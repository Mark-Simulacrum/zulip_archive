<html>
<head><meta charset="utf-8"><title>2022 perf roadmap draft complete · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html">2022 perf roadmap draft complete</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="273033876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273033876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273033876">(Feb 24 2022 at 00:54)</a>:</h4>
<p>I have finished the draft of the <a href="https://hackmd.io/YJQSj_nLSZWl2sbI84R1qA?view">Compiler performance roadmap for 2022</a>. Please take a look, comment on it, ask questions, etc.</p>



<a name="273033897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273033897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273033897">(Feb 24 2022 at 00:54)</a>:</h4>
<p>In particular:</p>
<ul>
<li>Is anything important missing?</li>
</ul>



<a name="273033902"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273033902" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273033902">(Feb 24 2022 at 00:54)</a>:</h4>
<ul>
<li>Is anything there you think shouldn't be?</li>
</ul>



<a name="273033908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273033908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273033908">(Feb 24 2022 at 00:54)</a>:</h4>
<ul>
<li>Is anything unclear?</li>
</ul>



<a name="273034095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273034095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273034095">(Feb 24 2022 at 00:57)</a>:</h4>
<ul>
<li>Are there items you want to assign to yourself?</li>
</ul>



<a name="273034126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273034126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273034126">(Feb 24 2022 at 00:57)</a>:</h4>
<p>I don't know if we should have any kind of official ratification procedure... hopefully consensus here is good enough, it's not a legal document <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="273034129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273034129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273034129">(Feb 24 2022 at 00:57)</a>:</h4>
<p>Thanks!</p>



<a name="273036965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273036965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273036965">(Feb 24 2022 at 01:39)</a>:</h4>
<p>I think my own goals on compiler bootstrap performance probably aren't well covered yet, might be good to add a section there. I plan to continue investing in that.</p>



<a name="273041109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273041109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273041109">(Feb 24 2022 at 02:57)</a>:</h4>
<p>Good to hear, though I wonder if that's too specific for this document? Improvements would help rustc devs but not your typical Rust programmer.</p>



<a name="273041496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273041496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273041496">(Feb 24 2022 at 03:02)</a>:</h4>
<p>Yeah, not sure</p>



<a name="273041519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273041519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273041519">(Feb 24 2022 at 03:03)</a>:</h4>
<p>I think it influences the compiler performance wg's work (insofar as e.g. UX improvements to the triage comments, etc. will in part be informed by this work, I expect)</p>



<a name="273041524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273041524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273041524">(Feb 24 2022 at 03:03)</a>:</h4>
<p>but most end users indeed probably don't care, though distros and other less Rust-y people could.</p>



<a name="273041605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273041605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273041605">(Feb 24 2022 at 03:04)</a>:</h4>
<p>Let's leave it out for now, I think. We can always revise the roadmap and/or expand upon it in the future, afterall it's not like it must be exhaustive either :)</p>



<a name="273051775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273051775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273051775">(Feb 24 2022 at 06:16)</a>:</h4>
<p>It would be nice to have these goals and tasks written somewhere, especially if other contributors can collaborate and help achieve them</p>



<a name="273056194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273056194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273056194">(Feb 24 2022 at 07:40)</a>:</h4>
<p>As for preliminary task assignments:</p>
<ul>
<li>I can take the fxhash one: it would be great if mark could help make the repo and publishable for more people like us t-compiler contributors, I don’t know if bors is needed per se (I’m not even sure t-compiler has all necessary credentials) so that we can merge the PR syncing the repo with the actual <a href="http://crates.io">crates.io</a> code at the very least. I hoped looking into it a bit more, esp if zoxc’s change is an instruction loss but cycles/wall-time because of vectorization, to see if the slice hashing could be vectorized a bit more even on our x64-v1 target (though if that part is of interest to others it’s very self contained and does not require any experience with rustc. It’s a good independent task, though fxhash is harsh and tends to waste a lot of people’s time). I’ll start with the WIP PR first anyways and see later.</li>
<li>I can also take the cargo scheduling: I am looking into that now, and will ask the cargo team how/if to turn my prototype into a PR. I’m not sure the approach I took is acceptable, and I also need to test it more deeply to ensure the schedule is not just faster but also, you know, valid.</li>
<li>I've looked a bit into the build scripts but it was only preliminary and seems a good independent task. I've noted the use cases I found in the analysis doc. wesley also mentioned the metabuild RFC, which is implemented in cargo, and could help with some of these use-cases (but not say, how seemingly slow they are to compile, and which needs to be compared to a regular hello world, and to check if it's a measurement issue or can be reproduced elsewhere)</li>
<li>I'm currently trying to see if I can fix the pipelining issue in hyper (that is in hyper itself): it's not compiler work per se, but it does affect compile times for that whole eco-system significantly. There are in-progress and recently landed cargo PRs that could help as well.</li>
<li>I do have access to a windows machine, and could try looking into PGO there</li>
</ul>



<a name="273056621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273056621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273056621">(Feb 24 2022 at 07:48)</a>:</h4>
<p>I was wondering, what do you all think about an item to take a look at allocators again: it's a very independent task. </p>
<ul>
<li>the mimalloc benchmarks were still a max-rss regressions but cpu time improvements were interesting. the beta supposed to fix the memory usage regressions seemed to nullify these perf improvements though, but maybe that has changed since the last perf run (unlikely, there's not that much activity in mimalloc but who knows). </li>
<li>But I had tried locally snmalloc and it looked promising (especially if we want to do more multithreaded deallocs, say) and could maybe also help windows users though I've just looked at it on linux. It seemed at least worthy of taking a look. </li>
<li>jemalloc 5.3 is about to release</li>
<li>and of course there are others, like tcmalloc, though we likely wouldn't making much use of its multithreaded capabilities</li>
</ul>
<p>it doesn't have to be on the roadmap, much like mark's bootstrapping goals, for anyone to look at it</p>



<a name="273058510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273058510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> tm <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273058510">(Feb 24 2022 at 08:16)</a>:</h4>
<ul>
<li><a href="https://github.com/rust-lang/rust/issues/93257">#93257</a> suggest there might be opportunity for large improvement in building MIR cleanup blocks. Currently the code size is quadratic in input size in the provided test case.</li>
</ul>



<a name="273058816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273058816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273058816">(Feb 24 2022 at 08:20)</a>:</h4>
<p>I believe we've seen this show up in real world profiles as well (and I had this issue bookmarked already apparently), e.g. in <code>tinyvec</code> IIRC</p>



<a name="273059147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273059147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273059147">(Feb 24 2022 at 08:24)</a>:</h4>
<p>Good to have it fixed, but I don't think it needs to be mentioned on the roadmap</p>



<a name="273060387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273060387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273060387">(Feb 24 2022 at 08:39)</a>:</h4>
<p>we can keep it at a high-level if you prefer, and link to other lists of more fine-grained tasks, for example if some people would want to know where they can contribute</p>



<a name="273063810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273063810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273063810">(Feb 24 2022 at 09:17)</a>:</h4>
<p>(for the "proc-macro2 and quote" item in the list: there were <a href="https://github.com/dtolnay/quote/pull/162">https://github.com/dtolnay/quote/pull/162</a> and <a href="https://github.com/dtolnay/proc-macro2/pull/239">https://github.com/dtolnay/proc-macro2/pull/239</a> as examples of the general area of buffering to amortize the proc-macro bridge back and forth; I remember there are also WIP PRs for the bridge itself and can find them if we'd like to link things we could help test and land)</p>



<a name="273207645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20perf%20roadmap%20draft%20complete/near/273207645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20perf.20roadmap.20draft.20complete.html#273207645">(Feb 25 2022 at 09:44)</a>:</h4>
<p>The roadmap looks good to me. One area that is potentially missing is getting Windows benchmarks running. While I think it's easy to argue that having benchmarks running on Windows would be helpful, it might not be worth the overall cost. <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> was working on this before, but I believe the work has largely stalled at the point where the suite can at least be run locally. </p>
<p>I won't have a ton of time to participate, but I'm hoping to have time to work a bit on perf.rlo UI/UX and PR process (e.g., gating bors when a PR is labeled as perf-regression with no perf-regression-triaged).</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>