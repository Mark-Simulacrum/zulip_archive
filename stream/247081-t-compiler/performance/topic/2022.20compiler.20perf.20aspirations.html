<html>
<head><meta charset="utf-8"><title>2022 compiler perf aspirations · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html">2022 compiler perf aspirations</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="272881239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881239">(Feb 22 2022 at 23:26)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="120989">@nnethercote</span> <span class="user-mention" data-user-id="116113">@lqd</span>! In response to the Rust Compiler Ambitions 2022 blog post, I'd be interested in helping out with developing the compiler in my free time. One of the areas that interest me in general is improving compile times of <code>rustc</code>. So far I have worked on improving stable hashing (incremental) and rustdoc performance. I usually try to find ideas on what to improve by randomly profiling <code>rustc</code> on various crates, since I'm not that knowledgeable about the compiler yet to think of higher-level changes. If you have any ideas on what experiments or ideas could be explored, I'd be glad to try them out :)</p>



<a name="272881272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881272">(Feb 22 2022 at 23:26)</a>:</h4>
<p>Hi Jakub!</p>



<a name="272881328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881328">(Feb 22 2022 at 23:27)</a>:</h4>
<p>Thank you for the offer. Profiling <code>rustc</code> on crates is much of what I've been doing for several years now, it's a good approach <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="272881478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881478">(Feb 22 2022 at 23:29)</a>:</h4>
<p>You may have seen the draft <a href="https://hackmd.io/YJQSj_nLSZWl2sbI84R1qA?view">roadmap</a>, and also the <a href="https://hackmd.io/mxdn4U58Su-UQXwzOHpHag?view">analysis</a> that is partly informing it. I am working on both of these documents right now, I hope to have drafts complete by the end of the week. Comments are welcome</p>



<a name="272881595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881595">(Feb 22 2022 at 23:30)</a>:</h4>
<p>The roadmap should serve as a helpful list of things to work on, I am very happy to have people helping with items</p>



<a name="272881759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881759">(Feb 22 2022 at 23:32)</a>:</h4>
<p>To be fair, the "randomly profile" approach is getting less effective with time, because a lot of the low-hanging fruit has been picked already. This is why @lqd's big data set is so useful, because it gives a much wider view of the ecosystem (beyond the benchmarks in <code>rustc-perf</code>), and also does some looking at full project build performance, not just single crate performance</p>



<a name="272881784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881784">(Feb 22 2022 at 23:32)</a>:</h4>
<p>I am happy to answer questions here, too</p>



<a name="272881809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881809">(Feb 22 2022 at 23:33)</a>:</h4>
<p>What platform do you use: Linux, Mac, something else?</p>



<a name="272881842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881842">(Feb 22 2022 at 23:33)</a>:</h4>
<p>Indeed I have been noticing that finding low-hanging fruits by random profiling is becoming harder and harder <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span> I work on Linux.</p>



<a name="272881922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272881922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272881922">(Feb 22 2022 at 23:34)</a>:</h4>
<p>Cool, Linux is probably the best-established platform, in terms of rustc profiler/benchmarking support.</p>



<a name="272883310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272883310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Beránek <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272883310">(Feb 22 2022 at 23:49)</a>:</h4>
<p>Yeah the profiling support is actually quite nice. I'm usually either using perf for flamegraphs, cachegrind or dhat. Well, it seems that the profiling support is actually quite good because of you! :D I'll try to take a look at the lqd dataset eventually. If you'll have some ideas worth trying that you'll lack the bandwidth for, you can try to post them here and maybe someone (e.g. me) can try to pick them up. But I suppose that the document from lqd also serves for this purpose.</p>



<a name="272883788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272883788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272883788">(Feb 22 2022 at 23:55)</a>:</h4>
<p>The roadmap will be the main "ideas for people to work on" document.  lqd has his <a href="https://gist.github.com/lqd/2c92d351ed9eb2b846b3bc2f51cace6f">thoughts</a> document, which has <em>lots</em> of ideas and would be worth reading, but the data gathering + analysis + roadmap is an attempt to reduce that down, be more focused on a smaller number of items that have a high chance of working</p>



<a name="272913448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272913448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272913448">(Feb 23 2022 at 07:37)</a>:</h4>
<p>btw the latest version of that document is <a href="https://hackmd.io/3Dp68rTDSpWvRDfWF6lbMw?view">https://hackmd.io/3Dp68rTDSpWvRDfWF6lbMw?view</a> where it’s much easier to comment/update (and is linked from the compiler aspirations blog post)</p>



<a name="272913793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/272913793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#272913793">(Feb 23 2022 at 07:42)</a>:</h4>
<p>there are other interesting things like analyzing some behavior we rarely see, that’s happening <a href="https://lqd.github.io/rustc-benchmarking-data/results/round-14-self-profile-check/summarize/summarize-w-profiling-nalgebra-0.30.1-Check-Full.txt">in nalgebra</a>. </p>
<p>The <code>specialization_graph_of</code> query is extremely slow there. My guess is that it’s coherence checking (as the same thing has happened before, e.g. <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/windows-rs.20perf">here</a>, an early rejection helped a lot at the time) but it could be slightly different and it would be good to check the reasons for that, and which parts of the crate trigger it. </p>
<p>If that’s because of the quadratic coherence check it may not be easy to fix though, but it will be good to know what is the issue to begin with.</p>



<a name="273030933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273030933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273030933">(Feb 24 2022 at 00:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> In the roadmap, you added "PGO, etc. to tier-1 platforms". What is the "etc."?</p>



<a name="273030951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273030951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273030951">(Feb 24 2022 at 00:18)</a>:</h4>
<p>PGO is the only one like that I know of. Unless you mean BOLT? (which is currently a separate bullet point)</p>



<a name="273032739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273032739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273032739">(Feb 24 2022 at 00:41)</a>:</h4>
<p>I think we apply some other optimizations exclusive to Linux (well, x86_64-unknown-linux-gnu)</p>



<a name="273032826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273032826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273032826">(Feb 24 2022 at 00:42)</a>:</h4>
<p>Yeah, llvm is built with thinlto and we enable jemalloc for example</p>



<a name="273032841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273032841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273032841">(Feb 24 2022 at 00:42)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> ^</p>



<a name="273032885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273032885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273032885">(Feb 24 2022 at 00:43)</a>:</h4>
<p>Plus there's some medium effect from building LLVM with a recent clang, not some ancient toolchain, probably</p>



<a name="273032896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273032896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273032896">(Feb 24 2022 at 00:43)</a>:</h4>
<p>Ok, thanks</p>



<a name="273033175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273033175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273033175">(Feb 24 2022 at 00:46)</a>:</h4>
<p>Another question on that: you suggested 15-30% wins are possible... is that realistic? Seems high. Would be cool if true... <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="273033319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273033319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273033319">(Feb 24 2022 at 00:48)</a>:</h4>
<p>I think cumulative effect on Linux for pgo was in that range, yeah</p>



<a name="273033352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273033352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273033352">(Feb 24 2022 at 00:48)</a>:</h4>
<p>The wins from BOLT for clang are in the 5-10% range IIRC, when applied atop PGO</p>



<a name="273033366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/2022%20compiler%20perf%20aspirations/near/273033366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/2022.20compiler.20perf.20aspirations.html#273033366">(Feb 24 2022 at 00:48)</a>:</h4>
<p>k, thx</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>