<html>
<head><meta charset="utf-8"><title>PR #90951 mixed results · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html">PR #90951 mixed results</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="262248302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262248302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262248302">(Nov 21 2021 at 16:22)</a>:</h4>
<p>I cannot find what caused <a href="https://github.com/rust-lang/rust/issues/90951">#90951</a> to have mixed results for perf.  The perf regressions are all <code>cargo doc</code> and apparently metadata decoding. I had not done any major changes to rustdoc or metadata decoding at all, so I think it might be spurious.</p>
<p>Also, when I go to the detailed query page for a benchmark that was improved, it shows a red percentage and a lot of zeros:<br>
<a href="/user_uploads/4715/4sE7dzsZC3GurLOCCbunkZOo/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/4sE7dzsZC3GurLOCCbunkZOo/image.png" title="image.png"><img src="/user_uploads/4715/4sE7dzsZC3GurLOCCbunkZOo/image.png"></a></div><p>That is pretty confusing to me and I have no idea what that means.</p>
<p>Can anyone take a look? Thanks.</p>



<a name="262248766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262248766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262248766">(Nov 21 2021 at 16:32)</a>:</h4>
<p>The overview page shows the amount of instructions by default, which doesn't have a lot of noise. The detailed query page uses wall time, which is pretty noisy.</p>



<a name="262248965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262248965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262248965">(Nov 21 2021 at 16:36)</a>:</h4>
<p>Looks like there's significantly more decoding happening of various things, not clear exactly why. Would need some hefty investigation, I suspect</p>



<a name="262249899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262249899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262249899">(Nov 21 2021 at 16:58)</a>:</h4>
<p>It looks like mk_const (which is what interns things) just uses the underlying hash impl though</p>



<a name="262250228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262250228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262250228">(Nov 21 2021 at 17:05)</a>:</h4>
<p>so I'm not sure that the change you've made is actually ok</p>



<a name="262250396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262250396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262250396">(Nov 21 2021 at 17:09)</a>:</h4>
<p><code>intern_const</code> uses a newtype wrapper <code>CstHash</code> which hashes the fields.</p>



<a name="262250602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262250602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262250602">(Nov 21 2021 at 17:14)</a>:</h4>
<p><span class="user-mention" data-user-id="361356">@fee1-dead</span> metadata decoding uses the Hash impl you modified, so I'm not super surprised it was affected by this change</p>



<a name="262250617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262250617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262250617">(Nov 21 2021 at 17:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361356">fee1-dead</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/PR.20.2390951.20mixed.20results/near/262250396">said</a>:</p>
<blockquote>
<p><code>intern_const</code> uses a newtype wrapper <code>CstHash</code> which hashes the fields.</p>
</blockquote>
<p>Ah, I see that code now.</p>



<a name="262250629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262250629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262250629">(Nov 21 2021 at 17:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/PR.20.2390951.20mixed.20results/near/262250602">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="361356">fee1-dead</span> metadata decoding uses the Hash impl you modified, so I'm not super surprised it was affected by this change</p>
</blockquote>
<p>Hmmm. I assumed that it would use <code>HashStable</code> so modifying the <code>Hash</code> impl would have no effect.</p>



<a name="262250674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262250674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262250674">(Nov 21 2021 at 17:16)</a>:</h4>
<p>Oh uhh good question I'm not sure which it uses</p>



<a name="262286360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262286360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262286360">(Nov 22 2021 at 07:26)</a>:</h4>
<p>And I limited the implementation of Hash to only <code>&amp;'tcx ty::Const&lt;'tcx&gt;</code> so it restricts to hashing interned references</p>



<a name="262312477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262312477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262312477">(Nov 22 2021 at 12:34)</a>:</h4>
<p>Er, 'tcx there isn't special - it's just a lifetime</p>



<a name="262312546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262312546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262312546">(Nov 22 2021 at 12:35)</a>:</h4>
<p>So that impl applies for all &amp;ty::Const</p>



<a name="262452903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262452903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262452903">(Nov 23 2021 at 13:11)</a>:</h4>
<p>Just tried to profile locally today and 1. I did not find any meaningful information. 2. I was both surprised and confused because the modified compiler actually ran faster than the original, where the benchmarks were shown as "regressions".</p>



<a name="262453100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262453100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262453100">(Nov 23 2021 at 13:14)</a>:</h4>
<p>How did you profile? It's not atypical to see different results with locally built binaries, especially if you're not using the same level of optimization (pgo, LTO, etc)</p>



<a name="262455067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262455067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262455067">(Nov 23 2021 at 13:29)</a>:</h4>
<p>I have another folder, basically <code>git checkout</code> the commit before my change, and copied my <code>config.toml</code> and built stage1. Both callgrind and perf record said the modified compiler is faster.</p>



<a name="262455223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262455223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262455223">(Nov 23 2021 at 13:30)</a>:</h4>
<p>What benchmark are you measuring? How big is the improvement?</p>
<p>It's worth noting that CI can definitely deviate significantly from what you see locally, particularly for hot code.</p>



<a name="262456163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456163">(Nov 23 2021 at 13:38)</a>:</h4>
<p>Are there instructions somewhere for replicating what CI does? It seems hard to diagnose "pgo made different decisions" ... especially if your change would be an improvement without pgo</p>



<a name="262456210"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456210" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456210">(Nov 23 2021 at 13:38)</a>:</h4>
<p>DEPLOY=1 ./src/ci/docker/run dist-x86_64-linux, basically?</p>



<a name="262456215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456215">(Nov 23 2021 at 13:38)</a>:</h4>
<p>(and I wonder if it makes sense to disable pgo for benchmarking so we get more accurate comparisons)</p>



<a name="262456257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456257">(Nov 23 2021 at 13:38)</a>:</h4>
<p>disabling PGO for benchmarking but not production builds feels like a pretty odd thing to do</p>



<a name="262456290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456290">(Nov 23 2021 at 13:39)</a>:</h4>
<p>ultimately we need to measure what we ship</p>



<a name="262456488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456488">(Nov 23 2021 at 13:40)</a>:</h4>
<p>I worry that will steer us into local minima of "this is what pgo knows how to optimize well", when we could see a larger improvement over time from changes that are each individually regressions if you're using pgo</p>



<a name="262456709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456709">(Nov 23 2021 at 13:42)</a>:</h4>
<p>It's possible, but I feel like the reverse side of landing regressions for what we ship in the hope that they're actually going to become improvements in aggregate is... less clear-cut</p>



<a name="262456727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456727">(Nov 23 2021 at 13:42)</a>:</h4>
<p>like, it's definitely a tradeoff to use PGO</p>



<a name="262456743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456743">(Nov 23 2021 at 13:42)</a>:</h4>
<p>maybe even the wrong one!</p>



<a name="262456845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262456845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262456845">(Nov 23 2021 at 13:43)</a>:</h4>
<p>but right now, at least, I've not yet been convinced the fairly significant wins (on the order of &gt;15%, IIRC, on many benchmarks) are something we should lose because it makes benchmarking less tightly predictable</p>



<a name="262457473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262457473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262457473">(Nov 23 2021 at 13:49)</a>:</h4>
<blockquote>
<p>but right now, at least, I've not yet been convinced the fairly significant wins (on the order of &gt;15%, IIRC, on many benchmarks) are something we should lose because it makes benchmarking less tightly predictable</p>
</blockquote>
<p>To be clear, I don't think we should disable pgo for what we ship, only for benchmarks. But I understand that's both hard to implement and means we get a less accurate idea of what the actual perf is</p>



<a name="262457653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262457653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262457653">(Nov 23 2021 at 13:50)</a>:</h4>
<blockquote>
<p>It's possible, but I feel like the reverse side of landing regressions for what we ship in the hope that they're actually going to become improvements in aggregate</p>
</blockquote>
<p>I guess I don't see how we hope to measure this side of things</p>



<a name="262457680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262457680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262457680">(Nov 23 2021 at 13:51)</a>:</h4>
<p>fwiw, I think firefox produces both pgo and non-pgo builds and regularly measures both in their CI</p>



<a name="262457732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262457732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262457732">(Nov 23 2021 at 13:51)</a>:</h4>
<p>I think it's a little too much for us -- we already struggle with the amount of data thrown at you from measurement reports -- but it's something to consider once we get better at that.</p>



<a name="262464159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262464159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262464159">(Nov 23 2021 at 14:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/PR.20.2390951.20mixed.20results/near/262455223">said</a>:</p>
<blockquote>
<p>What benchmark are you measuring? How big is the improvement?</p>
<p>It's worth noting that CI can definitely deviate significantly from what you see locally, particularly for hot code.</p>
</blockquote>
<p><a href="/user_uploads/4715/6H13sXRe7YVhVLnlsby_NnlQ/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/6H13sXRe7YVhVLnlsby_NnlQ/image.png" title="image.png"><img src="/user_uploads/4715/6H13sXRe7YVhVLnlsby_NnlQ/image.png"></a></div><p><a href="/user_uploads/4715/tt2ae3mdWb2qe9nvRhvE3gaA/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/tt2ae3mdWb2qe9nvRhvE3gaA/image.png" title="image.png"><img src="/user_uploads/4715/tt2ae3mdWb2qe9nvRhvE3gaA/image.png"></a></div>



<a name="262464622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262464622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262464622">(Nov 23 2021 at 14:43)</a>:</h4>
<p>Left is compiler with change</p>
<p><a href="/user_uploads/4715/fcMKB_SJPxp8PGDvWv2LZXPs/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/fcMKB_SJPxp8PGDvWv2LZXPs/image.png" title="image.png"><img src="/user_uploads/4715/fcMKB_SJPxp8PGDvWv2LZXPs/image.png"></a></div>



<a name="262464671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262464671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262464671">(Nov 23 2021 at 14:43)</a>:</h4>
<p>Both of those benchmarks are typically dominated by pretty "uninteresting" code, IIRC, such as code in the dynamic linker.</p>
<p>I would suggest measuring something potentially larger -- e.g., the ripgrep-doc regression</p>



<a name="262466631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262466631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262466631">(Nov 23 2021 at 14:58)</a>:</h4>
<p><a href="/user_uploads/4715/fRMEB1-emtQyUAX1kcT46inr/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/fRMEB1-emtQyUAX1kcT46inr/image.png" title="image.png"><img src="/user_uploads/4715/fRMEB1-emtQyUAX1kcT46inr/image.png"></a></div>



<a name="262466784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262466784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262466784">(Nov 23 2021 at 14:59)</a>:</h4>
<p>Yeah. I mean, it's hard to say. Typically I start looking at callgrind reports in kcachegrind, with callgrind adjusted with --dump-instr=yes at least, and start trying to figure out what the difference between builds is</p>



<a name="262466941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262466941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262466941">(Nov 23 2021 at 15:00)</a>:</h4>
<p>it's worth noting our current PGO setup doesn't include Doc builds</p>



<a name="262466985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262466985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262466985">(Nov 23 2021 at 15:00)</a>:</h4>
<p>so it may be worth working to add those in a separate PR</p>



<a name="262467035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262467035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262467035">(Nov 23 2021 at 15:01)</a>:</h4>
<p>BTW can you demangle rust symbols in KCachegrind?</p>



<a name="262467077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262467077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262467077">(Nov 23 2021 at 15:01)</a>:</h4>
<p>I'm not sure what kcachegrind uses for demangling.</p>



<a name="262467097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262467097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262467097">(Nov 23 2021 at 15:01)</a>:</h4>
<p>it probably needs to be updated to support the v0 format</p>



<a name="262467565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262467565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262467565">(Nov 23 2021 at 15:05)</a>:</h4>
<p><a href="/user_uploads/4715/T5qY_ZJq_zyx5DDHLUZZcJjH/image.png">image.png</a> </p>
<div class="message_inline_image"><a href="/user_uploads/4715/T5qY_ZJq_zyx5DDHLUZZcJjH/image.png" title="image.png"><img src="/user_uploads/4715/T5qY_ZJq_zyx5DDHLUZZcJjH/image.png"></a></div><p>callgrind results report that modified version runs faster for "item_children", but the perf website said it was a regression</p>



<a name="262473183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262473183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262473183">(Nov 23 2021 at 15:45)</a>:</h4>
<p>I've had cases where the optimized method itself was faster but other things became slower due to reasons</p>



<a name="262500474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262500474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262500474">(Nov 23 2021 at 19:13)</a>:</h4>
<p><span class="user-mention" data-user-id="361356">@fee1-dead</span> I've done some work recently to make the Valgrind v0 demangling story better. If you do a trunk build of valgrind it will demangle most of the v0 symbols (but not the ones with <code>.llvm.&lt;numbers&gt;</code> suffixes). To get and build Valgrind, it's something like this:</p>
<div class="codehilite"><pre><span></span><code>git clone git://sourceware.org/git/valgrind.git
cd valgrind
sh ./autogen.sh
sh ./configure
make --quiet -j 8
</code></pre></div>
<p>Then you can run <code>vg-in-place</code> directly, or do <code>make install</code>and run it from the install directory.</p>



<a name="262500699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262500699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262500699">(Nov 23 2021 at 19:15)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="232545">@Joshua Nelson</span> On the question of what builds to benchmark on CI?</p>
<p><span aria-label="clap" class="emoji emoji-1f44f" role="img" title="clap">:clap:</span> Benchmark <span aria-label="clap" class="emoji emoji-1f44f" role="img" title="clap">:clap:</span> what <span aria-label="clap" class="emoji emoji-1f44f" role="img" title="clap">:clap:</span> you <span aria-label="clap" class="emoji emoji-1f44f" role="img" title="clap">:clap:</span> ship <span aria-label="clap" class="emoji emoji-1f44f" role="img" title="clap">:clap:</span>.</p>



<a name="262500787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262500787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262500787">(Nov 23 2021 at 19:16)</a>:</h4>
<p>literally laughed out loud, my dog perked his head up <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="262500883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262500883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262500883">(Nov 23 2021 at 19:17)</a>:</h4>
<p>good dog</p>



<a name="262500943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262500943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262500943">(Nov 23 2021 at 19:18)</a>:</h4>
<p>13/10</p>



<a name="262504241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262504241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262504241">(Nov 23 2021 at 19:48)</a>:</h4>
<p>(I will say, I think there is value in providing easy ways to generate <em>variations</em> of the shipped build that are more amenable to various kinds of analysis. But I’m totally on board for the <em>minimum</em> of what CI should evaluate.)</p>



<a name="262585381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2390951%20mixed%20results/near/262585381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fee1-dead <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2390951.20mixed.20results.html#262585381">(Nov 24 2021 at 13:05)</a>:</h4>
<p>I suspect that this PR is like <a href="https://github.com/rust-lang/rust/pull/87688#issuecomment-940361493">https://github.com/rust-lang/rust/pull/87688#issuecomment-940361493</a>, so I don't think I can take actions to fix the regression.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>