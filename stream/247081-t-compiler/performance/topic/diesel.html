<html>
<head><meta charset="utf-8"><title>diesel · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html">diesel</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="271052300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271052300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271052300">(Feb 07 2022 at 22:27)</a>:</h4>
<p>I've been looking at compilation of <code>diesel</code>, because its profiles look a bit different to normal. I think I've worked out at least part of the reason why.</p>



<a name="271052413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271052413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271052413">(Feb 07 2022 at 22:27)</a>:</h4>
<p>Check out this ridiculous file: <a href="https://github.com/rust-lang/rustc-perf/blob/master/collector/benchmarks/diesel/diesel/src/macros/tuples.rs">https://github.com/rust-lang/rustc-perf/blob/master/collector/benchmarks/diesel/diesel/src/macros/tuples.rs</a></p>



<a name="271052558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271052558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271052558">(Feb 07 2022 at 22:28)</a>:</h4>
<p><code>TypeFoldable</code> related stuff is quite hot when compiling diesel</p>



<a name="271052598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271052598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271052598">(Feb 07 2022 at 22:29)</a>:</h4>
<p>We have <code>List&lt;Predicate&gt;</code>s with 100s of entries, things like this:</p>
<div class="codehilite"><pre><span></span><code>Binder(TraitPredicate(&lt;impl Row&lt;&#39;a, __DB&gt; as row::Row&lt;&#39;a, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;impl Row&lt;&#39;a, __DB&gt; as row::RowIndex&lt;&amp;&#39;b str&gt;&gt;, polarity:Positive), [Region(BrNamed(DefId(0:5763 ~ diesel[8a10]::row::Row::&#39;b), &#39;b))]), Binder(TraitPredicate(&lt;impl Row&lt;&#39;a, __DB&gt; as row::RowIndex&lt;usize&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;impl Row&lt;&#39;a, __DB&gt; as std::marker::Sized&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AF as deserialize::StaticallySizedRow&lt;SAF, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AF as deserialize::FromSqlRow&lt;SAF, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AE as deserialize::StaticallySizedRow&lt;SAE, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AE as deserialize::FromSqlRow&lt;SAE, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AD as deserialize::StaticallySizedRow&lt;SAD, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AD as deserialize::FromSqlRow&lt;SAD, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AC as deserialize::StaticallySizedRow&lt;SAC, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AC as deserialize::FromSqlRow&lt;SAC, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AB as deserialize::StaticallySizedRow&lt;SAB, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AB as deserialize::FromSqlRow&lt;SAB, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AA as deserialize::StaticallySizedRow&lt;SAA, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;AA as deserialize::FromSqlRow&lt;SAA, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;Z as deserialize::StaticallySizedRow&lt;SZ, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;Z as deserialize::FromSqlRow&lt;SZ, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;Y as deserialize::StaticallySizedRow&lt;SY, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;Y as deserialize::FromSqlRow&lt;SY, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;X as deserialize::StaticallySizedRow&lt;SX, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;X as deserialize::FromSqlRow&lt;SX, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;W as deserialize::StaticallySizedRow&lt;SW, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;W as deserialize::FromSqlRow&lt;SW, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;V as deserialize::StaticallySizedRow&lt;SV, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;V as deserialize::FromSqlRow&lt;SV, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;U as deserialize::StaticallySizedRow&lt;SU, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;U as deserialize::FromSqlRow&lt;SU, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;T as deserialize::StaticallySizedRow&lt;ST, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;T as deserialize::FromSqlRow&lt;ST, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;S as deserialize::StaticallySizedRow&lt;SS, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;S as deserialize::FromSqlRow&lt;SS, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;R as deserialize::StaticallySizedRow&lt;SR, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;R as deserialize::FromSqlRow&lt;SR, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;Q as deserialize::StaticallySizedRow&lt;SQ, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;Q as deserialize::FromSqlRow&lt;SQ, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;P as deserialize::StaticallySizedRow&lt;SP, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;P as deserialize::FromSqlRow&lt;SP, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;O as deserialize::StaticallySizedRow&lt;SO, __DB&gt;&gt;, polarity:Positive), []), Binder(TraitPredicate(&lt;O as deserialize::FromSqlRow&lt;SO, __DB&gt;&gt;, polarity:Positive), []),  ...
</code></pre></div>



<a name="271052639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271052639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271052639">(Feb 07 2022 at 22:29)</a>:</h4>
<p>So, variadic tuples FTW? :)</p>



<a name="271052778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271052778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271052778">(Feb 07 2022 at 22:30)</a>:</h4>
<p>I'm not sure if what this macro is doing is more complex than that</p>



<a name="271052880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271052880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271052880">(Feb 07 2022 at 22:31)</a>:</h4>
<p>Having said that, <a href="https://github.com/diesel-rs/diesel/tree/master/diesel/src/macros">https://github.com/diesel-rs/diesel/tree/master/diesel/src/macros</a> is the latest version and that file isn't present</p>



<a name="271053284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271053284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271053284">(Feb 07 2022 at 22:34)</a>:</h4>
<p>Oh, it's now a proc macro: <a href="https://github.com/diesel-rs/diesel/blob/0e49ce0e22803c3b8f4141e4abe10d8b73a2c31f/diesel_derives/src/lib.rs#L1235">https://github.com/diesel-rs/diesel/blob/0e49ce0e22803c3b8f4141e4abe10d8b73a2c31f/diesel_derives/src/lib.rs#L1235</a></p>



<a name="271054667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271054667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271054667">(Feb 07 2022 at 22:46)</a>:</h4>
<p>with features to limit the max length:<br>
<a href="https://github.com/diesel-rs/diesel/blob/0e49ce0e22803c3b8f4141e4abe10d8b73a2c31f/diesel_derives/src/diesel_for_each_tuple.rs">https://github.com/diesel-rs/diesel/blob/0e49ce0e22803c3b8f4141e4abe10d8b73a2c31f/diesel_derives/src/diesel_for_each_tuple.rs</a></p>



<a name="271054731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/diesel/near/271054731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/diesel.html#271054731">(Feb 07 2022 at 22:47)</a>:</h4>
<p>I wonder if they'd be better off with bespoke tuple structs where they are actually used</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>