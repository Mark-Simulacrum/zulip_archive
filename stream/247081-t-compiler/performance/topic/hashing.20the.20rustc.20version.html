<html>
<head><meta charset="utf-8"><title>hashing the rustc version · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html">hashing the rustc version</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265678764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265678764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265678764">(Dec 21 2021 at 12:20)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/89836">#89836</a> introduced a hash of the rustc version (including the git commit) into the stable crate ID generated by rustc -- this is causing some pain with perf, since there's a natural noise addition due to the added effectively random variable being part of the build. I haven't thoroughly checked but I also suspect that every single symbol now has a different mangled name from rustc binary to the next version, which also seems kinda unfortunate -- makes binary comparisons and such harder.</p>



<a name="265678816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265678816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265678816">(Dec 21 2021 at 12:21)</a>:</h4>
<p>I'm increasingly feeling like it should be reverted, since it's rather a pain to work around and the benefits seem quite minor to me</p>



<a name="265678845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265678845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265678845">(Dec 21 2021 at 12:21)</a>:</h4>
<p>I filed <a href="https://github.com/rust-lang/rustc-perf/issues/1126">https://github.com/rust-lang/rustc-perf/issues/1126</a> to track this on the perf side</p>



<a name="265678917"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265678917" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265678917">(Dec 21 2021 at 12:22)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="224872">@rylev</span> I think it's your triage day? This is likely to cause a bunch of noise in the results over the last week, just a heads up</p>



<a name="265680301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680301">(Dec 21 2021 at 12:38)</a>:</h4>
<p><del>Just generated the triage report, and it looks relatively normal in terms of number of PRs with performance changes. I'll let you know if I see anything suspicious when I take a closer look.</del></p>



<a name="265680363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680363">(Dec 21 2021 at 12:39)</a>:</h4>
<p>Nevermind, I was looking at the wrong date. There are 23 mixed performance regressions...</p>



<a name="265680653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680653">(Dec 21 2021 at 12:42)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> taking a closer look: 27 out of 38 comparisons show as performance changes. Things definitely look shakier too. The significance factors on changes are very large even on changes we wouldn't expect (e.g., updating clippy)</p>



<a name="265680668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680668">(Dec 21 2021 at 12:42)</a>:</h4>
<p>I'm not sure if doing a triage report is really useful given this behavior</p>



<a name="265680752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680752">(Dec 21 2021 at 12:44)</a>:</h4>
<p>Yeah, not sure</p>



<a name="265680818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680818">(Dec 21 2021 at 12:44)</a>:</h4>
<p>Here's the raw report for you to take a look at: <a href="https://gist.github.com/rylev/37dec1fa900ccdd212d61ea995bfb931">https://gist.github.com/rylev/37dec1fa900ccdd212d61ea995bfb931</a></p>



<a name="265680908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680908">(Dec 21 2021 at 12:45)</a>:</h4>
<p>I think most of that looks like noise to me</p>



<a name="265680927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680927">(Dec 21 2021 at 12:45)</a>:</h4>
<p>maybe write up a short summary explaining the problem and just leave all the rest like that?</p>



<a name="265680979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680979">(Dec 21 2021 at 12:46)</a>:</h4>
<p>(feel free to steal language from the rustc-perf issue or pr)</p>



<a name="265680988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265680988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265680988">(Dec 21 2021 at 12:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> how much of this is also related to <a href="https://github.com/rust-lang/rustc-perf/pull/1123">https://github.com/rust-lang/rustc-perf/pull/1123</a>?</p>



<a name="265681009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265681009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265681009">(Dec 21 2021 at 12:46)</a>:</h4>
<p>that should only have reduced noise -- and made a single PR worse</p>



<a name="265681023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265681023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265681023">(Dec 21 2021 at 12:46)</a>:</h4>
<p>specifically <a href="https://github.com/rust-lang/rust/pull/92036">https://github.com/rust-lang/rust/pull/92036</a></p>



<a name="265681167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265681167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265681167">(Dec 21 2021 at 12:48)</a>:</h4>
<p>Ok and that PR does show up in the regressions. I can make note of that</p>



<a name="265681187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265681187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265681187">(Dec 21 2021 at 12:48)</a>:</h4>
<p>And then I'll make a note in the summary of why things look so bad</p>



<a name="265681384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265681384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265681384">(Dec 21 2021 at 12:51)</a>:</h4>
<p>hm, I think the failure on my PR is actually not caused by it, presumably a recent regression</p>
<blockquote>
<p>thread 'rustc' panicked at 'failed to lookup <code>SourceFile</code> in new context', compiler/rustc_query_impl/src/on_disk_cache.rs:500:22</p>
</blockquote>



<a name="265681658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265681658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265681658">(Dec 21 2021 at 12:54)</a>:</h4>
<p>We'll need to go through and comment on all the PRs to make sure the authors know that any performance change might not have anything to do with their PR</p>



<a name="265681683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265681683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265681683">(Dec 21 2021 at 12:54)</a>:</h4>
<p>yeah, that's a good idea</p>



<a name="265681698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265681698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265681698">(Dec 21 2021 at 12:54)</a>:</h4>
<p>and probably drop the perf-regression label or add triaged with "likely noise"</p>



<a name="265681848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265681848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265681848">(Dec 21 2021 at 12:56)</a>:</h4>
<p>I guess we're just going to eat any real performance regressions in this PRs then, right?</p>



<a name="265682146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682146">(Dec 21 2021 at 12:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> should we create an issue for this on rust-lang/rust? I this is only being tracking in rust-lang/rustc-perf, but if we want to push for this being reverted we should probably bring attention to it, no?</p>



<a name="265682233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682233">(Dec 21 2021 at 13:00)</a>:</h4>
<p>yeah, I'm not yet sure a revert is precisely right</p>



<a name="265682584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682584">(Dec 21 2021 at 13:04)</a>:</h4>
<p>Is it possible to not use the git hash in the compiler version? I guess this would mean that <a href="https://github.com/rust-lang/rust/issues/85142">the original issue</a> would not be solved for two compiler artifacts built from source but it would still fix it for official compiler artifacts</p>



<a name="265682724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682724">(Dec 21 2021 at 13:06)</a>:</h4>
<p>You mean hash just the version (i.e., 1.59.0)?</p>



<a name="265682747"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682747" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682747">(Dec 21 2021 at 13:06)</a>:</h4>
<p>in general it's possible but it's not clear to me that there's much advantage</p>



<a name="265682756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682756">(Dec 21 2021 at 13:06)</a>:</h4>
<p>Yea (and nightly-2021-12-21)</p>



<a name="265682772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682772">(Dec 21 2021 at 13:06)</a>:</h4>
<p>well, nightly-2021-22-11 is not known to rustc</p>



<a name="265682797"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682797" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682797">(Dec 21 2021 at 13:07)</a>:</h4>
<div class="codehilite"><pre><span></span><code>rustc 1.59.0-nightly (928783de6 2021-12-11)
binary: rustc
commit-hash: 928783de663bd855a96f14b2d38c1061603587c6
commit-date: 2021-12-11
host: x86_64-unknown-linux-gnu
release: 1.59.0-nightly
LLVM version: 13.0.0
</code></pre></div>



<a name="265682813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682813">(Dec 21 2021 at 13:07)</a>:</h4>
<p>you can draw from that data only</p>



<a name="265682828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682828">(Dec 21 2021 at 13:07)</a>:</h4>
<p>but in theory it's possible, yes</p>



<a name="265682833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682833">(Dec 21 2021 at 13:07)</a>:</h4>
<p>I'm not sure it's really <em>better</em></p>



<a name="265682950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682950">(Dec 21 2021 at 13:08)</a>:</h4>
<p>the only thing adding this hash gets you is hard linker errors if you try to link together different rustc version'd libraries, but that's not really that big a win imo</p>



<a name="265682974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682974">(Dec 21 2021 at 13:09)</a>:</h4>
<p>and we'd still have a randomized spike/win in perf every cycle, or every day if we include the date</p>



<a name="265682999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265682999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265682999">(Dec 21 2021 at 13:09)</a>:</h4>
<p>Perhaps a we need a flag to turn this off? So by default the symbols have embedded version info but not in perf runs?</p>



<a name="265683013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683013">(Dec 21 2021 at 13:09)</a>:</h4>
<p>This would make perf testing with official releases not really possible...</p>



<a name="265683108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683108">(Dec 21 2021 at 13:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hashing.20the.20rustc.20version/near/265682950">said</a>:</p>
<blockquote>
<p>the only thing adding this hash gets you is hard linker errors if you try to link together different rustc version'd libraries, but that's not really that big a win imo</p>
</blockquote>
<p>I guess I don't have an appreciation for how obvious the error is without the linker error. If there's an abi mismatch when does the user first see an error?</p>



<a name="265683117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683117">(Dec 21 2021 at 13:10)</a>:</h4>
<p>When running the binary?</p>



<a name="265683142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683142">(Dec 21 2021 at 13:11)</a>:</h4>
<p>no, it's just ub</p>



<a name="265683177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683177">(Dec 21 2021 at 13:11)</a>:</h4>
<p>Yea so while it might not be a super common case, it's not necessarily super easy to catch when it does happen.</p>



<a name="265683196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683196">(Dec 21 2021 at 13:11)</a>:</h4>
<p>Especially if the symbol in question isn't used very often</p>



<a name="265683248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683248">(Dec 21 2021 at 13:12)</a>:</h4>
<p>sure, yeah</p>



<a name="265683271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683271">(Dec 21 2021 at 13:12)</a>:</h4>
<p>the PR added the RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER env variable which I'm working on setting in rustc-perf (going to land that PR shortly)</p>



<a name="265683283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683283">(Dec 21 2021 at 13:12)</a>:</h4>
<p>which is confusingly referencing incr comp, but really is just for any build.</p>



<a name="265683476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683476">(Dec 21 2021 at 13:15)</a>:</h4>
<p>Ah. Ok that can help, but it has the same issue as what I pointed out above: you can't really perf test official releases against each other since they will have version info in their symbols.</p>



<a name="265683490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683490">(Dec 21 2021 at 13:15)</a>:</h4>
<p>I'm not sure how often people test two adjacent nightly versions, but that becomes harder (impossible?) now</p>



<a name="265683495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683495">(Dec 21 2021 at 13:15)</a>:</h4>
<p>well, mangled symbols being different is somewhat ok</p>



<a name="265683522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683522">(Dec 21 2021 at 13:15)</a>:</h4>
<p>it's not <em>ideal</em> but e.g. valgrind diffs will use demangled symbols for comparison, iirc</p>



<a name="265683589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683589">(Dec 21 2021 at 13:16)</a>:</h4>
<p>that said, I wouldn't be surprised if it causes noise at the PGO/LLVM level due to hash table ordering and such</p>



<a name="265683659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683659">(Dec 21 2021 at 13:17)</a>:</h4>
<p>Well I guess I've said my piece, and we shouldn't really be deciding this here. This obviously needs discussion in an issue and/or in <a class="stream" data-stream-id="131828" href="/#narrow/stream/131828-t-compiler">#t-compiler</a> .</p>



<a name="265683742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683742">(Dec 21 2021 at 13:18)</a>:</h4>
<p>yeah</p>



<a name="265683761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683761">(Dec 21 2021 at 13:18)</a>:</h4>
<p>I'll do some more investigation to confirm impact on symbols</p>



<a name="265683786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683786">(Dec 21 2021 at 13:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hashing.20the.20rustc.20version/near/265683761">said</a>:</p>
<blockquote>
<p>I'll do some more investigation to confirm impact on symbols</p>
</blockquote>
<p>Out of curiosity, what do you mean by this?</p>



<a name="265683820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683820">(Dec 21 2021 at 13:19)</a>:</h4>
<p>I'm going to try to check some of the noisy results from the triage report locally to see if setting that env variable just when running rustc is enough to eliminate the noise</p>



<a name="265683829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683829">(Dec 21 2021 at 13:19)</a>:</h4>
<p>(i.e., in cachegrind)</p>



<a name="265683912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265683912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265683912">(Dec 21 2021 at 13:20)</a>:</h4>
<p>that'll give a pretty good approximation of whether this is a "definitely not acceptable for perf work" or "not necessarily great, but not a blocker either"</p>



<a name="265695123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265695123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265695123">(Dec 21 2021 at 15:10)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="133247">@bjorn3</span> <span class="user-mention" data-user-id="316352">@pierwill</span></p>



<a name="265698110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265698110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265698110">(Dec 21 2021 at 15:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hashing.20the.20rustc.20version/near/265683283">said</a>:</p>
<blockquote>
<p>which is confusingly referencing incr comp, but really is just for any build.</p>
</blockquote>
<p>the env var already existed for the incremental compilation artifact header: <a href="https://github.com/rust-lang/rust/blob/42983a28ab3c70728da7a9b932b667c978dd898d/compiler/rustc_incremental/src/persist/file_format.rs#L193">https://github.com/rust-lang/rust/blob/42983a28ab3c70728da7a9b932b667c978dd898d/compiler/rustc_incremental/src/persist/file_format.rs#L193</a> It probably makes sense to rename both uses of the env var.</p>



<a name="265698166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265698166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265698166">(Dec 21 2021 at 15:32)</a>:</h4>
<p>Using this env var to reduce perf noise makes sense to me.</p>



<a name="265726988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/265726988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#265726988">(Dec 21 2021 at 19:47)</a>:</h4>
<p><a href="https://github.com/rust-lang/rustc-perf/pull/1129">https://github.com/rust-lang/rustc-perf/pull/1129</a></p>



<a name="266276134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/266276134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#266276134">(Dec 28 2021 at 17:20)</a>:</h4>
<p>The change also adds an 8% overhead to the UI testsuite because it compiles a dozen regular expressions for each test which adds up to ~160000 regexps being compiled.<br>
Could <code>RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER</code> help here too?</p>



<a name="266277935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/266277935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#266277935">(Dec 28 2021 at 17:48)</a>:</h4>
<p>It does.</p>



<a name="267787963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/267787963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#267787963">(Jan 12 2022 at 21:22)</a>:</h4>
<p>Shall we rename <code>RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER</code> -&gt; <code>RUSTC_FORCE_RUSTC_VERSION</code>?</p>



<a name="267789270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hashing%20the%20rustc%20version/near/267789270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pierwill <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hashing.20the.20rustc.20version.html#267789270">(Jan 12 2022 at 21:34)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/92825">https://github.com/rust-lang/rust/pull/92825</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>