<html>
<head><meta charset="utf-8"><title>perfbot and bootstrap · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html">perfbot and bootstrap</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269648778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269648778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269648778">(Jan 27 2022 at 22:19)</a>:</h4>
<p>@lqd had an interesting question: does the rustc-perf bot (that comments on CI runs in PRs) report on changes to bootstrap timings?</p>



<a name="269648863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269648863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269648863">(Jan 27 2022 at 22:20)</a>:</h4>
<p>I suspect not, because <a href="https://github.com/rust-lang/rust/pull/93066">https://github.com/rust-lang/rust/pull/93066</a> improved bootstrap by 8 seconds but there was no mention of that in the PR comments</p>



<a name="269649401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269649401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269649401">(Jan 27 2022 at 22:25)</a>:</h4>
<p>no, those aren't connected at all to the regular stats</p>



<a name="269649473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269649473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269649473">(Jan 27 2022 at 22:26)</a>:</h4>
<p>I'd love to switch them to using <code>perf stat</code>, and maybe directly integrate them as "just crates", though that might skew things too much</p>



<a name="269649524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269649524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269649524">(Jan 27 2022 at 22:26)</a>:</h4>
<p>Not sure how easy it is to get the significance algorithm running on them without making them regular entries in our database</p>



<a name="269679307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269679307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269679307">(Jan 28 2022 at 02:44)</a>:</h4>
<p>would switching them to <code>perf stat</code> also trivially give us data about max-rss?</p>



<a name="269680027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269680027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269680027">(Jan 28 2022 at 02:59)</a>:</h4>
<p>Yeah, if they used the same collection framework we'd get all the same statistics. (Memory usage might be a bit interesting since it's pretty strongly tied to parallelism, though.)</p>



<a name="269681876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269681876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269681876">(Jan 28 2022 at 03:28)</a>:</h4>
<p>someone was recently asking me about Out of Memory issues they were getting trying to build the compiler, and I realized that I'm out of touch about what the current requirements are there</p>



<a name="269681920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269681920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269681920">(Jan 28 2022 at 03:29)</a>:</h4>
<p>(and I mentioned to them that perhaps reducing the number of parallel builds could help alleviate that issue...)</p>



<a name="269682363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269682363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269682363">(Jan 28 2022 at 03:37)</a>:</h4>
<p>yeah, with big/little and similar architectures getting more and more popular I suspect we'll either need Cargo to be better at scaling not just with numcpus but with number of gigabytes, since more cores may not mean more memory in more cases</p>



<a name="269693398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269693398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269693398">(Jan 28 2022 at 06:43)</a>:</h4>
<p>Agreed. While I don't think we have the data to do this in <em>general</em> for arbitrary Rust builds, I think for rustc in particular we should clamp the autodetected number of CPUs for a build at something like RAM/1.5G or similar.</p>



<a name="269738117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269738117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269738117">(Jan 28 2022 at 13:50)</a>:</h4>
<p>if the jobserver protocol was more dynamic, I could imagine some kind of memory-sensitive scheme -- maybe even recording prior memory usage.</p>



<a name="269740935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269740935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269740935">(Jan 28 2022 at 14:08)</a>:</h4>
<p>On linux we could monitor PSI and use that to dynamically steal/re-issue/not-consume tokens.<br>
And I think better cargo-critical-path scheduling (which we talked about in another thread) might also cut down on memory consumption since it should lead to fewer crates being compiled at the same time because since the goal there would be to reduce crate-parallelism in favor of within-rustc parallelism when it's beneficial to do so.</p>



<a name="269799984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269799984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269799984">(Jan 28 2022 at 20:46)</a>:</h4>
<p><span class="user-mention" data-user-id="330154">@The 8472</span> I'd be super concerned about the jobserver protocol deadlocking if tokens are not consistently re-emitted by anything consuming them.</p>



<a name="269800025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269800025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269800025">(Jan 28 2022 at 20:46)</a>:</h4>
<p>At most, I think it might make sense for the "top-level" thing running the jobserver to sometimes eat or inject tokens itself. But only the "top-level" thing that actually created the jobserver pipe.</p>



<a name="269800278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269800278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269800278">(Jan 28 2022 at 20:48)</a>:</h4>
<p>Yeah, that was the idea. Does the kernel wake up pipe waiters based on thread priorities? If so the jobserver crate could run with normal priority and the rustc instances with reduced priority, this way it would always be able to take away a few tokens when necessary</p>



<a name="269805467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/perfbot%20and%20bootstrap/near/269805467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/perfbot.20and.20bootstrap.html#269805467">(Jan 28 2022 at 21:31)</a>:</h4>
<p>I think anything more advanced than what we do now (fixed sized jobserver) needs a different protocol to work well</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>