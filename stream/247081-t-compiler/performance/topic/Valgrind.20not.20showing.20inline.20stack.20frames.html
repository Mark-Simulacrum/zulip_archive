<html>
<head><meta charset="utf-8"><title>Valgrind not showing inline stack frames · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html">Valgrind not showing inline stack frames</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261872800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/261872800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#261872800">(Nov 18 2021 at 00:54)</a>:</h4>
<p>I had noticed that the stacks produced by DHAT weren't as good as they used to be. I tried bisecting rustc but couldn't find an old version that showed the good behaviour I expected. Then I bisected Valgrind and found it to be at fault: <a href="https://bugs.kde.org/show_bug.cgi?id=445668">https://bugs.kde.org/show_bug.cgi?id=445668</a></p>



<a name="261873556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/261873556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#261873556">(Nov 18 2021 at 01:03)</a>:</h4>
<p>It probably affects Massif too.</p>



<a name="261873603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/261873603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#261873603">(Nov 18 2021 at 01:04)</a>:</h4>
<p>But I may be the only person running those tools <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261874678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/261874678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#261874678">(Nov 18 2021 at 01:18)</a>:</h4>
<p>I didn't notice they got worse, but improvement seems excellent - I had to manually add instrumentation a couple times to "de-inline" things</p>



<a name="261950502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/261950502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#261950502">(Nov 18 2021 at 16:20)</a>:</h4>
<p>You are definitely not the only one running Valgrind</p>



<a name="261950547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/261950547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#261950547">(Nov 18 2021 at 16:20)</a>:</h4>
<p>but I guess you mean DHAT+Massif specifically.</p>



<a name="261983013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/261983013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#261983013">(Nov 18 2021 at 20:05)</a>:</h4>
<p>yeah</p>



<a name="261983170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/261983170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#261983170">(Nov 18 2021 at 20:06)</a>:</h4>
<p>I found two bad bugs in Valgrind affecting its ability to profile rustc within 2 weeks of starting work again, it's suggestive <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="261983602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/261983602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#261983602">(Nov 18 2021 at 20:10)</a>:</h4>
<p>I think we might have a gap in that few nightly+beta users are using Valgrind (despite the fact that our test suite … used to include running object code under valgrind during CI, IIRC), but there are definitely stable users employing Valgrind, and that can lead to us discovering Valgrind bugs later than I would like.</p>



<a name="262383241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262383241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262383241">(Nov 22 2021 at 21:59)</a>:</h4>
<p>Good news: the fix for the missing inline stack frames has been merged into Valgrind: <a href="https://bugs.kde.org/show_bug.cgi?id=445668">https://bugs.kde.org/show_bug.cgi?id=445668</a></p>



<a name="262383416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262383416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262383416">(Nov 22 2021 at 22:00)</a>:</h4>
<p>I wonder if I can convince Julian to do a 3.18.2 release in the not-too-distant future</p>



<a name="262679387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262679387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262679387">(Nov 25 2021 at 08:47)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> if you do so, it would be great to also do something about symbol name verbosity with the new mangling scheme. As you've seen, all fully qualified paths start with crate name and crate disambiguator (e.g. <code>core[1888027d9e9c7885]</code>). The disambiguator part (<code>[1888027d9e9c7885]</code>) is necessary in the mangled form to avoid symbol name conflicts but for a use case like valgrind it is not so important and could just be omitted. That is something that is under the control of the program doing the demangling, so it does not need changes in the compiler or the mangling scheme.</p>



<a name="262679517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262679517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262679517">(Nov 25 2021 at 08:48)</a>:</h4>
<p>Just to be clear: the inline stack frame is orthogonal to demangling.</p>



<a name="262679577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262679577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262679577">(Nov 25 2021 at 08:49)</a>:</h4>
<p>Valgrind uses an import of the libiberty demangler, so any demangling changes (such as handling <code>.llvm.&lt;numbers&gt;</code> suffixes, and stripping junk like <code>core[1888027d9e9c7885]</code>) would have to be put into libiberty and then imported into Valgrind.</p>



<a name="262680232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262680232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262680232">(Nov 25 2021 at 08:55)</a>:</h4>
<p>Yes, demangling is separate. But it would be good to get it into better shape before a new release :)</p>



<a name="262680315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262680315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262680315">(Nov 25 2021 at 08:56)</a>:</h4>
<p>If looks like the current code already has a verbosity flag that does the right thing here:<br>
<a href="https://github.com/sailfishos-mirror/valgrind/blob/49fe0dc74a07ea4c5077867e44127eb68466eded/coregrind/m_demangle/rust-demangle.c#L708-L713">https://github.com/sailfishos-mirror/valgrind/blob/49fe0dc74a07ea4c5077867e44127eb68466eded/coregrind/m_demangle/rust-demangle.c#L708-L713</a></p>



<a name="262680342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262680342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262680342">(Nov 25 2021 at 08:56)</a>:</h4>
<p>but I don't know if valgrind can control that</p>



<a name="262680580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262680580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262680580">(Nov 25 2021 at 08:58)</a>:</h4>
<p>anyway, sorry for hijacking the thread :)</p>



<a name="262699877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262699877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262699877">(Nov 25 2021 at 12:28)</a>:</h4>
<p>Controlling verbosity should be doable, but I don't understand exactly what "verbose" means in this context...</p>



<a name="262701348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Valgrind%20not%20showing%20inline%20stack%20frames/near/262701348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Valgrind.20not.20showing.20inline.20stack.20frames.html#262701348">(Nov 25 2021 at 12:47)</a>:</h4>
<p>Judging from the code linked to above it seems to control if</p>
<ul>
<li>the crate disambiguator is emitted (<code>std[123456789]::cmp::min</code> vs <code>std::cmp::min</code>),</li>
<li>const generic args are annotated with their type (<code>foo&lt;[u32; 123]&gt;</code> vs <code>foo&lt;[u32; 123: usize]&gt;</code>), and</li>
<li>if legacy scheme symbols have their hash attached (<code>std::cmp::min::h12345678</code> vs <code>std::cmp::min</code>)</li>
</ul>
<p>So it looks like switching to <code>verbose = false</code> is feasible.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>