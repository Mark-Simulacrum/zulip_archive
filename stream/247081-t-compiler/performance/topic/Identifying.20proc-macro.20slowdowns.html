<html>
<head><meta charset="utf-8"><title>Identifying proc-macro slowdowns · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html">Identifying proc-macro slowdowns</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="276545117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276545117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276545117">(Mar 24 2022 at 22:01)</a>:</h4>
<p>In one of my work projects I've found that incremental cargo check is spending 96% of its time in expand_crate</p>



<a name="276545139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276545139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276545139">(Mar 24 2022 at 22:01)</a>:</h4>
<p>are there any good ways of digging into where that time is going?</p>



<a name="276549804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276549804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276549804">(Mar 24 2022 at 22:55)</a>:</h4>
<p>Not any <em>good</em> ways. It's quite likely that it's a declarative macro rather than a proc macro causing the slowness, I've been working on a bunch of these lately.</p>



<a name="276549936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276549936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276549936">(Mar 24 2022 at 22:57)</a>:</h4>
<p>If you are comfortable building rustc from source, applying this diff will be informative:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">index</span><span class="w"> </span><span class="n">d8071bf159a</span><span class="o">..</span><span class="mf">7e8</span><span class="n">fe2b1e1c</span><span class="w"> </span><span class="mi">100644</span><span class="w"></span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_expand</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">mbe</span><span class="o">/</span><span class="n">macro_parser</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">compiler</span><span class="o">/</span><span class="n">rustc_expand</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">mbe</span><span class="o">/</span><span class="n">macro_parser</span><span class="p">.</span><span class="n">rs</span><span class="w"></span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">436</span><span class="p">,</span><span class="mi">6</span><span class="w"> </span><span class="o">+</span><span class="mi">436</span><span class="p">,</span><span class="mi">7</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="k">fn</span> <span class="nf">parse_tt_inner</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="n">ms</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">TokenTree</span><span class="p">],</span><span class="w"></span>
<span class="w">         </span><span class="n">token</span>: <span class="kp">&amp;</span><span class="nc">Token</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">NamedParseResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="o">+</span><span class="w">        </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"macro {}"</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">macro_name</span><span class="p">);</span><span class="w"></span>
<span class="w">         </span><span class="c1">// Matcher positions that would be valid if the macro invocation was over now. Only</span>
<span class="w">         </span><span class="c1">// modified if `token == Eof`.</span>
<span class="w">         </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">eof_items</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EofItems</span>::<span class="nb">None</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="276550052"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276550052" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276550052">(Mar 24 2022 at 22:58)</a>:</h4>
<p>I've learned that "tt muncher" and "push-down accumulation" macros (both described in <a href="https://veykril.github.io/tlborm/">https://veykril.github.io/tlborm/</a>) are inherently quadratic relative to their input length. So if you have any such macros, they might be the cause. Alternatively, you might be using such a macro from another crate.</p>



<a name="276550066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276550066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276550066">(Mar 24 2022 at 22:58)</a>:</h4>
<p>Better diagnosis of this stuff is an open question.</p>



<a name="276594302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594302">(Mar 25 2022 at 09:32)</a>:</h4>
<p>do you have a link to the repo that we could try ?</p>
<p>if not, maybe try something like this for a cargo check: <code>[profile.dev.build-override] opt-level = 3</code></p>
<p>it will ask for build scripts, proc-macros, and their dependencies to be optimized: it will slow down from-scratch compile times but if then <code>expand_crate</code> is noticeably faster, that should mean the slowness is coming from the proc-macros compared to the macro_rules macros</p>



<a name="276594485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594485">(Mar 25 2022 at 09:34)</a>:</h4>
<p>No, the repo is private</p>



<a name="276594504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594504">(Mar 25 2022 at 09:35)</a>:</h4>
<p>I suspect async-graphql</p>



<a name="276594524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594524">(Mar 25 2022 at 09:35)</a>:</h4>
<p>But we’re also using sqlx::query and query_as a bunch</p>



<a name="276594666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594666">(Mar 25 2022 at 09:37)</a>:</h4>
<p>and it's not the case where sqlx is making db queries during expansion, right ?</p>



<a name="276594706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594706">(Mar 25 2022 at 09:37)</a>:</h4>
<p>I’ve set the offline feature for sqlx and provide a sqlx-data.json</p>



<a name="276594724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594724">(Mar 25 2022 at 09:37)</a>:</h4>
<p>So at least theoretically it should not be waiting for the database</p>



<a name="276594785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594785">(Mar 25 2022 at 09:38)</a>:</h4>
<p>Oh, trace_macros! might also be useful</p>



<a name="276594804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594804">(Mar 25 2022 at 09:38)</a>:</h4>
<p>yes!</p>



<a name="276594849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594849">(Mar 25 2022 at 09:39)</a>:</h4>
<p>Oh yeah, I just lexically surround stuff with those calls right?</p>



<a name="276594871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594871">(Mar 25 2022 at 09:39)</a>:</h4>
<p>yeah</p>



<a name="276594984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276594984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276594984">(Mar 25 2022 at 09:40)</a>:</h4>
<p>if that's not enough, adding debug output to rustc if you're able or otherwise bisecting proc-macros by overriding the opt-level of select ones in your cargo.toml, until we do add better diagnostics :/</p>



<a name="276595584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/276595584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#276595584">(Mar 25 2022 at 09:47)</a>:</h4>
<p>(and complicated graphql queries sounds like a promising candidate, <a href="https://github.com/async-graphql/async-graphql/issues/783">https://github.com/async-graphql/async-graphql/issues/783</a> shows some possible workarounds if that's the source)</p>



<a name="277019473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277019473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277019473">(Mar 29 2022 at 15:10)</a>:</h4>
<p>I tried <code>trace_macros!()</code> on my graphql module and it seems like it doesn't take effect for attribute macros?</p>



<a name="277019537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277019537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277019537">(Mar 29 2022 at 15:11)</a>:</h4>
<p>I see a bunch of expansions for declarative macros and for function macros, but none for the attribute macros</p>



<a name="277036143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277036143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277036143">(Mar 29 2022 at 17:04)</a>:</h4>
<p>that's quite unfortunate, we're going to really need better diagnosis of such issues ...</p>



<a name="277151330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277151330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277151330">(Mar 30 2022 at 14:17)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/95473">#95473</a> should hopefully help, and you should be able to try it easily with <a href="https://github.com/kennytm/rustup-toolchain-install-master/">rustup-toolchain-install-master</a> like so <code>rustup-toolchain-install-master a121de4a30502064e6d60b71f035e0b005beeaff</code> once the try build completes.</p>
<p>Individual <code>expand_proc_macro</code> events will show up in the self-profiler, to e.g. <br>
1) find out whether these proc-macro expansions are slow in general: by comparing the aggregate duration to the other activities via <code>summarize</code><br>
2) diagnose which ones are taking a long time: you can ask to record the proc-macro name as an argument when capturing self-profiling event arguments with <code>-Zself-profile -Zself-profile-events=default,args</code>.</p>
<p>For example, for these 3 types of slow proc-macros</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[proc_macro]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">macro_function_like</span><span class="p">(</span><span class="n">_item</span>: <span class="nc">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TokenStream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">thread</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">TokenStream</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[proc_macro_derive(MacroDerive)]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">macro_derive</span><span class="p">(</span><span class="n">_item</span>: <span class="nc">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TokenStream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">thread</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">TokenStream</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cp">#[proc_macro_attribute]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">macro_attribute</span><span class="p">(</span><span class="n">_attr</span>: <span class="nc">TokenStream</span><span class="p">,</span><span class="w"> </span><span class="n">_item</span>: <span class="nc">TokenStream</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">TokenStream</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">thread</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="n">TokenStream</span>::<span class="n">new</span><span class="p">()</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The raw <code>.mm_profdata</code> data for <code>measureme</code> for the 1st use-case will look this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">expand_proc_macro</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="p">[],</span><span class="w"> </span><span class="n">duration</span>: <span class="mf">2.000253166</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="n">GenericActivity</span><span class="p">)</span><span class="w"></span>
<span class="n">expand_proc_macro</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="p">[],</span><span class="w"> </span><span class="n">duration</span>: <span class="mf">1.000153694</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="n">GenericActivity</span><span class="p">)</span><span class="w"></span>
<span class="n">expand_proc_macro</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="p">[],</span><span class="w"> </span><span class="n">duration</span>: <span class="mf">3.000153118</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="n">GenericActivity</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>and in <code>summarize</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">+-----------------------------+-----------+-----------------+----------+------------+---------------------------------+</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">Item</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="bp">Self</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Time</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">Item</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Incremental</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">hashing</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">|</span><span class="w"></span>
<span class="o">+-----------------------------+-----------+-----------------+----------+------------+---------------------------------+</span><span class="w"></span>
<span class="o">|</span><span class="w"> </span><span class="n">expand_proc_macro</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="mf">6.00</span><span class="n">s</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mf">94.153</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="mf">6.00</span><span class="n">s</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">3</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="mf">0.00</span><span class="n">ns</span><span class="w">                          </span><span class="o">|</span><span class="w"></span>
</code></pre></div>
<p>The 2nd use-case will look like this with event arguments turned on:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">expand_proc_macro</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="p">[</span><span class="s">"MacroDerive"</span><span class="p">],</span><span class="w"> </span><span class="n">duration</span>: <span class="mf">2.000263228</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="n">GenericActivity</span><span class="p">)</span><span class="w"></span>
<span class="n">expand_proc_macro</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="p">[</span><span class="s">"macro_function_like"</span><span class="p">],</span><span class="w"> </span><span class="n">duration</span>: <span class="mf">1.000145736</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="n">GenericActivity</span><span class="p">)</span><span class="w"></span>
<span class="n">expand_proc_macro</span><span class="p">,</span><span class="w"> </span><span class="n">args</span>: <span class="p">[</span><span class="s">"macro_attribute"</span><span class="p">],</span><span class="w"> </span><span class="n">duration</span>: <span class="mf">3.000157216</span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="n">GenericActivity</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>The latter being more commonly readable processed with <code>crox</code> and visualized in Chrome's profiler: after clicking on the first <code>expand_proc_macro</code> event, the name is visible in the properties panel at the bottom.</p>
<p><a href="/user_uploads/4715/UHz4JVxfm5hDINTqdRlFWWrR/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/UHz4JVxfm5hDINTqdRlFWWrR/image.png" title="image.png"><img src="/user_uploads/4715/UHz4JVxfm5hDINTqdRlFWWrR/image.png"></a></div>



<a name="277209305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277209305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277209305">(Mar 30 2022 at 22:00)</a>:</h4>
<p>Thanks, going to try that tomorrow!</p>



<a name="277209661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277209661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277209661">(Mar 30 2022 at 22:04)</a>:</h4>
<p>it seems likely that it's going to point at the graphql proc-macro you mentioned; so maybe in the future we should also add a separate flag to track where each expansion happens, to separate the multiple calls to the same proc-macro</p>



<a name="277266712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277266712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277266712">(Mar 31 2022 at 11:34)</a>:</h4>
<p>argh, got bitten again by Apple Silicon being tier 2 :(</p>



<a name="277274332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277274332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277274332">(Mar 31 2022 at 12:44)</a>:</h4>
<p>Okay, I built a compiler from source</p>



<a name="277274368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277274368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277274368">(Mar 31 2022 at 12:44)</a>:</h4>
<p>what's the easiest way to get Cargo to call it?</p>



<a name="277274394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277274394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277274394">(Mar 31 2022 at 12:45)</a>:</h4>
<p>currently I have not installed it in anyway, but I could install it to some prefix if that helps</p>



<a name="277274539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277274539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277274539">(Mar 31 2022 at 12:46)</a>:</h4>
<p><code>rustup toolchain link stage1 build/$TRIPLE/stage1; cargo +stage1 b</code></p>



<a name="277274648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277274648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277274648">(Mar 31 2022 at 12:47)</a>:</h4>
<p>should I get the stage1 or the stage2? why?</p>



<a name="277275177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277275177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277275177">(Mar 31 2022 at 12:51)</a>:</h4>
<p>I believe from a performance perspective stage1 and stage2 are the same (i.e., will have the same optimizations applied to both).</p>



<a name="277275836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277275836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277275836">(Mar 31 2022 at 12:56)</a>:</h4>
<p>Theoretically stage1 could run slower but it will generate exactly the same code as stage2. The difference is mostly important for the ABI of rustc_private.</p>



<a name="277278380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277278380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277278380">(Mar 31 2022 at 13:15)</a>:</h4>
<p>stage1 should be good enough yeah</p>



<a name="277278606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277278606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277278606">(Mar 31 2022 at 13:16)</a>:</h4>
<p>but at least locally building will allow you to add more precise logging, compared to trying the PR on linux on CI or something</p>



<a name="277280628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277280628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277280628">(Mar 31 2022 at 13:31)</a>:</h4>
<p>in particular, with the timing already there in the PR: adding a debug print of the span where the proc macros are invoked eg <a href="https://github.com/rust-lang/rust/blob/f47f3f35ba9738b9101cc7ef6f62ae2908dd8404/compiler/rustc_expand/src/proc_macro.rs#L25">https://github.com/rust-lang/rust/blob/f47f3f35ba9738b9101cc7ef6f62ae2908dd8404/compiler/rustc_expand/src/proc_macro.rs#L25</a> should be telling you the culprits</p>



<a name="277304909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277304909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277304909">(Mar 31 2022 at 16:10)</a>:</h4>
<p>just to ensure that there's no allocation here when event arguments are not recorded by the self-profiler, and to always add the span as another arg, maybe we could add an API to the self-profiler with a closure à la <code>prof.generic_activity_with("expand_proc_macro", || format!("{} from {:?}", self.name, span))</code> </p>
<p>otherwise I'm not sure how to make sure of this with the self-profiler ? cc <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> </p>
<p>sometimes <code>generic_activity_with_arg</code> is used with <a href="https://github.com/rust-lang/rust/blob/03314912f1361af6b39383958b5aa1b4aed61c26/compiler/rustc_codegen_llvm/src/back/write.rs#L724-L725">a <code>format!</code> arg</a> directly but the string will be ignored most of the time</p>



<a name="277338868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277338868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277338868">(Mar 31 2022 at 20:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116113">@lqd</span> that seems totally reasonable. I think as of right now, we aren't using <code>generic_activity_with_arg</code> in any places that are sufficently hot for the allocation to matter but it would be great to support capturing more data in those kind of contexts.</p>



<a name="277987000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/277987000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#277987000">(Apr 06 2022 at 07:54)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/95473">#95473</a> has landed btw and should be available in tomorrow's nightly. <a href="https://github.com/rust-lang/rust/issues/95689">#95689</a> should add some infrastructure to also record proc-macro expansion spans.</p>
<p>and maybe we'll do the actual span recording changes in another PR, depending on whether wesley would prefer these changes to be included in 95689 or not</p>



<a name="278036004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/278036004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#278036004">(Apr 06 2022 at 14:57)</a>:</h4>
<p>Yeah, I did try this last week but wasn't able to as clearly reproduce the slow cargo check runs</p>



<a name="278036048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/278036048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#278036048">(Apr 06 2022 at 14:57)</a>:</h4>
<p>Will take another swing at trying this soon when I'm working on that part of the code again</p>



<a name="278036182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/278036182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dirkjan Ochtman <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#278036182">(Apr 06 2022 at 14:58)</a>:</h4>
<p>Also when I tried I didn't actually see/find the expanded lines in the summarize output</p>



<a name="278039310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/278039310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#278039310">(Apr 06 2022 at 15:16)</a>:</h4>
<p>I think there may be some expansions for ... dependencies maybe ? ... that don't go through these paths, or something that I don't fully understand yet. I was able to get the expansion events for local lib and bin, but not from dependencies even when recording over the whole crate graph...</p>



<a name="278074557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Identifying%20proc-macro%20slowdowns/near/278074557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Identifying.20proc-macro.20slowdowns.html#278074557">(Apr 06 2022 at 19:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116113">lqd</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Identifying.20proc-macro.20slowdowns/near/277987000">said</a>:</p>
<blockquote>
<p>and maybe we'll do the actual span recording changes in another PR, depending on whether wesley would prefer these changes to be included in 95689 or not</p>
</blockquote>
<p>we indeed did that, and I opened <a href="https://github.com/rust-lang/rust/issues/95739">#95739</a> as draft until <a href="https://github.com/rust-lang/rust/issues/95689">#95689</a> lands (since it contains its commits) to also record expansion spans in the event arguments (and in case people would like a <code>try</code> build in the meantime)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>