<html>
<head><meta charset="utf-8"><title>Distinguishing compiler vs compiler output perf regressions · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html">Distinguishing compiler vs compiler output perf regressions</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="264759979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264759979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264759979">(Dec 13 2021 at 19:48)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/91840">#91840</a> regressed perf, but this PR probably causes non-trivial changes to compiler output. Is there a good way for me to test if the output is worse or if I just need to improve the perf of the mir opt itself? (do we have some kind of benchmark suite for rustc output?)</p>



<a name="264760200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264760200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264760200">(Dec 13 2021 at 19:50)</a>:</h4>
<p>No, but you can sometimes guesstimate it from the change in rustdoc performance. Rustdoc is mostly just a ton of memory allocations though</p>



<a name="264760594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264760594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264760594">(Dec 13 2021 at 19:53)</a>:</h4>
<p>that regression is likely just <a href="https://github.com/rust-lang/rustc-perf/issues/1105">https://github.com/rust-lang/rustc-perf/issues/1105</a>, so I wouldn't directly worry about it</p>



<a name="264760928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264760928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264760928">(Dec 13 2021 at 19:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions/near/264760594">said</a>:</p>
<blockquote>
<p>that regression is likely just <a href="https://github.com/rust-lang/rustc-perf/issues/1105">https://github.com/rust-lang/rustc-perf/issues/1105</a>, so I wouldn't directly worry about it</p>
</blockquote>
<p>Ah good to know, but even then the changes are much more mixed than I'd like it to be for an MIR <em>optimization</em> <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span> I'll take a look to see if there are any obvious improvements I can make (there was also a previous PR that claimed to pull 5% off a similar strategy so also will look at what's different there)</p>



<a name="264761015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264761015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264761015">(Dec 13 2021 at 19:56)</a>:</h4>
<p>The rustdoc changes are a consistent 0.00% to 0.01%</p>



<a name="264761076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264761076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264761076">(Dec 13 2021 at 19:57)</a>:</h4>
<p>hm</p>



<a name="264761106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264761106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264761106">(Dec 13 2021 at 19:57)</a>:</h4>
<p>so generally speaking it's more like "results are not changing perf", I'd say</p>



<a name="264761202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264761202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264761202">(Dec 13 2021 at 19:57)</a>:</h4>
<p>it's potentially the case that the optimization is not worth it as-is, though</p>



<a name="264761341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264761341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264761341">(Dec 13 2021 at 19:58)</a>:</h4>
<p>Aren't Mir opts off by default? Are you sure yours is actually running?</p>



<a name="264761830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264761830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264761830">(Dec 13 2021 at 20:01)</a>:</h4>
<p>That's... a good point. I will test that too (after I do my homework because despite rustc being fun I would also like to graduate!)</p>



<a name="264778367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264778367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264778367">(Dec 13 2021 at 22:15)</a>:</h4>
<p>Each mir opt needs to individually decide at which mir opt level it runs. Currently this means doing an early return from the optimization if the required mir opt level is not enabled.</p>



<a name="264946049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Distinguishing%20compiler%20vs%20compiler%20output%20perf%20regressions/near/264946049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jake <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions.html#264946049">(Dec 14 2021 at 23:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232545">Joshua Nelson</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Distinguishing.20compiler.20vs.20compiler.20output.20perf.20regressions/near/264760200">said</a>:</p>
<blockquote>
<p>No, but you can sometimes guesstimate it from the change in rustdoc performance. Rustdoc is mostly just a ton of memory allocations though</p>
</blockquote>
<p>By the way, I figured out the hard way that you can get something nearly equivalent by locally benching the stage 1 compiler which will run the optimization pass but is not itself built with the optimization on</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>