<html>
<head><meta charset="utf-8"><title>hardware counter (rdpmc) measurements · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html">hardware counter (rdpmc) measurements</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="204432110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204432110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204432110">(Jul 20 2020 at 14:52)</a>:</h4>
<p>so I finally got around to making this work: it seems to be relatively stable <a href="https://gist.github.com/eddyb/e405cef307a4aebbbda3406e17c42173">https://gist.github.com/eddyb/e405cef307a4aebbbda3406e17c42173</a></p>



<a name="204432133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204432133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204432133">(Jul 20 2020 at 14:53)</a>:</h4>
<p>although I did this by hand, I should automate it lol</p>



<a name="204432224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204432224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204432224">(Jul 20 2020 at 14:53)</a>:</h4>
<p>(I took two runs and manually paired them to the right crate)</p>



<a name="204432326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204432326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204432326">(Jul 20 2020 at 14:54)</a>:</h4>
<p>ideally I can get just one crate I can keep measuring. <code>core</code> seems like a good low-effort candidate</p>



<a name="204432719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204432719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204432719">(Jul 20 2020 at 14:57)</a>:</h4>
<p>what's weird is using <code>-j1</code> feels much slower but I still get <code>12785...</code> for core. is that Cargo's pipelining not kicking in? so I guess passing <code>-j1</code> to <code>x.py</code> doesn't make the <code>core</code> compilation itself slower, it's just less visually active</p>



<a name="204432951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204432951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204432951">(Jul 20 2020 at 14:58)</a>:</h4>
<p>hm I would've expected -j1 to make core compilation slower, unless you've messed with codegen-units-std or something like that</p>



<a name="204432974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204432974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204432974">(Jul 20 2020 at 14:58)</a>:</h4>
<p>maybe we're defaulting to codegen-units-std = 1? I forget</p>



<a name="204433225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433225">(Jul 20 2020 at 15:00)</a>:</h4>
<p>anyway <code>--emit=metadata</code> gives me 93G (as opposed to 127G), and that shouldn't get into multithreaded nonsense</p>



<a name="204433555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433555">(Jul 20 2020 at 15:03)</a>:</h4>
<p>would be interesting to see how that compares to <code>perf stat -e instructions:u</code> for that same crate</p>



<a name="204433593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433593">(Jul 20 2020 at 15:03)</a>:</h4>
<p>if I'm following you correctly that you're sticking this around the whole compilation or so?</p>



<a name="204433610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433610">(Jul 20 2020 at 15:03)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> first sad news: running under <code>perf stat</code>results in <code>index = 0</code> (i.e counter is disabled) in my code. I guess I should check that at the very start, when I make sure it's supported, so I don't crash. but it probably means we can't do both internal and external perf counter collection<br>
(<strong>EDIT</strong>: see below, it can work for a subset of counters)</p>



<a name="204433656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433656">(Jul 20 2020 at 15:03)</a>:</h4>
<p>yeah it's from <code>rustc_data_structures::profiling::SelfProfiler</code> being created, to it being dropped</p>



<a name="204433664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433664">(Jul 20 2020 at 15:04)</a>:</h4>
<p>we could plausibly "move in" perf stat into self-profile infra I guess?</p>



<a name="204433714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433714">(Jul 20 2020 at 15:04)</a>:</h4>
<p>just do whatever it does ourselves</p>



<a name="204433729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433729">(Jul 20 2020 at 15:04)</a>:</h4>
<p>not sure how hard that'd be</p>



<a name="204433743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433743">(Jul 20 2020 at 15:04)</a>:</h4>
<p>well I wanted to validate my results</p>



<a name="204433761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433761">(Jul 20 2020 at 15:04)</a>:</h4>
<p>I guess you can compare separate runs</p>



<a name="204433776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433776">(Jul 20 2020 at 15:04)</a>:</h4>
<p>good point about <code>-e</code>, I guess maybe it just runs out of hardware registers</p>



<a name="204433825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433825">(Jul 20 2020 at 15:05)</a>:</h4>
<p>well.. <em>both</em> monitoring instructions maybe isn't supported by the kernel? I don't really know</p>



<a name="204433864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204433864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204433864">(Jul 20 2020 at 15:05)</a>:</h4>
<p>okay not crashing!</p>



<a name="204434027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434027">(Jul 20 2020 at 15:06)</a>:</h4>
<div class="codehilite"><pre><span></span><code>93,352,538,263 (mine)
93,387,254,621 (perf stat)
</code></pre></div>



<a name="204434305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434305">(Jul 20 2020 at 15:08)</a>:</h4>
<p>are those separate runs? Or are we just missing ~35M instructions?</p>



<a name="204434315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434315">(Jul 20 2020 at 15:08)</a>:</h4>
<p>I guess it's not that much</p>



<a name="204434343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434343">(Jul 20 2020 at 15:08)</a>:</h4>
<p>presumably most of that is before the self profiler starts</p>



<a name="204434362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434362">(Jul 20 2020 at 15:09)</a>:</h4>
<p>or maybe after, idk what kind of teardown we do</p>



<a name="204434365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434365">(Jul 20 2020 at 15:09)</a>:</h4>
<p>ah, interesting. I guess we could move things up into <code>fn main() {}</code> in src/rustc/mod.rs?</p>



<a name="204434380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434380">(Jul 20 2020 at 15:09)</a>:</h4>
<p>er, <a href="http://main.rs">main.rs</a></p>



<a name="204434393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434393">(Jul 20 2020 at 15:09)</a>:</h4>
<p>well, the driver I guess, but sure</p>



<a name="204434428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434428">(Jul 20 2020 at 15:09)</a>:</h4>
<p>my setup right now: <a href="/user_uploads/4715/Y1zFv8WqbvQLM2zu3o3rDm3T/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/Y1zFv8WqbvQLM2zu3o3rDm3T/image.png" title="image.png"><img src="/user_uploads/4715/Y1zFv8WqbvQLM2zu3o3rDm3T/image.png"></a></div>



<a name="204434611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434611">(Jul 20 2020 at 15:11)</a>:</h4>
<p>Thanks for working on this <span class="user-mention" data-user-id="119009">@eddyb</span>. This is really slick!</p>



<a name="204434676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434676">(Jul 20 2020 at 15:11)</a>:</h4>
<p>seems "good enough" though to land initially at least</p>



<a name="204434761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434761">(Jul 20 2020 at 15:12)</a>:</h4>
<p>I kinda have to, this is a prerequisite for some data collection that needs to be query-level and the current (timing) data is too noisy :(</p>



<a name="204434802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434802">(Jul 20 2020 at 15:12)</a>:</h4>
<p>/me handwaves away the fact that this is like two months late</p>



<a name="204434864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204434864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204434864">(Jul 20 2020 at 15:13)</a>:</h4>
<p>anyway the fun part starts now, I want to measure the overhead of sampling this every time we sample the clock</p>



<a name="204435043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204435043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204435043">(Jul 20 2020 at 15:14)</a>:</h4>
<p>so I'll probably just run, idk, 100 compilations of <code>core</code> to get some solid data then try to do some basic stats on it. the more precision I can get, the better I can estimate the fine-grained sampling overhead</p>



<a name="204445893"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204445893" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204445893">(Jul 20 2020 at 16:44)</a>:</h4>
<p>so uhh <a href="/user_uploads/4715/fSUKCn3_-emgs_hqRtBzZWLB/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/fSUKCn3_-emgs_hqRtBzZWLB/image.png" title="image.png"><img src="/user_uploads/4715/fSUKCn3_-emgs_hqRtBzZWLB/image.png"></a></div>



<a name="204445933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204445933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204445933">(Jul 20 2020 at 16:44)</a>:</h4>
<p>I tried to make a really tall window to show how little variance there is</p>



<a name="204445966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204445966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204445966">(Jul 20 2020 at 16:45)</a>:</h4>
<p>but it doesn't <em>really</em> get across</p>



<a name="204446126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204446126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204446126">(Jul 20 2020 at 16:46)</a>:</h4>
<p>(blue is some initial data, red is 100 measurements. same metholodogy though)</p>



<a name="204446235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204446235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204446235">(Jul 20 2020 at 16:47)</a>:</h4>
<p><a href="http://perf.rust-lang.org">perf.rust-lang.org</a> uses an absolute scale, doesn't it? and yet we can often see variance, even in <code>instructions:u</code>?</p>



<a name="204446286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204446286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204446286">(Jul 20 2020 at 16:47)</a>:</h4>
<p>but I guess using the same exact compiler, and having no dependencies (because libcore) might make it less susceptible to certain effects</p>



<a name="204446679"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204446679" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204446679">(Jul 20 2020 at 16:51)</a>:</h4>
<p><a href="/user_uploads/4715/0SfERORAyv-bn5QmLX1ptG5x/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/0SfERORAyv-bn5QmLX1ptG5x/image.png" title="image.png"><img src="/user_uploads/4715/0SfERORAyv-bn5QmLX1ptG5x/image.png"></a></div>



<a name="204446712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204446712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204446712">(Jul 20 2020 at 16:51)</a>:</h4>
<p>this is more representative, but you're only seeing like 1% of the range</p>



<a name="204446860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204446860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204446860">(Jul 20 2020 at 16:52)</a>:</h4>
<p><span class="user-mention" data-user-id="130111">@anp</span> ^^ btw if you're on Zulip, you can track my adventures here</p>



<a name="204451093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204451093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204451093">(Jul 20 2020 at 17:29)</a>:</h4>
<p>so I can observe an overhead (to sample on every timing start/end), but it's only like 0.5%. if I hardcode some of the values (and expect they're not changed after the initial configuration), I can try to lower it. but I think it's acceptable?</p>



<a name="204451202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204451202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204451202">(Jul 20 2020 at 17:30)</a>:</h4>
<p>I should also be able to measure the overhead of <code>measureme</code> itself (but that's easier done with <code>perf stat</code> on an unmodified <code>rustc</code>, since my code won't run without <code>-Z self-profile</code>)</p>



<a name="204451207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204451207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> anp <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204451207">(Jul 20 2020 at 17:30)</a>:</h4>
<p>that seems like reasonably low sampling overhead</p>



<a name="204451267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204451267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204451267">(Jul 20 2020 at 17:31)</a>:</h4>
<p>oh and also this is a debug-assertions <code>rustc</code> build, I keep forgetting that :P</p>



<a name="204513894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204513894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204513894">(Jul 21 2020 at 05:41)</a>:</h4>
<p><a href="/user_uploads/4715/ewJm2r4sf3P-RqOeR8s6XAbY/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/ewJm2r4sf3P-RqOeR8s6XAbY/image.png" title="image.png"><img src="/user_uploads/4715/ewJm2r4sf3P-RqOeR8s6XAbY/image.png"></a></div>



<a name="204514020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514020">(Jul 21 2020 at 05:44)</a>:</h4>
<p>so this is the sampling overhead, at the most dynamic configuration it can be, I think, but without writing any of the data out (just using <code>black_box</code>)</p>



<a name="204514259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514259">(Jul 21 2020 at 05:50)</a>:</h4>
<p>so if I remove any of the dynamic reads from the mmap page, and the seqlock loop entirely, I'm left with just a <code>rdpmc</code> instruction and a sign-extension from 48-bit to 64-bit. so that should be "minimal overhead possible"</p>



<a name="204514287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514287">(Jul 21 2020 at 05:51)</a>:</h4>
<p>although after I check this, I should also add <code>#[inline]</code> everywhere relevant to make sure I'm not hiding anything behind unoptimizable calls</p>



<a name="204514522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514522">(Jul 21 2020 at 05:56)</a>:</h4>
<p><span class="user-mention" data-user-id="279335">@Jim Blandy</span> oh hey any chance you're on Zulip? this is the thread where I'm documenting my adventures in <code>rdpmc</code> :D</p>



<a name="204514578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514578">(Jul 21 2020 at 05:58)</a>:</h4>
<p><span class="user-mention" data-user-id="116155">@Jake Goulding</span> btw you may be pleased to hear that AArch64 is the only other architecture that has examples floating around of reading performance counters in userspace for fine-grained profiling (e.g. <a href="https://github.com/deater/perf_event_tests/blob/a379ad31192c0780278507b0acefe70d872fb643/tests/rdpmc/rdpmc_inlines.h#L46-L56">https://github.com/deater/perf_event_tests/blob/a379ad31192c0780278507b0acefe70d872fb643/tests/rdpmc/rdpmc_inlines.h#L46-L56</a>)</p>



<a name="204514582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514582">(Jul 21 2020 at 05:59)</a>:</h4>
<p>I'm not sure what architectures 1. even have such counters 2. have support for reading those counters by the Linux kernel</p>



<a name="204514599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514599">(Jul 21 2020 at 05:59)</a>:</h4>
<p>so this would be like the one thing I could use an AArch64 machine for... ah but it wouldn't even be macOS, I just realized</p>



<a name="204514658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514658">(Jul 21 2020 at 06:01)</a>:</h4>
<p>a quick search suggests macOS doesn't have any kind of official support for enabling measurements from userspace :(</p>



<a name="204514725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514725">(Jul 21 2020 at 06:02)</a>:</h4>
<p>so yeah the relevant hardware here would be one of those "a lot of 64-bit-only cores" server CPUs or, uhh, a raspberry pi 4?</p>



<a name="204514800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514800">(Jul 21 2020 at 06:04)</a>:</h4>
<p>sorry, got a bit excited there. we can keep it x86-only for now (I think 32-bit vs 64-bit doesn't even matter? but I haven't tested anything on 32-bit rustc)</p>



<a name="204514822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514822">(Jul 21 2020 at 06:05)</a>:</h4>
<p><a href="/user_uploads/4715/n7XjUSD8qwoM_w0ANeGyLDGh/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/n7XjUSD8qwoM_w0ANeGyLDGh/image.png" title="image.png"><img src="/user_uploads/4715/n7XjUSD8qwoM_w0ANeGyLDGh/image.png"></a></div>



<a name="204514835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514835">(Jul 21 2020 at 06:05)</a>:</h4>
<p>this one is the same as above, but I just realized that you can see noise much better if it's less wide</p>



<a name="204514884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514884">(Jul 21 2020 at 06:06)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="130111">@anp</span> okay what keeps weirding me out about this is that it's nothing like the self-profiling graphs I made before where it looks like there's a "baseline" and outliers that "jump up" from it</p>



<a name="204514894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514894">(Jul 21 2020 at 06:07)</a>:</h4>
<p>but here the noise looks... "balanced"?</p>



<a name="204514906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514906">(Jul 21 2020 at 06:07)</a>:</h4>
<p>I wonder how flat it would get if ASLR were disabled, lol</p>



<a name="204514982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514982">(Jul 21 2020 at 06:08)</a>:</h4>
<p><a href="https://github.com/rust-lang/rustc-perf/pull/661">https://github.com/rust-lang/rustc-perf/pull/661</a> is the data I'm thinking of, relying on "plateaus" where rustc performance shouldn't really change much</p>



<a name="204514996"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204514996" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204514996">(Jul 21 2020 at 06:09)</a>:</h4>
<p>oh right the self-profiling data has the same behavior as wall-time, instruction counts don't have that behavior</p>



<a name="204515059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204515059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204515059">(Jul 21 2020 at 06:10)</a>:</h4>
<p>it almost seems like we could get higher-quality timings somehow, those "spikes" must be some huge events. I wonder what we can cheaply get from the kernel that tries to measure only your userspace activity and cuts out anything else</p>



<a name="204515101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204515101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204515101">(Jul 21 2020 at 06:11)</a>:</h4>
<p>(I still want instruction counts, but the noise on wall-time seems comically large if you think about it)</p>



<a name="204515614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204515614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204515614">(Jul 21 2020 at 06:24)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> oh nice apparently you <em>can</em> disable ASLR for one process :D <a href="https://askubuntu.com/a/507954">https://askubuntu.com/a/507954</a></p>



<a name="204515804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204515804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204515804">(Jul 21 2020 at 06:30)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> hey if you're bored, can you <code>perf stat -e instructions:u</code> this about a dozen times on the server rustc-perf runs on?<br>
<code>rustc $(rustc --print=sysroot)/lib/rustlib/src/rust/src/libcore/lib.rs --edition=2018 --crate-type=lib --crate-name=core --emit=metadata -Zself-profile</code></p>



<a name="204515859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204515859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204515859">(Jul 21 2020 at 06:30)</a>:</h4>
<p>doesn't really matter what version (could even be stable with <code>RUSTC_BOOTSTRAP=1</code>), I'm just interested in general what kind of variance one would get on that server</p>



<a name="204515884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204515884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204515884">(Jul 21 2020 at 06:31)</a>:</h4>
<p>it's probably the easiest way to filter out differences in the setup (since I can do the same and we can just stare at the data)</p>



<a name="204516276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204516276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204516276">(Jul 21 2020 at 06:41)</a>:</h4>
<p>hmpf it doesn't look like disabling ASLR impacts the (tiny) instructions:u noise I'm seeing</p>



<a name="204516988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204516988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204516988">(Jul 21 2020 at 06:57)</a>:</h4>
<p><span class="user-mention" data-user-id="130111">@anp</span> are 1D scatter/density plots a thing? or I guess one of the axes could be "which test setup this is" and the other has all 100 values measured with that setup?</p>



<a name="204517005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204517005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204517005">(Jul 21 2020 at 06:57)</a>:</h4>
<p>maybe I can make plotly give me that</p>



<a name="204521997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204521997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204521997">(Jul 21 2020 at 08:17)</a>:</h4>
<p><a href="/user_uploads/4715/H7QQJSmyg32WGwbSWiArRElS/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/H7QQJSmyg32WGwbSWiArRElS/image.png" title="image.png"><img src="/user_uploads/4715/H7QQJSmyg32WGwbSWiArRElS/image.png"></a></div>



<a name="204522012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204522012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204522012">(Jul 21 2020 at 08:17)</a>:</h4>
<p>this feels terrible but it's roughly what I want? well, kind of</p>



<a name="204522146"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204522146" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204522146">(Jul 21 2020 at 08:19)</a>:</h4>
<p>Criterion has violin plots</p>



<a name="204522213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204522213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204522213">(Jul 21 2020 at 08:20)</a>:</h4>
<p>oh I forgot those existed</p>



<a name="204524419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204524419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204524419">(Jul 21 2020 at 08:49)</a>:</h4>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span> okay violin works great!</p>



<a name="204524753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204524753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204524753">(Jul 21 2020 at 08:53)</a>:</h4>
<p><a href="/user_uploads/4715/Z5IhmNxbPNVYDLFxdsD3EC3_/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/Z5IhmNxbPNVYDLFxdsD3EC3_/image.png" title="image.png"><img src="/user_uploads/4715/Z5IhmNxbPNVYDLFxdsD3EC3_/image.png"></a></div>



<a name="204524869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204524869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204524869">(Jul 21 2020 at 08:54)</a>:</h4>
<p>so yeah ASLR isn't an improvement, it would show up as wider and less tall if it were less noisy, wouldn't it?</p>



<a name="204529531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204529531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204529531">(Jul 21 2020 at 09:55)</a>:</h4>
<p>oh wow, <code>measureme</code> hasn't been updated since January <a href="https://github.com/rust-lang/rust/blame/master/src/librustc_data_structures/Cargo.toml#L30">https://github.com/rust-lang/rust/blame/master/src/librustc_data_structures/Cargo.toml#L30</a></p>



<a name="204529787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204529787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204529787">(Jul 21 2020 at 09:58)</a>:</h4>
<p>that means it should be easy to do what I need to by patching <code>measureme 0.7.1</code> (since I'm only interested in rustc versions in the past few months)</p>



<a name="204530805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204530805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204530805">(Jul 21 2020 at 10:13)</a>:</h4>
<p><a href="/user_uploads/4715/YpPQhmbtEUptF6LjudhDuWox/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/YpPQhmbtEUptF6LjudhDuWox/image.png" title="image.png"><img src="/user_uploads/4715/YpPQhmbtEUptF6LjudhDuWox/image.png"></a></div>



<a name="204530822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204530822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204530822">(Jul 21 2020 at 10:13)</a>:</h4>
<p>inlining makes a huge impact, that's nice</p>



<a name="204531065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204531065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204531065">(Jul 21 2020 at 10:17)</a>:</h4>
<p>the overhead of the newest attempt (i.e. the increase between the bottom two), using the medians is:<br>
<strong>0.12%</strong></p>



<a name="204533378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204533378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204533378">(Jul 21 2020 at 10:48)</a>:</h4>
<p>huh maybe these are how we should display things on compare page on perf (at least optionally)</p>



<a name="204533920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204533920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204533920">(Jul 21 2020 at 10:55)</a>:</h4>
<p>btw I'm using <a href="https://chart-studio.plotly.com/create">https://chart-studio.plotly.com/create</a> because it's incredibly convenient to just copy-paste some data in</p>



<a name="204538382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204538382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204538382">(Jul 21 2020 at 11:57)</a>:</h4>
<p><a href="/user_uploads/4715/QRTbHw5_PFBLm3sodcjKggrV/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/QRTbHw5_PFBLm3sodcjKggrV/image.png" title="image.png"><img src="/user_uploads/4715/QRTbHw5_PFBLm3sodcjKggrV/image.png"></a></div>



<a name="204538408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204538408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204538408">(Jul 21 2020 at 11:57)</a>:</h4>
<p>seems like disabling ASLR is a waste of time, although I don't even know if the command I'm using works :P</p>



<a name="204538730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204538730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204538730">(Jul 21 2020 at 12:01)</a>:</h4>
<p>re arm/aarch if its something trivial that you're running, I can run it on my aarch box.</p>



<a name="204538736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204538736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204538736">(Jul 21 2020 at 12:01)</a>:</h4>
<p>oh nice</p>



<a name="204538752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204538752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204538752">(Jul 21 2020 at 12:01)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> it's a small patch on top of rustc, and then just compiling libcore with that</p>



<a name="204538827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204538827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204538827">(Jul 21 2020 at 12:02)</a>:</h4>
<p>but it does require an AArch64 build of rustc, which we normally wouldn't get out of a <code>try</code> build</p>



<a name="204571636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204571636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204571636">(Jul 21 2020 at 16:42)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> </p>
<div class="codehilite"><pre><span></span><code> Performance counter stats for &#39;rustc /home/collector/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/src/libcore/lib.rs --edition=2018 --crate-type=lib --crate-name=core --emit=metadata -Zself-profile&#39; (12 runs):

    43,424,730,693      instructions:u                                                                                   ( +-  0.00% )

       7.576909112 seconds time elapsed                                          ( +-  0.12% )
</code></pre></div>



<a name="204571692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204571692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204571692">(Jul 21 2020 at 16:42)</a>:</h4>
<p>that's a nightly rustc of some time ago</p>



<a name="204580437"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204580437" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204580437">(Jul 21 2020 at 17:54)</a>:</h4>
<p>perhaps more useful:</p>
<div class="codehilite"><pre><span></span><code>collector@perf-collect:~$ for i in `seq 1 12`; do echo $i; perf stat -e instructions:u -B rustc $(rustc --print=sysroot)/lib/rustlib/src/rust/src/libcore/lib.rs --edition=2018 --crate-type=lib --crate-name=core --emit=metadata -Zself-profile; done
    43,427,141,687      instructions:u
       7.522372296 seconds time elapsed
    43,420,553,572      instructions:u
       7.571120513 seconds time elapsed
    43,422,220,738      instructions:u
       7.668403681 seconds time elapsed
    43,436,800,653      instructions:u
       7.549231552 seconds time elapsed
    43,422,366,692      instructions:u
       7.575593641 seconds time elapsed
    43,428,013,365      instructions:u
       7.457968917 seconds time elapsed
    43,432,935,579      instructions:u
       7.507432044 seconds time elapsed
    43,427,934,583      instructions:u
       7.548457473 seconds time elapsed
    43,422,266,505      instructions:u
       7.486037536 seconds time elapsed
    43,432,800,422      instructions:u
       7.565062622 seconds time elapsed
    43,424,821,136      instructions:u
       7.591561708 seconds time elapsed
    43,428,555,077      instructions:u
       7.607044089 seconds time elapsed
</code></pre></div>



<a name="204581725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204581725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204581725">(Jul 21 2020 at 18:05)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> This is really impressive!</p>



<a name="204581745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204581745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204581745">(Jul 21 2020 at 18:05)</a>:</h4>
<p>I look forward to this being one of the standard parts of performance comparison</p>



<a name="204581833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204581833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204581833">(Jul 21 2020 at 18:06)</a>:</h4>
<p>(We'll still need real-time for parallel cases, but this should help reduce noise otherwise.)</p>



<a name="204594250"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204594250" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204594250">(Jul 21 2020 at 19:44)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I want us to collect side by side instruction counts and the current timing measurements. it might even be possible to eventually account for parallelism but idk how <code>perf_event_open</code> interacts with threads, I haven't looked into it</p>



<a name="204595015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204595015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204595015">(Jul 21 2020 at 19:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> without even doing any analysis, looks like it swings about 16M, which is about the same as what I have here. thanks!</p>



<a name="204595054"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204595054" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204595054">(Jul 21 2020 at 19:51)</a>:</h4>
<p>so <code>core</code> has very little variance huh</p>



<a name="204595192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204595192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204595192">(Jul 21 2020 at 19:52)</a>:</h4>
<p>also, absolutely speaking, wow my runs have just over 2x more instructions, I wonder if that's all from debug assertions</p>



<a name="204595240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204595240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204595240">(Jul 21 2020 at 19:53)</a>:</h4>
<p>if you have debug asserts on std and rustc enabled I know that's a 50% wall time hit during a std build for me and I can believe it's a 2x instruction hit</p>



<a name="204595367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204595367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204595367">(Jul 21 2020 at 19:54)</a>:</h4>
<p>50% more time but made up of many smol instructions</p>



<a name="204595408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204595408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204595408">(Jul 21 2020 at 19:54)</a>:</h4>
<p>presumably a lot of checks that never trip an assert or do <code>debug!</code> logging :P</p>



<a name="204619425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204619425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Blandy <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204619425">(Jul 22 2020 at 00:40)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> ohai - thanks for the link</p>



<a name="204620581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Blandy <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620581">(Jul 22 2020 at 00:58)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Have you seen this paper?<br>
<a href="https://www.hpl.hp.com/techreports/2012/HPL-2012-68.pdf">https://www.hpl.hp.com/techreports/2012/HPL-2012-68.pdf</a><br>
Roughly, seqlocks don't get along well with modern language memory models, because the reads between the two sequence checks (deliberately) race with writes, but those races are UB in Rust and C++. The paper looks at a few ways to reconcile things.</p>



<a name="204620832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620832">(Jul 22 2020 at 01:02)</a>:</h4>
<p><del>@<strong>Jim Blandy</strong> it's really not a "lock" though</del></p>



<a name="204620846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620846">(Jul 22 2020 at 01:02)</a>:</h4>
<p>wait sorry I misread</p>



<a name="204620850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Blandy <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620850">(Jul 22 2020 at 01:02)</a>:</h4>
<p>upshot, I think the code from the <code>perf_event_open(2)</code> man page is UB</p>



<a name="204620857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620857">(Jul 22 2020 at 01:02)</a>:</h4>
<p>it would help if I read the entire message <em>sigh</em></p>



<a name="204620864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620864">(Jul 22 2020 at 01:03)</a>:</h4>
<p>okay yeah that confirms my suspicions</p>



<a name="204620883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620883">(Jul 22 2020 at 01:03)</a>:</h4>
<p>presumably one needs <em>at least</em> relaxed atomic reads?</p>



<a name="204620972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620972">(Jul 22 2020 at 01:04)</a>:</h4>
<p>I was gonna go full-on atomics then decided to just copy the C code</p>



<a name="204620978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Blandy <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620978">(Jul 22 2020 at 01:04)</a>:</h4>
<p>I don't remember the paper. Clearly, the reads of the data need to be properly ordered with respect to the sequence number reads. What does that entail?</p>



<a name="204620988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204620988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204620988">(Jul 22 2020 at 01:05)</a>:</h4>
<p>hmm "Figure 1.Seqlocks: Initial buggy version" in the paper doesn't have the barriers that the <code>perf_event_open</code> code does</p>



<a name="204621009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621009">(Jul 22 2020 at 01:05)</a>:</h4>
<p>the only UB I can think of is unsynchronized reads when the values can change via preemption</p>



<a name="204621055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621055">(Jul 22 2020 at 01:06)</a>:</h4>
<p>but I wasn't sure if it was UB at all. maybe it's UB in Rust but not C</p>



<a name="204621075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Blandy <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621075">(Jul 22 2020 at 01:07)</a>:</h4>
<p>I had forgotten about the <code>barrier</code> calls. That makes things a lot better.<br>
On the man page, it looks like the reads of <code>pc-&gt;lock</code> are not atomic, so those race.</p>



<a name="204621202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621202">(Jul 22 2020 at 01:09)</a>:</h4>
<p><span class="user-mention" data-user-id="279335">@Jim Blandy</span> the good news for my usecase is that I can make it sequential consistency and not really pay the cost. because the plan is to not even read any of that when sampling</p>



<a name="204621230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621230">(Jul 22 2020 at 01:10)</a>:</h4>
<p>AFAICT the kernel doesn't communicate anything through the mmap page that varies throughout execution other than maybe the counter being disabled or changing the hardware register it's using</p>



<a name="204621287"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621287" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621287">(Jul 22 2020 at 01:10)</a>:</h4>
<p>so  my plan is to check before and after for expected values and assume nothing changed in between</p>



<a name="204621317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621317">(Jul 22 2020 at 01:11)</a>:</h4>
<p>and so sampling would be <em>just</em> <code>rdpmc</code> with none of the loop around it</p>



<a name="204621338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Blandy <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621338">(Jul 22 2020 at 01:11)</a>:</h4>
<p>The enabled vs. running time is certainly something you can check at the end. I don't know how often the kernel moves PMC registers around, hopefully not often!</p>



<a name="204621341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621341">(Jul 22 2020 at 01:11)</a>:</h4>
<p>sadly probably a poor fit for a library (except by perhaps providing a lot of control over the details of sampling)</p>



<a name="204621395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621395">(Jul 22 2020 at 01:12)</a>:</h4>
<p>I haven't observed any value for <code>index</code> other than <code>1</code> (i.e. register 0)</p>



<a name="204621406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621406">(Jul 22 2020 at 01:12)</a>:</h4>
<p>I don't think it will move anything around if nothing else in the process isn't using them</p>



<a name="204621411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Blandy <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621411">(Jul 22 2020 at 01:12)</a>:</h4>
<p>It seems like you basically just want the kernel to allocate the PMC register for you, and then you're going to do all the reading of that register yourself.</p>



<a name="204621431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Blandy <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621431">(Jul 22 2020 at 01:13)</a>:</h4>
<p>If you run two programs that are measuring at the same time, do they get assigned separate indices?</p>



<a name="204621444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621444">(Jul 22 2020 at 01:13)</a>:</h4>
<p>I can check but I highly doubt it</p>



<a name="204621503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621503">(Jul 22 2020 at 01:14)</a>:</h4>
<p>also it's suggested that <code>offset</code> tracks some kernel bookkeeping or something but AFAICT that's just patently not true</p>



<a name="204621510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621510">(Jul 22 2020 at 01:14)</a>:</h4>
<p>I've only observed one value so far and it's like <code>(1 &lt;&lt; 47) - 1</code></p>



<a name="204621522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621522">(Jul 22 2020 at 01:14)</a>:</h4>
<p>which is a typical bias representation (<code>pmc_width</code> is <code>48</code>)</p>



<a name="204621534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621534">(Jul 22 2020 at 01:14)</a>:</h4>
<p>maybe <code>offset</code> is used that way when it's a software counter, not a hardware one?</p>



<a name="204621629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Blandy <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621629">(Jul 22 2020 at 01:16)</a>:</h4>
<p>Yeah, I guess it wouldn't make sense for the indices to be something visible between processes, that'd be an avoidable information leak at the least.</p>



<a name="204621656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621656">(Jul 22 2020 at 01:17)</a>:</h4>
<p>yeah I just checked, <code>index</code> is always <code>1</code></p>



<a name="204621662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621662">(Jul 22 2020 at 01:17)</a>:</h4>
<p>let me see if I run it under <code>perf stat</code></p>



<a name="204621759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621759">(Jul 22 2020 at 01:18)</a>:</h4>
<p><code>index</code> becomes <code>0</code> with no <code>-e</code> because presumably <code>perf stat</code> uses all it can (I guess I need to treat <code>index == 0</code> as "not supported" on startup)</p>



<a name="204621778"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204621778" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204621778">(Jul 22 2020 at 01:19)</a>:</h4>
<p><span class="user-mention" data-user-id="279335">@Jim Blandy</span> okay yeah with <code>perf stat -e instructions:u</code> I get <code>index</code> being <code>2</code></p>



<a name="204632371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204632371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204632371">(Jul 22 2020 at 05:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/204594250">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> I want us to collect side by side instruction counts and the current timing measurements. it might even be possible to eventually account for parallelism but idk how <code>perf_event_open</code> interacts with threads, I haven't looked into it</p>
</blockquote>
<p>Perf measures everything run under it (and gives enough information that you can account threads separately), but with threads, it's possible for instruction counts to be higher and real-time to be lower. Also, in addition to instruction counts, you should collect cache misses, and one or two other things, which can help explain why instruction counts might be <em>lower</em> and time <em>higher</em>.</p>



<a name="204638516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204638516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204638516">(Jul 22 2020 at 07:52)</a>:</h4>
<p>so one problem with real-time is that it includes things happening elsewhere in the OS, either waiting for the kernel or just other programs running. but I guess you could use the CPU timestamp thing on x86? or maybe you can just get "user time" but idk how much that can vary (I should check what <code>measureme</code> does right now)</p>



<a name="204638576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204638576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204638576">(Jul 22 2020 at 07:53)</a>:</h4>
<p>but also heh I remember when I suggested using cache misses as an approximation of the "DRAM bandwidth" needed (I forgot how I phrased it back then, but I still agree with it)</p>



<a name="204638657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204638657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204638657">(Jul 22 2020 at 07:54)</a>:</h4>
<p>anyway all of the things I'm interested in at the moment are pretty accurately reflected in <code>instructions:u</code>, so that's why I'm focusing on that, but long-term we do probably want to be measuring several things</p>



<a name="204638691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204638691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204638691">(Jul 22 2020 at 07:55)</a>:</h4>
<p>sorry, a bit scatter-brained there, just woke up</p>



<a name="204647358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204647358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204647358">(Jul 22 2020 at 09:50)</a>:</h4>
<p>I'm still interested in adding cache misses but it hasn't been high priority enough. It should now be really simple though, only a couple places to edit</p>



<a name="204649067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204649067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204649067">(Jul 22 2020 at 10:13)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> word of warning, <code>perf stat</code> seems to run out of hardware counters on Zen 1, so we need to do some testing first :P</p>



<a name="204649130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204649130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204649130">(Jul 22 2020 at 10:14)</a>:</h4>
<p>We're on 3600x which is... Zen 2 I think? Not sure if that's enough</p>



<a name="204649165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204649165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204649165">(Jul 22 2020 at 10:15)</a>:</h4>
<p>ah interesting, I wonder if that actually helps</p>



<a name="204649187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204649187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204649187">(Jul 22 2020 at 10:15)</a>:</h4>
<p>or maybe you're using a filter</p>



<a name="204649206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204649206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204649206">(Jul 22 2020 at 10:15)</a>:</h4>
<p>(I think two of the values I get are 0 because <code>perf stat</code> runs out of counters? not sure)</p>



<a name="204710808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204710808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204710808">(Jul 22 2020 at 19:22)</a>:</h4>
<p>doesn't perf multiplex counters if there are too many requested for the hardware?</p>



<a name="204710814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204710814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204710814">(Jul 22 2020 at 19:22)</a>:</h4>
<p>maybe that's only for sampling</p>



<a name="204778785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204778785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204778785">(Jul 23 2020 at 09:59)</a>:</h4>
<p>btw this is the setup for measuring <code>instructions:u</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="k">impl</span><span class="w"> </span><span class="n">Counter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">instructions</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">new</span><span class="p">(</span><span class="n">perf_hw_id_PERF_COUNT_HW_INSTRUCTIONS</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">hw_id</span>: <span class="nc">perf_hw_id</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="o">..</span><span class="p">.}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="204778922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204778922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204778922">(Jul 23 2020 at 10:00)</a>:</h4>
<p>so it would be really easy to add other counters, code-wise (modulo routing them in <code>measureme</code> to be stored on disk) - there would ofc be doubled overhead</p>



<a name="204783118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204783118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204783118">(Jul 23 2020 at 11:01)</a>:</h4>
<p><a href="/user_uploads/4715/-pe7qVlFhHEdokjwG7WABwd-/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/-pe7qVlFhHEdokjwG7WABwd-/image.png" title="image.png"><img src="/user_uploads/4715/-pe7qVlFhHEdokjwG7WABwd-/image.png"></a></div>



<a name="204783132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204783132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204783132">(Jul 23 2020 at 11:01)</a>:</h4>
<p>help my names are increasingly longer</p>



<a name="204783742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204783742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204783742">(Jul 23 2020 at 11:10)</a>:</h4>
<p>but I think I've found the final variation (orange), which <em>should</em> (in theory) be capable of running under <code>perf stat -e instructions:u</code>without reading the wrong counter</p>



<a name="204783761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204783761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204783761">(Jul 23 2020 at 11:10)</a>:</h4>
<p>it doesn't cost more to use the correct hardware register index, so at least that's nice</p>



<a name="204784222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204784222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204784222">(Jul 23 2020 at 11:18)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> good news, a quick look suggests running under <code>perf stat -e instructions:u</code> doesn't impact the measurements (which I guess makes sense since <code>perf</code> isn't running any code inside the userspace of the process)</p>



<a name="204784244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204784244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204784244">(Jul 23 2020 at 11:18)</a>:</h4>
<p>and running under <code>perf stat</code> (which runs out of hardware registers) is now detected (<code>index == 0</code>) properly instead of panicking</p>



<a name="204784375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204784375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204784375">(Jul 23 2020 at 11:21)</a>:</h4>
<p>Detected properly - what can we do?</p>
<p>(Out of interest, can we piggy back on perf stat's allocated register?)</p>
<p>One thing to note is that there's no reason we can't run perf stat and self profile in separate runs. IIRC, we already basically do this on perf.rlo and that way we're less likely to interfere with each other.</p>



<a name="204784438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204784438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204784438">(Jul 23 2020 at 11:22)</a>:</h4>
<p>I don't think there's a way to see what other <code>perf_event_open</code> calls did. not to mention that <code>perf</code> has it in another process so it's probably not even visible as a file description in the <code>rustc</code> process</p>



<a name="204784446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204784446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204784446">(Jul 23 2020 at 11:22)</a>:</h4>
<p>maybe there's some <code>ptrace</code> support but it seems extreme</p>



<a name="204784474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204784474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204784474">(Jul 23 2020 at 11:23)</a>:</h4>
<p>and yeah separate runs makes sense - that or maybe the perf hardware can handle it. or we can use filters to pick what to measure etc. etc.</p>



<a name="204784585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204784585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204784585">(Jul 23 2020 at 11:25)</a>:</h4>
<p>I should organize the data, to make it easy to share later, but other than that I think I need to move to integrating with <code>measureme</code>, there's nothing else I can do in <code>rustc_data_structures</code> with what APIs I have available</p>



<a name="204784602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/204784602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#204784602">(Jul 23 2020 at 11:25)</a>:</h4>
<p>(short of encoding the data as strings, which, lol)</p>



<a name="205485223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205485223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205485223">(Jul 30 2020 at 14:28)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> hmm looking at <code>measureme</code>, <code>nanos_since_start</code> isn't <code>#[inline]</code>, but everything calling it is, that seems bad</p>



<a name="205485255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205485255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205485255">(Jul 30 2020 at 14:29)</a>:</h4>
<p>ah nvm it's in an <code>impl&lt;S: SerializationSink&gt; Profiler&lt;S&gt;</code> so it doesn't need the <code>#[inline]</code></p>



<a name="205616928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205616928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205616928">(Jul 31 2020 at 17:18)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> so it looks like the overheads are roughly this: (for libcore, out of ~93 billion instructions):</p>
<ul>
<li><code>0.64%</code> for measuring time (current measureme implementation, <code>std::time::Instant::elapsed</code>)</li>
<li><code>0.03%</code> for measuring instructions w/ <code>rdpmc</code> (from <code>measureme</code>)</li>
<li><code>0.12%</code> for measuring instructions w/ <code>rdpmc</code> (from <code>rustc_data_structures</code>, not sure why it was slower, I hope it was just worse optimized?)</li>
</ul>



<a name="205616967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205616967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205616967">(Jul 31 2020 at 17:19)</a>:</h4>
<p>overall, measuring instructions is 5x-20x faster than measuring time</p>



<a name="205616982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205616982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205616982">(Jul 31 2020 at 17:19)</a>:</h4>
<p>again, assuming I didn't make any mistakes doing all of this</p>



<a name="205617007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205617007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205617007">(Jul 31 2020 at 17:20)</a>:</h4>
<p>I need to figure out a better data gathering setup, and maybe go down from 100 samples, that takes like 40min lol</p>



<a name="205617328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205617328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205617328">(Jul 31 2020 at 17:23)</a>:</h4>
<p>Sounds great! I wonder if we could use some low level CPU counter for time measurements - 1% overhead is pretty big.</p>



<a name="205623182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205623182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205623182">(Jul 31 2020 at 18:13)</a>:</h4>
<p>I think <code>rdtsc</code> is the equivalent to <code>rdpmc</code> and the perf mmap page works similarly. I wonder if <code>rdtsc</code> is available on non-linux</p>



<a name="205623637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205623637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205623637">(Jul 31 2020 at 18:18)</a>:</h4>
<p><del>ugh my data has issues, I'm playing around with various combinations of setups and seeing weird things</del></p>



<a name="205623970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205623970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205623970">(Jul 31 2020 at 18:21)</a>:</h4>
<p><del>@<strong>simulacrum</strong> oh the 0.64% is probably overestimated because I forgot to use <code>black_box</code> in a critical place so it's probably optimizing out a bunch of <code>measureme</code> lol</del></p>



<a name="205625045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205625045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205625045">(Jul 31 2020 at 18:32)</a>:</h4>
<p>adding a <code>black_box</code> (around the <code>0</code>, with no sampling of any kind) made it... faster??</p>



<a name="205625073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205625073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205625073">(Jul 31 2020 at 18:32)</a>:</h4>
<p>starting to suspect my methodology here</p>



<a name="205628589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205628589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205628589">(Jul 31 2020 at 18:58)</a>:</h4>
<p>but if I'm sampling instructions, <code>black_box(0)</code> for the timestamp is as fast as <code>0</code></p>



<a name="205628760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205628760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205628760">(Jul 31 2020 at 19:00)</a>:</h4>
<p><del>but best guess now is that the overhead of getting the time is like <code>0.30%</code> and I don't know yet what accounts for the other half</del></p>



<a name="205629441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205629441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205629441">(Jul 31 2020 at 19:07)</a>:</h4>
<p>ahhh I think the <code>0.64%</code> figure is probably right, I was just missing an <code>#[inline]</code>, but it's generic so idk why it makes a difference</p>



<a name="205630019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205630019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205630019">(Jul 31 2020 at 19:13)</a>:</h4>
<p>like I now have all 4 combinations of <code>(is_sampling_time, is_sampling_instructions)</code> looking like what I expected, I just had to add <code>#[inline]</code> to get that, now I have to redo all 4 with <code>#[inline]</code> to make sure they're not off the mark again</p>



<a name="205630131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205630131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205630131">(Jul 31 2020 at 19:14)</a>:</h4>
<p><a href="/user_uploads/4715/4K45ny8qW1vm5uJZXtDo1gnp/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/4K45ny8qW1vm5uJZXtDo1gnp/image.png" title="image.png"><img src="/user_uploads/4715/4K45ny8qW1vm5uJZXtDo1gnp/image.png"></a></div>



<a name="205630205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205630205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205630205">(Jul 31 2020 at 19:15)</a>:</h4>
<p>so I still haven't confirmed this data with <code>#[inline]</code> in all 4 cases, but the gap between the two pairs is arguably the cost of sampling time, whereas the gap in each pair is the cost of sampling instructions</p>



<a name="205635153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205635153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205635153">(Jul 31 2020 at 19:56)</a>:</h4>
<p><a href="/user_uploads/4715/CLVIBol90o8KYZCgQLH-35s6/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/CLVIBol90o8KYZCgQLH-35s6/image.png" title="image.png"><img src="/user_uploads/4715/CLVIBol90o8KYZCgQLH-35s6/image.png"></a></div>



<a name="205635181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205635181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205635181">(Jul 31 2020 at 19:57)</a>:</h4>
<p>I think this is my final dataset</p>



<a name="205635379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205635379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205635379">(Jul 31 2020 at 19:59)</a>:</h4>
<p>and only 10 data points because collecting 100 for each run was a mistake (the ~40min they take is way longer than the rustc rebuild takes lol)</p>



<a name="205637427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205637427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205637427">(Jul 31 2020 at 20:20)</a>:</h4>
<p>That's really awesome work <span class="user-mention" data-user-id="119009">@eddyb</span>!! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="205637448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205637448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205637448">(Jul 31 2020 at 20:21)</a>:</h4>
<p>I'm still not saving the instructions counts to disk :P</p>



<a name="205637539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205637539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205637539">(Jul 31 2020 at 20:22)</a>:</h4>
<p>Who needs that? :P</p>



<a name="205638763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205638763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205638763">(Jul 31 2020 at 20:35)</a>:</h4>
<p><a href="/user_uploads/4715/3T4mesqw5nnR4XQPEcfzPSpc/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/3T4mesqw5nnR4XQPEcfzPSpc/image.png" title="image.png"><img src="/user_uploads/4715/3T4mesqw5nnR4XQPEcfzPSpc/image.png"></a></div>



<a name="205638804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205638804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205638804">(Jul 31 2020 at 20:35)</a>:</h4>
<p>this is the violin plot version. I should also redo the overhead calculation now</p>



<a name="205639242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205639242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205639242">(Jul 31 2020 at 20:40)</a>:</h4>
<p>instructions are so low-overhead compared to time that I just want them now :)</p>



<a name="205640395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205640395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205640395">(Jul 31 2020 at 20:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> I tried to put the new data into a table (and I also made the plotly charts available) <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50#gistcomment-3399834">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50#gistcomment-3399834</a></p>



<a name="205640474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205640474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205640474">(Jul 31 2020 at 20:53)</a>:</h4>
<p><code>rdpmc</code> overhead seems to be between <code>0.04%</code> (when on top of time) and <code>0.06%</code>. maybe I should use interval arithmetic but ehhh</p>



<a name="205640560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205640560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205640560">(Jul 31 2020 at 20:54)</a>:</h4>
<p>sampling time being 10x slower than sampling the instruction counter is good enough for me I think</p>



<a name="205644039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644039">(Jul 31 2020 at 21:35)</a>:</h4>
<p>come on... <a href="/user_uploads/4715/_Mi0e0gtpwfBIdAXHEF2LHWy/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/_Mi0e0gtpwfBIdAXHEF2LHWy/image.png" title="image.png"><img src="/user_uploads/4715/_Mi0e0gtpwfBIdAXHEF2LHWy/image.png"></a></div>



<a name="205644074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644074">(Jul 31 2020 at 21:35)</a>:</h4>
<p>it's cheaper to use the sampled instruction counts than <code>black_box(0)</code></p>



<a name="205644181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644181">(Jul 31 2020 at 21:36)</a>:</h4>
<p>er, that seems odd? doesn't black box literally compile to nothing? maybe it's inhibiting optimizations I guess</p>



<a name="205644376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644376">(Jul 31 2020 at 21:39)</a>:</h4>
<p>do I replace the old "Sampling instructions:u" with the new measurement, and redo the screenshots and everything? it is technically more realistic :/</p>



<a name="205644395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644395">(Jul 31 2020 at 21:39)</a>:</h4>
<p>for now, enjoy this:</p>
<h3>Normal run</h3>
<table>
<thead>
<tr>
<th>Item</th>
<th>Self time</th>
<th>% of total time</th>
<th>Time</th>
<th>Item count</th>
</tr>
</thead>
<tbody>
<tr>
<td>typeck</td>
<td>7.58s</td>
<td>30.921</td>
<td>7.88s</td>
<td>11911</td>
</tr>
<tr>
<td>mir_borrowck</td>
<td>2.86s</td>
<td>11.665</td>
<td>5.60s</td>
<td>11911</td>
</tr>
<tr>
<td>expand_crate</td>
<td>2.22s</td>
<td>9.056</td>
<td>2.24s</td>
<td>1</td>
</tr>
<tr>
<td>resolve_crate</td>
<td>1.51s</td>
<td>6.178</td>
<td>1.51s</td>
<td>1</td>
</tr>
<tr>
<td>mir_built</td>
<td>1.32s</td>
<td>5.397</td>
<td>1.53s</td>
<td>11911</td>
</tr>
</tbody>
</table>
<h3>Each 1s is 1 billion instructions</h3>
<table>
<thead>
<tr>
<th>Item</th>
<th>Self time</th>
<th>% of total time</th>
<th>Time</th>
<th>Item count</th>
</tr>
</thead>
<tbody>
<tr>
<td>typeck</td>
<td>27.30s</td>
<td>29.426</td>
<td>27.94s</td>
<td>11911</td>
</tr>
<tr>
<td>mir_borrowck</td>
<td>11.50s</td>
<td>12.393</td>
<td>20.75s</td>
<td>11911</td>
</tr>
<tr>
<td>expand_crate</td>
<td>8.97s</td>
<td>9.670</td>
<td>9.08s</td>
<td>1</td>
</tr>
<tr>
<td>resolve_crate</td>
<td>8.84s</td>
<td>9.530</td>
<td>8.84s</td>
<td>1</td>
</tr>
<tr>
<td>mir_built</td>
<td>5.32s</td>
<td>5.736</td>
<td>5.69s</td>
<td>11911</td>
</tr>
</tbody>
</table>



<a name="205644483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644483">(Jul 31 2020 at 21:40)</a>:</h4>
<p>this is not averaged or anything, it's just <code>summarize summarize ... | head -n 13</code> from a couple random runs (I haven't deleted all the files that keep piling up, yet, since a few sets of runs ago)</p>



<a name="205644528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644528">(Jul 31 2020 at 21:41)</a>:</h4>
<p>is % of total time a percent of total instructions ?</p>



<a name="205644541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644541">(Jul 31 2020 at 21:41)</a>:</h4>
<p>I would expect so, yes</p>



<a name="205644612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644612">(Jul 31 2020 at 21:42)</a>:</h4>
<p>Or -- I guess -- instructions spent in queries?</p>



<a name="205644616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644616">(Jul 31 2020 at 21:42)</a>:</h4>
<p>Since we can't actually do global and local, right?</p>



<a name="205644639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644639">(Jul 31 2020 at 21:42)</a>:</h4>
<p>we should test the collection server's hardware for support for this btw</p>



<a name="205644734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644734">(Jul 31 2020 at 21:43)</a>:</h4>
<p>not sure you mean by "global and local". this is the exact same thing <code>perf -e instructions:u</code> measures</p>



<a name="205644853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644853">(Jul 31 2020 at 21:44)</a>:</h4>
<p>except it starts when the <code>Profiler</code> is created and ends when it's dropped, instead of lasting the whole process</p>



<a name="205644906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644906">(Jul 31 2020 at 21:45)</a>:</h4>
<p>right, that's what I meant, I think</p>



<a name="205644919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644919">(Jul 31 2020 at 21:45)</a>:</h4>
<p>I guess a bit wider than I thought</p>



<a name="205644926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205644926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205644926">(Jul 31 2020 at 21:45)</a>:</h4>
<p>but close enough anyway</p>



<a name="205645134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205645134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205645134">(Jul 31 2020 at 21:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> btw I looked at two more runs (one of each kind) and the % column looks like it has 2-3 orders of magnitude less variance for instructions than for time</p>



<a name="205645192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205645192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205645192">(Jul 31 2020 at 21:48)</a>:</h4>
<p>yeah that's what I'd expect I think</p>



<a name="205645706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205645706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205645706">(Jul 31 2020 at 21:54)</a>:</h4>
<p>I just checked and blue -&gt; cyan overhead in my last screenshot is very close to the difference between the other pair that includes sampling time</p>



<a name="205645729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205645729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205645729">(Jul 31 2020 at 21:54)</a>:</h4>
<p>so I'm going to have to replace red with cyan I think. it's more representative of the final product anyway</p>



<a name="205677474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205677474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205677474">(Aug 01 2020 at 11:30)</a>:</h4>
<p>new plots are: <a href="https://user-images.githubusercontent.com/77424/89100856-59837800-d403-11ea-8757-f38e0f467107.png">https://user-images.githubusercontent.com/77424/89100856-59837800-d403-11ea-8757-f38e0f467107.png</a> <a href="https://user-images.githubusercontent.com/77424/89100862-66a06700-d403-11ea-982d-a439d53725ca.png">https://user-images.githubusercontent.com/77424/89100862-66a06700-d403-11ea-982d-a439d53725ca.png</a></p>
<div class="message_inline_image"><a href="https://user-images.githubusercontent.com/77424/89100856-59837800-d403-11ea-8757-f38e0f467107.png"><img src="https://user-images.githubusercontent.com/77424/89100856-59837800-d403-11ea-8757-f38e0f467107.png"></a></div><div class="message_inline_image"><a href="https://user-images.githubusercontent.com/77424/89100862-66a06700-d403-11ea-982d-a439d53725ca.png"><img src="https://user-images.githubusercontent.com/77424/89100862-66a06700-d403-11ea-982d-a439d53725ca.png"></a></div>



<a name="205677481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205677481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205677481">(Aug 01 2020 at 11:31)</a>:</h4>
<p>after updating <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50#gistcomment-3399834">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50#gistcomment-3399834</a></p>



<a name="205677495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205677495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205677495">(Aug 01 2020 at 11:31)</a>:</h4>
<p>overhead of measuring instructions is around 0.04%, now much closer between measuring and not measuring time, which is another reason I'm more confident in this configuration</p>



<a name="205677537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205677537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205677537">(Aug 01 2020 at 11:32)</a>:</h4>
<p>so 15x faster than measuring time. and I really want to stop messing with it more</p>



<a name="205678681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205678681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205678681">(Aug 01 2020 at 12:09)</a>:</h4>
<p>sadly dynamic choice between instructions and time brings it right in the middle even if "instructions" is always picked dynamically, so we'd need to be more clever than that</p>



<a name="205678736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205678736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205678736">(Aug 01 2020 at 12:10)</a>:</h4>
<p>(as in, "return time if the instruction counter wasn't enabled")</p>



<a name="205683021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205683021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205683021">(Aug 01 2020 at 14:07)</a>:</h4>
<p><code>summarize summarize --json</code> seems useful, curious if it will give me data that's full-precision</p>



<a name="205683084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205683084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205683084">(Aug 01 2020 at 14:08)</a>:</h4>
<p>ahhh yeah beautiful :D</p>



<a name="205683112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205683112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205683112">(Aug 01 2020 at 14:09)</a>:</h4>
<p>and any numbers I need I can just feed to <code> | (.secs*1e9+.nanos)</code></p>



<a name="205825780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205825780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205825780">(Aug 03 2020 at 17:56)</a>:</h4>
<p><a href="/user_uploads/4715/9YluEZrEgzuhR3-uDLsbeoCD/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/9YluEZrEgzuhR3-uDLsbeoCD/image.png" title="image.png"><img src="/user_uploads/4715/9YluEZrEgzuhR3-uDLsbeoCD/image.png"></a></div>



<a name="205826011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205826011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205826011">(Aug 03 2020 at 17:58)</a>:</h4>
<p>so this the difference in the variance of time vs instructions:u data, as seen by the total counted by <code>summarize summarize --json</code></p>



<a name="205826035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205826035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205826035">(Aug 03 2020 at 17:58)</a>:</h4>
<p>it's like 600x smaller for instructions:u</p>



<a name="205826150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205826150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205826150">(Aug 03 2020 at 17:59)</a>:</h4>
<p>so sampling time takes 15x more time and varies 600x more, at least in this configuration</p>



<a name="205835022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205835022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205835022">(Aug 03 2020 at 19:11)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> looking at individual queries (with a lot of executions, around 10k), the variance for self time/instructions seems to be somewhat constant for time, but differ more (between queries) for instructions</p>



<a name="205835077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205835077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205835077">(Aug 03 2020 at 19:12)</a>:</h4>
<p>seems like it reflects the workload. still, the largest one I found so far was still 100x smaller than the time variance, I wonder if I can automate this though</p>



<a name="205839960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205839960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205839960">(Aug 03 2020 at 19:54)</a>:</h4>
<p>huh, <code>resolve_crate</code>, which is a whole 6% of the compilation, possibly because it has only one execution, ends up with ±324 <em>instructions</em> (around an average of ~8.8 billion) whereas as time it's 1.56s ±0.28s</p>



<a name="205840032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205840032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205840032">(Aug 03 2020 at 19:55)</a>:</h4>
<p>that's getting to the point where you could hunt down sources of variance</p>



<a name="205840168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205840168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205840168">(Aug 03 2020 at 19:56)</a>:</h4>
<p>but I never expected to see that kind of thing and it's almost pointless to dig into it (given that there are smaller things with more variance)</p>



<a name="205840181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205840181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205840181">(Aug 03 2020 at 19:57)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="120989">@njn</span> who will probably be very happy to see the self-profile get much more precise</p>



<a name="205840407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205840407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205840407">(Aug 03 2020 at 19:59)</a>:</h4>
<p>I wonder what the simplest opt-in thing is that we could land. something where it does the (sadly less efficient) dynamic choice between hardware counters and time, and there's one-time cost of setting that up and noting down in the file what kind of measurements are used</p>



<a name="205840426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205840426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205840426">(Aug 03 2020 at 19:59)</a>:</h4>
<p>at this point measuring both seems silly, unless we also add <code>rdtsc</code> support</p>



<a name="205840653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205840653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205840653">(Aug 03 2020 at 20:01)</a>:</h4>
<p>IMO it seems like instructions, if available, are almost always a definite win for compiler devs trying to use this</p>



<a name="205840690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205840690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205840690">(Aug 03 2020 at 20:01)</a>:</h4>
<p>I'd be in favor of only supporting one or the other just to start</p>



<a name="205841260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841260">(Aug 03 2020 at 20:06)</a>:</h4>
<p>one problem is backwards-compat, and the fact that measuring instructions requires nightly (locally I integrated it with a <code>feature = "nightly"</code>). so we might want to release a <code>measureme</code> breaking change if we want to force a certain default</p>



<a name="205841346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841346">(Aug 03 2020 at 20:07)</a>:</h4>
<p>hm I wouldn't worry about measureme being usable on stable personally</p>



<a name="205841356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841356">(Aug 03 2020 at 20:07)</a>:</h4>
<p>(we can release a major version though)</p>



<a name="205841363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841363">(Aug 03 2020 at 20:07)</a>:</h4>
<p>not sure if Cargo features are the best way to control odd toggles like "force this to only use instruction-counting on supported platforms, so that there is no dynamic cost"</p>



<a name="205841409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841409">(Aug 03 2020 at 20:08)</a>:</h4>
<p>There might be another breaking change coming soon anyway</p>



<a name="205841414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841414">(Aug 03 2020 at 20:08)</a>:</h4>
<p>aaah okay that's better</p>



<a name="205841444"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841444" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841444">(Aug 03 2020 at 20:08)</a>:</h4>
<p>(I'll be sure to coordinate the breakage &amp; rustc update with <span class="user-mention" data-user-id="116122">@simulacrum</span> )</p>



<a name="205841500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841500">(Aug 03 2020 at 20:09)</a>:</h4>
<p>so there's sort of 3 possible states:</p>
<ul>
<li>platform doesn't support instruction-counting (or not on nightly, so <code>asm!</code> is not available)</li>
<li>we tried initializing the counter but it didn't work (e.g. <code>perf stat</code> is using up all the counters, or the hardware register isn't 48 bits wide, which I'm currently hardcoding)</li>
<li>we're counting instructions</li>
</ul>



<a name="205841586"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841586" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841586">(Aug 03 2020 at 20:10)</a>:</h4>
<p>and most of the code just sees <code>None</code>, <code>None</code>, and <code>Some(hw_counters)</code> currently</p>



<a name="205841630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841630">(Aug 03 2020 at 20:10)</a>:</h4>
<p>so we should figure out how to handle each of those that's best for everyone</p>



<a name="205841803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205841803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205841803">(Aug 03 2020 at 20:12)</a>:</h4>
<p><code>-Zself-profile</code> not working outside of x64 Linux is a non-starter, but even on x64 Linux maybe some hardware doesn't support the counters?</p>



<a name="205842043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842043">(Aug 03 2020 at 20:14)</a>:</h4>
<p>btw if we don't want to do a time fallback, it might even be slightly cheaper to measure instructions than on might graphs since we're not checking for <code>Some</code> vs <code>None</code>. but that's getting into the weeds</p>



<a name="205842116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842116">(Aug 03 2020 at 20:15)</a>:</h4>
<p>I would think we'd want to fallback to the current implementation if we can't use rdpmc</p>



<a name="205842249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842249">(Aug 03 2020 at 20:16)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so that kind of dynamic feedback results in something around 93B on this graph, right halfway in the middle <a href="https://user-images.githubusercontent.com/77424/89100856-59837800-d403-11ea-8757-f38e0f467107.png">https://user-images.githubusercontent.com/77424/89100856-59837800-d403-11ea-8757-f38e0f467107.png</a></p>
<div class="message_inline_image"><a href="https://user-images.githubusercontent.com/77424/89100856-59837800-d403-11ea-8757-f38e0f467107.png"><img src="https://user-images.githubusercontent.com/77424/89100856-59837800-d403-11ea-8757-f38e0f467107.png"></a></div>



<a name="205842263"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842263" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842263">(Aug 03 2020 at 20:16)</a>:</h4>
<p>that's the only cost</p>



<a name="205842293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842293">(Aug 03 2020 at 20:17)</a>:</h4>
<p>it's a bit weird that the effect on optimizations is half the overhead of measuring time</p>



<a name="205842459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842459">(Aug 03 2020 at 20:18)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> is that branching on each query or so? Would it be faster to stash a function pointer or so?</p>



<a name="205842461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842461">(Aug 03 2020 at 20:18)</a>:</h4>
<p>the data itself would still be low-variance AFAICT, there would just be an extra constant number of instructions for every time we're sampling</p>



<a name="205842575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842575">(Aug 03 2020 at 20:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> this is all inlined and even adding <code>#[inline]</code> on one generic function helped, so I don't see how we could use function pointers</p>



<a name="205842592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842592">(Aug 03 2020 at 20:19)</a>:</h4>
<p>ah :/</p>



<a name="205842674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842674">(Aug 03 2020 at 20:20)</a>:</h4>
<p>well, I guess the absolute cost isn't <em>too</em> important</p>



<a name="205842685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842685">(Aug 03 2020 at 20:20)</a>:</h4>
<p>it's really low compared to rustc anyway</p>



<a name="205842760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842760">(Aug 03 2020 at 20:21)</a>:</h4>
<p>maybe we can explicitly "outline" the time collection (i.e., inline(never) it)</p>



<a name="205842764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205842764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205842764">(Aug 03 2020 at 20:21)</a>:</h4>
<p>anyway it's not that bad I don't think. maybe I should count how many times we read it so I can count the overhead in instructions</p>



<a name="205856504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205856504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205856504">(Aug 03 2020 at 22:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> okay I ended up doing some ugly range math to get this, but "19, 367, 388" are actually agreed upon by averages as well, so I'm pretty confident about them <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50#gistcomment-3399834">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50#gistcomment-3399834</a></p>



<a name="205856531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205856531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205856531">(Aug 03 2020 at 22:53)</a>:</h4>
<p>looks like sampling instructions takes about 20 instructions</p>



<a name="205856641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/205856641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#205856641">(Aug 03 2020 at 22:54)</a>:</h4>
<p>seems a bit much but I really need to stop looking at the overhead metrics. the per-query variance of time vs instructions data is far more interesting</p>



<a name="206803453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206803453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206803453">(Aug 13 2020 at 11:23)</a>:</h4>
<p>(deleted)</p>



<a name="206803534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206803534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206803534">(Aug 13 2020 at 11:24)</a>:</h4>
<p>(deleted)</p>



<a name="206803937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206803937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206803937">(Aug 13 2020 at 11:31)</a>:</h4>
<p>(deleted)</p>



<a name="206805233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206805233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206805233">(Aug 13 2020 at 11:49)</a>:</h4>
<p>oops</p>



<a name="206805238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206805238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206805238">(Aug 13 2020 at 11:49)</a>:</h4>
<p>I wasn't where I thought I was lol</p>



<a name="206815456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206815456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206815456">(Aug 13 2020 at 13:39)</a>:</h4>
<p>though I'd check what the numbers are like without debug assertions/logging</p>



<a name="206815487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206815487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206815487">(Aug 13 2020 at 13:39)</a>:</h4>
<p>93 billion -&gt; 43 billion. whoops</p>



<a name="206816220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816220">(Aug 13 2020 at 13:45)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so I think I have a plan for measuring arbitrary things instead of just times. not sure what to call it other than "samples" or maybe "stamps" (as in, "timestamps" without the "time"), but I think we can store some metadata about what is being sampled (we have an arbitrary JSON object to work with, right?)</p>



<a name="206816305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816305">(Aug 13 2020 at 13:46)</a>:</h4>
<p>I think so, yeah, there's a metadata "header"</p>



<a name="206816332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816332">(Aug 13 2020 at 13:46)</a>:</h4>
<p>I struggled with naming this in perf.r-l.o too</p>



<a name="206816355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816355">(Aug 13 2020 at 13:46)</a>:</h4>
<p>I ended up with "statistic" but I'm not a fan</p>



<a name="206816381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816381">(Aug 13 2020 at 13:46)</a>:</h4>
<p>Do you mean with the raw on-disk format? Or what we expose to per.rlo?</p>



<a name="206816384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816384">(Aug 13 2020 at 13:46)</a>:</h4>
<p>(there it's "process statistics" or "pstats")</p>



<a name="206816595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816595">(Aug 13 2020 at 13:48)</a>:</h4>
<p>so I'm imagining something like this:</p>
<div class="codehilite"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="n">sampler</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">Sampler</span>::<span class="n">Time</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[(</span><span class="s">&quot;s&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e9</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e6</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;us&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1e3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;ns&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="n">Sampler</span>::<span class="n">Instructions</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[(</span><span class="s">&quot;instructions:u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)],</span><span class="w"></span>
<span class="w">    </span><span class="n">Sampler</span>::<span class="n">Cycles</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[(</span><span class="s">&quot;cycles:u&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)],</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="206816617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816617">(Aug 13 2020 at 13:48)</a>:</h4>
<p>the raw event data</p>



<a name="206816686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816686">(Aug 13 2020 at 13:49)</a>:</h4>
<p>this seems reasonable</p>



<a name="206816704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816704">(Aug 13 2020 at 13:49)</a>:</h4>
<p>not sure exactly where that's intended to be put, though</p>



<a name="206816710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816710">(Aug 13 2020 at 13:49)</a>:</h4>
<p>We just assume it's "time" currently but it would be easy enough to encode that in the metadata.</p>



<a name="206816720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816720">(Aug 13 2020 at 13:50)</a>:</h4>
<p>we could theoretically have more than one kind of measurement per profiler but I think we can start without that feature and just think about it for the future</p>



<a name="206816791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816791">(Aug 13 2020 at 13:50)</a>:</h4>
<p>I mostly just want to ship some version :)</p>



<a name="206816828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816828">(Aug 13 2020 at 13:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I would have that in the code and then it's just shoved into the JSON and nothing reading the format has to care what those mean</p>



<a name="206816843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816843">(Aug 13 2020 at 13:50)</a>:</h4>
<p>seems good</p>



<a name="206816851"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816851" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816851">(Aug 13 2020 at 13:50)</a>:</h4>
<p>In the demographic data community the preferred term is "indicator"</p>



<a name="206816901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816901">(Aug 13 2020 at 13:51)</a>:</h4>
<p><span class="user-mention" data-user-id="120179">@Eh2406</span> the problem is that this is a value that increases monotonically over time</p>



<a name="206816910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816910">(Aug 13 2020 at 13:51)</a>:</h4>
<p>and you can reason about quantities, ranges, etc.</p>



<a name="206816953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206816953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206816953">(Aug 13 2020 at 13:51)</a>:</h4>
<p>"counter" is probably the most accurate one word</p>



<a name="206817041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817041">(Aug 13 2020 at 13:52)</a>:</h4>
<p>but that doesn't give you a generic name for what is being counted</p>



<a name="206817048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817048">(Aug 13 2020 at 13:52)</a>:</h4>
<p>I could also see "unit" being appropriate but "counter" is fine by me.</p>



<a name="206817082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817082">(Aug 13 2020 at 13:52)</a>:</h4>
<p>IE "What are the units on this measurement?"</p>



<a name="206817134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817134">(Aug 13 2020 at 13:53)</a>:</h4>
<p>sure, it's the values of that measurement that I have a hard time with. like "timestamp"</p>



<a name="206817166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817166">(Aug 13 2020 at 13:53)</a>:</h4>
<p>hmm. "count" might be fine</p>



<a name="206817203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817203">(Aug 13 2020 at 13:53)</a>:</h4>
<p>even if "count of nanoseconds" is a weird way to refer to time</p>



<a name="206817290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817290">(Aug 13 2020 at 13:54)</a>:</h4>
<p>count, counter and units (the last one referring to the data in the snippet I pasted above) could work</p>



<a name="206817519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817519">(Aug 13 2020 at 13:56)</a>:</h4>
<p>so that units example: on the <code>.events</code> reader side:</p>
<ul>
<li>you use the unit with multiplier of 1 if you <em>have to</em> refer to the integer count</li>
<li>you use the first unit if you need an uniform thing to present to users</li>
<li>you can use any of the other units if you can have heterogenous rendering (this allows <code>3ms</code> or <code>50us</code> instead of <code>0.003s</code> and <code>0.00005s</code>)</li>
</ul>



<a name="206817559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817559">(Aug 13 2020 at 13:56)</a>:</h4>
<p>I think that's good enough of a strategy that it allows the reader side to not hardcode "unit types"</p>



<a name="206817599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817599">(Aug 13 2020 at 13:57)</a>:</h4>
<p>the <code>summarize summarize --json</code> output would be changed for time measurements if we don't special-case time</p>



<a name="206817643"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817643" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817643">(Aug 13 2020 at 13:57)</a>:</h4>
<p>hopefully that's fine. anyway these are my thoughts on actually landing this, as opposed to me using it for measurements</p>



<a name="206817722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817722">(Aug 13 2020 at 13:58)</a>:</h4>
<p>seems good to me</p>



<a name="206817750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817750">(Aug 13 2020 at 13:58)</a>:</h4>
<p>we might want a "canonical integer representation" I guess</p>



<a name="206817762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817762">(Aug 13 2020 at 13:58)</a>:</h4>
<p>but that can just be the rightmost unit</p>



<a name="206817796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206817796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206817796">(Aug 13 2020 at 13:58)</a>:</h4>
<p>(or whichever one has a "1")</p>



<a name="206818280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818280">(Aug 13 2020 at 14:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/206817796">said</a>:</p>
<blockquote>
<p>(or whichever one has a "1")</p>
</blockquote>
<p>yeah that's what I meant above with "if you <em>have to</em> refer to the integer count"</p>



<a name="206818339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818339">(Aug 13 2020 at 14:03)</a>:</h4>
<p>glad I remembered about the JSON blob, that makes this <em>significantly</em> easier than I thought it would be, and probably more backwards-compatible lol</p>



<a name="206818373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818373">(Aug 13 2020 at 14:03)</a>:</h4>
<p>assuming the old code ignores unknown keys in the JSON blob</p>



<a name="206818389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818389">(Aug 13 2020 at 14:03)</a>:</h4>
<p>I think so, it's just serde</p>



<a name="206818410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818410">(Aug 13 2020 at 14:03)</a>:</h4>
<p>I don't think we would've put a deny on it</p>



<a name="206818477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818477">(Aug 13 2020 at 14:04)</a>:</h4>
<p>One question might be is whether we want to switch perf.r-l.o to just instruction-counting</p>



<a name="206818489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818489">(Aug 13 2020 at 14:04)</a>:</h4>
<p>I think that's the right thing to do</p>



<a name="206818511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818511">(Aug 13 2020 at 14:04)</a>:</h4>
<p>and there might be some question of "when is time even good to record"</p>



<a name="206818529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818529">(Aug 13 2020 at 14:04)</a>:</h4>
<p>at least at query-level</p>



<a name="206818863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818863">(Aug 13 2020 at 14:07)</a>:</h4>
<p>I think I want flags to control everything and even allow e.g. the cycles:u measurement I alluded to earlier</p>



<a name="206818896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818896">(Aug 13 2020 at 14:07)</a>:</h4>
<p>oh sure, but we're not going to have capacity/budget/whatever on perf.rlo to record everything</p>



<a name="206818904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818904">(Aug 13 2020 at 14:07)</a>:</h4>
<p>so I think we'll want to pick one thing</p>



<a name="206818909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818909">(Aug 13 2020 at 14:07)</a>:</h4>
<p>and eat the (minor) cost of the support of that being there</p>



<a name="206818982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206818982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206818982">(Aug 13 2020 at 14:08)</a>:</h4>
<p>right, on known hardware we can just do that</p>



<a name="206819058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206819058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206819058">(Aug 13 2020 at 14:09)</a>:</h4>
<p>this would be easy if we could just force it onto everyone but I feel like it's better design anyway to make the implementation flexible and choose at the use site</p>



<a name="206867371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206867371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206867371">(Aug 13 2020 at 20:32)</a>:</h4>
<p><em>sigh</em> remember how I was complaining about something weird happening and having the dynamically unreachable time sampling somehow adding half of the cost of actually doing the time sampling? well, when building w/o debug assertions, the <code>19 ±4</code> overhead of the simplest possible setup goes down to <code>14 ±2</code> <em>even with</em> the "dynamically dead time sampling" code path left in - I suspected this might happen but didn't properly check</p>



<a name="206869101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206869101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206869101">(Aug 13 2020 at 20:46)</a>:</h4>
<p>this is with the same workload (compiling the same version of libcore in check mode), and the number of samples is the same, I checked, so the only difference should really be debug-assertions-induced overhead. really weird what it does to optimizations though</p>



<a name="206869193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206869193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206869193">(Aug 13 2020 at 20:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so the good news is that it's actually both cheaper to measure instructions at all, <em>and</em> less worrying to dynamically make a decision on <em>what</em> to sample, the bad news is I have to do the data gathering all over again ugh</p>



<a name="206869247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206869247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206869247">(Aug 13 2020 at 20:47)</a>:</h4>
<p>fwiw I don't personally mind landing this without gathering any data on the raw performance impact</p>



<a name="206869255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206869255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206869255">(Aug 13 2020 at 20:47)</a>:</h4>
<p>well, re-gathering</p>



<a name="206869349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206869349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206869349">(Aug 13 2020 at 20:48)</a>:</h4>
<p>you don't, but I'll have to make a report where having this information will help :P</p>



<a name="206869432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206869432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206869432">(Aug 13 2020 at 20:49)</a>:</h4>
<p>anyway it doesn't take that long, and I've learned what not to do to avoid wasting time, it's just another hour of work or so</p>



<a name="206869777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206869777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206869777">(Aug 13 2020 at 20:51)</a>:</h4>
<p>and who knows, maybe I find some other broken assumption or mistake I've made before</p>



<a name="206872872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206872872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206872872">(Aug 13 2020 at 21:17)</a>:</h4>
<p>okay good thing I checked, it does go down, but merely to <code>8 ±4</code>, if I remove the "dynamically dead code". it's nowhere near 150-200 or however many instructions it was before between those two, although maybe measuring time is really cheap too w/o debug assertions?</p>



<a name="206874375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206874375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206874375">(Aug 13 2020 at 21:30)</a>:</h4>
<p><code>8 ±4</code> is interesting because just off the top of my head, there's no way around 7-8 instructions for the <code>rdpmc</code> measurement (load the counter index, <code>rdpmc</code>, combine two halves into an <code>u64</code>, sext from 48 to 64 bits, subtract the start count)</p>



<a name="206874403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206874403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206874403">(Aug 13 2020 at 21:31)</a>:</h4>
<p>so this finally <em>feels</em> right</p>



<a name="206875806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206875806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206875806">(Aug 13 2020 at 21:46)</a>:</h4>
<p>uhh more weirdness: why is <code>Instant::elapsed</code> <em>twice as fast</em> (<code>367 ±4</code> -&gt; <code>189 ±3</code>) now? maybe this isn't from debug assertions, but disabling incremental</p>



<a name="206883889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206883889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206883889">(Aug 13 2020 at 23:32)</a>:</h4>
<p>oh no. oh dear. could this code stop playing tricks on me</p>



<a name="206883979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206883979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206883979">(Aug 13 2020 at 23:33)</a>:</h4>
<p>I've somehow gone from "weirdly large cost from code that doesn't even run" to "adding extra code can make it run less instructions"(??)</p>



<a name="206884071"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206884071" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206884071">(Aug 13 2020 at 23:34)</a>:</h4>
<p>I might need to make this <code>#[inline(always)]</code> instead of <code>#[inline]</code> :/</p>



<a name="206891114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206891114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206891114">(Aug 14 2020 at 01:48)</a>:</h4>
<p>nope, <code>#[inline(never)]</code> was what made it sensible</p>



<a name="206897565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206897565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206897565">(Aug 14 2020 at 04:36)</a>:</h4>
<p>except <code>#[inline(never)]</code> makes a different thing cheaper than something it shouldn't be cheaper than... (so the most realistic configuration ends up as <code>-1 ±3</code> instead of <code>14 ±2</code>)</p>



<a name="206897572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206897572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206897572">(Aug 14 2020 at 04:37)</a>:</h4>
<p>one of these days I'll learn not to pick a fight with LLVM</p>



<a name="206899615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206899615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206899615">(Aug 14 2020 at 05:30)</a>:</h4>
<p>I really just want the table here again but w/o the costs of debug-assertions or incremental, and I keep coming up with numbers that don't match that ordering <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50#gistcomment-3399834">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50#gistcomment-3399834</a></p>



<a name="206900066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206900066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206900066">(Aug 14 2020 at 05:40)</a>:</h4>
<p>oh, <code>black_box(0)</code> is like 4-5 instructions. and I'm working at a scale at which that matters. I might have to make my own, cheaper, <code>black_box(0)</code> using inline assembly</p>



<a name="206900465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206900465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206900465">(Aug 14 2020 at 05:48)</a>:</h4>
<p>maybe this helps <a href="https://godbolt.org/z/an8avP">https://godbolt.org/z/an8avP</a></p>



<a name="206900663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206900663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206900663">(Aug 14 2020 at 05:53)</a>:</h4>
<p>actually, hmm, this is pretty neat (limited to things that fit in a register, sadly) <a href="https://godbolt.org/z/eP3ocG">https://godbolt.org/z/eP3ocG</a></p>



<a name="206900829"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206900829" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jknodt <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206900829">(Aug 14 2020 at 05:57)</a>:</h4>
<p>is it possible you could just pass a ptr to the asm call so it works for anything?</p>



<a name="206900879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206900879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206900879">(Aug 14 2020 at 05:58)</a>:</h4>
<p><span class="user-mention" data-user-id="326189">@jknodt</span> that's what <code>std::hint::black_box</code> does and exactly what that snippet shows I can avoid</p>



<a name="206900890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206900890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jknodt <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206900890">(Aug 14 2020 at 05:58)</a>:</h4>
<p>ah oops, I was unaware</p>



<a name="206900919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206900919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206900919">(Aug 14 2020 at 05:59)</a>:</h4>
<p>I am trying to reduce as much as possible the overhead of <code>black_box</code> because I'm counting the instructions and when you have literally 4-8 instructions, every instruction <del>counts</del> matters</p>



<a name="206900928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206900928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206900928">(Aug 14 2020 at 05:59)</a>:</h4>
<p>the only reason I'm using it is so that LLVM doesn't optimize out so much it makes it impossible to determine any other overheads</p>



<a name="206903558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206903558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206903558">(Aug 14 2020 at 06:56)</a>:</h4>
<p>oh hey it is measurably cheaper :D (by about 3 instructions)</p>



<a name="206903719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206903719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206903719">(Aug 14 2020 at 07:00)</a>:</h4>
<p>left a note here for anyone who might find this useful <a href="https://github.com/rust-lang/rust/issues/64102#issuecomment-673921803">https://github.com/rust-lang/rust/issues/64102#issuecomment-673921803</a></p>



<a name="206905247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206905247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206905247">(Aug 14 2020 at 07:30)</a>:</h4>
<p>phew, more code -&gt; more instructions, not less, finally</p>



<a name="206906876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206906876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206906876">(Aug 14 2020 at 08:00)</a>:</h4>
<p><code>5 ±3</code> instructions to sample only <code>rdpmc</code>, <code>17 ±3</code> with the "dynamically dead time fallback", I think that's fine</p>



<a name="206906964"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206906964" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206906964">(Aug 14 2020 at 08:02)</a>:</h4>
<p>sampling instructions on top of time (but not using them) is an increase from <code>180 ±4</code> to <code>184 ±4</code>, so I'd be happy to say it's 4-8 instructions</p>



<a name="206906985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206906985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206906985">(Aug 14 2020 at 08:02)</a>:</h4>
<p>the important thing is that <code>17</code> is 10 times smaller than <code>180</code>, <em>not</em> half</p>



<a name="206907408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206907408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206907408">(Aug 14 2020 at 08:11)</a>:</h4>
<p><a href="/user_uploads/4715/UYdafm3wo0r6JsxF7Q5xjBvn/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/UYdafm3wo0r6JsxF7Q5xjBvn/image.png" title="image.png"><img src="/user_uploads/4715/UYdafm3wo0r6JsxF7Q5xjBvn/image.png"></a></div>



<a name="206907482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206907482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206907482">(Aug 14 2020 at 08:12)</a>:</h4>
<p>I should've been doing this from the start, it's so much easier to duplicate any analysis for a similar shaped dataset, than all of the stuff I was doing by hand</p>



<a name="206908626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206908626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206908626">(Aug 14 2020 at 08:33)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> huh I just checked with tiny test programs and <code>setarch $(uname -m) -R</code> actually works, for both static data and heap pointers o_O</p>



<a name="206908648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206908648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206908648">(Aug 14 2020 at 08:33)</a>:</h4>
<p>this means I don't actually know what's causing all the noise during rustc runs</p>



<a name="206908722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206908722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206908722">(Aug 14 2020 at 08:34)</a>:</h4>
<p>ugh could it be that I was going through the <code>rustup</code> wrapper for <code>rustc</code>? I didn't think of that</p>



<a name="206908752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206908752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206908752">(Aug 14 2020 at 08:35)</a>:</h4>
<p>oh come on</p>



<a name="206908754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206908754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206908754">(Aug 14 2020 at 08:35)</a>:</h4>
<p>I can already tell it's working</p>



<a name="206908808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206908808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206908808">(Aug 14 2020 at 08:36)</a>:</h4>
<p>it's not exactly the same value every time but the closest two runs are <em>49</em> instructions apart (out of <em>43 billion</em>)</p>



<a name="206908901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206908901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206908901">(Aug 14 2020 at 08:38)</a>:</h4>
<p>at least I've stopped gathering 100 each, so I wasn't wasting more than a few minutes (and it's not perfectly identical every run so it's not like I could've cut it down to 1 value)</p>



<a name="206909148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206909148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206909148">(Aug 14 2020 at 08:42)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> apologies for all of the information that seemed final at the time but now I have to redo it all one last time, with ASLR disabled <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<a name="206909162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206909162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206909162">(Aug 14 2020 at 08:43)</a>:</h4>
<p>just because of how much of a difference it makes</p>



<a name="206909233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206909233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206909233">(Aug 14 2020 at 08:44)</a>:</h4>
<p>I'm probably throwing away the debug-assertions+incremental data. it's not relevant to builds we want to measure perf on, and I didn't have ASLR disabled, and I'm not redoing <em>those</em></p>



<a name="206910473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206910473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206910473">(Aug 14 2020 at 09:05)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> without ASLR the <code>rdpmc</code> overhead seems to be <em>exactly</em> 4 instructions, and in the "dynamically picking what to sample" configuration, 18 instructions. the variance is small enough that my conservative math results in "±0"</p>



<a name="206913252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206913252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206913252">(Aug 14 2020 at 09:47)</a>:</h4>
<p>lol I think I'm seeing <a href="https://github.com/rust-lang/rust/blob/43bec40138bab10c08ac916bff2f2f81b2b70669/library/std/src/sys/unix/time.rs#L68-L71">https://github.com/rust-lang/rust/blob/43bec40138bab10c08ac916bff2f2f81b2b70669/library/std/src/sys/unix/time.rs#L68-L71</a> in the data</p>



<a name="206913335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206913335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206913335">(Aug 14 2020 at 09:48)</a>:</h4>
<p>when time is being sampled, there's variance in the data on the order of the number of samples (1.7 million)</p>



<a name="206913360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206913360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206913360">(Aug 14 2020 at 09:48)</a>:</h4>
<p>presumably that codepath adds 2 extra instructions or so</p>



<a name="206913593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206913593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206913593">(Aug 14 2020 at 09:52)</a>:</h4>
<p>the difference ASLR makes: <a href="/user_uploads/4715/PGbUXHz3cDMnb_GNB5xZmExO/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/PGbUXHz3cDMnb_GNB5xZmExO/image.png" title="image.png"><img src="/user_uploads/4715/PGbUXHz3cDMnb_GNB5xZmExO/image.png"></a></div>



<a name="206955630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206955630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206955630">(Aug 14 2020 at 17:33)</a>:</h4>
<p>hmm, actually, are CPU clock cycles measured by <code>rdtsc</code>, not <code>rdpmc</code>? that would make it harder for me to directly use it as another "hardware counter" to make the code more realistic - although, at the same time, maybe I can just go and implement <code>rdtsc</code> lol</p>



<a name="206961859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206961859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206961859">(Aug 14 2020 at 18:32)</a>:</h4>
<p>hmm, 6 instructions after and 1 before <a href="https://godbolt.org/z/s4KGMf">https://godbolt.org/z/s4KGMf</a></p>



<a name="206961919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206961919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206961919">(Aug 14 2020 at 18:33)</a>:</h4>
<p>a bit odd that they don't show up directly in my measurements. I guess my estimate of 8 was right all along and there's just stuff I can't account for in the codegen</p>



<a name="206962114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206962114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206962114">(Aug 14 2020 at 18:35)</a>:</h4>
<p>if you replace the <code>i64</code> with <code>u64</code> you get a clever use of <code>movzx</code> instead</p>



<a name="206965498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206965498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206965498">(Aug 14 2020 at 19:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/206913252">said</a>:</p>
<blockquote>
<p>lol I think I'm seeing <a href="https://github.com/rust-lang/rust/blob/43bec40138bab10c08ac916bff2f2f81b2b70669/library/std/src/sys/unix/time.rs#L68-L71">https://github.com/rust-lang/rust/blob/43bec40138bab10c08ac916bff2f2f81b2b70669/library/std/src/sys/unix/time.rs#L68-L71</a> in the data</p>
</blockquote>
<p>oops, no, it's <a href="https://github.com/rust-lang/rust/blob/43bec40138bab10c08ac916bff2f2f81b2b70669/library/std/src/sys/unix/time.rs#L23-L33">https://github.com/rust-lang/rust/blob/43bec40138bab10c08ac916bff2f2f81b2b70669/library/std/src/sys/unix/time.rs#L23-L33</a></p>



<a name="206966739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206966739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206966739">(Aug 14 2020 at 19:16)</a>:</h4>
<p>I am being informed (by <span class="user-mention" data-user-id="310399">@Mara</span>) that the kernel stores <code>u64</code> nanoseconds, converts that into seconds + nanoseconds to be "helpful" then we convert that back... so that's a division by 10⁹ followed by a multiplication by 10⁹</p>



<a name="206967865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206967865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206967865">(Aug 14 2020 at 19:26)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> does rustc-perf currently track the variance in the <code>perf stat</code> values it averages or w/e?</p>



<a name="206967880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206967880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206967880">(Aug 14 2020 at 19:26)</a>:</h4>
<p>also, how do you disable ASLR? is it system-wide?</p>



<a name="206968032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968032">(Aug 14 2020 at 19:27)</a>:</h4>
<p>I'm worried some of our own data is less useful merely because <code>rustc-perf</code> itself doesn't disable ASLR... although no, it doesn't actually seem to be that way now that I think about it again, or at least it's not a big part of it (for time data, anyway)</p>



<a name="206968093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968093">(Aug 14 2020 at 19:28)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> system wide, but we can do local too if that helps</p>



<a name="206968122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968122">(Aug 14 2020 at 19:28)</a>:</h4>
<p>the local one might just always work</p>



<a name="206968145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968145">(Aug 14 2020 at 19:28)</a>:</h4>
<p><code>setarch $(uname -m) -R ./build/x86_64-unknown-linux-gnu/stage1/bin/rustc ...</code> is what I'm doing</p>



<a name="206968159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968159">(Aug 14 2020 at 19:28)</a>:</h4>
<p>I didn't want to use sudo if we can avoid it within perf's scripts</p>



<a name="206968169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968169">(Aug 14 2020 at 19:28)</a>:</h4>
<p>doesn't require it</p>



<a name="206968188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968188">(Aug 14 2020 at 19:29)</a>:</h4>
<p>(we don't have root access on <a href="http://build.lyken.rs">build.lyken.rs</a>)</p>



<a name="206968302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968302">(Aug 14 2020 at 19:30)</a>:</h4>
<p>I also wonder, e.g. if <span class="user-mention" data-user-id="120989">@njn</span> was disabling ASLR when profiling. the difference is big enough IMO to be significant, and with ASLR disabled rustc behaves much better</p>



<a name="206968314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968314">(Aug 14 2020 at 19:30)</a>:</h4>
<p>Ah okay, then sounds great n</p>



<a name="206968337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968337">(Aug 14 2020 at 19:30)</a>:</h4>
<p>We do not track variance but I have raw data for each run we do</p>



<a name="206968350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968350">(Aug 14 2020 at 19:30)</a>:</h4>
<p>So we could compute it</p>



<a name="206968378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968378">(Aug 14 2020 at 19:31)</a>:</h4>
<p>there's still ±8k (in the 43B total) but I suspect it might not show up on most queries, so it might be possible to find where that comes from (it might just be some IO?)</p>



<a name="206968414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968414">(Aug 14 2020 at 19:31)</a>:</h4>
<p>Maybe! I don't know how to isolate variance on these scales though</p>



<a name="206968511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968511">(Aug 14 2020 at 19:32)</a>:</h4>
<p>what I've been doing is just <code>${(max+min)/2} ±${(max-min)/2}</code> which is probably not the best statistical approach lol</p>



<a name="206968563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968563">(Aug 14 2020 at 19:32)</a>:</h4>
<p>that is, I'm ignoring the probability distribution within the <code>min..=max</code> range</p>



<a name="206968590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206968590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206968590">(Aug 14 2020 at 19:33)</a>:</h4>
<p>but it does seem to be good enough to tell me how much it jumps around</p>



<a name="206986591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206986591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206986591">(Aug 14 2020 at 21:56)</a>:</h4>
<p>incredible, moving the <code>- 1</code> here to after the other subtraction is required for LLVM to make this branchless &lt;<a href="https://github.com/rust-lang/rust/blob/43bec40138bab10c08ac916bff2f2f81b2b70669/library/std/src/sys/unix/time.rs#L30">https://github.com/rust-lang/rust/blob/43bec40138bab10c08ac916bff2f2f81b2b70669/library/std/src/sys/unix/time.rs#L30</a>&gt;</p>



<a name="206986613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206986613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206986613">(Aug 14 2020 at 21:56)</a>:</h4>
<p>(the other requirement is deduplicating the <code>Duration::new</code> call which is something else LLVM should be able to do itself <em>sigh</em>)</p>



<a name="206986730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206986730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206986730">(Aug 14 2020 at 21:58)</a>:</h4>
<p>there's other optimizations <span class="user-mention" data-user-id="310399">@Mara</span> wants to make but I think I can get rid of the instruction variance just by triggering the right LLVM optimizations with minimal changes, <em>and land</em> those changes</p>



<a name="206990719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206990719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> njn <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206990719">(Aug 14 2020 at 22:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/206968302">said</a>:</p>
<blockquote>
<p>I also wonder, e.g. if <span class="user-mention silent" data-user-id="120989">njn</span> was disabling ASLR when profiling.</p>
</blockquote>
<p>nope</p>



<a name="206994888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206994888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206994888">(Aug 15 2020 at 00:04)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> first PR up <a href="https://github.com/rust-lang/rust/pull/75545">https://github.com/rust-lang/rust/pull/75545</a></p>



<a name="206994912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206994912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206994912">(Aug 15 2020 at 00:05)</a>:</h4>
<p>(don't get too excited though, it's the <code>Instant::elapsed</code> non-deterministic instruction count thing :P)</p>



<a name="206994988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206994988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206994988">(Aug 15 2020 at 00:06)</a>:</h4>
<p>this is what it allows me to get: <a href="/user_uploads/4715/43jpVXTjepLH60d68OTjrLAu/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/43jpVXTjepLH60d68OTjrLAu/image.png" title="image.png"><img src="/user_uploads/4715/43jpVXTjepLH60d68OTjrLAu/image.png"></a></div>



<a name="206995021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206995021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206995021">(Aug 15 2020 at 00:07)</a>:</h4>
<p>all the "total instruction count" noise is now like 100-200x smaller than the number of <code>measureme</code> events</p>



<a name="206995030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206995030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206995030">(Aug 15 2020 at 00:07)</a>:</h4>
<p>mostly thanks to disabling ASLR</p>



<a name="206995093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206995093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206995093">(Aug 15 2020 at 00:08)</a>:</h4>
<p>with some dedication it might be possible to reduce it further</p>



<a name="206995131"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/206995131" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#206995131">(Aug 15 2020 at 00:09)</a>:</h4>
<p>hopefully that is the last time I look at time</p>



<a name="207023378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207023378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207023378">(Aug 15 2020 at 14:05)</a>:</h4>
<p>this UI is not perfect, but it kinda works :D <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50/revisions?short_path=276f278#diff-276f27882e3d5a545404f37b49cbbb4c">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50/revisions?short_path=276f278#diff-276f27882e3d5a545404f37b49cbbb4c</a></p>



<a name="207024754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207024754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207024754">(Aug 15 2020 at 14:44)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> final version, thanks to disabling ASLR I should be able to keep that realistic overhead of 18 instructions no matter what other things I change, I feel <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50</a></p>



<a name="207024758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207024758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207024758">(Aug 15 2020 at 14:44)</a>:</h4>
<p>the plots are... effectively 1D now :P</p>



<a name="207025008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025008">(Aug 15 2020 at 14:52)</a>:</h4>
<p>fwiw the panic thing might be fixable with a catch_unwind that, on unwinding, hits hint::unreachable_unchecked</p>



<a name="207025010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025010">(Aug 15 2020 at 14:52)</a>:</h4>
<p>but maybe we shouldn't do that :)</p>



<a name="207025015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025015">(Aug 15 2020 at 14:52)</a>:</h4>
<p>I doubt it's that simple</p>



<a name="207025022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025022">(Aug 15 2020 at 14:53)</a>:</h4>
<p>perhaps not</p>



<a name="207025023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025023">(Aug 15 2020 at 14:53)</a>:</h4>
<p>panicking shouldn't cause instructions to run in the happy path</p>



<a name="207025033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025033">(Aug 15 2020 at 14:53)</a>:</h4>
<p>overheads are definitely more than low enough</p>



<a name="207025035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025035">(Aug 15 2020 at 14:53)</a>:</h4>
<p>yeah I'm happy with it being 18 and not 180 :P</p>



<a name="207025083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025083">(Aug 15 2020 at 14:54)</a>:</h4>
<p>this is what I was working with before I realized how much of an impact my debug-assertions+incremental configuration was hurting things <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50/78f97038d768aa355b3767785224a946cb919ef1">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50/78f97038d768aa355b3767785224a946cb919ef1</a></p>



<a name="207025094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025094">(Aug 15 2020 at 14:55)</a>:</h4>
<p>presumably with ASLR disabled that would just say 180 or 181 :P</p>



<a name="207025102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025102">(Aug 15 2020 at 14:55)</a>:</h4>
<p>but I'm not checking</p>



<a name="207025208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025208">(Aug 15 2020 at 14:58)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> anyway the good news is that, assuming your disabling of ASLR works, perf.r-l.o will require no changes to get the low-noise  benefits</p>



<a name="207025212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025212">(Aug 15 2020 at 14:58)</a>:</h4>
<p>we did confirm that it disables ASLR by checking that a pointer is at the same location when running, iirc, but didn't do more than that</p>



<a name="207025214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025214">(Aug 15 2020 at 14:58)</a>:</h4>
<p>and it should be on the cheaper end thanks to the builds being nightly ones</p>



<a name="207025221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025221">(Aug 15 2020 at 14:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> we should actually be able to tell if you render the variance</p>



<a name="207025222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025222">(Aug 15 2020 at 14:59)</a>:</h4>
<p>Wouldn't changing code sizes have an effect similar to ASLR?</p>



<a name="207025224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025224">(Aug 15 2020 at 14:59)</a>:</h4>
<p>what do you mean by "code sizes"?</p>



<a name="207025225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025225">(Aug 15 2020 at 14:59)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> hm so I'm not really opposed to rendering variance but historically have not done so because we have like at most 3 data points per run</p>



<a name="207025231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025231">(Aug 15 2020 at 14:59)</a>:</h4>
<p>I wish the data was accessible some other way :(</p>



<a name="207025233"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025233" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025233">(Aug 15 2020 at 14:59)</a>:</h4>
<p>If the size of the <code>.text</code> or <code>.data</code> sections in the rustc executable changes.</p>



<a name="207025281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025281">(Aug 15 2020 at 15:00)</a>:</h4>
<p>ah sure but I'm interested in variance within one <code>rustc</code> build, at least for now</p>



<a name="207025304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025304">(Aug 15 2020 at 15:00)</a>:</h4>
<p>although that's a good point when it comes to looking at differences between two rustc versions</p>



<a name="207025317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025317">(Aug 15 2020 at 15:01)</a>:</h4>
<p>data is accessible via sqlite database dumps, I can prepare one that's recent and give it you if you want</p>



<a name="207025324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025324">(Aug 15 2020 at 15:01)</a>:</h4>
<p>that's what I want to avoid :P</p>



<a name="207025340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025340">(Aug 15 2020 at 15:01)</a>:</h4>
<p>how would you want the data?</p>



<a name="207025383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025383">(Aug 15 2020 at 15:02)</a>:</h4>
<p>I have the files around so I could extract it with jq myself, it's just... effort to be able to <em>see</em> the differences. but I guess I can pick, say, hello world</p>



<a name="207025388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025388">(Aug 15 2020 at 15:02)</a>:</h4>
<p>I've wanted to do like high/low bands on the graph page for each data point</p>



<a name="207025389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025389">(Aug 15 2020 at 15:02)</a>:</h4>
<p>I guess we could</p>



<a name="207025392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025392">(Aug 15 2020 at 15:02)</a>:</h4>
<p>ohhh that'd be nice</p>



<a name="207025403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025403">(Aug 15 2020 at 15:03)</a>:</h4>
<p>probably needs me to pull <a href="https://github.com/rust-lang/rustc-perf/pull/744">https://github.com/rust-lang/rustc-perf/pull/744</a> over the edge</p>



<a name="207025538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025538">(Aug 15 2020 at 15:06)</a>:</h4>
<p>btw what is perf currently using?</p>



<a name="207025539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025539">(Aug 15 2020 at 15:06)</a>:</h4>
<p>for?</p>



<a name="207025541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025541">(Aug 15 2020 at 15:06)</a>:</h4>
<p>for plotting</p>



<a name="207025546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025546">(Aug 15 2020 at 15:06)</a>:</h4>
<p>highcharts</p>



<a name="207025551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025551">(Aug 15 2020 at 15:06)</a>:</h4>
<p>I've stuck with <a href="http://plot.ly">plot.ly</a> for my own personal use and it seems pretty nice but idk how easy it would be to integrate (or how fast etc.)</p>



<a name="207025556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025556">(Aug 15 2020 at 15:07)</a>:</h4>
<p>(it's just very easy to throw some data at it and play around with the settings, in its "chart studio")</p>



<a name="207025561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025561">(Aug 15 2020 at 15:07)</a>:</h4>
<p>oh heh that PR lists <a href="https://github.com/lampepfl/bench/pull/418">https://github.com/lampepfl/bench/pull/418</a> as mentioning it</p>



<a name="207025601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207025601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207025601">(Aug 15 2020 at 15:08)</a>:</h4>
<p>sounds like uPlot is faster than <a href="http://plot.ly">plot.ly</a></p>



<a name="207026003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026003">(Aug 15 2020 at 15:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <code>snzip -cd times/commit-d839ad4507180aa47a451a273cb3f1a1ba653c80-x86_64-unknown-linux-gnu.json.sz | jq '.benchmarks.helloworld.Ok.runs[] | select(.check == true) | .stats.stats[4]'</code></p>



<a name="207026067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026067">(Aug 15 2020 at 15:20)</a>:</h4>
<p>uhh, that's <code>111393821 ±12833352</code>, that's worse than I was getting <em>with</em> ASLR</p>



<a name="207026075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026075">(Aug 15 2020 at 15:21)</a>:</h4>
<p>which cache is that?</p>



<a name="207026079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026079">(Aug 15 2020 at 15:21)</a>:</h4>
<p>it's check mode</p>



<a name="207026081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026081">(Aug 15 2020 at 15:21)</a>:</h4>
<p>no, like, full build?</p>



<a name="207026082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026082">(Aug 15 2020 at 15:21)</a>:</h4>
<p>oooh sorry</p>



<a name="207026085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026085">(Aug 15 2020 at 15:21)</a>:</h4>
<p>wait what why are there 4 values total</p>



<a name="207026092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026092">(Aug 15 2020 at 15:21)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> are you sure the data is kept?</p>



<a name="207026134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026134">(Aug 15 2020 at 15:22)</a>:</h4>
<p>only as of recently</p>



<a name="207026137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026137">(Aug 15 2020 at 15:22)</a>:</h4>
<p>not in the JSON format (which has not been used in like 2 months?)</p>



<a name="207026138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026138">(Aug 15 2020 at 15:22)</a>:</h4>
<p>aaaaaaah. so not in the old rustc-timing <code>json.sz</code> files</p>



<a name="207026144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026144">(Aug 15 2020 at 15:22)</a>:</h4>
<p>so I just have no access to it. hmpf.</p>



<a name="207026171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026171">(Aug 15 2020 at 15:23)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> anyway just get me some helloworld-check/full values</p>



<a name="207026174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026174">(Aug 15 2020 at 15:23)</a>:</h4>
<p>yeah working on it</p>



<a name="207026219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026219">(Aug 15 2020 at 15:24)</a>:</h4>
<p>all I'm doing is <code>${(max+min)/2} ±${(max-min)/2}</code>, although for 3 values there's not like you have a lot of options huh</p>



<a name="207026226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026226">(Aug 15 2020 at 15:24)</a>:</h4>
<p>just sorting the values and looking at them will provide just as much insight</p>



<a name="207026234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026234">(Aug 15 2020 at 15:24)</a>:</h4>
<div class="codehilite"><pre><span></span><code> {103307800,101652511,101652367}
 {103300735,101645649,101645480}
 {102959339,101326806,101312198}
 {102960157,101302524,101314247}
 {102965663,101308304,101319839}
 {102965387,101307539,101307578}
 {102968902,101311513,101310930}
 {102967894,101309011,101309172}
 {102965638,101318501,101306774}
 {102976765,101317611,101317512}
 {102493279,100843371,100843371}
 {102496789,100847180,100847154}
 {102492400,100854924,100842823}
 {102492147,100842367,100842369}
 {102488342,100838672,100837924}
 {102488535,100838863,100838846}
 {102750537,101097301,101097162}
 {102758805,101116076,101104402}
 {102751384,101097248,101108144}
 {102505727,100848453,100847845}
 {102495957,100839075,100839826}
 {102503933,100859000,100847284}
 {102496033,100839284,100839285}
 {102499549,100844540,100843935}
 {102498828,100860489,100842486}
 {102504633,100848460,100848496}
 {102760905,101105154,101110976}
 {102548360,100900308,100899683}
 {103315765,101671339,101671371}
 {103317990,101674791,101674792}
 {103290474,101651630,101651444}
 {103294063,101654920,101654943}
 {103533896,101902695,101893341}
 {103536330,101897005,101897234}
</code></pre></div>



<a name="207026239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026239">(Aug 15 2020 at 15:25)</a>:</h4>
<p>I guess the first one is self-profile overhead</p>



<a name="207026241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026241">(Aug 15 2020 at 15:25)</a>:</h4>
<p>so ignore that</p>



<a name="207026242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026242">(Aug 15 2020 at 15:25)</a>:</h4>
<p>we only have 2</p>



<a name="207026878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026878">(Aug 15 2020 at 15:42)</a>:</h4>
<p>uhhh thanks I guess</p>



<a name="207026882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026882">(Aug 15 2020 at 15:42)</a>:</h4>
<p>but yeah looks like ASLR is off</p>



<a name="207026885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026885">(Aug 15 2020 at 15:43)</a>:</h4>
<p>just eyeballing it</p>



<a name="207026942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026942">(Aug 15 2020 at 15:44)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> wait, do we average the last 2, or all 3, when displaying the values?</p>



<a name="207026951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026951">(Aug 15 2020 at 15:44)</a>:</h4>
<p>We take minimum</p>



<a name="207026953"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026953" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026953">(Aug 15 2020 at 15:44)</a>:</h4>
<p>oooh</p>



<a name="207026968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207026968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207026968">(Aug 15 2020 at 15:45)</a>:</h4>
<p>We should add the setarch to perf directly</p>



<a name="207027040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207027040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207027040">(Aug 15 2020 at 15:47)</a>:</h4>
<p>yeah that would've prevented e.g. me gathering data (before any of this <code>rdpmc</code> stuff) going back all the way to february, with ASLR enabled. thankfully, it's not too bad and it's mostly there to inform us of where the interesting regressions/improvements are</p>



<a name="207027226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207027226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207027226">(Aug 15 2020 at 15:52)</a>:</h4>
<p>hmm the "18 instructions" figure jumps down to 16 if I compile rustc in a different directory. but I'm guessing the baseline would also be 2 instructions lower, so I just have to use one directory for all measurements I compare together lol</p>



<a name="207027229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207027229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207027229">(Aug 15 2020 at 15:52)</a>:</h4>
<p>pretty much what <span class="user-mention" data-user-id="133247">@bjorn3</span> was talking about wrt disabling ASLR not being enough</p>



<a name="207027234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207027234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207027234">(Aug 15 2020 at 15:53)</a>:</h4>
<p>something something allocate arenas at fixed addresses when a flag is passed</p>



<a name="207027297"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207027297" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207027297">(Aug 15 2020 at 15:55)</a>:</h4>
<p>I wonder if we shouldn't be using random tmp directories for benchmarking either, and instead going with some well known name</p>



<a name="207027302"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207027302" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207027302">(Aug 15 2020 at 15:55)</a>:</h4>
<p>hopefully that doesn't affect my measurements of overhead, too significantly. oh yeah, looking at the data with ASLR on allows me to confirm that the data with ASLR off isn't complete nonsense</p>



<a name="207027972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207027972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207027972">(Aug 15 2020 at 16:13)</a>:</h4>
<p>so hmm, looking at "variance" (<code>(max-min) / 2</code>) in the average self time <em>per</em> invocation (i.e. of <code>self_time / invocation_count</code>, not doing anything clever with individual events), these are all above ±1000:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;wf_checking&quot;</span><span class="p">:</span> <span class="mi">74755</span><span class="p">,</span>
  <span class="nt">&quot;generate_crate_metadata&quot;</span><span class="p">:</span> <span class="mf">44780.5</span><span class="p">,</span>
  <span class="nt">&quot;typeck_item_bodies&quot;</span><span class="p">:</span> <span class="mi">28286</span><span class="p">,</span>
  <span class="nt">&quot;match_checking&quot;</span><span class="p">:</span> <span class="mi">14127</span><span class="p">,</span>
  <span class="nt">&quot;death_checking&quot;</span><span class="p">:</span> <span class="mi">13407</span><span class="p">,</span>
  <span class="nt">&quot;analysis&quot;</span><span class="p">:</span> <span class="mf">8695.5</span><span class="p">,</span>
  <span class="nt">&quot;type_check_crate&quot;</span><span class="p">:</span> <span class="mf">7583.5</span><span class="p">,</span>
  <span class="nt">&quot;crate_inherent_impls_overlap_check&quot;</span><span class="p">:</span> <span class="mf">5398.5</span><span class="p">,</span>
  <span class="nt">&quot;MIR_effect_checking&quot;</span><span class="p">:</span> <span class="mi">5248</span><span class="p">,</span>
  <span class="nt">&quot;crate_lints&quot;</span><span class="p">:</span> <span class="mf">5192.5</span><span class="p">,</span>
  <span class="nt">&quot;expand_crate&quot;</span><span class="p">:</span> <span class="mf">3651.5</span><span class="p">,</span>
  <span class="nt">&quot;MIR_borrow_checking&quot;</span><span class="p">:</span> <span class="mf">1960.5</span><span class="p">,</span>
  <span class="nt">&quot;check_private_in_public&quot;</span><span class="p">:</span> <span class="mi">1853</span><span class="p">,</span>
  <span class="nt">&quot;inferred_outlives_crate&quot;</span><span class="p">:</span> <span class="mf">1703.5</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>



<a name="207028017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207028017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207028017">(Aug 15 2020 at 16:14)</a>:</h4>
<p>and I don't actually know why <em>these</em> would be affected</p>



<a name="207028319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207028319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207028319">(Aug 15 2020 at 16:22)</a>:</h4>
<p>the average across all queries is <code>±1018</code> instructions, but a lot of it is in queries that have no business being non-deterministic. for comparison, the same arbitrary metric is <code>0.878ms</code> for time, which is roughly 4000x noisier (but this isn't really indicative of much, even if confirms the general trend)</p>



<a name="207029561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207029561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207029561">(Aug 15 2020 at 16:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> ahh, adding <code>mfence</code> before and after <code>rdpmc</code> brings the <code>±1018</code> "average query variance" down to <code>±53</code> so 1. instruction serialization matters 2. <code>mfence</code> works (at least on AMD hardware)</p>



<a name="207029623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207029623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207029623">(Aug 15 2020 at 16:54)</a>:</h4>
<p>Seems worthwhile to include if it's not a big perf hit</p>



<a name="207029638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207029638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207029638">(Aug 15 2020 at 16:54)</a>:</h4>
<p>Hm does that imply.... 1000+ instructions in flight? I forget what mfence does exactly</p>



<a name="207029653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207029653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207029653">(Aug 15 2020 at 16:55)</a>:</h4>
<p>nah the measurement is far too unscientific for the scale to matter</p>



<a name="207029787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207029787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207029787">(Aug 15 2020 at 16:58)</a>:</h4>
<p>the good news is I have a metric which observes the distinction between serializing and not serializing (none of the "overhead" metrics see anything other than the 2 extra instructions), the bad news is... I'd rather not collect the overhead summary data again lol</p>



<a name="207029816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207029816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207029816">(Aug 15 2020 at 16:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> it's listed in AMD manuals as a "serializing instruction", the only other userspace one would be <code>cpuid</code> which I'd rather not use. serialization here I think refers to out-of-order execution</p>



<a name="207029906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207029906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207029906">(Aug 15 2020 at 17:00)</a>:</h4>
<p>Hm well how large of a percent is 1000? Looks pretty sizeable for the ones you listed</p>



<a name="207029972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207029972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207029972">(Aug 15 2020 at 17:01)</a>:</h4>
<p>let me uhh dump the top 14 like I did there, before I try <code>mfence</code> just before, and not after, the <code>rdpmc</code></p>



<a name="207030045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030045">(Aug 15 2020 at 17:03)</a>:</h4>
<p>I just wish I didn't spend the time to write this huge comment:</p>
<div class="codehilite"><pre><span></span><code><span class="w">        </span><span class="c1">// FIXME(eddyb) the Intel and AMD manuals warn about the need for</span>
<span class="w">        </span><span class="c1">// &quot;serializing instructions&quot; before/after `rdpmc`, if avoiding any</span>
<span class="w">        </span><span class="c1">// reordering is desired, but do not agree on the full set of usable</span>
<span class="w">        </span><span class="c1">// &quot;serializing instructions&quot; (e.g. `mfence` isn&#39;t listed in both).</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// The only usable, and guaranteed to work, &quot;serializing instruction&quot;</span>
<span class="w">        </span><span class="c1">// appears to be `cpuid`, but it doesn&#39;t seem easy to use, especially</span>
<span class="w">        </span><span class="c1">// due to the overlap in registers with `rdpmc` itself, and it might</span>
<span class="w">        </span><span class="c1">// have too high of a cost, compared to serialization benefits (if any).</span>
</code></pre></div>



<a name="207030061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030061">(Aug 15 2020 at 17:03)</a>:</h4>
<p>it was so easy to try, too</p>



<a name="207030249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030249">(Aug 15 2020 at 17:08)</a>:</h4>
<p>very few queries left where the variance per invocation is more than 0.5, and a bunch are just perfectly deterministic now</p>



<a name="207030452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030452">(Aug 15 2020 at 17:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> this is everything above <code>±10</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;expand_crate&quot;</span><span class="p">:</span> <span class="mf">8939.5</span><span class="p">,</span>
  <span class="nt">&quot;free_global_ctxt&quot;</span><span class="p">:</span> <span class="mi">726</span><span class="p">,</span>
  <span class="nt">&quot;drop_ast&quot;</span><span class="p">:</span> <span class="mf">409.5</span><span class="p">,</span>
  <span class="nt">&quot;wf_checking&quot;</span><span class="p">:</span> <span class="mf">252.5</span><span class="p">,</span>
  <span class="nt">&quot;hir_lowering&quot;</span><span class="p">:</span> <span class="mi">208</span><span class="p">,</span>
  <span class="nt">&quot;generate_crate_metadata&quot;</span><span class="p">:</span> <span class="mf">169.5</span><span class="p">,</span>
  <span class="nt">&quot;resolve_crate&quot;</span><span class="p">:</span> <span class="mf">165.5</span><span class="p">,</span>
  <span class="nt">&quot;setup_global_ctxt&quot;</span><span class="p">:</span> <span class="mi">152</span><span class="p">,</span>
  <span class="nt">&quot;build_hir_map&quot;</span><span class="p">:</span> <span class="mi">143</span><span class="p">,</span>
  <span class="nt">&quot;crate_lints&quot;</span><span class="p">:</span> <span class="mi">122</span><span class="p">,</span>
  <span class="nt">&quot;AST_validation&quot;</span><span class="p">:</span> <span class="mf">86.5</span><span class="p">,</span>
  <span class="nt">&quot;typeck_item_bodies&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
  <span class="nt">&quot;resolve_lifetimes&quot;</span><span class="p">:</span> <span class="mi">58</span><span class="p">,</span>
  <span class="nt">&quot;match_checking&quot;</span><span class="p">:</span> <span class="mi">49</span><span class="p">,</span>
  <span class="nt">&quot;analysis&quot;</span><span class="p">:</span> <span class="mf">32.5</span><span class="p">,</span>
  <span class="nt">&quot;lint_levels&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
  <span class="nt">&quot;type_check_crate&quot;</span><span class="p">:</span> <span class="mf">20.5</span><span class="p">,</span>
  <span class="nt">&quot;death_checking&quot;</span><span class="p">:</span> <span class="mi">19</span><span class="p">,</span>
  <span class="nt">&quot;MIR_effect_checking&quot;</span><span class="p">:</span> <span class="mi">17</span><span class="p">,</span>
  <span class="nt">&quot;drop_compiler&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
  <span class="nt">&quot;MIR_borrow_checking&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>



<a name="207030462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030462">(Aug 15 2020 at 17:12)</a>:</h4>
<p>Is that variance?</p>



<a name="207030467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030467">(Aug 15 2020 at 17:13)</a>:</h4>
<p>yeah, per invocation</p>



<a name="207030474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030474">(Aug 15 2020 at 17:13)</a>:</h4>
<p>same as the other thing I pasted before</p>



<a name="207030476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030476">(Aug 15 2020 at 17:13)</a>:</h4>
<p>Hm well expand crate has disk reading and such</p>



<a name="207030482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030482">(Aug 15 2020 at 17:13)</a>:</h4>
<p>Seems like a good start at least</p>



<a name="207030483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030483">(Aug 15 2020 at 17:13)</a>:</h4>
<p>yeah that's where most of the file IO is isn't it, huh</p>



<a name="207030551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030551">(Aug 15 2020 at 17:14)</a>:</h4>
<p>Though I've never been sure how much IO has userspace non-determinism</p>



<a name="207030563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030563">(Aug 15 2020 at 17:15)</a>:</h4>
<p>Anyway I'm happy with these variances to start off with</p>



<a name="207030705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030705">(Aug 15 2020 at 17:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> hmm I would expect partial reads to be the source of IO nondeterminism but actually that doesn't track</p>



<a name="207030756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030756">(Aug 15 2020 at 17:20)</a>:</h4>
<p>heh <span class="user-mention" data-user-id="310399">@Mara</span> is suggesting we can look at <code>strace</code> if we want to dig into IO nondeterminism</p>



<a name="207030764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207030764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207030764">(Aug 15 2020 at 17:20)</a>:</h4>
<p>that's something I didn't think of but it makes sense, alongside disabling ASLR it brings us closer to <code>rr</code></p>



<a name="207031379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207031379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207031379">(Aug 15 2020 at 17:38)</a>:</h4>
<p>that's funny, <code>mfence</code> only before, not after, is even better</p>



<a name="207031476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207031476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207031476">(Aug 15 2020 at 17:42)</a>:</h4>
<p>brings <code>expand_crate</code> down to about 1800. I'm not pasting it again because I'm trying <code>lfence</code> next</p>



<a name="207033587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207033587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207033587">(Aug 15 2020 at 18:37)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> with <code>lfence</code> it's down to this for queries above <code>±0.5</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;expand_crate&quot;</span><span class="p">:</span> <span class="mi">1068</span><span class="p">,</span>
  <span class="nt">&quot;free_global_ctxt&quot;</span><span class="p">:</span> <span class="mf">993.5</span><span class="p">,</span>
  <span class="nt">&quot;drop_ast&quot;</span><span class="p">:</span> <span class="mf">554.5</span><span class="p">,</span>
  <span class="nt">&quot;generate_crate_metadata&quot;</span><span class="p">:</span> <span class="mf">432.5</span><span class="p">,</span>
  <span class="nt">&quot;resolve_crate&quot;</span><span class="p">:</span> <span class="mf">334.5</span><span class="p">,</span>
  <span class="nt">&quot;build_hir_map&quot;</span><span class="p">:</span> <span class="mf">219.5</span><span class="p">,</span>
  <span class="nt">&quot;hir_lowering&quot;</span><span class="p">:</span> <span class="mi">179</span><span class="p">,</span>
  <span class="nt">&quot;setup_global_ctxt&quot;</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
  <span class="nt">&quot;wf_checking&quot;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span>
  <span class="nt">&quot;resolve_lifetimes&quot;</span><span class="p">:</span> <span class="mi">87</span><span class="p">,</span>
  <span class="nt">&quot;typeck_item_bodies&quot;</span><span class="p">:</span> <span class="mf">53.5</span><span class="p">,</span>
  <span class="nt">&quot;crate_variances&quot;</span><span class="p">:</span> <span class="mi">43</span><span class="p">,</span>
  <span class="nt">&quot;AST_validation&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
  <span class="nt">&quot;privacy_access_levels&quot;</span><span class="p">:</span> <span class="mi">26</span><span class="p">,</span>
  <span class="nt">&quot;early_lint_checks&quot;</span><span class="p">:</span> <span class="mi">23</span><span class="p">,</span>
  <span class="nt">&quot;check_private_in_public&quot;</span><span class="p">:</span> <span class="mf">21.5</span><span class="p">,</span>
  <span class="nt">&quot;get_lib_features&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
  <span class="nt">&quot;lint_levels&quot;</span><span class="p">:</span> <span class="mf">19.5</span><span class="p">,</span>
  <span class="nt">&quot;inferred_outlives_crate&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
  <span class="nt">&quot;death_checking&quot;</span><span class="p">:</span> <span class="mf">13.5</span><span class="p">,</span>
  <span class="nt">&quot;analysis&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
  <span class="nt">&quot;crate_lints&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
  <span class="nt">&quot;MIR_effect_checking&quot;</span><span class="p">:</span> <span class="mf">9.5</span><span class="p">,</span>
  <span class="nt">&quot;MIR_borrow_checking&quot;</span><span class="p">:</span> <span class="mf">5.5</span><span class="p">,</span>
  <span class="nt">&quot;link_binary&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="nt">&quot;write_crate_metadata&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
  <span class="nt">&quot;match_checking&quot;</span><span class="p">:</span> <span class="mf">4.5</span><span class="p">,</span>
  <span class="nt">&quot;unused_lib_feature_checking&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="nt">&quot;complete_gated_feature_checking&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
  <span class="nt">&quot;self_profile_alloc_query_strings&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
  <span class="nt">&quot;check_mod_item_types&quot;</span><span class="p">:</span> <span class="mf">3.432735426002182</span><span class="p">,</span>
  <span class="nt">&quot;specialization_graph_of&quot;</span><span class="p">:</span> <span class="mf">2.2374999998137355</span><span class="p">,</span>
  <span class="nt">&quot;type_check_crate&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&quot;mir_borrowck_const_arg&quot;</span><span class="p">:</span> <span class="mf">1.2222222222262644</span><span class="p">,</span>
  <span class="nt">&quot;get_lang_items&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;misc_checking_1&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;stability_index&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&quot;trait_impls_of&quot;</span><span class="p">:</span> <span class="mf">0.8647540983620274</span><span class="p">,</span>
  <span class="nt">&quot;collect_mod_item_types&quot;</span><span class="p">:</span> <span class="mf">0.8004484304983635</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>



<a name="207036089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207036089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207036089">(Aug 15 2020 at 19:43)</a>:</h4>
<p>hmm what I can do now is actually look at the worst offenders, using not 10 but 100 samples, because the distribution now should be more interesting</p>



<a name="207037816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207037816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207037816">(Aug 15 2020 at 20:26)</a>:</h4>
<p><a href="/user_uploads/4715/mZDqcs5sY0yUHx68do5hTYue/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/mZDqcs5sY0yUHx68do5hTYue/image.png" title="image.png"><img src="/user_uploads/4715/mZDqcs5sY0yUHx68do5hTYue/image.png"></a></div>



<a name="207037819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207037819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207037819">(Aug 15 2020 at 20:26)</a>:</h4>
<p>this is weird...</p>



<a name="207037885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207037885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207037885">(Aug 15 2020 at 20:28)</a>:</h4>
<p>oh dear, the faint wiggle in a plateau is my "proclaimed" variance</p>



<a name="207037936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207037936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207037936">(Aug 15 2020 at 20:29)</a>:</h4>
<p>which means everything else would show up as huge errors, or something else entirely, if I had it plugged into <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50</a></p>



<a name="207038136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038136">(Aug 15 2020 at 20:34)</a>:</h4>
<p>okay this is super weird but the spike up followed by going down to a plateau, in the right half, correlates to the <em>process ID</em> numbers going 6 digit -&gt; 4 digit -&gt; 5 digit. the plateaus correspond to process IDs staying the same number of digits</p>



<a name="207038180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038180">(Aug 15 2020 at 20:35)</a>:</h4>
<p>I wish I was making this up</p>



<a name="207038183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038183">(Aug 15 2020 at 20:35)</a>:</h4>
<div class="codehilite"><pre><span></span><code>core-121108 instructions:u=43369802349
core-121645 instructions:u=43369816774
core-8520   instructions:u=43372789853
core-15678  instructions:u=43372147988
core-15890  instructions:u=43372146592
</code></pre></div>



<a name="207038339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038339">(Aug 15 2020 at 20:39)</a>:</h4>
<p>yupp every single "level" corresponds to a PID length, the order is: 3, 6, 5, 4</p>



<a name="207038397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038397">(Aug 15 2020 at 20:40)</a>:</h4>
<p>Could it be the thread id (and not process id) being stringified or something like that?</p>



<a name="207038422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038422">(Aug 15 2020 at 20:41)</a>:</h4>
<p>again <span class="user-mention" data-user-id="310399">@Mara</span> comes to the rescue: it's probably the allocations cascading into moving around all the other allocations that happen after them</p>



<a name="207038507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038507">(Aug 15 2020 at 20:43)</a>:</h4>
<p>Maybe use leading zeros in the measureme profile names?</p>



<a name="207038556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038556">(Aug 15 2020 at 20:44)</a>:</h4>
<p>that's what <span class="user-mention" data-user-id="310399">@Mara</span> also suggested lol. yeah we should do that to avoid <a href="http://perf.rust-lang.org">perf.rust-lang.org</a> seeing this effect at all</p>



<a name="207038716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038716">(Aug 15 2020 at 20:49)</a>:</h4>
<p>welp, so, my overhead measurements have 6-digit PIDs for the first 2 columns but 5-digit PIDs for the remaining 3 columns. but at least I don't have any column with more than one PID length, which means at most the "overhead" value may be off, and I'll try figure out by how much, but it shouldn't really be a big problem</p>



<a name="207038791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207038791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207038791">(Aug 15 2020 at 20:50)</a>:</h4>
<p>hmm I guess the 3, 6, 5, 4 order is just because it probably cascades into pointer-keyed hashmaps which would have one of four possible modes but they do not need to correlate with that one small allocation that caused it</p>



<a name="207039047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207039047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207039047">(Aug 15 2020 at 20:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so I think what the pid length difference leads to is one less instruction in each of the last 3 columns (or rows in the gist I guess). I'll cut my losses and not go back to correct that, at the very least it has no impact on the variance</p>



<a name="207039373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207039373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207039373">(Aug 15 2020 at 21:07)</a>:</h4>
<p><a href="https://twitter.com/eddyb_r/status/1294745328739127296">https://twitter.com/eddyb_r/status/1294745328739127296</a><br>
<a href="user_uploads/4715/5aGihzizuTmaelBhdkKzNBLI/image.png">image.png</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/eddyb_r/status/1294745328739127296"><img class="twitter-avatar" src="https://pbs.twimg.com/profile_images/1291545948322226178/trAmIAt9_normal.jpg"></a><p>expectation: disable ASLR, get deterministic pointer hashing

reality: entropy vacuum that will be filled by anything, even something as insignificant as *checks notes* log₁₀(pid)?? <a href="https://t.co/4jwCe5snWM">https://twitter.com/eddyb_r/status/1294745328739127296/photo/1</a></p><span>- eddyb, continuously burning out, (@eddyb_r)</span><div class="twitter-image"><a href="https://t.co/4jwCe5snWM"><img src="https://pbs.twimg.com/media/EffbA0sX0AAqfJG.jpg:thumb"></a></div></div></div><div class="message_inline_image"><a href="user_uploads/4715/5aGihzizuTmaelBhdkKzNBLI/image.png" title="image.png"><img src="user_uploads/4715/5aGihzizuTmaelBhdkKzNBLI/image.png"></a></div>



<a name="207040599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207040599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207040599">(Aug 15 2020 at 21:40)</a>:</h4>
<p>ugh the tweet doesn't load properly</p>



<a name="207041273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041273">(Aug 15 2020 at 21:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> hmm I wonder if we're running into one of these <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-400325608">https://github.com/mozilla/rr/issues/2034#issuecomment-400325608</a></p>



<a name="207041280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041280">(Aug 15 2020 at 21:57)</a>:</h4>
<p>I've never gotten rr to work on amd cpus</p>



<a name="207041293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041293">(Aug 15 2020 at 21:57)</a>:</h4>
<p>but I've only tried on 1800x</p>



<a name="207041294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041294">(Aug 15 2020 at 21:57)</a>:</h4>
<p>specifically, <code>instructions:u</code> might be affected</p>



<a name="207041370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041370">(Aug 15 2020 at 21:59)</a>:</h4>
<p><a href="/user_uploads/4715/fyzCmv9qyut954lc6r4frwGr/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/fyzCmv9qyut954lc6r4frwGr/image.png" title="image.png"><img src="/user_uploads/4715/fyzCmv9qyut954lc6r4frwGr/image.png"></a></div>



<a name="207041375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041375">(Aug 15 2020 at 21:59)</a>:</h4>
<p>if it's just that we can disable c6 easily</p>



<a name="207041389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041389">(Aug 15 2020 at 21:59)</a>:</h4>
<p><a href="https://github.com/jfredrickson/disable-c6">https://github.com/jfredrickson/disable-c6</a></p>



<a name="207041507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041507">(Aug 15 2020 at 22:01)</a>:</h4>
<p>will ask our sysadmin if we can try this on <a href="http://build.lyken.rs">build.lyken.rs</a>, and see what it does to the data, thanks!</p>



<a name="207041562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041562">(Aug 15 2020 at 22:02)</a>:</h4>
<p>I know that at least for me that script is necessary for system stability on 1800x, but is not on 3950x</p>



<a name="207041571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041571">(Aug 15 2020 at 22:02)</a>:</h4>
<p>with iirc 4.x kernels, so maybe fixed in kernel patches or something since then</p>



<a name="207041575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041575">(Aug 15 2020 at 22:02)</a>:</h4>
<div class="codehilite"><pre><span></span><code>vendor_id       : AuthenticAMD
cpu family      : 23
model           : 1
model name      : AMD EPYC 7401P 24-Core Processor
stepping        : 2
</code></pre></div>



<a name="207041587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041587">(Aug 15 2020 at 22:03)</a>:</h4>
<p>hm I don't know what family that processor is</p>



<a name="207041598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041598">(Aug 15 2020 at 22:03)</a>:</h4>
<p>23 is 0x17 so probably this one</p>



<a name="207041601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041601">(Aug 15 2020 at 22:03)</a>:</h4>
<p>yeah so that should work</p>



<a name="207041606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041606">(Aug 15 2020 at 22:03)</a>:</h4>
<p>though the script might be ryzen-specific, not sure</p>



<a name="207041644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041644">(Aug 15 2020 at 22:04)</a>:</h4>
<p>it's definitely Zen 1</p>



<a name="207041653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041653">(Aug 15 2020 at 22:04)</a>:</h4>
<p>hm 0x17 is Zen 2 afaik</p>



<a name="207041655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041655">(Aug 15 2020 at 22:04)</a>:</h4>
<p>maybe the epyc versioning is different?</p>



<a name="207041657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041657">(Aug 15 2020 at 22:04)</a>:</h4>
<p>maybe</p>



<a name="207041667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041667">(Aug 15 2020 at 22:05)</a>:</h4>
<p>locally I see</p>
<div class="codehilite"><pre><span></span><code>vendor_id       : AuthenticAMD
cpu family      : 23
model           : 113
model name      : AMD Ryzen 9 3950X 16-Core Processor
</code></pre></div>



<a name="207041686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041686">(Aug 15 2020 at 22:05)</a>:</h4>
<p>and that's definitely not a zen 1 chip</p>



<a name="207041696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041696">(Aug 15 2020 at 22:05)</a>:</h4>
<p>it's the model then</p>



<a name="207041744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041744">(Aug 15 2020 at 22:06)</a>:</h4>
<p>hm the model is hex 0x71</p>



<a name="207041745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041745">(Aug 15 2020 at 22:06)</a>:</h4>
<p>family 23 must be all Zen</p>



<a name="207041751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041751">(Aug 15 2020 at 22:06)</a>:</h4>
<p>maybe it's... reversed?</p>



<a name="207041760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041760">(Aug 15 2020 at 22:06)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <a href="https://en.wikichip.org/wiki/amd/cpuid">https://en.wikichip.org/wiki/amd/cpuid</a></p>



<a name="207041848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041848">(Aug 15 2020 at 22:08)</a>:</h4>
<p>I can't find the PDF for 7401p epycs</p>



<a name="207041855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041855">(Aug 15 2020 at 22:08)</a>:</h4>
<p>I always struggle on AMDs website though</p>



<a name="207041883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041883">(Aug 15 2020 at 22:09)</a>:</h4>
<p>do you know if you have revision b1 or b0?</p>



<a name="207041928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207041928">(Aug 15 2020 at 22:10)</a>:</h4>
<p>I found this <a href="https://developer.amd.com/resources/epyc-resources/epyc-specifications/">https://developer.amd.com/resources/epyc-resources/epyc-specifications/</a></p>



<a name="207042011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042011">(Aug 15 2020 at 22:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> there's one revision per model, no?</p>



<a name="207042015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042015">(Aug 15 2020 at 22:12)</a>:</h4>
<p>hm not sure</p>



<a name="207042040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042040">(Aug 15 2020 at 22:13)</a>:</h4>
<p>Model 31h is Zen 2 EPYC</p>



<a name="207042042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042042">(Aug 15 2020 at 22:13)</a>:</h4>
<p>this should be the manual for mine <a href="http://developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf">http://developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf</a></p>



<a name="207042121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042121">(Aug 15 2020 at 22:14)</a>:</h4>
<p>I think you want the revision guide</p>



<a name="207042123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042123">(Aug 15 2020 at 22:14)</a>:</h4>
<p>wait this lists it as B2 lol <a href="https://en.wikichip.org/wiki/amd/epyc/7401p">https://en.wikichip.org/wiki/amd/epyc/7401p</a></p>



<a name="207042220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042220">(Aug 15 2020 at 22:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> oh wait, "stepping: 2" -&gt; B2</p>



<a name="207042276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042276">(Aug 15 2020 at 22:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> 1054 has "No fix planned" for all 3 columns <a href="https://developer.amd.com/wp-content/resources/55449_1.16.pdf#page=13">https://developer.amd.com/wp-content/resources/55449_1.16.pdf#page=13</a></p>



<a name="207042401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042401">(Aug 15 2020 at 22:22)</a>:</h4>
<p>yeah, though I imagine disabling c6 would do it</p>



<a name="207042405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042405">(Aug 15 2020 at 22:22)</a>:</h4>
<p>maybe the script I gave you earlier will do it though, not sure</p>



<a name="207042816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042816">(Aug 15 2020 at 22:34)</a>:</h4>
<p>so this is <code>expand_crate</code> (the 63 runs I have of it that are all 5-digit PIDs): <a href="/user_uploads/4715/nQJADqKSSWG0llmeTALX6lRR/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/nQJADqKSSWG0llmeTALX6lRR/image.png" title="image.png"><img src="/user_uploads/4715/nQJADqKSSWG0llmeTALX6lRR/image.png"></a></div>



<a name="207042891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042891">(Aug 15 2020 at 22:36)</a>:</h4>
<p>I was hoping it would look like this, as opposed to just being uniformly distributed</p>



<a name="207042918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207042918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207042918">(Aug 15 2020 at 22:37)</a>:</h4>
<p>presumably we can have more functions profiled to get a better idea where in macro expansion the noise is introduced. it shouldn't be a big deal to wrap all IO in profiling etc.</p>



<a name="207043188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207043188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207043188">(Aug 15 2020 at 22:45)</a>:</h4>
<p>this is <code>is_mir_available</code>, which has one of the lowest non-0 total variance out of all the queries (it's one value, or +1, or even rarer, +2): <a href="/user_uploads/4715/y3vffg3omXTASQjvbxRiA6pD/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/y3vffg3omXTASQjvbxRiA6pD/image.png" title="image.png"><img src="/user_uploads/4715/y3vffg3omXTASQjvbxRiA6pD/image.png"></a></div>



<a name="207043311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207043311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207043311">(Aug 15 2020 at 22:48)</a>:</h4>
<p>I'm finding similar things elsewhere. hmpf. so it definitely looks like there could be hardware issues. I wish <code>summarize</code> told me how many direct child events there are, and total descendent events, because I suspect the variance in many cases is proportional to the number of <code>rdpmc</code> inside. maybe I should look at "total time" instead of "self time", because it shouldn't have this problem, hmm</p>



<a name="207043468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207043468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207043468">(Aug 15 2020 at 22:53)</a>:</h4>
<p>per-query "total time" is worse than "self time", huh. how? this seems like it would imply the "child/descendant noise" cancels out? either that or <code>summarize</code> does something I wouldn't expect, with the data</p>



<a name="207043681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207043681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207043681">(Aug 15 2020 at 22:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> lol no wonder <code>drop_ast</code> is weird <a href="https://github.com/rust-lang/rust/commit/8ec687611b070be1e143f8ed038ea9ea871a0935">https://github.com/rust-lang/rust/commit/8ec687611b070be1e143f8ed038ea9ea871a0935</a></p>



<a name="207043691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207043691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207043691">(Aug 15 2020 at 22:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> you can disable c6 in bios too, as a more permanent solution.</p>



<a name="207043776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207043776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207043776">(Aug 15 2020 at 23:01)</a>:</h4>
<p>7xx1 is 1st gen ryzen.</p>



<a name="207043890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207043890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207043890">(Aug 15 2020 at 23:04)</a>:</h4>
<p><span class="user-mention" data-user-id="281572">@marmeladema</span> not sure if you're around: <a href="https://github.com/rust-lang/rust/pull/72882#discussion_r471042204">https://github.com/rust-lang/rust/pull/72882#discussion_r471042204</a></p>



<a name="207043906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207043906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207043906">(Aug 15 2020 at 23:04)</a>:</h4>
<p>I probably don't even need to fix it for now, just remember that it will look like <code>analysis</code></p>



<a name="207044013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044013">(Aug 15 2020 at 23:07)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> okay I might be onto something: there's a lot of variance on queries that execute once, but call a lot of other queries (e.g. a loop over every definition in the crate). this is significant because there's sampling points on every single call from, and return to, that loop, and if either I haven't fully serialized <code>rdpmc</code>, or there's weird hardware issues, that will add up and contribute to the uncertainty of "loop vs callees"</p>



<a name="207044059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044059">(Aug 15 2020 at 23:08)</a>:</h4>
<p>overall I think I have more data than I know what to do with, and I should start upstreaming all this work before I get too distracted</p>



<a name="207044068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044068">(Aug 15 2020 at 23:09)</a>:</h4>
<p>wouldn't that just be from variances from the individual queries adding up?</p>



<a name="207044072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044072">(Aug 15 2020 at 23:09)</a>:</h4>
<p>but big <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span> to upstreaming</p>



<a name="207044073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044073">(Aug 15 2020 at 23:09)</a>:</h4>
<p>but then the self time would not vary at all, since it's doing something very simple</p>



<a name="207044083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044083">(Aug 15 2020 at 23:09)</a>:</h4>
<p>well, not "time" , but instruction count</p>



<a name="207044122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044122">(Aug 15 2020 at 23:10)</a>:</h4>
<p>hm but we compute self time by subtracting out, no?</p>



<a name="207044138"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044138" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044138">(Aug 15 2020 at 23:11)</a>:</h4>
<p>if sampling is perfect, then you can perfectly subtract something noisy from something that only has the noise from that inner thing and... I need to retry this sentence lol</p>



<a name="207044141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044141">(Aug 15 2020 at 23:11)</a>:</h4>
<p>so if "true" total count is, say, 100, and then that consists of 10 queries which are 10 +/- 5 then the total count would have a variance of +/- 50, if I'm recalling my math right</p>



<a name="207044188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044188">(Aug 15 2020 at 23:12)</a>:</h4>
<p>for two loop elements, <code>a</code> and <code>b</code>, you have <code>x + a + y + b + z</code></p>



<a name="207044193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044193">(Aug 15 2020 at 23:12)</a>:</h4>
<p>with perfect sampling, <code>(x + a + y + b + z) - a - b = (x + y + z)</code></p>



<a name="207044198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marmeladema <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044198">(Aug 15 2020 at 23:12)</a>:</h4>
<p>Hello! I'll take a look at your comment asap <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="207044204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044204">(Aug 15 2020 at 23:13)</a>:</h4>
<p>(it's not urgent, don't worry!)</p>



<a name="207044207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044207">(Aug 15 2020 at 23:13)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> if <code>x</code>, <code>y</code> and <code>z</code> are perfectly deterministic (as most loops in rustc should be), we get to eliminate the noise entirely</p>



<a name="207044213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044213">(Aug 15 2020 at 23:13)</a>:</h4>
<p>like it doesn't matter what <code>a</code> an <code>b</code> are, we can just subtract them out</p>



<a name="207044218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044218">(Aug 15 2020 at 23:13)</a>:</h4>
<p>hmm okay yeah that makes sense</p>



<a name="207044219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044219">(Aug 15 2020 at 23:13)</a>:</h4>
<p>we subtract within each run, not across them, which is why this works at all</p>



<a name="207044222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marmeladema <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044222">(Aug 15 2020 at 23:13)</a>:</h4>
<p>It seems relatively easy to add {} around those 2 lines :P I can take care of it</p>



<a name="207044382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044382">(Aug 15 2020 at 23:17)</a>:</h4>
<p>hmm, you know what, just to satisfy my curiosity, I'll try <code>cpuid</code>, in case neither <code>mfence</code> nor <code>lfence</code> fully serialize (e.g. maybe they only serialize memory instructions but not register-only ones)</p>



<a name="207044610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044610">(Aug 15 2020 at 23:23)</a>:</h4>
<p>I believe none of the x86 fences flush the pipeline.</p>



<a name="207044663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> marmeladema <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044663">(Aug 15 2020 at 23:24)</a>:</h4>
<p>I think this should fix it: <a href="https://github.com/rust-lang/rust/pull/75575">https://github.com/rust-lang/rust/pull/75575</a></p>



<a name="207044677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044677">(Aug 15 2020 at 23:25)</a>:</h4>
<p>thanks!</p>



<a name="207044732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044732">(Aug 15 2020 at 23:27)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> what amount of variation are you dealing with here? in orders of 10?</p>



<a name="207044782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044782">(Aug 15 2020 at 23:28)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> it could be as low as ±1 instruction per <code>rdpmc</code>, and could still add up to what I'm seeing</p>



<a name="207044790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044790">(Aug 15 2020 at 23:28)</a>:</h4>
<p>IIRC without cpuid the only other way to serialize the pipeline is to load/store certain MSRs that have other side effects (like e.g. storing a different TLB)</p>



<a name="207044911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207044911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207044911">(Aug 15 2020 at 23:33)</a>:</h4>
<p>I'll attempt with this now: <a href="https://godbolt.org/z/aeebT3">https://godbolt.org/z/aeebT3</a></p>



<a name="207045416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207045416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207045416">(Aug 15 2020 at 23:50)</a>:</h4>
<p>huh in practice that's 6 extra instructions compared to just a lone <code>rdpmc</code>, presumably the clobbering leads to more instructions around it?</p>



<a name="207049504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207049504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207049504">(Aug 16 2020 at 01:59)</a>:</h4>
<p><code>cpuid</code> looks like it's similar to <code>mfence</code> (which was worse than <code>lfence</code>), <em>at best</em>, but a lot of the time it's noisier. it even seems to introduce extra variance in the process total which... shouldn't be possible, should it?</p>



<a name="207049577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207049577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207049577">(Aug 16 2020 at 02:02)</a>:</h4>
<p>either I have more methodology issues or it's worse</p>



<a name="207051232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051232">(Aug 16 2020 at 02:46)</a>:</h4>
<p>huh, 8 of the 10 runs I have collected on my laptop (with the <code>lfence</code> variant) have total instructions vary by ±342 (as opposed to being in the 5000-8000 range)</p>



<a name="207051562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051562">(Aug 16 2020 at 02:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> welp, it has much less variance on my laptop Q_Q</p>



<a name="207051612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051612">(Aug 16 2020 at 03:00)</a>:</h4>
<p>If there's simpleish tests I'd be happy to queue them up manually on the collector</p>



<a name="207051618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051618">(Aug 16 2020 at 03:01)</a>:</h4>
<p>the problem is getting the exact version of rustc I'm using</p>



<a name="207051625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051625">(Aug 16 2020 at 03:01)</a>:</h4>
<p>without opening a Rust PR :P</p>



<a name="207051670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051670">(Aug 16 2020 at 03:02)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> wait, what if I gave you a zip?</p>



<a name="207051672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051672">(Aug 16 2020 at 03:02)</a>:</h4>
<p>of a working sysroot</p>



<a name="207051676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051676">(Aug 16 2020 at 03:02)</a>:</h4>
<p>I think I can de-NixOS-ify it in a couple commands</p>



<a name="207051677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051677">(Aug 16 2020 at 03:02)</a>:</h4>
<p>Yeah that seems fine. I won't be able to run things until tomorrow</p>



<a name="207051680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051680">(Aug 16 2020 at 03:03)</a>:</h4>
<p>ah then I might as well go to sleep then</p>



<a name="207051684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051684">(Aug 16 2020 at 03:03)</a>:</h4>
<p>I should try <code>cpuid</code> again now</p>



<a name="207051687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207051687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207051687">(Aug 16 2020 at 03:03)</a>:</h4>
<p>and just also gather more runs in case this is a weird fluke</p>



<a name="207054729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207054729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207054729">(Aug 16 2020 at 04:41)</a>:</h4>
<p>uhh <code>cpuid</code> seems to work great on my X230, better than <code>lfence</code> actually, although I might be accidentally cherry-picking the data, I need to take a closer look at it after I sleep</p>



<a name="207054900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207054900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207054900">(Aug 16 2020 at 04:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so <span class="user-mention" data-user-id="310399">@Mara</span> found this, which is fascinating <a href="https://stackoverflow.com/questions/51844886/is-lfence-serializing-on-amd-processors/51848609#51848609">https://stackoverflow.com/questions/51844886/is-lfence-serializing-on-amd-processors/51848609#51848609</a></p>



<a name="207055085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207055085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207055085">(Aug 16 2020 at 04:52)</a>:</h4>
<p>the kernel setting that bit must be why it's useful on the server. I suspect my laptop doesn't even need a serializing instruction as much as the server, since I doubt <code>lfence</code> does anything useful here on an Ivy Bridge</p>



<a name="207091491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091491">(Aug 16 2020 at 21:44)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> oh I promised I'd get you binaries, didn't I?</p>



<a name="207091495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091495">(Aug 16 2020 at 21:44)</a>:</h4>
<p><span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>



<a name="207091496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091496">(Aug 16 2020 at 21:44)</a>:</h4>
<p>sure yeah, I can run some</p>



<a name="207091498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091498">(Aug 16 2020 at 21:44)</a>:</h4>
<p>I think we're on 18.04 ubuntu fwiw</p>



<a name="207091509"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091509" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091509">(Aug 16 2020 at 21:45)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> what's a normal INTERP on linux? e.g. <code>ldd $(which echo) | tail -n1</code></p>



<a name="207091580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091580">(Aug 16 2020 at 21:47)</a>:</h4>
<p>/lib64/ld-linux-x86-64.so.2</p>



<a name="207091834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091834">(Aug 16 2020 at 21:55)</a>:</h4>
<p>thanks</p>



<a name="207091838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091838">(Aug 16 2020 at 21:55)</a>:</h4>
<p>ugh, xz compression is incredibly slow</p>



<a name="207091899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091899">(Aug 16 2020 at 21:57)</a>:</h4>
<p>and gzip barely does anything :|</p>



<a name="207091949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207091949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207091949">(Aug 16 2020 at 21:59)</a>:</h4>
<p>or maybe it wasn't compressing at all</p>



<a name="207092003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092003">(Aug 16 2020 at 22:00)</a>:</h4>
<p>I'm silly, I should be doing this on the server</p>



<a name="207092045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092045">(Aug 16 2020 at 22:01)</a>:</h4>
<p>the smart thing to do would've been to keep copies of the builds there, not on my laptop lol</p>



<a name="207092500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092500">(Aug 16 2020 at 22:15)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <a href="http://build.lyken.rs/~eddy/rdpmc-self-contained.tar.xz">http://build.lyken.rs/~eddy/rdpmc-self-contained.tar.xz</a></p>



<a name="207092504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092504">(Aug 16 2020 at 22:15)</a>:</h4>
<p>~500MB compressed down to ~100MB courtesy of xz's most extreme settings</p>



<a name="207092564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092564">(Aug 16 2020 at 22:16)</a>:</h4>
<p>downloaded</p>



<a name="207092567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092567">(Aug 16 2020 at 22:16)</a>:</h4>
<p>what should I run?</p>



<a name="207092577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092577">(Aug 16 2020 at 22:16)</a>:</h4>
<p>you should be able to run the scripts as many times as you'd like</p>



<a name="207092584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092584">(Aug 16 2020 at 22:17)</a>:</h4>
<p>hmm</p>
<p>cpuid-sysroot/bin/rustc: /lib/x86_64-linux-gnu/libm.so.6: version `GLIBC_2.29' not found (required by /home/simulacrum/rdpmc-self-contained/cpuid-sysroot/bin/../lib/librustc_driver-9d0ee5e443b15ab2.so)</p>



<a name="207092587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092587">(Aug 16 2020 at 22:17)</a>:</h4>
<p>ten of each is like the minimum I'd normally do</p>



<a name="207092588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092588">(Aug 16 2020 at 22:17)</a>:</h4>
<p>I was afraid of that</p>



<a name="207092589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092589">(Aug 16 2020 at 22:17)</a>:</h4>
<p>oh goddammit</p>



<a name="207092597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092597">(Aug 16 2020 at 22:17)</a>:</h4>
<p>I think I have 2.30 installed</p>



<a name="207092600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092600">(Aug 16 2020 at 22:17)</a>:</h4>
<p>wait you have <em>newer</em>? that should work, no?</p>



<a name="207092601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092601">(Aug 16 2020 at 22:17)</a>:</h4>
<p>at least GNU objdump (GNU Binutils for Ubuntu) 2.30</p>



<a name="207092604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092604">(Aug 16 2020 at 22:17)</a>:</h4>
<p>yeah.</p>



<a name="207092606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092606">(Aug 16 2020 at 22:18)</a>:</h4>
<p>maybe that's not the right way to get that version?</p>



<a name="207092644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092644">(Aug 16 2020 at 22:18)</a>:</h4>
<p>that's binutils, not glibc</p>



<a name="207092649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092649">(Aug 16 2020 at 22:18)</a>:</h4>
<p>ah gah</p>



<a name="207092651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092651">(Aug 16 2020 at 22:18)</a>:</h4>
<p>you can execute <code>/lib/x86_64-linux-gnu/libc.so.6</code> to check glibc version</p>



<a name="207092652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092652">(Aug 16 2020 at 22:18)</a>:</h4>
<p>GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1.2) stable release version 2.27.</p>



<a name="207092654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092654">(Aug 16 2020 at 22:18)</a>:</h4>
<p>thanks!</p>



<a name="207092659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092659">(Aug 16 2020 at 22:19)</a>:</h4>
<p>I wonder what it'd take to patch that out</p>



<a name="207092665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092665">(Aug 16 2020 at 22:19)</a>:</h4>
<p>fairly difficult, sadly. It'd be easier/take less time for you to compile whatever you did in an older stdenv.</p>



<a name="207092716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092716">(Aug 16 2020 at 22:20)</a>:</h4>
<p>we were trying to avoid that lol</p>



<a name="207092721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092721">(Aug 16 2020 at 22:20)</a>:</h4>
<p>you could _also_ ship the whole nix closure.</p>



<a name="207092722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092722">(Aug 16 2020 at 22:20)</a>:</h4>
<p>I guess maybe I can run in docker or something? seems annoying</p>



<a name="207092724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092724">(Aug 16 2020 at 22:21)</a>:</h4>
<p>or get nix make, yeah, a docker image</p>



<a name="207092735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092735">(Aug 16 2020 at 22:21)</a>:</h4>
<p>we should just compile rustc against musl</p>



<a name="207092738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092738">(Aug 16 2020 at 22:21)</a>:</h4>
<p>completely self-contained</p>



<a name="207092780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092780">(Aug 16 2020 at 22:22)</a>:</h4>
<p><a href="https://nixos.org/nixpkgs/manual/#sec-pkgs-dockerTools">https://nixos.org/nixpkgs/manual/#sec-pkgs-dockerTools</a> if you wanted to attempt docker image generation</p>



<a name="207092782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092782">(Aug 16 2020 at 22:22)</a>:</h4>
<p>trying docker now</p>



<a name="207092783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092783">(Aug 16 2020 at 22:22)</a>:</h4>
<p>I mean <span class="user-mention" data-user-id="116122">@simulacrum</span> is not on NixOS and I'm not sending a docker image over lol</p>



<a name="207092784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092784">(Aug 16 2020 at 22:22)</a>:</h4>
<p>err</p>



<a name="207092786"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092786" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092786">(Aug 16 2020 at 22:22)</a>:</h4>
<p>well I mean I have it installed</p>



<a name="207092804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092804">(Aug 16 2020 at 22:23)</a>:</h4>
<p>I meant you're not on NixOS and you're the one who has to run docker</p>



<a name="207092812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092812">(Aug 16 2020 at 22:23)</a>:</h4>
<p>managed to run it</p>



<a name="207092823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092823">(Aug 16 2020 at 22:23)</a>:</h4>
<p>so I can stop looking at ELF headers :P</p>



<a name="207092869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092869">(Aug 16 2020 at 22:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207092783">said</a>:</p>
<blockquote>
<p>I mean <span class="user-mention silent" data-user-id="116122">simulacrum</span> is not on NixOS and I'm not sending a docker image over lol</p>
</blockquote>
<p>eh, I mean it spits out a tarball at you anyway, so you just <code>nix-build &amp;&amp; xz -9 result</code> and upload much the same way you did above.</p>



<a name="207092871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092871">(Aug 16 2020 at 22:24)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> btw beware that this is still sensitive to the PID length so uhhh keep only runs with the same PID length whoops</p>



<a name="207092874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092874">(Aug 16 2020 at 22:24)</a>:</h4>
<p>hmm</p>



<a name="207092875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092875">(Aug 16 2020 at 22:24)</a>:</h4>
<p>I could've patched this, but I didn't think much through it</p>



<a name="207092876"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092876" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092876">(Aug 16 2020 at 22:24)</a>:</h4>
<p>does that get spit out anywhere?</p>



<a name="207092877"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092877" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092877">(Aug 16 2020 at 22:25)</a>:</h4>
<p>assuming it actually prints anything</p>



<a name="207092883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092883">(Aug 16 2020 at 22:25)</a>:</h4>
<p>if you don't get any stderr output, it's broken</p>



<a name="207092886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092886">(Aug 16 2020 at 22:25)</a>:</h4>
<p>no I am</p>



<a name="207092888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092888">(Aug 16 2020 at 22:25)</a>:</h4>
<p>the PID is on that line</p>



<a name="207092889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092889">(Aug 16 2020 at 22:25)</a>:</h4>
<p>so far, with <a href="http://cpuid-test.sh">cpuid-test.sh</a>:</p>
<div class="codehilite"><pre><span></span><code>core-19 instructions:u=43525734060
core-25 instructions:u=43525741970
core-31 instructions:u=43525735298
core-37 instructions:u=43525737872
core-43 instructions:u=43525737524
core-49 instructions:u=43525739793
core-55 instructions:u=43525739084
</code></pre></div>



<a name="207092892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092892">(Aug 16 2020 at 22:25)</a>:</h4>
<p>lmao you have 2-digit PIDs</p>



<a name="207092898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092898">(Aug 16 2020 at 22:25)</a>:</h4>
<p>well it is in docker</p>



<a name="207092906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092906">(Aug 16 2020 at 22:25)</a>:</h4>
<p>I don't think I've ever come across any. oh that makes sense</p>



<a name="207092909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092909">(Aug 16 2020 at 22:25)</a>:</h4>
<div class="codehilite"><pre><span></span><code>core-19 instructions:u=43525734060
core-25 instructions:u=43525741970
core-31 instructions:u=43525735298
core-37 instructions:u=43525737872
core-43 instructions:u=43525737524
core-49 instructions:u=43525739793
core-55 instructions:u=43525739084
core-61 instructions:u=43525742087
core-67 instructions:u=43525737148
core-73 instructions:u=43525735965
</code></pre></div>



<a name="207092962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092962">(Aug 16 2020 at 22:26)</a>:</h4>
<p>it probably doesn't matter which length it is as long as we don't compare across different PID lengths</p>



<a name="207092963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092963">(Aug 16 2020 at 22:26)</a>:</h4>
<p>gah I guess we need to redo it in the 100s</p>



<a name="207092968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092968">(Aug 16 2020 at 22:27)</a>:</h4>
<p>oh you crossed over?</p>



<a name="207092971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092971">(Aug 16 2020 at 22:27)</a>:</h4>
<p>yeah, on lfence</p>



<a name="207092976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092976">(Aug 16 2020 at 22:27)</a>:</h4>
<p>I use up 6 pids every run</p>



<a name="207092978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092978">(Aug 16 2020 at 22:27)</a>:</h4>
<p>fascinating</p>



<a name="207092980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092980">(Aug 16 2020 at 22:27)</a>:</h4>
<p>I never saw a proper colleration because this is a multi-purpose server</p>



<a name="207092982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092982">(Aug 16 2020 at 22:27)</a>:</h4>
<p>so actually I need to get into the thousands I guess until I can fit both lfence and cpuid in same length</p>



<a name="207092988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207092988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207092988">(Aug 16 2020 at 22:28)</a>:</h4>
<p>*correlation (wtf eddy)</p>



<a name="207093025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093025">(Aug 16 2020 at 22:28)</a>:</h4>
<p>ughhh just run some short thing in a loop</p>



<a name="207093027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093027">(Aug 16 2020 at 22:28)</a>:</h4>
<p>I should've just fixed this</p>



<a name="207093033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093033">(Aug 16 2020 at 22:29)</a>:</h4>
<p>anyway get 10 of each or w/e and then <code>summarize summarize --json *.events</code></p>



<a name="207093085"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093085" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093085">(Aug 16 2020 at 22:30)</a>:</h4>
<p>I need to run summarize in between, right? Not after 20?</p>



<a name="207093092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093092">(Aug 16 2020 at 22:30)</a>:</h4>
<p>actually that will take forever so make sure you only run it for relevant files. also you can probably copy the summarize binary instead of building it inside the docker environment</p>



<a name="207093093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093093">(Aug 16 2020 at 22:30)</a>:</h4>
<p>you can run it whenever you want</p>



<a name="207093094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093094">(Aug 16 2020 at 22:30)</a>:</h4>
<p>the files aren't going away</p>



<a name="207093101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093101">(Aug 16 2020 at 22:30)</a>:</h4>
<p>I'm a bit confused tbh what exactly I'm aiming for with the summarze</p>



<a name="207093105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093105">(Aug 16 2020 at 22:31)</a>:</h4>
<p>getting the JSON output so we can look at it</p>



<a name="207093108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093108">(Aug 16 2020 at 22:31)</a>:</h4>
<p>but I thought it only accepted one event file?</p>



<a name="207093109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093109">(Aug 16 2020 at 22:31)</a>:</h4>
<p>like I can give you a <code>jq</code> command that will combine 10 files into a report of sorts</p>



<a name="207093113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093113">(Aug 16 2020 at 22:31)</a>:</h4>
<p>aaah sorry</p>



<a name="207093115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093115">(Aug 16 2020 at 22:31)</a>:</h4>
<p><code>echo core-*.events | xargs -n1 summarize summarize --json</code></p>



<a name="207093116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093116">(Aug 16 2020 at 22:31)</a>:</h4>
<p>I forgot I have to do that</p>



<a name="207093159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093159">(Aug 16 2020 at 22:32)</a>:</h4>
<p>(replace the <code>*</code> with <code>{123,456,...}</code> if you have too many files that you don't want to waste time on)</p>



<a name="207093161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093161">(Aug 16 2020 at 22:32)</a>:</h4>
<p>okay well we'll be in the 10000s because my loop was faster than expected (once I fixed the fact that echo is a bash primitive)</p>



<a name="207093167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093167">(Aug 16 2020 at 22:32)</a>:</h4>
<p>that's fine, 5-digit is my most common</p>



<a name="207093172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093172">(Aug 16 2020 at 22:33)</a>:</h4>
<p>presumably because there are only 27k or so 6-digit PIDs (not sure why they seem to be 17-bit?)</p>



<a name="207093177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093177">(Aug 16 2020 at 22:33)</a>:</h4>
<p>okay, so to double check:</p>
<ul>
<li>run <a href="http://lfence-test.sh">lfence-test.sh</a> 10 times</li>
<li>grab summarize output, with <code>echo core-*.events | xargs -n1 summarize summarize --json</code>, pasting that into some gist or whatever</li>
<li>run <a href="http://cpuid-test.sh">cpuid-test.sh</a> 10 times</li>
<li>repeat summarize</li>
</ul>



<a name="207093214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093214">(Aug 16 2020 at 22:34)</a>:</h4>
<p>you can do all the summarize and analysis after you run all 20</p>



<a name="207093217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093217">(Aug 16 2020 at 22:34)</a>:</h4>
<p>it's easier that way IME</p>



<a name="207093221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093221">(Aug 16 2020 at 22:34)</a>:</h4>
<p>actually I can just give you the commands to run if you give me each of the 10 outputs</p>



<a name="207093222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093222">(Aug 16 2020 at 22:34)</a>:</h4>
<p>hm but don't we want it for each? I thought we were comparing the two?</p>



<a name="207093229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093229">(Aug 16 2020 at 22:34)</a>:</h4>
<p>I can just upload another tarball of the raw event files too</p>



<a name="207093234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093234">(Aug 16 2020 at 22:35)</a>:</h4>
<p>it's a waste of time, I have no way to analyze them beyond what's in the JSONs</p>



<a name="207093242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093242">(Aug 16 2020 at 22:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> okay so maybe I should give you an example of my process</p>



<a name="207093285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093285">(Aug 16 2020 at 22:36)</a>:</h4>
<p>I format the PIDs into the bracket notation, then:<br>
<code>echo core-{14168,14298,14482,14614,14722,14880,15012,15209,15324,15455} | xargs -n1 summarize summarize --json</code><br>
after which I can run a series of jq commands on the JSON files</p>



<a name="207093305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093305">(Aug 16 2020 at 22:37)</a>:</h4>
<p><code>cat core-{14168,14298,14482,14614,14722,14880,15012,15209,15324,15455}.json | jq -Cs 'map(.query_data) | transpose | map({key: .[0].label, count: .[0].invocation_count, values: map(.self_time | (.secs*1e9+.nanos))}) | map(.+{variance: (.count as $count | .values | map(./$count) | ((max-min)/2))}) | sort_by(.variance) | reverse | map(.+{value: .variance}) | from_entries' | less</code></p>



<a name="207093307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093307">(Aug 16 2020 at 22:37)</a>:</h4>
<p>something like this</p>



<a name="207093420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093420">(Aug 16 2020 at 22:40)</a>:</h4>
<p>okay I have jq output, let me stick it in a gist</p>



<a name="207093425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093425">(Aug 16 2020 at 22:41)</a>:</h4>
<p>hm okay how do I disable color?!</p>



<a name="207093428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093428">(Aug 16 2020 at 22:41)</a>:</h4>
<p>trying -M</p>



<a name="207093481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093481">(Aug 16 2020 at 22:42)</a>:</h4>
<p><a href="https://gist.github.com/Mark-Simulacrum/51fc69dbd07af72a1d403e3b0d0eabfa">https://gist.github.com/Mark-Simulacrum/51fc69dbd07af72a1d403e3b0d0eabfa</a></p>



<a name="207093500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093500">(Aug 16 2020 at 22:43)</a>:</h4>
<p>cpuid:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;expand_crate&quot;</span><span class="p">:</span> <span class="mi">911</span><span class="p">,</span>
  <span class="nt">&quot;free_global_ctxt&quot;</span><span class="p">:</span> <span class="mf">696.5</span><span class="p">,</span>
  <span class="nt">&quot;drop_ast&quot;</span><span class="p">:</span> <span class="mf">652.5</span><span class="p">,</span>
  <span class="nt">&quot;hir_lowering&quot;</span><span class="p">:</span> <span class="mi">417</span><span class="p">,</span>
  <span class="nt">&quot;build_hir_map&quot;</span><span class="p">:</span> <span class="mi">242</span><span class="p">,</span>
  <span class="nt">&quot;generate_crate_metadata&quot;</span><span class="p">:</span> <span class="mf">185.5</span><span class="p">,</span>
  <span class="nt">&quot;AST_validation&quot;</span><span class="p">:</span> <span class="mi">182</span><span class="p">,</span>
  <span class="nt">&quot;setup_global_ctxt&quot;</span><span class="p">:</span> <span class="mf">169.5</span><span class="p">,</span>
  <span class="nt">&quot;resolve_crate&quot;</span><span class="p">:</span> <span class="mi">164</span><span class="p">,</span>
  <span class="nt">&quot;resolve_lifetimes&quot;</span><span class="p">:</span> <span class="mi">94</span><span class="p">,</span>
  <span class="nt">&quot;analysis&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>
  <span class="nt">&quot;privacy_access_levels&quot;</span><span class="p">:</span> <span class="mf">21.5</span><span class="p">,</span>
  <span class="nt">&quot;self_profile_alloc_query_strings&quot;</span><span class="p">:</span> <span class="mi">21</span>
<span class="p">}</span>
</code></pre></div>


<p>lfence:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;generate_crate_metadata&quot;</span><span class="p">:</span> <span class="mi">130243</span><span class="p">,</span>
  <span class="nt">&quot;death_checking&quot;</span><span class="p">:</span> <span class="mi">51652</span><span class="p">,</span>
  <span class="nt">&quot;wf_checking&quot;</span><span class="p">:</span> <span class="mf">29166.5</span><span class="p">,</span>
  <span class="nt">&quot;crate_lints&quot;</span><span class="p">:</span> <span class="mi">27651</span><span class="p">,</span>
  <span class="nt">&quot;typeck_item_bodies&quot;</span><span class="p">:</span> <span class="mf">18083.5</span><span class="p">,</span>
  <span class="nt">&quot;match_checking&quot;</span><span class="p">:</span> <span class="mf">13480.5</span><span class="p">,</span>
  <span class="nt">&quot;privacy_access_levels&quot;</span><span class="p">:</span> <span class="mf">10645.5</span><span class="p">,</span>
  <span class="nt">&quot;MIR_effect_checking&quot;</span><span class="p">:</span> <span class="mi">6678</span><span class="p">,</span>
  <span class="nt">&quot;type_check_crate&quot;</span><span class="p">:</span> <span class="mf">6337.5</span><span class="p">,</span>
  <span class="nt">&quot;analysis&quot;</span><span class="p">:</span> <span class="mf">6011.5</span><span class="p">,</span>
  <span class="nt">&quot;resolve_lifetimes&quot;</span><span class="p">:</span> <span class="mi">5045</span><span class="p">,</span>
  <span class="nt">&quot;check_private_in_public&quot;</span><span class="p">:</span> <span class="mf">3375.5</span><span class="p">,</span>
  <span class="nt">&quot;inferred_outlives_crate&quot;</span><span class="p">:</span> <span class="mf">2848.5</span><span class="p">,</span>
  <span class="nt">&quot;expand_crate&quot;</span><span class="p">:</span> <span class="mi">1087</span><span class="p">,</span>
  <span class="nt">&quot;crate_inherent_impls_overlap_check&quot;</span><span class="p">:</span> <span class="mf">899.5</span><span class="p">,</span>
  <span class="nt">&quot;module_lints&quot;</span><span class="p">:</span> <span class="mf">681.5</span><span class="p">,</span>
</code></pre></div>



<a name="207093502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093502">(Aug 16 2020 at 22:43)</a>:</h4>
<p>seems like definitely cpuid</p>



<a name="207093504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093504">(Aug 16 2020 at 22:43)</a>:</h4>
<p>oops the color is from <code>-C</code>, since I view them with less</p>



<a name="207093516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093516">(Aug 16 2020 at 22:43)</a>:</h4>
<p>oh and my <code>$LESS</code> contains <code>R</code>, oops I forgot <code>less</code> has bad defaults</p>



<a name="207093577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093577">(Aug 16 2020 at 22:44)</a>:</h4>
<p>wow that <code>lfence</code> output is much worse than any of mine, can you show me the 10 and 10 printed lines?</p>



<a name="207093580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093580">(Aug 16 2020 at 22:44)</a>:</h4>
<p>I can easy throw them into a spreadsheet etc.</p>



<a name="207093598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093598">(Aug 16 2020 at 22:45)</a>:</h4>
<div class="codehilite"><pre><span></span><code>lfence:
core-10239 instructions:u=43515148034
core-10245 instructions:u=43515151331
core-10251 instructions:u=43515155952
core-10257 instructions:u=43515149440
core-10263 instructions:u=43515150868
core-10269 instructions:u=43515160064
core-10275 instructions:u=43515155889
core-10281 instructions:u=43515154408
core-10287 instructions:u=43515163551
core-10293 instructions:u=43515155459
10239,10245,10251,10257,10263,10269,10275,10281,10287,10293

cpuid:
core-10303 instructions:u=43523480492
core-10309 instructions:u=43523491249
core-10315 instructions:u=43523486253
core-10321 instructions:u=43523481456
core-10327 instructions:u=43523484773
core-10333 instructions:u=43523486601
core-10339 instructions:u=43523495003
core-10345 instructions:u=43523482209
core-10351 instructions:u=43523500676
core-10357 instructions:u=43523482799
10303,10309,10315,10321,10327,10333,10339,10345,10351,10357
</code></pre></div>



<a name="207093652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093652">(Aug 16 2020 at 22:46)</a>:</h4>
<p>fascinating</p>



<a name="207093658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093658">(Aug 16 2020 at 22:47)</a>:</h4>
<p>the totals have less variance in lfence, but both are acceptable, so you don't have any weird outliers, at least not in the lfence data</p>



<a name="207093707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093707">(Aug 16 2020 at 22:48)</a>:</h4>
<p>I wonder if your kernel doesn't set that bit that makes lfence serializing. but even w/o lfence I had less trouble than it does here, huh</p>



<a name="207093712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093712">(Aug 16 2020 at 22:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> to see the individual values, replace <code>map(.+{value: .variance})</code> with <code>map(.+{value: .values})</code></p>



<a name="207093720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093720">(Aug 16 2020 at 22:49)</a>:</h4>
<p>(that's part of why that command is so long: keep the sorting but extract different aspects)</p>



<a name="207093767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093767">(Aug 16 2020 at 22:50)</a>:</h4>
<p>e.g. the ones from lfence's <code>generate_crate_metadata</code> might be interesting to look at</p>



<a name="207093784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093784">(Aug 16 2020 at 22:50)</a>:</h4>
<p>if they're uniformly distributed, then it's really broken. if not, that might just be an unlucky run that you can exclude to get slightly less noisy data etc.</p>



<a name="207093788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093788">(Aug 16 2020 at 22:50)</a>:</h4>
<p>but it applying to so many queries... ugh</p>



<a name="207093800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093800">(Aug 16 2020 at 22:51)</a>:</h4>
<p>lfence values <a href="https://gist.githubusercontent.com/Mark-Simulacrum/6797708b57b0ff5d3bdf10d85ab4c19d/raw/0cb0f6d6e3a8af5cabcc1b29dad05980578c9280/lfence-values.json">https://gist.githubusercontent.com/Mark-Simulacrum/6797708b57b0ff5d3bdf10d85ab4c19d/raw/0cb0f6d6e3a8af5cabcc1b29dad05980578c9280/lfence-values.json</a></p>



<a name="207093808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093808">(Aug 16 2020 at 22:51)</a>:</h4>
<p>and cpuid, in case it matters: <a href="https://gist.github.com/Mark-Simulacrum/9e84fea85a8e92fbf1894b20aa494f8e">https://gist.github.com/Mark-Simulacrum/9e84fea85a8e92fbf1894b20aa494f8e</a></p>



<a name="207093862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093862">(Aug 16 2020 at 22:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I wonder if there is actually a correlation between newer hardware and measurement noise... maybe the IPC increases lead to more instructions being counted on the wrong side of the <code>rdpmc</code>?</p>



<a name="207093875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093875">(Aug 16 2020 at 22:53)</a>:</h4>
<p>hm seems... not implausible</p>



<a name="207093955"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207093955" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207093955">(Aug 16 2020 at 22:55)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> if you re-run the first jq command, for lfence, but with 10287 (second to last) taken out of the PID list, is is still wild?</p>



<a name="207094004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094004">(Aug 16 2020 at 22:56)</a>:</h4>
<p><a href="/user_uploads/4715/p-zNnNmW3267WXypOpTMOZcV/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/p-zNnNmW3267WXypOpTMOZcV/image.png" title="image.png"><img src="/user_uploads/4715/p-zNnNmW3267WXypOpTMOZcV/image.png"></a></div>



<a name="207094007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094007">(Aug 16 2020 at 22:56)</a>:</h4>
<p>this is why I'm saying that</p>



<a name="207094010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094010">(Aug 16 2020 at 22:56)</a>:</h4>
<p>lfence head without that one:</p>
<p>{<br>
  "death_checking": 51652,<br>
  "generate_crate_metadata": 40165,<br>
  "wf_checking": 29166.5,<br>
  "typeck_item_bodies": 18083.5,<br>
  "match_checking": 13480.5,<br>
  "MIR_effect_checking": 6678,<br>
  "type_check_crate": 6055,<br>
  "analysis": 6011.5,<br>
  "resolve_lifetimes": 5038,<br>
  "crate_lints": 3721.5,</p>



<a name="207094015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094015">(Aug 16 2020 at 22:56)</a>:</h4>
<p>(the problem is that we haven't accounted for all sources of non-determinism so we could still have "bad runs")</p>



<a name="207094022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094022">(Aug 16 2020 at 22:57)</a>:</h4>
<p>okay yeah it's still really bad wow</p>



<a name="207094034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094034">(Aug 16 2020 at 22:57)</a>:</h4>
<p>your cpuid numbers are like my lfence ones, on Zen 1</p>



<a name="207094081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094081">(Aug 16 2020 at 22:58)</a>:</h4>
<p>but nowhere near as good as what I get on Ivy Bridge</p>



<a name="207094093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094093">(Aug 16 2020 at 22:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> btw feel free to get another 10 on lfence and see if the problem persists</p>



<a name="207094101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094101">(Aug 16 2020 at 22:59)</a>:</h4>
<p>that's usually what I do. but it's likely that's more or less what we'll get on that</p>



<a name="207094109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094109">(Aug 16 2020 at 22:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so is that the hardware <a href="http://perf.rust-lang.org">perf.rust-lang.org</a> collection is done on?</p>



<a name="207094200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094200">(Aug 16 2020 at 23:00)</a>:</h4>
<p>yeah</p>



<a name="207094209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094209">(Aug 16 2020 at 23:00)</a>:</h4>
<p>getting another 10 on lfence</p>



<a name="207094549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094549">(Aug 16 2020 at 23:08)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> what's this on, Ryzen 3rd gen (Zen 2)?</p>



<a name="207094560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094560">(Aug 16 2020 at 23:09)</a>:</h4>
<p>AMD Ryzen 5 3600 6-Core Processor so I think so</p>



<a name="207094568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094568">(Aug 16 2020 at 23:09)</a>:</h4>
<p>errr I meant 3rd gen yeah</p>



<a name="207094571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094571">(Aug 16 2020 at 23:09)</a>:</h4>
<p>thanks. I'll try to find someone with a recent intel</p>



<a name="207094635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094635">(Aug 16 2020 at 23:11)</a>:</h4>
<p>hm no new lfence is still just as bad</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;generate_crate_metadata&quot;: 140926.5,
  &quot;death_checking&quot;: 74773.5,
  &quot;wf_checking&quot;: 32379.5,
  &quot;crate_lints&quot;: 27772.5,
  &quot;typeck_item_bodies&quot;: 19102,
  &quot;match_checking&quot;: 11496,
  &quot;type_check_crate&quot;: 9371,
  &quot;privacy_access_levels&quot;: 8393.5,
  &quot;resolve_lifetimes&quot;: 6870.5,
  &quot;analysis&quot;: 6784.5,

core-10394 instructions:u=43515149852
core-10400 instructions:u=43515153805
core-10406 instructions:u=43515155901
core-10412 instructions:u=43515163472
core-10418 instructions:u=43515151332
core-10424 instructions:u=43515156056
core-10430 instructions:u=43515152366
core-10436 instructions:u=43515153840
core-10442 instructions:u=43515151231
core-10448 instructions:u=43515152978
</code></pre></div>



<a name="207094701"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094701" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094701">(Aug 16 2020 at 23:14)</a>:</h4>
<p>how recent of an intel do you need?</p>



<a name="207094759"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094759" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094759">(Aug 16 2020 at 23:15)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> closer to today than to 2013 :P</p>



<a name="207094761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094761">(Aug 16 2020 at 23:15)</a>:</h4>
<p>so anything from the past few years</p>



<a name="207094807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094807">(Aug 16 2020 at 23:16)</a>:</h4>
<p>like Zen 1 EPYC is 2017, anything from that era or newer should be relevant</p>



<a name="207094809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094809">(Aug 16 2020 at 23:16)</a>:</h4>
<p>I have physical access to haswell and can spin up a gcloud vm of anything that it has.</p>



<a name="207094818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094818">(Aug 16 2020 at 23:16)</a>:</h4>
<p>I'd expect haswell to be similar to my laptop, but if it has more cores it would be interesting</p>



<a name="207094825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094825">(Aug 16 2020 at 23:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> okay that's good to know so we're pretty much only left with <code>cpuid</code></p>



<a name="207094831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094831">(Aug 16 2020 at 23:17)</a>:</h4>
<p>I can check on ryzen 3950x as well I guess, but that's also a shared machine so probably noisier</p>



<a name="207094836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094836">(Aug 16 2020 at 23:17)</a>:</h4>
<p>it shouldn't be possible for it to be noisier, though?</p>



<a name="207094880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094880">(Aug 16 2020 at 23:18)</a>:</h4>
<p>except for hardware bugs and the kernel failing to perfectly stop and start the counters etc.</p>



<a name="207094884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094884">(Aug 16 2020 at 23:18)</a>:</h4>
<p>the Ivy Bridge is my laptop running a browser</p>



<a name="207094889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094889">(Aug 16 2020 at 23:18)</a>:</h4>
<p>yeah its counting instructions… this is so mind-bending too… like "eh maybe its that, no but its counting instructions… maybe its turbo? instructions. Power saving? instructions!"</p>



<a name="207094896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094896">(Aug 16 2020 at 23:19)</a>:</h4>
<p>heh yeah except for IO I'd expect to have 0 variance with ASLR disabled</p>



<a name="207094898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094898">(Aug 16 2020 at 23:19)</a>:</h4>
<p>gcloud has anything from sandy bridge to cascade lake</p>



<a name="207094908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094908">(Aug 16 2020 at 23:20)</a>:</h4>
<p>if you want to play around with this, cascade lake seems more relevant</p>



<a name="207094950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207094950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207094950">(Aug 16 2020 at 23:20)</a>:</h4>
<p>like I wonder if Intel has managed to make their CPUs as noisy as AMD, and/or if the AMD hardware bugs are relevant</p>



<a name="207095307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207095307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207095307">(Aug 16 2020 at 23:32)</a>:</h4>
<p>/me patchelfs the interp and back to nix world</p>



<a name="207095374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207095374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207095374">(Aug 16 2020 at 23:34)</a>:</h4>
<p>on 3950x:</p>
<div class="codehilite"><pre><span></span><code>$ head -n11 cpuid
{
  &quot;drop_ast&quot;: 530,
  &quot;free_global_ctxt&quot;: 438.5,
  &quot;expand_crate&quot;: 408.5,
  &quot;resolve_crate&quot;: 359,
  &quot;generate_crate_metadata&quot;: 211.5,
  &quot;build_hir_map&quot;: 194,
  &quot;resolve_lifetimes&quot;: 147.5,
  &quot;hir_lowering&quot;: 128,
  &quot;wf_checking&quot;: 119,
  &quot;AST_validation&quot;: 109,
$ head -n11 lfence
{
  &quot;wf_checking&quot;: 89191,
  &quot;generate_crate_metadata&quot;: 46524.5,
  &quot;type_check_crate&quot;: 37893,
  &quot;death_checking&quot;: 20512,
  &quot;match_checking&quot;: 14341,
  &quot;typeck_item_bodies&quot;: 13185,
  &quot;analysis&quot;: 7043,
  &quot;resolve_lifetimes&quot;: 5680.5,
  &quot;MIR_borrow_checking&quot;: 5393,
  &quot;MIR_effect_checking&quot;: 4347.5,
</code></pre></div>



<a name="207095528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207095528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207095528">(Aug 16 2020 at 23:39)</a>:</h4>
<p>on intel from 2017 (Intel(R) Xeon(R) Gold 6130 CPU @ 2.10GHz)</p>
<div class="codehilite"><pre><span></span><code>[nix-shell:~/nagisa/rdpmc-self-contained]$ for i in $(seq 1 10); do ./cpuid-test.sh ; done
core-37077 instructions:u=43387365592
core-37084 instructions:u=43387372275
core-37090 instructions:u=43387374783
core-37096 instructions:u=43387372464
core-37102 instructions:u=43387372209
core-37108 instructions:u=43387369313
core-37602 instructions:u=43387374764
core-37608 instructions:u=43387375390
core-37614 instructions:u=43387369938
core-37620 instructions:u=43387371590

[nix-shell:~/nagisa/rdpmc-self-contained]$ for i in $(seq 1 10); do ./lfence-test.sh ; done
core-37627 instructions:u=43374800757
core-38121 instructions:u=43374805328
core-38127 instructions:u=43374809346
core-38133 instructions:u=43374809580
core-38139 instructions:u=43374802446
core-38145 instructions:u=43374803511
core-38151 instructions:u=43374805686
core-38520 instructions:u=43374869667
core-38692 instructions:u=43374808695
core-38698 instructions:u=43374811197
</code></pre></div>



<a name="207095573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207095573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207095573">(Aug 16 2020 at 23:40)</a>:</h4>
<p>no idea what else I should run if anything ^^</p>



<a name="207095634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207095634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207095634">(Aug 16 2020 at 23:42)</a>:</h4>
<p>you need to install measureme tooling, then  <code>echo core-{14168,14298,14482,14614,14722,14880,15012,15209,15324,15455} | xargs -n1 summarize summarize --json</code> with the pid list from each (or just all of the files, doesn't matter) and then <code>cat core-{14168,14298,14482,14614,14722,14880,15012,15209,15324,15455}.json | jq -Cs 'map(.query_data) | transpose | map({key: .[0].label, count: .[0].invocation_count, values: map(.self_time | (.secs*1e9+.nanos))}) | map(.+{variance: (.count as $count | .values | map(./$count) | ((max-min)/2))}) | sort_by(.variance) | reverse | map(.+{value: .variance}) | from_entries' -M | head -n11</code> with pid lists for each</p>



<a name="207095887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207095887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207095887">(Aug 16 2020 at 23:51)</a>:</h4>
<p>cpuid:</p>
<div class="codehilite"><pre><span></span><code>  &quot;hir_lowering&quot;: 22187,
  &quot;expand_crate&quot;: 11248.5,
  &quot;analysis&quot;: 10441,
  &quot;AST_validation&quot;: 10172,
  &quot;early_lint_checks&quot;: 8434,
  &quot;build_hir_map&quot;: 4198,
  &quot;stability_index&quot;: 1677,
  &quot;resolve_crate&quot;: 1414.5,
  &quot;type_check_crate&quot;: 1397.5,
  &quot;proc_macro_decls_static&quot;: 1058.5,
</code></pre></div>


<p>lfence:</p>
<div class="codehilite"><pre><span></span><code>  &quot;expand_crate&quot;: 17514,
  &quot;AST_validation&quot;: 16109,
  &quot;hir_lowering&quot;: 9436,
  &quot;early_lint_checks&quot;: 5784,
  &quot;build_hir_map&quot;: 4683.5,
  &quot;free_global_ctxt&quot;: 3837.5,
  &quot;privacy_access_levels&quot;: 2545.5,
  &quot;MIR_effect_checking&quot;: 2448.5,
  &quot;type_check_crate&quot;: 2144.5,
  &quot;typeck_item_bodies&quot;: 1713.5,
</code></pre></div>



<a name="207095930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207095930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207095930">(Aug 16 2020 at 23:52)</a>:</h4>
<p>both seem equally bad to me ^^</p>



<a name="207096047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096047">(Aug 16 2020 at 23:57)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> yeah so intel looks... just bad all around?</p>



<a name="207096049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096049">(Aug 16 2020 at 23:57)</a>:</h4>
<p>in fact on intel cpuid is worse I think?</p>



<a name="207096264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096264">(Aug 17 2020 at 00:02)</a>:</h4>
<p>only on for hir_lowering at low end lfence is worse than cpuid</p>



<a name="207096267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096267">(Aug 17 2020 at 00:02)</a>:</h4>
<p>might want to aggregate those variances somehow</p>



<a name="207096270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096270">(Aug 17 2020 at 00:02)</a>:</h4>
<p>either into an average or a sum or something.</p>



<a name="207096343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096343">(Aug 17 2020 at 00:05)</a>:</h4>
<p>oh I looked wrong, misplaced the comma in expand_crate on cpuid</p>



<a name="207096463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096463">(Aug 17 2020 at 00:09)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I think it's more like "modern CPUs are worse"</p>



<a name="207096464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096464">(Aug 17 2020 at 00:09)</a>:</h4>
<p>my Ivy Bridge is better than anything newer so far</p>



<a name="207096539"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096539" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096539">(Aug 17 2020 at 00:11)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> you can try looking at lfence again without 38520 if you want, its total is way off</p>



<a name="207096591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096591">(Aug 17 2020 at 00:12)</a>:</h4>
<div class="codehilite"><pre><span></span><code>  &quot;expand_crate&quot;: 17514,
  &quot;AST_validation&quot;: 16109,
  &quot;hir_lowering&quot;: 9436,
  &quot;early_lint_checks&quot;: 5784,
  &quot;build_hir_map&quot;: 4683.5,
  &quot;resolve_crate&quot;: 1523,
  &quot;type_check_crate&quot;: 501,
  &quot;crate_variances&quot;: 218.5,
  &quot;MIR_borrow_checking&quot;: 171.5,
  &quot;MIR_effect_checking&quot;: 143,
</code></pre></div>



<a name="207096597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096597">(Aug 17 2020 at 00:12)</a>:</h4>
<p>2017 intel is older than 3950x I think, but those are two different timescales</p>



<a name="207096605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096605">(Aug 17 2020 at 00:13)</a>:</h4>
<p>isn't 3950x from 2020?</p>



<a name="207096611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096611">(Aug 17 2020 at 00:13)</a>:</h4>
<p>or maybe 2019</p>



<a name="207096612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096612">(Aug 17 2020 at 00:13)</a>:</h4>
<p>June 11, 2019 (announced)<br>
November 25, 2019 (launched)</p>



<a name="207096613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096613">(Aug 17 2020 at 00:13)</a>:</h4>
<p>I can go ahead and spawn the lake thing on gcp too, just had this broadwell(?) laying around doing nothing, so figured I could just do the test on it first.</p>



<a name="207096617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096617">(Aug 17 2020 at 00:13)</a>:</h4>
<p>sounds good. even this is already really useful, thanks!</p>



<a name="207096664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096664">(Aug 17 2020 at 00:14)</a>:</h4>
<p>it does lend credence to the idea that more modern CPUs are noisier</p>



<a name="207096675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096675">(Aug 17 2020 at 00:15)</a>:</h4>
<p>hm 3950x is less noisy though than the 2017 chip?</p>
<div class="codehilite"><pre><span></span><code>  &quot;drop_ast&quot;: 530,
  &quot;free_global_ctxt&quot;: 438.5,
  &quot;expand_crate&quot;: 408.5,
  &quot;resolve_crate&quot;: 359,
  &quot;generate_crate_metadata&quot;: 211.5,
  &quot;build_hir_map&quot;: 194,
  &quot;resolve_lifetimes&quot;: 147.5,
  &quot;hir_lowering&quot;: 128,
  &quot;wf_checking&quot;: 119,
  &quot;AST_validation&quot;: 109,
</code></pre></div>


<p>is the cpuid data from 3950x</p>



<a name="207096687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096687">(Aug 17 2020 at 00:15)</a>:</h4>
<p>and 3600 is similar:</p>
<div class="codehilite"><pre><span></span><code>  &quot;expand_crate&quot;: 911,
  &quot;free_global_ctxt&quot;: 696.5,
  &quot;drop_ast&quot;: 652.5,
  &quot;hir_lowering&quot;: 417,
  &quot;build_hir_map&quot;: 242,
  &quot;generate_crate_metadata&quot;: 185.5,
  &quot;AST_validation&quot;: 182,
  &quot;setup_global_ctxt&quot;: 169.5,
  &quot;resolve_crate&quot;: 164,
  &quot;resolve_lifetimes&quot;: 94,
  &quot;analysis&quot;: 48,
  &quot;privacy_access_levels&quot;: 21.5,
  &quot;self_profile_alloc_query_strings&quot;: 21
</code></pre></div>



<a name="207096736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096736">(Aug 17 2020 at 00:16)</a>:</h4>
<p>I think it's gotten better from Zen 1 to Zen 2 but overall worse from Ivy Bridge</p>



<a name="207096750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096750">(Aug 17 2020 at 00:17)</a>:</h4>
<p>ftr this is Ivy Bridge top 3:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;expand_crate&quot;</span><span class="p">:</span> <span class="mf">118.5</span><span class="p">,</span>
  <span class="nt">&quot;resolve_crate&quot;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
  <span class="nt">&quot;stability_index&quot;</span><span class="p">:</span> <span class="mf">18.5</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>



<a name="207096752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096752">(Aug 17 2020 at 00:17)</a>:</h4>
<p>is that some hardware you have (vs. <span class="user-mention" data-user-id="123586">@nagisa</span>'s data?)</p>



<a name="207096753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096753">(Aug 17 2020 at 00:17)</a>:</h4>
<p>it's my X230 thinkpad from 2013</p>



<a name="207096793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096793">(Aug 17 2020 at 00:18)</a>:</h4>
<p>which I didn't expect would be useful for perf measurement but if we're measuring instructions... it works surprisingly well lol</p>



<a name="207096795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096795">(Aug 17 2020 at 00:18)</a>:</h4>
<p>aha yeah, so it definitely seems like intel got way worse (and maybe better since 2017, though)</p>
<p>amd has improved from zen 1 to zen 2 and is in the 1k range</p>



<a name="207096864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096864">(Aug 17 2020 at 00:20)</a>:</h4>
<p>I'm trying to think through what we're not accounting for here. the quality of data should improve with the number of cores, right? less multithreading pressure, less chances for something weird to happen... but maybe not</p>



<a name="207096871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096871">(Aug 17 2020 at 00:21)</a>:</h4>
<p>like my laptop's Ivy Bridge i7 is actually 2C/4T (because it's a mobile part)</p>



<a name="207096874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096874">(Aug 17 2020 at 00:21)</a>:</h4>
<p>and I'm running firefox and VSCode on it</p>



<a name="207096878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096878">(Aug 17 2020 at 00:21)</a>:</h4>
<p>and yet the data is <em>really good</em></p>



<a name="207096879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096879">(Aug 17 2020 at 00:21)</a>:</h4>
<p>3950x has 16C/32T<br>
3600 has 6C/12T</p>



<a name="207096921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096921">(Aug 17 2020 at 00:22)</a>:</h4>
<p>maybe mobile parts speculate less or something?</p>



<a name="207096927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096927">(Aug 17 2020 at 00:22)</a>:</h4>
<p>oh huh I never thought about that. it's not a different uarch tho, it just has less cores to keep the power budget down</p>



<a name="207096928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096928">(Aug 17 2020 at 00:22)</a>:</h4>
<p>like I think it might be branded as i7 because of the cache size?</p>



<a name="207096937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096937">(Aug 17 2020 at 00:23)</a>:</h4>
<p>I don't know much about intel's branding</p>



<a name="207096938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207096938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207096938">(Aug 17 2020 at 00:23)</a>:</h4>
<p>but I'm not an expert at this</p>



<a name="207097013"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097013" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097013">(Aug 17 2020 at 00:24)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> hang on, Xeon Gold... could that be the redesign that Intel hasn't managed to put into its consumer line yet?</p>



<a name="207097022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097022">(Aug 17 2020 at 00:24)</a>:</h4>
<p>like that might be a newer uarch than the latest i9 or w/e lmao</p>



<a name="207097026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097026">(Aug 17 2020 at 00:24)</a>:</h4>
<p>well, more advanced</p>



<a name="207097029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097029">(Aug 17 2020 at 00:24)</a>:</h4>
<p>doubt it.</p>



<a name="207097039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097039">(Aug 17 2020 at 00:25)</a>:</h4>
<p>I was looking at this like a month or two ago and IIRC because of the fab issues with 10nm or w/e, they haven't been able to ship a major redesign for like half a decade</p>



<a name="207097045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097045">(Aug 17 2020 at 00:25)</a>:</h4>
<p><em>except</em> for some higher-end Xeons</p>



<a name="207097053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097053">(Aug 17 2020 at 00:25)</a>:</h4>
<p>(presumably because they're much lower quantity so the low yields weren't as big of an issue)</p>



<a name="207097096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097096">(Aug 17 2020 at 00:26)</a>:</h4>
<p>this chip is from before 10nm production woes were even a public thing if I remember the events correctly.</p>



<a name="207097110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097110">(Aug 17 2020 at 00:27)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> it's "Skylake (server)" which is a direct predecessor of Cascade Lake</p>



<a name="207097161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097161">(Aug 17 2020 at 00:28)</a>:</h4>
<p>I wish there was a nicer way to view this information because I forgot the exact details</p>



<a name="207097168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097168">(Aug 17 2020 at 00:28)</a>:</h4>
<blockquote>
<p>Skylake server configuration introduces a number of significant changes from both Intel's previous microarchitecture, Broadwell, as well as the Skylake (client) architecture.</p>
</blockquote>



<a name="207097224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097224">(Aug 17 2020 at 00:30)</a>:</h4>
<p>oh right it's "Cove" that's the keyword I'm looking for</p>



<a name="207097238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097238">(Aug 17 2020 at 00:31)</a>:</h4>
<p>oh nvm that's "Ice Lake (server)" that's switching to the "Cove" design</p>



<a name="207097280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097280">(Aug 17 2020 at 00:32)</a>:</h4>
<p>but "Ice Lake (client)" also switches to "Cove". what.</p>



<a name="207097300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097300">(Aug 17 2020 at 00:33)</a>:</h4>
<blockquote>
<p>Palm Cove is the core microarchitecture that is found in Intel's Cannon Lake SoCs. Although originally intended to be mass manufactured for all client and server markets, due to Intel's prolong 10 nm process problems, Palm Cove is getting skipped with the exception of a single chip.</p>
</blockquote>



<a name="207097301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097301">(Aug 17 2020 at 00:33)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> okay I was misremembering Palm Cove as ending up in some Xeon Gold/Platinums</p>



<a name="207097304"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097304" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097304">(Aug 17 2020 at 00:33)</a>:</h4>
<p>but it's from 2018, I thought it was older</p>



<a name="207097594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097594">(Aug 17 2020 at 00:43)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> aaaah okay I found the thing that confused me, it's just from last year I guess: "Ice Lake (client)" is actually mobile-only. 10th gen desktop is "Comet Lake"</p>



<a name="207097611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097611">(Aug 17 2020 at 00:43)</a>:</h4>
<p>intel naming scheme and focused product stack™</p>



<a name="207097612"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097612" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097612">(Aug 17 2020 at 00:43)</a>:</h4>
<p>so this is the first generation with "Cove" cores: <a href="https://en.wikichip.org/wiki/intel/microarchitectures/ice_lake_(server)">https://en.wikichip.org/wiki/intel/microarchitectures/ice_lake_(server)</a></p>



<a name="207097652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097652">(Aug 17 2020 at 00:44)</a>:</h4>
<p>that's desktop or higher-end</p>



<a name="207097783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097783">(Aug 17 2020 at 00:48)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> okay so I knew that the "server" line (higher-end Xeons, not E's, and maybe some i7/i9 X's?) was getting "Cove" a few generations earlier, but I guess it is tied to 10nm and the only low-volume 10nm parts were, well, just some mobile SoCs</p>



<a name="207097795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097795">(Aug 17 2020 at 00:49)</a>:</h4>
<p>the Intel codenames are just absurd tbh</p>



<a name="207097854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097854">(Aug 17 2020 at 00:50)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> so "Cascade Lake" is also in the "highe-end server" line, but it's only the next generation after "Skylake (server)", so the differences should be small</p>



<a name="207097858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097858">(Aug 17 2020 at 00:51)</a>:</h4>
<p>but it does say there's spectre &amp; friends mitigations, so maybe that makes <code>rdpmc</code> more reliable?</p>



<a name="207097911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207097911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207097911">(Aug 17 2020 at 00:52)</a>:</h4>
<p>lol this looks like an IBM mainframe <a href="https://en.wikichip.org/wiki/intel/microarchitectures/cascade_lake#Higher_core-count_multi-chip_processors">https://en.wikichip.org/wiki/intel/microarchitectures/cascade_lake#Higher_core-count_multi-chip_processors</a></p>



<a name="207098035"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098035" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098035">(Aug 17 2020 at 00:56)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="123586">@nagisa</span> anyway ignoring all that offtopic discussion, I think the conclusion is that a Xeon Gold may behave differently than a desktop/laptop i7/i9</p>



<a name="207098037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098037">(Aug 17 2020 at 00:57)</a>:</h4>
<p>Intel started splitting the codenames after Broadwell</p>



<a name="207098045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098045">(Aug 17 2020 at 00:57)</a>:</h4>
<p>and then the Lake nation attacked</p>



<a name="207098091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098091">(Aug 17 2020 at 00:58)</a>:</h4>
<p>on the AMD side, I don't think people were taking it seriously before Zen, so at least I can pretend the history there doesn't matter</p>



<a name="207098293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098293">(Aug 17 2020 at 01:03)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> looking at the <code>rdpmc</code> details for your Ryzen 5 3600, well, looks like you have L2 <em>and</em> L3 misses available</p>



<a name="207098296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098296">(Aug 17 2020 at 01:03)</a>:</h4>
<p><em>and</em> micro-ops retired. that might be more accurate than instructions retired</p>



<a name="207098300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098300">(Aug 17 2020 at 01:03)</a>:</h4>
<p>wait till you hear about the chinese x86 implementations and VIA's resurrection.</p>



<a name="207098339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098339">(Aug 17 2020 at 01:04)</a>:</h4>
<p>the 3600 is the perf collector, btw</p>



<a name="207098341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098341">(Aug 17 2020 at 01:04)</a>:</h4>
<p>so that's the "important one"</p>



<a name="207098342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098342">(Aug 17 2020 at 01:04)</a>:</h4>
<p>yeah that's why I'm looking at it. although I think the 39xx is the same</p>



<a name="207098348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098348">(Aug 17 2020 at 01:04)</a>:</h4>
<p>this is what I'm looking at btw <a href="https://developer.amd.com/wp-content/resources/56176_ppr_Family_17h_Model_71h_B0_pub_Rev_3.06.zip">https://developer.amd.com/wp-content/resources/56176_ppr_Family_17h_Model_71h_B0_pub_Rev_3.06.zip</a></p>



<a name="207098356"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098356" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098356">(Aug 17 2020 at 01:05)</a>:</h4>
<p>page 172</p>



<a name="207098368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098368">(Aug 17 2020 at 01:05)</a>:</h4>
<p>unfortunately we'd need a kernel upgrade to get <code>perf</code> to know about most of  those on the perf collector, though we could hack it via the raw interface</p>



<a name="207098409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098409">(Aug 17 2020 at 01:06)</a>:</h4>
<p>mhmm</p>



<a name="207098411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098411">(Aug 17 2020 at 01:06)</a>:</h4>
<p>(It's not impossible to do the kernel upgrade but I'd rather not if we can avoid it)</p>



<a name="207098417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098417">(Aug 17 2020 at 01:06)</a>:</h4>
<p>I'm looking for any suggestion of anything being broken but I don't see any</p>



<a name="207098430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098430">(Aug 17 2020 at 01:07)</a>:</h4>
<p>I think this PDF doesn't have the errata</p>



<a name="207098434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098434">(Aug 17 2020 at 01:07)</a>:</h4>
<p>that's a different one</p>



<a name="207098438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098438">(Aug 17 2020 at 01:07)</a>:</h4>
<p>I don't see it in here for 17h <a href="https://developer.amd.com/resources/developer-guides-manuals/">https://developer.amd.com/resources/developer-guides-manuals/</a></p>



<a name="207098446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098446">(Aug 17 2020 at 01:07)</a>:</h4>
<p>not even a revision guide</p>



<a name="207098452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098452">(Aug 17 2020 at 01:07)</a>:</h4>
<p>hm I had a different url before that worked</p>



<a name="207098495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098495">(Aug 17 2020 at 01:08)</a>:</h4>
<p>for EPYC it's in the Revision guide</p>



<a name="207098513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098513">(Aug 17 2020 at 01:09)</a>:</h4>
<p>why are all of these zip files?!</p>



<a name="207098517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098517">(Aug 17 2020 at 01:09)</a>:</h4>
<p>ooooh <code>rpdmc</code> can access one of 3 different kinds of counters, that's how it includes L3:</p>
<blockquote>
<p>There are six core performance event counters per thread, six performance events counters per L3 complex and four Data Fabric performance events counters mapped to the RDPMC instruction as follows:</p>
</blockquote>



<a name="207098519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098519">(Aug 17 2020 at 01:10)</a>:</h4>
<p>this is the one I wanted <a href="https://developer.amd.com/wp-content/resources/55449_1.16.pdf#page=13">https://developer.amd.com/wp-content/resources/55449_1.16.pdf#page=13</a></p>



<a name="207098563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098563">(Aug 17 2020 at 01:10)</a>:</h4>
<p>which probably means we can't get L3 numbers because the kernel has no easy way of separating them into processes</p>



<a name="207098573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098573">(Aug 17 2020 at 01:11)</a>:</h4>
<p>that would make sense, yeah</p>



<a name="207098574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098574">(Aug 17 2020 at 01:11)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> that's all Zen 1, no?</p>



<a name="207098577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098577">(Aug 17 2020 at 01:11)</a>:</h4>
<p>hm 17h is zen 2 I thought?</p>



<a name="207098582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098582">(Aug 17 2020 at 01:11)</a>:</h4>
<p>no 17h is Zen</p>



<a name="207098584"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098584" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098584">(Aug 17 2020 at 01:11)</a>:</h4>
<p>oh right</p>



<a name="207098585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098585">(Aug 17 2020 at 01:11)</a>:</h4>
<p>maybe <a href="https://developer.amd.com/wp-content/resources/56323-PUB_0.74.pdf">https://developer.amd.com/wp-content/resources/56323-PUB_0.74.pdf</a>?</p>



<a name="207098588"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098588" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098588">(Aug 17 2020 at 01:11)</a>:</h4>
<p>the "model" tells apart the Zen generations and EPYC vs desktop</p>



<a name="207098629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098629">(Aug 17 2020 at 01:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> that doesn't include 71h models</p>



<a name="207098635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098635">(Aug 17 2020 at 01:12)</a>:</h4>
<p>you can go to page 8 and see that it's just EPYC 7002</p>



<a name="207098636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098636">(Aug 17 2020 at 01:12)</a>:</h4>
<p>hm well maybe there's just no revision guide :/</p>



<a name="207098638"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098638" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098638">(Aug 17 2020 at 01:12)</a>:</h4>
<p>nothing more</p>



<a name="207098685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098685">(Aug 17 2020 at 01:14)</a>:</h4>
<p>wow we can count a lot of nonsense</p>



<a name="207098692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098692">(Aug 17 2020 at 01:14)</a>:</h4>
<p>if we had more than 6 counters we could probably get a lot of data and measure a more accurate performance cost</p>



<a name="207098755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098755">(Aug 17 2020 at 01:17)</a>:</h4>
<p>page 180 in the zip I linked, "EX (SC) events" seems to have all the cool retire events</p>



<a name="207098805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098805">(Aug 17 2020 at 01:18)</a>:</h4>
<p>hm I think you mean 181</p>



<a name="207098812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098812">(Aug 17 2020 at 01:18)</a>:</h4>
<p>oh yeah the section is labelled wrong</p>



<a name="207098825"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098825" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098825">(Aug 17 2020 at 01:19)</a>:</h4>
<p>but anyone the only insight is that uops might be more useful than just instructions</p>



<a name="207098826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098826">(Aug 17 2020 at 01:19)</a>:</h4>
<p>it starts at the <em>very</em> end of 180</p>



<a name="207098830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207098830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207098830">(Aug 17 2020 at 01:19)</a>:</h4>
<p>we haven't learned anything about how broken Zen 2 is</p>



<a name="207099055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099055">(Aug 17 2020 at 01:24)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> looks like I have <code>uops_retired.all</code> in <code>perf list</code> on my Ivy Bridge, do you have that too?</p>



<a name="207099067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099067">(Aug 17 2020 at 01:25)</a>:</h4>
<p>not in perf list</p>



<a name="207099112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099112">(Aug 17 2020 at 01:26)</a>:</h4>
<p>I do have ex_ret_cops in core which is labeled as Retired Uops</p>



<a name="207099114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099114">(Aug 17 2020 at 01:26)</a>:</h4>
<p>Zen has less things to count than Ivy Bridge? hmpf</p>



<a name="207099118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099118">(Aug 17 2020 at 01:26)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> yeah that must be it</p>



<a name="207099120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099120">(Aug 17 2020 at 01:26)</a>:</h4>
<div class="codehilite"><pre><span></span><code>core:
  ex_div_busy
       [Div Cycles Busy count]
  ex_div_count
       [Div Op Count]
  ex_ret_brn
       [Retired Branch Instructions]
  ex_ret_brn_far
       [Retired Far Control Transfers]
  ex_ret_brn_ind_misp
       [Retired Indirect Branch Instructions Mispredicted]
  ex_ret_brn_misp
       [Retired Branch Instructions Mispredicted]
  ex_ret_brn_resync
       [Retired Branch Resyncs]
  ex_ret_brn_tkn
       [Retired Taken Branch Instructions]
  ex_ret_brn_tkn_misp
       [Retired Taken Branch Instructions Mispredicted]
  ex_ret_cond
       [Retired Conditional Branch Instructions]
  ex_ret_cond_misp
       [Retired Conditional Branch Instructions Mispredicted]
  ex_ret_cops
       [Retired Uops]
  ex_ret_fus_brnch_inst
       [The number of fused retired branch instructions retired per cycle. The
        number of events logged per cycle can vary from 0 to 3]
  ex_ret_instr
       [Retired Instructions]
  ex_ret_mmx_fp_instr.mmx_instr
       [MMX instructions]
  ex_ret_mmx_fp_instr.sse_instr
       [SSE instructions (SSE, SSE2, SSE3, SSSE3, SSE4A, SSE41, SSE42, AVX)]
  ex_ret_mmx_fp_instr.x87_instr
       [x87 instructions]
  ex_ret_near_ret
       [Retired Near Returns]
  ex_ret_near_ret_mispred
       [Retired Near Returns Mispredicted]
  ex_tagged_ibs_ops.ibs_count_rollover
       [Number of times an op could not be tagged by IBS because of a previous
        tagged op that has not retired]
  ex_tagged_ibs_ops.ibs_tagged_ops
       [Number of Ops tagged by IBS]
  ex_tagged_ibs_ops.ibs_tagged_ops_ret
       [Number of Ops tagged by IBS that retired]
</code></pre></div>



<a name="207099123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099123">(Aug 17 2020 at 01:27)</a>:</h4>
<p>I see something similar on Zen 1 EPYC</p>



<a name="207099174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099174">(Aug 17 2020 at 01:28)</a>:</h4>
<p>that's on 3950x but I think we concluded that 3600 should have the same (just we need a more recent kernel for perf to know about it with nice names)</p>



<a name="207099187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099187">(Aug 17 2020 at 01:29)</a>:</h4>
<p>3600 and 3950x are materially the same thing, the only difference is that there's 2 of ccx in the latter.</p>



<a name="207099190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099190">(Aug 17 2020 at 01:29)</a>:</h4>
<p>yeah that's what I thought</p>



<a name="207099195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099195">(Aug 17 2020 at 01:29)</a>:</h4>
<p>(well and former also has 2 of its cores fused out)</p>



<a name="207099197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099197">(Aug 17 2020 at 01:29)</a>:</h4>
<p>I wasn't sure if they, like, disabled some counters or whatever in the 3600 chip</p>



<a name="207099209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099209">(Aug 17 2020 at 01:30)</a>:</h4>
<p>I'm increasingly mad/sad that Intel seems like the better option for measurement, except that Xeon Gold did seem to be worse</p>



<a name="207099248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099248">(Aug 17 2020 at 01:30)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> they're both technically desktop parts so unless hetnzer is virtualizing you, I doubt there could be a difference</p>



<a name="207099253"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099253" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099253">(Aug 17 2020 at 01:30)</a>:</h4>
<p>maybe if you were comparing a G (integrated GPU) part with a non-G one</p>



<a name="207099256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099256">(Aug 17 2020 at 01:31)</a>:</h4>
<p>iirc we tried to get "a real machine" from hetnzer, but I don't know if that's actually true</p>



<a name="207099260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099260">(Aug 17 2020 at 01:31)</a>:</h4>
<p>I think it is</p>



<a name="207099270"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099270" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099270">(Aug 17 2020 at 01:31)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> okay this might be silly but what does <code>perf list | wc -l</code> say on your Xeon Gold?</p>



<a name="207099272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099272">(Aug 17 2020 at 01:31)</a>:</h4>
<p>its probably still hypervised.</p>



<a name="207099343"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099343" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099343">(Aug 17 2020 at 01:33)</a>:</h4>
<p>37</p>



<a name="207099381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099381">(Aug 17 2020 at 01:34)</a>:</h4>
<p>uhh is that an old kernel?</p>



<a name="207099387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099387">(Aug 17 2020 at 01:34)</a>:</h4>
<p>I get 1115</p>



<a name="207099388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099388">(Aug 17 2020 at 01:34)</a>:</h4>
<p>yeah.</p>



<a name="207099392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099392">(Aug 17 2020 at 01:34)</a>:</h4>
<p>blergh so there's no easy way to do that</p>



<a name="207099393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099393">(Aug 17 2020 at 01:34)</a>:</h4>
<div class="codehilite"><pre><span></span><code>List of pre-defined events (to be used in -e):

  branch-instructions OR branches                    [Hardware event]
  branch-misses                                      [Hardware event]
  bus-cycles                                         [Hardware event]
  cache-misses                                       [Hardware event]
  cache-references                                   [Hardware event]
  cpu-cycles OR cycles                               [Hardware event]
  instructions                                       [Hardware event]
  ref-cycles                                         [Hardware event]

  alignment-faults                                   [Software event]
  bpf-output                                         [Software event]
  context-switches OR cs                             [Software event]
  cpu-clock                                          [Software event]
  cpu-migrations OR migrations                       [Software event]
  dummy                                              [Software event]
  emulation-faults                                   [Software event]
  major-faults                                       [Software event]
  minor-faults                                       [Software event]
  page-faults OR faults                              [Software event]
  task-clock                                         [Software event]

  branch-instructions OR cpu/branch-instructions/    [Kernel PMU event]
  branch-misses OR cpu/branch-misses/                [Kernel PMU event]
  bus-cycles OR cpu/bus-cycles/                      [Kernel PMU event]
  cache-misses OR cpu/cache-misses/                  [Kernel PMU event]
  cache-references OR cpu/cache-references/          [Kernel PMU event]
  cpu-cycles OR cpu/cpu-cycles/                      [Kernel PMU event]
  instructions OR cpu/instructions/                  [Kernel PMU event]
  intel_bts//                                        [Kernel PMU event]
  intel_cqm/llc_occupancy/                           [Kernel PMU event]
  intel_cqm/local_bytes/                             [Kernel PMU event]
  intel_cqm/total_bytes/                             [Kernel PMU event]
  intel_pt//                                         [Kernel PMU event]
  msr/aperf/                                         [Kernel PMU event]
  msr/mperf/                                         [Kernel PMU event]
  msr/tsc/                                           [Kernel PMU event]

  rNNN                                               [Raw hardware event descriptor]
  cpu/t1=v1[,t2=v2,t3 ...]/modifier                  [Raw hardware event descriptor]
   (see &#39;man perf-list&#39; on how to encode it)

  mem:&lt;addr&gt;[/len][:access]                          [Hardware breakpoint]
</code></pre></div>



<a name="207099397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099397">(Aug 17 2020 at 01:34)</a>:</h4>
<p>lol</p>



<a name="207099403"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099403" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099403">(Aug 17 2020 at 01:34)</a>:</h4>
<p>yeah that's basically what the 3600 with 4.15 kernel shows</p>



<a name="207099422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099422">(Aug 17 2020 at 01:35)</a>:</h4>
<p>I only have 5.4.33 here, that's not <em>that</em> much newer, is it?</p>



<a name="207099483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099483">(Aug 17 2020 at 01:36)</a>:</h4>
<p>1335 on haswell, 380 on zen1</p>



<a name="207099484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099484">(Aug 17 2020 at 01:36)</a>:</h4>
<p>I guess I get kernel updates more regularly than the stable channel hmm</p>



<a name="207099490"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099490" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099490">(Aug 17 2020 at 01:36)</a>:</h4>
<p>I think they added the counters for ryzen on 5.x series</p>



<a name="207099494"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099494" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099494">(Aug 17 2020 at 01:36)</a>:</h4>
<p>I have 453 counters on 3950x and 5.4.0 kernel</p>



<a name="207099499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099499">(Aug 17 2020 at 01:37)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> hmmmmm what if you ran the thing (god I'm falling asleep) on the Haskell</p>



<a name="207099505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099505">(Aug 17 2020 at 01:37)</a>:</h4>
<p>the Haswell even</p>



<a name="207099507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099507">(Aug 17 2020 at 01:37)</a>:</h4>
<p>both of those above on 5.6</p>



<a name="207099515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099515">(Aug 17 2020 at 01:37)</a>:</h4>
<p>eh… I could...</p>



<a name="207099517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099517">(Aug 17 2020 at 01:37)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> wait, if you have an older kernel then <code>lfence</code> does nothing on Zen</p>



<a name="207099521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099521">(Aug 17 2020 at 01:37)</a>:</h4>
<p>that must explain why it's so bad</p>



<a name="207099535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099535">(Aug 17 2020 at 01:38)</a>:</h4>
<p>making it serializing is a Spectre mitigation</p>



<a name="207099536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099536">(Aug 17 2020 at 01:38)</a>:</h4>
<p>hm we tested on 3950x with 5.4 kernel though? I think it was bad there too</p>



<a name="207099578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099578">(Aug 17 2020 at 01:38)</a>:</h4>
<p>oh huh nvm then</p>



<a name="207099585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099585">(Aug 17 2020 at 01:38)</a>:</h4>
<p>maybe Linux thinks Zen 2 doesn't need that kind of aggressive mitigation</p>



<a name="207099587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099587">(Aug 17 2020 at 01:38)</a>:</h4>
<p>intel/haswell has a ton of counters for i915 (the gpu)</p>



<a name="207099590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099590">(Aug 17 2020 at 01:38)</a>:</h4>
<p>yeah <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20%28rdpmc%29.20measurements/near/207095374">https://rust-lang.zulipchat.com/#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20%28rdpmc%29.20measurements/near/207095374</a></p>



<a name="207099658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099658">(Aug 17 2020 at 01:40)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> what if the older kernel on the Xeon Gold is worse at keeping measurements noiseless?</p>



<a name="207099661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099661">(Aug 17 2020 at 01:40)</a>:</h4>
<p>at this point I feel like we'll all go mad if we keep going</p>



<a name="207099667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099667">(Aug 17 2020 at 01:40)</a>:</h4>
<p>maybe? I mean I can always fire up the vm with recent kernel on most recent intel chip google bothered to buy</p>



<a name="207099671"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099671" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099671">(Aug 17 2020 at 01:41)</a>:</h4>
<p>too lazy to do it today though</p>



<a name="207099672"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099672" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099672">(Aug 17 2020 at 01:41)</a>:</h4>
<p>yeah no worries just running through all the things I can think of</p>



<a name="207099674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099674">(Aug 17 2020 at 01:41)</a>:</h4>
<p>overall it looks like <code>lfence</code> doesn't work on every system and <code>cpuid</code> is just better most of the time</p>



<a name="207099678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099678">(Aug 17 2020 at 01:41)</a>:</h4>
<p>it's not on my Zen 1 but I think that's because <code>lfence</code> gets the MSR bit set to become a serializing instruction <em>and</em> <code>cpuid</code> sucks in general</p>



<a name="207099721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099721">(Aug 17 2020 at 01:42)</a>:</h4>
<p>if we were measuring uops retired we could actually see how many uops are wasted on <code>cpuid</code>, lol</p>



<a name="207099724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099724">(Aug 17 2020 at 01:42)</a>:</h4>
<p>wait I can do that tho</p>



<a name="207099804"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099804" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099804">(Aug 17 2020 at 01:45)</a>:</h4>
<p>huh I'm seeing stuff online that would suggest <code>setarch $(uname -m) -R</code> works around <code>perf stat</code>, which... given my previous experience, I doubt that works? but I can try</p>



<a name="207099853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099853">(Aug 17 2020 at 01:47)</a>:</h4>
<p>even if disabling ASLR doesn't work, I can still compare the results I think</p>



<a name="207099904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099904">(Aug 17 2020 at 01:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> wow, uops retired is only about 1.25x the number of instructions</p>



<a name="207099909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099909">(Aug 17 2020 at 01:49)</a>:</h4>
<p>at least <code>perf stat</code> doesn't seem to need root to do this</p>



<a name="207099960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099960">(Aug 17 2020 at 01:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207099904">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> wow, uops retired is only about 1.25x the number of instructions</p>
</blockquote>
<p>not super surprised, compiler is mostly a pointer chasing algorithm and does not use much of the complicated instructions</p>



<a name="207099966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099966">(Aug 17 2020 at 01:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> btw do you know where <code>time</code> or <code>perf stat</code> gets its "user" vs "sys" time split from? does libstd's <code>Instant</code> correspond to global time, not "user" time? this seems like it may have an opportunity for reduci- nevermind, "user" and "sys" times are only microsecond precision, compared to total time</p>



<a name="207099970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099970">(Aug 17 2020 at 01:51)</a>:</h4>
<p>I would be willing to bet most of the µops actually come from various avx2 optimised algorithms.</p>



<a name="207099971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099971">(Aug 17 2020 at 01:51)</a>:</h4>
<p>instant is global time almost certainly</p>



<a name="207099982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207099982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207099982">(Aug 17 2020 at 01:51)</a>:</h4>
<p>user/sys time is ~100% counted by the kernel itself</p>



<a name="207100024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100024">(Aug 17 2020 at 01:52)</a>:</h4>
<p>there's a per-process counter for both of those in /proc/pid/stats or whatever</p>



<a name="207100030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100030">(Aug 17 2020 at 01:52)</a>:</h4>
<p>I've been told <code>CLOCK_MONOTONIC</code> uses <code>rdtsc</code> and a kernel-updated CPU frequency to get a nanosecond-precision estimate</p>



<a name="207100034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100034">(Aug 17 2020 at 01:53)</a>:</h4>
<p>not sure why "user time" couldn't do the same</p>



<a name="207100075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100075">(Aug 17 2020 at 01:54)</a>:</h4>
<p>probably rdtscp nowadays</p>



<a name="207100082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100082">(Aug 17 2020 at 01:54)</a>:</h4>
<p>what SCP number does that have :P</p>



<a name="207100087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100087">(Aug 17 2020 at 01:54)</a>:</h4>
<p>both rdtsc and rdtscp nowadays are agnostic to cpu clock changes though</p>



<a name="207100088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100088">(Aug 17 2020 at 01:54)</a>:</h4>
<p>object class: Intel Inside ^(TM)</p>



<a name="207100329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100329">(Aug 17 2020 at 02:01)</a>:</h4>
<p>huuh, <code>setarch -R</code> did work around perf!</p>



<a name="207100332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100332">(Aug 17 2020 at 02:01)</a>:</h4>
<p>the difference seems to be 64 ±15 uops for 6 instructions</p>



<a name="207100373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100373">(Aug 17 2020 at 02:02)</a>:</h4>
<p>so yeah that's what I'd expected <code>cpuid</code> to be lmao (that one is <code>cpuid(0)</code>, maybe there's a cheaper one?)</p>



<a name="207100388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100388">(Aug 17 2020 at 02:03)</a>:</h4>
<p>oh wait the "baseline" has<code>lfence</code>, so it's 7 instructions, not 6</p>



<a name="207100432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100432">(Aug 17 2020 at 02:04)</a>:</h4>
<p>oh but <code>lfence</code> is probably 1 uop? ugh I should've measured with a proper baseline</p>



<a name="207100445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100445">(Aug 17 2020 at 02:04)</a>:</h4>
<p>anyway it's still around 60 uops for <code>cpuid(0)</code></p>



<a name="207100651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100651">(Aug 17 2020 at 02:10)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> wow, the <code>cpuid</code> runs are on average slower by almost half a second</p>



<a name="207100664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100664">(Aug 17 2020 at 02:11)</a>:</h4>
<p>yeah :/ </p>
<p>That does mean that we add up to something like ~8 minutes slower, but then again wall-clock collection wasn't cheap either so...</p>



<a name="207100720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100720">(Aug 17 2020 at 02:13)</a>:</h4>
<p>yeah this is like 3-4x cheaper than wall-clock lol</p>



<a name="207100788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100788">(Aug 17 2020 at 02:14)</a>:</h4>
<p>I guess I can do some math on the uops. they would add up to around 100 million, out of 55 billion. wait why am I doing this. I can just go look at the difference</p>



<a name="207100814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100814">(Aug 17 2020 at 02:15)</a>:</h4>
<p>yeah it's 0.11B out of 55B. so 1/500 or 0.2%</p>



<a name="207100865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100865">(Aug 17 2020 at 02:17)</a>:</h4>
<p>that's 10x smaller than the time difference I'm seeing... so maybe the "user time" is still too noisy?</p>



<a name="207100866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100866">(Aug 17 2020 at 02:17)</a>:</h4>
<p>anyway there's definitely a cost <em>sigh</em></p>



<a name="207100915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100915">(Aug 17 2020 at 02:18)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I wonder if the distro you're using just didn't enable Spectre mitigations o_O</p>



<a name="207100925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100925">(Aug 17 2020 at 02:19)</a>:</h4>
<p>although we can probably defer caring about it until we are actually measuring uops</p>



<a name="207100926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100926">(Aug 17 2020 at 02:19)</a>:</h4>
<p>and just go with <code>cpuid</code> for now</p>



<a name="207100957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207100957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207100957">(Aug 17 2020 at 02:19)</a>:</h4>
<p>all I've learned today is that we can't have perfectly nice things, we just have to settle for 5 orders of magnitude less noise or however much we're up to now :P</p>



<a name="207101853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207101853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207101853">(Aug 17 2020 at 02:43)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> oh I checked again and what you're seeing with <code>lfence</code> on Zen 2 is what I'm seeing unserialized on Zen 1</p>



<a name="207101862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207101862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207101862">(Aug 17 2020 at 02:43)</a>:</h4>
<p>so that's not actually worse</p>



<a name="207101907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207101907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207101907">(Aug 17 2020 at 02:44)</a>:</h4>
<p>well, <code>"generate_crate_metadata": 140926.5,</code> is double but there might just be large-scale noise</p>



<a name="207101910"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207101910" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207101910">(Aug 17 2020 at 02:44)</a>:</h4>
<p>that task might just be querying a gajillion things</p>



<a name="207101919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207101919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207101919">(Aug 17 2020 at 02:45)</a>:</h4>
<p>again I wish I had a "child intervals" metric to just divide the variance by</p>



<a name="207111650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207111650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207111650">(Aug 17 2020 at 06:53)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> If you try to get instruction-count variance down to zero, you're definitely going to be chasing things from here to eternity. It's possible to do <em>better</em>, though.</p>



<a name="207111727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207111727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207111727">(Aug 17 2020 at 06:54)</a>:</h4>
<p>Entering the scheduler is going to send uncertainty through the roof. Touching the disk or filesystem, even more so.</p>



<a name="207111984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207111984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207111984">(Aug 17 2020 at 06:59)</a>:</h4>
<p>It's possible to get multiple runs with the same instruction count. Theoretically.</p>



<a name="207119605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207119605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207119605">(Aug 17 2020 at 08:47)</a>:</h4>
<p>curious why scheduling isn't "free" - this is user-mode only, can't the kernel pause the counters?</p>



<a name="207119633"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207119633" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207119633">(Aug 17 2020 at 08:47)</a>:</h4>
<p>or are they getting ±1 on every context switch?</p>



<a name="207120640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207120640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207120640">(Aug 17 2020 at 09:00)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> like I can already get groups of 10 runs that are ±5k, out of ~44B</p>



<a name="207121081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207121081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207121081">(Aug 17 2020 at 09:05)</a>:</h4>
<p>and it's singlethreaded anyway. hmpf</p>



<a name="207121176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207121176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207121176">(Aug 17 2020 at 09:06)</a>:</h4>
<p>I wonder if I should wrap my tests in using <code>perf stat</code> to read some of the software events and see if there is a correlation there</p>



<a name="207137534"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207137534" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207137534">(Aug 17 2020 at 12:37)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> someone else who uses the same hetzner box we do, got back to me, and said "hetzner boxes are bare metal"</p>



<a name="207137540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207137540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207137540">(Aug 17 2020 at 12:37)</a>:</h4>
<p>which is what I knew</p>



<a name="207138535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207138535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207138535">(Aug 17 2020 at 12:48)</a>:</h4>
<p>it really depends on how you define "bare metal", I’m 99% confident that if the machine is at a DC and its not your own physical hardware, then it going to be hypervised.</p>



<a name="207138711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207138711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207138711">(Aug 17 2020 at 12:50)</a>:</h4>
<p>I'm pretty sure Hetzner machines aren't hypervised, it's basically colocation with rented hardware.</p>



<a name="207138792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207138792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207138792">(Aug 17 2020 at 12:51)</a>:</h4>
<p>(at least with their dedicated offering, can't speak to any others)</p>



<a name="207139183"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207139183" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207139183">(Aug 17 2020 at 12:54)</a>:</h4>
<p>(turns out there's a way to check this, CPUID(1) bit 31 will be set if hypervised)</p>



<a name="207144988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207144988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207144988">(Aug 17 2020 at 13:41)</a>:</h4>
<p>yeah this is all dedicated</p>



<a name="207145125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207145125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207145125">(Aug 17 2020 at 13:42)</a>:</h4>
<p>you're renting the hardware, not just some level of access to it</p>



<a name="207146585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207146585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207146585">(Aug 17 2020 at 13:55)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span></p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> like I can already get groups of 10 runs that are ±5k, out of ~44B</p>
</blockquote>
<p>Yes, you can absolutely get within 5k. I'm saying it gets harder and harder the closer you want to get it.</p>



<a name="207155365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207155365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207155365">(Aug 17 2020 at 15:10)</a>:</h4>
<p>I mean I doubt there's anything happening that's not.... oh I could've build a really simple test /facepalm</p>



<a name="207155416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207155416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207155416">(Aug 17 2020 at 15:10)</a>:</h4>
<p>I can just execute a known number of instructions for a minute and see how far off <code>rdpmc</code> is</p>



<a name="207155609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207155609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207155609">(Aug 17 2020 at 15:12)</a>:</h4>
<p>I can also execute <em>a lot</em> of <code>rdpmc</code> in predictable ways. I should've done all this benchmarking ahead of time, oh well</p>



<a name="207155632"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207155632" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207155632">(Aug 17 2020 at 15:12)</a>:</h4>
<p>at least now that I know I might not trust some hardware, I can look for certain patterns</p>



<a name="207155818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207155818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207155818">(Aug 17 2020 at 15:14)</a>:</h4>
<p>anything that gets non-uniformly worse with time probably involves the kernel (or I could invoke some syscalls I guess? yeah I should be able to measure how many instructions get counted on the wrong side. ideally the core itself stops counting past the <code>syscall</code> but maybe the kernal has to manually pause it)</p>



<a name="207170011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207170011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207170011">(Aug 17 2020 at 17:12)</a>:</h4>
<p>awwwww I can't sketch this in the browser <a href="https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2018&amp;gist=0679cc907f127c73fbcea64b6db6b920">https://play.rust-lang.org/?version=nightly&amp;mode=release&amp;edition=2018&amp;gist=0679cc907f127c73fbcea64b6db6b920</a>. but I should be able to just do it locally</p>



<a name="207170472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207170472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207170472">(Aug 17 2020 at 17:16)</a>:</h4>
<p>heh I never looked at this, but on Ivy Bridge I get <code>index=0x40000001</code> (I think that's before subtracting <code>0</code>, so <code>0x40000000</code> is what is passed to <code>rdpmc</code>), that high up bit is not set on Zen</p>



<a name="207171852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207171852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207171852">(Aug 17 2020 at 17:28)</a>:</h4>
<p>why is Clang not working here like GCC is? <a href="https://godbolt.org/z/vTxnYd">https://godbolt.org/z/vTxnYd</a></p>



<a name="207172243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207172243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207172243">(Aug 17 2020 at 17:31)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> if I flip all the 1s and 2s in the second example on &lt;<a href="https://blog.rust-lang.org/inside-rust/2020/06/08/new-inline-asm.html">https://blog.rust-lang.org/inside-rust/2020/06/08/new-inline-asm.html</a>&gt;, it breaks the same way I'm seeing stuff break for me, hwat</p>



<a name="207172399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207172399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207172399">(Aug 17 2020 at 17:32)</a>:</h4>
<p>2 is a valid temporary backwards label, 1 isn't?!</p>



<a name="207172883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207172883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207172883">(Aug 17 2020 at 17:35)</a>:</h4>
<p>(deleted)</p>



<a name="207173524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173524">(Aug 17 2020 at 17:39)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="239881">@Josh Triplett</span> oh wow with very little effort I already have useful information. the noise is proportional to the duration of a trivial loop, on my old hardware at least, so I think it is from context-switching with imperfect pause/resume</p>



<a name="207173581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173581">(Aug 17 2020 at 17:39)</a>:</h4>
<p>That sounds entirely likely, yes.</p>



<a name="207173614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173614">(Aug 17 2020 at 17:39)</a>:</h4>
<p>that's sad... given that this is a solvable problem</p>



<a name="207173752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173752">(Aug 17 2020 at 17:40)</a>:</h4>
<p>I bet there's some kernel config param for this somewhere that's disabled by default because most of the people don't care about perf counters and it would likely have perf impact on the scheduler.</p>



<a name="207173836"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173836" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173836">(Aug 17 2020 at 17:41)</a>:</h4>
<p>What happens if you run the same process (note: <em>do not run an infinite loop</em>) using <code>chrt -f 99 ./theprocess</code>?</p>



<a name="207173873"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173873" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173873">(Aug 17 2020 at 17:41)</a>:</h4>
<p>if there was a hardware feature to keep the counter per-privilege-level then it shouldn't cost anything</p>



<a name="207173918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173918">(Aug 17 2020 at 17:41)</a>:</h4>
<p>except at the hardware level ofc</p>



<a name="207173919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173919">(Aug 17 2020 at 17:41)</a>:</h4>
<p>There <em>are</em> hardware features for that, as far as I know.</p>



<a name="207173940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173940">(Aug 17 2020 at 17:41)</a>:</h4>
<p>I think there is, but it also depends on precise counters</p>



<a name="207173976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207173976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207173976">(Aug 17 2020 at 17:42)</a>:</h4>
<p>this is "retired instructions"</p>



<a name="207174010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207174010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207174010">(Aug 17 2020 at 17:42)</a>:</h4>
<p>maybe it's just not in Ivy Bridge</p>



<a name="207174063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207174063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207174063">(Aug 17 2020 at 17:42)</a>:</h4>
<p>anyway I don't think I need to go much further, nor add any analysis, you can literally see the variance</p>



<a name="207174266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207174266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207174266">(Aug 17 2020 at 17:44)</a>:</h4>
<p>see the "p" modifier in "man perf-list"</p>



<a name="207174428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207174428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207174428">(Aug 17 2020 at 17:44)</a>:</h4>
<p>which refers to address sampling, but I <em>think</em> that also affects plain counters for stuff like kernel/user separation</p>



<a name="207174664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207174664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207174664">(Aug 17 2020 at 17:46)</a>:</h4>
<p>interesting, will look at that in a bit</p>



<a name="207174738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207174738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207174738">(Aug 17 2020 at 17:46)</a>:</h4>
<p>until then, anyone with nightly and <code>rustc-dev</code> installed can run this:<br>
<code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/d003c82d38c3ff0df18764acb8abd2a6e39fe180/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; ./rdpmc-bench</code></p>



<a name="207175018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175018">(Aug 17 2020 at 17:49)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> ^^ wow, my Ivy Bridge (Linux 5.4.33) is 3x worse than the Zen 1 EPYC (Linux 5.4.12). can you try on Zen 2?</p>



<a name="207175041"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175041" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175041">(Aug 17 2020 at 17:49)</a>:</h4>
<p>I wonder if this is more tied to kernel version, too</p>



<a name="207175188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175188">(Aug 17 2020 at 17:50)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> hopefully this should be much easier to try out than a whole rustc build (also it only takes a few seconds)</p>



<a name="207175249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175249">(Aug 17 2020 at 17:51)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0463]: can&#39;t find crate for `memmap`
 --&gt; &lt;anon&gt;:6:1
  |
6 | extern crate memmap;
  | ^^^^^^^^^^^^^^^^^^^^ can&#39;t find crate

error: aborting due to previous error

For more information about this error, try `rustc --explain E0463`.
</code></pre></div>



<a name="207175273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175273">(Aug 17 2020 at 17:51)</a>:</h4>
<p>that's <code>rustc-dev</code> missing</p>



<a name="207175303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175303">(Aug 17 2020 at 17:51)</a>:</h4>
<p>ah okay</p>



<a name="207175308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175308">(Aug 17 2020 at 17:51)</a>:</h4>
<p>I should've shoved that into the command</p>



<a name="207175360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175360">(Aug 17 2020 at 17:52)</a>:</h4>
<p>hm do you want output of that in a gist?</p>



<a name="207175431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175431">(Aug 17 2020 at 17:52)</a>:</h4>
<p>just give me the rough value from the last set</p>



<a name="207175450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175450">(Aug 17 2020 at 17:52)</a>:</h4>
<div class="codehilite"><pre><span></span><code>### `ecx=10000000`
1
1
0
1
1
0
1
0
1
1

### `ecx=100000000`
5
6
6
6
5
6
6
6
5
6

### `ecx=1000000000`
57
57
58
56
57
57
57
59
57
57

rdpmc-bench instructions:u=11111202218
</code></pre></div>



<a name="207175458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175458">(Aug 17 2020 at 17:52)</a>:</h4>
<p>for me it's 333 on the EPYC</p>



<a name="207175474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175474">(Aug 17 2020 at 17:52)</a>:</h4>
<p>oh wow nice</p>



<a name="207175481"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175481" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175481">(Aug 17 2020 at 17:52)</a>:</h4>
<p>that's on 3950x</p>



<a name="207175511"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175511" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175511">(Aug 17 2020 at 17:53)</a>:</h4>
<p>but we've established it's more or less identical to 3600 so should be fine</p>



<a name="207175529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175529">(Aug 17 2020 at 17:53)</a>:</h4>
<p>it'd be good to check in case it's the kernel</p>



<a name="207175559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175559">(Aug 17 2020 at 17:53)</a>:</h4>
<p>I mean, there really is nothing happening here, so the kernel is the one screwing things up :P</p>



<a name="207175573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175573">(Aug 17 2020 at 17:53)</a>:</h4>
<p>I just don't know how the hardware plays into that</p>



<a name="207175698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207175698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207175698">(Aug 17 2020 at 17:54)</a>:</h4>
<p>I edited the command to be more self-contained</p>



<a name="207176473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176473">(Aug 17 2020 at 18:01)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> oh <code>:p</code> is not for "Instructions retired"</p>



<a name="207176562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176562">(Aug 17 2020 at 18:02)</a>:</h4>
<p>darn</p>



<a name="207176608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176608">(Aug 17 2020 at 18:02)</a>:</h4>
<p>looks like it's mostly for randomized/interval sampling</p>



<a name="207176661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176661">(Aug 17 2020 at 18:02)</a>:</h4>
<p>which is, like, scattershot profiling, not exact counting</p>



<a name="207176682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176682">(Aug 17 2020 at 18:03)</a>:</h4>
<p>on my i7-7700k, I get:</p>
<div class="codehilite"><pre><span></span><code>### `ecx=1000000000`
892
895
891
890
890
891
920
901
905
895
</code></pre></div>



<a name="207176692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176692">(Aug 17 2020 at 18:03)</a>:</h4>
<p>it's also for retired uops, idk what's up with that</p>



<a name="207176732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176732">(Aug 17 2020 at 18:03)</a>:</h4>
<p>on my Ryzen 7 3800X, I get:</p>
<div class="codehilite"><pre><span></span><code>### `ecx=1000000000`
222
223
222
223
225
223
223
226
235
225
</code></pre></div>



<a name="207176761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176761">(Aug 17 2020 at 18:03)</a>:</h4>
<p>I should've aggregated it so ppl don't paste the whole 10 :P</p>



<a name="207176816"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176816" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176816">(Aug 17 2020 at 18:04)</a>:</h4>
<p>they're only really there so one can eyeball the values and make sure there's no weird outliers</p>



<a name="207176857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176857">(Aug 17 2020 at 18:04)</a>:</h4>
<p>yeah, I know well about sampling -- I used to work on Intel vTune <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> (~12 years ago)</p>



<a name="207176861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176861">(Aug 17 2020 at 18:04)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> oh hello that last one is 4x worse than <span class="user-mention" data-user-id="116122">@simulacrum</span>'s</p>



<a name="207176899"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176899" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176899">(Aug 17 2020 at 18:04)</a>:</h4>
<p>ahhh fun times. ever messed around with 100% deterministic nonsense like I'm struggling with here?</p>



<a name="207176926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176926">(Aug 17 2020 at 18:05)</a>:</h4>
<p>I thought precision also affected counters for user/kernel attribution, but I'm not sure anymore</p>



<a name="207176985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207176985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207176985">(Aug 17 2020 at 18:05)</a>:</h4>
<p>like maybe this is a lost cause, I don't know enough about the actual implementation to be sure, I just know it should theoretically be possible to implement this in a way is 100% exact</p>



<a name="207177179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177179">(Aug 17 2020 at 18:07)</a>:</h4>
<p>the 111 multiples intrigue me, why would there be something divided by 9 anywhere</p>



<a name="207177320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177320">(Aug 17 2020 at 18:08)</a>:</h4>
<p>like it looks like in many cases it's some multiple of <code>1.1111...</code> repeating, aka <code>10/9</code></p>



<a name="207177389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177389">(Aug 17 2020 at 18:08)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> if I try <code>perf stat -e instructions:p echo</code> I see <code>&lt;not supported&gt;      instructions:pu</code></p>



<a name="207177410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177410">(Aug 17 2020 at 18:08)</a>:</h4>
<p>just in case the man page wasn't accurate</p>



<a name="207177741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177741">(Aug 17 2020 at 18:11)</a>:</h4>
<p>it is really interesting that <span class="user-mention" data-user-id="138448">@cuviper</span> and I are seeing radically different (57 vs 220) results on 3800x and 3950x</p>



<a name="207177763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177763">(Aug 17 2020 at 18:11)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> out of interest, what kernel do you have? I have 5.4.0-42-generic</p>



<a name="207177770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177770">(Aug 17 2020 at 18:12)</a>:</h4>
<p>you know why I want to see the 3600 then :)</p>



<a name="207177838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177838">(Aug 17 2020 at 18:12)</a>:</h4>
<p>I could run it on 2700X</p>



<a name="207177857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177857">(Aug 17 2020 at 18:12)</a>:</h4>
<p>the basic <code>instructions</code> is just an arch-neutral alias, but I'm not sure exactly what it maps to. on my i7, <code>perf list</code> has 4 different <code>inst_retired.*</code> counters of increasing precision</p>



<a name="207177864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177864">(Aug 17 2020 at 18:12)</a>:</h4>
<p>3600 is also 62</p>



<a name="207177872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177872">(Aug 17 2020 at 18:12)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I'm on <code>5.7.14-200.fc32.x86_64</code></p>



<a name="207177937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207177937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207177937">(Aug 17 2020 at 18:13)</a>:</h4>
<p>so far I guess we have:</p>
<p>3800x (cuviper): 220 5.7.14-200.fc32.x86_64<br>
3950x (mark): 57 5.4.0-42-generic<br>
3600 (perf.rlo): 62 4.15.0-70-generic<br>
 i7-7700k (cuviper): 880</p>



<a name="207178053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178053">(Aug 17 2020 at 18:14)</a>:</h4>
<blockquote>
<p><code>inst_retired.prec_dist</code> Precise instruction retired event with HW to reduce effect of PEBS shadow in IP distribution (Must be precise)]</p>
</blockquote>



<a name="207178097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178097">(Aug 17 2020 at 18:14)</a>:</h4>
<p>this again seems like it's some IP sampling thing. weird that it has this name tho</p>



<a name="207178231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178231">(Aug 17 2020 at 18:16)</a>:</h4>
<p>and Zen 1 only has <code>ex_ret_instr</code> anyway</p>



<a name="207178552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178552">(Aug 17 2020 at 18:19)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> where do you get 67? I saw 56</p>



<a name="207178564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178564">(Aug 17 2020 at 18:19)</a>:</h4>
<p>you can probably take the minimum</p>



<a name="207178608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178608">(Aug 17 2020 at 18:19)</a>:</h4>
<p>perf.rlo being similar is reassuring</p>



<a name="207178734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178734">(Aug 17 2020 at 18:20)</a>:</h4>
<p>er I think I added 11 or something</p>



<a name="207178788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178788">(Aug 17 2020 at 18:21)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> did you do something to those machines to make them better at this?</p>



<a name="207178805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178805">(Aug 17 2020 at 18:21)</a>:</h4>
<p>or maybe there's less stuff running on them</p>



<a name="207178901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178901">(Aug 17 2020 at 18:22)</a>:</h4>
<p>the 3600 box has:</p>
<div class="codehilite"><pre><span></span><code>kernel.perf_event_paranoid = -1
kernel.randomize_va_space = 0
kernel.nmi_watchdog = 0
</code></pre></div>



<a name="207178939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178939">(Aug 17 2020 at 18:22)</a>:</h4>
<p>hm it might be the nmi watchdog, actually</p>



<a name="207178944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178944">(Aug 17 2020 at 18:22)</a>:</h4>
<p>heh could it be - yeah that</p>



<a name="207178946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178946">(Aug 17 2020 at 18:22)</a>:</h4>
<p>both of my boxes have that off</p>



<a name="207178952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178952">(Aug 17 2020 at 18:23)</a>:</h4>
<p>ahahahaha</p>



<a name="207178971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178971">(Aug 17 2020 at 18:23)</a>:</h4>
<p>I wonder if the 9 is like the number of uops per instruction or something</p>



<a name="207178972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178972">(Aug 17 2020 at 18:23)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> could you test 3800 without nmi watchdog?</p>



<a name="207178976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207178976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207178976">(Aug 17 2020 at 18:23)</a>:</h4>
<p>oh, I haven't changed any of those</p>



<a name="207179083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207179083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207179083">(Aug 17 2020 at 18:24)</a>:</h4>
<p>I think only nmi watchdog should have any effect here</p>



<a name="207179229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207179229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207179229">(Aug 17 2020 at 18:25)</a>:</h4>
<p>hm turning it back on does not seem to change numbers though</p>



<a name="207179247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207179247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207179247">(Aug 17 2020 at 18:25)</a>:</h4>
<p>no change, I'm still at ~222</p>



<a name="207179281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207179281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207179281">(Aug 17 2020 at 18:25)</a>:</h4>
<p><span class="user-mention" data-user-id="310399">@Mara</span> reports increase from 300 to 325 when setting it to 0</p>



<a name="207179282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207179282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207179282">(Aug 17 2020 at 18:25)</a>:</h4>
<p>and is that a mostly idle box?</p>



<a name="207179451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207179451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207179451">(Aug 17 2020 at 18:27)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I <em>think</em> what's happening is that it's parsing <code>1b</code> as a binary literal.</p>



<a name="207179460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207179460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207179460">(Aug 17 2020 at 18:27)</a>:</h4>
<p><span class="user-mention" data-user-id="143274">@Amanieu</span> jfc</p>



<a name="207179624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207179624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207179624">(Aug 17 2020 at 18:28)</a>:</h4>
<p>okay I looked at uops and there's almost exactly 1 per instruction, so the weird 9 isn't coming from there. maybe it's just a factor of 3 and it's something to do with instructions per preemption interval</p>



<a name="207179954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207179954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207179954">(Aug 17 2020 at 18:31)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> <code>sudo chrt -f 99 ./rdpmc-bench</code> doesn't make things better on Ivy Bridge</p>



<a name="207180001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180001">(Aug 17 2020 at 18:32)</a>:</h4>
<p>can't test on the server but presumably <span class="user-mention" data-user-id="116122">@simulacrum</span> can</p>



<a name="207180083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180083">(Aug 17 2020 at 18:33)</a>:</h4>
<p>that made things worse</p>



<a name="207180086"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180086" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180086">(Aug 17 2020 at 18:33)</a>:</h4>
<p>up to 115</p>



<a name="207180130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180130">(Aug 17 2020 at 18:33)</a>:</h4>
<p>okay I guess it kinda did for me too, although it was kinda random</p>



<a name="207180401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180401">(Aug 17 2020 at 18:36)</a>:</h4>
<p>none of the other flags decrease it</p>



<a name="207180576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180576">(Aug 17 2020 at 18:37)</a>:</h4>
<p><code>chrt -f 99</code> pushed me up to ~460</p>



<a name="207180646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180646">(Aug 17 2020 at 18:38)</a>:</h4>
<p><a href="https://man7.org/linux/man-pages/man1/chrt.1.html">https://man7.org/linux/man-pages/man1/chrt.1.html</a></p>



<a name="207180699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180699">(Aug 17 2020 at 18:38)</a>:</h4>
<p>wait I think I wanted <code>sudo chrt -f 1 ./rdpmc-bench</code></p>



<a name="207180732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180732">(Aug 17 2020 at 18:38)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> did you mean the command to add, or remove, scheduling noise?</p>



<a name="207180735"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180735" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180735">(Aug 17 2020 at 18:38)</a>:</h4>
<p>-f 1 gives me 120</p>



<a name="207180807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180807">(Aug 17 2020 at 18:39)</a>:</h4>
<p>is there any way to just never schedule anything on that hardware thread until it's done?</p>



<a name="207180892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180892">(Aug 17 2020 at 18:40)</a>:</h4>
<p>hm is there a perf thing to tell us if we did get descheduled?</p>



<a name="207180916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180916">(Aug 17 2020 at 18:40)</a>:</h4>
<div class="codehilite"><pre><span></span><code> Performance counter stats for &#39;chrt -f 1 ./rdpmc-bench&#39;:

                 1      context-switches
                 0      cpu-migrations

       5.056706532 seconds time elapsed

       5.056689000 seconds user
       0.000000000 seconds sys
</code></pre></div>



<a name="207180918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180918">(Aug 17 2020 at 18:40)</a>:</h4>
<p>oh right I meant to count context switches</p>



<a name="207180932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207180932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207180932">(Aug 17 2020 at 18:41)</a>:</h4>
<p><code>sudo perf stat -e context-switches,cpu-migrations chrt -f 1 ./rdpmc-bench</code></p>



<a name="207181009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181009">(Aug 17 2020 at 18:41)</a>:</h4>
<p>okay so weird, if I remove the chrt I get 57 or so, but I have 233 context switches now</p>



<a name="207181083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181083">(Aug 17 2020 at 18:42)</a>:</h4>
<p>could we be missing increments <em>because</em> we're switching away?</p>



<a name="207181105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181105">(Aug 17 2020 at 18:42)</a>:</h4>
<p>(what are we even counting?)</p>



<a name="207181248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181248">(Aug 17 2020 at 18:43)</a>:</h4>
<p>I'm subtracting the number printed as <code>ecx</code>, and <code>10</code> (which seems to be the constant overhead of <code>rdpmc</code>+surrounding code)</p>



<a name="207181280"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181280" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181280">(Aug 17 2020 at 18:43)</a>:</h4>
<p>I should've been clearer: all the numbers printed should be 0 if the system isn't buggy</p>



<a name="207181574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181574">(Aug 17 2020 at 18:45)</a>:</h4>
<p>does <code>perf</code> just return <code>0</code> for context switches when not running as root?</p>



<a name="207181666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181666">(Aug 17 2020 at 18:46)</a>:</h4>
<p>not for me</p>



<a name="207181734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181734">(Aug 17 2020 at 18:46)</a>:</h4>
<p>you have the paranoid setting changed</p>



<a name="207181751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181751">(Aug 17 2020 at 18:46)</a>:</h4>
<p>ah, perhaps that's why</p>



<a name="207181763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181763">(Aug 17 2020 at 18:46)</a>:</h4>
<div class="codehilite"><pre><span></span><code>               232      context-switches
                 0      cpu-migrations
                 0      sched:sched_kthread_stop
                 0      sched:sched_kthread_stop_ret
               294      sched:sched_waking
               233      sched:sched_wakeup
                 0      sched:sched_wakeup_new
               232      sched:sched_switch
                 1      sched:sched_migrate_task
                 0      sched:sched_process_free
                 1      sched:sched_process_exit
                 0      sched:sched_wait_task
                 0      sched:sched_process_wait
                 0      sched:sched_process_fork
                 1      sched:sched_process_exec
                 0      sched:sched_stat_wait
                 0      sched:sched_stat_sleep
                 0      sched:sched_stat_iowait
                 0      sched:sched_stat_blocked
        2547087692      sched:sched_stat_runtime
                 0      sched:sched_pi_setprio
                 0      sched:sched_process_hang
                 0      sched:sched_move_numa
                 0      sched:sched_stick_numa
                 0      sched:sched_swap_numa
                24      sched:sched_wake_idle_without_ipi
</code></pre></div>



<a name="207181813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181813">(Aug 17 2020 at 18:46)</a>:</h4>
<p>that's on a 57 run without any chrt</p>



<a name="207181878"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181878" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181878">(Aug 17 2020 at 18:47)</a>:</h4>
<p>do you ever see any negative values for the shorter ones?</p>



<a name="207181895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181895">(Aug 17 2020 at 18:47)</a>:</h4>
<p>if scheduling could steal I would expect that to happen sometimes</p>



<a name="207181906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181906">(Aug 17 2020 at 18:47)</a>:</h4>
<p>no</p>



<a name="207181926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181926">(Aug 17 2020 at 18:47)</a>:</h4>
<p>zeroes yes, negative no</p>



<a name="207181928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181928">(Aug 17 2020 at 18:47)</a>:</h4>
<p>this is such a weird problem</p>



<a name="207181944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207181944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207181944">(Aug 17 2020 at 18:47)</a>:</h4>
<p>yeah 0 is correct, anything else is hardware/software bug :P</p>



<a name="207182009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182009">(Aug 17 2020 at 18:48)</a>:</h4>
<p>/me is mad at CPU manufacturers if you can't tell</p>



<a name="207182016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182016">(Aug 17 2020 at 18:48)</a>:</h4>
<p>with chrt:</p>
<div class="codehilite"><pre><span></span><code> Performance counter stats for &#39;chrt -f 99 ./rdpmc-bench&#39;:

                 2      context-switches
                 0      cpu-migrations
                 0      sched:sched_kthread_stop
                 0      sched:sched_kthread_stop_ret
                72      sched:sched_waking
                26      sched:sched_wakeup
                 0      sched:sched_wakeup_new
                 2      sched:sched_switch
                 1      sched:sched_migrate_task
                 0      sched:sched_process_free
                 1      sched:sched_process_exit
                 0      sched:sched_wait_task
                 0      sched:sched_process_wait
                 0      sched:sched_process_fork
                 2      sched:sched_process_exec
                 0      sched:sched_stat_wait
                 0      sched:sched_stat_sleep
                 0      sched:sched_stat_iowait
                 0      sched:sched_stat_blocked
            619517      sched:sched_stat_runtime
                 0      sched:sched_pi_setprio
                 0      sched:sched_process_hang
                 0      sched:sched_move_numa
                 0      sched:sched_stick_numa
                 0      sched:sched_swap_numa
                34      sched:sched_wake_idle_without_ipi
</code></pre></div>



<a name="207182029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182029">(Aug 17 2020 at 18:48)</a>:</h4>
<p>(and 115)</p>



<a name="207182037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182037">(Aug 17 2020 at 18:48)</a>:</h4>
<p>what's the wakeup stuff?</p>



<a name="207182049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182049">(Aug 17 2020 at 18:48)</a>:</h4>
<p>could we get everything down to 0?</p>



<a name="207182065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182065">(Aug 17 2020 at 18:48)</a>:</h4>
<p>it's not described in the docs...</p>



<a name="207182088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182088">(Aug 17 2020 at 18:49)</a>:</h4>
<p>oh dear</p>



<a name="207182114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182114">(Aug 17 2020 at 18:49)</a>:</h4>
<p>I assume it's a kernel function?</p>



<a name="207182239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182239">(Aug 17 2020 at 18:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> googling finds this <a href="https://perfetto.dev/docs/data-sources/cpu-scheduling">https://perfetto.dev/docs/data-sources/cpu-scheduling</a></p>



<a name="207182264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182264">(Aug 17 2020 at 18:50)</a>:</h4>
<p>specifically <a href="https://perfetto.dev/docs/data-sources/cpu-scheduling#scheduling-wakeups-and-latency-analysis">https://perfetto.dev/docs/data-sources/cpu-scheduling#scheduling-wakeups-and-latency-analysis</a></p>



<a name="207182310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182310">(Aug 17 2020 at 18:50)</a>:</h4>
<p>getting a timeline might be interesting heh</p>



<a name="207182407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182407">(Aug 17 2020 at 18:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> wait hang on, that can't be all context-switches, we <em>print</em></p>



<a name="207182431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182431">(Aug 17 2020 at 18:51)</a>:</h4>
<p>so syscall context-switches are missing</p>



<a name="207182446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182446">(Aug 17 2020 at 18:51)</a>:</h4>
<p>I wonder what else might be</p>



<a name="207182518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182518">(Aug 17 2020 at 18:52)</a>:</h4>
<p>although there are no syscalls between two <code>rdpmc</code> samples, and that's intentional</p>



<a name="207182677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182677">(Aug 17 2020 at 18:53)</a>:</h4>
<p>if I am interpreting perf sched output correctly, we're on the CPU pretty much full time?</p>



<a name="207182862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182862">(Aug 17 2020 at 18:54)</a>:</h4>
<p><a href="https://gist.githubusercontent.com/Mark-Simulacrum/a6339a2999d766a52289186478b9d76c/raw/3c81671da9171644c98933f6fbd40529a31b5b55/gistfile1.txt">https://gist.githubusercontent.com/Mark-Simulacrum/a6339a2999d766a52289186478b9d76c/raw/3c81671da9171644c98933f6fbd40529a31b5b55/gistfile1.txt</a></p>



<a name="207182869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207182869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207182869">(Aug 17 2020 at 18:54)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> hmmm, my 333 is "1 instruction every 3 million" and I can see it in the <code>ecx=1000000</code> data (twice as many 0s as 1s), I wonder if that's something that happens every milisecond or so? it's only one instruction per milisecond, roughly</p>



<a name="207183079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207183079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207183079">(Aug 17 2020 at 18:56)</a>:</h4>
<p>you know what would be funny? if this was from the USB frame period</p>



<a name="207183175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207183175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207183175">(Aug 17 2020 at 18:56)</a>:</h4>
<p>"1kHz ground loop accidentally increments CPU performance monitoring counter" sounds like the kind of thing I'd be cursed with</p>



<a name="207183204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207183204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207183204">(Aug 17 2020 at 18:57)</a>:</h4>
<p>(but I doubt it could do that without breaking other stuff)</p>



<a name="207183278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207183278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207183278">(Aug 17 2020 at 18:57)</a>:</h4>
<p>here's a timechart svg <a href="https://gist.github.com/Mark-Simulacrum/f5ad629a3d3dbc8d9705e98bcd08eb89">https://gist.github.com/Mark-Simulacrum/f5ad629a3d3dbc8d9705e98bcd08eb89</a></p>



<a name="207183352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207183352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207183352">(Aug 17 2020 at 18:58)</a>:</h4>
<p><a href="https://gist.githubusercontent.com/Mark-Simulacrum/f5ad629a3d3dbc8d9705e98bcd08eb89/raw/5ed02b00183f60335b372ff04bfede95a0ec0ff9/o.svg">https://gist.githubusercontent.com/Mark-Simulacrum/f5ad629a3d3dbc8d9705e98bcd08eb89/raw/5ed02b00183f60335b372ff04bfede95a0ec0ff9/o.svg</a></p>



<a name="207183485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207183485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207183485">(Aug 17 2020 at 18:59)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> can perf count, like, just hardware interrupts?</p>



<a name="207183500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207183500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207183500">(Aug 17 2020 at 18:59)</a>:</h4>
<p>no idea</p>



<a name="207183968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207183968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207183968">(Aug 17 2020 at 19:02)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so uhh <span class="user-mention" data-user-id="310399">@Mara</span> found this: <code>CONFIG_HZ=300</code></p>



<a name="207184015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184015">(Aug 17 2020 at 19:02)</a>:</h4>
<p>I'm not rebooting for this</p>



<a name="207184017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184017">(Aug 17 2020 at 19:02)</a>:</h4>
<p>she changed my code to also measure time (smart, welp) and it seems to match</p>



<a name="207184038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184038">(Aug 17 2020 at 19:03)</a>:</h4>
<p>yeah me neither</p>



<a name="207184056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184056">(Aug 17 2020 at 19:03)</a>:</h4>
<p>but it's an interesting starting point</p>



<a name="207184100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184100">(Aug 17 2020 at 19:03)</a>:</h4>
<p>so, like, the scheduler parameters only affect what it <em>chooses</em> to do, but the preemption interrupt <em>always</em> fires</p>



<a name="207184545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184545">(Aug 17 2020 at 19:07)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="138448">@cuviper</span> <code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/m-ou-se/c904c59086e013d548b359912fc26467/raw/ac31ae5f0e02927a0213ebefba5565134d9ff6f7/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; ./rdpmc-bench</code></p>



<a name="207184574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184574">(Aug 17 2020 at 19:07)</a>:</h4>
<p>this is <span class="user-mention" data-user-id="310399">@Mara</span>'s variant, which does confirm it's 1kHz on the Zen 1 EPYC I was getting 333 on</p>



<a name="207184618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184618">(Aug 17 2020 at 19:08)</a>:</h4>
<p>also 1kHz on my laptop</p>



<a name="207184653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184653">(Aug 17 2020 at 19:08)</a>:</h4>
<p>54 (213110 μs) = 3946 μs per thing = 253 Hz</p>



<a name="207184714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184714">(Aug 17 2020 at 19:08)</a>:</h4>
<p>and same-ish on 3600</p>



<a name="207184716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184716">(Aug 17 2020 at 19:08)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <code>zgrep HZ /proc/config.gz</code></p>



<a name="207184761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184761">(Aug 17 2020 at 19:09)</a>:</h4>
<p>I don't have that file</p>



<a name="207184769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184769">(Aug 17 2020 at 19:09)</a>:</h4>
<p>huh</p>



<a name="207184794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184794">(Aug 17 2020 at 19:09)</a>:</h4>
<p>what do you have for <code>/proc/config*</code>?</p>



<a name="207184833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184833">(Aug 17 2020 at 19:09)</a>:</h4>
<p>nothing</p>



<a name="207184850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184850">(Aug 17 2020 at 19:09)</a>:</h4>
<p>hmpf</p>



<a name="207184852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184852">(Aug 17 2020 at 19:09)</a>:</h4>
<p>ah it's in /boot for me it seems</p>



<a name="207184986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207184986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207184986">(Aug 17 2020 at 19:11)</a>:</h4>
<p>3600:</p>
<div class="codehilite"><pre><span></span><code>CONFIG_NO_HZ_COMMON=y
# CONFIG_HZ_PERIODIC is not set
CONFIG_NO_HZ_IDLE=y
# CONFIG_NO_HZ_FULL is not set
CONFIG_NO_HZ=y
# CONFIG_HZ_100 is not set
CONFIG_HZ_250=y
# CONFIG_HZ_300 is not set
# CONFIG_HZ_1000 is not set
CONFIG_HZ=250
</code></pre></div>


<p>3950x:</p>
<div class="codehilite"><pre><span></span><code>CONFIG_NO_HZ_COMMON=y
# CONFIG_HZ_PERIODIC is not set
CONFIG_NO_HZ_IDLE=y
# CONFIG_NO_HZ_FULL is not set
CONFIG_NO_HZ=y
# CONFIG_HZ_100 is not set
CONFIG_HZ_250=y
# CONFIG_HZ_300 is not set
# CONFIG_HZ_1000 is not set
CONFIG_HZ=250
</code></pre></div>



<a name="207185012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185012">(Aug 17 2020 at 19:11)</a>:</h4>
<p>lol nice, perfect match</p>



<a name="207185098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185098">(Aug 17 2020 at 19:11)</a>:</h4>
<p>so, we literally miscount almost always only one extra instruction per scheduler interrupt, with I guess a few more here and there? so at least most of the noise from this seems like a bug either in the kernel or in the CPU's interrupt handling</p>



<a name="207185286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185286">(Aug 17 2020 at 19:13)</a>:</h4>
<p>I have <code>CONFIG_NO_HZ=y</code> and <code>CONFIG_HZ=1000</code></p>



<a name="207185317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185317">(Aug 17 2020 at 19:13)</a>:</h4>
<p>I think we should just grep for <code>CONFIG_HZ=</code></p>



<a name="207185335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185335">(Aug 17 2020 at 19:14)</a>:</h4>
<p>the other stuff is how it picked the numerical value</p>



<a name="207185401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185401">(Aug 17 2020 at 19:14)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> and you get around 1000 Hz if you run the modified command?</p>



<a name="207185415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185415">(Aug 17 2020 at 19:14)</a>:</h4>
<p>yes</p>



<a name="207185453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185453">(Aug 17 2020 at 19:15)</a>:</h4>
<p>so all the numbers we were looking at before are not that interesting heh</p>



<a name="207185673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185673">(Aug 17 2020 at 19:17)</a>:</h4>
<p>you know what's funny? if we had a software event for this "every <code>1/CONFIG_HZ</code> seconds" interrupt or w/e it is, we could just subtract that value from the instruction counter and it would improve the quality of the data</p>



<a name="207185837"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185837" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185837">(Aug 17 2020 at 19:18)</a>:</h4>
<p>there surely is a tracepoint for that, at least</p>



<a name="207185983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185983">(Aug 17 2020 at 19:20)</a>:</h4>
<p>one of <code>perf list sched_</code></p>



<a name="207185992"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207185992" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207185992">(Aug 17 2020 at 19:20)</a>:</h4>
<p>(gotta be root / non-paranoid)</p>



<a name="207186067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186067">(Aug 17 2020 at 19:21)</a>:</h4>
<p>ooooh, <code>perf list</code> needs <code>sudo</code> to even see the full list</p>



<a name="207186076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186076">(Aug 17 2020 at 19:21)</a>:</h4>
<p>(maybe only root)</p>



<a name="207186244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186244">(Aug 17 2020 at 19:23)</a>:</h4>
<p>oh wait aren't these what <span class="user-mention" data-user-id="116122">@simulacrum</span> was looking at before?</p>



<a name="207186292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186292">(Aug 17 2020 at 19:23)</a>:</h4>
<p>yeah didn't seem relevant</p>



<a name="207186315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186315">(Aug 17 2020 at 19:23)</a>:</h4>
<p>well, correlated</p>



<a name="207186423"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186423" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186423">(Aug 17 2020 at 19:24)</a>:</h4>
<p>maybe one of the irq events then?</p>



<a name="207186446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186446">(Aug 17 2020 at 19:24)</a>:</h4>
<p>I'll go looking</p>



<a name="207186703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186703">(Aug 17 2020 at 19:27)</a>:</h4>
<p><code>irq:softirq_entry</code> seems to have a relevant value, not sure yet</p>



<a name="207186721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186721">(Aug 17 2020 at 19:27)</a>:</h4>
<p>I guess it counts more than one thing?</p>



<a name="207186904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207186904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207186904">(Aug 17 2020 at 19:29)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> oh I think I found it: <code>timer:hrtimer_expire_entry</code></p>



<a name="207187290"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207187290" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207187290">(Aug 17 2020 at 19:32)</a>:</h4>
<blockquote>
<p>If type is <code>PERF_TYPE_TRACEPOINT</code>, then we are measuring kernel tracepoints.  The value to use in <code>config</code> can be obtained from under debugfs <code>tracing/events/*/*/id</code> if ftrace is enabled in the kernel.</p>
</blockquote>



<a name="207187375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207187375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207187375">(Aug 17 2020 at 19:33)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ sudo cat /sys/kernel/debug/tracing/events/timer/hrtimer_expire_entry/id
367
</code></pre></div>



<a name="207187492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207187492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207187492">(Aug 17 2020 at 19:34)</a>:</h4>
<p>so that's how I'd get a hold of that</p>



<a name="207187716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207187716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207187716">(Aug 17 2020 at 19:37)</a>:</h4>
<p>oh but can we even tie tracepoint events to the core the process is running on?</p>



<a name="207187835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207187835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207187835">(Aug 17 2020 at 19:38)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so I wonder if the best recourse we have for now is CONFIG_HZ=10 or w/e :P</p>



<a name="207187857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207187857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207187857">(Aug 17 2020 at 19:38)</a>:</h4>
<p>I am mildly uncomfortable recompiling kernels for this</p>



<a name="207187866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207187866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207187866">(Aug 17 2020 at 19:38)</a>:</h4>
<p>I guess we can do it later too</p>



<a name="207187896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207187896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207187896">(Aug 17 2020 at 19:39)</a>:</h4>
<p>hmm, is there no way to change this at runtime? I agree, recompiling kernels is unpractical</p>



<a name="207187927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207187927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207187927">(Aug 17 2020 at 19:39)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> may know. I suspect no though.</p>



<a name="207188152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188152">(Aug 17 2020 at 19:41)</a>:</h4>
<p>hmm there's some math I haven't done: <code>44*333</code></p>



<a name="207188161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188161">(Aug 17 2020 at 19:41)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> You cannot change HZ at runtime. And you can't set it to an unsupported value.</p>



<a name="207188181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188181">(Aug 17 2020 at 19:41)</a>:</h4>
<p>oh ugh</p>



<a name="207188213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188213">(Aug 17 2020 at 19:41)</a>:</h4>
<p>You can only set it to 100, 250, 300, or 1000.</p>



<a name="207188293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188293">(Aug 17 2020 at 19:42)</a>:</h4>
<p>If you want to avoid the scheduler here, you want <code>CONFIG_NO_HZ_FULL</code>, which has some caveats documented in <code>Documentation</code>.</p>



<a name="207188298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188298">(Aug 17 2020 at 19:42)</a>:</h4>
<p>so about 14652 instructions are added just by scheduling alone, to my libcore measurements. and the common ± there, for the total, is ~7000. that probably isn't a coincidence</p>



<a name="207188410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188410">(Aug 17 2020 at 19:43)</a>:</h4>
<p>Full nohz means that if a thread has only one process scheduled on it, it'll never be interrupted for scheduling.</p>



<a name="207188432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188432">(Aug 17 2020 at 19:44)</a>:</h4>
<p>cooperative multitasking :D</p>



<a name="207188486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188486">(Aug 17 2020 at 19:44)</a>:</h4>
<p>Single-tasking. ;)</p>



<a name="207188500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188500">(Aug 17 2020 at 19:44)</a>:</h4>
<p>oh wait you mean, like, I can pin a hardware thread to a core and have it not be interrupted at all?</p>



<a name="207188506"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188506" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188506">(Aug 17 2020 at 19:44)</a>:</h4>
<p>Yes!</p>



<a name="207188520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188520">(Aug 17 2020 at 19:44)</a>:</h4>
<p>sweet! thank you so much :D</p>



<a name="207188560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188560">(Aug 17 2020 at 19:45)</a>:</h4>
<p>Take a look in the kernel docs for more info about full nohz.</p>



<a name="207188569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188569">(Aug 17 2020 at 19:45)</a>:</h4>
<p>There are some other steps you have to take to make that work.</p>



<a name="207188578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188578">(Aug 17 2020 at 19:45)</a>:</h4>
<p>(They involve telling the kernel to not do other work on that CPU either.)</p>



<a name="207188599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188599">(Aug 17 2020 at 19:45)</a>:</h4>
<p>But yes, this is exactly what you want.</p>



<a name="207188608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188608">(Aug 17 2020 at 19:45)</a>:</h4>
<p>It's the way to get the least possible jitter.</p>



<a name="207188710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188710">(Aug 17 2020 at 19:46)</a>:</h4>
<blockquote>
<p>This is important for applications with aggressive real-time response constraints because it allows them to improve their worst-case response times by the maximum duration of a scheduling-clock interrupt.</p>
</blockquote>



<a name="207188754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188754">(Aug 17 2020 at 19:47)</a>:</h4>
<p>this is all kinda silly because that extra instruction per interrupt should just not be counted <em>sigh</em></p>



<a name="207188888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188888">(Aug 17 2020 at 19:48)</a>:</h4>
<p>oh you specify with a boot parameter which cores get this behavior. so you can limit it to a handful and schedule the measurement stuff on those</p>



<a name="207188895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188895">(Aug 17 2020 at 19:48)</a>:</h4>
<p>Yes, exactly.</p>



<a name="207188935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188935">(Aug 17 2020 at 19:49)</a>:</h4>
<p>And then make sure that the measurement bits don't compete with each other.</p>



<a name="207188940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188940">(Aug 17 2020 at 19:49)</a>:</h4>
<p>that seems great, we have 48 hardware threads, we could spare 2-4 without affecting most of the system, right?</p>



<a name="207188943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188943">(Aug 17 2020 at 19:49)</a>:</h4>
<p>You need only <em>one</em> process running on a core.</p>



<a name="207188971"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207188971" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207188971">(Aug 17 2020 at 19:49)</a>:</h4>
<p>Yeah, the only thing that'll care will be large compiles. :)</p>



<a name="207189074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189074">(Aug 17 2020 at 19:50)</a>:</h4>
<p>sadly this does seem like it requires a bunch of manual configuration, so you do it to a machine, rather than baking it into a measurement tool</p>



<a name="207189080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189080">(Aug 17 2020 at 19:50)</a>:</h4>
<p>Right.</p>



<a name="207189091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189091">(Aug 17 2020 at 19:50)</a>:</h4>
<p>That's the best you're going to get, though.</p>



<a name="207189102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189102">(Aug 17 2020 at 19:50)</a>:</h4>
<p>Short of running bare-metal. ;)</p>



<a name="207189162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189162">(Aug 17 2020 at 19:51)</a>:</h4>
<p>it doesn't have to be this way, at least not for the 1 instruction per timer interrupt. <span class="user-mention" data-user-id="310399">@Mara</span> suggests there might be a hardcoded value that's off by one, <em>somewhere</em> in the kernel</p>



<a name="207189225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189225">(Aug 17 2020 at 19:51)</a>:</h4>
<p>That wouldn't be <em>shocking</em>, such as if one of the save/restore instructions is itself being counted.</p>



<a name="207189295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189295">(Aug 17 2020 at 19:52)</a>:</h4>
<p>But in the meantime, you might still try this to confirm your hypothesis.</p>



<a name="207189366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189366">(Aug 17 2020 at 19:52)</a>:</h4>
<p>yeah, I'm only barely trying to avoid making this an even bigger rabbit hole than it already is :P</p>



<a name="207189390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189390">(Aug 17 2020 at 19:53)</a>:</h4>
<p>believe it or not, I wanted to optimize the trait system</p>



<a name="207189404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189404">(Aug 17 2020 at 19:53)</a>:</h4>
<p>that's how all of this started</p>



<a name="207189745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207189745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207189745">(Aug 17 2020 at 19:56)</a>:</h4>
<p>I wonder if it's <code>sysret</code>/equivalent, where <em>technically</em> we're back in usermode when that retires, so it's counted?</p>



<a name="207190249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207190249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207190249">(Aug 17 2020 at 20:01)</a>:</h4>
<p>heh, I was thinking something like that too</p>



<a name="207190261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207190261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207190261">(Aug 17 2020 at 20:01)</a>:</h4>
<p>okay so I found this <a href="https://github.com/torvalds/linux/blob/00e4db51259a5f936fec1424b884f029479d3981/kernel/time/hrtimer.c#L1521-L1526">https://github.com/torvalds/linux/blob/00e4db51259a5f936fec1424b884f029479d3981/kernel/time/hrtimer.c#L1521-L1526</a></p>



<a name="207190417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207190417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207190417">(Aug 17 2020 at 20:02)</a>:</h4>
<p><a href="https://github.com/torvalds/linux/blob/00e4db51259a5f936fec1424b884f029479d3981/kernel/time/hrtimer.c#L1730-L1733">https://github.com/torvalds/linux/blob/00e4db51259a5f936fec1424b884f029479d3981/kernel/time/hrtimer.c#L1730-L1733</a></p>



<a name="207190419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207190419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207190419">(Aug 17 2020 at 20:02)</a>:</h4>
<p>I guess that would be <code>iret</code> in this case, but same idea</p>



<a name="207190540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207190540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207190540">(Aug 17 2020 at 20:03)</a>:</h4>
<p>actually hrtimer might not even be it, it could just be this thing here <a href="https://github.com/torvalds/linux/blob/b923f1247b72fc100b87792fd2129d026bb10e66/kernel/time/timer.c#L1715">https://github.com/torvalds/linux/blob/b923f1247b72fc100b87792fd2129d026bb10e66/kernel/time/timer.c#L1715</a></p>



<a name="207190984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207190984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207190984">(Aug 17 2020 at 20:07)</a>:</h4>
<p>why is x86 not on here <a href="https://github.com/torvalds/linux/search?p=1&amp;q=update_process_times&amp;unscoped_q=update_process_times">https://github.com/torvalds/linux/search?p=1&amp;q=update_process_times&amp;unscoped_q=update_process_times</a></p>



<a name="207191167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207191167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207191167">(Aug 17 2020 at 20:08)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> That's for tracking user/system time, not instruction counts, AFAIK.</p>



<a name="207191196"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207191196" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207191196">(Aug 17 2020 at 20:08)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I'm looking for the IRQ handler</p>



<a name="207191884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207191884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207191884">(Aug 17 2020 at 20:15)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> wait, if I can't find it, then it could be that still</p>



<a name="207192074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207192074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207192074">(Aug 17 2020 at 20:17)</a>:</h4>
<p>oh all the IRQ stuff is in here <a href="https://github.com/torvalds/linux/blob/4da9f3302615f4191814f826054846bf843e24fa/arch/x86/entry/entry_64.S">https://github.com/torvalds/linux/blob/4da9f3302615f4191814f826054846bf843e24fa/arch/x86/entry/entry_64.S</a></p>



<a name="207192456"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207192456" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207192456">(Aug 17 2020 at 20:20)</a>:</h4>
<p>so many levels of indirection <a href="https://github.com/torvalds/linux/blob/921d2597abfc05e303f08baa6ead8f9ab8a723e1/arch/x86/include/asm/idtentry.h#L572">https://github.com/torvalds/linux/blob/921d2597abfc05e303f08baa6ead8f9ab8a723e1/arch/x86/include/asm/idtentry.h#L572</a></p>



<a name="207192538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207192538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207192538">(Aug 17 2020 at 20:21)</a>:</h4>
<p>you're in a maze of twisty macros, all alike</p>



<a name="207192585"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207192585" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207192585">(Aug 17 2020 at 20:21)</a>:</h4>
<p>this feels right <a href="https://github.com/torvalds/linux/blob/08bf1a27c4c354b853fd81a79e953525bbcc8506/arch/x86/kernel/irq.c#L226-L263">https://github.com/torvalds/linux/blob/08bf1a27c4c354b853fd81a79e953525bbcc8506/arch/x86/kernel/irq.c#L226-L263</a></p>



<a name="207192669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207192669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207192669">(Aug 17 2020 at 20:22)</a>:</h4>
<p>what exactly are you looking for?</p>



<a name="207192684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207192684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207192684">(Aug 17 2020 at 20:22)</a>:</h4>
<p>something that might be pausing/subtracting the MSRs</p>



<a name="207192768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207192768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207192768">(Aug 17 2020 at 20:23)</a>:</h4>
<p>I think the kernel/user separation is a pure hardware feature, so perf only needs to bother when context switching</p>



<a name="207192954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207192954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207192954">(Aug 17 2020 at 20:25)</a>:</h4>
<p>or if you request more counters than you have hw, I guess it will also mux</p>



<a name="207192960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207192960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207192960">(Aug 17 2020 at 20:25)</a>:</h4>
<p>yeah okay I think there's just no extra code running that I can see. so it must be the damned <code>iret</code> <em>sigh</em></p>



<a name="207193023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207193023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207193023">(Aug 17 2020 at 20:25)</a>:</h4>
<p>which means any interrupts on that core are relevant, not just the timer</p>



<a name="207193037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207193037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207193037">(Aug 17 2020 at 20:26)</a>:</h4>
<p>yeah</p>



<a name="207193251"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207193251" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207193251">(Aug 17 2020 at 20:27)</a>:</h4>
<p>wait can we just count <code>iret</code>s?</p>



<a name="207193889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207193889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207193889">(Aug 17 2020 at 20:32)</a>:</h4>
<p>doesn't look like there's a nice <code>rdpmc</code> counter for <code>iret</code>s :/</p>



<a name="207194095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207194095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207194095">(Aug 17 2020 at 20:34)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> heh at this point it might be easier to just run the process under <code>qemu-user-...</code> or something</p>



<a name="207194176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207194176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207194176">(Aug 17 2020 at 20:35)</a>:</h4>
<p>we ain't patching the CPUs and modifying the kernel seems like a hassle (and nobody else benefits from it without doing the same)</p>



<a name="207197780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207197780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207197780">(Aug 17 2020 at 21:09)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> <span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> oh dear, see section 3.1 <a href="http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=10">http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=10</a></p>



<a name="207197808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207197808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207197808">(Aug 17 2020 at 21:09)</a>:</h4>
<p>as usual, <span class="user-mention" data-user-id="310399">@Mara</span> is finding more things than I am, although I guess I didn't even think too much about searching for it</p>



<a name="207198004"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198004" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198004">(Aug 17 2020 at 21:11)</a>:</h4>
<p>well, good to find prior art, at least</p>



<a name="207198007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198007">(Aug 17 2020 at 21:11)</a>:</h4>
<blockquote>
<p>This interrupt behavior was originally undocumented  when  we  first described  it,  but  now  appears  in  some  vendor documentation.   The  number  of  extra events  is  inherently  unpredictable,  but often can be measured with an additional “hardware interrupts” event that can be used to adjust the total aggregate results.</p>
</blockquote>



<a name="207198239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198239">(Aug 17 2020 at 21:13)</a>:</h4>
<p>section 4 has ideas on how to compensate</p>



<a name="207198365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198365">(Aug 17 2020 at 21:14)</a>:</h4>
<p>I've yet to find a "hardware interrupt" event in <code>perf list</code> though</p>



<a name="207198413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198413">(Aug 17 2020 at 21:15)</a>:</h4>
<p>might not be known by the kernel, have to manually pull out the mask from that pdf</p>



<a name="207198417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198417">(Aug 17 2020 at 21:15)</a>:</h4>
<p>which is a pain :/</p>



<a name="207198537"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198537" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198537">(Aug 17 2020 at 21:16)</a>:</h4>
<p>hmm, there's this I guess:</p>
<blockquote>
<p>The number of far control transfers retired including far call/jump/return, IRET, SYSCALL and SYSRET, plus exceptions and interrupts. Far control transfers are not subject to branch prediction.</p>
</blockquote>



<a name="207198617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198617">(Aug 17 2020 at 21:17)</a>:</h4>
<p>why is "Retired <code>cpuid</code> instructions" in the Load/Store unit lol</p>



<a name="207198761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198761">(Aug 17 2020 at 21:19)</a>:</h4>
<p>I'll look at Ivy Bridge next</p>



<a name="207198863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207198863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207198863">(Aug 17 2020 at 21:20)</a>:</h4>
<p>I think that should be <a href="https://software.intel.com/sites/default/files/managed/8b/6e/335279_performance_monitoring_events_guide.pdf#page=113">https://software.intel.com/sites/default/files/managed/8b/6e/335279_performance_monitoring_events_guide.pdf#page=113</a></p>



<a name="207199993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207199993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207199993">(Aug 17 2020 at 21:37)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> oh it looks like <code>INST_RETIRED.ANY</code> is just an always-on counter, and <code>INST_RETIRED.ANY_P</code> is what <code>instructions:u</code> uses</p>



<a name="207200007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207200007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207200007">(Aug 17 2020 at 21:37)</a>:</h4>
<p>the "p" stands for "programmable"</p>



<a name="207200065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207200065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207200065">(Aug 17 2020 at 21:38)</a>:</h4>
<p>ah</p>



<a name="207200235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207200235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207200235">(Aug 17 2020 at 21:40)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> oooh and "precise" means you can presumably tell it to snapshot the instruction pointer after <em>exactly</em> a specific number of events, which is not somethin we need</p>



<a name="207200478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207200478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207200478">(Aug 17 2020 at 21:43)</a>:</h4>
<p>HARDWARE_INTERRUPTS is limited to... "Knights Corner", which is a Phi uarch?!</p>



<a name="207200580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207200580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207200580">(Aug 17 2020 at 21:44)</a>:</h4>
<p>oh it's called HW_INTERRUPTS on the others</p>



<a name="207200683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207200683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207200683">(Aug 17 2020 at 21:45)</a>:</h4>
<p>Skylake and Kaby Lake should have <code>HW_INTERRUPTS.RECEIVED</code>, weirdly enough there's more counters on Atoms than that</p>



<a name="207200844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207200844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207200844">(Aug 17 2020 at 21:47)</a>:</h4>
<p>anyway, yeah, uhh, <span class="user-mention" data-user-id="123586">@nagisa</span>'s Xeon Gold could work :P</p>



<a name="207200897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207200897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207200897">(Aug 17 2020 at 21:48)</a>:</h4>
<p>what do you want me to run.</p>



<a name="207200959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207200959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207200959">(Aug 17 2020 at 21:49)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> <code>perf list hw_int</code>, although I'm worried you might've said you have an old kernel on it</p>



<a name="207201068"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201068" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201068">(Aug 17 2020 at 21:50)</a>:</h4>
<p>I've been looking for ways to count hardware interrupts in the hopes of subtracting them from the number of retired instructions</p>



<a name="207201111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201111">(Aug 17 2020 at 21:50)</a>:</h4>
<p>or at least confirming that they match up</p>



<a name="207201239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201239">(Aug 17 2020 at 21:52)</a>:</h4>
<p>yeah, that command outputs nothing.</p>



<a name="207201532"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201532" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201532">(Aug 17 2020 at 21:56)</a>:</h4>
<p>oh <span class="user-mention" data-user-id="310399">@Mara</span> was able to get it working on a Coffee lake laptop, it's incredibly close :D</p>



<a name="207201574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201574">(Aug 17 2020 at 21:57)</a>:</h4>
<p>(total extra instructions:u=3061. hw_interrupts.received:u=3059)</p>



<a name="207201676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201676">(Aug 17 2020 at 21:58)</a>:</h4>
<p>so the moral of the story is don’t touch touchpad or the spacebar when benchmarking.</p>



<a name="207201678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201678">(Aug 17 2020 at 21:58)</a>:</h4>
<p>lmao</p>



<a name="207201688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201688">(Aug 17 2020 at 21:58)</a>:</h4>
<p>the scheduler timer is like 1kHz for me anyway</p>



<a name="207201723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201723">(Aug 17 2020 at 21:59)</a>:</h4>
<p>most of the modern kernels use tickless, don't they?</p>



<a name="207201752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201752">(Aug 17 2020 at 22:00)</a>:</h4>
<p>I don't know, you'd have to ask <span class="user-mention" data-user-id="239881">@Josh Triplett</span></p>



<a name="207201823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201823">(Aug 17 2020 at 22:00)</a>:</h4>
<p>but at least for every machine we've tested on, the extra instructions correlate with <code>CONFIG_HZ</code></p>



<a name="207201868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207201868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207201868">(Aug 17 2020 at 22:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> if only Zen had a hardware interrupt counter...</p>



<a name="207202028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207202028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207202028">(Aug 17 2020 at 22:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207201723">said</a>:</p>
<blockquote>
<p>most of the modern kernels use tickless, don't they?</p>
</blockquote>
<p>Most modern kernels use tickless <em>idle</em>. That means they don't wake up if there's no work to do, which makes them sleep in lower power states.</p>



<a name="207202037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207202037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207202037">(Aug 17 2020 at 22:02)</a>:</h4>
<p>Tickless non-idle is much newer, and most distributions don't use it.</p>



<a name="207202059"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207202059" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207202059">(Aug 17 2020 at 22:02)</a>:</h4>
<p>you could set the kernel to configure interrupt thing to not deliver interrupts to certain cores only.</p>



<a name="207202063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207202063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207202063">(Aug 17 2020 at 22:02)</a>:</h4>
<p>That's the <code>CONFIG_NO_HZ_FULL</code> I mentioned above.</p>



<a name="207202097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207202097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207202097">(Aug 17 2020 at 22:03)</a>:</h4>
<p>Ah</p>
<div class="codehilite"><pre><span></span><code>$ cat /proc/config.gz | gzip -d | grep NO_HZ
CONFIG_NO_HZ_COMMON=y
CONFIG_NO_HZ_IDLE=y
# CONFIG_NO_HZ_FULL is not set
CONFIG_NO_HZ=y
</code></pre></div>



<a name="207202104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207202104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207202104">(Aug 17 2020 at 22:03)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> Yeah, interrupt remediation/mitigation helps as well, and I believe nohz_full does some of that.</p>



<a name="207202112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207202112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207202112">(Aug 17 2020 at 22:03)</a>:</h4>
<p>Yup.</p>



<a name="207202121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207202121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207202121">(Aug 17 2020 at 22:03)</a>:</h4>
<p>Most distribution kernels don't use it.</p>



<a name="207202139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207202139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207202139">(Aug 17 2020 at 22:03)</a>:</h4>
<p>It's an improvement for workloads that run one process per logical CPU, and a slight degradation to context switch performance.</p>



<a name="207262956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207262956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207262956">(Aug 18 2020 at 14:04)</a>:</h4>
<p>oh come on, even <code>perf_event_open</code>'s manpage mentions the problem:</p>
<blockquote>
<p><code>PERF_COUNT_HW_INSTRUCTIONS</code> Retired instructions.  Be careful, these can be affected by various issues, most notably hardware interrupt counts.</p>
</blockquote>



<a name="207262985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207262985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207262985">(Aug 18 2020 at 14:05)</a>:</h4>
<p>/me should learn to read</p>



<a name="207263314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207263314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207263314">(Aug 18 2020 at 14:07)</a>:</h4>
<p>okay this is how you'd look up any of the CPU-specific names (basically, might as well use the numbers from the Intel/AMD manuals):</p>
<blockquote>
<p>The <code>libpfm4</code> library can be used to translate from the name in the architectural manuals to the raw hex value <code>perf_event_open()</code> expects in this field.</p>
</blockquote>



<a name="207263726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207263726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207263726">(Aug 18 2020 at 14:10)</a>:</h4>
<p><a href="/user_uploads/4715/eRAU5wMiTOzoAs0xndOOwYqc/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/eRAU5wMiTOzoAs0xndOOwYqc/image.png" title="image.png"><img src="/user_uploads/4715/eRAU5wMiTOzoAs0xndOOwYqc/image.png"></a></div>



<a name="207263761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207263761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207263761">(Aug 18 2020 at 14:11)</a>:</h4>
<p>presumably <code>USR</code> is how it automatically pauses when the kernel is executing</p>



<a name="207264942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207264942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207264942">(Aug 18 2020 at 14:20)</a>:</h4>
<p><code>hw_interrupts.received:u=13257</code></p>



<a name="207264946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207264946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207264946">(Aug 18 2020 at 14:20)</a>:</h4>
<p>wat</p>



<a name="207264991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207264991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207264991">(Aug 18 2020 at 14:20)</a>:</h4>
<p>is this how people find undocumented hardware features??</p>



<a name="207265096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207265096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207265096">(Aug 18 2020 at 14:21)</a>:</h4>
<p>this is on Ivy Bridge, which does not have <code>0x01_cb</code> aka <code>hw_interrupts.received</code></p>



<a name="207265289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207265289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207265289">(Aug 18 2020 at 14:23)</a>:</h4>
<p>(that's the correct number, so it's not just random other counter)</p>



<a name="207265479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207265479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207265479">(Aug 18 2020 at 14:24)</a>:</h4>
<p>why would Intel not document something that has existed since at least Ivy Bridge, until Skylake?</p>



<a name="207266215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207266215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207266215">(Aug 18 2020 at 14:30)</a>:</h4>
<p>if you want to check if a certain Intel CPU has this counter: <code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/b6914ba9b7156f703832737acf9bbc7063001d88/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; ./rdpmc-bench</code></p>



<a name="207266627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207266627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207266627">(Aug 18 2020 at 14:33)</a>:</h4>
<p>sadly, on my Ivy Bridge, either the interrupts counter overcounts, or the instruction counter undercounts. but sometimes everything is just 0 lmao</p>



<a name="207266720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207266720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207266720">(Aug 18 2020 at 14:34)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> <span class="user-mention" data-user-id="138448">@cuviper</span>  ^^ feel free to go ham :D</p>



<a name="207266762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207266762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207266762">(Aug 18 2020 at 14:34)</a>:</h4>
<p>now I'm wondering if Zen has a similarly undocumented counter</p>



<a name="207267080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207267080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207267080">(Aug 18 2020 at 14:37)</a>:</h4>
<blockquote>
<p>PMCx02C [Interrupts Taken] (Core::X86::Pmc::Core::LsIntTaken)</p>
</blockquote>
<p>Not sure if you've looked at that already</p>



<a name="207267098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207267098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207267098">(Aug 18 2020 at 14:37)</a>:</h4>
<p>I guess the name looks like load/store interrupts?</p>



<a name="207267120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207267120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207267120">(Aug 18 2020 at 14:37)</a>:</h4>
<p>wait how did I not find that at all?</p>



<a name="207267150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207267150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207267150">(Aug 18 2020 at 14:37)</a>:</h4>
<p>well, no, it's the LS unit where CPUID retires are also counted</p>



<a name="207267160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207267160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207267160">(Aug 18 2020 at 14:37)</a>:</h4>
<p>(btw you can tell that it's a real counter if at the end you get a count that's roughly the time it took times <code>COUNT_HZ</code>)</p>



<a name="207267634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207267634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207267634">(Aug 18 2020 at 14:41)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> wait, I just realized that "instructions retired" uses the "fixed-function" "instructions retired" counter. I wonder what programmable means then. maybe it's just for the "do something after N events" functionality</p>



<a name="207267914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207267914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207267914">(Aug 18 2020 at 14:43)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> yeah that works lmfao</p>



<a name="207267968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207267968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207267968">(Aug 18 2020 at 14:44)</a>:</h4>
<p>Can you write the fixed function counter? I don't remember.</p>



<a name="207268003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207268003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207268003">(Aug 18 2020 at 14:44)</a>:</h4>
<p><code>perf stat -e r02c:u ./rdpmc-bench</code> on Zen</p>



<a name="207268102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207268102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207268102">(Aug 18 2020 at 14:45)</a>:</h4>
<p>Because sampling works by writing <code>-N</code> into the counter, then taking your sample in the overflow interrupt</p>



<a name="207268106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207268106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207268106">(Aug 18 2020 at 14:45)</a>:</h4>
<p>okay so we have something for AMD and something for Intel, we just now have to use <code>cpuid</code> or w/e to pick which</p>



<a name="207268127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207268127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207268127">(Aug 18 2020 at 14:45)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> ah!!</p>



<a name="207268155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207268155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207268155">(Aug 18 2020 at 14:45)</a>:</h4>
<p>that makes a lot of sense heh</p>



<a name="207268419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207268419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207268419">(Aug 18 2020 at 14:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> okay idk how I missed it, I guess the PDF was too big so I didn't bother searching for "interrupt" and I guess at that time I was looking for <code>iret</code> <em>sigh</em></p>



<a name="207271428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207271428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207271428">(Aug 18 2020 at 15:09)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> <span class="user-mention" data-user-id="123586">@nagisa</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> so these should give interesting results w/o needing <code>rustc</code> or even a new kernel/<code>perf</code>:<br>
Intel: <code>perf stat -e instructions:u,r01cb:u dd if=/dev/zero of=/dev/null bs=1 count=5M</code><br>
AMD: <code>perf stat -e instructions:u,r02c:u dd if=/dev/zero of=/dev/null bs=1 count=5M</code></p>



<a name="207271931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207271931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207271931">(Aug 18 2020 at 15:12)</a>:</h4>
<p>ryzen1:        997,037,101      instructions:u                       415      r02c:u                              1.817760669 seconds time elapsed 0.414737000 seconds user<br>
haswell (touching touchpad):        997,055,202      instructions:u                     4,168      r01cb:u           5.499130405 seconds time elapsed 3.253139000 seconds user                  <br>
haswell (not touching touchpad):        997,054,316      instructions:u                       3,279      r01cb:u            5.480396036 seconds time elapsed 3.270190000 seconds user                 <br>
xeon:        954,496,549      instructions:u                      221      r01cb:u  (real   0m2.781s user   0m0.888s as reported by time)</p>



<a name="207271974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207271974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207271974">(Aug 18 2020 at 15:12)</a>:</h4>
<p>3950x:         1028056259      instructions:u, 60      r02c:u<br>
3600: 1,022,785,182      instructions:u, 241      r02c:u</p>



<a name="207272016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272016">(Aug 18 2020 at 15:12)</a>:</h4>
<p>oh I should've mentioned, "seconds user" are also useful</p>



<a name="207272157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272157">(Aug 18 2020 at 15:13)</a>:</h4>
<p>you sure you want user not total?</p>



<a name="207272174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272174">(Aug 18 2020 at 15:13)</a>:</h4>
<p>since you’re looking at hz ticks</p>



<a name="207272191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272191">(Aug 18 2020 at 15:13)</a>:</h4>
<p>the 4.x kernels don't seem to report seconds user, but total is 1.34 on 3600 and 1.19 on 3950x</p>



<a name="207272193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272193">(Aug 18 2020 at 15:13)</a>:</h4>
<p>yeah, in my tests, the raw counter maps to <code>CONFIG_HZ</code> times "seconds user"</p>



<a name="207272252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272252">(Aug 18 2020 at 15:14)</a>:</h4>
<p>0.316 on 3950x seconds user</p>



<a name="207272301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272301">(Aug 18 2020 at 15:14)</a>:</h4>
<p>that's why it's only 60?</p>



<a name="207272410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272410">(Aug 18 2020 at 15:15)</a>:</h4>
<p>non-1kHz <code>CONFIG_HZ</code> makes this a bit weird but it seems to work :D</p>



<a name="207272442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272442">(Aug 18 2020 at 15:15)</a>:</h4>
<p>updated my message.</p>



<a name="207272600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272600">(Aug 18 2020 at 15:16)</a>:</h4>
<p>the Xeon is <code>CONFIG_HZ=250</code> I bet</p>



<a name="207272631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272631">(Aug 18 2020 at 15:16)</a>:</h4>
<p>no way to verify, no <code>/proc/config</code> on that machine.</p>



<a name="207272647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272647">(Aug 18 2020 at 15:16)</a>:</h4>
<p>anything in <code>/boot</code>?</p>



<a name="207272864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207272864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207272864">(Aug 18 2020 at 15:18)</a>:</h4>
<div class="codehilite"><pre><span></span><code>CONFIG_HZ_250=y
CONFIG_HZ=250
</code></pre></div>


<p>yep</p>



<a name="207273088"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207273088" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207273088">(Aug 18 2020 at 15:19)</a>:</h4>
<p>so both Ivy Bridge and Haswell work despite this being only documented in Skyake (3 generations later, I guess?). do we have anything older? if not I'll just hardcode it to "Ivy Bridge or newer" for Intel and "any Zen" for AMD. and thanks again everyone :D</p>



<a name="207273258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207273258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207273258">(Aug 18 2020 at 15:21)</a>:</h4>
<p>technically I have a Netburst (Pentium 4) at my parents' place but I don't think I ever set up SSH to it properly D:</p>



<a name="207273629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207273629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207273629">(Aug 18 2020 at 15:23)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I just realized that if I use <code>debug!</code>, the messages here won't be usable on nightly (and I don't want to panic, but maybe I should use <code>error!</code> if there's an issue turning the counters on?). and/or is there a way to have <code>RUSTC_LOG</code> turn on a log message without it requiring debug-assertions?</p>



<a name="207273734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207273734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207273734">(Aug 18 2020 at 15:24)</a>:</h4>
<p>info! is always present</p>



<a name="207273746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207273746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207273746">(Aug 18 2020 at 15:24)</a>:</h4>
<p>I have at least one message that always shows up in the "success path" on supported architectures</p>



<a name="207273772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207273772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207273772">(Aug 18 2020 at 15:24)</a>:</h4>
<p>oh right <code>info!</code> doesn't output by default (I think <code>error!</code> does?)</p>



<a name="207273895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207273895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207273895">(Aug 18 2020 at 15:25)</a>:</h4>
<p>thanks, I think I'll use a combination of <code>info!</code> and <code>error!</code>. I especially want people to submit bug reports and have it reach back to the self-profiling WG, ideally all the way back to me, if someone stumbles over a problem with it</p>



<a name="207274493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207274493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207274493">(Aug 18 2020 at 15:30)</a>:</h4>
<p>i7-7700K: 1,022,970,081 instructions:u; 2,580 r01cb:u; 2.537181000 seconds user; 1.567827000 seconds sys<br>
R7 3800X: 1,022,975,044 instructions:u; 267 r02c:u; 0.265782000 seconds user; 0.840306000 seconds sys</p>



<a name="207274523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207274523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207274523">(Aug 18 2020 at 15:30)</a>:</h4>
<p>nice :D</p>



<a name="207274553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207274553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207274553">(Aug 18 2020 at 15:30)</a>:</h4>
<p>(that user time is shocking -- perhaps cpu vulnerability mitigations?)</p>



<a name="207274615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207274615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207274615">(Aug 18 2020 at 15:31)</a>:</h4>
<p>it's also architecturally outdated compared to the AMD one :P</p>



<a name="207274762"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207274762" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207274762">(Aug 18 2020 at 15:32)</a>:</h4>
<p>it's amazing Intel remains competitive for gaming, I think it's almost entirely in frequency and overclocking, to make up for the gap that AMD has created otherwise</p>



<a name="207274847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207274847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207274847">(Aug 18 2020 at 15:32)</a>:</h4>
<p>it's a <em>little</em> outdated, but 10x is extreme</p>



<a name="207275029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275029">(Aug 18 2020 at 15:34)</a>:</h4>
<p>full perf stat shows similar IPC, and AMD is much worse on branch misses (3.64% vs. 0.05%)</p>



<a name="207275192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275192">(Aug 18 2020 at 15:35)</a>:</h4>
<p>and I guess since I want to collect all my stats with both <code>cpuid</code> and subtracting the hardware interrupts, I think I'll finally do the smart thing and have it controlled through env vars or something so I don't have to edit the code manually</p>



<a name="207275497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275497">(Aug 18 2020 at 15:38)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> hey you think we could do the same <code>instructions - hw_ints</code> trick on perf.r-l.o, by passing the right <code>rXXXX</code> to <code>perf</code>?</p>



<a name="207275525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275525">(Aug 18 2020 at 15:38)</a>:</h4>
<p>there's only like 6 counters or so though so we have to be careful</p>



<a name="207275527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275527">(Aug 18 2020 at 15:38)</a>:</h4>
<p>I'd be fine with that</p>



<a name="207275563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275563">(Aug 18 2020 at 15:38)</a>:</h4>
<p>to be honest this is much more worthwhile than the faults counter for example, so I don't mind ditching some of those</p>



<a name="207275604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275604">(Aug 18 2020 at 15:39)</a>:</h4>
<p>I'm a bit worried about the transition and messaging</p>



<a name="207275628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275628">(Aug 18 2020 at 15:39)</a>:</h4>
<p>calling it <code>instructions:u</code> feels a bit misleading because <code>perf -e instructions:u</code> will not give you this</p>



<a name="207275740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275740">(Aug 18 2020 at 15:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207274762">said</a>:</p>
<blockquote>
<p>it's amazing Intel remains competitive for gaming, I think it's almost entirely in frequency and overclocking, to make up for the gap that AMD has created otherwise</p>
</blockquote>
<p>It's mostly latency of cache and memory , that's why Ryzens 2XXX smashed them in benchmarks but lack in gaming. With Ryzens 3XXX this improved drastically.</p>



<a name="207275819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207275819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207275819">(Aug 18 2020 at 15:41)</a>:</h4>
<p>huh I wonder if compile times are also affected. would love to move <a href="http://build.lyken.rs">build.lyken.rs</a> over to Zen 2</p>



<a name="207276024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276024">(Aug 18 2020 at 15:42)</a>:</h4>
<p>definitely are.</p>



<a name="207276048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276048">(Aug 18 2020 at 15:43)</a>:</h4>
<p><code>precise_instructions</code></p>



<a name="207276089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276089">(Aug 18 2020 at 15:43)</a>:</h4>
<p>oh for the name</p>



<a name="207276143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276143">(Aug 18 2020 at 15:44)</a>:</h4>
<p>zen2 is IIRC ~25% faster at compilation than 1. That’s within core. Core-to-core workloads also add some improvement.</p>



<a name="207276229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276229">(Aug 18 2020 at 15:44)</a>:</h4>
<p><code>instructions_minus_ints</code> is what I'd call them I guess idk. maybe unclear</p>



<a name="207276300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276300">(Aug 18 2020 at 15:45)</a>:</h4>
<p>its clear, but as a metric it seems like… it unnecessarily locks in the implementation</p>



<a name="207276358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276358">(Aug 18 2020 at 15:45)</a>:</h4>
<p>I'm worried about keeping the name while changing the implementation, basically</p>



<a name="207276432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276432">(Aug 18 2020 at 15:46)</a>:</h4>
<p>we should probably collect the two metrics separately and only compute the difference at presentation level</p>



<a name="207276445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276445">(Aug 18 2020 at 15:46)</a>:</h4>
<p>(much like what you’d do with metrics systems like prometheus)</p>



<a name="207276448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276448">(Aug 18 2020 at 15:46)</a>:</h4>
<p>oh right derp</p>



<a name="207276485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276485">(Aug 18 2020 at 15:46)</a>:</h4>
<p>this is only a problem for <code>measureme</code> which doesn't want to store twice the data per event</p>



<a name="207276512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276512">(Aug 18 2020 at 15:46)</a>:</h4>
<p><a href="http://perf.rust-lang.org">perf.rust-lang.org</a> could just start measuring <code>hw-interrupts:u</code> or w/e</p>



<a name="207276602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207276602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207276602">(Aug 18 2020 at 15:47)</a>:</h4>
<p>and we could name the rendered thing anything we want</p>



<a name="207279435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207279435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207279435">(Aug 18 2020 at 16:09)</a>:</h4>
<p>wait, for AMD I can just look through all this to find when the counter was added <a href="https://developer.amd.com/resources/developer-guides-manuals/">https://developer.amd.com/resources/developer-guides-manuals/</a></p>



<a name="207280346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207280346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207280346">(Aug 18 2020 at 16:15)</a>:</h4>
<p>uh oh I found "interrupts taken" for AMD going back to "family 11h", whenever that was (document is dated 2008)</p>



<a name="207280691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207280691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207280691">(Aug 18 2020 at 16:18)</a>:</h4>
<p>wait no even 10h has it, and I don't see PDFs for older families</p>



<a name="207281075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207281075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207281075">(Aug 18 2020 at 16:21)</a>:</h4>
<p>10h is K10 from <em>2007</em></p>



<a name="207281853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207281853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207281853">(Aug 18 2020 at 16:28)</a>:</h4>
<p>and we have confirmation that works, with <code>r0cf:u</code> (on family 16h, which is the last one before Zen, and it looks like it's never been changed until Zen)</p>



<a name="207282493"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207282493" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207282493">(Aug 18 2020 at 16:33)</a>:</h4>
<p>wow even Intel admits 6th gen to today (10th gen) is all Skylake and Skylake derivatives, this hasn't been changed since 2018 <a href="https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia32-architectures-performance-monitoring-events.html">https://software.intel.com/content/www/us/en/develop/download/intel-64-and-ia32-architectures-performance-monitoring-events.html</a></p>



<a name="207282623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207282623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207282623">(Aug 18 2020 at 16:34)</a>:</h4>
<p>would love some info on "Cove"s tho, guess I should look at that one set of mobile SoCs that got Cove'd</p>



<a name="207283174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207283174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207283174">(Aug 18 2020 at 16:39)</a>:</h4>
<p>wait, the Intel manuals themselves list the counters too</p>



<a name="207283589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207283589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207283589">(Aug 18 2020 at 16:43)</a>:</h4>
<p>14nm, 14nm+, 14nm++, ...</p>



<a name="207283799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207283799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207283799">(Aug 18 2020 at 16:45)</a>:</h4>
<p>so I found this document, and family 0Fh seems to be the first AMD family to implement AMD64 so I think on x86_64 we have counters for any AMD CPU (sadly it changed its index in Zen) <a href="https://developer.amd.com/wordpress/media/2012/10/325591.pdf">https://developer.amd.com/wordpress/media/2012/10/325591.pdf</a></p>



<a name="207284007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207284007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207284007">(Aug 18 2020 at 16:47)</a>:</h4>
<p>(just confirmed, the old <code>r0cf:u</code> doesn't work in Zen, it's not an alias or anything)</p>



<a name="207285783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207285783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207285783">(Aug 18 2020 at 17:02)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> what gcloud with a new CPU did you say you could spin up? can you run this on it?<br>
<code>perf stat -e instructions:u,r01cb:u dd if=/dev/zero of=/dev/null bs=1 count=5M</code></p>



<a name="207285811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207285811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207285811">(Aug 18 2020 at 17:02)</a>:</h4>
<p>although I may have heard gcloud blocks access to the counters</p>



<a name="207285858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207285858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207285858">(Aug 18 2020 at 17:02)</a>:</h4>
<p>I want to set an upper bound on Intel CPUs because I'm worried they might change the counter index</p>



<a name="207287530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207287530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207287530">(Aug 18 2020 at 17:15)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> actually, if it's Cascade Lake, that's already documented as being the same as Skylake</p>



<a name="207288093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207288093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207288093">(Aug 18 2020 at 17:19)</a>:</h4>
<p>Any counter that's not "architectural" is subject to change</p>



<a name="207288155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207288155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207288155">(Aug 18 2020 at 17:20)</a>:</h4>
<p>ah, thanks</p>



<a name="207288181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207288181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207288181">(Aug 18 2020 at 17:20)</a>:</h4>
<p>I don't think AMD has any equivalent</p>



<a name="207288579"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207288579" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207288579">(Aug 18 2020 at 17:23)</a>:</h4>
<p>and yeah this is not architectural</p>



<a name="207288830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207288830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207288830">(Aug 18 2020 at 17:25)</a>:</h4>
<p>lol, <code>EventSel=CBH,UMask=01H</code> is used as something else on Westmere and Nehalem, so the only one we don't know what it does on is Sandy Bridge</p>



<a name="207289285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207289285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207289285">(Aug 18 2020 at 17:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207266215">said</a>:</p>
<blockquote>
<p>if you want to check if a certain Intel CPU has this counter: <code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/b6914ba9b7156f703832737acf9bbc7063001d88/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; ./rdpmc-bench</code></p>
</blockquote>
<p>oh wait we forgot about scheduling. <code>sudo chrt -f 1 ./rdpmc-bench</code> is almost perfect (but note that the command above is for Intel)</p>



<a name="207289366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207289366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207289366">(Aug 18 2020 at 17:29)</a>:</h4>
<p>or maybe that was a fluke</p>



<a name="207289441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207289441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207289441">(Aug 18 2020 at 17:30)</a>:</h4>
<p>I forget, maybe we want <code>-f 99</code>?</p>



<a name="207289505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207289505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207289505">(Aug 18 2020 at 17:30)</a>:</h4>
<p>nope that's worse</p>



<a name="207290018"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207290018" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207290018">(Aug 18 2020 at 17:34)</a>:</h4>
<p>can look at things in 30 mins</p>



<a name="207290083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207290083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207290083">(Aug 18 2020 at 17:35)</a>:</h4>
<p>did someone here have a Sandy Bridge? I forget</p>



<a name="207290101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207290101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207290101">(Aug 18 2020 at 17:35)</a>:</h4>
<p>there's a cascade lake, sandy bridge is also available on gcp</p>



<a name="207290121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207290121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207290121">(Aug 18 2020 at 17:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207094898">said</a>:</p>
<blockquote>
<p>gcloud has anything from sandy bridge to cascade lake</p>
</blockquote>
<p>ah this is what I remembered</p>



<a name="207290129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207290129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207290129">(Aug 18 2020 at 17:35)</a>:</h4>
<p><a href="https://cloud.google.com/compute/docs/cpu-platforms">https://cloud.google.com/compute/docs/cpu-platforms</a></p>



<a name="207290236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207290236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207290236">(Aug 18 2020 at 17:36)</a>:</h4>
<p>ty</p>



<a name="207290291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207290291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207290291">(Aug 18 2020 at 17:37)</a>:</h4>
<p>I suspect they might not work but if it does, we can validate a decent range</p>



<a name="207290936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207290936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207290936">(Aug 18 2020 at 17:42)</a>:</h4>
<p>ooooh this might explain why intel doesn't even document things past kaby lake: coffee lake even uses the same CPUID family/model numbers as kaby lake: <a href="https://en.wikichip.org/wiki/intel/cpuid#Big_Cores_.28Client.29">https://en.wikichip.org/wiki/intel/cpuid#Big_Cores_.28Client.29</a></p>



<a name="207291882"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207291882" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207291882">(Aug 18 2020 at 17:50)</a>:</h4>
<p>somehow I missed that this has a proper categorization which includes telling me which lakes are actually coves (because Intel hates reason): <a href="https://en.wikipedia.org/wiki/Template:Intel_processors">https://en.wikipedia.org/wiki/Template:Intel_processors</a></p>



<a name="207291922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207291922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207291922">(Aug 18 2020 at 17:50)</a>:</h4>
<p>huh, both report perf counters as <code>&lt;not supported&gt;</code> I wonder if you just can’t use perf counters on gcp?</p>



<a name="207291957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207291957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207291957">(Aug 18 2020 at 17:51)</a>:</h4>
<p><em>sigh</em> that's what danopia saw too, on GCE, I was hoping it was different here</p>



<a name="207291995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207291995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207291995">(Aug 18 2020 at 17:51)</a>:</h4>
<p>lemme see if I can spin up actual hardware backed stuff...</p>



<a name="207292200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207292200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207292200">(Aug 18 2020 at 17:53)</a>:</h4>
<p>found someone with sandy bridge :D</p>



<a name="207292568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207292568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207292568">(Aug 18 2020 at 17:56)</a>:</h4>
<p>they are probably disabled for security concerns on GCE, for timing attacks and such</p>



<a name="207292626"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207292626" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207292626">(Aug 18 2020 at 17:56)</a>:</h4>
<p>and it works! basically Intel has added a hw interrupts counter in Sandy Bridge but didn't tell anyone until Skylake...</p>



<a name="207296905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207296905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207296905">(Aug 18 2020 at 18:31)</a>:</h4>
<p>should've just looked here, heh, I should be able to get some data out of it: <a href="https://github.com/wcohen/libpfm4">https://github.com/wcohen/libpfm4</a></p>



<a name="207297243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207297243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207297243">(Aug 18 2020 at 18:34)</a>:</h4>
<p>nice <a href="https://github.com/wcohen/libpfm4/tree/master/lib/events">https://github.com/wcohen/libpfm4/tree/master/lib/events</a></p>



<a name="207297624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207297624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207297624">(Aug 18 2020 at 18:37)</a>:</h4>
<p>it's missing <code>INTERRUPT_TAKEN</code> on Zen 1 (it has it for Zen 2) but I thought that was documented?</p>



<a name="207308901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207308901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207308901">(Aug 18 2020 at 20:04)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> <span class="user-mention" data-user-id="138448">@cuviper</span> btw for all Intel CPUs we've confirmed the counter (especially if pre-Skylake, i.e. undocumented), <code>cat /proc/cpuinfo | head -n5</code> would be useful (I decided to track whether we've confirmed through testing that a certain model has the counter)</p>
<p>i.e. systems we've ran <code>perf stat -e instructions:u,r01cb:u dd if=/dev/zero of=/dev/null bs=1 count=5M</code> on and the second counter roughly matches "user time" by some factor</p>



<a name="207309176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207309176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207309176">(Aug 18 2020 at 20:06)</a>:</h4>
<div class="codehilite"><pre><span></span><code>processor       : 0
vendor_id       : GenuineIntel
cpu family      : 6
model           : 158
model name      : Intel(R) Core(TM) i7-7700K CPU @ 4.20GHz
</code></pre></div>



<a name="207309198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207309198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207309198">(Aug 18 2020 at 20:07)</a>:</h4>
<p>gave you 5 lines to include the name :)</p>



<a name="207309214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207309214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207309214">(Aug 18 2020 at 20:07)</a>:</h4>
<p>yeah I meant to write 5 oops</p>



<a name="207309897"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207309897" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207309897">(Aug 18 2020 at 20:12)</a>:</h4>
<p>here's a haswell xeon: 1,028,004,226 instructions:u; 3,277 r01cb:u; 3.272502000 seconds user; 2.111821000 seconds sys</p>
<div class="codehilite"><pre><span></span><code>processor       : 0
vendor_id       : GenuineIntel
cpu family      : 6
model           : 63
model name      : Intel(R) Xeon(R) CPU E5-2697 v3 @ 2.60GHz
</code></pre></div>



<a name="207310439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207310439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207310439">(Aug 18 2020 at 20:16)</a>:</h4>
<p>The counter is a bit higher on my laptop:<br>
1,038,458,363 instructions:u; 3,426 r01cb:u; 2.986509000 seconds user; 2.400569000 seconds sys</p>
<div class="codehilite"><pre><span></span><code>processor       : 0
vendor_id       : GenuineIntel
cpu family      : 6
model           : 142
model name      : Intel(R) Core(TM) i7-7600U CPU @ 2.80GHz
</code></pre></div>



<a name="207310475"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207310475" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207310475">(Aug 18 2020 at 20:16)</a>:</h4>
<p>the important thing is that it's not 0 or otherwise completely uncorrelated</p>



<a name="207310540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207310540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207310540">(Aug 18 2020 at 20:17)</a>:</h4>
<p>we're counting interrupts, and if you're unlucky enough you could get almost all hardware interrupts from everything on the system</p>



<a name="207310981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207310981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207310981">(Aug 18 2020 at 20:21)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> btw, Fedora and RHEL/CentOS kernels <em>do</em> have <code>CONFIG_NO_HZ_FULL=y</code></p>



<a name="207311040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311040">(Aug 18 2020 at 20:22)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> Oooh!</p>



<a name="207311098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311098">(Aug 18 2020 at 20:22)</a>:</h4>
<p>lol "Crystal Well" <a href="https://ark.intel.com/content/www/us/en/ark/products/83505/intel-core-i7-4770hq-processor-6m-cache-up-to-3-40-ghz.html">https://ark.intel.com/content/www/us/en/ark/products/83505/intel-core-i7-4770hq-processor-6m-cache-up-to-3-40-ghz.html</a></p>



<a name="207311110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311110">(Aug 18 2020 at 20:22)</a>:</h4>
<p>(this is one of <span class="user-mention" data-user-id="310399">@Mara</span>'s)</p>



<a name="207311112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311112">(Aug 18 2020 at 20:22)</a>:</h4>
<p>That's a massive endorsement, especially the latter (given how conservative RHEL tends to be).</p>



<a name="207311150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311150">(Aug 18 2020 at 20:22)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> Thanks for letting me know! I need to give that a try myself.</p>



<a name="207311208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311208">(Aug 18 2020 at 20:23)</a>:</h4>
<p>I'm trying to find when that changed. there's a feature page for <code>CONFIG_NO_HZ</code> way back in Fedora 8, but not sure about full yet</p>



<a name="207311368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311368">(Aug 18 2020 at 20:24)</a>:</h4>
<p>I'm guessing you don't actually enable <code>nohz_full</code> on the kernel command line by default, so this would mostly just have an effect if people enable it?</p>



<a name="207311411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311411">(Aug 18 2020 at 20:24)</a>:</h4>
<p>I'm not sure, I just noticed it in the config file</p>



<a name="207311446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311446">(Aug 18 2020 at 20:24)</a>:</h4>
<p>there's nothing on <code>/proc/cmdline</code></p>



<a name="207311803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311803">(Aug 18 2020 at 20:27)</a>:</h4>
<p>bah, there's an article behind the subscriber paywall... <a href="https://access.redhat.com/solutions/2273531">https://access.redhat.com/solutions/2273531</a></p>



<a name="207311943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207311943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207311943">(Aug 18 2020 at 20:28)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span><br>
haswell:</p>
<div class="codehilite"><pre><span></span><code> processor  : 0
vendor_id   : GenuineIntel
cpu family  : 6
model       : 70
model name  : Intel(R) Core(TM) i7-4750HQ CPU @ 2.00GHz
</code></pre></div>


<p>xeon:</p>
<div class="codehilite"><pre><span></span><code>processor   : 0
vendor_id   : GenuineIntel
cpu family  : 6
model       : 85
model name  : Intel(R) Xeon(R) Gold 6130 CPU @ 2.10GHz
</code></pre></div>



<a name="207312389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207312389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207312389">(Aug 18 2020 at 20:31)</a>:</h4>
<p>well that article is mostly just explaining how to use <code>nohz_full</code></p>



<a name="207312463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207312463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207312463">(Aug 18 2020 at 20:32)</a>:</h4>
<p>but it seems we've supported this since RHEL 7</p>



<a name="207312900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207312900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207312900">(Aug 18 2020 at 20:36)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> <span class="user-mention" data-user-id="123586">@nagisa</span> thanks, I'll try to put together everything</p>



<a name="207313021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207313021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207313021">(Aug 18 2020 at 20:37)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> in Fedora sources, it looks like we enable <code>CONFIG_NO_HZ_FULL=y</code> for all but s390x and i686</p>



<a name="207313075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207313075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207313075">(Aug 18 2020 at 20:37)</a>:</h4>
<p>not sure why those are excluded, but you might want to find out if you're going explore this for Debian</p>



<a name="207314347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207314347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207314347">(Aug 18 2020 at 20:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> the good news is that we can combine the two techniques, and avoid scheduling making this worse</p>



<a name="207314371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207314371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207314371">(Aug 18 2020 at 20:49)</a>:</h4>
<p>I assume that if the timer interrupt schedules a different process, we're overcounting <em>relevant</em> interrupts</p>



<a name="207315029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207315029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207315029">(Aug 18 2020 at 20:54)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="138448">@cuviper</span> I wonder if I can combine <code>chrt</code> and <code>perf</code></p>



<a name="207315058"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207315058" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207315058">(Aug 18 2020 at 20:54)</a>:</h4>
<p>playing around with <code>sudo perf stat -e 'sched:*' ./rdpmc-bench</code> some values look relevant but I'm not sure</p>



<a name="207315110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207315110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207315110">(Aug 18 2020 at 20:55)</a>:</h4>
<p>I managed to do it by nesting chrt inside perf</p>



<a name="207315128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207315128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207315128">(Aug 18 2020 at 20:55)</a>:</h4>
<p>i.e., <code>perf stat -e ... chrt .. rdpmc-bench</code></p>



<a name="207315340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207315340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207315340">(Aug 18 2020 at 20:57)</a>:</h4>
<p>looks like it worked</p>



<a name="207315723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207315723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207315723">(Aug 18 2020 at 21:00)</a>:</h4>
<p>uh oh I broke my wifi with <code>chrt -f 99</code></p>



<a name="207315831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207315831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207315831">(Aug 18 2020 at 21:01)</a>:</h4>
<p>why did it seem not to work before huh</p>



<a name="207315880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207315880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207315880">(Aug 18 2020 at 21:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207315723">said</a>:</p>
<blockquote>
<p>uh oh I broke my wifi with <code>chrt -f 99</code></p>
</blockquote>
<p>One of the things real-time systems need to do is move things to other CPUs. Usually you want to dedicate at least 1-2 CPUs for doing non-real-time things, and make sure all the interrupts go there.</p>



<a name="207316115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207316115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207316115">(Aug 18 2020 at 21:03)</a>:</h4>
<p><a href="/user_uploads/4715/nYeUe194M5Nb418pEE2jUUWx/IMG_20200819_000226.jpg">IMG_20200819_000226.jpg</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/nYeUe194M5Nb418pEE2jUUWx/IMG_20200819_000226.jpg" title="IMG_20200819_000226.jpg"><img src="/user_uploads/4715/nYeUe194M5Nb418pEE2jUUWx/IMG_20200819_000226.jpg"></a></div>



<a name="207316147"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207316147" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207316147">(Aug 18 2020 at 21:03)</a>:</h4>
<p>totally worth it</p>



<a name="207316688"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207316688" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207316688">(Aug 18 2020 at 21:08)</a>:</h4>
<p>I get why it broke but I wish it was smarter than that <em>sigh</em></p>



<a name="207316754"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207316754" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207316754">(Aug 18 2020 at 21:09)</a>:</h4>
<p>also it seems to have lost the ability to connect at all?</p>



<a name="207317098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207317098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207317098">(Aug 18 2020 at 21:12)</a>:</h4>
<p><code>sudo rmmod iwldvm; sudo rmmod iwlwifi; sudo modprobe iwldvm</code> fixed my wifi :D</p>



<a name="207317333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207317333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207317333">(Aug 18 2020 at 21:13)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> really surprised it doesn't automatically schedule high-priority stuff on non-device-interrupt cores</p>



<a name="207349382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207349382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207349382">(Aug 18 2020 at 22:25)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> It doesn't know what's important to you. You can set the priority of those kernel threads yourself, and many people do. Sometimes those kernel threads are critical for your real-time workload.</p>



<a name="207349398"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207349398" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207349398">(Aug 18 2020 at 22:25)</a>:</h4>
<p>alright, thanks</p>



<a name="207349432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207349432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207349432">(Aug 18 2020 at 22:25)</a>:</h4>
<p>There are kernel options that <em>should</em> move all of those threads off the cores you specify.</p>



<a name="207366777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207366777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207366777">(Aug 19 2020 at 03:26)</a>:</h4>
<p>oh hey I finally found where "Ice Lake (Client)" is documented</p>



<a name="207366785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207366785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207366785">(Aug 19 2020 at 03:26)</a>:</h4>
<p><a href="/user_uploads/4715/hnN_9kfAN239NSlLSncQfAB-/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/hnN_9kfAN239NSlLSncQfAB-/image.png" title="image.png"><img src="/user_uploads/4715/hnN_9kfAN239NSlLSncQfAB-/image.png"></a></div>



<a name="207366920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207366920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207366920">(Aug 19 2020 at 03:30)</a>:</h4>
<p>uh oh that's worrying, Intel doesn't list any interrupt-related events for Ice Lake :(</p>



<a name="207366938"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207366938" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207366938">(Aug 19 2020 at 03:31)</a>:</h4>
<p>I hope that's just them not documenting it again</p>



<a name="207366946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207366946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207366946">(Aug 19 2020 at 03:31)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> its such a basic functionality that I'd be surprised if it didn't exist.</p>



<a name="207366991"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207366991" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207366991">(Aug 19 2020 at 03:32)</a>:</h4>
<p>yeah Intel are being weird about it. I already don't trust them to document it given it's been around since Sandy Bridge and is undocumented until Skylake</p>



<a name="207366995"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207366995" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207366995">(Aug 19 2020 at 03:32)</a>:</h4>
<p>and these are documents that refer to Ice Lake so it's not like they couldn't have updated them :/</p>



<a name="207367024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207367024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207367024">(Aug 19 2020 at 03:33)</a>:</h4>
<p>interestingly, "Ice Lake (Server)" isn't documented in the same way (and the Xeon SP docs only include "Family 6 Model 85")</p>



<a name="207367809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207367809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207367809">(Aug 19 2020 at 03:55)</a>:</h4>
<p>finally found what I was looking for: "Specification update" documents here: <a href="https://www.intel.com/content/www/us/en/products/docs/processors/core/core-technical-resources.html">https://www.intel.com/content/www/us/en/products/docs/processors/core/core-technical-resources.html</a></p>



<a name="207368188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207368188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207368188">(Aug 19 2020 at 04:05)</a>:</h4>
<p>hmm but that doesn't indicate that the manuals need to be updated for the new CPUID models. and neither does this: <a href="https://software.intel.com/content/dam/develop/public/us/en/documents/252046-sdm-change-document.pdf">https://software.intel.com/content/dam/develop/public/us/en/documents/252046-sdm-change-document.pdf</a></p>



<a name="207368395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207368395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207368395">(Aug 19 2020 at 04:12)</a>:</h4>
<p><a href="/user_uploads/4715/iPYpqOK4tkId7HoBNLaQ8KyM/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/iPYpqOK4tkId7HoBNLaQ8KyM/image.png" title="image.png"><img src="/user_uploads/4715/iPYpqOK4tkId7HoBNLaQ8KyM/image.png"></a></div>



<a name="207368433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207368433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207368433">(Aug 19 2020 at 04:12)</a>:</h4>
<p>well, this is a start :)</p>



<a name="207368602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207368602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207368602">(Aug 19 2020 at 04:17)</a>:</h4>
<p>they updated that, and a single MSRs table, but nothing else, to include Comet Lake</p>



<a name="207369883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207369883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207369883">(Aug 19 2020 at 04:43)</a>:</h4>
<p>and ofc it takes me ages to find this: <a href="https://download.01.org/perfmon/index/">https://download.01.org/perfmon/index/</a></p>



<a name="207370057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207370057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207370057">(Aug 19 2020 at 04:47)</a>:</h4>
<p>... which isn't more updated either</p>



<a name="207370234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207370234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207370234">(Aug 19 2020 at 04:50)</a>:</h4>
<p>Intel is so lazy with Skylake it doesn't even update the data anymore...</p>



<a name="207372232"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207372232" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207372232">(Aug 19 2020 at 05:39)</a>:</h4>
<p><a href="https://gist.github.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/revisions#diff-803b16a97a87f5fb019400650f9f8e64R335-R355">https://gist.github.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/revisions#diff-803b16a97a87f5fb019400650f9f8e64R335-R355</a></p>



<a name="207372324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207372324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207372324">(Aug 19 2020 at 05:41)</a>:</h4>
<p>so I got a perfect run for whatever reason</p>



<a name="207372327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207372327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207372327">(Aug 19 2020 at 05:41)</a>:</h4>
<p>after which I ran this on the Zen 1 EPYC server which perfectly auto-detected and produced a perfect run too :D <code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/855f6e0b9b797313c0d767a57981b6bdb84294d4/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; ./rdpmc-bench</code></p>



<a name="207372419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207372419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207372419">(Aug 19 2020 at 05:43)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I kid you not I can't get the server to output  anything other than 0s <span aria-label="shock" class="emoji emoji-1f628" role="img" title="shock">:shock:</span></p>



<a name="207372713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207372713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207372713">(Aug 19 2020 at 05:51)</a>:</h4>
<p>I guess I never tested this on there? until now? and my laptop has way more scheduling noise etc.</p>



<a name="207373993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207373993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207373993">(Aug 19 2020 at 06:22)</a>:</h4>
<p>That doesn't surprise me. Laptops have a lot going on.</p>



<a name="207373998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207373998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207373998">(Aug 19 2020 at 06:22)</a>:</h4>
<p>I'm much more surprised by the server always saying 0</p>



<a name="207374006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374006">(Aug 19 2020 at 06:22)</a>:</h4>
<p>(as opposed to just having lower noise)</p>



<a name="207374021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374021">(Aug 19 2020 at 06:23)</a>:</h4>
<p>Also, yes, spec updates and other notes are much much more up to date than the main manuals, which don't get updated the way you might hope they would.</p>



<a name="207374028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374028">(Aug 19 2020 at 06:23)</a>:</h4>
<p>Especially for non-architectural stuff.</p>



<a name="207374038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374038">(Aug 19 2020 at 06:23)</a>:</h4>
<p>sadly the spec update is still incomplete, the relevant chapter didn't get updated at all</p>



<a name="207374039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374039">(Aug 19 2020 at 06:23)</a>:</h4>
<p>(Yeah, zero noise surprises me.)</p>



<a name="207374107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374107">(Aug 19 2020 at 06:25)</a>:</h4>
<p>like all Intel needs to do is add the codename and the one or two CPUID Family,Model pairs in one place, and it just didn't bother to</p>



<a name="207374127"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374127" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374127">(Aug 19 2020 at 06:25)</a>:</h4>
<p>just to clarify that nothing has changed. like they've done in the past up-to-and-including Coffee Lake</p>



<a name="207374134"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374134" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374134">(Aug 19 2020 at 06:25)</a>:</h4>
<p>they just... gave up after that lol</p>



<a name="207374601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374601">(Aug 19 2020 at 06:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so accounting for hardware interrupts has a fascinating effect on rustc queries: it basically doubles the number of them that have exactly 0 variance. but the worst-case noise is worse</p>



<a name="207374854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374854">(Aug 19 2020 at 06:41)</a>:</h4>
<p>not much worse though I guess</p>



<a name="207374904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207374904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207374904">(Aug 19 2020 at 06:42)</a>:</h4>
<p>(roughly doubled? I don't remember exactly for the server though)</p>



<a name="207375021"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207375021" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207375021">(Aug 19 2020 at 06:44)</a>:</h4>
<p>the total doesn't get denoised by a lot, which I think makes sense, it's impacted mostly by the few large queries.</p>



<a name="207423377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207423377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207423377">(Aug 19 2020 at 15:33)</a>:</h4>
<p>hmm so on the server I see <code>hw_interrupts:u</code> variance of about ±333, for runs of ±5k to ±8k <code>instructions:u</code></p>



<a name="207423399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207423399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207423399">(Aug 19 2020 at 15:33)</a>:</h4>
<p>(i.e. my "<code>rustc</code> compiling libcore in check mode" runs)</p>



<a name="207423504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207423504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207423504">(Aug 19 2020 at 15:34)</a>:</h4>
<p>so it can account for some of the smaller queries but not most of the whole process</p>



<a name="207423801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207423801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207423801">(Aug 19 2020 at 15:36)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> is there yet some sort of flamegraph (or <code>crox</code>) "diff" mode? since the events should be deterministic, I'm curious of the distribution of the variance over the runtime of the process</p>



<a name="207423840"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207423840" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207423840">(Aug 19 2020 at 15:37)</a>:</h4>
<p>No, there's not.</p>



<a name="207423942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207423942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207423942">(Aug 19 2020 at 15:37)</a>:</h4>
<p>I get <code>"analysis": 36.5,</code> and <code>"analysis": 7.5,</code> for two groups of 10 runs that I did with the latest code, let me see what it looks like before</p>



<a name="207424065"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207424065" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207424065">(Aug 19 2020 at 15:38)</a>:</h4>
<p>ah not incredibly better, it was already <code>"analysis": 13,</code> before (<strong>EDIT</strong>: <code>"analysis": 119.5,</code> with <code>cpuid</code>)</p>



<a name="207424081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207424081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207424081">(Aug 19 2020 at 15:39)</a>:</h4>
<p>oh but that's self time /facepalm. I want to look at total times</p>



<a name="207424590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207424590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207424590">(Aug 19 2020 at 15:43)</a>:</h4>
<p>Variance of totals (<em>not</em> "self" counts)</p>
<ul>
<li>before: <code>"analysis": 22510.5,</code></li>
<li>after: <code>"analysis": 6729,</code>, <code>"analysis": 4325,</code></li>
</ul>



<a name="207424637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207424637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207424637">(Aug 19 2020 at 15:43)</a>:</h4>
<p>so it is better, but only around 5x</p>



<a name="207424775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207424775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207424775">(Aug 19 2020 at 15:44)</a>:</h4>
<p>I wonder if I could "zip" the crox output somehow</p>



<a name="207424806"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207424806" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207424806">(Aug 19 2020 at 15:44)</a>:</h4>
<p>or actually, can <code>crox</code> take multiple profiles in?</p>



<a name="207424861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207424861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207424861">(Aug 19 2020 at 15:45)</a>:</h4>
<div class="codehilite"><pre><span></span><code>OPTIONS:
        --dir &lt;dir&gt;
            all event trace files in dir will be merged to one chrome_profiler.json file
</code></pre></div>



<a name="207424869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207424869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207424869">(Aug 19 2020 at 15:45)</a>:</h4>
<p>yes yes yes :D</p>



<a name="207431895"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207431895" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207431895">(Aug 19 2020 at 16:44)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I plan to use <a href="http://www.brendangregg.com/blog/2014-11-09/differential-flame-graphs.html">http://www.brendangregg.com/blog/2014-11-09/differential-flame-graphs.html</a> on the website (probably adding a diff mode to measureme's flamegraph tooling)</p>



<a name="207431930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207431930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207431930">(Aug 19 2020 at 16:44)</a>:</h4>
<p>inferno already supports it so just need to make use of that</p>



<a name="207434271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207434271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207434271">(Aug 19 2020 at 17:03)</a>:</h4>
<p>oh... yeah that'd be great (I'd use variance across a set of runs rather than difference between two runs tho). although I think I don't want a flamegraph, or at least not one that collapses any two events together (i.e. I want all the original call stacks)</p>



<a name="207440990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207440990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207440990">(Aug 19 2020 at 18:00)</a>:</h4>
<p>yeah that's poorly supported by most tooling, and crox/chromium dev tools is the only thing I've found that will render things</p>



<a name="207441029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441029">(Aug 19 2020 at 18:00)</a>:</h4>
<p>I failed to find an easy way to just produce html files with bundled JS and such that'll do what the chrome dev tools perf tab does</p>



<a name="207441063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441063">(Aug 19 2020 at 18:01)</a>:</h4>
<p>eternaleye was telling me you can "just" disable collapsing</p>



<a name="207441111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441111">(Aug 19 2020 at 18:01)</a>:</h4>
<p>like that it's mostly a generator side choice</p>



<a name="207441129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441129">(Aug 19 2020 at 18:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> Have you seen <a href="https://github.com/jlfwong/speedscope">https://github.com/jlfwong/speedscope</a>?</p>



<a name="207441155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441155">(Aug 19 2020 at 18:01)</a>:</h4>
<p>I think you can even pass it a url to load</p>



<a name="207441165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441165">(Aug 19 2020 at 18:01)</a>:</h4>
<p>you can, but e.g. inferno sort of collapses anyway</p>



<a name="207441231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441231">(Aug 19 2020 at 18:02)</a>:</h4>
<p><a href="https://github.com/jonhoo/inferno/issues/185">https://github.com/jonhoo/inferno/issues/185</a></p>



<a name="207441248"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441248" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441248">(Aug 19 2020 at 18:02)</a>:</h4>
<p>Oh yeah, I meant for the crox data</p>



<a name="207441376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441376">(Aug 19 2020 at 18:03)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> yeah speedscope looks pretty good! I might take a stab at getting urls to that to just happen on perf.rlo</p>



<a name="207441407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441407">(Aug 19 2020 at 18:03)</a>:</h4>
<p>that said I need to fix the crox stuff to stream JSON to the client rather than buffering in memory :/</p>



<a name="207441590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441590">(Aug 19 2020 at 18:05)</a>:</h4>
<p>It looks like we need to configure some CORS headers or something so the web app can load the file via ajax</p>



<a name="207441879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441879">(Aug 19 2020 at 18:07)</a>:</h4>
<p>that's not a problem, we already do that -- I was playing with firefox profiling tooling <a href="https://profiler.firefox.com/">https://profiler.firefox.com/</a></p>



<a name="207441935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207441935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207441935">(Aug 19 2020 at 18:07)</a>:</h4>
<p>(currently though just the <a href="https://profiler.firefox.com/">https://profiler.firefox.com/</a> domain can load from us though)</p>



<a name="207445310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445310">(Aug 19 2020 at 18:38)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so I switched it to do syscalls in a loop: <code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/bd2a6a125c1e32c515b9bdc1f0997326883ed4fc/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; ./rdpmc-bench</code></p>



<a name="207445359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445359">(Aug 19 2020 at 18:38)</a>:</h4>
<p>all zeroes</p>



<a name="207445388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445388">(Aug 19 2020 at 18:39)</a>:</h4>
<p>did you try the previous one from last night btw?</p>



<a name="207445389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445389">(Aug 19 2020 at 18:39)</a>:</h4>
<p>rdpmc-bench instructions:u=444517581 hw_interrupts.received:u=344</p>



<a name="207445407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445407">(Aug 19 2020 at 18:39)</a>:</h4>
<p>hm I think no?</p>



<a name="207445441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445441">(Aug 19 2020 at 18:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207372327">said</a>:</p>
<blockquote>
<p>after which I ran this on the Zen 1 EPYC server which perfectly auto-detected and produced a perfect run too :D <code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/855f6e0b9b797313c0d767a57981b6bdb84294d4/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; ./rdpmc-bench</code></p>
</blockquote>
<p>^^</p>



<a name="207445457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445457">(Aug 19 2020 at 18:39)</a>:</h4>
<p>just did that as well, looks like all zeroes</p>



<a name="207445467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445467">(Aug 19 2020 at 18:39)</a>:</h4>
<p>trying on perf.rlo collector</p>



<a name="207445601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445601">(Aug 19 2020 at 18:40)</a>:</h4>
<p>yep all zeroes!</p>



<a name="207445604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207445604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207445604">(Aug 19 2020 at 18:40)</a>:</h4>
<p>the syscall version consistently undercounts on my Ivy Bridge, but both a plain loop and a syscall loop produce always all 0s on the Zen 1 EPYC</p>



<a name="207446047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207446047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207446047">(Aug 19 2020 at 18:44)</a>:</h4>
<p>so even if we enter the kernel, we've accounted for most of the artificial benchmark noise, but the bad news is I still have no idea how we're gathering all that noise during <code>rustc</code> execution. maybe I need a funky metric, like, sorting queries ascending by variance and descending by total (including everything nested in them, i.e. not "self") or something, to find the biggest low-variance chunk of work to know to exclude it</p>



<a name="207447394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207447394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207447394">(Aug 19 2020 at 18:56)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Are you looking at a portion of rustc that has already read everything in and done all its memory allocation, and just needs to do computation? Or are you looking at a portion of rustc that's reading things in, allocating memory, and writing things out?</p>



<a name="207447462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207447462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207447462">(Aug 19 2020 at 18:56)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> most of rustc is IO-free except for potentially touching memory-mapped pages (and ofc allocating)</p>



<a name="207447465"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207447465" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207447465">(Aug 19 2020 at 18:57)</a>:</h4>
<p>Memory allocation (if it enters the kernel) is going to incur some variance because it touches page tables and has to do invalidations. Touching the filesystem will have inherent variation.</p>



<a name="207447499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207447499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207447499">(Aug 19 2020 at 18:57)</a>:</h4>
<p>but I'm counting userspace instructions?</p>



<a name="207447566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207447566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207447566">(Aug 19 2020 at 18:57)</a>:</h4>
<p>At this point, are you seeing zero variation on kernel entries/exits/etc?</p>



<a name="207447674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207447674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207447674">(Aug 19 2020 at 18:58)</a>:</h4>
<p>do you mean their count? I'm not counting any software events rn. maybe I should figure out how</p>



<a name="207447728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207447728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207447728">(Aug 19 2020 at 18:59)</a>:</h4>
<p>one interesting thing is the variation is too small to do any one big thing in, not even every second or so. it's more like taking a slightly different branch a few hundred/thousand times</p>



<a name="207447854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207447854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207447854">(Aug 19 2020 at 19:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207447674">said</a>:</p>
<blockquote>
<p>do you mean their count? I'm not counting any software events rn. maybe I should figure out how</p>
</blockquote>
<p>That'd be interesting too, but I meant, did you sort out the issue where syscalls and other kernel entries/exits were causing instruction count to vary?</p>



<a name="207448016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207448016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207448016">(Aug 19 2020 at 19:01)</a>:</h4>
<p>no, that was returning from hardware interrupts, I spent a whole day writing auto-detection logic so we can use the right counter for that (and now I can't stand the word "lake" etc.)</p>



<a name="207448078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207448078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207448078">(Aug 19 2020 at 19:01)</a>:</h4>
<p>the synthetic benchmarks run flawlessly on Zen, accounting for every single last instruction</p>



<a name="207448083"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207448083" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207448083">(Aug 19 2020 at 19:01)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I'm glad you've got that "cove"-red. ;)</p>



<a name="207448092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207448092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207448092">(Aug 19 2020 at 19:01)</a>:</h4>
<p>i.e. they print only 0</p>



<a name="207448125"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207448125" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207448125">(Aug 19 2020 at 19:01)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I'm actually scared Ice Lake might remove the counter, or leave it undocumented</p>



<a name="207448221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207448221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207448221">(Aug 19 2020 at 19:02)</a>:</h4>
<p>the most recent SDM + the update doc do not include <code>HW_INTERRUPTS.RECEIVED</code> or anything interrupt-related for Ice Lake</p>



<a name="207448257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207448257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207448257">(Aug 19 2020 at 19:02)</a>:</h4>
<p>I very much doubt Ice Lake will remove it, and if it isn't documented at all I can help you find someone at Intel who might be able to sort that out.</p>



<a name="207448266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207448266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207448266">(Aug 19 2020 at 19:02)</a>:</h4>
<p>pre-cove it's all good though,going all the way back to Sandy Bridge</p>



<a name="207448324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207448324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207448324">(Aug 19 2020 at 19:03)</a>:</h4>
<p>well the good news is that there's little enough counters that you could just go digging for them, but I don't (nor know anyone who does) have e.g. anything pre-Sandy Bridge for example</p>



<a name="207539050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539050">(Aug 20 2020 at 15:54)</a>:</h4>
<p>ugh the <code>chrome_profiler.json</code> file is ~1GB</p>



<a name="207539104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539104">(Aug 20 2020 at 15:55)</a>:</h4>
<p>Are you looking for things with "large" variance?</p>



<a name="207539119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539119">(Aug 20 2020 at 15:55)</a>:</h4>
<p>hmm</p>



<a name="207539141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539141">(Aug 20 2020 at 15:55)</a>:</h4>
<p><code>--minimum-duration 1</code>?</p>



<a name="207539174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539174">(Aug 20 2020 at 15:55)</a>:</h4>
<p>Yeah, that's what I was going to suggest.</p>



<a name="207539195"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539195" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539195">(Aug 20 2020 at 15:56)</a>:</h4>
<p>That often has a pretty big impact.</p>



<a name="207539197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539197">(Aug 20 2020 at 15:56)</a>:</h4>
<p>that'd be 1000 instructions</p>



<a name="207539259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539259">(Aug 20 2020 at 15:56)</a>:</h4>
<p>only halves it lol?</p>



<a name="207539279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539279">(Aug 20 2020 at 15:56)</a>:</h4>
<p>oh, 1000 instructions total, not variance</p>



<a name="207539310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539310">(Aug 20 2020 at 15:56)</a>:</h4>
<p>I'll increase it until I'm happy with the size, thanks!</p>



<a name="207539492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539492">(Aug 20 2020 at 15:58)</a>:</h4>
<p>why are they not aligned?</p>



<a name="207539601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539601">(Aug 20 2020 at 15:59)</a>:</h4>
<p>Not aligned?</p>



<a name="207539686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539686">(Aug 20 2020 at 15:59)</a>:</h4>
<p>all the counts are relative to the start, in the implementation, but in the viewer, they start around 13 billion</p>



<a name="207539711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539711">(Aug 20 2020 at 16:00)</a>:</h4>
<p>err, 13 billion more with each</p>



<a name="207539767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539767">(Aug 20 2020 at 16:00)</a>:</h4>
<p>lemme just zoom out and screenshot</p>



<a name="207539838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539838">(Aug 20 2020 at 16:00)</a>:</h4>
<p><a href="/user_uploads/4715/lA1fZd6P7C24w3LWRjLIchgS/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/lA1fZd6P7C24w3LWRjLIchgS/image.png" title="image.png"><img src="/user_uploads/4715/lA1fZd6P7C24w3LWRjLIchgS/image.png"></a></div>



<a name="207539879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207539879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207539879">(Aug 20 2020 at 16:01)</a>:</h4>
<p>but also I feel it'd be hard to eyeball this</p>



<a name="207540342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540342">(Aug 20 2020 at 16:04)</a>:</h4>
<p>That's so weird.</p>



<a name="207540443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540443">(Aug 20 2020 at 16:05)</a>:</h4>
<p>uh oh there's 2.7 <em>billion</em> that's either in <code>item_bodies_checking</code> or <code>typeck_item_bodies</code>. but I would've seen it as that huge of a variance, and I don't, so I think this is a <code>crox</code> or chromium bug</p>



<a name="207540565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540565">(Aug 20 2020 at 16:06)</a>:</h4>
<p>There's so little processing going on in <code>crox</code>. I can't think off hand how we could be causing this.</p>



<a name="207540599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540599">(Aug 20 2020 at 16:06)</a>:</h4>
<p>We basically just translate the measureme events into json and let chromium deal with it.</p>



<a name="207540655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540655">(Aug 20 2020 at 16:07)</a>:</h4>
<p>ughh</p>



<a name="207540670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540670">(Aug 20 2020 at 16:07)</a>:</h4>
<p>oh the color correlates with self time, heh</p>



<a name="207540691"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540691" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540691">(Aug 20 2020 at 16:08)</a>:</h4>
<p>oh could it be the <code>--minimum-duration</code>?</p>



<a name="207540755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540755">(Aug 20 2020 at 16:08)</a>:</h4>
<p>Hmm</p>



<a name="207540777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540777">(Aug 20 2020 at 16:08)</a>:</h4>
<p>anyway this looks like a deadend</p>



<a name="207540814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540814">(Aug 20 2020 at 16:08)</a>:</h4>
<p>These are different runs of <code>rustc</code> all merged into the same graph right?</p>



<a name="207540831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540831">(Aug 20 2020 at 16:09)</a>:</h4>
<p>yeah, you can see the PIDs on the left</p>



<a name="207540943"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540943" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540943">(Aug 20 2020 at 16:10)</a>:</h4>
<p>So if you ran <code>mmview {file} | head</code> they should all have <code>timestamp: 0</code> at the beginning right?</p>



<a name="207540974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207540974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207540974">(Aug 20 2020 at 16:10)</a>:</h4>
<p>what's <code>mmview</code>?</p>



<a name="207541003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541003">(Aug 20 2020 at 16:10)</a>:</h4>
<p>It just dumps the data from your trace file in a semi-readable format</p>



<a name="207541015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541015">(Aug 20 2020 at 16:10)</a>:</h4>
<p>installing now</p>



<a name="207541039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541039">(Aug 20 2020 at 16:10)</a>:</h4>
<p>I really only use it for debugging stuff</p>



<a name="207541055"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541055" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541055">(Aug 20 2020 at 16:10)</a>:</h4>
<p>wait</p>



<a name="207541082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541082">(Aug 20 2020 at 16:11)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> this might be one of the few ways I have to avoid writing code, lol</p>



<a name="207541120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541120">(Aug 20 2020 at 16:11)</a>:</h4>
<p>good thing you mentioned it because I'd never heard of it</p>



<a name="207541152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541152">(Aug 20 2020 at 16:11)</a>:</h4>
<p>I should be able to erase the timestamps and check that the event order is identical</p>



<a name="207541191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541191">(Aug 20 2020 at 16:12)</a>:</h4>
<p>Oh, yeah that would probably work</p>



<a name="207541241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541241">(Aug 20 2020 at 16:12)</a>:</h4>
<p>and then zip them together</p>



<a name="207541299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541299">(Aug 20 2020 at 16:12)</a>:</h4>
<p>(if I can't I'll try to do this with <code>crox</code>'s output and <code>jq</code>, I guess)</p>



<a name="207541364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541364">(Aug 20 2020 at 16:13)</a>:</h4>
<p>I should add a <code>--json</code> flag to mmview and just give you a raw json dump without any processing.</p>



<a name="207541377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541377">(Aug 20 2020 at 16:13)</a>:</h4>
<p>ugh you print it as times</p>



<a name="207541386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541386">(Aug 20 2020 at 16:13)</a>:</h4>
<p>yeah...</p>



<a name="207541418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541418">(Aug 20 2020 at 16:13)</a>:</h4>
<p>the problem is you're rounding to microseconds :P</p>



<a name="207541546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541546">(Aug 20 2020 at 16:14)</a>:</h4>
<p>anyway they all start with <code>timestamp: 0 μs - 2216 μs,</code> (<code>parse_crate</code>)</p>



<a name="207541576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541576">(Aug 20 2020 at 16:15)</a>:</h4>
<p>That seems right then.</p>



<a name="207541590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541590">(Aug 20 2020 at 16:15)</a>:</h4>
<p>at least the good news is that I won't need to erase the timestamps because you're rounding away almost all of the variance heh</p>



<a name="207541601"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541601" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541601">(Aug 20 2020 at 16:15)</a>:</h4>
<p>to check that the event order is the same</p>



<a name="207541713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541713">(Aug 20 2020 at 16:16)</a>:</h4>
<p><code>diff -U10 &lt;(mmview core-047003) &lt;(mmview core-047937) | less</code></p>



<a name="207541785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541785">(Aug 20 2020 at 16:17)</a>:</h4>
<p>okay the diff is huge because of tiny changes in the thousands of instructions</p>



<a name="207541860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207541860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207541860">(Aug 20 2020 at 16:17)</a>:</h4>
<p>so I have to <code> | sed 's/timestamp:.*//'</code> each <code>mmview</code> - and that results in no diff!</p>



<a name="207542099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207542099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207542099">(Aug 20 2020 at 16:19)</a>:</h4>
<p>trying out a few random old profiles, including with different implementations of instruction counting, and so far I can't find one that differs in event order</p>



<a name="207542454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207542454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207542454">(Aug 20 2020 at 16:22)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> I guess one trick I could do is pick a min and a max and do a diff between them</p>



<a name="207542670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207542670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207542670">(Aug 20 2020 at 16:24)</a>:</h4>
<p>Since the events are in the order, it would probably be easy to write a script to find the event with the largest difference in self-time between runs</p>



<a name="207542752"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207542752" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207542752">(Aug 20 2020 at 16:25)</a>:</h4>
<p>yeah, I wish I had the mental capacity to go write code without spending a week or two on it</p>



<a name="207543153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207543153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207543153">(Aug 20 2020 at 16:28)</a>:</h4>
<p><code>summarize diff</code> tells me <code>mir_borrowck</code> and <code>associated_items</code> are interesting</p>



<a name="207543713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207543713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207543713">(Aug 20 2020 at 16:33)</a>:</h4>
<p>wait, <code>mir_borrowck</code>'s self "time" accounts for almost all of the variance, between these two runs</p>



<a name="207543945"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207543945" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207543945">(Aug 20 2020 at 16:34)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> hmpf I need to screw with <code>mmview</code>'s output to make it processable</p>



<a name="207544042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207544042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207544042">(Aug 20 2020 at 16:35)</a>:</h4>
<p>oh I can JSON-ify it and throw it into <code>jq</code> heh</p>



<a name="207544531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207544531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207544531">(Aug 20 2020 at 16:38)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <code>sed -E 's/(\w+): (.*),/"\1": "\2",/'</code>, first try :D</p>



<a name="207544776"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207544776" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207544776">(Aug 20 2020 at 16:40)</a>:</h4>
<p>Yer a (regex) wizard eddyb</p>



<a name="207544927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207544927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207544927">(Aug 20 2020 at 16:41)</a>:</h4>
<p>/me adds <code>| sed -E 's/("thread_id": .*),/\1/'</code> to make <code>jq</code> happy</p>



<a name="207545753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207545753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207545753">(Aug 20 2020 at 16:48)</a>:</h4>
<p>(from there on it's smooth sailing, <code> | jq 'select(.label == "mir_borrowck") | .timestamp'</code> - but I'm afraid that will give me total ranges, so I'd have a hard time figuring out self time)</p>



<a name="207546801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207546801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207546801">(Aug 20 2020 at 16:58)</a>:</h4>
<p>well, needs <code> | split(" - ") | map(rtrimstr(" μs") | tonumber) | (.[1] - .[0])</code> in the <code>jq</code> filter to make things more comparable</p>



<a name="207547521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207547521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207547521">(Aug 20 2020 at 17:04)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> so I have this command: <code>jq -s 'transpose | map(.[1] - .[0])' &lt;(mmview core-049351 | sed -E 's/(\w+): (.*),/"\1": "\2",/' | sed -E 's/("thread_id": .*),/\1/' | jq -s 'map(select(.label == "mir_borrowck") | .timestamp | split(" - ") | map(rtrimstr(" μs") | tonumber) | (.[1] - .[0]))') &lt;(mmview core-030520 | sed -E 's/(\w+): (.*),/"\1": "\2",/' | sed -E 's/("thread_id": .*),/\1/' | jq -s 'map(select(.label == "mir_borrowck") | .timestamp | split(" - ") | map(rtrimstr(" μs") | tonumber) | (.[1] - .[0]))') | less</code></p>



<a name="207547720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207547720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207547720">(Aug 20 2020 at 17:06)</a>:</h4>
<p>and the output is a stream of <code>0</code>, <code>+1</code> and <code>-1</code> and... oof</p>



<a name="207547887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207547887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207547887">(Aug 20 2020 at 17:07)</a>:</h4>
<p>that makes sense since any one range being larger would have a drastic impact</p>



<a name="207548129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207548129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207548129">(Aug 20 2020 at 17:09)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> is the <code>crox</code> output similarly rounded?</p>



<a name="207548217"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207548217" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207548217">(Aug 20 2020 at 17:10)</a>:</h4>
<p>while it would be harder to use, I think I can filter into two arrays (start and end) and then zip them (with <code>transpose</code>)</p>



<a name="207548310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207548310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207548310">(Aug 20 2020 at 17:11)</a>:</h4>
<p>Yeah, it's rounded to microseconds <a href="https://github.com/rust-lang/measureme/blob/master/crox/src/main.rs#L15">https://github.com/rust-lang/measureme/blob/master/crox/src/main.rs#L15</a></p>



<a name="207548341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207548341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207548341">(Aug 20 2020 at 17:11)</a>:</h4>
<p>Which was never an issue until we had such accurate timing lol</p>



<a name="207548480"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207548480" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207548480">(Aug 20 2020 at 17:12)</a>:</h4>
<p><code>Instant::now</code> does return nanosecond precision (I've been informed it does that by interpolating using <code>rdtsc</code> and some factor kept in shared memory</p>



<a name="207548648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207548648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207548648">(Aug 20 2020 at 17:14)</a>:</h4>
<p>so the best thing right now would actually be a flamegraph diff, maybe?</p>



<a name="207561394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207561394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207561394">(Aug 20 2020 at 19:04)</a>:</h4>
<p>at least I should be able to just run <code>crox</code> on one profile and see what's up with it</p>



<a name="207561961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207561961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207561961">(Aug 20 2020 at 19:09)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> how does <code>summarize</code> compute "self time"? does it look only at direct children of the event, or is it weirder? also, is total time computed from the hierarchy somehow, or is it just the range size?</p>



<a name="207562049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207562049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207562049">(Aug 20 2020 at 19:10)</a>:</h4>
<p>Total time is just the range size</p>



<a name="207562067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207562067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207562067">(Aug 20 2020 at 19:10)</a>:</h4>
<p>Self time is total time - total time for the direct children</p>



<a name="207562267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207562267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207562267">(Aug 20 2020 at 19:12)</a>:</h4>
<p>because I'm not seeing a lot of <code>mir_borrowck</code> direct children (or "callees" I could say). not even total descendants. although, there's apparently like 1k bodies?</p>



<a name="207562325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207562325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207562325">(Aug 20 2020 at 19:13)</a>:</h4>
<p>so actually, every <code>mir_borrowck</code> execution being ±1 instruction could account for everything. welp</p>



<a name="207562613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207562613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207562613">(Aug 20 2020 at 19:15)</a>:</h4>
<p>let me just patch up <code>mmview</code> to just print instruction counts</p>



<a name="207562634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207562634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207562634">(Aug 20 2020 at 19:15)</a>:</h4>
<p>or nanoseconds or w/e</p>



<a name="207563780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207563780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207563780">(Aug 20 2020 at 19:25)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> oh wow <code>mmview</code> is really simple, I can just modify it to output the JSON I need heh</p>



<a name="207563855"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207563855" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207563855">(Aug 20 2020 at 19:26)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> oh you're using "global start time", that's why <code>crox</code> did that weird thing</p>



<a name="207563879"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207563879" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207563879">(Aug 20 2020 at 19:26)</a>:</h4>
<p>that's why it was offset by 13 billion instructions</p>



<a name="207563901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207563901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207563901">(Aug 20 2020 at 19:26)</a>:</h4>
<p>because each run takes 13 seconds</p>



<a name="207564121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207564121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207564121">(Aug 20 2020 at 19:28)</a>:</h4>
<p>Isn't that only done in mmview?</p>



<a name="207565922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207565922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207565922">(Aug 20 2020 at 19:44)</a>:</h4>
<p>it must be used in <code>crox</code> too. or at least the version I have</p>



<a name="207566303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207566303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207566303">(Aug 20 2020 at 19:48)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so actually, I wish I realized how tiny <code>mmview</code> was, I can do my own thing like it very easily</p>



<a name="207566566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207566566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207566566">(Aug 20 2020 at 19:50)</a>:</h4>
<p>Yeah, I think the first version was literally just</p>
<div class="codehilite"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">profiler_data</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="207569724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207569724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207569724">(Aug 20 2020 at 20:19)</a>:</h4>
<p>even <code>crox</code> is tiny heh</p>



<a name="207570149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207570149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207570149">(Aug 20 2020 at 20:24)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <code>crox</code> uses <code>data.metadata.start_time.duration_since(UNIX_EPOCH)</code></p>



<a name="207576447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207576447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> andjo403 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207576447">(Aug 20 2020 at 21:24)</a>:</h4>
<p>yes I added the start_time when I crated the merging in crox. my use case was to get something similar to <a href="https://doc.rust-lang.org/cargo/reference/unstable.html#timings">cargo -Z timings</a> to be able to see how all the rustc compilations from a cargo build interacted.<br>
I had not enough imagination to think of use it as a way to diff the same execution run multiple times :D</p>



<a name="207577142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207577142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> andjo403 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207577142">(Aug 20 2020 at 21:32)</a>:</h4>
<p>and that the times is rounded to micros I think is mostly that that is the default in chrome tracing format.<br>
to have nanos you will have to write some extra information to the json file to get the time scaling correct in the gui.</p>



<a name="207577468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207577468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207577468">(Aug 20 2020 at 21:37)</a>:</h4>
<p>well this isn't even nanoseconds, I'm storing an entirely different value (instruction counts) in the timestamps</p>



<a name="207580327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207580327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207580327">(Aug 20 2020 at 22:10)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> I've got an idea, along the lines of "I can enforce that no two «timestamps» are the same, and use a <code>BTreeMap&lt;u64, Event&gt;</code> to do range queries"</p>



<a name="207580368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207580368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207580368">(Aug 20 2020 at 22:10)</a>:</h4>
<p>the funny thing about that is re-splitting start/end (which I assume <code>analyzeme</code> combines?)</p>



<a name="207597074"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207597074" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207597074">(Aug 21 2020 at 03:17)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> figured out, <code>analyzeme</code> itself adds the start time, and it needs to be subtracted out</p>



<a name="207597077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207597077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207597077">(Aug 21 2020 at 03:17)</a>:</h4>
<p>thankfully it looks like a precise operation</p>



<a name="207597257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207597257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207597257">(Aug 21 2020 at 03:23)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> theory: having separate tools isn't great, and we want to more have ways to analyze the data, and e.g. the Chromium profiler format would be just one kind of format we'd serialize an event stream to (which could be the result of e.g. diffing two event streams, doing some variance analysis, etc.)</p>



<a name="207597298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207597298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207597298">(Aug 21 2020 at 03:24)</a>:</h4>
<p>similarly, <code>--json</code> or flamegraphs</p>



<a name="207598741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207598741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207598741">(Aug 21 2020 at 04:03)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> but yeah I think I need to reason about the space between every consecutive pair of low-level events (i.e. start/end/instant) because it will have "inherent variance" of 2x sampling variance</p>



<a name="207598745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207598745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207598745">(Aug 21 2020 at 04:03)</a>:</h4>
<p>whereas anything made of more sampling points will amplify that</p>



<a name="207599665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207599665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207599665">(Aug 21 2020 at 04:26)</a>:</h4>
<p>I wish this was a separate crate I can "just" use :( <a href="https://github.com/bheisler/criterion.rs/blob/master/src/stats/mod.rs">https://github.com/bheisler/criterion.rs/blob/master/src/stats/mod.rs</a></p>



<a name="207600394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207600394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207600394">(Aug 21 2020 at 04:49)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> actually, hmm, a list of start/end/instant events sorted by timestamp with a "parent start index/timestamp" or something in each entry would allow speeding up all analysis and wouldn't be harder to construct than the current <code>Vec&lt;Event&gt;</code></p>



<a name="207600438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207600438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207600438">(Aug 21 2020 at 04:50)</a>:</h4>
<p>this is exactly what I wanted to avoid though :P (rewriting parts of <code>analyzeme</code>)</p>



<a name="207600775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207600775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207600775">(Aug 21 2020 at 05:00)</a>:</h4>
<p>oh what I thought is a <code>Vec&lt;Event&gt;</code> is an iterator of <code>LightweightEvent</code>, heh. oh and start/end aren't actually recorded like I thought they are, so I'm reconstructing the sampling points from something more boiled down at recording time oooh</p>



<a name="207600844"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207600844" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207600844">(Aug 21 2020 at 05:02)</a>:</h4>
<p>that explains the reverse iteration in <code>summarize</code>, since recording is effectively in postorder (parent range event after all child events)</p>



<a name="207603030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207603030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207603030">(Aug 21 2020 at 06:06)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so an abstraction I think we can build is basically <code>summarize</code>'s <code>analysis</code> module but without <code>query_data</code> or per-thread <code>start</code>/<code>end</code> time. so all it gives you is access to the stack as you iterate through events in reverse</p>



<a name="207603042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207603042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207603042">(Aug 21 2020 at 06:07)</a>:</h4>
<p>but I think I'll avoid building that, now that I understand how it all works, just because of how straight-forward it seems</p>



<a name="207603049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207603049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207603049">(Aug 21 2020 at 06:07)</a>:</h4>
<p>(to just copy that code and modify it)</p>



<a name="207686542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686542">(Aug 21 2020 at 21:24)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="138448">@cuviper</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="123586">@nagisa</span> I might know why the interrupt count helps a lot more on Zen than it does on my Ivy Bridge:</p>
<blockquote>
<p>Many implementations include an event which can be used for this purpose; some CPUs do not (such as Atom or Pentium D) and on some the event is unreliable when HyperThreading is enabled (Nehalem) [23].</p>
</blockquote>
<p>Nehalem doesn't have this counter, as far as Intel documentation is concerned! so presumably that's still a problem in Ivy Bridge</p>



<a name="207686587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686587">(Aug 21 2020 at 21:24)</a>:</h4>
<p>I had this still open and glanced at it and spotted that <a href="http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=17">http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=17</a></p>



<a name="207686611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686611">(Aug 21 2020 at 21:24)</a>:</h4>
<p>it also implies there's an older (surely undocumented?) counter and I must've missed something</p>



<a name="207686630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686630">(Aug 21 2020 at 21:25)</a>:</h4>
<blockquote>
<p>[23]  C. Segulja. Personal Communication, 2012.</p>
</blockquote>
<p>oh <em>come on</em></p>



<a name="207686668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686668">(Aug 21 2020 at 21:25)</a>:</h4>
<p>Honestly, if you end up with something that only times reliably on Haswell and newer, that wouldn't be a big deal.</p>



<a name="207686678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686678">(Aug 21 2020 at 21:25)</a>:</h4>
<p>Skylake is when Intel started documenting the counter at all AFAICT</p>



<a name="207686726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686726">(Aug 21 2020 at 21:26)</a>:</h4>
<p>but I think the overcounting problem still exists in Coffee Lake?</p>



<a name="207686760"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686760" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686760">(Aug 21 2020 at 21:26)</a>:</h4>
<p>Documenting it at all, or documenting it in a sensible place to look? :)</p>



<a name="207686766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686766">(Aug 21 2020 at 21:27)</a>:</h4>
<p>so far "always zero" has only been observed reliably on Zen (which is nice because of all the Zen errata that had us worried)</p>



<a name="207686815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686815">(Aug 21 2020 at 21:27)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> well, listing it in the list of performance counting events. a list which for some reason doesn't include it for  bridges and wells despite them empirically having the same event with the same EventSel/UMask value to configure it</p>



<a name="207686886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686886">(Aug 21 2020 at 21:28)</a>:</h4>
<p>like they include it for atoms and phis but not older "Core" series :/</p>



<a name="207686912"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686912" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686912">(Aug 21 2020 at 21:29)</a>:</h4>
<p>Given that it isn't architectural, it might have only gotten documented <em>at all</em> because someone needed it to be public.</p>



<a name="207686951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686951">(Aug 21 2020 at 21:29)</a>:</h4>
<p>That happened a few times when we needed something disclosed; that was the point at which it got documented in the public documentation.</p>



<a name="207686980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207686980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207686980">(Aug 21 2020 at 21:29)</a>:</h4>
<p>but why not go back and be uniform? it's exactly the same AFAICT, you'd just copy-paste it</p>



<a name="207687076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687076">(Aug 21 2020 at 21:30)</a>:</h4>
<p>anyway, the only reason I didn't bother with anything before Sandy Bridge is the same EventSel/UMask pair maps to <em>something else</em> in Nehalem or whatever is listed just before Sandy Bridge in the Intel docs</p>



<a name="207687092"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687092" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687092">(Aug 21 2020 at 21:30)</a>:</h4>
<p>so I would have to both find someone with hardware <em>and</em> bruteforce it</p>



<a name="207687106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687106">(Aug 21 2020 at 21:31)</a>:</h4>
<p>Multiple reasons. Primarily, it isn't architectural, so verifying that it's actually "exactly the same" isn't trivial. Nobody wants to document/promise something  that isn't true.</p>



<a name="207687164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687164">(Aug 21 2020 at 21:31)</a>:</h4>
<p>but, they designed it. they know it's there. it's broken everywhere with HT or w/e so I don't see why they would not document it before</p>



<a name="207687238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687238">(Aug 21 2020 at 21:32)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> it's so weird. AMD includes it in the <em>K8</em> docs. i.e. the original AMD64. from early 2000s</p>



<a name="207687241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687241">(Aug 21 2020 at 21:32)</a>:</h4>
<p>That's a very very plural "they"; the same set of people may not have been involved the whole time, for instance. ;)</p>



<a name="207687258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687258">(Aug 21 2020 at 21:32)</a>:</h4>
<p>yeah but, like, surely they have the specs</p>



<a name="207687284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687284">(Aug 21 2020 at 21:32)</a>:</h4>
<p>And secondarily, updating documents for older processors isn't anyone's job specifically, whereas someone clearly had a specific need for it to be documented on Skylake and newer. :)</p>



<a name="207687328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687328">(Aug 21 2020 at 21:33)</a>:</h4>
<p>given how they haven't even bothered to include <em>released generations</em> in the docs... I'm not really <em>surprised</em></p>



<a name="207687337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687337">(Aug 21 2020 at 21:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207687258">said</a>:</p>
<blockquote>
<p>yeah but, like, surely they have the specs</p>
</blockquote>
<p>You would be <em>astonished</em> at how many <em>different</em> specs there are, how hard they are to find even internally, and how much work it takes to get the necessary approvals to publicly document something.</p>



<a name="207687338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687338">(Aug 21 2020 at 21:33)</a>:</h4>
<p>just <em>disappointed</em></p>



<a name="207687413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687413">(Aug 21 2020 at 21:34)</a>:</h4>
<ul>
<li>validation is hard.</li>
</ul>



<a name="207687414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687414">(Aug 21 2020 at 21:34)</a>:</h4>
<p>It's not like there's a single massive internal manual for any given processor that you can get access to if you work there. ;)</p>



<a name="207687439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687439">(Aug 21 2020 at 21:34)</a>:</h4>
<p>does intel even validate the more obscure counters? You’ll never know! Does AMD? Same answer ah!</p>



<a name="207687443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687443">(Aug 21 2020 at 21:34)</a>:</h4>
<p>There are absolutely specs; I'm not suggesting there aren't. The problem is that there are <em>many</em> specs. :)</p>



<a name="207687479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687479">(Aug 21 2020 at 21:35)</a>:</h4>
<p>I don't mean necessarily a document. I mean the actual HDL that they made the CPUs from</p>



<a name="207687514"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687514" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687514">(Aug 21 2020 at 21:35)</a>:</h4>
<p>then again, my standards are lowering every minute I pay any attention to all of this</p>



<a name="207687519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687519">(Aug 21 2020 at 21:35)</a>:</h4>
<p>counters are probably a microcode thing (inferred from <span class="user-mention" data-user-id="239881">@Josh Triplett</span> saying they are not architectural)</p>



<a name="207687580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687580">(Aug 21 2020 at 21:36)</a>:</h4>
<p>/me has absolutely no idea how they're implemented and probably couldn't say if he did.</p>



<a name="207687583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687583">(Aug 21 2020 at 21:36)</a>:</h4>
<p>"architectural" is Intel speak for "guaranteed to exist"</p>



<a name="207687587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687587">(Aug 21 2020 at 21:36)</a>:</h4>
<p>That, yes.</p>



<a name="207687594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687594">(Aug 21 2020 at 21:36)</a>:</h4>
<p>like they won't remove it in the next generation. nor change how they're accessed</p>



<a name="207687614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687614">(Aug 21 2020 at 21:36)</a>:</h4>
<p>I see.</p>



<a name="207687617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687617">(Aug 21 2020 at 21:36)</a>:</h4>
<p>"architectural" means "this is part of Intel Architecture, and it isn't going away". It's part of the eternally growing backwards compatibility.</p>



<a name="207687622"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687622" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687622">(Aug 21 2020 at 21:36)</a>:</h4>
<p>everything else requires you using <code>cpuid</code> + published documents to guess how you might use it</p>



<a name="207687637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687637">(Aug 21 2020 at 21:37)</a>:</h4>
<p>it's interesting that there are claims of a Nehalem counter though. the paper talks as if Intel documented this... but it's not there. I wonder if they just... removed them?</p>



<a name="207687654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687654">(Aug 21 2020 at 21:37)</a>:</h4>
<p>from the SDM and other documents, I mean</p>



<a name="207687706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687706">(Aug 21 2020 at 21:38)</a>:</h4>
<p>hang on</p>



<a name="207687720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687720">(Aug 21 2020 at 21:38)</a>:</h4>
<p>/me goes to get their physical copies circa 2008</p>



<a name="207687746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687746">(Aug 21 2020 at 21:39)</a>:</h4>
<p>Things are almost never removed from the SDM; I'd guess they probably weren't there to begin with.</p>



<a name="207687779"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687779" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687779">(Aug 21 2020 at 21:39)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> One easy way to see the notion of "architectural" to look at documentation of "model-specific registers", used with rdmsr/wrmsr. Some of those are "architectural", commonly prefixed with <code>IA32_</code> or similar; once those are documented, they'll keep existing past a given generation (or "as long as this feature is enumerated" or similar), with the same number, and the same behavior.</p>



<a name="207687860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207687860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207687860">(Aug 21 2020 at 21:40)</a>:</h4>
<p>A non-architectural MSR may have different behavior in the next generation, or not exist at all, or be renumbered and <em>perhaps</em> have the same functionality...</p>



<a name="207688457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207688457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207688457">(Aug 21 2020 at 21:47)</a>:</h4>
<p>so in the SDM, the list of events is Appending A of volume 3. or used to be</p>



<a name="207688675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207688675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207688675">(Aug 21 2020 at 21:50)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> they did remove it! I should've read all the fine print lol. see <a href="http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=5">http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=5</a></p>



<a name="207688751"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207688751" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207688751">(Aug 21 2020 at 21:51)</a>:</h4>
<p>so it's <code>11d</code> on Nehalem and Westmere. got it</p>



<a name="207688972"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207688972" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207688972">(Aug 21 2020 at 21:54)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> my physical copy has it too! it's <code>c8</code> for "Intel Core Microarchitecture" (I guess this is pre-Nehalem)</p>



<a name="207689073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207689073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207689073">(Aug 21 2020 at 21:55)</a>:</h4>
<p>thanks Intel, for removing something instead of adding caveats/errata and making me feel insane,</p>



<a name="207689333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207689333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207689333">(Aug 21 2020 at 21:58)</a>:</h4>
<p>now all that's left is to find that the latest microcode update actually removed/disabled those counters.</p>



<a name="207689374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207689374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207689374">(Aug 21 2020 at 21:59)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> no it's literally just the PDFs</p>



<a name="207689409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207689409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207689409">(Aug 21 2020 at 21:59)</a>:</h4>
<p>I'm not even sure the counters themselves have a mechanism to disable them. but maybe microcode and intercept any MSR write?</p>



<a name="207689485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207689485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207689485">(Aug 21 2020 at 22:00)</a>:</h4>
<p>if Intel could redact my physical copy they probably would've</p>



<a name="207690202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207690202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207690202">(Aug 21 2020 at 22:09)</a>:</h4>
<p>oh the first table has the <code>c8</code> that's in my physical copy heh <a href="http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=4">http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=4</a></p>



<a name="207690411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207690411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207690411">(Aug 21 2020 at 22:12)</a>:</h4>
<p>so, huh, they kept it on Bonell (an Atom uarch), with the old <code>hW_INT_RCV</code> name and the <code>c8</code> <code>EventSel</code> value, in <a href="https://software.intel.com/content/dam/develop/public/us/en/documents/335279-performance-monitoring-events-guide.pdf">https://software.intel.com/content/dam/develop/public/us/en/documents/335279-performance-monitoring-events-guide.pdf</a>. maybe it's because it doesn't have HT?</p>



<a name="207692249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207692249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207692249">(Aug 21 2020 at 22:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207688675">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> they did remove it! I should've read all the fine print lol. see <a href="http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=5">http://web.eece.maine.edu/~vweaver/projects/deterministic/deterministic_counters.pdf#page=5</a></p>
</blockquote>
<p>Weird.</p>
<p>In any case, if it potentially breaks with hyperthreading, do you actually want it?</p>



<a name="207692397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207692397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207692397">(Aug 21 2020 at 22:39)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> the HT interrupt overcounting variance is significantly less than the variance within interrupts themselves (which cause overcounting of instructions because <code>iret</code> counts as retiring in its <em>target</em> mode, not <em>source</em>, which makes sense mechanically but is undesireable)</p>



<a name="207692426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207692426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207692426">(Aug 21 2020 at 22:39)</a>:</h4>
<p>being able to test something and <em>knowing</em> at least some of the caveats is better than nothing at all</p>



<a name="207692479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207692479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207692479">(Aug 21 2020 at 22:40)</a>:</h4>
<p>AMD <em>does this right</em>, by producing errata instead, so Intel is just bad at this</p>



<a name="207692492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207692492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207692492">(Aug 21 2020 at 22:40)</a>:</h4>
<p>sure, they might have their reasons, but I don't have to be happy at the time wasted</p>



<a name="207692552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207692552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207692552">(Aug 21 2020 at 22:41)</a>:</h4>
<p>anyway I still have noise an order of magnitude larger, that I have to write some low-level analysis of the event data to dig further into</p>



<a name="207692636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207692636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207692636">(Aug 21 2020 at 22:42)</a>:</h4>
<p>so I could've deferred the whole interrupt counting thing, but there wasn't really a way to know</p>



<a name="207750109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207750109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207750109">(Aug 23 2020 at 01:26)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> have you considered making the analysis simpler by storing an event's start time when it starts, and the end time when it ends, but the guard that records the end time does so where the event was originally written, making it preorder rather than postorder, and allowing all analysis to go forwards rather than backwards? (maybe this belongs elsewhere?)</p>



<a name="207750118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207750118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207750118">(Aug 23 2020 at 01:27)</a>:</h4>
<p>I guess it might be hard to measure how much costlier that is? but we could design for it, maybe? it's less cache-friendly though so maybe we shouldn't care</p>



<a name="207750867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207750867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207750867">(Aug 23 2020 at 01:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207750118">said</a>:</p>
<blockquote>
<p>I guess it might be hard to measure how much costlier that is? but we could design for it, maybe? it's less cache-friendly though so maybe we shouldn't care</p>
</blockquote>
<p>that seems like it would either require an unbounded cache buffer (as there's no upper bound on how long spans may live for) or seeking around the file (→ randomizing the write patterns)</p>



<a name="207750929"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207750929" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207750929">(Aug 23 2020 at 01:55)</a>:</h4>
<p>It might be worthwhile to consider recording the start and end events separately though (which is something I’m experimenting in a tracing subscriber I’m writing)</p>



<a name="207752137"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207752137" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207752137">(Aug 23 2020 at 02:35)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> we use memory-mapping outside of windows, so it'd just be random access (hence cache effects). keeping them separate would probably be better, yeah (it's actually what I have to recover, since I care about individual sampling points, and intervals between consecutive ones, heh)</p>



<a name="207753476"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207753476" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207753476">(Aug 23 2020 at 03:18)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> hmm given the way events are read, I think it's actually faster to do one pass per thread (and even do a full pass <em>just</em> to gather the set of thread IDs, although we could encode that in the JSON blob) instead of using a hashmap to store per-thread state and update it as we go</p>



<a name="207753571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207753571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207753571">(Aug 23 2020 at 03:20)</a>:</h4>
<p>and/or I can just error for now if the <code>thread_id</code> isn't the one I expect, since introducing parallelism probably destroys any chance of making all this deterministic and therefore aggregating a set of runs is meaningless</p>



<a name="207754363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207754363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207754363">(Aug 23 2020 at 03:45)</a>:</h4>
<p>oh wow cool, <code>summarize summarize</code> and <code>summarize diff</code> can take JSON files <code>--json</code> produced. can this compute a diff of diffs? lol</p>



<a name="207754381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207754381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207754381">(Aug 23 2020 at 03:46)</a>:</h4>
<p>at the very least it seems like it can <em>show</em> the JSON file without recomputing the data from the original event traces, which is nice</p>



<a name="207758542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207758542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207758542">(Aug 23 2020 at 06:10)</a>:</h4>
<p>I hope there's a crate for this because I keep writing it heh <a href="https://gist.github.com/eddyb/b4c70b2432835c710256d58fd2037575">https://gist.github.com/eddyb/b4c70b2432835c710256d58fd2037575</a></p>



<a name="207759261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207759261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207759261">(Aug 23 2020 at 06:36)</a>:</h4>
<p>fascinating, I just finished this and the most common small variances in monotonic timestamp intervals are ±5, ±10 and ±15 (nanoseconds), together accounting for 277547 out of 1708446 consecutive intervals, or 16%</p>



<a name="207759325"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207759325" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207759325">(Aug 23 2020 at 06:39)</a>:</h4>
<p>adding <code>cpuid</code> before <code>rdpmc</code> increases the number of ±0 (instructions) intervals from 330833 (19.4%) to 1630224 (95.4%)</p>



<a name="207759369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207759369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207759369">(Aug 23 2020 at 06:40)</a>:</h4>
<p>that's much starker than what I was able to see when the sampling points were grouped together into the higher-level profiling view</p>



<a name="207759441"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207759441" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207759441">(Aug 23 2020 at 06:42)</a>:</h4>
<p>on the Zen 1 EPYC, <code>lfence</code> instead of <code>cpuid</code> results in 1652944 (96.75%) ±0 (instructions) intervals, presumably because it's simpler? and the right bit in the right MSR is enabled by the kernel to make it just as serializing as <code>cpuid</code></p>



<a name="207759502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207759502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207759502">(Aug 23 2020 at 06:45)</a>:</h4>
<p>with <code>cpuid</code> and subtracting hardware interrupts, it goes up to 1700244 (99.5%)</p>



<a name="207759598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207759598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207759598">(Aug 23 2020 at 06:49)</a>:</h4>
<p>that's actually <strong>9.5x fewer</strong> non-deterministic intervals, so in a sense, an order of magnitude improvement! even if the total variance doesn't look like it improves much</p>



<a name="207759663"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207759663" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207759663">(Aug 23 2020 at 06:51)</a>:</h4>
<p>in my poor approximation from before, this maps to all of those small queries ending up with 0 variance, but now I can actually quantify it</p>



<a name="207759993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207759993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207759993">(Aug 23 2020 at 07:03)</a>:</h4>
<p>combining two sets of 10 runs brings it down to 1694716 (99.2%), but that's still quite better than 95.4%. although, only "5.7x fewer". if I manage to track down the remaining variance, I should be able to do runs of 100 or w/e (maybe even e.g. in groups of 10 with large <code>sleep</code>s in between, to be able to spot weird clustering effects)</p>



<a name="207760610"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207760610" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207760610">(Aug 23 2020 at 07:27)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> I guess this is my first PR to <code>measureme</code> <a href="https://github.com/rust-lang/measureme/pull/129">https://github.com/rust-lang/measureme/pull/129</a></p>



<a name="207784202"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207784202" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207784202">(Aug 23 2020 at 17:58)</a>:</h4>
<div class="codehilite"><pre><span></span><code>  ±659 instructions (after entering `free_global_ctxt` and before leaving `free_global_ctxt`)
</code></pre></div>


<p>not sure if I should make a special-case for that (the interval is a whole single query), but I think that means <code>free_global_ctxt</code> <em>on its own</em> is introducing a tenth or so of the variance</p>



<a name="207784307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207784307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207784307">(Aug 23 2020 at 18:01)</a>:</h4>
<p>oh <code>hir_lowering</code> is doing the same thing, so <em>something</em> they're doing is inherently non-deterministic and it's not just death by a thousand cuts (since it's just two sampling points)</p>



<a name="207785043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785043">(Aug 23 2020 at 18:20)</a>:</h4>
<p>Hm both sound like they're likely generating allocator traffic which is going to be very sensitive I feel to the environment.</p>



<a name="207785053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785053">(Aug 23 2020 at 18:20)</a>:</h4>
<p>(and potentially uses nondeterministic HashMaps or something? I've never looked at jemalloc internals...)</p>



<a name="207785192"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785192" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785192">(Aug 23 2020 at 18:24)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> there's no room for non-deterministic allocators anymore</p>



<a name="207785201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785201">(Aug 23 2020 at 18:25)</a>:</h4>
<p>like there isn't enough variance left. it's like 2-3 orders of magnitude smaller than with ASLR enabled</p>



<a name="207785207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785207">(Aug 23 2020 at 18:25)</a>:</h4>
<p>No, I mean ASLR isn't everything</p>



<a name="207785218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785218">(Aug 23 2020 at 18:25)</a>:</h4>
<p>even the PID-length-in-base-10 thing introduces a couple million instructions IIRC</p>



<a name="207785276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785276">(Aug 23 2020 at 18:27)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I think "free" is very misleading and it's containing a <code>Drop</code> impl that does IO</p>



<a name="207785284"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785284" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785284">(Aug 23 2020 at 18:27)</a>:</h4>
<p>Hm I guess. Have we checked if valgrind cachegrind diffs are perfect (i.e. empty)? That might be a good way to try and track things down more precisely</p>



<a name="207785296"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785296" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785296">(Aug 23 2020 at 18:28)</a>:</h4>
<p>Ah IO could I guess cause.. something? Have you tried compiling in memory (e.g. tmpfs?)</p>



<a name="207785342"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785342" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785342">(Aug 23 2020 at 18:28)</a>:</h4>
<p>Ideally probably we'd chroot into a ram-only drive, something like that, to hopefully isolate any disk io</p>



<a name="207785345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785345">(Aug 23 2020 at 18:28)</a>:</h4>
<p>no, but also I don't yet know how IO can cause instruction variance. my best bet, now that I know where it is, is to bisect the code itself</p>



<a name="207785419"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785419" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785419">(Aug 23 2020 at 18:30)</a>:</h4>
<p>I can just use my regular incremental builds and not even enable <code>-Zself-profile</code>, just do the microbenchmark thing around small pieces of code</p>



<a name="207785515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207785515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207785515">(Aug 23 2020 at 18:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> anyway this is why I wanted this sort of view of the data, it's very precise about the trouble-makers</p>



<a name="207786305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207786305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207786305">(Aug 23 2020 at 18:55)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> wait what, <code>MmapSerializationSink</code> is just in-memory and writes it out to a file in the destructor?</p>



<a name="207786309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207786309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207786309">(Aug 23 2020 at 18:55)</a>:</h4>
<p>why can't windows do <em>that</em></p>



<a name="207786358"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207786358" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207786358">(Aug 23 2020 at 18:56)</a>:</h4>
<p>heh it has a buffer. so it's the same thing but with extra steps? I thought the reason windows couldn't do the mmap thing was because we were using memory-mapped <em>files</em></p>



<a name="207786377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207786377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207786377">(Aug 23 2020 at 18:57)</a>:</h4>
<p>but this isn't relevant to me because by the time that destructor runs, no more events can be recorded. so it's not what shows up in my data</p>



<a name="207786602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207786602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207786602">(Aug 23 2020 at 19:02)</a>:</h4>
<p>you can also see borrowck is doing something non-deterministic, and it's <em>not</em> death-by-a-thousand-cuts (from the 11k borrowck queries), because 6 out of the largest 10 variances are from borrowck, and <em>they alone</em> add up to ±1784.5, which is like a third of the variance, lol</p>



<a name="207786768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207786768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207786768">(Aug 23 2020 at 19:06)</a>:</h4>
<p>I think the differences in descriptions are from different instances of borrowck which have different sub-events. I could probably figure out what is being borrow-checked simply by enabling query keys, doing a set of runs, and running <code>summarize aggregate</code> on those</p>



<a name="207787556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207787556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207787556">(Aug 23 2020 at 19:26)</a>:</h4>
<p>changed it to "largest 20" and 15 of them are borrowck AFAICT. that makes it ±3499. out of ±4865 (variance of totals across this set of runs). so at least 72% of the variance is coming <em>entirely</em> from within borrowck</p>



<a name="207788176"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207788176" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207788176">(Aug 23 2020 at 19:43)</a>:</h4>
<p>AFAICT it's <em>something in here</em> that introduces a few hundreds instructions of non-deterministic variance (for several executions of <code>mir_borrowck</code>, out of 11k) <a href="https://github.com/rust-lang/rust/blob/05630b06fdf76c25c6ccf2e9ac3567592eae6c67/src/librustc_mir/borrow_check/mod.rs#L110-L188">https://github.com/rust-lang/rust/blob/05630b06fdf76c25c6ccf2e9ac3567592eae6c67/src/librustc_mir/borrow_check/mod.rs#L110-L188</a></p>



<a name="207789608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207789608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207789608">(Aug 23 2020 at 20:21)</a>:</h4>
<p>actually, most are after the <code>nll::replace_regions_in_mir</code> call huh, not before, my bad</p>



<a name="207797293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207797293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207797293">(Aug 23 2020 at 23:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so what you were saying before - heap allocators not taking the exact same number of instructions every time <em>despite</em> producing the exact same sequence of addresses? and we're somehow lucky with arenas? (AFAICT the arena allocations are far less noisy, but I'm not 100% sure yet)</p>



<a name="207797315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207797315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207797315">(Aug 23 2020 at 23:53)</a>:</h4>
<p>I suppose I can use the <code>tcx</code> TLS to just instrument arbitrary things huh</p>



<a name="207797448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207797448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207797448">(Aug 23 2020 at 23:57)</a>:</h4>
<div class="codehilite"><pre><span></span><code>  ±223 ns (after leaving `AFTER report_move_errors` and before leaving `AFTER report_region_errors`)
</code></pre></div>


<p>that's on the destructor side. and there <em>is</em> a variable between those two timers (that owns a bunch of heap allocations)</p>



<a name="207797463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207797463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207797463">(Aug 23 2020 at 23:57)</a>:</h4>
<p>time to figure out how to write an instrumented <code>GlobalAllocator</code></p>



<a name="207797607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207797607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207797607">(Aug 24 2020 at 00:02)</a>:</h4>
<p>well, I can start by trying to enable <code>jemalloc</code>. oh huh, nightlies have it enabled, that's something I didn't klnow</p>



<a name="207797959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207797959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207797959">(Aug 24 2020 at 00:10)</a>:</h4>
<p>I'm seeing about ~400x more noise if I enable <code>jemalloc</code>, which might suggest randomness (at least I think it's about the same as ASLR). but the only (P)RNG I can find in <code>jemalloc</code> has a fixed seed: <a href="https://github.com/jemalloc/jemalloc/blob/092fcac0b4b3854c12c51d22174df00303a3fe6a/src/ckh.c#L376">https://github.com/jemalloc/jemalloc/blob/092fcac0b4b3854c12c51d22174df00303a3fe6a/src/ckh.c#L376</a></p>



<a name="207798209"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207798209" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207798209">(Aug 24 2020 at 00:16)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so the current hypothesis is that <em>somehow</em> allocating/deallocating AST/HIR/MIR (and maybe the arenas' backing storage?) is responsible for most of the remaining variance, if not all of it. if it is, I'm not sure why it would be, or how we would fix it. <code>jemalloc</code> making it worse is worrying, but we could carry a patched version and/or set some compile-time options?</p>



<a name="207799238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799238">(Aug 24 2020 at 00:47)</a>:</h4>
<p>that's weird, <code>wee_alloc</code> still has more or less the same variances in the same places as the default <code>glibc</code> allocator</p>



<a name="207799311"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799311" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799311">(Aug 24 2020 at 00:49)</a>:</h4>
<p>allocation in multi-threaded programs will always mirror the fact that there's no real defined order of malloc/realloc/free calls in such programs.</p>



<a name="207799361"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799361" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799361">(Aug 24 2020 at 00:50)</a>:</h4>
<p>in particular walking freelists is probably where you're seeing the variation.</p>



<a name="207799379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799379">(Aug 24 2020 at 00:51)</a>:</h4>
<p>but the addresses are the same, and there's only one active thread throughout all of this</p>



<a name="207799428"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799428" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799428">(Aug 24 2020 at 00:52)</a>:</h4>
<p>I'm not letting LLVM run (I'm using <code>--emit=metadata</code>), incremental is not enabled, parallel rustc is not enabled</p>



<a name="207799435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799435">(Aug 24 2020 at 00:53)</a>:</h4>
<p>I know the addresses are the same, because the <code>FxHashMap</code>s go wild when they aren't (whether from ASLR or even just the number of base 10 digits of the pid :P)</p>



<a name="207799440"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799440" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799440">(Aug 24 2020 at 00:53)</a>:</h4>
<p>hm <em>shrug</em></p>



<a name="207799484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799484">(Aug 24 2020 at 00:54)</a>:</h4>
<p>I did find something weird in <code>glibc</code>, isn't this UB? (unsynchronized access to global state) <a href="https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/sysdeps/unix/sysv/linux/mmap_internal.h#L29-L33">https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/sysdeps/unix/sysv/linux/mmap_internal.h#L29-L33</a></p>



<a name="207799512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799512">(Aug 24 2020 at 00:55)</a>:</h4>
<p>eh… its probably "fine" given that the call always return the same value.</p>



<a name="207799580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799580">(Aug 24 2020 at 00:57)</a>:</h4>
<p>I guess only the first allocation would hit that, probably inside <code>glibc</code> startup logic, before any threads start. and I think this is more or less just a memory read (bypassing the need for a syscall) <a href="https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/sysdeps/unix/sysv/linux/getpagesize.c#L29">https://github.com/bminor/glibc/blob/5f72f9800b250410cad3abfeeb09469ef12b2438/sysdeps/unix/sysv/linux/getpagesize.c#L29</a></p>



<a name="207799900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207799900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207799900">(Aug 24 2020 at 01:05)</a>:</h4>
<p>ah, <code>GLRO</code> accesses <code>rtld</code> internal state, not something like the vDSO, and the value comes from auxv: <a href="https://github.com/bminor/glibc/blob/be5c5315b95aaddcef38f1d3f4c526401076bd38/elf/dl-sysdep.c#L129-L131">https://github.com/bminor/glibc/blob/be5c5315b95aaddcef38f1d3f4c526401076bd38/elf/dl-sysdep.c#L129-L131</a></p>



<a name="207800025"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207800025" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207800025">(Aug 24 2020 at 01:08)</a>:</h4>
<p>so <code>mmap</code> is probably fine. the only other thing <code>wee_alloc</code> uses, AFAICT, is <code>pthread_mutex_{lock,unlock}</code> (maybe it should use <code>parking_lot</code>?) <a href="https://github.com/rustwasm/wee_alloc/blob/f26c431df6fb6c7df0d6f8e0675471b9c56d8787/wee_alloc/src/imp_unix.rs#L55-L60">https://github.com/rustwasm/wee_alloc/blob/f26c431df6fb6c7df0d6f8e0675471b9c56d8787/wee_alloc/src/imp_unix.rs#L55-L60</a><br>
so I guess now I go try out the bump allocator idea instead</p>



<a name="207800096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207800096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207800096">(Aug 24 2020 at 01:11)</a>:</h4>
<p>ah, here we go, somehow I didn't find this at first <a href="https://crates.io/crates/bump_alloc">https://crates.io/crates/bump_alloc</a></p>



<a name="207800658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207800658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207800658">(Aug 24 2020 at 01:27)</a>:</h4>
<p>a bump allocator is still noisy. what. how. literally cloning a <code>mir::Body</code> is still around ±200 (although only a small number of them, so maybe I'm thinking about this wrong and something <em>happens</em> halfway through the process? but that wouldn't explain <code>hir_lowering</code>...)</p>



<a name="207802079"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207802079" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207802079">(Aug 24 2020 at 02:14)</a>:</h4>
<p>I guess I can go try <code>perf stat -e page-faults:u</code></p>



<a name="207802151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207802151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207802151">(Aug 24 2020 at 02:16)</a>:</h4>
<p>well, it's 140829 every time so I doubt that's it</p>



<a name="207802883"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207802883" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207802883">(Aug 24 2020 at 02:39)</a>:</h4>
<p>yeah okay dropping <code>ast::Crate</code> with noop deallocation still has all of that variance (around ±700 instructions) <span aria-label="shock" class="emoji emoji-1f628" role="img" title="shock">:shock:</span></p>



<a name="207804235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804235">(Aug 24 2020 at 03:21)</a>:</h4>
<p>but overriding <code>free</code> removes that. why would <code>#[global_allocator]</code> not work? is there something broken about dylibs?</p>



<a name="207804597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804597">(Aug 24 2020 at 03:33)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="123586">@nagisa</span> I just plugged this into <code>src/rustc/rustc.rs</code> and nothing breaks lol <a href="https://doc.rust-lang.org/std/alloc/trait.GlobalAlloc.html#example">https://doc.rust-lang.org/std/alloc/trait.GlobalAlloc.html#example</a></p>



<a name="207804605"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804605" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804605">(Aug 24 2020 at 03:33)</a>:</h4>
<p>I guess that explains why <code>wee_alloc</code> behaves like glibc... because I <em>was</em> hitting glibc's allocator</p>



<a name="207804668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804668">(Aug 24 2020 at 03:35)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> wait why do we inject <code>jemalloc</code> in <code>src/rustc/rustc.rs</code>? doesn't that mean e.g. <code>rustdoc</code> doesn't get it?</p>



<a name="207804675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804675">(Aug 24 2020 at 03:35)</a>:</h4>
<p>(without having a copy of that logic. which it doesn't. whereas if it were in <code>librustc_driver</code> it would just apply)</p>



<a name="207804736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804736">(Aug 24 2020 at 03:37)</a>:</h4>
<p><code>librustc_driver</code> <em>also</em> can't override <code>#[global_allocator]</code>, is the feature just broken entirely with dylibs?!</p>



<a name="207804843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804843">(Aug 24 2020 at 03:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207804736">said</a>:</p>
<blockquote>
<p><code>librustc_driver</code> <em>also</em> can't override <code>#[global_allocator]</code>, is the feature just broken entirely with dylibs?!</p>
</blockquote>
<p>very likely it is.</p>



<a name="207804861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804861">(Aug 24 2020 at 03:41)</a>:</h4>
<p>but instead of emitting an error, it's just silently a noop</p>



<a name="207804894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804894">(Aug 24 2020 at 03:42)</a>:</h4>
<p>it might even be platform-dependent :(</p>



<a name="207804928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207804928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207804928">(Aug 24 2020 at 03:43)</a>:</h4>
<p>if anyone else wants to follow along, throw this into <code>src/librustc_driver/lib.rs</code> or <code>src/rustc/rustc.rs</code>, and watch it break nothing:</p>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MyAllocator</span><span class="p">;</span><span class="w"></span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">impl</span><span class="w"> </span><span class="n">std</span>::<span class="n">alloc</span>::<span class="n">GlobalAlloc</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyAllocator</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="nc">std</span>::<span class="n">alloc</span>::<span class="n">Layout</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">dealloc</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">_</span>: <span class="nc">std</span>::<span class="n">alloc</span>::<span class="n">Layout</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="cp">#[global_allocator]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">ALLOC</span>: <span class="nc">MyAllocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyAllocator</span><span class="p">;</span><span class="w"></span>
</code></pre></div>



<a name="207805181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207805181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207805181">(Aug 24 2020 at 03:51)</a>:</h4>
<p>ftr this is what happens even to an empty program that isn't cursed by dylibs <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d07c14ed91d3d023edafd8e12f82bbee">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=d07c14ed91d3d023edafd8e12f82bbee</a></p>



<a name="207805228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207805228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207805228">(Aug 24 2020 at 03:52)</a>:</h4>
<p><code>memory allocation of 4 bytes failed</code> followed by a core-dumping abort</p>



<a name="207858607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207858607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Peter Rabbit <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207858607">(Aug 24 2020 at 15:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/207786305">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <span class="user-mention silent" data-user-id="125250">Wesley Wiser</span> wait what, <code>MmapSerializationSink</code> is just in-memory and writes it out to a file in the destructor?</p>
</blockquote>
<p>Wait, what?! The entire point of a memory mapped file is that you do all your work directly in the memory mapped buffer, not a separate buffer which you linearly read/write the entire thing from/to the file!</p>



<a name="207866686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207866686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207866686">(Aug 24 2020 at 16:49)</a>:</h4>
<p>I suspect it was like that originally, but then somebody refactored it to not be mmap</p>



<a name="207866803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207866803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207866803">(Aug 24 2020 at 16:50)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> it is <code>mmap</code> but it's anon</p>



<a name="207886023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207886023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#207886023">(Aug 24 2020 at 19:29)</a>:</h4>
<p>It was like that from the initial implementation <a href="https://github.com/rust-lang/measureme/pull/12/files">https://github.com/rust-lang/measureme/pull/12/files</a></p>



<a name="209262556"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209262556" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209262556">(Sep 07 2020 at 06:51)</a>:</h4>
<p>had to write this, so if anyone needs it: C-&gt;Rust/<code>GlobalAlloc</code> allocator wrapper (w/o <code>aligned_alloc</code> because I'm lazy and neither Rust nor LLVM seem to use it): <a href="https://gist.github.com/eddyb/df25e28313b37c8c9519bc503541f4b0">https://gist.github.com/eddyb/df25e28313b37c8c9519bc503541f4b0</a></p>



<a name="209262577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209262577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209262577">(Sep 07 2020 at 06:51)</a>:</h4>
<p>hopefully <em>now</em> I can actually test what I was trying to use <code>#[global_allocator]</code> for</p>



<a name="209568207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209568207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209568207">(Sep 09 2020 at 21:01)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> glibc allocator non-determinism demo (the two runs will likely produce different instruction counts)</p>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/0c21da49b86ebd5273a1a31598fcd69c4ac7dcf8/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="209568330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209568330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209568330">(Sep 09 2020 at 21:02)</a>:</h4>
<p>maybe I should give up on this but it was bothering me that I couldn't reproduce the non-isolated rustc non-determinism</p>



<a name="209568450"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209568450" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209568450">(Sep 09 2020 at 21:03)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Counter::new: version=0 compat_version=0 index=0x4
CpuModel::detect: vendor=&quot;AuthenticAMD&quot; family=23 model=113
CpuModel::detect: known AMD CPU: Zen 2 (Matisse)
Counter::new: version=0 compat_version=0 index=0x5

# `rdpmc` benchmarks: `Box::new(0u8)` noise

### `100000` iterations
-2595320
-2595305
-2595305
-2595467
-2595269
-2595305
-2595467
-2595305
-2595304
-2595467

total=-25953514

rdpmc-bench instructions:u=224066205 hw_interrupts.received:u=3
Counter::new: version=0 compat_version=0 index=0x4
CpuModel::detect: vendor=&quot;AuthenticAMD&quot; family=23 model=113
CpuModel::detect: known AMD CPU: Zen 2 (Matisse)
Counter::new: version=0 compat_version=0 index=0x5

# `rdpmc` benchmarks: `Box::new(0u8)` noise

### `100000` iterations
-2595320
-2595305
-2595305
-2595467
-2595304
-2595305
-2595467
-2595305
-2595304
-2595467

total=-25953549

rdpmc-bench instructions:u=224066171 hw_interrupts.received:u=4
</code></pre></div>



<a name="209568563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209568563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209568563">(Sep 09 2020 at 21:04)</a>:</h4>
<p>aha, got a run with same number of interrupts:</p>
<div class="codehilite"><pre><span></span><code>### `100000` iterations
-2595320
-2595305
-2595305
-2595467
-2595304
-2595305
-2595467
-2595305
-2595304
-2595467

total=-25953549

rdpmc-bench instructions:u=224066171 hw_interrupts.received:u=4

-2595320
-2595305
-2595305
-2595467
-2595304
-2595305
-2595467
-2595305
-2595304
-2595467

total=-25953549

rdpmc-bench instructions:u=224066171 hw_interrupts.received:u=4
</code></pre></div>



<a name="209568593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209568593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209568593">(Sep 09 2020 at 21:05)</a>:</h4>
<p>that one looks identical</p>



<a name="209568621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209568621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209568621">(Sep 09 2020 at 21:05)</a>:</h4>
<p>I was able to get the same number of interrupts but different instructions</p>



<a name="209568792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209568792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209568792">(Sep 09 2020 at 21:06)</a>:</h4>
<p>hm, I'll try running it several times I guess</p>



<a name="209568824"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209568824" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209568824">(Sep 09 2020 at 21:07)</a>:</h4>
<p><code>page-faults:u</code> is always the same if I use <code>setarch x86_64 -R perf stat -e page-faults:u ./rdpmc-bench</code> but maybe that doesn't include everything? also glibc could be doing something weird, maybe I should check what syscalls it uses</p>



<a name="209568861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209568861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209568861">(Sep 09 2020 at 21:07)</a>:</h4>
<p>so far I <em>always</em> get the same amount of instructions with interrupts being equal, across maybe 5 instances of that happening</p>



<a name="209569153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209569153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209569153">(Sep 09 2020 at 21:10)</a>:</h4>
<p>total=-25953549 seems like the number, interestingly I can see that number both with 4 and 5 interrupts</p>



<a name="209569168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209569168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209569168">(Sep 09 2020 at 21:10)</a>:</h4>
<p>e.g.</p>
<div class="codehilite"><pre><span></span><code>### `100000` iterations
-2595320
-2595305
-2595305
-2595467
-2595304
-2595305
-2595467
-2595305
-2595304
-2595467

total=-25953549

rdpmc-bench instructions:u=224066172 hw_interrupts.received:u=5
</code></pre></div>



<a name="209571908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209571908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209571908">(Sep 09 2020 at 21:36)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I don't <em>think</em> the interrupts are that important, at least given that everything else I've tried seems to be deterministic once accounting for interrupts (which is already handled in the <code>total</code>). I think I need to try and <code>strace</code> it now (especially with it pretty self-contained. I would not dare <code>strace</code> <code>rustc</code> itself, heh)</p>



<a name="209573942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209573942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209573942">(Sep 09 2020 at 21:59)</a>:</h4>
<div class="codehilite"><pre><span></span><code><span class="gu">@@ -95 +95 @@</span>
<span class="gd">-set_tid_address(0x7ffff7dce2d0)         = 19624</span>
<span class="gi">+set_tid_address(0x7ffff7dce2d0)         = 19630</span>
<span class="gu">@@ -114 +114 @@</span>
<span class="gd">-sched_getaffinity(19624, 32, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47]) = 32</span>
<span class="gi">+sched_getaffinity(19630, 32, [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47]) = 32</span>
<span class="gu">@@ -126,2 +126,2 @@</span>
<span class="gd">-clone(child_stack=0x7ffff7dc8ef0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tid=[19625], tls=0x7ffff7dc9700, child_tidptr=0x7ffff7dc99d0) = 19625</span>
<span class="gd">-futex(0x7ffff7dc99d0, FUTEX_WAIT, 19625, NULL) = 0</span>
<span class="gi">+clone(child_stack=0x7ffff7dc8ef0, flags=CLONE_VM|CLONE_FS|CLONE_FILES|CLONE_SIGHAND|CLONE_THREAD|CLONE_SYSVSEM|CLONE_SETTLS|CLONE_PARENT_SETTID|CLONE_CHILD_CLEARTID, parent_tid=[19631], tls=0x7ffff7dc9700, child_tidptr=0x7ffff7dc99d0) = 19631</span>
<span class="gi">+futex(0x7ffff7dc99d0, FUTEX_WAIT, 19631, NULL) = 0</span>
<span class="gu">@@ -415 +415 @@</span>
<span class="gd">-write(1, &quot;-495601\n&quot;, 8)                = 8</span>
<span class="gi">+write(1, &quot;-495605\n&quot;, 8)                = 8</span>
<span class="gu">@@ -417 +417 @@</span>
<span class="gd">-write(1, &quot;total=-4954938\n&quot;, 15)        = 15</span>
<span class="gi">+write(1, &quot;total=-4954942\n&quot;, 15)        = 15</span>
<span class="gu">@@ -421 +421 @@</span>
<span class="gd">-write(2, &quot;245066655&quot;, 9245066655)                = 9</span>
<span class="gi">+write(2, &quot;245066656&quot;, 9245066656)                = 9</span>
<span class="gu">@@ -423 +423 @@</span>
<span class="gd">-write(2, &quot;28&quot;, 228)                       = 2</span>
<span class="gi">+write(2, &quot;33&quot;, 233)                       = 2</span>
</code></pre></div>



<a name="209574006"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209574006" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209574006">(Sep 09 2020 at 22:00)</a>:</h4>
<p>there's almost nothing! just the thread ID</p>



<a name="209575519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209575519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209575519">(Sep 09 2020 at 22:18)</a>:</h4>
<p>not liking this, I'm worried it's effectively a thread ID-keyed hashmap <a href="https://github.com/bminor/glibc/blob/e74b61c09a2a2ab52153e731225ccba5078659b1/malloc/malloc.c#L302-L313">https://github.com/bminor/glibc/blob/e74b61c09a2a2ab52153e731225ccba5078659b1/malloc/malloc.c#L302-L313</a></p>



<a name="209575725"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209575725" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209575725">(Sep 09 2020 at 22:20)</a>:</h4>
<p>this seems potentially useful <a href="https://people.cs.umass.edu/~emery/pubs/dthreads-sosp11.pdf">https://people.cs.umass.edu/~emery/pubs/dthreads-sosp11.pdf</a></p>



<a name="209575818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209575818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209575818">(Sep 09 2020 at 22:22)</a>:</h4>
<p>wait I might be misreading <code>tidx</code> as (tid)x when it's probably t(idx)</p>



<a name="209576925"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209576925" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209576925">(Sep 09 2020 at 22:34)</a>:</h4>
<p>I wonder if there's an easy way to "just" dump a full instruction trace. like <code>ptrace</code> single-step the entire program and log the instruction pointer or something</p>



<a name="209577161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209577161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209577161">(Sep 09 2020 at 22:37)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> You could also run the program in a container where it always gets the same PID.</p>



<a name="209677611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209677611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209677611">(Sep 10 2020 at 17:02)</a>:</h4>
<p>ahhh right I was trying to not forget about looking for some way to do that, but forgot anyway. thanks!</p>



<a name="209677813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209677813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209677813">(Sep 10 2020 at 17:04)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> however, I'm starting to doubt <code>glibc</code> is at fault at all here. I can reproduce some non-determinism with just a custom bump allocator (copied from the <code>bump_alloc</code> crate) called through <code>Box::new</code>:</p>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/32cb521017fa593dfe6e6d69cb12d8012c761061/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="209677950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209677950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209677950">(Sep 10 2020 at 17:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209577161">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> You could also run the program in a container where it always gets the same PID.</p>
</blockquote>
<p>maybe even <em>just</em> a new pid namespace, without an entire container</p>



<a name="209678244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209678244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209678244">(Sep 10 2020 at 17:06)</a>:</h4>
<p><code>systemd-nspawn</code> is what I was going to check if it creates deterministic PIDs</p>



<a name="209678731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209678731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209678731">(Sep 10 2020 at 17:10)</a>:</h4>
<p>but I'm not sure it matters now. with <code>bump_alloc</code>, I can even turn off the glibc multithreading and still get nondeterminism:</p>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/a4318c8538707ca160902b770911e46591ea3c2d/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="209678769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209678769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209678769">(Sep 10 2020 at 17:10)</a>:</h4>
<p>(though I really just forgot initially that I had the dummy thread there from last time)</p>



<a name="209678815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209678815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209678815">(Sep 10 2020 at 17:10)</a>:</h4>
<p>maybe just <code>unshare -fp</code> is enough</p>



<a name="209678984"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209678984" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209678984">(Sep 10 2020 at 17:12)</a>:</h4>
<p>interestingly, the "touch a byte at the start of every page" inline assembly loop <em>was</em> deterministic, so I must be missing something simple</p>



<a name="209681431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209681431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209681431">(Sep 10 2020 at 17:33)</a>:</h4>
<p>I'd still try deterministic PIDs to rule out that source of nondeterminism if you can.</p>



<a name="209681538"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209681538" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209681538">(Sep 10 2020 at 17:34)</a>:</h4>
<p>And yeah, <code>unshare -fp</code> ought to be enough.</p>



<a name="209684145"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209684145" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209684145">(Sep 10 2020 at 17:54)</a>:</h4>
<p>yeah I need to try it on a whole <code>rustc</code>, but I'm still trying to figure out what this effect is. I must've had some flaw in my "touch a byte at the start of every page" artificial benchmark, because this allocator is getting really close to what that was</p>



<a name="209699161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699161">(Sep 10 2020 at 19:43)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> looks like it's atomics? and since allocators love to use atomics, that's how they factor in?<br>
this one is just <code>fetch_add(1)</code> in a loop:</p>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/36f2960561fe0871c85f7ddf8c2ff560b6f73774/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="209699238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699238">(Sep 10 2020 at 19:43)</a>:</h4>
<p>Oh, I guess maybe they're lowering to loops rather than single instructions?</p>



<a name="209699300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699300">(Sep 10 2020 at 19:43)</a>:</h4>
<p>I thought that was an ARM thing, not an x86 thing, but I could believe it -- if it's not a fetch_add and a CAS instead, in particular</p>



<a name="209699383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699383">(Sep 10 2020 at 19:44)</a>:</h4>
<p>I doubt that's it. also this is on the stack, there's 0 contention, even a loop would be deterministic :|</p>



<a name="209699424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699424">(Sep 10 2020 at 19:44)</a>:</h4>
<p>hm, compare_exchange_weak is technically allowed to fail spuriously</p>



<a name="209699485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699485">(Sep 10 2020 at 19:45)</a>:</h4>
<p>but I think no one does that? At least I don't think I was able to trigger that ever on zen but that was zen 1</p>



<a name="209699557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699557">(Sep 10 2020 at 19:46)</a>:</h4>
<p>it's <code>lock xadd</code> <a href="https://godbolt.org/z/7hKnvo">https://godbolt.org/z/7hKnvo</a></p>



<a name="209699656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699656">(Sep 10 2020 at 19:46)</a>:</h4>
<p>I don't see how that can cause instruction-count differences</p>



<a name="209699807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699807">(Sep 10 2020 at 19:47)</a>:</h4>
<p>can you check my most recent testcase on Zen 2? and if it doesn't repro at first, run <code>setarch x86_64 -R ./rdpmc-bench</code> a few times</p>



<a name="209699817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209699817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209699817">(Sep 10 2020 at 19:47)</a>:</h4>
<p>though ASLR shouldn't matter</p>



<a name="209700166"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700166" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700166">(Sep 10 2020 at 19:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> haha, <span class="user-mention" data-user-id="310399">@Mara</span> repro'd the overcounting I'm seeing (on Zen 1), on pre-Zen AMD</p>



<a name="209700219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700219">(Sep 10 2020 at 19:50)</a>:</h4>
<p>whereas Intel seems to only undercount (though I think that's hyperthreading bugs)</p>



<a name="209700318"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700318" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700318">(Sep 10 2020 at 19:51)</a>:</h4>
<p>what am I looking for on zen 2?</p>



<a name="209700335"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700335" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700335">(Sep 10 2020 at 19:51)</a>:</h4>
<p>any values other than 0</p>



<a name="209700350"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700350" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700350">(Sep 10 2020 at 19:51)</a>:</h4>
<p>aha, I am seeing lots of -2 and one -1 across 4 runs so far</p>



<a name="209700364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700364">(Sep 10 2020 at 19:52)</a>:</h4>
<p>ughh that's not great</p>



<a name="209700421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700421">(Sep 10 2020 at 19:52)</a>:</h4>
<div class="codehilite"><pre><span></span><code># `rdpmc` benchmarks: `fetch_add(1)` noise

### `100000000` iterations
-2
-2
-2
-2
-2
-2
-2
-2
-2
-2

total=-20

rdpmc-bench instructions:u=5000019999 hw_interrupts.received:u=1000
Counter::new: version=0 compat_version=0 index=0x4
CpuModel::detect: vendor=&quot;AuthenticAMD&quot; family=23 model=113
CpuModel::detect: known AMD CPU: Zen 2 (Matisse)
Counter::new: version=0 compat_version=0 index=0x5

# `rdpmc` benchmarks: `fetch_add(1)` noise

### `100000000` iterations
-2
-2
-2
-1
-2
-2
-2
-2
-2
-2

total=-19

rdpmc-bench instructions:u=5000019999 hw_interrupts.received:u=999
</code></pre></div>



<a name="209700482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700482">(Sep 10 2020 at 19:52)</a>:</h4>
<p>(no idea why we're seeing 1000s of interrupts now)</p>



<a name="209700515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700515">(Sep 10 2020 at 19:52)</a>:</h4>
<p>well, maybe that's a compiler difference? hmm</p>



<a name="209700575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700575">(Sep 10 2020 at 19:53)</a>:</h4>
<p>actually, wait, did we ever confirm we still have to subtract interrupts from instructions on Zen 2?</p>



<a name="209700598"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700598" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700598">(Sep 10 2020 at 19:53)</a>:</h4>
<p>not sure. that file has RawVec allocations in it?</p>



<a name="209700668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700668">(Sep 10 2020 at 19:54)</a>:</h4>
<p>maybe that's before the collection starts, anyway</p>



<a name="209700732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700732">(Sep 10 2020 at 19:54)</a>:</h4>
<p>maybe Zen 2 is fine but I don't have Zen 2 to develop on :(</p>



<a name="209700780"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700780" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700780">(Sep 10 2020 at 19:55)</a>:</h4>
<p>I can get you ssh onto the perf collector, but that's not a good place to do sporadic development</p>



<a name="209700802"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700802" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700802">(Sep 10 2020 at 19:55)</a>:</h4>
<p>something weird I just noticed is that all of my non-deterministic overcounting comes in multiples of 5 o_O</p>



<a name="209700835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209700835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209700835">(Sep 10 2020 at 19:55)</a>:</h4>
<p>which is also the number of instructions per iteration</p>



<a name="209701247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209701247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209701247">(Sep 10 2020 at 19:58)</a>:</h4>
<p>(though not the older AMD <span class="user-mention" data-user-id="310399">@Mara</span> got to overcount)</p>



<a name="209701748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209701748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209701748">(Sep 10 2020 at 20:02)</a>:</h4>
<p>so the errata says exiting C6 causes inaccuracies. can atomics interact with C6?</p>



<a name="209703075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209703075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209703075">(Sep 10 2020 at 20:13)</a>:</h4>
<p><del>okay <span class="user-mention" data-user-id="310399">@Mara</span>  has confirmed it's not atomics, but maybe something else in my loop. I need to play around with it a bit more I guess.</del> though I should also make sure I'm taking into account mine is Zen 1</p>



<a name="209704128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209704128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209704128">(Sep 10 2020 at 20:22)</a>:</h4>
<p>ah yeah I can't repro with a non-atomic <code>add</code> or <code>xadd</code>, on Zen 1</p>



<a name="209706091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209706091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209706091">(Sep 10 2020 at 20:40)</a>:</h4>
<p><del>@<strong>simulacrum</strong> in the process of trying to use inline assembly I stumbled over manual <code>lock xadd</code> being <em>incredibly</em> slow for some reason. this is that testcase if you're curious:</del></p>
<p><del><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/72e2ffca8869e52a866dcb6c4f6352c11976d8c2/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></del></p>



<a name="209706128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209706128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209706128">(Sep 10 2020 at 20:41)</a>:</h4>
<p><del>it takes like a minute to print the first <code>0</code>, on Zen 1. works fine on my Ivy Bridge laptop though</del></p>



<a name="209706143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209706143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209706143">(Sep 10 2020 at 20:41)</a>:</h4>
<p>hm, pretty much instant here</p>



<a name="209706158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209706158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209706158">(Sep 10 2020 at 20:41)</a>:</h4>
<p>or at least not appreciably different from the other scripts</p>



<a name="209706169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209706169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209706169">(Sep 10 2020 at 20:41)</a>:</h4>
<p>-1s mostly, one 0 here with that</p>



<a name="209706260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209706260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209706260">(Sep 10 2020 at 20:42)</a>:</h4>
<p>ftr <code>mov {tmp}, 1; lock xadd qword ptr [{atomic}], {tmp}</code> is what's in the inline assembly</p>



<a name="209706547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209706547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209706547">(Sep 10 2020 at 20:44)</a>:</h4>
<p>PEBKAC, I wrote <code>0</code> and didn't specify it as <code>usize</code> so I'm trashing the stack...</p>



<a name="209707531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209707531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209707531">(Sep 10 2020 at 20:52)</a>:</h4>
<p>so: 1. <code>lock xadd</code> overcounts for me, <code>xadd</code> doesn't, and 2. now it's in multiples of 4, but also each loop iteration is 4 instructions, so that's probably connected. will try adding some <code>nop</code>s</p>



<a name="209707974"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209707974" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209707974">(Sep 10 2020 at 20:56)</a>:</h4>
<p>I added 3 nops and now it's overcounting in multiples of 7 :P</p>



<a name="209708524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209708524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209708524">(Sep 10 2020 at 21:01)</a>:</h4>
<p>and now I was able to make it do multiples of 19 (I'm using primes to make the results as distinct as possible)</p>



<a name="209708627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209708627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209708627">(Sep 10 2020 at 21:01)</a>:</h4>
<p>how can this even happen? it's treating the entire BB as a transaction?</p>



<a name="209710226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209710226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209710226">(Sep 10 2020 at 21:15)</a>:</h4>
<p><span class="user-mention" data-user-id="310399">@Mara</span> had this idea:</p>
<blockquote>
<p>is it speculatively executing until the next <code>lock</code> which then conflicts with the existing <code>lock</code> and throws the whole thing out?</p>
</blockquote>
<p>and... my testing seems to confirm it? if I have multiple <code>lock xadd</code>s, the distance between them (including going across the loop backedge) is what is being overcounted</p>



<a name="209712244"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712244" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712244">(Sep 10 2020 at 21:31)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="138448">@cuviper</span> excuse me?? <a href="https://patents.google.com/patent/US20180074977A1/en">https://patents.google.com/patent/US20180074977A1/en</a></p>



<a name="209712334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712334">(Sep 10 2020 at 21:32)</a>:</h4>
<blockquote>
<p>In the event that the processor detects a violation of the atomic or fencing properties of the lock instruction prior to committing the value of the lock instruction, the processor rolls back state and executes the lock instruction in a slow mode in which younger instructions are not allowed to retire until the stored value of the lock instruction is committed</p>
</blockquote>



<a name="209712415"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712415" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712415">(Sep 10 2020 at 21:33)</a>:</h4>
<p>I don't know if AMD processors actually <em>do</em> that, but that certainly sounds like a thing processors <em>could</em> coordinate to do.</p>



<a name="209712488"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712488" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712488">(Sep 10 2020 at 21:33)</a>:</h4>
<p>I mean, I have no other explanation for the overcounting in <em>exact multiples</em> of whatever number of instructions I put between consecutive <code>lock</code>s</p>



<a name="209712548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712548">(Sep 10 2020 at 21:34)</a>:</h4>
<p>Sure sounds plausible.</p>



<a name="209712589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712589">(Sep 10 2020 at 21:34)</a>:</h4>
<p>You could do a speculation-defeating pattern after the locking instruction.</p>



<a name="209712608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712608">(Sep 10 2020 at 21:34)</a>:</h4>
<p>retpoline or similar.</p>



<a name="209712773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712773">(Sep 10 2020 at 21:36)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so I think this is my best testcase so far, thanks to the primes involved:</p>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/f99379ef009ea955347a2352aa6fb0f7f98bd8e8/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="209712841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712841">(Sep 10 2020 at 21:37)</a>:</h4>
<p>mostly -1s, couple zeros snuck in</p>



<a name="209712901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209712901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209712901">(Sep 10 2020 at 21:37)</a>:</h4>
<p>so what I'm seeing is values that are 13x+17y (e.g. I got 13, 17, 26, 30, 56)</p>



<a name="209713063"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209713063" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209713063">(Sep 10 2020 at 21:39)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I forget, did you have access to Zen 1 at all?</p>



<a name="209713081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209713081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209713081">(Sep 10 2020 at 21:39)</a>:</h4>
<p>or was it someone else</p>



<a name="209713097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209713097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209713097">(Sep 10 2020 at 21:39)</a>:</h4>
<p>I don't readily, but if absolutely necessary can get it</p>



<a name="209713113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209713113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209713113">(Sep 10 2020 at 21:39)</a>:</h4>
<p>(it's not a computer I have ssh into, so I need to ask someone else to run things)</p>



<a name="209713190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209713190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209713190">(Sep 10 2020 at 21:40)</a>:</h4>
<p>we need to get <a href="http://build.lyken.rs">build.lyken.rs</a> onto Zen 2, but the sysadmin has been p busy</p>



<a name="209713230"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209713230" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209713230">(Sep 10 2020 at 21:40)</a>:</h4>
<p>well, give it ~3-4 months and Zen 3 will be along</p>



<a name="209714110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714110">(Sep 10 2020 at 21:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> someone on Zen 2 confirmed 13x+17y (e.g. <a href="https://puck.moe/up/bulig-valod.txt">https://puck.moe/up/bulig-valod.txt</a>)</p>



<a name="209714150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714150">(Sep 10 2020 at 21:51)</a>:</h4>
<p>hm well my Zen 2 never went above 0</p>



<a name="209714152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714152">(Sep 10 2020 at 21:51)</a>:</h4>
<p>but maybe I didn't run it enough</p>



<a name="209714165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714165">(Sep 10 2020 at 21:51)</a>:</h4>
<p>you have to add 1 because of the compiler version thing or w/e, but you can see the 13 (shown as 12)</p>



<a name="209714179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714179">(Sep 10 2020 at 21:51)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I'm actually wondering if you did anything to it :P</p>



<a name="209714185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714185">(Sep 10 2020 at 21:51)</a>:</h4>
<p>that might've fixed this</p>



<a name="209714271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714271">(Sep 10 2020 at 21:52)</a>:</h4>
<p>hm nmi watchdog is on, though perf event paranoid is at -1</p>



<a name="209714279"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714279" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714279">(Sep 10 2020 at 21:52)</a>:</h4>
<p>but I don't think so</p>



<a name="209714307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714307">(Sep 10 2020 at 21:52)</a>:</h4>
<p>I have a 3950x so it's plausible you need the kernel to basically not be on your CPU core? and many cores helps with that?</p>



<a name="209714316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714316">(Sep 10 2020 at 21:52)</a>:</h4>
<p>do you have that C6 thing?</p>



<a name="209714341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714341">(Sep 10 2020 at 21:53)</a>:</h4>
<p>hm, I'm sure the processor does</p>



<a name="209714362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714362">(Sep 10 2020 at 21:53)</a>:</h4>
<p>sorry, I mean, the workaround you linked a few weeks ago</p>



<a name="209714396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714396">(Sep 10 2020 at 21:53)</a>:</h4>
<p>no, c6 is enabled</p>



<a name="209714414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714414">(Sep 10 2020 at 21:53)</a>:</h4>
<p>did you try only on one machine?</p>



<a name="209714418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714418">(Sep 10 2020 at 21:53)</a>:</h4>
<div class="codehilite"><pre><span></span><code>P0 - Enabled - FID = 8C - DID = 8 - VID = 48 - Ratio = 35.00 - vCore = 1.10000
P1 - Enabled - FID = 8C - DID = A - VID = 58 - Ratio = 28.00 - vCore = 1.00000
P2 - Enabled - FID = 84 - DID = C - VID = 68 - Ratio = 22.00 - vCore = 0.90000
P3 - Disabled
P4 - Disabled
P5 - Disabled
P6 - Disabled
P7 - Disabled
C6 State - Package - Enabled
C6 State - Core - Enabled
</code></pre></div>



<a name="209714486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714486">(Sep 10 2020 at 21:54)</a>:</h4>
<p>I only have one zen 2</p>



<a name="209714495"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714495" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714495">(Sep 10 2020 at 21:54)</a>:</h4>
<p>oh, I guess I could do the perf collector</p>



<a name="209714568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714568">(Sep 10 2020 at 21:55)</a>:</h4>
<p>perf collector is normally 0, and hit one 17</p>



<a name="209714593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714593">(Sep 10 2020 at 21:55)</a>:</h4>
<p>yes :D. well, it sucks, but at least I'm not crazy</p>



<a name="209714619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714619">(Sep 10 2020 at 21:55)</a>:</h4>
<p>hm now I wonder, perf collector is currently at llvm 10</p>



<a name="209714753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714753">(Sep 10 2020 at 21:56)</a>:</h4>
<p>okay so llvm 11 gives me -1 and a 25 on perf collector</p>



<a name="209714768"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714768" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714768">(Sep 10 2020 at 21:57)</a>:</h4>
<p>that's a 2*13-1</p>



<a name="209714803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209714803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209714803">(Sep 10 2020 at 21:57)</a>:</h4>
<p>the -1 must be llvm 11 emitting one less instruction in the setup code, nice :P</p>



<a name="209716445"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209716445" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209716445">(Sep 10 2020 at 22:14)</a>:</h4>
<p>I have 2700X in my desktop, it's Zen+. So I can help if you need something from it.</p>



<a name="209716619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209716619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209716619">(Sep 10 2020 at 22:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209712773">said</a>:</p>
<blockquote>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/f99379ef009ea955347a2352aa6fb0f7f98bd8e8/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>
</blockquote>
<p>if anyone wants to try it out, this is the thing to run ^^ (what to look for: the individual lines with just a number on them. ideally they're all <code>0</code>, or if you're on LLVM 11, <code>-1</code>. on top of that, deviations of the form 13x+17y is what we're looking for)</p>



<a name="209716796"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209716796" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209716796">(Sep 10 2020 at 22:18)</a>:</h4>
<p><span class="user-mention" data-user-id="119581">@mati865</span> ^^</p>



<a name="209717499"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209717499" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209717499">(Sep 10 2020 at 22:27)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> <a href="https://gist.github.com/mati865/22336da383dd6738f7ce32a3a4cb2eff">https://gist.github.com/mati865/22336da383dd6738f7ce32a3a4cb2eff</a></p>



<a name="209717577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209717577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209717577">(Sep 10 2020 at 22:28)</a>:</h4>
<p>yupp, that reproduced. and you're on LLVM 11 :D</p>



<a name="209717634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209717634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209717634">(Sep 10 2020 at 22:29)</a>:</h4>
<blockquote>
<p><code>CpuModel::detect: known AMD CPU: Zen+ (Pinnacle Ridge)</code></p>
</blockquote>
<p>still really happy with my unnecessarily precise CPU detection logic :P</p>



<a name="209717654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209717654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209717654">(Sep 10 2020 at 22:29)</a>:</h4>
<p>Well, it's nightly ;)</p>



<a name="209717674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209717674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209717674">(Sep 10 2020 at 22:29)</a>:</h4>
<p>telling on myself by having older nightly on both my laptop and the server,</p>



<a name="209717799"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209717799" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209717799">(Sep 10 2020 at 22:31)</a>:</h4>
<p>IMO that logic makes sense.</p>



<a name="209717845"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209717845" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209717845">(Sep 10 2020 at 22:31)</a>:</h4>
<p>I could access desktop with 1600 (truly Zen 1) tomorrow if you want.</p>



<a name="209718009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209718009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209718009">(Sep 10 2020 at 22:33)</a>:</h4>
<p>only if it's not a hassle. so far I think we've confirmed it across all existing Zen, with the exception of some Zen 2 machines seemingly not being affected (i.e. simulacrum's)</p>



<a name="209718110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209718110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209718110">(Sep 10 2020 at 22:35)</a>:</h4>
<p>the trickier problem is figuring what, if anything, we can do about it. there's enough atomics in close proximity in <em>at least</em> global allocators, to cause measurable noise</p>



<a name="209718348"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209718348" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209718348">(Sep 10 2020 at 22:38)</a>:</h4>
<p>it's not relatively significant at the scale of the whole process, but it can cause differences of hundreds of instructions between different runs, in parts of the compiler which do a lot of allocations</p>



<a name="209721276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209721276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209721276">(Sep 10 2020 at 23:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> theory: this kind of <code>lock</code> speculation is a potential side-channel. potential consequence: maybe there's a microcode update and/or some MSR bit that turns it off</p>



<a name="209721327"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209721327" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209721327">(Sep 10 2020 at 23:18)</a>:</h4>
<p>seems not impossible</p>



<a name="209721336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209721336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209721336">(Sep 10 2020 at 23:18)</a>:</h4>
<p>what are the kernel versions on the two Zen 2 machines?</p>



<a name="209721376"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209721376" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209721376">(Sep 10 2020 at 23:18)</a>:</h4>
<p>the one that doesn't exhibit the behavior has 5.4.0-42-generic and the one that does is 4.15.0-70-generic</p>



<a name="209721435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209721435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209721435">(Sep 10 2020 at 23:19)</a>:</h4>
<p>hmpf. I repro'd on Zen 1 on 5.4.12. but maybe this is Zen 1 vs Zen 2</p>



<a name="209721540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209721540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209721540">(Sep 10 2020 at 23:21)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> ahh the other Zen 2 repro was 5.6.15. so probably it's not (just) the kernel version</p>



<a name="209748029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209748029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209748029">(Sep 11 2020 at 07:19)</a>:</h4>
<p>I ran it on Zen 2 and also get lots of different non -1 values: <a href="https://gist.github.com/jix/36ee39cc54c734c90f46ba8e4e8f80c1">https://gist.github.com/jix/36ee39cc54c734c90f46ba8e4e8f80c1</a></p>



<a name="209749695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209749695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209749695">(Sep 11 2020 at 07:41)</a>:</h4>
<p>thanks!</p>



<a name="209749813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209749813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209749813">(Sep 11 2020 at 07:43)</a>:</h4>
<p>so last night I tried to make an even smaller benchmark, based on a suggestion that a child thread could interfere, but didn't get anywhere. I guess I can try adding it to the existing setup I have</p>



<a name="209750200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209750200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209750200">(Sep 11 2020 at 07:50)</a>:</h4>
<p>that's interesting, in <code>rdpmc-bench.rs</code>, an interfering thread noticeably slows down the execution on my laptop, which results in a lot more undercounting, but I think that's consistent with the undercounting being proportional to execution time (since it's likely the hyperthreading issue)</p>



<a name="209750461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209750461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209750461">(Sep 11 2020 at 07:53)</a>:</h4>
<p>and on Zen 1, I can see the additional overcounting from having that other thread interfere, even if it's only e.g. a million instructions out of 3 billion</p>



<a name="209750949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209750949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209750949">(Sep 11 2020 at 08:00)</a>:</h4>
<p>aha! I can make it much worse with nops:</p>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/799934eb7e5af03cc0197672945bed51bf76a8d0/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="209751266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209751266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209751266">(Sep 11 2020 at 08:04)</a>:</h4>
<p>(I think I made the overcounting ~100x worse just by giving it more instructions to speculate <em>quickly</em>)</p>



<a name="209751599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209751599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209751599">(Sep 11 2020 at 08:08)</a>:</h4>
<p>yeah <a href="https://gist.github.com/jix/6da90c02b76e06d7ed31a288f544fbac">https://gist.github.com/jix/6da90c02b76e06d7ed31a288f544fbac</a></p>



<a name="209751617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209751617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209751617">(Sep 11 2020 at 08:09)</a>:</h4>
<p>haha that looks about right</p>



<a name="209751708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209751708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209751708">(Sep 11 2020 at 08:10)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so if you have a Zen machine where that last testcase doesn't go <em>at least</em> into the millions, we need to figure out what makes it special. maybe it's a distro default? like I suspect hardening for spectre/meltdown/etc. might've disabled this too</p>



<a name="209754087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209754087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209754087">(Sep 11 2020 at 08:39)</a>:</h4>
<p>btw, feel free to ping me if you need anything tested on zen 2 (although mine doesn't seem to be that special)</p>



<a name="209754498"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209754498" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209754498">(Sep 11 2020 at 08:45)</a>:</h4>
<p>also do you think it'd be useful to test with "mitigations=off" (should disable all those hardening stuff)? I need to reboot anyway soonish and could try that</p>



<a name="209755225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209755225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209755225">(Sep 11 2020 at 08:53)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> this is (literally) patented speculation, I don't think <em>disabling</em> mitigations would improve things, but feel free to try</p>



<a name="209755291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209755291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209755291">(Sep 11 2020 at 08:54)</a>:</h4>
<p>ideally we could just enable mitigations and have it become deterministic</p>



<a name="209755292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209755292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209755292">(Sep 11 2020 at 08:54)</a>:</h4>
<p>ah I was referring to "we need to figure out what makes it special. maybe it's a distro default? like I suspect hardening for spectre/meltdown/etc."</p>



<a name="209755322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209755322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209755322">(Sep 11 2020 at 08:54)</a>:</h4>
<p>oh but it would affect it the other way around?</p>



<a name="209755330"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209755330" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209755330">(Sep 11 2020 at 08:54)</a>:</h4>
<p>right, I guess that's what <span class="user-mention" data-user-id="116122">@simulacrum</span> could try, if rebooting is an option (on the machine we couldn't repro)</p>



<a name="209755340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209755340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209755340">(Sep 11 2020 at 08:54)</a>:</h4>
<p>whereas for you, if anything it should make it worse :P</p>



<a name="209755486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209755486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209755486">(Sep 11 2020 at 08:56)</a>:</h4>
<p>well I guess given that I have a quite recent kernel with all mitigations on and AFAIK also the latest microcode updates there is no point in disabling anything of that...</p>



<a name="209756249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756249">(Sep 11 2020 at 09:05)</a>:</h4>
<p>okay this is 50 instructions, most of the time speculation goes through all of them (and I've made it easier to tell when it's multiples of the distance i.e. 50 here):</p>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/72ca37ead3989686643f77a52ff4a49cfacecffd/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="209756313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756313">(Sep 11 2020 at 09:05)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> oof, worried that means there's no way to turn it on. maybe <span class="user-mention" data-user-id="116122">@simulacrum</span> can finally repro with this active interference setup and there wasn't any unaffected Zen 2 to begin with :(</p>



<a name="209756478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756478">(Sep 11 2020 at 09:07)</a>:</h4>
<p><a href="https://gist.github.com/jix/092f9358940d75a605414eb1317857a3">https://gist.github.com/jix/092f9358940d75a605414eb1317857a3</a></p>



<a name="209756616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756616">(Sep 11 2020 at 09:08)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> if you run it a few more times, do you get any exacts? I think you might also be seeing undercounting if this isn't a dedicated server or w/e, so that's making my display less useful :(</p>



<a name="209756659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756659">(Sep 11 2020 at 09:09)</a>:</h4>
<p>it is my desktop, so there are various light loads running in parallel</p>



<a name="209756686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756686">(Sep 11 2020 at 09:09)</a>:</h4>
<p>although you might also be on LLVM 11 which means there's that pesky <code>-1</code> getting in the way :(</p>



<a name="209756785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756785">(Sep 11 2020 at 09:10)</a>:</h4>
<p>LLVM 11 version, I guess/hope:<br>
<code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/8cf503a943f4defc1cd831e2ad04c8325dff50df/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="209756843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756843">(Sep 11 2020 at 09:11)</a>:</h4>
<p>whether it hits a multiple of 50 seems to be random</p>



<a name="209756854"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756854" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756854">(Sep 11 2020 at 09:12)</a>:</h4>
<p>(it's really just <code>s/25/24/</code>, for the setup cost)</p>



<a name="209756903"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756903" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756903">(Sep 11 2020 at 09:12)</a>:</h4>
<p>for me I can get entire runs that are all perfect multiples</p>



<a name="209756933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756933">(Sep 11 2020 at 09:12)</a>:</h4>
<p>not happening here</p>



<a name="209756942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209756942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209756942">(Sep 11 2020 at 09:12)</a>:</h4>
<p>or I guess 1 in 10 might get an extra lone instruction. but the overall pattern is pretty clear</p>



<a name="209757009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209757009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209757009">(Sep 11 2020 at 09:13)</a>:</h4>
<p>this is on a 24C/48T Zen 1 EPYC so I think each thread gets its own hardware thread</p>



<a name="209757015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209757015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209757015">(Sep 11 2020 at 09:13)</a>:</h4>
<p>you know, I should check something...</p>



<a name="209757139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209757139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209757139">(Sep 11 2020 at 09:15)</a>:</h4>
<p>wait, that's interesting... if I add taskset 2 (to pin it to a single thread) I get mostly 1 for your latest version</p>



<a name="209757163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209757163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209757163">(Sep 11 2020 at 09:15)</a>:</h4>
<p>you may be accidentally starving the interference child thread</p>



<a name="209757175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209757175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209757175">(Sep 11 2020 at 09:15)</a>:</h4>
<p>ah, ok</p>



<a name="209757178"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209757178" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209757178">(Sep 11 2020 at 09:15)</a>:</h4>
<p>in which case you get the same as if it weren't spawned at all :P</p>



<a name="209757188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209757188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209757188">(Sep 11 2020 at 09:15)</a>:</h4>
<p>yeah that makes sense</p>



<a name="209757264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209757264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209757264">(Sep 11 2020 at 09:16)</a>:</h4>
<p>(which, yes, should be all 0 for the appropriate version, depending on whether you have LLVM 10 or 11)</p>



<a name="209757561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209757561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209757561">(Sep 11 2020 at 09:19)</a>:</h4>
<p>heh, I don't need to even touch the same location (so presumably the values don't matter at all), I just need to be in the same cache line (make the <code>static</code> aligned to 64 bytes then writing to +56 repros but +64 doesn't). maybe I can make it even worse just by constantly writing to it in the child thread, w/o any <code>lock xadd</code> there</p>



<a name="209758170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209758170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209758170">(Sep 11 2020 at 09:26)</a>:</h4>
<p>yeaaaah, this doesn't even use atomics in the child thread, nor touch the same bytes:<br>
<code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/025ee76590ad4e24a7dce9754080fb7c2b30df85/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="209758205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209758205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209758205">(Sep 11 2020 at 09:26)</a>:</h4>
<p>and the value can remain <code>0</code> at all times, it's irrelevant, only the cache line ownership is</p>



<a name="209758307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209758307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209758307">(Sep 11 2020 at 09:28)</a>:</h4>
<p>still looks the same AFAICT</p>



<a name="209758381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209758381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209758381">(Sep 11 2020 at 09:28)</a>:</h4>
<p>yeah it's getting kind of silly. mostly just wanted to confirm I could really streamline it</p>



<a name="209759885"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209759885" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209759885">(Sep 11 2020 at 09:43)</a>:</h4>
<p>now one question could be: can I get a counter that tracks the loss of cache line ownership? it wouldn't be useful in general because I have no idea how many instructions were speculated, but it would be nice to have some more confirmation</p>



<a name="209764911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209764911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209764911">(Sep 11 2020 at 10:38)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> moving to per-thread bump allocators resulted in max variance (as per <code>summarize aggregate</code>, <em>not</em> the totals) being down from hundreds/thousands to <code>±29.5 instructions</code> (it's that with or without an outlier of like +8k in terms of totals, which confuses me, I wonder where that went in the data)</p>



<a name="209764922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209764922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209764922">(Sep 11 2020 at 10:38)</a>:</h4>
<p>too bad we can't ship this :P</p>



<a name="209773299"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773299" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773299">(Sep 11 2020 at 12:24)</a>:</h4>
<p>I cannot readily reboot no</p>



<a name="209773411"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773411" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773411">(Sep 11 2020 at 12:25)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> no worries. running my most recent command is more useful (since it will tell us for sure whether your Zen 2 is really immune)</p>



<a name="209773541"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773541" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773541">(Sep 11 2020 at 12:26)</a>:</h4>
<p><a href="https://gist.githubusercontent.com/Mark-Simulacrum/c435177905503112cd7c9885b3e16b87/raw/6669acb72596015bfa0a58021459d4b39a90aaf7/gistfile1.txt">https://gist.githubusercontent.com/Mark-Simulacrum/c435177905503112cd7c9885b3e16b87/raw/6669acb72596015bfa0a58021459d4b39a90aaf7/gistfile1.txt</a></p>



<a name="209773624"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773624" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773624">(Sep 11 2020 at 12:27)</a>:</h4>
<p>I wonder if it's speculating shorter distances than Zen 1 hmm, although the noise could just be from the system</p>



<a name="209773680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773680">(Sep 11 2020 at 12:28)</a>:</h4>
<p>it is basically idle</p>



<a name="209773687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773687">(Sep 11 2020 at 12:28)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so that's on the machine that used to give just <code>-1</code>?</p>



<a name="209773700"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773700" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773700">(Sep 11 2020 at 12:28)</a>:</h4>
<p>yes</p>



<a name="209773716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773716">(Sep 11 2020 at 12:28)</a>:</h4>
<p>thanks. so it was just getting lucky before</p>



<a name="209773734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773734">(Sep 11 2020 at 12:28)</a>:</h4>
<p>let me rerun that</p>



<a name="209773774"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209773774" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209773774">(Sep 11 2020 at 12:28)</a>:</h4>
<p>rerunning the older script, I still consistently get -1</p>



<a name="209774205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209774205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209774205">(Sep 11 2020 at 12:33)</a>:</h4>
<p>there may be an explanation for that, possibly related to the cache hierarchy and everything else running on the CPU</p>



<a name="209774226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209774226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209774226">(Sep 11 2020 at 12:33)</a>:</h4>
<p>(maybe some false sharing? I don't really know)</p>



<a name="209774305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209774305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209774305">(Sep 11 2020 at 12:34)</a>:</h4>
<p>but anyway the most recent tests are conclusive, as they force conflicts</p>



<a name="209774391"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209774391" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209774391">(Sep 11 2020 at 12:35)</a>:</h4>
<p>okay</p>



<a name="209774405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209774405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209774405">(Sep 11 2020 at 12:35)</a>:</h4>
<p>let me know if I should run something else</p>



<a name="209802975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209802975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209802975">(Sep 11 2020 at 16:24)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I think I found an msr that disables that speculative retirement feature, at least with that I get consistent all zeros... and it doesn't seem to break stuff otherwise</p>



<a name="209803081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209803081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209803081">(Sep 11 2020 at 16:25)</a>:</h4>
<p>it's setting bit 55 in C001_102C ... that's not documented anywhere though, so it might be a super dangerous thing to do</p>



<a name="209803336"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209803336" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209803336">(Sep 11 2020 at 16:27)</a>:</h4>
<p>also works if I just do that for the thread that is measured, not the interfering thread (or rather it works 50% of the time when I apply it to one of two hw threads)</p>



<a name="209803758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209803758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209803758">(Sep 11 2020 at 16:31)</a>:</h4>
<p>for older AMD cpus it is documented that C001_102C controls the execution unit, and it's also documented that that unit handles retirement/contains the retirement queue... so I just tried flipping bits from high to low (I started with high because the only documented bit for older cpus was rather high and the value on my CPU was all zeros for the lower bits)</p>



<a name="209809191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209809191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209809191">(Sep 11 2020 at 17:17)</a>:</h4>
<p>If anyone else wants to try this (at their own risk) I'm using this python script to mess with the MSRs <a href="https://gist.github.com/jix/0e1f16c1ecd1d56a74f26bfbfa560353">https://gist.github.com/jix/0e1f16c1ecd1d56a74f26bfbfa560353</a> the bit that works on my machine is hardcoded and it does check that the existing MSR value matches what I find on my machine... it does not check whether you're running it on the same CPU though</p>



<a name="209816155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209816155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jonas Schievink  [he/him] <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209816155">(Sep 11 2020 at 18:15)</a>:</h4>
<p>wow, nice job!</p>



<a name="209816810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209816810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209816810">(Sep 11 2020 at 18:21)</a>:</h4>
<p>Also did a complete rustc perf run with that MSR bit set (while running other stuff like firefox and vscode etc. in parallel) ... seems to not cause any issues on my machine</p>



<a name="209816884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209816884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209816884">(Sep 11 2020 at 18:21)</a>:</h4>
<p>Does anyone know of any benchmarks or similar that stress atomics/cache coherency stuff?</p>



<a name="209817637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209817637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209817637">(Sep 11 2020 at 18:28)</a>:</h4>
<p>That's incredibly impressive! I would love to see this behavior and the discovery of this undocumented MSR as a post somewhere.</p>



<a name="209817783"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209817783" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209817783">(Sep 11 2020 at 18:29)</a>:</h4>
<p>Props to <span class="user-mention" data-user-id="119009">@eddyb</span>  for finding the patent on this otherwise undocumented behavior, and <span class="user-mention" data-user-id="137027">@Jannis Harder</span> for figuring out the undocumented disable mechanism.</p>



<a name="209818740"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209818740" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209818740">(Sep 11 2020 at 18:37)</a>:</h4>
<p>that sounds exactly like Christopher Domas' "god mode unlocked" talk about uncovering hardware backdoors in old set top box cpus, starting from patents :)</p>



<a name="209822314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209822314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209822314">(Sep 11 2020 at 19:08)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I literally googled something along the lines of "lock xadd retired instructions" or something lol, to get the patent</p>



<a name="209822337"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209822337" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209822337">(Sep 11 2020 at 19:08)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> wow that's awesome!</p>



<a name="209822668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209822668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209822668">(Sep 11 2020 at 19:11)</a>:</h4>
<p>this is the best thing I've woken up to</p>



<a name="209823193"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209823193" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209823193">(Sep 11 2020 at 19:15)</a>:</h4>
<p>"so I just tried flipping bits". haha, amazing</p>



<a name="209823247"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209823247" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209823247">(Sep 11 2020 at 19:15)</a>:</h4>
<p><span class="user-mention" data-user-id="116113">@lqd</span> sand...sifter, I think? and yeah, I was imagining one could set bits but I don't actually own a Zen machine and asking someone else to run <code>wrsmr</code> for <em>any</em> values is terrifying</p>



<a name="209823317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209823317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mara <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209823317">(Sep 11 2020 at 19:16)</a>:</h4>
<p>(also, hello. :) don't think i've said anything here before)</p>



<a name="209823516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209823516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209823516">(Sep 11 2020 at 19:17)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> do you want to... tweet about it? or maybe we should post to <a href="https://github.com/mozilla/rr/issues/2034">https://github.com/mozilla/rr/issues/2034</a> in case it's relevant?</p>



<a name="209823580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209823580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209823580">(Sep 11 2020 at 19:18)</a>:</h4>
<p>exactly yeah, using sandsifter, which I don't think he ever released actually ?</p>



<a name="209823835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209823835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209823835">(Sep 11 2020 at 19:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209817637">said</a>:</p>
<blockquote>
<p>That's incredibly impressive! I would love to see this behavior and the discovery of this undocumented MSR as a post somewhere.</p>
</blockquote>
<p>Well, <span class="user-mention" data-user-id="119009">@eddyb</span> already suggested that there is an MSR bit for this when asking on twitter if anyone knew about this feature... and I've heard many times that in a modern CPU basically every feature has a so-called chicken bit to disable it, either to be able to work around bugs that slip through verification, but also to make it easier to initially verify parts independently... and I guess more recently to mitigate side channels.</p>
<p>Then for the spec_store_bypass side channel, there is a mitigation that uses an architectural MSR for recent CPUs... but for older ones uses a previously undocumented MSR, so that was a precedent for those bits just sitting around in the MSRs... that one is actually mitigated by an MSR close to the one I'm using.</p>
<p>Then I looked at what I could find documented about that block of MSRs, and found that from family 15h to 17h the registers in that area themselves seem to affect the same units... and 15h had an errata that was fixed by a bit in  C001_102C, which told me that this is the execution unit.</p>
<p>Looking at documented architecture diagrams, the execution unit is the unit that has the retire queue... and at that point I decided to not think too hard about the worst case scenario when I start to flip bits ;) and it took only 9 bits, and zero crashes to find it.</p>



<a name="209823916"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209823916" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209823916">(Sep 11 2020 at 19:21)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> hmm do you happen to know if it makes running <code>rustc</code> significantly slower?</p>



<a name="209824000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824000">(Sep 11 2020 at 19:21)</a>:</h4>
<p>like I hope it's just that feature and not, say, fully serializing the entire execution and completely destroying IPC</p>



<a name="209824109"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824109" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824109">(Sep 11 2020 at 19:22)</a>:</h4>
<p>a whole local perf run took 26 minutes, but I think I forgot to disable boost so I can't really compare that to anything</p>



<a name="209824130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824130">(Sep 11 2020 at 19:22)</a>:</h4>
<p>but I guess that means it's not too bad</p>



<a name="209824214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824214">(Sep 11 2020 at 19:23)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> and if you want you can tweet about it and just mention me (<code>@jix_</code> on twitter) ... I can also tweet it, but I tend to overthink public tweets so it'd take me some time ^^</p>



<a name="209824261"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824261" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824261">(Sep 11 2020 at 19:24)</a>:</h4>
<p>I was imagining trying with something that takes just seconds :P</p>



<a name="209824319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824319">(Sep 11 2020 at 19:24)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> do you mind if I link the zulip archive for these messages? since you already presented everything nicely :P</p>



<a name="209824395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824395">(Sep 11 2020 at 19:25)</a>:</h4>
<p>I don't mind :)</p>



<a name="209824589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824589">(Sep 11 2020 at 19:26)</a>:</h4>
<p>thanks!</p>



<a name="209824591"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824591" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824591">(Sep 11 2020 at 19:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209824261">said</a>:</p>
<blockquote>
<p>I was imagining trying with something that takes just seconds :P</p>
</blockquote>
<p>I mostly wanted to make sure things are stable (that's also why I forgot to disable boost, which I usually do whenever I benchmark things)</p>



<a name="209824788"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824788" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824788">(Sep 11 2020 at 19:28)</a>:</h4>
<p>fair, I'm a bit surprised you used that, I would've at most tried a rustc build (but tbh I wouldn't have thought of it)</p>



<a name="209824839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824839">(Sep 11 2020 at 19:29)</a>:</h4>
<p>or in other words, rustc-perf is not the easiest thing to run IME (but maybe I'm months behind)</p>



<a name="209824853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824853">(Sep 11 2020 at 19:29)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> was that with the bit set on all hardware threads?</p>



<a name="209824869"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824869" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824869">(Sep 11 2020 at 19:29)</a>:</h4>
<p>fwiw the official perf collector does not disable boost</p>



<a name="209824905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824905">(Sep 11 2020 at 19:29)</a>:</h4>
<p>(we should adopt RISC-V's "hart" term universally just so I don't have to type out "hardware thread" every time)</p>



<a name="209824909"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824909" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824909">(Sep 11 2020 at 19:29)</a>:</h4>
<p>I had a local perf run setup already</p>



<a name="209824998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209824998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209824998">(Sep 11 2020 at 19:30)</a>:</h4>
<p>oh that makes a lot of sense <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="209825089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209825089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209825089">(Sep 11 2020 at 19:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209824869">said</a>:</p>
<blockquote>
<p>fwiw the official perf collector does not disable boost</p>
</blockquote>
<p>I guess if you're using instructions it doesn't matter at all, for cycles I guess the memory clock not getting a boost might matter... but for my projects I often do wall clock benchmarks because I'm benchmarking my stuff against completely different implementations and for that comparing instructions is no good</p>



<a name="209825215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209825215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209825215">(Sep 11 2020 at 19:32)</a>:</h4>
<p>and AFAICT with boost enabled, it goes into thermal throttling so I'd expect higher wall clock variance</p>



<a name="209825595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209825595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209825595">(Sep 11 2020 at 19:36)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> have you ever played with counting μops btw?</p>



<a name="209825792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209825792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209825792">(Sep 11 2020 at 19:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209824261">said</a>:</p>
<blockquote>
<p>I was imagining trying with something that takes just seconds :P</p>
</blockquote>
<p>I ran the regex benchmark with and without the MSR bit set... the instruction count goes down slightly when the bit is set (as we would expect from eliminating overcounting) but the cycle count goes up by  &lt;1% avg and task clock by &lt;2% avg</p>



<a name="209825814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209825814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209825814">(Sep 11 2020 at 19:38)</a>:</h4>
<p>nope I haven't</p>



<a name="209825898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209825898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209825898">(Sep 11 2020 at 19:39)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> it's fun (and usable from userspace), I was able to see that most instructions take only 1μop, whereas something like a simple <code>cpuid</code> takes ~60</p>



<a name="209825941"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209825941" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209825941">(Sep 11 2020 at 19:39)</a>:</h4>
<p>AFAICT they might not be as reliable as instructions (which themselves are not perfect because of under/over-counting bugs <em>sigh</em>), but they could still tell you if you're hitting weird microcoded stuff</p>



<a name="209826093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209826093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209826093">(Sep 11 2020 at 19:41)</a>:</h4>
<p>a lot of stuff I do is affected a lot by memory access patterns, because it works on graphs that don't fit into the cache... I haven't found any good way to get a stable measurement for that that has good correlation to actual run time</p>



<a name="209826118"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209826118" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209826118">(Sep 11 2020 at 19:41)</a>:</h4>
<p>(I haven't tried too hard either though)</p>



<a name="209826293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209826293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209826293">(Sep 11 2020 at 19:43)</a>:</h4>
<p>I suspect some combination of cache misses at various cache levels could be useful in tracking memory bandwidth usage but... you're limited in how many counters you have at any time so you can't just throw a couple dozen of them into a complex equation</p>



<a name="209826572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209826572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209826572">(Sep 11 2020 at 19:45)</a>:</h4>
<p>(I'm imagining doing a bit of linear regression to find approximately how much slower than "an instruction" a cache miss is. although this may break down if SSE/AVX is used extensively. also, <code>memset</code> is always one instruction thanks to <code>rep stosb</code> aka "the <code>memset</code> instruction" existing)</p>



<a name="209827238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209827238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209827238">(Sep 11 2020 at 19:51)</a>:</h4>
<p>I guess you could capture more counters using multiple runs to get some data and then use some regression with regularization that makes it find a sparse equation (I forgot what you use to get that, but I remember that that's a thing)</p>



<a name="209829288"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209829288" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209829288">(Sep 11 2020 at 20:10)</a>:</h4>
<blockquote>
<p>regularization</p>
</blockquote>
<p>It is defintly a thing, but I don't know why you would need it here. There is Lasso and Ridge regressions and many more. I can help when it comes to that stats things.</p>



<a name="209829382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209829382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eh2406 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209829382">(Sep 11 2020 at 20:11)</a>:</h4>
<p>Ah I miss read. You want sparsity, then you are probably looking for Lasso. But there are stronger things if needed.</p>



<a name="209833219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209833219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209833219">(Sep 11 2020 at 20:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209823516">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137027">Jannis Harder</span> do you want to... tweet about it? or maybe we should post to <a href="https://github.com/mozilla/rr/issues/2034">https://github.com/mozilla/rr/issues/2034</a> in case it's relevant?</p>
</blockquote>
<p>I'm too tired right now to figure out enough of rr to leave a useful comment there, but it would be good to figure out if this could make rr usable on zen</p>



<a name="209834533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209834533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209834533">(Sep 11 2020 at 20:59)</a>:</h4>
<p>oh yeah I meant to go there and link some of this stuff haha (I'm still waking up, having to deal with some other stuff and getting distracted)</p>



<a name="209836513"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836513" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836513">(Sep 11 2020 at 21:20)</a>:</h4>
<p>heh, so I found another bit that seems to have the same effect... and unlike the one I found by just trying to flip bits... this one is "documented" in a mainboard manual: it's bit 54 of c001_1020 and <a href="https://gzhls.at/blob/ldb/6/4/8/a/e30dea919abbc96d15016869591022a12f0e.pdf">https://gzhls.at/blob/ldb/6/4/8/a/e30dea919abbc96d15016869591022a12f0e.pdf</a> says "Enables IBS through MSRC001_1005[42] and disables SpecLockMap through MSRC001_1020[54]." now IBS is some profiling feature I think but I don't find any other hits for SpecLockMap</p>



<a name="209836545"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836545" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836545">(Sep 11 2020 at 21:20)</a>:</h4>
<p>isn't IBS one of the mitigation things?</p>



<a name="209836568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836568">(Sep 11 2020 at 21:20)</a>:</h4>
<p>ah no I'm confusing stuff</p>



<a name="209836594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836594">(Sep 11 2020 at 21:21)</a>:</h4>
<p>"IBRS" is what I was remembering, from <a href="https://developer.amd.com/wp-content/resources/Architecture_Guidelines_Update_Indirect_Branch_Control.pdf">https://developer.amd.com/wp-content/resources/Architecture_Guidelines_Update_Indirect_Branch_Control.pdf</a></p>



<a name="209836599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836599">(Sep 11 2020 at 21:21)</a>:</h4>
<p>"AMD Instruction Based Sampling" ... but that MSR is the one used for the spec_store_bypass mitigation</p>



<a name="209836655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836655">(Sep 11 2020 at 21:22)</a>:</h4>
<p>if I benchmark the two MSR bits against each other with the regex benchmark... they almost don't differ in instructions... but  the "documented" one is actually a tiny bit faster</p>



<a name="209836734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836734">(Sep 11 2020 at 21:22)</a>:</h4>
<p>might also just be noise though</p>



<a name="209836901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836901">(Sep 11 2020 at 21:24)</a>:</h4>
<p>but given that that MSR is part of some mainboard's settings menu... maybe that is set on <span class="user-mention" data-user-id="116122">@simulacrum</span>'s machine?</p>



<a name="209836918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836918">(Sep 11 2020 at 21:24)</a>:</h4>
<p>is there an easy way to tell?</p>



<a name="209836962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836962">(Sep 11 2020 at 21:25)</a>:</h4>
<p>/proc/cpuinfo does have ibs in flags</p>



<a name="209836997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209836997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209836997">(Sep 11 2020 at 21:25)</a>:</h4>
<p>but I think that's <em>support</em> not set</p>



<a name="209837225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837225">(Sep 11 2020 at 21:27)</a>:</h4>
<p>also it's the other bit that is relevant, not the IBS one</p>



<a name="209837331"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837331" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837331">(Sep 11 2020 at 21:28)</a>:</h4>
<p>I guess IBS might have the same issue we have when "SpecLockMap" (which I assume is the feature of the patent) is active? but there isn't really anything but that manual that mentions SpecLockMap</p>



<a name="209837372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837372">(Sep 11 2020 at 21:29)</a>:</h4>
<p>oh wait I just realized that the "Lock" in there means the same thing as our <code>lock</code> lol</p>



<a name="209837521"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837521" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837521">(Sep 11 2020 at 21:30)</a>:</h4>
<p>yeah... I actually found that manual before I tried flipping bits by searching for MSR register numbers... but I also first didn't realize that spec + lock might be relevant</p>



<a name="209837550"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837550" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837550">(Sep 11 2020 at 21:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137027">Jannis Harder</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209823835">said</a>:</p>
<blockquote>
<p>Looking at documented architecture diagrams, the execution unit is the unit that has the retire queue... and at that point I decided to not think too hard about the worst case scenario when I start to flip bits ;) and it took only 9 bits, and zero crashes to find it.</p>
</blockquote>
<p>In general, you can safely assume that flipping MSR bits can't do worse than crash your system. The accessible surface area of the chip should <em>never</em> be able to brick or damage something.</p>



<a name="209837609"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837609" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837609">(Sep 11 2020 at 21:31)</a>:</h4>
<p>that's good to know :D</p>



<a name="209837692"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837692" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837692">(Sep 11 2020 at 21:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span>  <code>sudo modprobe msr; sudo dd skip=3221295136 if=/dev/cpu/0/msr bs=8 count=1 iflag=skip_bytes | hexdump</code> this reads the MSR c001_1020</p>



<a name="209837738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837738">(Sep 11 2020 at 21:32)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> what about <code>rdmsr</code> :P?</p>



<a name="209837741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837741">(Sep 11 2020 at 21:32)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> <code>$((0xC0011020))</code> might be easier; the expression parser understands hex.</p>



<a name="209837756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837756">(Sep 11 2020 at 21:32)</a>:</h4>
<p>(the command from <code>msr-tools</code>)</p>



<a name="209837822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837822">(Sep 11 2020 at 21:33)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> well I didn't have msr-tools installed (and was using python, not dd for my testing)</p>



<a name="209837881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837881">(Sep 11 2020 at 21:34)</a>:</h4>
<p>Also, I didn't know about <code>iflag=skip_bytes</code>, that's useful, thanks!</p>



<a name="209837894"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837894" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837894">(Sep 11 2020 at 21:34)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I'm using zsh and I can never remember what's zsh only and what also works in bash so I thought decimal is the safe but awkward choice</p>



<a name="209837999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209837999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209837999">(Sep 11 2020 at 21:35)</a>:</h4>
<p>but yeah if you have <code>msr-tools</code> that's just <code>sudo rdmsr -x 0xc0011020</code> :D</p>



<a name="209838057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838057">(Sep 11 2020 at 21:36)</a>:</h4>
<p>though didn't we confirm <span class="user-mention" data-user-id="116122">@simulacrum</span>'s machine reproduces? I guess it doesn't hurt to check</p>



<a name="209838150"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838150" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838150">(Sep 11 2020 at 21:36)</a>:</h4>
<p>I didn't keep track</p>



<a name="209838185"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838185" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838185">(Sep 11 2020 at 21:36)</a>:</h4>
<div class="codehilite"><pre><span></span><code>1+0 records in
1+0 records out
8 bytes copied, 5.4848e-05 s, 146 kB/s
0000000 0000 0000 4040 0006
0000008
</code></pre></div>



<a name="209838257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838257">(Sep 11 2020 at 21:37)</a>:</h4>
<p>that doesn't have that bit set</p>



<a name="209838417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838417">(Sep 11 2020 at 21:39)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> wait, I know what the PDF is saying!</p>



<a name="209838421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838421">(Sep 11 2020 at 21:39)</a>:</h4>
<p>ahahahaha</p>



<a name="209838535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838535">(Sep 11 2020 at 21:40)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> if you do "Enable IBS" in BIOS it helpfully disables the thing that would mess with IBS</p>



<a name="209838549"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838549" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838549">(Sep 11 2020 at 21:40)</a>:</h4>
<p>which also cares about not seeing speculation side-effects</p>



<a name="209838564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838564">(Sep 11 2020 at 21:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="137027">Jannis Harder</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209837331">said</a>:</p>
<blockquote>
<p>I guess IBS might have the same issue we have when "SpecLockMap" (which I assume is the feature of the patent) is active? but there isn't really anything but that manual that mentions SpecLockMap</p>
</blockquote>
<p>yeah that's what I meant here :)</p>



<a name="209838604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838604">(Sep 11 2020 at 21:41)</a>:</h4>
<p>anything that looks at the stream of retired instructions will hit this same problem, right</p>



<a name="209838666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838666">(Sep 11 2020 at 21:41)</a>:</h4>
<p>Given that the overall performance between the two bits doesn't seem to differ much, and if it differs at all, is better with the "documented" bit, I think that's the better choice</p>



<a name="209838743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838743">(Sep 11 2020 at 21:42)</a>:</h4>
<p>also I think linux already has infrastructure to set bits in that register per process, as it is used for per process spec_store_bypass mitigation</p>



<a name="209838966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209838966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209838966">(Sep 11 2020 at 21:44)</a>:</h4>
<p>That MSR is "Load-Store Configuration", the one I found first is "Execution Unit Configuration" (documented for older CPUs) it makes sense that this feature affects both, but I do wonder if there is an observable difference</p>



<a name="209839368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209839368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209839368">(Sep 11 2020 at 21:49)</a>:</h4>
<p>hmm looking at the linux code, it isn't written with more configurable bits in mind... and it will actually mess with the MSRs when there are processes which differ in whether they have the spec_store_bypass active</p>



<a name="209839581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209839581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209839581">(Sep 11 2020 at 21:51)</a>:</h4>
<p>it reads the boot value of that MSR once and caches it to avoid reading it before changing whether "Speculative Store Bypass" is enabled or not</p>



<a name="209839764"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209839764" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209839764">(Sep 11 2020 at 21:53)</a>:</h4>
<p>oh, but only on pre-zen AMD cpus... there's an architectural MSR for the "Speculative Store Bypass" on zen and newer</p>



<a name="209839905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209839905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209839905">(Sep 11 2020 at 21:54)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> btw did you see this? <a href="https://www.reddit.com/r/Amd/comments/89vucf/what_does_enable_ibs_and_streaming_stores/">https://www.reddit.com/r/Amd/comments/89vucf/what_does_enable_ibs_and_streaming_stores/</a></p>



<a name="209839915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209839915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209839915">(Sep 11 2020 at 21:55)</a>:</h4>
<p>this also mentions "Stack Buffer"</p>



<a name="209840112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840112">(Sep 11 2020 at 21:57)</a>:</h4>
<p>yeah, saw that after searching for "SpecLockMap", no idea about stack buffer</p>



<a name="209840422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840422">(Sep 11 2020 at 22:00)</a>:</h4>
<p>I've read somewhere that zen(2?) is also renaming stuff on the stack (but I haven't really looked at any zen/zen2 microarch docs yet... and might be misremembering things) maybe it's related to that?</p>



<a name="209840425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840425">(Sep 11 2020 at 22:00)</a>:</h4>
<p>wait, what if "Enable IBS" is common on Zen motherboards' "BIOS"es (UEFI setup, really)? we could use that for testing</p>



<a name="209840449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840449">(Sep 11 2020 at 22:00)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> lmao like SSA-ifying the stack? as a sort of weird cache?</p>



<a name="209840594"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840594" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840594">(Sep 11 2020 at 22:02)</a>:</h4>
<p>well I guess it brings the same advantages that register renaming does, but also for stuff that's spilled... but again, I might just be confused here</p>



<a name="209840726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840726">(Sep 11 2020 at 22:03)</a>:</h4>
<p>ah apparently it's more general memory renaming not limited to the stack?</p>



<a name="209840841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840841">(Sep 11 2020 at 22:04)</a>:</h4>
<p><a href="https://twitter.com/zwegner/status/1299819987343945733">https://twitter.com/zwegner/status/1299819987343945733</a> &lt;&lt; this was on my timeline and what I was thinking of</p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/zwegner/status/1299819987343945733"><img class="twitter-avatar" src="https://abs.twimg.com/sticky/default_profile_images/default_profile_normal.png"></a><p>With the "memory renaming" feature of Zen/Zen 2 getting a lot of attention (and to a lesser extent the same feature on ICL), does anybody know of a compiler that takes it into account?

It seems spill/fill should now be as local as possible instead of hoisted upwards.</p><span>- Zach Wegner (@zwegner)</span></div></div>



<a name="209840858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840858">(Sep 11 2020 at 22:04)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> so eternaleye linked me this <a href="https://en.wikipedia.org/wiki/Stack_register#Stack_engine">https://en.wikipedia.org/wiki/Stack_register#Stack_engine</a></p>



<a name="209840907"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840907" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840907">(Sep 11 2020 at 22:05)</a>:</h4>
<p>that's a different thing (and much older AFAIK)</p>



<a name="209840993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209840993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209840993">(Sep 11 2020 at 22:06)</a>:</h4>
<p>reading it that does seem to be less exciting</p>



<a name="209841016"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209841016" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209841016">(Sep 11 2020 at 22:06)</a>:</h4>
<p>but given that the renaming thing isn't stack specific, and the stack engine doesn't seem to need a buffer... I still have no idea what "Stack Buffer" could be</p>



<a name="209841053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209841053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209841053">(Sep 11 2020 at 22:06)</a>:</h4>
<p>we also don't have the actual MSR bit for that, do we?</p>



<a name="209841067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209841067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209841067">(Sep 11 2020 at 22:07)</a>:</h4>
<p>anyway that doesn't seem to be as important, just noting it</p>



<a name="209841354"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209841354" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209841354">(Sep 11 2020 at 22:10)</a>:</h4>
<p>I'm going to reboot now to check whether my "BIOS" does have a setting for this, can't find it in the manual, but that isn't exhaustive IIRC</p>



<a name="209842200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209842200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209842200">(Sep 11 2020 at 22:20)</a>:</h4>
<p>No such setting for me</p>



<a name="209843399"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209843399" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209843399">(Sep 11 2020 at 22:35)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="239881">@Josh Triplett</span> lol we raced <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-691339680">https://github.com/mozilla/rr/issues/2034#issuecomment-691339680</a></p>



<a name="209848077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209848077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209848077">(Sep 11 2020 at 23:47)</a>:</h4>
<p>(and now <code>rr</code> ppl are trying to use that bit to make <code>rr</code> work on Zen :D)</p>



<a name="209849535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209849535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209849535">(Sep 12 2020 at 00:16)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> sorry for not asking earlier, but do you have a simple <code>wrmsr</code> command that works?</p>



<a name="209849637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209849637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209849637">(Sep 12 2020 at 00:19)</a>:</h4>
<p>like, I would expect an "OR" operation is necessary?</p>



<a name="209849721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209849721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209849721">(Sep 12 2020 at 00:21)</a>:</h4>
<p>or are all the other bits in that MSR read-only?</p>



<a name="209854580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209854580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209854580">(Sep 12 2020 at 02:28)</a>:</h4>
<p>uh oh why didn't I think to look for this in <code>rr</code>'s source... <a href="https://github.com/mozilla/rr/blob/685ffeae62ed588cc7eec36f1a61c9456d50d8b8/src/PerfCounters.cc#L118-L121">https://github.com/mozilla/rr/blob/685ffeae62ed588cc7eec36f1a61c9456d50d8b8/src/PerfCounters.cc#L118-L121</a></p>



<a name="209854587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209854587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209854587">(Sep 12 2020 at 02:28)</a>:</h4>
<p>(back when I was trying to figure out hardware interrupts counters on the generations Intel redacted it out from)</p>



<a name="209854607"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209854607" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209854607">(Sep 12 2020 at 02:29)</a>:</h4>
<p>because it seems like they had to do the same subtraction with that counter</p>



<a name="209854716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209854716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209854716">(Sep 12 2020 at 02:33)</a>:</h4>
<p>the only one they have that I don't is <code>0x50011d</code> here, but they're missing AMD hw interrupts <a href="https://github.com/mozilla/rr/blob/685ffeae62ed588cc7eec36f1a61c9456d50d8b8/src/PerfCounters.cc#L135-L136">https://github.com/mozilla/rr/blob/685ffeae62ed588cc7eec36f1a61c9456d50d8b8/src/PerfCounters.cc#L135-L136</a></p>



<a name="209855151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209855151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209855151">(Sep 12 2020 at 02:47)</a>:</h4>
<p>ah I see. left a comment <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-691389136">https://github.com/mozilla/rr/issues/2034#issuecomment-691389136</a></p>



<a name="209861665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209861665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209861665">(Sep 12 2020 at 03:14)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> oh hey I found what "AMD CBS" stands for heh:</p>
<blockquote>
<p>What is AMD CBS?<br>
Custom settings for your Ryzen CPU's that are provided by AMD, CBS stands for Custom BIOS Settings.</p>
</blockquote>



<a name="209861739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209861739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209861739">(Sep 12 2020 at 03:16)</a>:</h4>
<p>also I just remembered that two of my colleagues have Ryzen 3700X or similar, but those are windows machines, welp</p>



<a name="209864155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209864155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209864155">(Sep 12 2020 at 04:37)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> They could have called it "AMD BIOS Configuration", or "ABC". ;)</p>



<a name="209864269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209864269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209864269">(Sep 12 2020 at 04:40)</a>:</h4>
<p>heh. I wonder if anything like that will get sillier than "Arm's ARM ARM" (and associated puns like "Thumb")</p>



<a name="209868319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209868319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209868319">(Sep 12 2020 at 06:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209849535">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137027">Jannis Harder</span> sorry for not asking earlier, but do you have a simple <code>wrmsr</code> command that works?</p>
</blockquote>
<p>I don't, seems like <code>wrmsr</code> doesn't do read modify write ops?</p>



<a name="209868320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209868320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209868320">(Sep 12 2020 at 06:58)</a>:</h4>
<p>oof</p>



<a name="209868328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209868328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209868328">(Sep 12 2020 at 06:59)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> although if all the cores/hardware threads have the same values, it's probably safe to just set them all to that value OR'd with the bit we want to set</p>



<a name="209868329"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209868329" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209868329">(Sep 12 2020 at 06:59)</a>:</h4>
<p>just a bit (har) more manual</p>



<a name="209868383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209868383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209868383">(Sep 12 2020 at 07:01)</a>:</h4>
<p>too bad I don't think there's a way to detect this cheaply when starting up, to warn the user :(</p>



<a name="209908990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209908990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209908990">(Sep 13 2020 at 01:48)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> hmm so we're looking at changing some kernel state to set the MSR bit without the kernel resetting it back, and I think I have a plan, but I ran into a small problem I can't find an answer for looking around: my <code>/proc/kallsyms</code> seems to only have <code>.text</code> symbols, but no <code>.data</code> ones, is this normal?</p>



<a name="209908997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209908997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209908997">(Sep 13 2020 at 01:49)</a>:</h4>
<p>even <code>EXPORT_SYMBOL_GPL</code> globals seem to be missing</p>



<a name="209910225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209910225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209910225">(Sep 13 2020 at 02:34)</a>:</h4>
<p><code>System.map</code> OTOH has them, so that might be useful</p>



<a name="209914608"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209914608" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209914608">(Sep 13 2020 at 05:20)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I'm not sure, but I <em>think</em> that's normal. <code>.data</code> symbols aren't needed for backtraces and similar.</p>



<a name="209916061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209916061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209916061">(Sep 13 2020 at 06:14)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="137027">@Jannis Harder</span> I got something working but at least it won't be necessary for anyone on Zen 2 <a href="https://gist.github.com/eddyb/b888bb87988ca97ead9abcf96aa49e15">https://gist.github.com/eddyb/b888bb87988ca97ead9abcf96aa49e15</a></p>



<a name="209916066"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209916066" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209916066">(Sep 13 2020 at 06:14)</a>:</h4>
<p>this is mostly for <a href="http://build.lyken.rs">build.lyken.rs</a> (which is Zen 1 EPYC)</p>



<a name="209917207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209917207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209917207">(Sep 13 2020 at 06:53)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> actually, should it be considered a vulnerability that I can (relatively easily) work around <code>__ro_after_init</code>? seems a bit wrong that <code>kernel_set_to_readonly</code> itself isn't <code>__ro_after_init</code>, it means I can write to it which removes the "stickiness" of <code>__ro_after_init</code> and allows remapping anything as writable</p>



<a name="209917276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209917276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209917276">(Sep 13 2020 at 06:55)</a>:</h4>
<p>hiding the address of <code>kernel_set_to_readonly</code> from <code>System.map</code> would be pointless btw, since before I realized I can get it from there I was able to pull it out of the disassembly of <code>mark_rodata_ro</code> with this:</p>
<p><code>sudo gdb /var/run/booted-system/kernel /proc/kcore -ex 'set disassembly-flavor intel' -ex 'x/40i 0x'$(sudo cat /proc/kallsyms | grep mark_rodata_ro | sed 's/ T .*//') -ex q | grep -A3 'call   0x'$(sudo cat /proc/kallsyms | grep set_memory_ro | sed 's/ T .*//')</code></p>



<a name="209959426"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209959426" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209959426">(Sep 14 2020 at 02:01)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> haha I didn't think to Ctrl+F "SpecLock" in here before, we might be able to <em>track</em> when it happens <a href="http://developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf">http://developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf</a></p>



<a name="209960062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209960062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209960062">(Sep 14 2020 at 02:19)</a>:</h4>
<p>lol this is very weird <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-691772998">https://github.com/mozilla/rr/issues/2034#issuecomment-691772998</a></p>



<a name="209960362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209960362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209960362">(Sep 14 2020 at 02:27)</a>:</h4>
<p>wait I didn't pay attention, "bit 3: SpecLockMapCommit. Read-write. Reset: 0." literally contains "SpecLockMap"</p>



<a name="209960587"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209960587" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209960587">(Sep 14 2020 at 02:32)</a>:</h4>
<div class="codehilite"><pre><span></span><code> Performance counter stats for &#39;./rdpmc-bench&#39;:
       900,923,203      instructions:u
         4,104,422      r0425:u
         3,336,967      r0825:u

 Performance counter stats for &#39;dd if=/dev/zero of=/dev/null bs=1 count=5M&#39;:
       997,043,218      instructions:u
                12      r0425:u
                34      r0825:u
</code></pre></div>



<a name="209960710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209960710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209960710">(Sep 14 2020 at 02:36)</a>:</h4>
<p>sadly I think all it shows is I have a lot of "lock xadd"s, I don't see how to correlate with the overcounting</p>



<a name="209964507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209964507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209964507">(Sep 14 2020 at 04:34)</a>:</h4>
<p>idk what it means but <code>r0225:u</code> has a value in the millions <em>only</em> when that second thread is interfering (while <code>r0425:u</code> and <code>r0825:u</code> remain around the same)</p>



<a name="209964523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209964523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209964523">(Sep 14 2020 at 04:35)</a>:</h4>
<p>if anyone is bored: <code>perf stat -i -e r0225:u,r0425:u,r0825:u ./rdpmc-bench</code> (I suspect these counters are Zen 1-specific though)</p>



<a name="209964683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209964683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209964683">(Sep 14 2020 at 04:39)</a>:</h4>
<p>hmm <code>r0225:u</code> is documented as <code>NonSpecLock</code>, maybe it's larger than overcounting (but proportional to it) because... perhaps there's a cache miss <em>before</em> attempting to start the speculative execution? guess I can start looking at L1d misses</p>



<a name="209965834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209965834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209965834">(Sep 14 2020 at 05:11)</a>:</h4>
<p>ahhh, <code>r0e25:u</code> (the sum of <code>r0225:u,r0425:u,r0825:u</code>) is equal to the <code>total_iterations + 147 + 112*num_powers_of_ten</code> (and there's one <code>lock xadd</code> per iteration) so I <em>think</em> it's the number of <code>lock</code> instructions ever executed</p>



<a name="209965863"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209965863" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209965863">(Sep 14 2020 at 05:12)</a>:</h4>
<p>what changes from run to run is in each of the 3 categories, each <code>lock</code> instruction ends up</p>



<a name="209965886"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209965886" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209965886">(Sep 14 2020 at 05:12)</a>:</h4>
<p>(to give an example: when the powers of ten are <code>5..=6</code>, I get <code>11,000,371      r0e25:u</code> <em>deterministically</em>)</p>



<a name="209966252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209966252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209966252">(Sep 14 2020 at 05:23)</a>:</h4>
<p><code>L1-dcache-load-misses:u</code> is pretty large, but I don't see the correlation</p>



<a name="209966505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209966505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209966505">(Sep 14 2020 at 05:30)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> heh I just realized <code>measureme</code> uses atomic adds when recording the events, let's try removing that and see what happens to the remaining noise (after it was already drastically lowered by the per-thread bump allocator) :D</p>



<a name="209967073"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209967073" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209967073">(Sep 14 2020 at 05:45)</a>:</h4>
<p>hmpf the totals still have a ±5000 instructions. wait what I only removed about a third of all <code>lock</code> instructions, where's the rest coming from?</p>



<a name="209967259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209967259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209967259">(Sep 14 2020 at 05:51)</a>:</h4>
<p>(I'm still seeing <code>-Zself-profile</code> increase the number of <code>lock</code> instructions by ~25x)</p>



<a name="209967447"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209967447" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209967447">(Sep 14 2020 at 05:57)</a>:</h4>
<p>(the number is the same every time so I doubt this is e.g. the kernel's instructions leaking into the userspace)</p>



<a name="209971289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209971289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209971289">(Sep 14 2020 at 07:11)</a>:</h4>
<p>huuuh I just did another search for the patent (to demonstrate how I found it in a first place) and thought I found the same but... no this one is by Intel?? <a href="https://patents.google.com/patent/US20060004998">https://patents.google.com/patent/US20060004998</a></p>



<a name="209971395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209971395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209971395">(Sep 14 2020 at 07:13)</a>:</h4>
<p>did AMD do patent infringement lol</p>



<a name="209972860"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209972860" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209972860">(Sep 14 2020 at 07:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/209959426">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137027">Jannis Harder</span> haha I didn't think to Ctrl+F "SpecLock" in here before, we might be able to <em>track</em> when it happens <a href="http://developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf">http://developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf</a></p>
</blockquote>
<p>Not quite sure how to read those tables, but even if we can count how often it happens, to compensate, we would need a way to count how many instructions were speculatively retired and it doesn't look like that's in there to me... or am I missing something?</p>



<a name="209973149"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209973149" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#209973149">(Sep 14 2020 at 07:38)</a>:</h4>
<p>yeah it's useless, except for learning that there are still atomic instructions, heh</p>



<a name="210234524"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234524" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234524">(Sep 16 2020 at 08:33)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> haha it's not just motherboards that tie that bit to IBS <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-693250265">https://github.com/mozilla/rr/issues/2034#issuecomment-693250265</a></p>



<a name="210234577"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234577" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234577">(Sep 16 2020 at 08:33)</a>:</h4>
<p>Yeah, just saw that :) great to have some more confirmation that setting that bit is actually supported</p>



<a name="210234629"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234629" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234629">(Sep 16 2020 at 08:34)</a>:</h4>
<p>AMD should just come out and say it <em>sigh</em></p>



<a name="210234669"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234669" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234669">(Sep 16 2020 at 08:34)</a>:</h4>
<p>I still wonder about that bit I found first though (just out of curiosity)</p>



<a name="210234719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234719">(Sep 16 2020 at 08:35)</a>:</h4>
<p>I wouldn't bet on that happening anytime soon... :/</p>



<a name="210234728"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234728" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234728">(Sep 16 2020 at 08:35)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> hmmm one thing you could do if you're bored is measure performance effects of each (on atomics-heavy code, maybe even my <code>rdpmc-bench.rs</code> but without the interfering thread?)</p>



<a name="210234739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234739">(Sep 16 2020 at 08:35)</a>:</h4>
<p>as in, total execution time</p>



<a name="210234792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234792">(Sep 16 2020 at 08:36)</a>:</h4>
<p>one of them might be more expensive than the other, which could tell us more about what they do differently</p>



<a name="210234801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234801">(Sep 16 2020 at 08:36)</a>:</h4>
<p>I compared them on the rustc-perf regexp benchmark and IIRC the bit I found first was slightly slower</p>



<a name="210234807"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234807" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234807">(Sep 16 2020 at 08:36)</a>:</h4>
<p>there's also the Zen 1 counters that I don't think you have access to :(</p>



<a name="210234817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234817">(Sep 16 2020 at 08:36)</a>:</h4>
<p>ah fascinating</p>



<a name="210234831"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234831" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234831">(Sep 16 2020 at 08:36)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> in that case I would say it turns off more :P</p>



<a name="210234833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234833">(Sep 16 2020 at 08:37)</a>:</h4>
<p>but I wasn't really careful when benchmarking that, so that might have been noise</p>



<a name="210234871"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234871" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234871">(Sep 16 2020 at 08:37)</a>:</h4>
<p>I think it might actually be the other way around... because the bit used for IBS is in the load/store MSR while "my" bit is in the execution MSR</p>



<a name="210234956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234956">(Sep 16 2020 at 08:38)</a>:</h4>
<p>that <em>could</em> mean it's earlier in the pipeline, no?</p>



<a name="210234973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234973">(Sep 16 2020 at 08:38)</a>:</h4>
<p>which of them?</p>



<a name="210234983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210234983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210234983">(Sep 16 2020 at 08:38)</a>:</h4>
<p>the "execution" one</p>



<a name="210235012"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235012" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235012">(Sep 16 2020 at 08:39)</a>:</h4>
<p>well I think the execution unit handles retirement... let me look at one of the public diagrams again</p>



<a name="210235049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235049">(Sep 16 2020 at 08:39)</a>:</h4>
<p>I think the early stuff in the pipeline is called the front-end not the execution unit</p>



<a name="210235057"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235057" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235057">(Sep 16 2020 at 08:39)</a>:</h4>
<p>I guess I'm thinking the word is a bit vague and could just as well refer to something around scheduling or close to writeback</p>



<a name="210235061"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235061" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235061">(Sep 16 2020 at 08:39)</a>:</h4>
<p>aaah okay then I see</p>



<a name="210235104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235104">(Sep 16 2020 at 08:40)</a>:</h4>
<p><a href="https://en.wikichip.org/w/images/f/f2/zen_2_core_diagram.svg">https://en.wikichip.org/w/images/f/f2/zen_2_core_diagram.svg</a> &lt;&lt; is what I'm going by</p>



<a name="210235111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235111">(Sep 16 2020 at 08:40)</a>:</h4>
<p>"execution unit" not "execute stage"</p>



<a name="210235152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235152">(Sep 16 2020 at 08:40)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> hmm that still has EX as "before" in the pipeline compared to LS</p>



<a name="210235168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235168">(Sep 16 2020 at 08:41)</a>:</h4>
<p>yeah, I just realized... or rather it's not clear to me how they interact</p>



<a name="210235173"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235173" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235173">(Sep 16 2020 at 08:41)</a>:</h4>
<p>or rather, LS is subordinate to EX and handles 3 of the ports</p>



<a name="210235212"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235212" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235212">(Sep 16 2020 at 08:41)</a>:</h4>
<p>red, cyan and blue are EX-&gt;LS commands and then green is LS-&gt;EX result</p>



<a name="210235323"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235323" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235323">(Sep 16 2020 at 08:43)</a>:</h4>
<p>AFAICT the speculative lock stuff isn't explicitly anywhere on there</p>



<a name="210235461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235461">(Sep 16 2020 at 08:44)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> you can't read it easily but the thing between Rename/Allocate and the Physical Register File, is labelled as "Schedulers"</p>



<a name="210235525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235525">(Sep 16 2020 at 08:45)</a>:</h4>
<p>the labels aren't broken when embedded in this wiki page: <a href="https://en.wikichip.org/wiki/amd/microarchitectures/zen_2">https://en.wikichip.org/wiki/amd/microarchitectures/zen_2</a></p>



<a name="210235543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235543">(Sep 16 2020 at 08:45)</a>:</h4>
<p>"16 entries" is interesting, maybe I should've played around with non-<code>nop</code> instructions</p>



<a name="210235551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235551">(Sep 16 2020 at 08:45)</a>:</h4>
<p>since it's possible <code>nop</code>s aren't even dispatched lol</p>



<a name="210235562"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235562" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235562">(Sep 16 2020 at 08:46)</a>:</h4>
<p>aaah okay <a href="https://en.wikichip.org/wiki/amd/microarchitectures/zen_2#Block_Diagram">https://en.wikichip.org/wiki/amd/microarchitectures/zen_2#Block_Diagram</a></p>



<a name="210235614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235614">(Sep 16 2020 at 08:46)</a>:</h4>
<p>(they joy of text in SVGs)</p>



<a name="210235793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235793">(Sep 16 2020 at 08:48)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> can you check this on Zen 2 btw? <code>perf stat -i -e r0225:u,r0425:u,r0825:u,r0e25:u ./rdpmc-bench</code></p>



<a name="210235801"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235801" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235801">(Sep 16 2020 at 08:49)</a>:</h4>
<p>assuming you still have the binary around :D</p>



<a name="210235969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210235969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210235969">(Sep 16 2020 at 08:51)</a>:</h4>
<p>the Zen 1 diagram is even more boring <a href="https://en.wikichip.org/w/images/0/02/zen_block_diagram.svg">https://en.wikichip.org/w/images/0/02/zen_block_diagram.svg</a></p>



<a name="210236101"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236101" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236101">(Sep 16 2020 at 08:52)</a>:</h4>
<p>that fails with no allocated hardware register, but if I remove one of the ones for perf it does work</p>



<a name="210236130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236130">(Sep 16 2020 at 08:53)</a>:</h4>
<p>Zen 2 has just 5 counters??</p>



<a name="210236140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236140">(Sep 16 2020 at 08:53)</a>:</h4>
<p>remove the last one then</p>



<a name="210236155"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236155" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236155">(Sep 16 2020 at 08:53)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> specifically, without either of the bits set, I'm curious what those counter do</p>



<a name="210236157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236157">(Sep 16 2020 at 08:53)</a>:</h4>
<div class="codehilite"><pre><span></span><code>     6,042,033      r0225:u                                                     
     2,758,150      r0425:u                                                     
     2,200,184      r0825:u
</code></pre></div>



<a name="210236174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236174">(Sep 16 2020 at 08:53)</a>:</h4>
<p>you can also look at <code>r0125:u</code> and <code>r0025:u</code> I guess</p>



<a name="210236182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236182">(Sep 16 2020 at 08:53)</a>:</h4>
<p>o_O that looks like the kind of results I get</p>



<a name="210236246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236246">(Sep 16 2020 at 08:54)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> and if you use just <code>r0e25:u</code>, it's always the same ~10 million value?</p>



<a name="210236254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236254">(Sep 16 2020 at 08:54)</a>:</h4>
<p>so they undocumented it but it does the same thing?</p>



<a name="210236276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236276">(Sep 16 2020 at 08:54)</a>:</h4>
<p>r0125 is 0 r0025 is also 0</p>



<a name="210236289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236289">(Sep 16 2020 at 08:55)</a>:</h4>
<p>yupp same as Zen 1</p>



<a name="210236293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236293">(Sep 16 2020 at 08:55)</a>:</h4>
<p>r0e25:u is always the same 11 million value</p>



<a name="210236301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236301">(Sep 16 2020 at 08:55)</a>:</h4>
<p>perfect</p>



<a name="210236306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236306">(Sep 16 2020 at 08:55)</a>:</h4>
<p>what are those?</p>



<a name="210236308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236308">(Sep 16 2020 at 08:55)</a>:</h4>
<p>so you can actually see the effects of either of the bits</p>



<a name="210236413"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236413" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236413">(Sep 16 2020 at 08:56)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> they're documented for Zen 1 EPYC but not anything else <a href="http://developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf#page=160">developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf#page=160</a></p>



<a name="210236434"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236434" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236434">(Sep 16 2020 at 08:56)</a>:</h4>
<p><a href="/user_uploads/4715/0m8iDiLCLbfxxu0YkGlVHCXW/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/0m8iDiLCLbfxxu0YkGlVHCXW/image.png" title="image.png"><img src="/user_uploads/4715/0m8iDiLCLbfxxu0YkGlVHCXW/image.png"></a></div>



<a name="210236462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236462">(Sep 16 2020 at 08:57)</a>:</h4>
<p>BusLock isn't interesting (hence 0) but the other ones are a 3-way classification of every <code>lock</code> instruction</p>



<a name="210236482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236482">(Sep 16 2020 at 08:57)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> so I'm curious how they get binned once you set each of the MSR bits :D</p>



<a name="210236621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236621">(Sep 16 2020 at 08:59)</a>:</h4>
<p>with the EX bit:</p>
<div class="codehilite"><pre><span></span><code>     6,784,252      r0225:u                                                     
     4,215,997      r0425:u                                                     
           118      r0825:u
</code></pre></div>



<a name="210236628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236628">(Sep 16 2020 at 08:59)</a>:</h4>
<p>with the LS bit:</p>
<div class="codehilite"><pre><span></span><code>     7,220,023      r0225:u                                                     
     3,780,344      r0425:u                                                     
             0      r0825:u
</code></pre></div>



<a name="210236637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236637">(Sep 16 2020 at 08:59)</a>:</h4>
<p>oh also my guess is NonSpecLock happens when the cache line isn't even owned by the current thread, whereas the overcounting happens when it gets stolen some time between starting speculative execution and finishing it</p>



<a name="210236685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236685">(Sep 16 2020 at 09:00)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> lol what</p>



<a name="210236697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236697">(Sep 16 2020 at 09:00)</a>:</h4>
<p>is the 118 constant? is the 0 constant?</p>



<a name="210236736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236736">(Sep 16 2020 at 09:00)</a>:</h4>
<p>this may indicate the EX bit is less reliable</p>



<a name="210236743"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236743" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236743">(Sep 16 2020 at 09:01)</a>:</h4>
<p>or not even tied to this feature</p>



<a name="210236746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236746">(Sep 16 2020 at 09:01)</a>:</h4>
<p>the 118 varies a bit around 120 the 0 seems constant</p>



<a name="210236881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236881">(Sep 16 2020 at 09:02)</a>:</h4>
<p>also, what's the deal with speclockmap vs speclock?</p>



<a name="210236952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210236952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210236952">(Sep 16 2020 at 09:03)</a>:</h4>
<p>not sure yet</p>



<a name="210237347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210237347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210237347">(Sep 16 2020 at 09:08)</a>:</h4>
<p>the ~120 value is only slightly lower (~100) if I remove the interfering thread</p>



<a name="210237654"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210237654" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210237654">(Sep 16 2020 at 09:11)</a>:</h4>
<p>hah I wonder if that's kernel-related</p>



<a name="210349872"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210349872" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210349872">(Sep 17 2020 at 05:34)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="137027">@Jannis Harder</span> heh so kernel patch looks likely now, which would be great for UX <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-693761247">https://github.com/mozilla/rr/issues/2034#issuecomment-693761247</a></p>



<a name="210355853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210355853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210355853">(Sep 17 2020 at 07:27)</a>:</h4>
<p>just realized my use of <code>warn!</code> is an issue (not shown by default, so I need to use <code>error!</code>) and opened <a href="https://github.com/rust-lang/rust/issues/76824">#76824</a></p>



<a name="210355874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210355874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210355874">(Sep 17 2020 at 07:27)</a>:</h4>
<p>like, I really want to catch every weird little thing that may happen</p>



<a name="210357569"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210357569" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210357569">(Sep 17 2020 at 07:49)</a>:</h4>
<p>Oh, I just realized that using those performance counters you can detect (with reasonable accuracy) whether the MSR bit is set without needing the msr module or even root and warn the user when it's not (maybe that's what you're already planning to do, but I was still stuck at thinking that we can't detect it without reading the MSR)</p>



<a name="210358313"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210358313" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210358313">(Sep 17 2020 at 07:56)</a>:</h4>
<p>whoa</p>



<a name="210358321"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210358321" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210358321">(Sep 17 2020 at 07:56)</a>:</h4>
<p>just run an atomic?</p>



<a name="210358363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210358363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210358363">(Sep 17 2020 at 07:56)</a>:</h4>
<p>(followed by a cache line of nops :P)</p>



<a name="210358436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210358436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210358436">(Sep 17 2020 at 07:57)</a>:</h4>
<p>yeah, given that it stays at zero with the bit set, I don't think it needs much interference or a long running loop to increment otherwise... (haven't tested that though)</p>



<a name="210358567"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210358567" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210358567">(Sep 17 2020 at 07:58)</a>:</h4>
<p>and even if not 100% reliable it would only miss warning the user, it wouldn't generate false positives</p>



<a name="210358649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210358649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210358649">(Sep 17 2020 at 07:59)</a>:</h4>
<p>I think I know what to do</p>



<a name="210358900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210358900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210358900">(Sep 17 2020 at 08:02)</a>:</h4>
<p><em>before</em> even starting the instruction counter, do a mini-benchmark (to avoid increasing the number of total counters) and then drop it, freeing the counter</p>



<a name="210368888"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210368888" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210368888">(Sep 17 2020 at 09:53)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> so this would be fun to run with and without the bit set:</p>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/84c85b88a751afc04c301ee1795375f50a29793b/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="210368920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210368920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210368920">(Sep 17 2020 at 09:53)</a>:</h4>
<p>I more or less implemented it :D</p>



<a name="210369038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369038">(Sep 17 2020 at 09:55)</a>:</h4>
<p>without the bit set <code>microbenchmark found 13% atomics started speculative execution</code> every time</p>



<a name="210369049"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369049" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369049">(Sep 17 2020 at 09:55)</a>:</h4>
<p>haha</p>



<a name="210369072"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369072" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369072">(Sep 17 2020 at 09:55)</a>:</h4>
<p>with the bit set no complaints</p>



<a name="210369152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369152">(Sep 17 2020 at 09:56)</a>:</h4>
<p>13% is exactly what I see too</p>



<a name="210369163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369163">(Sep 17 2020 at 09:56)</a>:</h4>
<p>anyway posted as <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-694127840">https://github.com/mozilla/rr/issues/2034#issuecomment-694127840</a></p>



<a name="210369315"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369315" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369315">(Sep 17 2020 at 09:58)</a>:</h4>
<p>oops forgot to say  that <code>rr</code> may want to do this themselves too</p>



<a name="210369405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369405">(Sep 17 2020 at 09:59)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> feel free to reply with your own Zen 2 stats (I used <code>./rdpmc-bench &gt; dev/null 2&gt;| rg atomics</code> to get some more compact output I can make that table from)</p>



<a name="210369664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369664">(Sep 17 2020 at 10:03)</a>:</h4>
<p>Uh not sure what you want me to post where... that's just the line with the 13%?</p>



<a name="210369803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369803">(Sep 17 2020 at 10:04)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> I mean the fact that you get 13% when the bit is not set and no message when the bit is set</p>



<a name="210369868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369868">(Sep 17 2020 at 10:05)</a>:</h4>
<p>it's almost bizarre that Zen 2 has the same behavior on average, but I suspect there's a μarch detail which causes that number</p>



<a name="210369946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210369946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210369946">(Sep 17 2020 at 10:06)</a>:</h4>
<p>maybe they're so slow that only every 7-8 <code>lock xadd</code>s gets speculated?</p>



<a name="210371770"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210371770" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210371770">(Sep 17 2020 at 10:32)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> just checked and it shows up correctly when running <code>rustc -Z self-profile</code> on my branch, e.g.:</p>
<p><code>[ERROR measureme::hw_counters::imp] CpuModel::detect: microbenchmark found 14% atomics started speculative execution, in AMD Zen (Naples/Whitehaven/Summit Ridge/Snowy Owl) CPU; this may add some non-deterministic noise - for more details on this, including possible solutions, see https://github.com/mozilla/rr/issues/2034</code></p>



<a name="210371784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210371784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210371784">(Sep 17 2020 at 10:33)</a>:</h4>
<p>also if anyone has opinions on phrasing/UX of some of this stuff, feel free to bring it up :D</p>



<a name="210372056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372056">(Sep 17 2020 at 10:36)</a>:</h4>
<p>My brain is saying there's a word or two missing in there but maybe I just need more <span aria-label="coffee" class="emoji emoji-2615" role="img" title="coffee">:coffee:</span> </p>
<p><code>microbenchmark found 14% of atomics were executed speculatively; this may add some non-deterministic noise for AMD Zen (Naples/Whitehaven/Summit Ridge/Snowy Owl) CPUs; for more details on this, including possible solutions, see https://github.com/mozilla/rr/issues/2034</code></p>



<a name="210372367"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372367" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372367">(Sep 17 2020 at 10:40)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> sadly that's not technically true :(</p>



<a name="210372382"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372382" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372382">(Sep 17 2020 at 10:40)</a>:</h4>
<p>I was wondering about that, it's a bit strange to describe</p>



<a name="210372397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372397">(Sep 17 2020 at 10:40)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> what gets speculated is instructions <em>after</em> the <code>lock xadd</code></p>



<a name="210372405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372405">(Sep 17 2020 at 10:41)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> I think I need more coffee then</p>



<a name="210372410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372410">(Sep 17 2020 at 10:41)</a>:</h4>
<p>like the CPU enters an almost "transactional" mode</p>



<a name="210372451"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372451" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372451">(Sep 17 2020 at 10:41)</a>:</h4>
<p>my hard to read phrasing is in the sense "atomic started &lt;CPU machinery&gt;"</p>



<a name="210372505"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372505" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372505">(Sep 17 2020 at 10:42)</a>:</h4>
<p>or "put into motion"</p>



<a name="210372531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372531">(Sep 17 2020 at 10:42)</a>:</h4>
<p>if anything described this as "transactions" I could just say "entered transactions" or something</p>



<a name="210372548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372548">(Sep 17 2020 at 10:43)</a>:</h4>
<p>Maybe for the purposes of this message, it's ok to be a bit more vague since we're linking to an issue with the technical details? </p>
<p><code>a microbenchmark detected non-deterministic noise which may skew results; this is an issue that often affects AMD Zen (...) CPUs; for more details on this, including possible solutions, see https://github.com/...</code></p>



<a name="210372572"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372572" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372572">(Sep 17 2020 at 10:43)</a>:</h4>
<p>nope we can't detect noise without a lot of effort :P</p>



<a name="210372645"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372645" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372645">(Sep 17 2020 at 10:44)</a>:</h4>
<p>oh and the CPU is the <em>current</em> CPU's name, not just listing AMD Zen CPUs</p>



<a name="210372677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372677">(Sep 17 2020 at 10:44)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> like, after having been lied to by so many things, I've become very adverse to saying "technically untrue" things</p>



<a name="210372690"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372690" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372690">(Sep 17 2020 at 10:44)</a>:</h4>
<p>it could be shorter for sure</p>



<a name="210372699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372699">(Sep 17 2020 at 10:44)</a>:</h4>
<p>Is the message generated when we know for sure this is happening or just when we think it could happen?</p>



<a name="210372709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372709">(Sep 17 2020 at 10:45)</a>:</h4>
<p>I could also drop the name <code>SpecLockMap</code> since that's something you can look up</p>



<a name="210372727"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372727" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372727">(Sep 17 2020 at 10:45)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> we're 100% sure the thing in the patent exists</p>



<a name="210372739"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372739" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372739">(Sep 17 2020 at 10:45)</a>:</h4>
<p>and is enabled</p>



<a name="210372758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372758">(Sep 17 2020 at 10:45)</a>:</h4>
<p>which almost guarantees the MSR bit that disables it, isn't set</p>



<a name="210372828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372828">(Sep 17 2020 at 10:46)</a>:</h4>
<p>Ok, so we're not 100% sure but this is much more accurate than just checking what the cpuid is or something?</p>



<a name="210372850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372850">(Sep 17 2020 at 10:46)</a>:</h4>
<p>We're like 90%+ sure</p>



<a name="210372852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372852">(Sep 17 2020 at 10:46)</a>:</h4>
<p>this is post-<code>cpuid</code>. we just can't read the MSR from userspace</p>



<a name="210372859"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372859" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372859">(Sep 17 2020 at 10:46)</a>:</h4>
<p>the cpuid only tells that the CPU has this feature, not whether it is enabled</p>



<a name="210372880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372880">(Sep 17 2020 at 10:46)</a>:</h4>
<p><code>cpuid</code> doesn't tell us anything other than the generation of CPU</p>



<a name="210372898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372898">(Sep 17 2020 at 10:47)</a>:</h4>
<p>(or well it doesn't even tell directly that it has the feature,... yeah what <span class="user-mention" data-user-id="119009">@eddyb</span> said)</p>



<a name="210372937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372937">(Sep 17 2020 at 10:47)</a>:</h4>
<p>Right sorry I'm just trying to figure out if we ran an experiment and that points to you having this issue right now or we're just giving you a warning that it could maybe happen but we have no idea if it actually is.</p>



<a name="210372994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210372994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210372994">(Sep 17 2020 at 10:48)</a>:</h4>
<p>I'm trying to answer, but I need a bit more to explain it lol</p>



<a name="210373002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373002">(Sep 17 2020 at 10:48)</a>:</h4>
<p>Ok, sorry I'll listen :)</p>



<a name="210373036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373036">(Sep 17 2020 at 10:48)</a>:</h4>
<p>so let's not use percentages, that's silly</p>



<a name="210373099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373099">(Sep 17 2020 at 10:49)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> we're sure (in the sense of only "something unreasonably strange only a few people at AMD know about, and which we have seen no signs of" could negate this) of certain facts</p>



<a name="210373179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373179">(Sep 17 2020 at 10:50)</a>:</h4>
<p>a "clever" (and patented) transaction-like machinery exists in Zen CPUs for speculatively executing instructions found <em>after</em> a <code>lock</code> (atomic) instruction</p>



<a name="210373226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373226">(Sep 17 2020 at 10:51)</a>:</h4>
<p>we have a name (via ASRock) for this feature: <code>SpecLockMap</code></p>



<a name="210373281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373281">(Sep 17 2020 at 10:51)</a>:</h4>
<p>this name also shows up in the AMD Zen 1 EPYC manuals, as part of a perf counter named <code>SpecLockMapCommit</code></p>



<a name="210373388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373388">(Sep 17 2020 at 10:53)</a>:</h4>
<p>we're sure that the MSR bit ("documented" by ASRock as "disabling <code>SpecLockMap</code>") removes all <code>SpecLockMapCommit</code> events, and <em>as far as we can tell</em> it solves the overcounting issue</p>



<a name="210373433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373433">(Sep 17 2020 at 10:53)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> in other words, I'm detecting that a part of the CPU is enabled, which is the default</p>



<a name="210373516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373516">(Sep 17 2020 at 10:54)</a>:</h4>
<p>on both Zen 1 and Zen 2 it looks like <em>at least</em> 13% of atomics consistently produce <code>SpecLockMapCommit</code> events</p>



<a name="210373526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373526">(Sep 17 2020 at 10:55)</a>:</h4>
<p>(presumably I could get <code>100%</code> if I spaced them out more? let me try)</p>



<a name="210373746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373746">(Sep 17 2020 at 10:56)</a>:</h4>
<p>the overcounting itself is likely under 0.00002%, I'm only looking into this because I want to be able to exactly measure instruction count differences between two different Rust builds</p>



<a name="210373861"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373861" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373861">(Sep 17 2020 at 10:58)</a>:</h4>
<p>which may be as low as 1 instruction difference, from legitimate sources (e.g. in my <code>rdpmc-bench.rs</code>, if you're on LLVM 11 you'll see <code>-1</code> instead of <code>0</code> for perfect runs, because some of the setup code produces one less instruction than it did under LLVM 10)</p>



<a name="210373914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210373914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210373914">(Sep 17 2020 at 10:58)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so this is only really meaningful to "perfectly deterministic profiles" and <code>rr</code></p>



<a name="210374257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374257">(Sep 17 2020 at 11:03)</a>:</h4>
<p>Ok, that makes sense</p>



<a name="210374324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374324">(Sep 17 2020 at 11:04)</a>:</h4>
<p>this shows how much I still have to work on the phrasing welp</p>



<a name="210374349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374349">(Sep 17 2020 at 11:04)</a>:</h4>
<p>I think in your original message I read "microbenchmark found 14% atomics started speculative execution" as needing to say "started in speculative execution mode"</p>



<a name="210374364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374364">(Sep 17 2020 at 11:04)</a>:</h4>
<p>yeah it's not great</p>



<a name="210374366"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374366" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374366">(Sep 17 2020 at 11:04)</a>:</h4>
<p>But I think based on your explanation that's wrong</p>



<a name="210374377"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374377" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374377">(Sep 17 2020 at 11:05)</a>:</h4>
<p>and your original phrasing is correct</p>



<a name="210374384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374384">(Sep 17 2020 at 11:05)</a>:</h4>
<p>I think I'll say <code>SpecLockMap detected</code></p>



<a name="210374401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374401">(Sep 17 2020 at 11:05)</a>:</h4>
<p>in case anyone wants to look it up outside of the <code>rr</code> issue</p>



<a name="210374420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374420">(Sep 17 2020 at 11:05)</a>:</h4>
<p>I think mentioning <code>SpecLockMap</code> somehow would be good</p>



<a name="210374775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210374775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210374775">(Sep 17 2020 at 11:10)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> okay I got it to 100% almost every time (and 95% one time), I think I can now tweak it so it doesn't take too long :P</p>



<a name="210376170"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210376170" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210376170">(Sep 17 2020 at 11:29)</a>:</h4>
<p>oh yeah I was clearly overthinking it lol</p>



<a name="210376177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210376177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210376177">(Sep 17 2020 at 11:29)</a>:</h4>
<p>it takes a single atomic</p>



<a name="210379651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210379651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210379651">(Sep 17 2020 at 12:10)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> what do you think of this now?</p>
<p><code>CpuModel::detect: SpecLockMap detected, in AMD Zen (Naples/Whitehaven/Summit Ridge/Snowy Owl) CPU; this may add some non-deterministic noise - for more details, and possible solutions, see https://github.com/mozilla/rr/issues/2034</code></p>



<a name="210379680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210379680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210379680">(Sep 17 2020 at 12:10)</a>:</h4>
<p>That's great!</p>



<a name="210379684"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210379684" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210379684">(Sep 17 2020 at 12:10)</a>:</h4>
<p>I'm no longer showing any values because I ran a shell loop and couldn't get it to not count</p>



<a name="210379689"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210379689" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210379689">(Sep 17 2020 at 12:10)</a>:</h4>
<p>thanks :D</p>



<a name="210379712"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210379712" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210379712">(Sep 17 2020 at 12:11)</a>:</h4>
<p>Btw, thanks for posting all this stuff here, it's been super interesting to follow along with</p>



<a name="210380942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210380942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210380942">(Sep 17 2020 at 12:24)</a>:</h4>
<p>okay left a comment about that part <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-694193189">https://github.com/mozilla/rr/issues/2034#issuecomment-694193189</a></p>



<a name="210380970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210380970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210380970">(Sep 17 2020 at 12:25)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> this is still reliable, right?</p>
<p><code>rustup component add --toolchain nightly rustc-dev &amp;&amp; curl -sS https://gist.githubusercontent.com/eddyb/269491b0b59605f39f1d0a9dcf535c4a/raw/73d6a9c55783d52bfbc8cc1ae6b7e8300a9ef7c9/rdpmc-bench.rs | rustc +nightly - -o rdpmc-bench -O &amp;&amp; setarch x86_64 -R ./rdpmc-bench &amp;&amp; sleep 1 &amp;&amp; setarch x86_64 -R ./rdpmc-bench</code></p>



<a name="210381015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210381015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210381015">(Sep 17 2020 at 12:25)</a>:</h4>
<p>I should maybe make a dedicated benchmark but eh</p>



<a name="210381510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210381510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210381510">(Sep 17 2020 at 12:30)</a>:</h4>
<p>it is</p>



<a name="210454686"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210454686" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210454686">(Sep 17 2020 at 21:35)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> heh more minor complications I can remove <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-694511526">https://github.com/mozilla/rr/issues/2034#issuecomment-694511526</a></p>



<a name="210471773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210471773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210471773">(Sep 18 2020 at 01:52)</a>:</h4>
<p>and <code>rr</code> is getting the <code>SpecLockMapCommit</code> check, nice <a href="https://github.com/mozilla/rr/pull/2671/files#diff-4af56136223ea6f4c389bb52987a6701R265-R294">https://github.com/mozilla/rr/pull/2671/files#diff-4af56136223ea6f4c389bb52987a6701R265-R294</a></p>



<a name="210484075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210484075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210484075">(Sep 18 2020 at 06:51)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> hah there's now a script that does the <code>wrmsr -a</code> thing <a href="https://github.com/mozilla/rr/wiki/Zen">https://github.com/mozilla/rr/wiki/Zen</a></p>



<a name="210484156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210484156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210484156">(Sep 18 2020 at 06:52)</a>:</h4>
<p>yeah, and since a few minutes ago it also doesn't trip on <code>/dev/cpu/microcode</code> existing :)</p>



<a name="210484167"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210484167" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210484167">(Sep 18 2020 at 06:52)</a>:</h4>
<p>heh</p>



<a name="210484461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210484461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210484461">(Sep 18 2020 at 06:56)</a>:</h4>
<p>though that doesn't seem to take into account all the Spectre mitigations stuff on Zen 1 :( <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-694692816">https://github.com/mozilla/rr/issues/2034#issuecomment-694692816</a></p>



<a name="210492820"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210492820" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210492820">(Sep 18 2020 at 08:45)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> did AMD ever document which CPUs actually have the architectural MSR for the ssb mitigation? The only thing I found says "some models of family 17h have logic that allow loads to bypass older stores but lack the architectural SPEC_CTRL or VIRT_SPEC_CTRL" which is pretty vague</p>



<a name="210494504"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210494504" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210494504">(Sep 18 2020 at 09:04)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> not really, you're supposed to use the <code>cpuid</code> bit</p>



<a name="210494522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210494522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210494522">(Sep 18 2020 at 09:04)</a>:</h4>
<p>but I doubt it varies within a generation</p>



<a name="210498850"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210498850" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210498850">(Sep 18 2020 at 09:59)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> I don't understand how zeros are possible</p>



<a name="210499031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499031">(Sep 18 2020 at 10:02)</a>:</h4>
<p>because you expect some atomics to be present?</p>



<a name="210499082"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499082" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499082">(Sep 18 2020 at 10:02)</a>:</h4>
<p>because I'm sure there are atomics present</p>



<a name="210499112"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499112" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499112">(Sep 18 2020 at 10:02)</a>:</h4>
<p>maybe there is some other mechanism that elides atomics?</p>



<a name="210499117"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499117" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499117">(Sep 18 2020 at 10:02)</a>:</h4>
<p>I just need to find something with a lot more</p>



<a name="210499140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499140">(Sep 18 2020 at 10:03)</a>:</h4>
<p>no, I mean, these counters count <code>lock</code> instructions, no matter how they're implemented</p>



<a name="210499148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499148">(Sep 18 2020 at 10:03)</a>:</h4>
<p>and we've shown this :/</p>



<a name="210499258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499258">(Sep 18 2020 at 10:04)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> what if you replace <code>perf ... echo</code> with <code>echo 'fn main() {}' | perf ... rustc -</code>?</p>



<a name="210499305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499305">(Sep 18 2020 at 10:05)</a>:</h4>
<p>for <code>echo 'fn main() {}' | perf stat -e r002c:u,r0225:u,r0425:u,r0825:u,r0e25:u rustc -</code> I get:</p>
<div class="codehilite"><pre><span></span><code>               285      r002c:u
             1,352      r0225:u
            16,867      r0425:u
            66,387      r0825:u
            84,606      r0e25:u
</code></pre></div>



<a name="210499319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499319">(Sep 18 2020 at 10:05)</a>:</h4>
<p>yeah nonzero for me too</p>



<a name="210499322"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499322" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499322">(Sep 18 2020 at 10:06)</a>:</h4>
<p>but what magnitude?</p>



<a name="210499365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499365">(Sep 18 2020 at 10:06)</a>:</h4>
<p>it should be the same a cross sytems</p>



<a name="210499406"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499406" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499406">(Sep 18 2020 at 10:06)</a>:</h4>
<div class="codehilite"><pre><span></span><code>           105      r002c:u                                                     
         1,622      r0225:u                                                     
        17,054      r0425:u                                                     
        65,330      r0825:u                                                     
        84,006      r0e25:u
</code></pre></div>



<a name="210499432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499432">(Sep 18 2020 at 10:07)</a>:</h4>
<p>weird, you're missing exactly 600</p>



<a name="210499462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499462">(Sep 18 2020 at 10:07)</a>:</h4>
<p>I'll run <code>rustup update stable</code> and hope we can use that to synchronize</p>



<a name="210499473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499473">(Sep 18 2020 at 10:08)</a>:</h4>
<p>"rustc 1.46.0 (04488afe3 2020-08-24)" is my default currently</p>



<a name="210499546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499546">(Sep 18 2020 at 10:08)</a>:</h4>
<p>I'm seeing a bunch of variation, this is weird, on ev- oh it's the LLVM threads</p>



<a name="210499661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499661">(Sep 18 2020 at 10:10)</a>:</h4>
<p><code>echo 'fn main() {}' | env RUSTC_BOOTSTRAP=1 perf stat -e r002c:u,r0225:u,r0425:u,r0825:u,r0e25:u rustc +stable - -Z no-parallel-llvm</code> still varies but it's a bit more stable, and the total (r0e25:u) is around 76,250</p>



<a name="210499795"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499795" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499795">(Sep 18 2020 at 10:12)</a>:</h4>
<p>so, if I have a simple c program that just exits (but is dynamically linked) I get all zeros... if I add a single lock add instruction I see just that single instruction for the counters</p>



<a name="210499810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499810">(Sep 18 2020 at 10:13)</a>:</h4>
<p>that's weird</p>



<a name="210499826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499826">(Sep 18 2020 at 10:13)</a>:</h4>
<p>what do you get for my last command btw?</p>



<a name="210499835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499835">(Sep 18 2020 at 10:13)</a>:</h4>
<p>why are you sure that echo should execute atomics?</p>



<a name="210499857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499857">(Sep 18 2020 at 10:13)</a>:</h4>
<div class="codehilite"><pre><span></span><code>            30      r002c:u                                                     
           804      r0225:u                                                     
        13,785      r0425:u                                                     
        59,915      r0825:u                                                     
        74,504      r0e25:u
</code></pre></div>



<a name="210499905"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499905" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499905">(Sep 18 2020 at 10:14)</a>:</h4>
<p>is it consistently around 74.5k?</p>



<a name="210499914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499914">(Sep 18 2020 at 10:14)</a>:</h4>
<p>+/- a few 100</p>



<a name="210499921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499921">(Sep 18 2020 at 10:14)</a>:</h4>
<p>because that's 2000 less counted atomics for you. maybe it's the glibc version?</p>



<a name="210499944"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499944" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499944">(Sep 18 2020 at 10:14)</a>:</h4>
<p>or maybe it's just some instructions aren't considered atomics anymore hah</p>



<a name="210499981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499981">(Sep 18 2020 at 10:15)</a>:</h4>
<p>if I compile my empty c program with <code>-pthread</code> I get 4 atomic instructions</p>



<a name="210499993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210499993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210499993">(Sep 18 2020 at 10:15)</a>:</h4>
<p>if you want you could make sure <code>r001c:u</code> (unchageable bus locks) is zero, I guess, that would....</p>



<a name="210500010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500010">(Sep 18 2020 at 10:15)</a>:</h4>
<p>oh! where is my <code>echo</code> from I wonder</p>



<a name="210500084"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500084" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500084">(Sep 18 2020 at 10:16)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> <code>ldd $(which echo)</code></p>



<a name="210500110"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500110" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500110">(Sep 18 2020 at 10:16)</a>:</h4>
<div class="codehilite"><pre><span></span><code>linux-vdso.so.1 (0x00007ffe8e7f5000)
libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007fdbd4c74000)
/lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007fdbd4e83000)
</code></pre></div>



<a name="210500113"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500113" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500113">(Sep 18 2020 at 10:16)</a>:</h4>
<p>mine links against <code>librt.so.1</code>, <code>libacl.so.1</code>, <code>libattr.so.1</code>, <code>libpthread.so.0</code> and <code>libc.so.6</code></p>



<a name="210500114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500114">(Sep 18 2020 at 10:17)</a>:</h4>
<p>okay so this is a distro thing</p>



<a name="210500140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500140">(Sep 18 2020 at 10:17)</a>:</h4>
<p>It can also vary between shells:</p>
<div class="codehilite"><pre><span></span><code>$ type echo
echo is a shell builtin
</code></pre></div>



<a name="210500153"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500153" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500153">(Sep 18 2020 at 10:17)</a>:</h4>
<p>that's not what perf will run</p>



<a name="210500222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500222">(Sep 18 2020 at 10:18)</a>:</h4>
<p><code>env echo --version</code> =&gt; <code>echo (GNU coreutils) 8.32</code> here</p>



<a name="210500241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500241">(Sep 18 2020 at 10:18)</a>:</h4>
<p>yeah the problem is the distro I think. not sure what NixOS does differently but there's a bunch of things linked by default that you don't have</p>



<a name="210500257"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500257" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500257">(Sep 18 2020 at 10:19)</a>:</h4>
<p>actually, what if you compile your C program with <code>-lrt -lacl -lattr -lpthread</code>? do you then get exactly my counts?</p>



<a name="210500306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500306">(Sep 18 2020 at 10:19)</a>:</h4>
<p>nope still only 4 total</p>



<a name="210500433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500433">(Sep 18 2020 at 10:21)</a>:</h4>
<p>I'll be afk for a bit</p>



<a name="210500709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500709">(Sep 18 2020 at 10:25)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> <span class="user-mention" data-user-id="119581">@mati865</span> if you're bored:</p>
<div class="codehilite"><pre><span></span><code>find /bin | xargs -n1 bash -c &#39;ldd $0 | grep -C10 libpthread &gt; /dev/null &amp;&amp; echo $0&#39; | wc -l
</code></pre></div>



<a name="210500813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500813">(Sep 18 2020 at 10:26)</a>:</h4>
<p>lol can we just get @glandium in here so they're not going back &amp; forth on GH?</p>



<a name="210500848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500848">(Sep 18 2020 at 10:27)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ find /bin | xargs -n1 bash -c &#39;ldd $0 | grep -C10 libpthread &gt; /dev/null &amp;&amp; echo $0&#39; | wc -l
ldd: /bin: not regular file
0
</code></pre></div>


<p>Huh?</p>



<a name="210500939"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500939" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500939">(Sep 18 2020 at 10:28)</a>:</h4>
<p><span class="user-mention" data-user-id="119581">@mati865</span> hmm maybe try <code>/usr/bin</code> instead?</p>



<a name="210500954"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210500954" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210500954">(Sep 18 2020 at 10:28)</a>:</h4>
<p>wait I should've asked first: are you on NixOS lol</p>



<a name="210501010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501010">(Sep 18 2020 at 10:29)</a>:</h4>
<p>Yeah, just noticed it did not follow the symlink.<br>
I'm on Arch Linux.</p>



<a name="210501099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501099">(Sep 18 2020 at 10:30)</a>:</h4>
<p>oh it needed <code>/</code> after <code>/bin</code>?</p>



<a name="210501187"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501187" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501187">(Sep 18 2020 at 10:31)</a>:</h4>
<p>Exactly.<br>
It prints <code>2298</code> at the end but on Arch <code>/bin</code> is symlinked to <code>/usr/bin</code> so that's every binary on my system.</p>



<a name="210501214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501214">(Sep 18 2020 at 10:31)</a>:</h4>
<p><em>grumbles</em></p>



<a name="210501276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501276">(Sep 18 2020 at 10:32)</a>:</h4>
<p><span class="user-mention" data-user-id="119581">@mati865</span> replace <code>wc -l</code> with <code>less</code> or w/e and then look for something that sounds simple/basic?</p>



<a name="210501283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501283">(Sep 18 2020 at 10:32)</a>:</h4>
<p>maybe it's everything lol</p>



<a name="210501312"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501312" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501312">(Sep 18 2020 at 10:32)</a>:</h4>
<p>(on NixOS, for <code>/run/current-system/sw/bin/</code> on this server, I get <code>313</code> out of <code>732</code> total files in that directory)</p>



<a name="210501375"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501375" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501375">(Sep 18 2020 at 10:33)</a>:</h4>
<p>/me scrolls over 2k entries...</p>



<a name="210501378"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501378" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501378">(Sep 18 2020 at 10:33)</a>:</h4>
<p>wait why am I looking for this? I guess I'm hoping for a multithreaded workload <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="210501458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501458">(Sep 18 2020 at 10:34)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ ldd /bin/sort
        linux-vdso.so.1 (0x00007ffdf7be3000)
        libcrypto.so.1.1 =&gt; /usr/lib/libcrypto.so.1.1 (0x00007f573158d000)
        libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007f573156b000)
        libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f57313a2000)
        libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007f573139c000)
        /lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f57318de000)
</code></pre></div>



<a name="210501461"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501461" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501461">(Sep 18 2020 at 10:34)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> ^</p>



<a name="210501881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501881">(Sep 18 2020 at 10:40)</a>:</h4>
<p><span class="user-mention" data-user-id="119581">@mati865</span> <span class="user-mention" data-user-id="137027">@Jannis Harder</span> alright, this saturates at 129 atomics for me (as in, if I increase the <code>seq</code> number, it doesn't go above 129):</p>
<div class="codehilite"><pre><span></span><code>seq 1000 | perf stat -e r002c:u,r0225:u,r0425:u,r0825:u,r0e25:u sort &gt; /dev/null
</code></pre></div>



<a name="210501928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210501928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210501928">(Sep 18 2020 at 10:41)</a>:</h4>
<div class="codehilite"><pre><span></span><code>                 1      r002c:u
                 4      r0225:u
                54      r0425:u
                71      r0825:u
               129      r0e25:u
</code></pre></div>


<p>Zen+</p>



<a name="210502010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210502010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210502010">(Sep 18 2020 at 10:42)</a>:</h4>
<p>Only <code>r0e25:u</code> is totally stable.</p>



<a name="210502027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210502027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210502027">(Sep 18 2020 at 10:42)</a>:</h4>
<p>yeah that's expected. it's the actual count, the rest are the 3 possible ways an atomic can execute</p>



<a name="210502108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210502108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210502108">(Sep 18 2020 at 10:43)</a>:</h4>
<p>e.g. <code>r0225:u</code> can be hit if the cache line was evicted, IIUC (which might happen non-deterministically through the kernel handling interrupts and whatnot)</p>



<a name="210503432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210503432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210503432">(Sep 18 2020 at 10:58)</a>:</h4>
<p>FWIW <code>perf stat -e r0225:u,r0425:u,r0825:u,r0e25:u /bin/echo</code> gives all zeros for me. So indeed seems like a distro thing.</p>



<a name="210504189"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210504189" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210504189">(Sep 18 2020 at 11:06)</a>:</h4>
<p><code>perf stat foo</code> will run <code>which foo</code>, not the shell's <code>foo</code>, if you're referring to that</p>



<a name="210504211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210504211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210504211">(Sep 18 2020 at 11:06)</a>:</h4>
<p>this holds in general for any command, not just <code>perf</code>, as long as it's not a shell builtin itself :P (<code>time</code> in some shells)</p>



<a name="210504246"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210504246" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210504246">(Sep 18 2020 at 11:07)</a>:</h4>
<p>I was referring to <code>assuming there are some distro differences and echo truly executes no atomics for you</code></p>



<a name="210504333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210504333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210504333">(Sep 18 2020 at 11:08)</a>:</h4>
<p>sure, it's just the <code>/bin/echo</code> that I think is redundant</p>



<a name="210504418"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210504418" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210504418">(Sep 18 2020 at 11:09)</a>:</h4>
<p>It is, I just wanted to be sure</p>



<a name="210504435"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210504435" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210504435">(Sep 18 2020 at 11:09)</a>:</h4>
<p>btw at some point I found out about the <code>command</code> command (heh), which (in some shells?) is a built-in that will execute what you pass to it ignoring  builtins. so, like, <code>command time foo</code> will run <code>$(which time) foo</code> not <code>time foo</code> (this only matters is <code>time</code> is a builtin)</p>



<a name="210504512"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210504512" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210504512">(Sep 18 2020 at 11:10)</a>:</h4>
<p>it came in handy as <code>fish</code>'s <code>time</code> builtin doesn't print max RSS like the real <code>time</code> tool does</p>



<a name="210505604"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210505604" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210505604">(Sep 18 2020 at 11:23)</a>:</h4>
<p>XD</p>
<div class="codehilite"><pre><span></span><code> mateusz@arch  /tmp/zen_test  time ls
a.out  foo  foo.c  test.c
ls --color=tty  0.00s user 0.00s system 83% cpu 0.001 total
 mateusz@arch  /tmp/zen_test  command time ls
time may be found in the following packages:
  extra/time 1.9-2                      /usr/bin/time
  community/plan9port 20190619-1        /usr/lib/plan9/bin/time
</code></pre></div>


<p>I was sure I had time installed on my system until now...<br>
I know my <code>time</code> is ZSH builtin.</p>



<a name="210579967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210579967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210579967">(Sep 18 2020 at 22:00)</a>:</h4>
<p>just noticed this was added o_O <a href="https://en.wikichip.org/wiki/amd/cpuid#Family_25_.2819h.29">https://en.wikichip.org/wiki/amd/cpuid#Family_25_.2819h.29</a></p>



<a name="210580600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210580600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210580600">(Sep 18 2020 at 22:09)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> does setting the MSR bit turn off both <code>r0425:u</code> <em>and</em> <code>r0825:u</code> for you, or just the latter?</p>



<a name="210581563"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210581563" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210581563">(Sep 18 2020 at 22:25)</a>:</h4>
<p><span class="user-mention" data-user-id="119581">@mati865</span> could you run <code>head -n6 /proc/cpuinfo</code>?</p>



<a name="210581641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210581641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210581641">(Sep 18 2020 at 22:26)</a>:</h4>
<p>I just realized I missed something important and we kinda need to catalog Zen further</p>



<a name="210581649"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210581649" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210581649">(Sep 18 2020 at 22:26)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> :</p>
<div class="codehilite"><pre><span></span><code>$ head -n6 /proc/cpuinfo
processor       : 0
vendor_id       : AuthenticAMD
cpu family      : 23
model           : 8
model name      : AMD Ryzen 7 2700X Eight-Core Processor
stepping        : 2
</code></pre></div>



<a name="210581839"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210581839" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210581839">(Sep 18 2020 at 22:30)</a>:</h4>
<p>thanks</p>



<a name="210581847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210581847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210581847">(Sep 18 2020 at 22:30)</a>:</h4>
<p>Sure</p>



<a name="210581901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210581901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210581901">(Sep 18 2020 at 22:31)</a>:</h4>
<p>this is starting to bother me a bit, and I didn't catalog everything we ran my benchmark on :/</p>



<a name="210581997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210581997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210581997">(Sep 18 2020 at 22:32)</a>:</h4>
<p>oh come on, the page I was looking at doesn't list at least two of these :| <a href="https://www.amd.com/en/support/tech-docs?keyword=family+17h+PPR">https://www.amd.com/en/support/tech-docs?keyword=family+17h+PPR</a></p>



<a name="210582544"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210582544" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210582544">(Sep 18 2020 at 22:42)</a>:</h4>
<p>but it's also missing the ones on here <a href="https://developer.amd.com/resources/epyc-resources/epyc-specifications/">https://developer.amd.com/resources/epyc-resources/epyc-specifications/</a></p>



<a name="210605000"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605000" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605000">(Sep 19 2020 at 08:50)</a>:</h4>
<p>Regarding GitHub comments I'm  on 5.8.9 with <code>CONFIG_KALLSYMS_ALL=y</code>, should I execute something?</p>



<a name="210605190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605190">(Sep 19 2020 at 08:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/210580600">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="137027">Jannis Harder</span> does setting the MSR bit turn off both <code>r0425:u</code> <em>and</em> <code>r0825:u</code> for you, or just the latter?</p>
</blockquote>
<p>just the latter, the <code>r0425:u</code> gets larger by what looks like <code>r0825:u</code>has without the MSR bit</p>



<a name="210605386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605386">(Sep 19 2020 at 09:03)</a>:</h4>
<p>that's good, so <code>Hi</code>/<code>Lo</code> are just names for two kinds of speculation o_O</p>



<a name="210605390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605390">(Sep 19 2020 at 09:03)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> just to be sure, what does <code>head -n6 /proc/cpuinfo</code> say?</p>



<a name="210605393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605393">(Sep 19 2020 at 09:03)</a>:</h4>
<p>some of these manuals are weird</p>



<a name="210605396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605396">(Sep 19 2020 at 09:03)</a>:</h4>
<div class="codehilite"><pre><span></span><code>processor   : 0
vendor_id   : AuthenticAMD
cpu family  : 23
model       : 113
model name  : AMD Ryzen 9 3950X 16-Core Processor
stepping    : 0
</code></pre></div>



<a name="210605502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605502">(Sep 19 2020 at 09:06)</a>:</h4>
<p>thanks. that's indeed documented as <code>SpecLockLoSpec</code> vs <code>SpecLockHiSpec</code> (for 4 vs 8)</p>



<a name="210605516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605516">(Sep 19 2020 at 09:07)</a>:</h4>
<p>didn't those have different names before?</p>



<a name="210605565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605565">(Sep 19 2020 at 09:08)</a>:</h4>
<p><code>SpecLock</code> and <code>SpecLockMapCommit</code>, yes, but those names only exist in the spec from <a href="https://developer.amd.com/resources/epyc-resources/epyc-specifications/">https://developer.amd.com/resources/epyc-resources/epyc-specifications/</a>, i.e. <a href="http://developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf">http://developer.amd.com/wordpress/media/2017/11/54945_PPR_Family_17h_Models_00h-0Fh.pdf</a></p>



<a name="210605614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605614">(Sep 19 2020 at 09:10)</a>:</h4>
<p>but it's not even applicable to EPYC 1 Zen at least according to itself, lol</p>



<a name="210605617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210605617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210605617">(Sep 19 2020 at 09:10)</a>:</h4>
<p>(it's... confusing)</p>



<a name="210642357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210642357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210642357">(Sep 20 2020 at 00:40)</a>:</h4>
<p>do we have anyone here with a Ryzen 1xxx series? I can't remember <em>starts searching</em></p>



<a name="210642397"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210642397" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210642397">(Sep 20 2020 at 00:40)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> in <a href="#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207271931">https://rust-lang.zulipchat.com/#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207271931</a> you said "ryzen1" - is that Ryzen 1xxx or EPYC 7xx1?</p>



<a name="210642446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210642446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210642446">(Sep 20 2020 at 00:42)</a>:</h4>
<p><span class="user-mention" data-user-id="119581">@mati865</span> oh oh you mentioned you have a desktop with a Ryzen 1600? in <a href="#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209717845">https://rust-lang.zulipchat.com/#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/209717845</a></p>



<a name="210642460"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210642460" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210642460">(Sep 20 2020 at 00:43)</a>:</h4>
<p>the test, to be clear, is this (alongside <code>head -n6 /proc/cpuinfo</code> so I don't lose track of it again :D):</p>
<div class="codehilite"><pre><span></span><code>seq <span class="m">1000</span> <span class="p">|</span> perf stat -e r002c:u,r0225:u,r0425:u,r0825:u,r0e25:u sort &gt; /dev/null
</code></pre></div>



<a name="210642522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210642522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210642522">(Sep 20 2020 at 00:44)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> you brought up "1800x" in <a href="#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041293">https://rust-lang.zulipchat.com/#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207041293</a> - do you still have access to that system?</p>



<a name="210642582"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210642582" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210642582">(Sep 20 2020 at 00:46)</a>:</h4>
<p>I don't</p>



<a name="210642815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210642815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210642815">(Sep 20 2020 at 00:54)</a>:</h4>
<p>thanks. so now I'm waiting for <span class="user-mention" data-user-id="123586">@nagisa</span>, <span class="user-mention" data-user-id="119581">@mati865</span>, tuxiqae on GItHub, and a couple people on IRC. frankly, any one of them getting non-zero results across the counters is confirmation that it behaves as expected</p>



<a name="210645507"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210645507" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210645507">(Sep 20 2020 at 02:28)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> btw it might be interesting to see what effect applying the script mentioned in <a href="https://github.com/mozilla/rr/wiki/Zen">https://github.com/mozilla/rr/wiki/Zen</a> has on the perf collection variance (presumably you'd want to run it before each run, in case the server became "too idle" or something)</p>



<a name="210645517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210645517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210645517">(Sep 20 2020 at 02:29)</a>:</h4>
<p>I expect the main impact will be on <code>instructions:u</code> in <code>-check</code> benchmarks, otherwise the multithreading will probably introduce its own non-determinism anyway</p>



<a name="210655271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210655271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210655271">(Sep 20 2020 at 08:06)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> my brother has 1600 in his desktop but he was quite busy lately.</p>



<a name="210655275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210655275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210655275">(Sep 20 2020 at 08:07)</a>:</h4>
<p>mhmm. well, if you get the chance to run that command quickly, lmk! and thanks either way :D</p>



<a name="210655338"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210655338" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210655338">(Sep 20 2020 at 08:09)</a>:</h4>
<p>I'll be there in 2-3 hours, got other things to do first :p</p>



<a name="210655346"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210655346" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210655346">(Sep 20 2020 at 08:10)</a>:</h4>
<p>heh that's no time, if I solve this mystery in less than a week I'll be happy</p>



<a name="210659405"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210659405" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210659405">(Sep 20 2020 at 10:17)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> are you around and willing to play a game?</p>



<a name="210659901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210659901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210659901">(Sep 20 2020 at 10:31)</a>:</h4>
<p>(OR your MSR with 0x100. but someone else already confirmed it fully disables <code>lock</code> speculation)</p>



<a name="210660139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210660139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210660139">(Sep 20 2020 at 10:37)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> <span class="user-mention" data-user-id="119581">@mati865</span> <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-695771458">https://github.com/mozilla/rr/issues/2034#issuecomment-695771458</a></p>



<a name="210660177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210660177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210660177">(Sep 20 2020 at 10:38)</a>:</h4>
<p>feel free to turn bits on/off and play around but I think the mystery is solved</p>



<a name="210660564"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210660564" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210660564">(Sep 20 2020 at 10:48)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Ubuntu 20.04 with 1600:</p>
<div class="codehilite"><pre><span></span><code>$ seq 1000 | perf stat -e r002c:u,r0225:u,r0425:u,r0825:u,r0e25:u sort &gt; /dev/null

 Performance counter stats for &#39;sort&#39;:

                 0      r002c:u
                 0      r0225:u
                56      r0425:u
                73      r0825:u
               129      r0e25:u
</code></pre></div>



<a name="210660574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210660574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210660574">(Sep 20 2020 at 10:49)</a>:</h4>
<p>sweet! that's expected. want to post it to <a href="https://github.com/mozilla/rr/issues/2034">https://github.com/mozilla/rr/issues/2034</a>? not sure if you want to run any of the <code>rr</code> stuff itself on that machine</p>



<a name="210660731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210660731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210660731">(Sep 20 2020 at 10:52)</a>:</h4>
<p>That would be a bit problematic, he has only Android Studio for learning <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="210660756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210660756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210660756">(Sep 20 2020 at 10:52)</a>:</h4>
<p>haha. no worries! the results are still useful to show that the 0s aren't universal to Zen 1 Ryzen 1st gen etc.</p>



<a name="210660766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210660766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210660766">(Sep 20 2020 at 10:53)</a>:</h4>
<p>even if we're pretty sure why that person was seeing the 0s</p>



<a name="210660771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210660771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210660771">(Sep 20 2020 at 10:53)</a>:</h4>
<p>and even if you're not confirming <code>rr</code> works :P</p>



<a name="210664278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210664278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210664278">(Sep 20 2020 at 12:17)</a>:</h4>
<p>okay maybe I went overkill on this <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-695780661">https://github.com/mozilla/rr/issues/2034#issuecomment-695780661</a></p>



<a name="210664360"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210664360" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210664360">(Sep 20 2020 at 12:19)</a>:</h4>
<p>oops, just remembered to add a small note to indicate that this is just documentation weirdness, they're all the same really</p>



<a name="210693719"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210693719" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210693719">(Sep 21 2020 at 00:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/210642397">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="123586">nagisa</span> in <a href="#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207271931">https://rust-lang.zulipchat.com/#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/207271931</a> you said "ryzen1" - is that Ryzen 1xxx or EPYC 7xx1?</p>
</blockquote>
<p>ryzen 1700</p>



<a name="210693737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210693737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210693737">(Sep 21 2020 at 00:59)</a>:</h4>
<div class="codehilite"><pre><span></span><code>                 1      r002c:u
                 3      r0225:u
                38      r0425:u
                88      r0825:u
               129      r0e25:u
</code></pre></div>



<a name="210694842"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210694842" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210694842">(Sep 21 2020 at 01:35)</a>:</h4>
<p>thanks!</p>



<a name="210695262"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210695262" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210695262">(Sep 21 2020 at 01:46)</a>:</h4>
<p><span class="user-mention" data-user-id="123586">@nagisa</span> btw if you missed it, we found out empirically that <code>MSRC001_1020[8]</code> just turns all lock speculation off :P</p>



<a name="210695267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210695267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210695267">(Sep 21 2020 at 01:46)</a>:</h4>
<p>not just the more advanced kind (that has the overcounting problem)</p>



<a name="210695566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210695566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210695566">(Sep 21 2020 at 01:56)</a>:</h4>
<p>oh and yorick on IRC, who confirmed that (on Zen 2, guess they didn't want to accidentally nuke their Zen 1 machine)</p>



<a name="210695574"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210695574" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210695574">(Sep 21 2020 at 01:57)</a>:</h4>
<p>well, let's just say they saw some terrible slowdown when accidentally passing decimal to <code>wrmsr</code> which would set some of the lower bits I guess</p>



<a name="210695630"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210695630" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210695630">(Sep 21 2020 at 01:59)</a>:</h4>
<blockquote>
<p>&lt;yorick&gt; <code>sudo wrmsr -a 0xc0011020 0xffffffffffffffff # for the adventurous</code></p>
</blockquote>



<a name="210695723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210695723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210695723">(Sep 21 2020 at 02:01)</a>:</h4>
<p><span class="user-mention" data-user-id="119581">@mati865</span> <span class="user-mention" data-user-id="123586">@nagisa</span> I bet neither of you has this motherboard <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-695870532">https://github.com/mozilla/rr/issues/2034#issuecomment-695870532</a></p>



<a name="210695965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210695965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210695965">(Sep 21 2020 at 02:06)</a>:</h4>
<blockquote>
<p>Gigabyte AX370-Gaming K7 version F31</p>
</blockquote>



<a name="210696102"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210696102" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210696102">(Sep 21 2020 at 02:10)</a>:</h4>
<p>found another motherboard (but that only sets bit 8) <a href="https://bugzilla.kernel.org/show_bug.cgi?id=196683#c573">https://bugzilla.kernel.org/show_bug.cgi?id=196683#c573</a></p>



<a name="210701308"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210701308" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210701308">(Sep 21 2020 at 04:47)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> oh this is much cleaner than mine (uses tracepoints instead, no other changes to kernel state) <a href="https://gist.github.com/glandium/01d54cefdb70561b5f6675e08f2990f2">https://gist.github.com/glandium/01d54cefdb70561b5f6675e08f2990f2</a></p>



<a name="210708798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210708798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210708798">(Sep 21 2020 at 07:31)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> the motherboard in  2700X box is Gigabyte X470 Gaming 7 WiFi rev 1.0.<br>
1600 box has Asus X370 Prime Pro.</p>



<a name="210708990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210708990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210708990">(Sep 21 2020 at 07:33)</a>:</h4>
<p>interesting, heh same chipset but different motherboard manufacturer. so I'm guessing it either requires a BIOS update or AMD never mandated those bits to be turned on (and whoever makes Gigabyte's BIOS just did it because it fixed some issue)</p>



<a name="210709141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210709141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210709141">(Sep 21 2020 at 07:34)</a>:</h4>
<p>I don't think motherboard matters here. This could be AGESA issue that affects some of the versions.</p>



<a name="210709201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210709201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210709201">(Sep 21 2020 at 07:35)</a>:</h4>
<p>BTW Gigabyte's BIOS (on my X470) is buggy as hell.</p>



<a name="210709334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210709334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210709334">(Sep 21 2020 at 07:37)</a>:</h4>
<p>F31 BIOS for Gigabyte AX370-Gaming K7 was released on 06/05/2019, so it's quite old.</p>



<a name="210725715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210725715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210725715">(Sep 21 2020 at 10:50)</a>:</h4>
<p>there's been a bios release with AGESA ComboAm4PI 1.0.0.6 for my mobo recently</p>



<a name="210725726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210725726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210725726">(Sep 21 2020 at 10:51)</a>:</h4>
<p>so I could possibly verify the theory</p>



<a name="210725746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/210725746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#210725746">(Sep 21 2020 at 10:51)</a>:</h4>
<p>but yeah more likely than not its gonna be an agesa thing, mobo manufacturers don’t have much say in how CPU is set-up at boot.</p>



<a name="211025726"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211025726" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211025726">(Sep 23 2020 at 16:11)</a>:</h4>
<p>alright, sysadmin just installed the workaround (glandium's version not mine) in the Zen 1 EPYC (<a href="http://build.lyken.rs">build.lyken.rs</a>)</p>



<a name="211025866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211025866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211025866">(Sep 23 2020 at 16:12)</a>:</h4>
<p>and results look great, at least in the artificial <code>rdpmc-bench</code>, will find out soon what <code>rustc -Z self-profile</code> is like</p>



<a name="211027982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211027982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211027982">(Sep 23 2020 at 16:28)</a>:</h4>
<div class="codehilite"><pre><span></span><code>43472092838
43472092580
43472092571
43472092571
43472092571
43472092571
43472092580
43472092580
43472092580
43472092571
</code></pre></div>



<a name="211028039"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211028039" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211028039">(Sep 23 2020 at 16:28)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> welcome to the future :D</p>



<a name="211028095"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211028095" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211028095">(Sep 23 2020 at 16:29)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Largest 7 variances:
  ±0 instructions: 2064977 occurrences, or 99.96%
  ±0.5 instructions: 794 occurrences, or 0.04%
  ±1 instructions: 6 occurrences, or 0.00%
  ±1.5 instructions: 2 occurrences, or 0.00%
  ±2 instructions: `adt_dtorck_constraint()`
  ±4.5 instructions: 2 occurrences, or 0.00%
  ±73 instructions: `self_profile_alloc_query_strings()`
</code></pre></div>



<a name="211030616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211030616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211030616">(Sep 23 2020 at 16:50)</a>:</h4>
<p>just had a cool idea: <code>instructions - uops</code> as a measure of "microcode is executing" (or maybe other things that expand but idk what exactly does)</p>



<a name="211030891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211030891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211030891">(Sep 23 2020 at 16:52)</a>:</h4>
<p>This is really incredible work <span class="user-mention" data-user-id="119009">@eddyb</span>!</p>



<a name="211030985"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211030985" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211030985">(Sep 23 2020 at 16:53)</a>:</h4>
<p>couldn't have done it with all of the people who helped me test, <span class="user-mention" data-user-id="137027">@Jannis Harder</span>'s MSR hackery, glandium's much improved kernel module, etc.</p>



<a name="211030999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211030999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211030999">(Sep 23 2020 at 16:53)</a>:</h4>
<p>also I'm falling asleep for the day but I really wanted to see this in action</p>



<a name="211082154"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211082154" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211082154">(Sep 24 2020 at 01:49)</a>:</h4>
<p>if I look at just the second and third run I see this:</p>
<div class="codehilite"><pre><span></span><code>Largest 3 variances:
  ±0 instructions: 2065670 occurrences, or 99.99%
  ±0.5 instructions: 112 occurrences, or 0.01%
  ±4.5 instructions: `write_crate_metadata()`
</code></pre></div>



<a name="211082165"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211082165" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211082165">(Sep 24 2020 at 01:49)</a>:</h4>
<p>with regards to <code>write_crate_metadata</code>, my bet is it's writing out data, which might result in a partial <code>write</code> and take more <code>write</code> syscalls sometimes</p>



<a name="211083143"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211083143" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211083143">(Sep 24 2020 at 02:08)</a>:</h4>
<p>oh, I want to try <code>jemalloc</code>, since that was much noisier (before applying the workaround)</p>



<a name="211084097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211084097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211084097">(Sep 24 2020 at 02:30)</a>:</h4>
<p>jemalloc still looks like it introduces ASLR, huh</p>



<a name="211084644"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211084644" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211084644">(Sep 24 2020 at 02:41)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> just to check, do we use <code>jemalloc</code> in nightlies? because  that seems to largely invalidate the benefits of disabling ASLR</p>



<a name="211084687"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211084687" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211084687">(Sep 24 2020 at 02:42)</a>:</h4>
<p>or it otherwise introduces noise some other way</p>



<a name="211084696"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211084696" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211084696">(Sep 24 2020 at 02:42)</a>:</h4>
<p>On linux, yes</p>



<a name="211084715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211084715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211084715">(Sep 24 2020 at 02:42)</a>:</h4>
<p>We've not checked for awhile if that's actually best though FWIW</p>



<a name="211084931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211084931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211084931">(Sep 24 2020 at 02:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> oof so <a href="http://perf.rust-lang.org">perf.rust-lang.org</a> has had unnecessary noise this entire time</p>



<a name="211084956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211084956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211084956">(Sep 24 2020 at 02:47)</a>:</h4>
<p>probably 100x-200x more with jemalloc than without, and that's <em>before</em> disabling <code>SpecLockMap</code></p>



<a name="211095835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211095835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211095835">(Sep 24 2020 at 07:08)</a>:</h4>
<p>Perf.rlo runs on Ubuntu 20.04?</p>



<a name="211131561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211131561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211131561">(Sep 24 2020 at 13:34)</a>:</h4>
<p>no</p>



<a name="211131597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211131597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211131597">(Sep 24 2020 at 13:35)</a>:</h4>
<p>we are on 18.04, though we could upgrade to 20.04 without too much hassle I suspect</p>



<a name="211131606"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211131606" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211131606">(Sep 24 2020 at 13:35)</a>:</h4>
<p>(probably should, just haven't gotten around to it)</p>



<a name="211142363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211142363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211142363">(Sep 24 2020 at 14:51)</a>:</h4>
<p>I think last benchmark without jemalloc was made on 18.04 already so I'd not expect big gains when compared to it.</p>



<a name="211146503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211146503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211146503">(Sep 24 2020 at 15:18)</a>:</h4>
<p>I expect recent glibc to be on par for performance, not necessarily faster. But in my experience it's also more stable for things like RSS.</p>



<a name="211146595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211146595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211146595">(Sep 24 2020 at 15:19)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> in case you missed it, <code>jemalloc</code> has unpredictable instruction counts even with ASLR disabled and <code>SpecLockMap</code> disabled (the thing that blocked <code>rr</code> on Zen until recently)</p>



<a name="211146621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211146621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211146621">(Sep 24 2020 at 15:19)</a>:</h4>
<p>and idk if I want to spend time investigating <em>why</em></p>



<a name="211146680"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211146680" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211146680">(Sep 24 2020 at 15:19)</a>:</h4>
<p>but it potentially means 100x noise reduction on <a href="http://perf.rust-lang.org">perf.rust-lang.org</a> (for <code>instructions:u</code> specifically) if we stop using jemalloc</p>



<a name="211146809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211146809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211146809">(Sep 24 2020 at 15:20)</a>:</h4>
<p>last time when I looked I could only find a PRNG with a constant seed</p>



<a name="211146868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211146868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211146868">(Sep 24 2020 at 15:21)</a>:</h4>
<p>I'll add that to my list of glibc's more stable things <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="211146962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211146962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211146962">(Sep 24 2020 at 15:21)</a>:</h4>
<p>if only I knew what was going on</p>



<a name="211147097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147097">(Sep 24 2020 at 15:22)</a>:</h4>
<p>with glibc's or any other thread-safe allocator we found the problem to be atomics which turned into the whole <code>SpecLockMap</code> fiasco and eventually unlocked <code>rr</code> on Zen, lol</p>



<a name="211147272"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147272" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147272">(Sep 24 2020 at 15:23)</a>:</h4>
<p><span aria-label="water buffalo" class="emoji emoji-1f403" role="img" title="water buffalo">:water_buffalo:</span>🪒 (pretend that's a yak)</p>



<a name="211147278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147278">(Sep 24 2020 at 15:23)</a>:</h4>
<p>but now that's solved and glibc's allocator is 100% deterministic AFAICT, whereas jemalloc is still around ±2 miillion instructions or so, which is about the same thing we get from ASLR</p>



<a name="211147448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147448">(Sep 24 2020 at 15:24)</a>:</h4>
<p>including that thing where the <code>pid.to_string()</code> allocation (through its length) was effectively behaving like low-entropy ASLR</p>



<a name="211147527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147527">(Sep 24 2020 at 15:25)</a>:</h4>
<p>any effect like that will funnel into <code>rustc</code>'s (pointer-keyed) <code>HashMap</code>s and cause the couple million instructions swing</p>



<a name="211147533"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147533" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147533">(Sep 24 2020 at 15:25)</a>:</h4>
<p>Have you compared syscalls?</p>



<a name="211147573"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147573" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147573">(Sep 24 2020 at 15:25)</a>:</h4>
<p>I have in the past while investigating the thing that turned out to be atomics</p>



<a name="211147651"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147651" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147651">(Sep 24 2020 at 15:26)</a>:</h4>
<p>but that was on the artificial microbenchmark</p>



<a name="211147699"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147699" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147699">(Sep 24 2020 at 15:26)</a>:</h4>
<p>I'm somewhat terrified of <code>strace</code>-ing an entire <code>rustc</code></p>



<a name="211147742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147742">(Sep 24 2020 at 15:26)</a>:</h4>
<p>then again, as long as the output file is not hundreds of GBs, the server can handle it lol</p>



<a name="211147773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147773">(Sep 24 2020 at 15:27)</a>:</h4>
<p>I know jemalloc likes <code>madvise</code> unused pages, which might cause some non-determinism whether the kernel uses that page for other things</p>



<a name="211147832"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147832" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147832">(Sep 24 2020 at 15:27)</a>:</h4>
<p>wouldn't reach into millions I don't think, if it was just pagefaults or something</p>



<a name="211147956"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211147956" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211147956">(Sep 24 2020 at 15:28)</a>:</h4>
<p>You could start with <code>strace -c</code> for an overview, then <code>strace -e foo</code> on interesting differences</p>



<a name="211148032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148032">(Sep 24 2020 at 15:28)</a>:</h4>
<p>True, the work of filling page faults is all in the kernel, out of your counts</p>



<a name="211148075"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148075" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148075">(Sep 24 2020 at 15:29)</a>:</h4>
<p>nooot exactly</p>



<a name="211148099"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148099" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148099">(Sep 24 2020 at 15:29)</a>:</h4>
<p>No?</p>



<a name="211148111"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148111" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148111">(Sep 24 2020 at 15:29)</a>:</h4>
<p>I've empirically measured the <code>iret</code>s from page faults count in userspace, just like any other kernel -&gt; userspace <code>iret</code>s</p>



<a name="211148121"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148121" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148121">(Sep 24 2020 at 15:29)</a>:</h4>
<p>it's why I'm subtracting hardware interrupts from instructions :D</p>



<a name="211148197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148197">(Sep 24 2020 at 15:30)</a>:</h4>
<p>page faults are just far more deterministic IME, so I haven't bothered yet</p>



<a name="211148221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148221">(Sep 24 2020 at 15:30)</a>:</h4>
<p>Well ok, but you're already dealing with that.</p>



<a name="211148243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148243">(Sep 24 2020 at 15:30)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> the problem is the CPU is being too literal <em>sigh</em></p>



<a name="211148285"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148285" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148285">(Sep 24 2020 at 15:31)</a>:</h4>
<p><code>iret</code> <em>technically</em> retires in userspace even if the kernel executed it</p>



<a name="211148332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148332">(Sep 24 2020 at 15:31)</a>:</h4>
<p>but I really wish they made an exception</p>



<a name="211148364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148364">(Sep 24 2020 at 15:31)</a>:</h4>
<p>Yeah</p>



<a name="211148379"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148379" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148379">(Sep 24 2020 at 15:31)</a>:</h4>
<p>anyway I guess I can do a quick <code>perf -e faults</code> or w/e</p>



<a name="211148548"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148548" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148548">(Sep 24 2020 at 15:32)</a>:</h4>
<p>of course the strace diff is  tiny lol</p>



<a name="211148599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148599">(Sep 24 2020 at 15:33)</a>:</h4>
<p>it's just pids/tids</p>



<a name="211148717"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148717" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148717">(Sep 24 2020 at 15:34)</a>:</h4>
<p>wait I'm missing <code>-f</code> ain't I /facepalm</p>



<a name="211148874"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148874" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148874">(Sep 24 2020 at 15:35)</a>:</h4>
<p>I also meant between glibc and jemalloc in <code>strace -c</code> counts, to look for systemic differences that may be your next clue (or red herring)</p>



<a name="211148935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211148935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211148935">(Sep 24 2020 at 15:35)</a>:</h4>
<p>interesting, I wouldn't have considered comparing across different builds like that</p>



<a name="211149020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211149020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211149020">(Sep 24 2020 at 15:36)</a>:</h4>
<p>wait what <em>process</em>? I thought this was a thread</p>



<a name="211149070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211149070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211149070">(Sep 24 2020 at 15:36)</a>:</h4>
<p>does strace call threads "processes"?</p>



<a name="211149409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211149409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211149409">(Sep 24 2020 at 15:39)</a>:</h4>
<p>Not sure, but in the kernel that is fuzzy -- <code>pid</code> is what we'd call a thread, and <code>tgid</code> is really the process</p>



<a name="211149438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211149438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211149438">(Sep 24 2020 at 15:39)</a>:</h4>
<p>heh</p>



<a name="211149529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211149529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211149529">(Sep 24 2020 at 15:40)</a>:</h4>
<p>okay this is better:<br>
<code>delta &lt;(cat rustc-cf65d26e-jemalloc-strace-1 | sed 's/70715/CHILD/') &lt;(cat rustc-cf65d26e-jemalloc-strace-2 | sed 's/71351/CHILD/')</code></p>



<a name="211149714"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211149714" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211149714">(Sep 24 2020 at 15:41)</a>:</h4>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code> [pid CHILD] madvise(0x7fffdd46d000, 10309632, MADV_DONTNEED) = 0
<span class="gd">-[pid CHILD] mmap(NULL, 83886080, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, -1, 0) = 0x7fffd0900&gt;</span>
 [pid CHILD] madvise(0x7fffdb620000, 12288, MADV_FREE) = 0
<span class="gd">-[pid CHILD] madvise(0x7fffe30f8000, 65536, MADV_FREE) = 0</span>
<span class="gi">+[pid CHILD] madvise(0x7fffd70ea000, 172032, MADV_FREE) = 0</span>
 [pid CHILD] madvise(0x7fffea469000, 40960, MADV_FREE) = 0
</code></pre></div>



<a name="211149742"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211149742" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211149742">(Sep 24 2020 at 15:41)</a>:</h4>
<p>hello darkness my old friend,</p>



<a name="211149880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211149880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211149880">(Sep 24 2020 at 15:43)</a>:</h4>
<p>that's weird, there's a literal <code>getrandom</code> call in <code>rustc</code> that doesn't affect instruction counts, I guess it's fixed length or something</p>



<a name="211149921"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211149921" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211149921">(Sep 24 2020 at 15:43)</a>:</h4>
<p>(it's making a temporary dir to write the output file in)</p>



<a name="211150339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211150339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211150339">(Sep 24 2020 at 15:46)</a>:</h4>
<p>oh no <a href="https://github.com/jemalloc/jemalloc/blob/dev/src/background_thread.c">https://github.com/jemalloc/jemalloc/blob/dev/src/background_thread.c</a></p>



<a name="211150392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211150392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211150392">(Sep 24 2020 at 15:47)</a>:</h4>
<p>I forgot about the "asynchronously GC whole slabs" strategy...</p>



<a name="211150420"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211150420" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211150420">(Sep 24 2020 at 15:47)</a>:</h4>
<p>I should've thought about this, but also it's been like a decade lol</p>



<a name="211150619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211150619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211150619">(Sep 24 2020 at 15:48)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> if <code>jemalloc</code> is starting helper threads to do GC on, that's free nondeterminism and it might mean <code>jemalloc</code> is at odds with <a href="http://perf.rust-lang.org">perf.rust-lang.org</a> :/</p>



<a name="211150702"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211150702" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211150702">(Sep 24 2020 at 15:49)</a>:</h4>
<p>Is there a tunable parameter for that?</p>



<a name="211150716"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211150716" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211150716">(Sep 24 2020 at 15:49)</a>:</h4>
<p>just found it heh</p>



<a name="211150798"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211150798" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211150798">(Sep 24 2020 at 15:50)</a>:</h4>
<p><a href="https://github.com/jemalloc/jemalloc/blob/259c5e3e8f4731f2e32ceac71c66f4bc7d078145/src/jemalloc.c#L1453-L1459">https://github.com/jemalloc/jemalloc/blob/259c5e3e8f4731f2e32ceac71c66f4bc7d078145/src/jemalloc.c#L1453-L1459</a></p>



<a name="211151019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211151019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211151019">(Sep 24 2020 at 15:51)</a>:</h4>
<p>oh there's an even earlier difference:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-[pid CHILD] madvise(0x7fffe2569000, 20480, MADV_FREE) = 0</span>
</code></pre></div>



<a name="211151045"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211151045" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211151045">(Sep 24 2020 at 15:51)</a>:</h4>
<p>okay I'm not sure it's starting a thread</p>



<a name="211151880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211151880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211151880">(Sep 24 2020 at 15:57)</a>:</h4>
<p>lol even in check mode we start a couple thread near the end and create a temp dir... to write nothing in?</p>



<a name="211155159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211155159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211155159">(Sep 24 2020 at 16:21)</a>:</h4>
<p>fascinating <a href="https://github.com/jemalloc/jemalloc/blob/dev/include/jemalloc/internal/pa.h">https://github.com/jemalloc/jemalloc/blob/dev/include/jemalloc/internal/pa.h</a></p>



<a name="211155424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211155424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211155424">(Sep 24 2020 at 16:23)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> not liking the look of this <a href="https://github.com/jemalloc/jemalloc/blob/259c5e3e8f4731f2e32ceac71c66f4bc7d078145/src/arena.c#L398-L412">https://github.com/jemalloc/jemalloc/blob/259c5e3e8f4731f2e32ceac71c66f4bc7d078145/src/arena.c#L398-L412</a></p>



<a name="211155536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211155536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211155536">(Sep 24 2020 at 16:24)</a>:</h4>
<p>it's either background thread or time-based :/</p>



<a name="211156119"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211156119" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211156119">(Sep 24 2020 at 16:28)</a>:</h4>
<p>oof <a href="http://jemalloc.net/jemalloc.3.html#opt.dirty_decay_ms">http://jemalloc.net/jemalloc.3.html#opt.dirty_decay_ms</a></p>



<a name="211156172"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211156172" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211156172">(Sep 24 2020 at 16:28)</a>:</h4>
<blockquote>
<p>A decay time of 0 causes all unused dirty pages to be purged immediately upon creation.</p>
</blockquote>



<a name="211156182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211156182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211156182">(Sep 24 2020 at 16:28)</a>:</h4>
<p>oh! that's probably beter</p>



<a name="211156665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211156665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211156665">(Sep 24 2020 at 16:32)</a>:</h4>
<p><code>MALLOC_CONF=dirty_decay_ms:0</code> maaay have done it :D</p>



<a name="211157129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211157129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211157129">(Sep 24 2020 at 16:35)</a>:</h4>
<p>down to just ±7825 :D</p>



<a name="211157666"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211157666" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211157666">(Sep 24 2020 at 16:40)</a>:</h4>
<p>aaand with both decays turned off (<code>MALLOC_CONF=dirty_decay_ms:0,muzzy_decay_ms:0</code>) we're back to only two common totals differing by 9 instructions!</p>
<div class="codehilite"><pre><span></span><code>43103897635
43103897635
43103897644
43103897635
43103897644
43103897644
43103897635
43103897635
43103897644
43103897635
</code></pre></div>



<a name="211157744"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211157744" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211157744">(Sep 24 2020 at 16:40)</a>:</h4>
<p>that's it. that's the jemalloc non-determinism <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span></p>



<a name="211158008"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158008" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158008">(Sep 24 2020 at 16:43)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> thanks a lot for the <code>strace</code> suggestion, knowing that the first difference is <code>madvise(MADV_FREE)</code> helped a lot!</p>



<a name="211158623"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158623" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158623">(Sep 24 2020 at 16:48)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> what's the easiest way to gauge variance across the 3 runs or w/e that we get on <a href="http://perf.rust-lang.org">perf.rust-lang.org</a> for a given benchmark?</p>



<a name="211158648"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158648" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158648">(Sep 24 2020 at 16:48)</a>:</h4>
<p>is the raw data easy to get at?</p>



<a name="211158673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158673">(Sep 24 2020 at 16:48)</a>:</h4>
<p>For me yeah</p>



<a name="211158678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158678">(Sep 24 2020 at 16:48)</a>:</h4>
<p>I'm asking because I want to test this jemalloc config</p>



<a name="211158704"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158704" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158704">(Sep 24 2020 at 16:48)</a>:</h4>
<p>okay great that should be enough</p>



<a name="211158741"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158741" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158741">(Sep 24 2020 at 16:49)</a>:</h4>
<p>But we have at most 2 data points fwiw because of self profile overheads</p>



<a name="211158777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158777">(Sep 24 2020 at 16:49)</a>:</h4>
<p>oof</p>



<a name="211158787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158787">(Sep 24 2020 at 16:49)</a>:</h4>
<p>I guess I can adjust that manually</p>



<a name="211158814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158814">(Sep 24 2020 at 16:49)</a>:</h4>
<p>(for a one off longer but more repetitions run)</p>



<a name="211158828"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158828" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158828">(Sep 24 2020 at 16:49)</a>:</h4>
<p>we should bump it for smaller benchmarks</p>



<a name="211158833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158833">(Sep 24 2020 at 16:49)</a>:</h4>
<p>It wouldn't be too hard</p>



<a name="211158856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158856">(Sep 24 2020 at 16:49)</a>:</h4>
<p>alright I'll prepare a PR then</p>



<a name="211158936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211158936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211158936">(Sep 24 2020 at 16:50)</a>:</h4>
<p>Sounds good, I can do the backend work today I think</p>



<a name="211159106"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211159106" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211159106">(Sep 24 2020 at 16:51)</a>:</h4>
<p>this is not that urgent, I don't think I want to rely on <code>jemalloc</code> locally anyway, the first time I tried it I wanted to check if it fixed the noise I was seeing (which was actually coming from <code>SpecLockMap</code>)</p>



<a name="211172300"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211172300" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211172300">(Sep 24 2020 at 18:36)</a>:</h4>
<p>oops forgot to open as draft initially</p>



<a name="211172484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211172484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211172484">(Sep 24 2020 at 18:38)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> spent a bunch trying to describe what's going on, not sure how well this "footnotes" style works <a href="https://github.com/rust-lang/rust/pull/77162">https://github.com/rust-lang/rust/pull/77162</a></p>



<a name="211178652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211178652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211178652">(Sep 24 2020 at 19:27)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> try build done, feel free to start poking at it <a href="https://github.com/rust-lang/rust/pull/77162#issuecomment-698541699">https://github.com/rust-lang/rust/pull/77162#issuecomment-698541699</a></p>



<a name="211178664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211178664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211178664">(Sep 24 2020 at 19:27)</a>:</h4>
<p>yep will do so shortly</p>



<a name="211179319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211179319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211179319">(Sep 24 2020 at 19:33)</a>:</h4>
<p>thanks! I'll probably go to sleep soon anyway, so no hurries</p>



<a name="211179347"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211179347" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211179347">(Sep 24 2020 at 19:33)</a>:</h4>
<p>(wait, that's not a word. that's hurry+worries)</p>



<a name="211213540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211213540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211213540">(Sep 25 2020 at 03:00)</a>:</h4>
<p>oh wow nice command</p>



<a name="211213763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211213763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211213763">(Sep 25 2020 at 03:05)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> at least e.g. <code>clap-rs</code> and <code>cranelift-codegen</code> behave similarly to what I saw myself locally</p>



<a name="211213853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211213853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211213853">(Sep 25 2020 at 03:07)</a>:</h4>
<p>oof, it's a performance regression</p>



<a name="211213926"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211213926" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211213926">(Sep 25 2020 at 03:08)</a>:</h4>
<p>hmpf both of those are less than 10 seconds</p>



<a name="211213931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211213931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211213931">(Sep 25 2020 at 03:09)</a>:</h4>
<p>maybe I'm wrong about that?</p>



<a name="211213936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211213936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211213936">(Sep 25 2020 at 03:09)</a>:</h4>
<p>10 seconds is a lot</p>



<a name="211213949"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211213949" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211213949">(Sep 25 2020 at 03:09)</a>:</h4>
<p>maybe it's more probabilistic and I'm not reading the docs correctly?</p>



<a name="211213997"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211213997" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211213997">(Sep 25 2020 at 03:10)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> anyway it might be that <code>SpecLockMap</code> is obscuring the actual changes here (if any)</p>



<a name="211214022"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214022" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214022">(Sep 25 2020 at 03:11)</a>:</h4>
<p>These are all instruction counts? Not sure what you mean by seconds</p>



<a name="211214028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214028">(Sep 25 2020 at 03:11)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> the <code>jemalloc</code> thing we're disabling only kicks in after 10 seconds by default</p>



<a name="211214036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214036">(Sep 25 2020 at 03:11)</a>:</h4>
<p>so for anything shorter, we shouldn't actually see a difference if I'm reading the docs right</p>



<a name="211214037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214037">(Sep 25 2020 at 03:11)</a>:</h4>
<p>Oh yeah that'll affect almost none of the benchmarks</p>



<a name="211214038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214038">(Sep 25 2020 at 03:11)</a>:</h4>
<p>welp</p>



<a name="211214081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214081">(Sep 25 2020 at 03:12)</a>:</h4>
<p>I can try toggling the msr bits tomorrow</p>



<a name="211214094"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214094" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214094">(Sep 25 2020 at 03:12)</a>:</h4>
<p>should be as simple as running the Python script from the rr wiki</p>



<a name="211214096"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214096" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214096">(Sep 25 2020 at 03:12)</a>:</h4>
<p>so anyway yeah we might not need this workaround in most cases (it would be funny if all of the benchmarks you disabled were exactly the only ones which did need it :P)</p>



<a name="211214100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214100">(Sep 25 2020 at 03:13)</a>:</h4>
<p>sorry I didn't explain this properly last night</p>



<a name="211214205"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214205" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214205">(Sep 25 2020 at 03:15)</a>:</h4>
<p>my libcore runs took somewhere between 13 and 24 seconds (I think the latter was with debug assertions enabled which I stopped using a while back), so they were seeing this</p>



<a name="211214273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214273">(Sep 25 2020 at 03:16)</a>:</h4>
<p>If you want to kick off a run with exclude switched to include on a new try build that seems like not a bad idea</p>



<a name="211214305"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214305" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214305">(Sep 25 2020 at 03:17)</a>:</h4>
<p>Might work on the same try commit, too, not sure</p>



<a name="211214319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214319">(Sep 25 2020 at 03:17)</a>:</h4>
<p>oooh, cool! does <code>queue</code> take the extra options or do I have to do separate try + <code>build</code>?</p>



<a name="211214386"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214386" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214386">(Sep 25 2020 at 03:18)</a>:</h4>
<p>I'll also take a look at the 10 second split</p>



<a name="211214401"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214401" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214401">(Sep 25 2020 at 03:19)</a>:</h4>
<p>on <a href="https://perf.rust-lang.org/index.html?absolute=true&amp;stat=wall-time">https://perf.rust-lang.org/index.html?absolute=true&amp;stat=wall-time</a> probably, since it seems like the easiest place to do it</p>



<a name="211214457"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211214457" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211214457">(Sep 25 2020 at 03:20)</a>:</h4>
<p>or, hmm, I have <code>rustc-timing</code> or w/e checked out somewhere, I could also <code>jq</code> some random commit in that</p>



<a name="211215031"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211215031" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211215031">(Sep 25 2020 at 03:34)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> it's... just <code>packed-simd</code> and <code>style-servo</code>, and the former only for <code>incr-full</code> :/</p>



<a name="211215652"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211215652" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211215652">(Sep 25 2020 at 03:49)</a>:</h4>
<p>I tried with the existing try build but nothing happened (not even on the status page) <a href="https://github.com/rust-lang/rust/pull/77162#issuecomment-698702189">https://github.com/rust-lang/rust/pull/77162#issuecomment-698702189</a></p>



<a name="211215707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211215707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211215707">(Sep 25 2020 at 03:50)</a>:</h4>
<p>won't bother, for just one benchmark, before <code>SpecLockMap</code> is disabled, anyway</p>



<a name="211215979"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211215979" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211215979">(Sep 25 2020 at 03:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I just had a "fun" idea: once my lands, the collector could run the equivalent of<br>
<code>echo | rustc - --crate-type=lib --emit=dep-info -o /dev/null -Z self-profile -Z self-profile-counters=instructions</code><br>
(and check stderr for any log messages)</p>



<a name="211216040"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211216040" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211216040">(Sep 25 2020 at 03:58)</a>:</h4>
<p>and refuse to run. so that we can tell if the workaround is ever reverted or something</p>



<a name="211218698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211218698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211218698">(Sep 25 2020 at 05:00)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I'm being informed <code>setarch -R</code> works without having to pass <code>x86_64</code> or w/e, I could've sworn I tried this, guess I didn't</p>



<a name="211243359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211243359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211243359">(Sep 25 2020 at 10:58)</a>:</h4>
<p>I tried it too. I think it's a recent addition</p>



<a name="211245158"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211245158" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211245158">(Sep 25 2020 at 11:21)</a>:</h4>
<p>it's on our server from the start of the year (and <code>--version</code> says it's <code>util-linux 2.33.2</code>), but maybe this is unstable NixOS</p>



<a name="211250775"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211250775" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211250775">(Sep 25 2020 at 12:26)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> okay, just ran the rr script, I get "Zen workaround in place"</p>



<a name="211250847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211250847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211250847">(Sep 25 2020 at 12:26)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> forgot to mention, I hope no collection is on-going?</p>



<a name="211250856"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211250856" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211250856">(Sep 25 2020 at 12:26)</a>:</h4>
<p>otherwise it will be partially denoised</p>



<a name="211250866"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211250866" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211250866">(Sep 25 2020 at 12:26)</a>:</h4>
<p>let me kill it and restart it</p>



<a name="211251135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211251135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211251135">(Sep 25 2020 at 12:29)</a>:</h4>
<p>so already that run might show some improvements (even with just two data points, they shouldn't be farther apart than the hardware interrupt noise, which is going to be smaller for quicker benchmarks anyway)</p>



<a name="211251334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211251334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211251334">(Sep 25 2020 at 12:30)</a>:</h4>
<p>eh, it's a try build so might not be perfect</p>



<a name="211251384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211251384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211251384">(Sep 25 2020 at 12:31)</a>:</h4>
<p>we don't really have a good way of assigning "environment" to commits yet, I've wanted to work on it but just haven't found time</p>



<a name="211251427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211251427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211251427">(Sep 25 2020 at 12:31)</a>:</h4>
<p>the other thing we should look into is counting hw interrupts on the collection server, but we have to be careful</p>



<a name="211251492"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211251492" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211251492">(Sep 25 2020 at 12:32)</a>:</h4>
<p>I ended up reading about what <code>perf stat</code> does when running out of counters and it's... not great</p>



<a name="211251519"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211251519" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211251519">(Sep 25 2020 at 12:32)</a>:</h4>
<p>the multiplexing means it has to rely on time to give you an estimate</p>



<a name="211251535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211251535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211251535">(Sep 25 2020 at 12:32)</a>:</h4>
<p>which means it would add noise of its own</p>



<a name="211251559"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211251559" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211251559">(Sep 25 2020 at 12:32)</a>:</h4>
<p>now thankfully not everything we measure is a PMU counter</p>



<a name="211729388"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211729388" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211729388">(Sep 30 2020 at 08:32)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> hmm is there any way to see if the collections that have happened before/after are different in any way?</p>



<a name="211729402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211729402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211729402">(Sep 30 2020 at 08:32)</a>:</h4>
<p>before/after running the Zen workaround script I mean</p>



<a name="211739396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211739396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211739396">(Sep 30 2020 at 10:14)</a>:</h4>
<p>just got an idea... WSL2 might be virtualizing perf counters, right?</p>



<a name="211739491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211739491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211739491">(Sep 30 2020 at 10:15)</a>:</h4>
<p>because we might be able to support profiling rustc on windows, sort of</p>



<a name="211751332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211751332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211751332">(Sep 30 2020 at 12:26)</a>:</h4>
<p>I don't think we observed any significant difference, it'll be annoying if even possible to locate it I think</p>



<a name="211754001"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211754001" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211754001">(Sep 30 2020 at 12:50)</a>:</h4>
<p>weeird</p>



<a name="211754023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211754023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211754023">(Sep 30 2020 at 12:51)</a>:</h4>
<p>though maybe it's hidden behind the interrupts</p>



<a name="211828225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211828225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211828225">(Sep 30 2020 at 21:15)</a>:</h4>
<p><span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>
<div class="codehilite"><pre><span></span><code>CpuModel::detect: vendor=&quot;AuthenticAMD&quot; family=15 model=107
CpuModel::detect: known AMD CPU: K8 (Hammer)
</code></pre></div>



<a name="211828332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211828332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211828332">(Sep 30 2020 at 21:16)</a>:</h4>
<p>and the hw interrupt counter looks functional</p>



<a name="211828390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211828390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211828390">(Sep 30 2020 at 21:17)</a>:</h4>
<p>anyway yeah uhh I can more easily get perfect results on Athlon 64 X2 than modern CPUs, that shouldn't be too surprising :P</p>



<a name="211829442"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211829442" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211829442">(Sep 30 2020 at 21:27)</a>:</h4>
<p>idk if it was worth spending an entire day trying to install linux from a windows install and no working boot from USB etc. etc.</p>



<a name="211829546"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/211829546" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#211829546">(Sep 30 2020 at 21:28)</a>:</h4>
<p>but hey if anyone needs to test something on K8</p>



<a name="213095459"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213095459" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213095459">(Oct 12 2020 at 23:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so prepping my code for upstreaming (blergh delays), I think I'm going with <code>instructions-minus-irqs:u</code> for the combined thing that subtracts "hardware interrupts" from <code>instructions:u</code> (to account for post-interrupt-handling kernel-&gt;usermode <code>iret</code>s overcounting)</p>



<a name="213095526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213095526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213095526">(Oct 12 2020 at 23:18)</a>:</h4>
<p>(reasoning is "irqs" is shorter than even "hw_ints" and probably more easily recognizable without being technically wrong AFAIK)</p>



<a name="213096188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213096188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213096188">(Oct 12 2020 at 23:31)</a>:</h4>
<p>Ok</p>



<a name="213100139"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213100139" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213100139">(Oct 13 2020 at 00:45)</a>:</h4>
<p>hopefully <code>-Z self-profile-counter=instructions-minus-irqs:u</code> is not too unwieldy</p>



<a name="213100157"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213100157" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213100157">(Oct 13 2020 at 00:45)</a>:</h4>
<p>maybe now that it's opt-in I can remove all the graceful fallback and make more things into normal error handling</p>



<a name="213101920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213101920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213101920">(Oct 13 2020 at 01:05)</a>:</h4>
<p><a href="/user_uploads/4715/0n2BEXMWvhXpnjbKrd1EaDym/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/0n2BEXMWvhXpnjbKrd1EaDym/image.png" title="image.png"><img src="/user_uploads/4715/0n2BEXMWvhXpnjbKrd1EaDym/image.png"></a></div>



<a name="213101924"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213101924" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213101924">(Oct 13 2020 at 01:06)</a>:</h4>
<p>final automation seems to be working</p>



<a name="213102191"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213102191" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213102191">(Oct 13 2020 at 01:10)</a>:</h4>
<p>this is so much better than editing the source for every test configuration <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> (especially since I've given up on measuring the raw 4-instruction <code>rdpmc</code> sequence, and all configurations are now pretty much in line with what one might observe in the final version)</p>



<a name="213102458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213102458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213102458">(Oct 13 2020 at 01:15)</a>:</h4>
<p>weird effect I keep seeing: the first run after some inactivity has 258 more instructions than the one after it. and this is exactly the same number across days and even different builds with several different changes</p>



<a name="213102653"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213102653" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213102653">(Oct 13 2020 at 01:19)</a>:</h4>
<p>maybe something to do with caching?</p>



<a name="213102658"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213102658" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213102658">(Oct 13 2020 at 01:19)</a>:</h4>
<p>like disk caching I mean</p>



<a name="213103535"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213103535" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213103535">(Oct 13 2020 at 01:38)</a>:</h4>
<p>maybe <code>write_all</code> for <code>libcore.rmeta</code> hits the retry loop <em>a lot</em> the first time, but then it just writes to the disk cache in RAM?</p>



<a name="213331520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213331520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213331520">(Oct 14 2020 at 18:18)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> I wonder if you have some data for several consecutive runs that's like <code>x+250</code> followed by several <code>x±10</code>?</p>



<a name="213331615"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213331615" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213331615">(Oct 14 2020 at 18:19)</a>:</h4>
<p>like this is the 10 runs after I recompiled, a couple days ago</p>
<div class="codehilite"><pre><span></span><code>43357151428
43357151170
43357151170
43357151170
43357151170
43357151179
43357151179
43357151182
43357151170
43357151170
</code></pre></div>



<a name="213331641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213331641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213331641">(Oct 14 2020 at 18:19)</a>:</h4>
<p>note how uniform they are after the first one</p>



<a name="213331733"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213331733" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213331733">(Oct 14 2020 at 18:20)</a>:</h4>
<p>and the differences I'm seeing are <em>weird</em>, they look to be associated with allocating. then again, this isn't <code>jemalloc</code> so idk how relevant it is</p>



<a name="213331771"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213331771" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213331771">(Oct 14 2020 at 18:20)</a>:</h4>
<p>oh wait you're not subtracting hardware interrupts yet</p>



<a name="213332136"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213332136" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213332136">(Oct 14 2020 at 18:24)</a>:</h4>
<p>I get somewhere between ±500 and ±5000 for the raw <code>interrupts:u</code> counter, so yeah you might not even be able to tell whether <code>SpecLockMap</code> is disabled</p>



<a name="213332175"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213332175" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213332175">(Oct 14 2020 at 18:24)</a>:</h4>
<p>and the IO noise might be worse for any crate with dependencies</p>



<a name="213333060"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213333060" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213333060">(Oct 14 2020 at 18:33)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> <span class="user-mention" data-user-id="138448">@cuviper</span> <span class="user-mention" data-user-id="239881">@Josh Triplett</span> haha an AMD person replied (though I missed it for almost two weeks) <a href="https://github.com/jlgreathouse/AMD_IBS_Toolkit/issues/5#issuecomment-702828173">https://github.com/jlgreathouse/AMD_IBS_Toolkit/issues/5#issuecomment-702828173</a></p>



<a name="213494037"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213494037" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213494037">(Oct 15 2020 at 22:06)</a>:</h4>
<p>okay I'm done screwing around with the look of this <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50</a></p>



<a name="213502225"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213502225" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213502225">(Oct 15 2020 at 23:52)</a>:</h4>
<p>replaced all of the <code>error!</code>s for reporting with proper <code>Result</code>s (I forget why I didn't do that in the first place, works great)</p>



<a name="213502258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213502258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213502258">(Oct 15 2020 at 23:52)</a>:</h4>
<p>now I can get messages like this from <code>rustc</code> (this one is from running under <code>perf stat</code> which takes up all 6 available perf counters):</p>
<div class="codehilite"><pre><span></span><code>warning: failed to create profiler: perf_event_mmap_page: no allocated hardware register (ran out?)
</code></pre></div>



<a name="213502276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213502276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213502276">(Oct 15 2020 at 23:53)</a>:</h4>
<p>and in that situation it just doesn't profile at all AFAICT, which makes sense</p>



<a name="213502383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213502383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213502383">(Oct 15 2020 at 23:55)</a>:</h4>
<p>(since it requires a separate flag to turn it on, it seems better to not do any automatic fallback to <code>wall-time</code> or w/e)</p>



<a name="213711043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711043">(Oct 18 2020 at 15:20)</a>:</h4>
<p>so the good news is that I was able to rebase all my stuff and have it "just work"</p>



<a name="213711050"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711050" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711050">(Oct 18 2020 at 15:21)</a>:</h4>
<p>the bad news is that I've spent the past couple days bisecting novel sources of variance</p>



<a name="213711207"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711207" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711207">(Oct 18 2020 at 15:24)</a>:</h4>
<p>we've got:</p>
<ol>
<li><a href="https://github.com/rust-lang/rust/issues/75600">#75600</a> "Improve codegen for <code>align_offset</code>" by <span class="user-mention" data-user-id="123586">@nagisa</span> (~±2, seems to have went away since)</li>
<li><a href="https://github.com/rust-lang/rust/issues/75642">#75642</a> "Move doc comment parsing to rustc_lexer" by <span class="user-mention" data-user-id="133169">@matklad</span> (~±100, specifically from <a href="https://github.com/rust-lang/rust/pull/75642/commits/ccbe94bf77e6a32fc9f31425bc820345be3143c0">this commit</a>, I was able to work around it using <code>match_indices</code>)</li>
<li><a href="https://github.com/rust-lang/rust/issues/73905">#73905</a> "Separate projection bounds and predicates" by <span class="user-mention" data-user-id="116118">@Matthew Jasper</span> (~±100, haven't looked deeper into it, and by far the largest PR)</li>
</ol>



<a name="213711292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711292">(Oct 18 2020 at 15:26)</a>:</h4>
<p>I have <em>no idea</em> where the variance is actually coming from. for the second PR, <code>memchr</code> is involved but it should be used before that PR, after that PR, and by my version, but the version that PR introduces (i.e. <code>contains</code>) is the only one that has any variance</p>



<a name="213711301"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711301" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711301">(Oct 18 2020 at 15:27)</a>:</h4>
<p>and I dread trying to minimize it in the third PR</p>



<a name="213711314"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711314" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711314">(Oct 18 2020 at 15:27)</a>:</h4>
<p>I doubt it's IO/syscall-related in any of the 3 cases, it must be something weirder than that</p>



<a name="213711359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711359">(Oct 18 2020 at 15:28)</a>:</h4>
<p>Does <code>contains</code> work differently depending on the alignment? ie. to process multiple chars at once</p>



<a name="213711363"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711363" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711363">(Oct 18 2020 at 15:28)</a>:</h4>
<p>thing is, ASLR is already off and nothing else actually varies</p>



<a name="213711368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711368">(Oct 18 2020 at 15:28)</a>:</h4>
<p>the moment addresses are different, you instantly get ±1million in the total</p>



<a name="213711370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711370">(Oct 18 2020 at 15:28)</a>:</h4>
<p>we've seen this happen with <code>pid.to_string()</code></p>



<a name="213711389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711389">(Oct 18 2020 at 15:29)</a>:</h4>
<p>and <code>contains</code> should be using <code>memchr</code> just like <code>find</code> and <code>match_indices</code>, so it's probably down to how LLVM optimizes our version of <code>memchr</code> in each case</p>



<a name="213711448"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711448" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711448">(Oct 18 2020 at 15:30)</a>:</h4>
<p>anyway I'm not worried about that for now, since I was able to get rid of the variance, the elephant in the room is the trait system PR</p>



<a name="213711464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711464">(Oct 18 2020 at 15:30)</a>:</h4>
<p>which I don't even think I can split into smaller parts because I can see some "fix rebase" commits</p>



<a name="213711528"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711528" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711528">(Oct 18 2020 at 15:32)</a>:</h4>
<p>this is the only blocker for upstreaming, and frankly given this unexpected development, we should probably track the numbers I've been staring at, on <code>perf.rust-lang.org</code></p>



<a name="213711560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711560">(Oct 18 2020 at 15:33)</a>:</h4>
<p>though I don't know if the problem shows up on a smaller crate, compared to libcore itself. I just think we should have 5-10 runs or more of one crate and try to keep them produce at most 2-3 different values (off by 9 or w/e is the <code>write_all</code> iteration unit)</p>



<a name="213711736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213711736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213711736">(Oct 18 2020 at 15:37)</a>:</h4>
<p>at this point I've done 29 builds to find all 3 PRs and who knows if there aren't more, I can't exactly revert <a href="https://github.com/rust-lang/rust/issues/73905">#73905</a> to check</p>



<a name="213716364"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213716364" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213716364">(Oct 18 2020 at 17:27)</a>:</h4>
<p>oh I wonder if <code>getrandom</code> ever gets called</p>



<a name="213716613"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213716613" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213716613">(Oct 18 2020 at 17:33)</a>:</h4>
<p>feel free to look at <a href="https://github.com/rust-lang/rust/pull/75728">https://github.com/rust-lang/rust/pull/75728</a> which has a chance to improve or make things worse ^^</p>



<a name="213716635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213716635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213716635">(Oct 18 2020 at 17:33)</a>:</h4>
<p>oh, interesting. <em>ideally</em> it shouldn't affect things, but once I'm done with everything else I can try applying it locally</p>



<a name="213717162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717162">(Oct 18 2020 at 17:47)</a>:</h4>
<p>nope, no <code>getrandom</code> syscalls. I guess if I'm playing with <code>strace</code> I might as well grab a few outputs and diff them</p>



<a name="213717229"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717229" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717229">(Oct 18 2020 at 17:49)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Is this single-threaded code?</p>



<a name="213717235"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717235" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717235">(Oct 18 2020 at 17:49)</a>:</h4>
<p>Nothing else running on the system at the same time?</p>



<a name="213717295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717295">(Oct 18 2020 at 17:50)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> it's reliable before <a href="https://github.com/rust-lang/rust/issues/73905">#73905</a> and not after, there is something in that PR which leads into a codepath that runs a different number of instructions</p>



<a name="213717310"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717310" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717310">(Oct 18 2020 at 17:50)</a>:</h4>
<p>furthermore, it's isolated to the trait system (which I can see with <code>summarize aggregate</code>)</p>



<a name="213717317"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717317" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717317">(Oct 18 2020 at 17:51)</a>:</h4>
<p>128 instructions difference in <code>evaluate_obligation</code>, for example</p>



<a name="213717383"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717383" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717383">(Oct 18 2020 at 17:53)</a>:</h4>
<p><a href="/user_uploads/4715/ti7EJcALzg922Mwhm_9SiBtN/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/ti7EJcALzg922Mwhm_9SiBtN/image.png" title="image.png"><img src="/user_uploads/4715/ti7EJcALzg922Mwhm_9SiBtN/image.png"></a></div>



<a name="213717392"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717392" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717392">(Oct 18 2020 at 17:53)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> this is what I'm staring at (ignore the first entry in each set of 10, that's an unrelated effect I haven't dug into yet, possible some IO since it's the first run after a whole <code>rustc</code> build)</p>



<a name="213717400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717400">(Oct 18 2020 at 17:53)</a>:</h4>
<p>the selected one is the <a href="https://github.com/rust-lang/rust/issues/73905">#73905</a> merge commit</p>



<a name="213717453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717453">(Oct 18 2020 at 17:54)</a>:</h4>
<p>Presumably you encountered a lot of issues like this whilst getting to this point: have all previous sources of non-determinism come from system-calls/IO? Or are there other ways non-determinism can get into the program?</p>



<a name="213717470"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717470" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717470">(Oct 18 2020 at 17:55)</a>:</h4>
<p>there's one main source I'm aware of, that's likely <code>write_all</code> taking 1 (or very rarely 2) more iterations</p>



<a name="213717473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717473">(Oct 18 2020 at 17:55)</a>:</h4>
<p>because this is writing a file (<code>libcore.rmeta</code>)</p>



<a name="213717525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717525">(Oct 18 2020 at 17:56)</a>:</h4>
<p>there's been ASLR (including <code>log10(pid)</code> behaving like a source of entropy) and <code>SpecLockMap</code>, both are disabled rn</p>



<a name="213717526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717526">(Oct 18 2020 at 17:56)</a>:</h4>
<p>I'm frankly <em>astonished</em> that you can get determinism across a kernel/user boundary.</p>



<a name="213717529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717529">(Oct 18 2020 at 17:56)</a>:</h4>
<p>But you didn't answer my earlier question. Single-threaded code, nothing else running on the system?</p>



<a name="213717542"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717542" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717542">(Oct 18 2020 at 17:57)</a>:</h4>
<p>the entire measurement is on a single thread AFAIK (<code>rustc</code> usually has two threads but the main thread shouldn't be used for anything, we have the split for extra stack space and some TLS shenanigans)</p>



<a name="213717589"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717589" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717589">(Oct 18 2020 at 17:58)</a>:</h4>
<p>the very strong correlation between the compiler builds and the results tells me the rest of the system doesn't matter, or I somehow got lucky every time</p>



<a name="213717603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717603">(Oct 18 2020 at 17:58)</a>:</h4>
<p>the microbenchmarks that I was using a few weeks ago, never showed any deviation on this server, from the expected exact count (once hardware interrupts were subtracted)</p>



<a name="213717614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717614">(Oct 18 2020 at 17:59)</a>:</h4>
<p>compared to my Ivy Bridge laptop (and other Intel machines I guess) where it undercounts a lot</p>



<a name="213717627"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717627" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717627">(Oct 18 2020 at 17:59)</a>:</h4>
<p>sadly there is a possibility <a href="http://perf.rust-lang.org">perf.rust-lang.org</a> may never have results this good, but we should try to reproduce them there</p>



<a name="213717708"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717708" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717708">(Oct 18 2020 at 18:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/213717526">said</a>:</p>
<blockquote>
<p>I'm frankly <em>astonished</em> that you can get determinism across a kernel/user boundary.</p>
</blockquote>
<p>not sure what you mean about this. IO is still a consideration, and results in e.g. those extra 9 instructions in some totals</p>



<a name="213717713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717713">(Oct 18 2020 at 18:01)</a>:</h4>
<p>but this is <em>userspace</em> instructions, varying due to a different syscall result</p>



<a name="213717766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717766">(Oct 18 2020 at 18:02)</a>:</h4>
<p>I am not counting kernel instructions, nor can I on this server, as I have no root access<br>
(ignoring the <code>iret</code>s that are IMO a design mistake in PMUs)</p>



<a name="213717858"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717858" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717858">(Oct 18 2020 at 18:04)</a>:</h4>
<p>frankly, if the <code>iret</code>s weren't "broken", several things would be improved</p>



<a name="213717891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717891">(Oct 18 2020 at 18:05)</a>:</h4>
<p>there's no data on the server to suggest hyperthreads matter. it's possible my processes are <code>nice</code>'d to a point where it doesn't</p>



<a name="213717933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717933">(Oct 18 2020 at 18:06)</a>:</h4>
<p>it's definitely all over the place on more consumer hardware :P</p>



<a name="213717940"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717940" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717940">(Oct 18 2020 at 18:06)</a>:</h4>
<p>Even if you're not counting kernel instructions, there are definitely cases where the kernel gives non-determinstic results for one process based on what's going on with other processes.</p>



<a name="213717947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717947">(Oct 18 2020 at 18:07)</a>:</h4>
<p>and apparently the reason Intel redacted certain perf counters out of their manuals has to do with hyperthreads so I would definitely not trust hyperthreads to be correct on Intel CPUs</p>



<a name="213717952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717952">(Oct 18 2020 at 18:07)</a>:</h4>
<p>I doubt it's just Intel there.</p>



<a name="213717962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717962">(Oct 18 2020 at 18:07)</a>:</h4>
<p>/me wonders if it's possible you're ever hitting EINTR or ERESTARTSYS.</p>



<a name="213717969"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213717969" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213717969">(Oct 18 2020 at 18:08)</a>:</h4>
<p>I mean that's what I assume the 9 instructions are from, <code>write_all</code> looping around once more</p>



<a name="213718007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718007">(Oct 18 2020 at 18:08)</a>:</h4>
<p>(You'd see EINTR in an strace, but I don't remember if strace can handle ERESTARTSYS.)</p>



<a name="213718011"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718011" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718011">(Oct 18 2020 at 18:08)</a>:</h4>
<p>I never bothered tracking it down because of how reliable it is</p>



<a name="213718015"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718015" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718015">(Oct 18 2020 at 18:08)</a>:</h4>
<p>i.e. I just get two possible totals, that are 9 instructions apart. that's fine</p>



<a name="213718017"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718017" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718017">(Oct 18 2020 at 18:08)</a>:</h4>
<p>you could always try disabling SMT right? In case it made a difference</p>



<a name="213718020"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718020" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718020">(Oct 18 2020 at 18:08)</a>:</h4>
<p>I'm not sure I'm making myself clear enough :P</p>



<a name="213718036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718036">(Oct 18 2020 at 18:09)</a>:</h4>
<p>there's code in 3 PRs which triggers something that doesn't show up before each of them</p>



<a name="213718047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718047">(Oct 18 2020 at 18:09)</a>:</h4>
<p>and this is repeatable even if I go back and forth</p>



<a name="213718087"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718087" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718087">(Oct 18 2020 at 18:10)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> You're clear. What I'm trying to narrow down is the degree to which we need to worry about those PRs triggering some non-determinism that was already possible before and just didn't tend to happen.</p>



<a name="213718116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718116">(Oct 18 2020 at 18:11)</a>:</h4>
<p><em>shrug</em> I'm mostly complaining that I have to dig into it</p>



<a name="213718120"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718120" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718120">(Oct 18 2020 at 18:11)</a>:</h4>
<p>/me stares at it a bit himself.</p>



<a name="213718126"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718126" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718126">(Oct 18 2020 at 18:11)</a>:</h4>
<p>in a way, all of these things are going to be like that</p>



<a name="213718130"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718130" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718130">(Oct 18 2020 at 18:11)</a>:</h4>
<p>/me is not getting sucked down this particular rabbit hole, but is up for staring a bit. :)</p>



<a name="213718179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718179">(Oct 18 2020 at 18:12)</a>:</h4>
<p>for example, both <code>contains</code> and <code>find</code>/<code>match_indices</code> call into our implementation of <code>memchr</code></p>



<a name="213718180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718180">(Oct 18 2020 at 18:12)</a>:</h4>
<p>(this is from the second PR in my list of 3)</p>



<a name="213718182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718182">(Oct 18 2020 at 18:12)</a>:</h4>
<p>but only <code>contains</code> causes anything weird</p>



<a name="213718190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718190">(Oct 18 2020 at 18:13)</a>:</h4>
<p>it's possible LLVM optimizes it to some SIMD instruction that has broken PMU support</p>



<a name="213718198"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718198" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718198">(Oct 18 2020 at 18:13)</a>:</h4>
<p>and which just doesn't happen to be used anywhere else</p>



<a name="213718258"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718258" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718258">(Oct 18 2020 at 18:14)</a>:</h4>
<p>yeah, although it seems like a big coincidence that a problematic use of SIMD would suddenly be introduced now, having not existed anywhere in the compiler prior. Unless it's an issue that only occurs rarely and so requires a particularly hot code path or something...</p>



<a name="213718260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718260">(Oct 18 2020 at 18:14)</a>:</h4>
<p>AFAICT since <code>SpecLockMap</code> was disabled, I haven't seen anything weird for consecutive executions, just the 9 instructions difference</p>



<a name="213718264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718264">(Oct 18 2020 at 18:14)</a>:</h4>
<p>and I've stared at dozens of runs already</p>



<a name="213718718"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213718718" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213718718">(Oct 18 2020 at 18:26)</a>:</h4>
<p>oh right there is <code>getrandom</code>, I just forgot to pass <code>-f</code> to <code>strace</code>. shouldn't matter though, it's just used for the name of a temp dir</p>



<a name="213719365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213719365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213719365">(Oct 18 2020 at 18:44)</a>:</h4>
<p>the only obvious difference I can see is <code>lseek(2, 0, SEEK_CUR)</code> because I was piping stderr into a file, but that's just under <code>strace</code></p>



<a name="213719896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213719896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213719896">(Oct 18 2020 at 18:56)</a>:</h4>
<p>oh ughh wasted some time because I didn't realize I was on the merge commit just before the noisy one (i.e. I didn't rebuild after finishing bisecting), so ofc the results weren't showing anything weird</p>



<a name="213721823"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213721823" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213721823">(Oct 18 2020 at 19:39)</a>:</h4>
<p>oh maybe the 9 instructions aren't from <code>write_all</code> but rather than the temporary directory it creates, since it has to take the raw <code>getrandom</code> output and produce <code>[a-zA-Z0-9}{6}</code> from it. very boring (and not what I'm after) but maybe I can also remove the variance from that entirely</p>



<a name="213734805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213734805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213734805">(Oct 19 2020 at 01:05)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/pull/73905/files#diff-34d5893dd95fe09f9a0fd3341efacd1c21853bb34ba29d9d79bb9af26bb8a0a0R1170">https://github.com/rust-lang/rust/pull/73905/files#diff-34d5893dd95fe09f9a0fd3341efacd1c21853bb34ba29d9d79bb9af26bb8a0a0R1170</a></p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-    ) -&gt; bool {</span>
<span class="gi">+    ) -&gt; smallvec::SmallVec&lt;[usize; 2]&gt; {</span>
</code></pre></div>



<a name="213734810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213734810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213734810">(Oct 19 2020 at 01:05)</a>:</h4>
<p>so I just had a hunch and changed that to <code>Vec&lt;usize&gt;</code> and it seems less noisy</p>



<a name="213735028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213735028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213735028">(Oct 19 2020 at 01:11)</a>:</h4>
<p>with <code>SmallVec&lt;[usize; 2]&gt;</code>:</p>
<div class="codehilite"><pre><span></span><code>  ±64 instructions: `evaluate_obligation()`
</code></pre></div>


<p>with <code>Vec&lt;usize&gt;</code>:</p>
<div class="codehilite"><pre><span></span><code>  ±6.5 instructions: `evaluate_obligation()`
  ±10 instructions: `evaluate_obligation()`
</code></pre></div>



<a name="213735619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213735619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213735619">(Oct 19 2020 at 01:29)</a>:</h4>
<p>though that's not the best metric, it looks like it's almost 3 times better in the total. <code>SmallVec&lt;[usize; 4]&gt;</code> is in between. curious what <code>SmallVec&lt;[usize; 1]&gt;</code> does</p>



<a name="213736593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213736593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213736593">(Oct 19 2020 at 01:53)</a>:</h4>
<p><code>SmallVec&lt;[usize; 1]&gt;</code> seems to be on par with <code>SmallVec&lt;[usize; 2]&gt;</code>, or worse, so I'm guessing the problem is perhaps in the code that upgrades a <code>SmallVec</code> from inline to using the heap?</p>



<a name="213777402"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213777402" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213777402">(Oct 19 2020 at 12:29)</a>:</h4>
<p>heh, I just realized I can use <code>-Zself-profile-events=default,query-keys</code> to <em>see</em> which invocations exactly are adding noise (and then trace through the code)</p>



<a name="213780089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780089">(Oct 19 2020 at 12:53)</a>:</h4>
<p><a href="/user_uploads/4715/MIwcxFmE9YyOntvh7RXGh8FZ/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/MIwcxFmE9YyOntvh7RXGh8FZ/image.png" title="image.png"><img src="/user_uploads/4715/MIwcxFmE9YyOntvh7RXGh8FZ/image.png"></a></div>



<a name="213780151"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780151" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780151">(Oct 19 2020 at 12:54)</a>:</h4>
<p>fun for the whole family</p>



<a name="213780520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780520">(Oct 19 2020 at 12:57)</a>:</h4>
<p>OOI, do you rebuild between runs, or is it the same binary each time?</p>



<a name="213780576"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780576" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780576">(Oct 19 2020 at 12:57)</a>:</h4>
<p>the variance is measured across the self-profile outputs of identical <code>rustc</code> commands with nothing else running in between</p>



<a name="213780647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780647">(Oct 19 2020 at 12:58)</a>:</h4>
<p>lemme grab what it's supposed to look like</p>



<a name="213780791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780791">(Oct 19 2020 at 12:59)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggory Blake</span> like, the frustrating thing is that I was able to get very reliable results before I rebased</p>



<a name="213780803"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780803" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780803">(Oct 19 2020 at 12:59)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Largest 3 variances:
  ±0 instructions: 1851868 occurrences, or 99.98%
  ±0.5 instructions: 400 occurrences, or 0.02%
  ±4.5 instructions: `write_crate_metadata()`
</code></pre></div>



<a name="213780822"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780822" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780822">(Oct 19 2020 at 12:59)</a>:</h4>
<p>some variation from this is what I would basically see every time</p>



<a name="213780967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780967">(Oct 19 2020 at 13:00)</a>:</h4>
<p>the ±0.5 stuff I think I have no way of removing, but also it doesn't show up in the totals (AFAICT it's because I have to read two counters and if an interrupt comes in between, it will subtract 1 from one interval and add 1 to another)</p>



<a name="213780987"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213780987" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213780987">(Oct 19 2020 at 13:01)</a>:</h4>
<p>You mentioned that addresses changing would have a much bigger effect - but it it possible that there's one allocation whose size differs slightly between runs that is having a knock-on affect on a small number of later allocations?</p>



<a name="213781093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213781093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213781093">(Oct 19 2020 at 13:01)</a>:</h4>
<p>the ±4.5 I used to think it's <code>write_all</code> but now I'm thinking it's the <code>getrandom</code> for the tempdir (it's very late in the compilation so it couldn't affect the trait system anyway)</p>



<a name="213781161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213781161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213781161">(Oct 19 2020 at 13:02)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggory Blake</span> if there's a difference it doesn't show up in <code>mmap</code> syscalls</p>



<a name="213781206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213781206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213781206">(Oct 19 2020 at 13:02)</a>:</h4>
<p>but that is a good point, I wonder if I can reliably trace <code>malloc</code></p>



<a name="213781259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213781259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213781259">(Oct 19 2020 at 13:02)</a>:</h4>
<p>right, I was thinking of a small allocation, eg. allocating 3 bytes instead of 4 where the alignment requirements mean that the impact is very limited</p>



<a name="213781324"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213781324" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213781324">(Oct 19 2020 at 13:03)</a>:</h4>
<p>yeah that's a great point, gonna grab <code>ltrace</code> and try with that</p>



<a name="213781729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213781729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213781729">(Oct 19 2020 at 13:06)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggory Blake</span> then again there's this whole thing, I wonder what size classes that was touching, because that one was really visible in the total instructions (since it behaved like having ASLR enabled) <a href="https://twitter.com/eddyb_r/status/1294745328739127296">https://twitter.com/eddyb_r/status/1294745328739127296</a></p>
<div class="inline-preview-twitter"><div class="twitter-tweet"><a href="https://twitter.com/eddyb_r/status/1294745328739127296"><img class="twitter-avatar" src="https://pbs.twimg.com/profile_images/1291545948322226178/trAmIAt9_normal.jpg"></a><p>expectation: disable ASLR, get deterministic pointer hashing

reality: entropy vacuum that will be filled by anything, even something as insignificant as *checks notes* log₁₀(pid)?? <a href="https://t.co/4jwCe5snWM">https://twitter.com/eddyb_r/status/1294745328739127296/photo/1</a></p><span>- 🇪dith 🅱️inch (@eddyb_r)</span><div class="twitter-image"><a href="https://t.co/4jwCe5snWM"><img src="https://pbs.twimg.com/media/EffbA0sX0AAqfJG.jpg:thumb"></a></div></div></div>



<a name="213781790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213781790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213781790">(Oct 19 2020 at 13:07)</a>:</h4>
<p>maybe in that case the only reason it cascaded like that is because it was fed into a larger allocation (it was building up a file path)</p>



<a name="213781919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213781919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213781919">(Oct 19 2020 at 13:08)</a>:</h4>
<p>Yeah I have no idea, I'm just throwing ideas out there :P</p>



<a name="213781977"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213781977" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213781977">(Oct 19 2020 at 13:08)</a>:</h4>
<p>no it's a great idea, usually with the big stuff it shows up in <code>strace</code> output but if it doesn't need to grow the size class that would make sense</p>



<a name="213815865"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213815865" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213815865">(Oct 19 2020 at 17:04)</a>:</h4>
<p>Another crazy idea: you could try dumping the process memory at various points, and bisect the issue that way</p>



<a name="213815930"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213815930" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213815930">(Oct 19 2020 at 17:04)</a>:</h4>
<p>since dumps from separate runs should be identical AIUI</p>



<a name="213820053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213820053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213820053">(Oct 19 2020 at 17:38)</a>:</h4>
<p>Another idea is running the whole thing under an application-level simulator (e.g. qemu).<br>
It gives maximum tracing/debugging capabilities, and if the variance comes from OS then app-level simulator should in theory still reproduce it.</p>
<p>I'm not sure how is reading of perf counters implemented in app-level qemu, they will likely include the simulator instructions as well.<br>
I'm also not sure the simulator itself doesn't use some randomized hash tables or something else introducing variance, this needs checking.</p>



<a name="213820267"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213820267" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213820267">(Oct 19 2020 at 17:40)</a>:</h4>
<p>Also, wouldn't it be more useful to ship the thing into production first and <em>then</em> hunt for these variances that are already vanishingly small? <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="213820430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213820430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213820430">(Oct 19 2020 at 17:41)</a>:</h4>
<p><span class="user-mention" data-user-id="123856">@Vadim Petrochenkov</span> the problem is I already had it perfect</p>



<a name="213820439"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213820439" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213820439">(Oct 19 2020 at 17:41)</a>:</h4>
<p>and then I rebased :(</p>



<a name="213820479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213820479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213820479">(Oct 19 2020 at 17:42)</a>:</h4>
<p>and now the data I collected before rebasing looks like lies</p>



<a name="213847892"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213847892" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213847892">(Oct 19 2020 at 21:21)</a>:</h4>
<p>huh managed to use <code>ltrace</code> with <code>rustc</code>, I guess there's maybe just too many functions?</p>



<a name="213847904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213847904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213847904">(Oct 19 2020 at 21:21)</a>:</h4>
<p>I had to add <code>-l libc.so.6</code> (<code>-e malloc</code> also works)</p>



<a name="213851501"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213851501" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213851501">(Oct 19 2020 at 21:56)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggory Blake</span> so previously, and even now before I found what flags to pass, <code>ltrace -f ./.../rustc</code> wouldn't show anything (well, other than threads exiting) while <code>ltrace echo</code> worked just fine</p>



<a name="213852709"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213852709" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213852709">(Oct 19 2020 at 22:09)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so this is unlikely to be in the initial implementation (unless necessary to remove some noise, but based on what I'm reading, it shouldn't be relevant), but it looks like we can handle per-thread instruction counting</p>



<a name="213852769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213852769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213852769">(Oct 19 2020 at 22:10)</a>:</h4>
<p>it will require more refactoring on the <code>rustc</code> side, because each thread will need its own counter</p>



<a name="213852784"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213852784" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213852784">(Oct 19 2020 at 22:10)</a>:</h4>
<p>(as opposed to just sharing a handle to one profiler)</p>



<a name="213852994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213852994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213852994">(Oct 19 2020 at 22:12)</a>:</h4>
<p>I missed the "thread" in "measures the calling process/thread" - so what I'm doing only applies to the "main" (well, second)<code>rustc</code> thread, meaning we can't just switch to this for <code>perf.rust-lang.org</code> right away (though it would be nice to start collecting <em>some</em> data. maybe only for <code>-check</code> runs?)</p>



<a name="213853078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213853078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213853078">(Oct 19 2020 at 22:13)</a>:</h4>
<p>there's some "inherit" functionality but I'm not sure how much I trust it to do something useful for us</p>



<a name="213853273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213853273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213853273">(Oct 19 2020 at 22:15)</a>:</h4>
<p>heh, for "check" runs I can confirm that they are recording <code>measureme</code> events from only one thread because my <code>summarize aggregate</code> refuses to work if that isn't the case</p>



<a name="213853523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213853523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213853523">(Oct 19 2020 at 22:18)</a>:</h4>
<p>heh <code>-l '*'</code> works just fine, why is that not the default?</p>



<a name="213854500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213854500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213854500">(Oct 19 2020 at 22:29)</a>:</h4>
<p>by "works just fine" I mean it's taking forever, this better be worth it</p>



<a name="213854575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213854575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213854575">(Oct 19 2020 at 22:30)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggory Blake</span> FWIW for <code>-l libc.so.6</code> I couldn't see any differences :/</p>



<a name="213854628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213854628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213854628">(Oct 19 2020 at 22:30)</a>:</h4>
<p>hence trying with <code>-l '*'</code> now</p>



<a name="213861177"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861177" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861177">(Oct 19 2020 at 23:56)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> <span class="user-mention" data-user-id="137027">@Jannis Harder</span> I'm pretty sure I found a pagefault (or related) undocumented counter on Zen: <code>perf stat -e r0420:u,page-faults:u</code> seems to show slightly higher <code>r0420:u</code> than <code>page-faults:u</code> (which is a "software" event, i.e. the kernel tracks only what it wants to), no matter where I stop the process</p>



<a name="213861239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861239">(Oct 19 2020 at 23:57)</a>:</h4>
<p>that event number... are you trolling?</p>



<a name="213861319"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861319" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861319">(Oct 19 2020 at 23:58)</a>:</h4>
<p>no! I literally tried <code>rffXX:u</code> for a bunch of undocumented values of XX and then replaced <code>ff</code> with individual bits to find the supported "mask bits"</p>



<a name="213861352"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861352" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861352">(Oct 19 2020 at 23:58)</a>:</h4>
<p>and this is the only one even close to the magnitude of <code>page-faults:u</code>, out of the ones I've tried</p>



<a name="213861462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861462">(Oct 20 2020 at 00:00)</a>:</h4>
<p>I wonder if it's exactly that, or something correlated like ring transitions</p>



<a name="213861467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861467">(Oct 20 2020 at 00:00)</a>:</h4>
<p>So... when your memory usage is too high, you'll get a lot of 420s</p>



<a name="213861515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861515">(Oct 20 2020 at 00:00)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> hmm good point, that would actually be perfect for subtracting <code>iret</code>s :D</p>



<a name="213861525"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861525" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861525">(Oct 20 2020 at 00:00)</a>:</h4>
<p>better than "hardware interrupts"</p>



<a name="213861722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861722">(Oct 20 2020 at 00:03)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> ding ding ding! I got lucky with 40k instead of the usual 18k hardware interrupts and <code>r0420</code> also went up</p>



<a name="213861881"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213861881" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213861881">(Oct 20 2020 at 00:05)</a>:</h4>
<p>that is, I think I've got an outlier result that confirms <code>r0420:u</code> includes <code>r002c:u</code> (interrupts taken). maybe it's <code>iret</code>s because that would be amazing, I've been using "interrupts taken" as a proxy for a subset of the <code>iret</code>s</p>



<a name="213862271"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213862271" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213862271">(Oct 20 2020 at 00:10)</a>:</h4>
<p>I'm trying to think what else would be correlated, that makes sense to have some counter.</p>



<a name="213862286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213862286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213862286">(Oct 20 2020 at 00:11)</a>:</h4>
<p>like PTI, but I think that mitigation is only used on Intel</p>



<a name="213862307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213862307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213862307">(Oct 20 2020 at 00:11)</a>:</h4>
<p><code>r0420:u = r002c:u + page-faults:u + x</code> where <code>x</code> is <code>5</code> for a full execution of this <code>rustc</code> invocation but <code>1</code> if I stop it mid-way</p>



<a name="213864746"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213864746" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213864746">(Oct 20 2020 at 00:47)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> I want to test if subtracting <code>r0420:u</code> instead of <code>r002c:u</code> from <code>instructions:u</code> produces more reliable results, but I have <code>ltrace -l '*'</code> that's been running for over 2h now and I think I want to go to sleep and hope that it finishes <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="213864838"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213864838" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213864838">(Oct 20 2020 at 00:48)</a>:</h4>
<p>could always review a few rust-lang/rust PRs to pass the time :P</p>



<a name="213929676"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213929676" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213929676">(Oct 20 2020 at 14:45)</a>:</h4>
<p><code>ltrace -l '*'</code> didn't finish and it's already up at 13GB of output</p>



<a name="213929827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213929827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213929827">(Oct 20 2020 at 14:46)</a>:</h4>
<p>oh and it just died because the SSH connection randomly decided to end</p>



<a name="213930224"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213930224" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213930224">(Oct 20 2020 at 14:49)</a>:</h4>
<p>it's okay, I went to it to stop it anyway, guess it didn't want to let me</p>



<a name="213930436"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213930436" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213930436">(Oct 20 2020 at 14:51)</a>:</h4>
<p>oh no did it disconnect because it finished and decided to actually print something, lol</p>



<a name="213930685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213930685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213930685">(Oct 20 2020 at 14:52)</a>:</h4>
<p>I guess even if that was the case, you'd have to do another whole run to compare? maybe not worth it</p>



<a name="213930896"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213930896" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213930896">(Oct 20 2020 at 14:54)</a>:</h4>
<p>so yeah it finished and took 16h30m to do so</p>



<a name="213932044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213932044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213932044">(Oct 20 2020 at 15:02)</a>:</h4>
<p>oh well, if I want to do a second run, I've made copies of <code>rustc</code>, <code>librustc_driver-*.so</code> and <code>libstd-*.so</code>, so that I can just put them back to go back to that point, and do something else in the meanwhile <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="213934163"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213934163" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213934163">(Oct 20 2020 at 15:15)</a>:</h4>
<p>hmm subtracting the 420 counter removed the extra ~230 instructions from the first run after building a new <code>rustc</code>, so maybe those <em>were</em> page faults? I guess I never got to check with <code>perf stat -e page-faults:u</code></p>



<a name="213938396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938396">(Oct 20 2020 at 15:47)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> if you have the time, could you run this a few times (including Ctrl+C-ing halfway through) on Zen 2?<br>
<code>setarch -R perf stat -e r0420:u,r002c:u,page-faults:u ~/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/rustc --edition=2018 --crate-type=lib --crate-name=core --emit=metadata ~/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/lib/rustlib/src/rust/library/core/src/lib.rs</code></p>



<a name="213938438"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938438" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938438">(Oct 20 2020 at 15:47)</a>:</h4>
<p>hm what do you mean ctrl+cing halfway through?</p>



<a name="213938449"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938449" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938449">(Oct 20 2020 at 15:47)</a>:</h4>
<p>just killing it</p>



<a name="213938474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938474">(Oct 20 2020 at 15:47)</a>:</h4>
<p>there is a relationship that should remain no matter where you stop it</p>



<a name="213938600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938600">(Oct 20 2020 at 15:48)</a>:</h4>
<p>what we're looking for is <code>r0420:u</code> being the sum of the other two counters, plus a very small extra count</p>



<a name="213938673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938673">(Oct 20 2020 at 15:49)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> it doesn't even matter what you're compiling, really, or whether it's <code>rustc</code> at all, just needs to do enough varied work to be conclusive</p>



<a name="213938724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938724">(Oct 20 2020 at 15:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/213862307">said</a>:</p>
<blockquote>
<p><code>r0420:u = r002c:u + page-faults:u + x</code> where <code>x</code> is <code>5</code> for a full execution of this <code>rustc</code> invocation but <code>1</code> if I stop it mid-way</p>
</blockquote>
<p>^^ this is what I see on Zen 1</p>



<a name="213938738"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938738" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938738">(Oct 20 2020 at 15:49)</a>:</h4>
<p><a href="https://gist.github.com/Mark-Simulacrum/954400111cc9cbadcc0121a02e1da40e">https://gist.github.com/Mark-Simulacrum/954400111cc9cbadcc0121a02e1da40e</a></p>



<a name="213938809"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938809" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938809">(Oct 20 2020 at 15:50)</a>:</h4>
<p>nice, that first one is doable with the naked eye :P</p>



<a name="213938833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938833">(Oct 20 2020 at 15:50)</a>:</h4>
<p>I don't even have to do the math, it's working :D</p>



<a name="213938961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938961">(Oct 20 2020 at 15:51)</a>:</h4>
<p>but <code>x</code> is 2 <span aria-label="surprise" class="emoji emoji-1f62e" role="img" title="surprise">:surprise:</span></p>



<a name="213938990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213938990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213938990">(Oct 20 2020 at 15:52)</a>:</h4>
<p>it's just some count. I have no idea of what</p>



<a name="213939140"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939140" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939140">(Oct 20 2020 at 15:52)</a>:</h4>
<p>I wouldn't be surprised if it e.g. varies with kernel version. but it also doesn't matter</p>



<a name="213939171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939171">(Oct 20 2020 at 15:53)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so this counter is even more reliable than the documented "interrupts taken" (<code>r002c:u</code>), it removed one oddity I hadn't investigated (but was starting to suspect was related to pagefaults or something similar)</p>



<a name="213939227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939227">(Oct 20 2020 at 15:53)</a>:</h4>
<p>That was from 3950x, I have a 3600x to test on if you'd like with a more recent kernel fwiw</p>



<a name="213939240"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939240" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939240">(Oct 20 2020 at 15:53)</a>:</h4>
<p>so yeah uhh great I've <em>already</em> obsoleted my "IRQs" naming choice <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="213939264"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939264" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939264">(Oct 20 2020 at 15:53)</a>:</h4>
<p>5.4.0-42-generic on 3950x, 5.8.0-21-generic on my 3600x</p>



<a name="213939369"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939369" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939369">(Oct 20 2020 at 15:54)</a>:</h4>
<p>it doesn't really matter, but feel free to if you're not doing anything else. at the end of the day, I trust the hardware to be reporting a useful value no matter what the kernel is doing</p>



<a name="213939370"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939370" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939370">(Oct 20 2020 at 15:54)</a>:</h4>
<p>I can also test on the perf collector 3600x which has a 4.15.0-70-generic</p>



<a name="213939396"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939396" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939396">(Oct 20 2020 at 15:54)</a>:</h4>
<p>ok, yeah, then I'll move on to my next task :)</p>



<a name="213939408"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939408" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939408">(Oct 20 2020 at 15:54)</a>:</h4>
<p>ah the perf collector would be better just in case that kernel does anything very weird</p>



<a name="213939443"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939443" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939443">(Oct 20 2020 at 15:54)</a>:</h4>
<p>but I doubt the hardware itself varies</p>



<a name="213939628"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939628" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939628">(Oct 20 2020 at 15:56)</a>:</h4>
<p>counts seem way higher fwiw</p>



<a name="213939657"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939657" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939657">(Oct 20 2020 at 15:56)</a>:</h4>
<p><a href="https://gist.github.com/Mark-Simulacrum/e34a16bd675ec4746149b9bdc6ce0319">https://gist.github.com/Mark-Simulacrum/e34a16bd675ec4746149b9bdc6ce0319</a></p>



<a name="213939662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939662">(Oct 20 2020 at 15:56)</a>:</h4>
<p>it is going to vary with the nightly version too</p>



<a name="213939681"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939681" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939681">(Oct 20 2020 at 15:56)</a>:</h4>
<p>oh, that was a different nightly, for sure</p>



<a name="213939731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939731">(Oct 20 2020 at 15:57)</a>:</h4>
<p>this one behaves like the machine I tested on heh</p>



<a name="213939766"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939766" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939766">(Oct 20 2020 at 15:57)</a>:</h4>
<p>or the rustc version. whichever affects it more</p>



<a name="213939833"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939833" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939833">(Oct 20 2020 at 15:57)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> thanks a lot, I'll try to see how to integrate it!</p>



<a name="213939932"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213939932" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213939932">(Oct 20 2020 at 15:58)</a>:</h4>
<p>kind of mad that I didn't go looking for an undocumented "all interrupts" or "all <code>iret</code>s" or w/e it is, earlier</p>



<a name="213940959"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213940959" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213940959">(Oct 20 2020 at 16:04)</a>:</h4>
<p>recap:<br>
good news: found a counter that works on both Zen 1 and Zen 2, and which removes the ~230 extra instructions from "initial runs"<br>
bad news: it's undocumented, I already decided to call the documented one "IRQs" (whereas this one includes "exceptions" like page faults, and may even be all <code>iret</code>s or something), no idea if there's an equivalent on Intel or older AMD, <em>and</em> it doesn't solve the noise I'm seeing introduced by the big trait system PR (which was my main concern)</p>



<a name="213942962"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213942962" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213942962">(Oct 20 2020 at 16:18)</a>:</h4>
<p>I notice that PR adds some calls to <code>ensure_sufficient_stack</code> - do you think segmented stacks could cause weirdness?</p>



<a name="213943566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213943566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213943566">(Oct 20 2020 at 16:23)</a>:</h4>
<p>hmm, given that page faults are very reliable most of the time I might defer the 420 stuff for later, and/or put it under a counter named <code>instructions-minus-r0420:u</code> and not bother giving it a name (I could probably even make this parse the number at runtime heh. probably not worth it though)</p>



<a name="213943682"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213943682" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213943682">(Oct 20 2020 at 16:24)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggory Blake</span> oh huh, that's an interesting point. they shouldn't, but who knows. at least I could try adding just those calls and nothing else</p>



<a name="213960515"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213960515" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213960515">(Oct 20 2020 at 18:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/213929827">said</a>:</p>
<blockquote>
<p>oh and it just died because the SSH connection randomly decided to end</p>
</blockquote>
<p>consider using <code>mosh</code> and/or <code>tmux</code></p>



<a name="213960664"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213960664" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213960664">(Oct 20 2020 at 18:28)</a>:</h4>
<p>+1 to mosh, although it breaks terminal scrollback :(</p>



<a name="213960710"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213960710" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213960710">(Oct 20 2020 at 18:29)</a>:</h4>
<p>yeah if <code>mosh</code> supported scrollback I would've switched to it ages ago</p>



<a name="213960748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213960748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213960748">(Oct 20 2020 at 18:29)</a>:</h4>
<p>in this case I didn't lose anything, and I've seen this before lol, with 4h-long commands that don't output anything during that 4h</p>



<a name="213960785"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213960785" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213960785">(Oct 20 2020 at 18:29)</a>:</h4>
<p>can probably prevent it by typing something (or just pressing enter) periodically while the command is running</p>



<a name="213960867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213960867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213960867">(Oct 20 2020 at 18:30)</a>:</h4>
<p>that's why I use <code>mosh</code> and <code>tmux</code> together</p>



<a name="213960950"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213960950" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213960950">(Oct 20 2020 at 18:31)</a>:</h4>
<p>thankfully it's rare that I do this and it's usually pointless anyway <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="213960998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213960998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213960998">(Oct 20 2020 at 18:31)</a>:</h4>
<p>last time I had to cut up the output into much smaller chunks to even diff it</p>



<a name="213974639"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213974639" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213974639">(Oct 20 2020 at 20:22)</a>:</h4>
<p>(split the <code>__tls_get_addr</code> discussion into its own topic)</p>



<a name="213974678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213974678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213974678">(Oct 20 2020 at 20:23)</a>:</h4>
<p>the important takeaway is I just need to avoid tracing <code>__tls_get_addr</code> if I use <code>ltrace</code> again</p>



<a name="213979536"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213979536" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213979536">(Oct 20 2020 at 21:07)</a>:</h4>
<p>oh wait, <code>ltrace</code> defaults to <code>-e @MAIN</code> so maybe because everything is in <code>libstd-*.so</code> and <code>librustc_driver-*.so</code>, not in <code>rustc</code> itself, that's why it can't trace <code>rustc</code> with no filters specified?</p>



<a name="213980070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213980070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213980070">(Oct 20 2020 at 21:12)</a>:</h4>
<p>and I can pass <code>-L</code> to remove the <code>-e @MAIN</code></p>



<a name="213980723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/213980723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#213980723">(Oct 20 2020 at 21:17)</a>:</h4>
<p>oh, I can't have both <code>-l '*'</code> and <code>-e '-__tls_get_addr'</code>, nor do I need them I don't think, looks like I only need the second one</p>



<a name="214005986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214005986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214005986">(Oct 21 2020 at 03:57)</a>:</h4>
<p>making far more progress with manual "timers" than I did with <code>ltrace</code> (i.e. I'm narrowing down where the noise is, and it does seem to be coming from one small area of the trait system, somewhere during winnowing, i.e. deduplicating/merging candidates to avoid ambiguity)</p>



<a name="214006981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214006981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214006981">(Oct 21 2020 at 04:20)</a>:</h4>
<p>oh no adding a "timer" to <code>candidate_should_be_dropped_in_favor_of</code> makes the results noiseless again, that's not what I want to see while tracking down the noise</p>



<a name="214046482"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214046482" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214046482">(Oct 21 2020 at 13:06)</a>:</h4>
<p>so possibly part of the problem is that the function I added a "timer" for is nested in two loops (it's called for every possible pair of two elements in a <code>Vec&lt;Candidate&gt;</code> to try and deduplicate them), trying with just around the loop now</p>



<a name="214048005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214048005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214048005">(Oct 21 2020 at 13:20)</a>:</h4>
<p>yeah it's entirely within this <a href="https://github.com/rust-lang/rust/blame/08e2d4616613716362b4b49980ff303f2b9ae654/compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs#L174-L197">https://github.com/rust-lang/rust/blame/08e2d4616613716362b4b49980ff303f2b9ae654/compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs#L174-L197</a></p>



<a name="214073731"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214073731" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214073731">(Oct 21 2020 at 16:09)</a>:</h4>
<p>okay I see <code>candidate_should_be_dropped_in_favor_of</code> was modified a bunch in <a href="https://github.com/rust-lang/rust/issues/73905">#73905</a>, and it looks to be mostly isolated from other changes, so it's plausible I could try reverting most of the changes in that function on top of current master</p>



<a name="214075491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214075491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214075491">(Oct 21 2020 at 16:20)</a>:</h4>
<p>"every possible pair of two elements" to try to dedup sounds like an algorithmic problem. Could that use a hash set?</p>



<a name="214075721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214075721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214075721">(Oct 21 2020 at 16:21)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> likely not worth it, it bails the moment it stops finding duplicates, and these are usually a small number</p>



<a name="214075736"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214075736" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214075736">(Oct 21 2020 at 16:21)</a>:</h4>
<p>Is this a case where the code is assuming that there's only two or three possibilities, so it would be faster to just check them by hand?</p>



<a name="214075745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214075745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214075745">(Oct 21 2020 at 16:21)</a>:</h4>
<p>Ah.</p>



<a name="214134160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214134160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214134160">(Oct 22 2020 at 01:15)</a>:</h4>
<p><del>huh I made a mistake the other day using <code>#[inline(always)]</code> where <code>#[inline(never)]</code> would've done what I wanted (I should've tried both)</del></p>



<a name="214134208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214134208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214134208">(Oct 22 2020 at 01:16)</a>:</h4>
<p><del>as in, it's inlining that was removing the noise, <em>not</em> not inlining</del></p>



<a name="214134309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214134309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214134309">(Oct 22 2020 at 01:19)</a>:</h4>
<p>and it tricked me again, none of the relevant timers show up in the result <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="214136737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214136737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214136737">(Oct 22 2020 at 02:09)</a>:</h4>
<p>wrapping the noise-removing timer in <code>if black_box(false) {...}</code> (which I should've done earlier) removes the effect so I'm now pretty sure it's the actual instructions that do something, not (just) LLVM optimizations</p>



<a name="214137407"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214137407" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214137407">(Oct 22 2020 at 02:23)</a>:</h4>
<p>a dummy <code>﻿cpuid(0)﻿</code> seems to be causing consistent results now</p>



<a name="214137695"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214137695" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214137695">(Oct 22 2020 at 02:28)</a>:</h4>
<p>the funny thing is that I could even check whether profiling is enabled and only then run <code>cpuid(0)</code> <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="214140857"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214140857" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214140857">(Oct 22 2020 at 03:46)</a>:</h4>
<p>wow even just <code>mfence</code> works, that's... weird</p>



<a name="214141693"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214141693" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214141693">(Oct 22 2020 at 04:09)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> <span class="user-mention" data-user-id="295632">@Diggory Blake</span> so yeah idk what it is but I'm pretty sure it has nothing to do with the rest of the system, all the <code>ltrace</code>-ing was a waste of time sadly, just a very weird interaction and <code>mfence</code> seems to be enough to block it (there's still a difference of 2 instructions sometimes but it's only in one execution so I'll take that over the mess I was seeing before)</p>



<a name="214167790"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214167790" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214167790">(Oct 22 2020 at 10:25)</a>:</h4>
<p>Huh, the fact that <code>mfence</code> fixes it suggests that it's related to concurrency. I wonder if we have a compare-exchange loop somewhere in the compiler? That could easily be non-deterministic, and an mfence could help synchronize stuff and avoid that being a problem...</p>



<a name="214179292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214179292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214179292">(Oct 22 2020 at 12:29)</a>:</h4>
<p>rustc uses parking_lot for  some mutexes, but when using <code>-Ccodegen-units=1</code> there should not be contention on any lock when not using parallel rustc. It is possible that there is a bit of overlap between <code>std::thread::spawn</code> and <code>join</code> for the main compiler thread where a lock is acquired.</p>



<a name="214203032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214203032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214203032">(Oct 22 2020 at 15:24)</a>:</h4>
<p>lol. this is in the trait system, there's no multithreading going on</p>



<a name="214205077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214205077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214205077">(Oct 22 2020 at 15:38)</a>:</h4>
<p>the trait system doesn't access any data protected by a mutex or use anything like <code>lazy_static</code>? Even with <code>-Ccodegen-units=1</code> and therefore no contention, I think compare/exchange is allowed to fail spuriously right?</p>



<a name="214205194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214205194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214205194">(Oct 22 2020 at 15:39)</a>:</h4>
<p>In non-parallel rustc the trait system doesn't support multithreading.</p>



<a name="214205462"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214205462" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214205462">(Oct 22 2020 at 15:41)</a>:</h4>
<p>There doesn't seem to be any use of <code>lazy_static</code> in rustc. Everything uses <code>thread_local!</code> or the <code>Session</code>.</p>



<a name="214229958"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214229958" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214229958">(Oct 22 2020 at 18:38)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggory Blake</span> keep in mind that before that PR, which doesn't touch any kind of synchronization primitives I can see, <em>this problem did not exist</em></p>



<a name="214230051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230051">(Oct 22 2020 at 18:39)</a>:</h4>
<p>there's the original main thread that is doing nothing except waiting for the child thread (the actual compiler thread), and that second thread is the only one getting measured</p>



<a name="214230161"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230161" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230161">(Oct 22 2020 at 18:40)</a>:</h4>
<p>there's some stuff protected by atomics and rwlocks but there is 0 contention and they behave fully deterministically</p>



<a name="214230197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230197">(Oct 22 2020 at 18:40)</a>:</h4>
<p>at least for what I'm measuring</p>



<a name="214230259"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230259" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230259">(Oct 22 2020 at 18:41)</a>:</h4>
<p>not to mention that I don't see any of those locks being anywhere near this code (and if they were a problem, I would've seen it before)</p>



<a name="214230432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230432">(Oct 22 2020 at 18:42)</a>:</h4>
<p>I doubt uncontended CAS can spuriously fail, but if it did, I'm pretty sure I'd see it somewhere</p>



<a name="214230580"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230580" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230580">(Oct 22 2020 at 18:43)</a>:</h4>
<p>I have a suspicion this might be another thing like <code>SpecLockMap</code> but even more obscure</p>



<a name="214230677"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230677" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230677">(Oct 22 2020 at 18:44)</a>:</h4>
<p>and that LLVM optimizations perhaps result in some instructions being used which cause this to happen</p>



<a name="214230782"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230782" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230782">(Oct 22 2020 at 18:45)</a>:</h4>
<p>What happens when you use rr? If it is something like <code>SpecLockMap</code> it should crash, right? If it isn't the differing instruction count should be reproducable in it.</p>



<a name="214230961"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230961" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230961">(Oct 22 2020 at 18:46)</a>:</h4>
<p>oh hmm good point, I'll have to note that down</p>



<a name="214230986"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214230986" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214230986">(Oct 22 2020 at 18:46)</a>:</h4>
<p>for now I want to focus on summarizing the important stuff that happened and the MVP</p>



<a name="214231141"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214231141" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214231141">(Oct 22 2020 at 18:48)</a>:</h4>
<p>open the PRs, etc. - I want to be done with the initial version at least, so that any work can happen async from the contract that's paying for this</p>



<a name="214266547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214266547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214266547">(Oct 23 2020 at 01:50)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> huh the new paged <code>measureme</code> serialization is really cool, when did that happen?</p>



<a name="214266554"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214266554" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214266554">(Oct 23 2020 at 01:50)</a>:</h4>
<p>also has <code>rustc</code> been updated to use it?</p>



<a name="214266900"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214266900" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214266900">(Oct 23 2020 at 01:58)</a>:</h4>
<p>oh wow <span class="user-mention" data-user-id="124287">@mw</span> is back?</p>



<a name="214266935"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214266935" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214266935">(Oct 23 2020 at 01:59)</a>:</h4>
<p>oh no I'll be blocked on <a href="https://github.com/rust-lang/rust/issues/77398">#77398</a></p>



<a name="214267034"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214267034" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214267034">(Oct 23 2020 at 02:01)</a>:</h4>
<p>though it looks like <span class="user-mention" data-user-id="116122">@simulacrum</span> has got that down now</p>



<a name="214267108"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214267108" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214267108">(Oct 23 2020 at 02:03)</a>:</h4>
<p>I guess it means even if I had a <code>measureme</code> PR ready in the past few weeks I wouldn't have been able to land the <code>rust-lang/rust</code> side of it</p>



<a name="214268458"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268458" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268458">(Oct 23 2020 at 02:42)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> this looks like it worked <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span>, is anything else blocking the PR? <a href="https://github.com/rust-lang/rust/pull/77398#issuecomment-714869011">https://github.com/rust-lang/rust/pull/77398#issuecomment-714869011</a></p>



<a name="214268464"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268464" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268464">(Oct 23 2020 at 02:42)</a>:</h4>
<p>I want to check on the self profile visualization which is almost certainly broken</p>



<a name="214268467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268467">(Oct 23 2020 at 02:43)</a>:</h4>
<p>But that should be an easy fix</p>



<a name="214268468"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268468" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268468">(Oct 23 2020 at 02:43)</a>:</h4>
<p>aww</p>



<a name="214268472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268472">(Oct 23 2020 at 02:43)</a>:</h4>
<p>I expect to r+ tomorrow</p>



<a name="214268474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268474">(Oct 23 2020 at 02:43)</a>:</h4>
<p>wait, do you mean the table? because that works</p>



<a name="214268479"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268479" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268479">(Oct 23 2020 at 02:43)</a>:</h4>
<p>No, the flamegraph</p>



<a name="214268485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268485">(Oct 23 2020 at 02:43)</a>:</h4>
<p>403 yeah :(</p>



<a name="214268543"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268543" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268543">(Oct 23 2020 at 02:45)</a>:</h4>
<p>I mostly want the file upload to work, I don't care about the ui as much. I should be able to verify or fix that tomorrow morning no problem</p>



<a name="214268551"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268551" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268551">(Oct 23 2020 at 02:45)</a>:</h4>
<p>thankfully I should be able to rebase on top of the PR to do my testing, and presumably the <code>measureme</code>PR I'll open first will take some time to land anyway</p>



<a name="214268597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268597">(Oct 23 2020 at 02:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> so presumably I'm not really blocked on it landing, the fact that it works at all should be good enough <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="214268599"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268599" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268599">(Oct 23 2020 at 02:46)</a>:</h4>
<p>fingers crossed etc.</p>



<a name="214268611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268611">(Oct 23 2020 at 02:47)</a>:</h4>
<p>Yeah. And the perf support should work fwiw for any pr</p>



<a name="214268655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268655">(Oct 23 2020 at 02:48)</a>:</h4>
<p>So if you emit compatible profiles with 9.0 summarize, you can just try that now</p>



<a name="214268659"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268659" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268659">(Oct 23 2020 at 02:48)</a>:</h4>
<p>(not sure how feasible that is)</p>



<a name="214268665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268665">(Oct 23 2020 at 02:48)</a>:</h4>
<p>I didn't even plan for a breaking change happening at any point FWIW, so all my changes are non-breaking</p>



<a name="214268750"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214268750" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214268750">(Oct 23 2020 at 02:51)</a>:</h4>
<p>in that even the counter descriptions are designed so that anything reading profiles that counted instructions will show them as nanoseconds if they haven't been updated to parse the counter names/units</p>



<a name="214293678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214293678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mw <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214293678">(Oct 23 2020 at 09:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/214266900">said</a>:</p>
<blockquote>
<p>oh wow <span class="user-mention silent" data-user-id="124287">mw</span> is back?</p>
</blockquote>
<p>only in a minimal form <code>:)</code></p>



<a name="214314773"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214314773" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214314773">(Oct 23 2020 at 13:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/214268750">said</a>:</p>
<blockquote>
<p>in that even the counter descriptions are designed so that anything reading profiles that counted instructions will show them as nanoseconds if they haven't been updated to parse the counter names/units</p>
</blockquote>
<p>That's really great work <span class="user-mention" data-user-id="119009">@eddyb</span>!</p>



<a name="214320557"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214320557" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214320557">(Oct 23 2020 at 14:30)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> well, kind of unnecessary, given the breaking changes made to the format :P</p>



<a name="214320602"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214320602" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214320602">(Oct 23 2020 at 14:30)</a>:</h4>
<p>but AFAICT there is no reason to make a breaking change here, other than renaming things like "time" and "timestamp"</p>



<a name="214323772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214323772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214323772">(Oct 23 2020 at 14:55)</a>:</h4>
<p>as in, I've only added to the public API, not changed any of the existing interfaces</p>



<a name="214469223"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214469223" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214469223">(Oct 25 2020 at 05:05)</a>:</h4>
<p>huh I was randomly browsing the RISC-V Privileged spec and I spotted some guaranteed perf counter support</p>



<a name="214469227"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214469227" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214469227">(Oct 25 2020 at 05:05)</a>:</h4>
<p>now I wish I had one of those incredibly expensive SiFive boards to play with</p>



<a name="214469291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214469291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214469291">(Oct 25 2020 at 05:06)</a>:</h4>
<blockquote>
<p>The hardware performance monitor includes 29 additional 64-bit event counters</p>
</blockquote>
<p>meanwhile x86 is up to like 6 48-bit counters :/</p>



<a name="214469463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214469463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214469463">(Oct 25 2020 at 05:10)</a>:</h4>
<p>oh no, do they not have automatic pause when in a different privilege mode :/</p>



<a name="214469685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214469685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214469685">(Oct 25 2020 at 05:15)</a>:</h4>
<p>I guess individual implementations can do it with custom event settings, but not mandating it (especially for <code>instret</code>) sucks :(</p>



<a name="214469791"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214469791" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214469791">(Oct 25 2020 at 05:18)</a>:</h4>
<p>this <em>feels</em> like it would be a RISC-V thing, given how much they try to make the privilege modes orthogonal</p>



<a name="214471091"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214471091" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214471091">(Oct 25 2020 at 05:51)</a>:</h4>
<p>oh nice this is a linkable version of the spec <a href="http://www.five-embeddev.com/riscv-isa-manual/latest/machine.html#hardware-performance-monitor">http://www.five-embeddev.com/riscv-isa-manual/latest/machine.html#hardware-performance-monitor</a></p>



<a name="214472135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214472135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214472135">(Oct 25 2020 at 06:14)</a>:</h4>
<p>found this (Ctrl+F "Hardware Performance Monitor", page 16) <a href="https://www.microsemi.com/document-portal/doc_download/1244570-ug0880-polarfire-soc-fpga-microprocessor-subsystem-mss-user-guide">https://www.microsemi.com/document-portal/doc_download/1244570-ug0880-polarfire-soc-fpga-microprocessor-subsystem-mss-user-guide</a><br>
so yupp, I was right, because the spec doesn't require it nor offer a general mechanism, they didn't bother implementing any way to limit the counter to counting in user mode only :(</p>



<a name="214478307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214478307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214478307">(Oct 25 2020 at 08:55)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> nice, <a href="https://github.com/rust-lang/rust/issues/77398">#77398</a> landed! time to do some final measurements :3</p>



<a name="214479908"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214479908" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214479908">(Oct 25 2020 at 09:34)</a>:</h4>
<p><code>final-final-final.md</code> vibes <a href="https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50">https://gist.github.com/eddyb/7a0a55411441142765db6cfa41504e50</a></p>



<a name="214642005"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214642005" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214642005">(Oct 26 2020 at 22:39)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> lol just spotted your comments, see <a href="https://github.com/rust-lang/measureme/pull/129#issuecomment-716861967">https://github.com/rust-lang/measureme/pull/129#issuecomment-716861967</a></p>



<a name="214642148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214642148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214642148">(Oct 26 2020 at 22:41)</a>:</h4>
<p>I've hidden them all as off-topic for now, but I'm glad you seem to be eager to review all that code :P</p>



<a name="214642190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214642190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214642190">(Oct 26 2020 at 22:41)</a>:</h4>
<p>(I agree more documentation is needed, I'm currently in the process of writing up what will be the PR description, and that effectively includes roughly the same information that I should also put in doc comments, but I want to have the PR open before I touch the code at all)</p>



<a name="214652990"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214652990" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214652990">(Oct 27 2020 at 01:34)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span>  I just wanted to make sure you weren't blocked on waiting for reviews from me. Feel free to ping me when you're ready for the reviews. :)</p>



<a name="214693218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214693218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214693218">(Oct 27 2020 at 12:40)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <span class="user-mention" data-user-id="116122">@simulacrum</span> so I just remembered the threading issue, and while what I was assuming would be the ideal solution (per-thread <code>!Sync</code>/<code>!Send</code> handles to the profiler, which include a counter) would require some refactors on the <code>rustc</code> side, I just realized I could have a <code>per_thread_counter: Vec&lt;Option&lt;Counter&gt;&gt;</code> in <code>measureme</code> and index it by <code>ThreadId</code></p>
<p>should I try to add this to the initial PR, or should we aim to merge the version that mostly only works for the single-thread case (so mostly check-mode only)?</p>



<a name="214694800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214694800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214694800">(Oct 27 2020 at 12:56)</a>:</h4>
<p>I guess I can keep going under the assumption it's the former and list it under caveats, the write-up is more important than any code changes at this point</p>



<a name="214700618"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214700618" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214700618">(Oct 27 2020 at 13:44)</a>:</h4>
<p>I would be happy to see the basic version land first and then we can land improvements to it as we go along.</p>



<a name="214708047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214708047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214708047">(Oct 27 2020 at 14:37)</a>:</h4>
<p>That makes sense to me too</p>



<a name="214744286"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/214744286" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#214744286">(Oct 27 2020 at 18:35)</a>:</h4>
<p>oh right the other alternative is all that <code>inherit</code> stuff but I have doubts about how well it would work hmpf. like it sounds hard for it to be exactly the same counter index (though I guess it could get cloned when the child thread is spawned, leaving gaps for non-<code>inherit</code> counters). I also don't know if the values read start out relative to the parent or from scratch etc.<br>
may be possible to find out by creating a mix of inherited and non-inherited counters on a thread and then seeing what is observed on child threads</p>



<a name="215048226"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215048226" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215048226">(Oct 30 2020 at 01:32)</a>:</h4>
<p>okay whew I've just:</p>
<ol>
<li>confirmed (via google activity history) that my original search query which found the AMD patent was <code>instructions retired lock</code></li>
<li>the AMD patent is nowhere to be found in the results now</li>
<li>came across this instead <a href="https://www.realworldtech.com/forum/?threadid=195249">https://www.realworldtech.com/forum/?threadid=195249</a></li>
</ol>



<a name="215048231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215048231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215048231">(Oct 30 2020 at 01:32)</a>:</h4>
<p>say hello to <em>Linus Torvalds</em></p>



<a name="215048454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215048454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215048454">(Oct 30 2020 at 01:37)</a>:</h4>
<p>some of the out-of-order execution discussions are way deeper than I ever bothered to think about <code>SpecLockMap</code> heh</p>



<a name="215048792"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215048792" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215048792">(Oct 30 2020 at 01:45)</a>:</h4>
<p>Heh, that's actually surprisingly close to my wild guess about CMPXCHG loops :P - atomic stores are being retired multiple times</p>



<a name="215048887"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215048887" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215048887">(Oct 30 2020 at 01:47)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggory Blake</span> note that the entire saga happened last month and the Zen 1 EPYC server I test on has had <code>SpecLockMap</code> disabled the entire time I was struggling with post-rebase noise</p>



<a name="215048937"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215048937" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215048937">(Oct 30 2020 at 01:48)</a>:</h4>
<p>with <code>SpecLockMap</code> disabled the noise went from (up to) ±10k to <em>zero</em></p>



<a name="215048946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215048946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Diggsey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215048946">(Oct 30 2020 at 01:48)</a>:</h4>
<p>ah, I thought you were saying this was the cause of the later variance</p>



<a name="215048948"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215048948" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215048948">(Oct 30 2020 at 01:48)</a>:</h4>
<p>the only variation was when writing the output file</p>



<a name="215048965"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215048965" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215048965">(Oct 30 2020 at 01:49)</a>:</h4>
<p>no, uhh, I'm about to write the write-up of the entire thing, but I guess I can link you to the <code>rr</code> comment <a href="https://github.com/mozilla/rr/issues/2034#issuecomment-691339758">https://github.com/mozilla/rr/issues/2034#issuecomment-691339758</a></p>



<a name="215049036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215049036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215049036">(Oct 30 2020 at 01:50)</a>:</h4>
<p><span class="user-mention" data-user-id="295632">@Diggory Blake</span> the connection btw is that the method <span class="user-mention" data-user-id="137027">@Jannis Harder</span> found for disabling <code>SpecLockMap</code> ended up unlocking <code>rr</code> on Zen :D</p>



<a name="215049115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215049115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215049115">(Oct 30 2020 at 01:52)</a>:</h4>
<p>we later found a detection method (from userspace, using a perf counter) and so both <code>rr</code> and my <code>measureme</code> code (PR soon! I mean you can read it on the <code>rdpmc</code> branch if you're curious :P) tell you to go to <a href="https://github.com/mozilla/rr/wiki/Zen">https://github.com/mozilla/rr/wiki/Zen</a> to learn how to turn <code>SpecLockMap</code> off</p>



<a name="215079433"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215079433" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215079433">(Oct 30 2020 at 10:57)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> <br>
So, I thought about ways to debug these variations in program runs.<br>
If rustc run leaves a trace that contains addresses and instruction counts of all executed basic blocks, then it would be simple to compare such traces and find differences, right?<br>
The differences can then be mapped to specific symbols or instructions using the traced address.</p>



<a name="215079668"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215079668" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215079668">(Oct 30 2020 at 10:59)</a>:</h4>
<p>I previously suggested qemu for this, but there is a much more light-weight alternative - dynamic binary instrumentation (e.g. Pin or <a href="https://github.com/DynamoRIO/dynamorio">DynamoRIO</a>).<br>
I have some experience writing clients performing specific tracing, and dumping instruction counts and basic block addresses requires amounts to a very simple client.</p>



<a name="215079981"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215079981" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215079981">(Oct 30 2020 at 11:02)</a>:</h4>
<p>(Syscalls, signals and other similar things can be easily traced as well, if necessary.)</p>



<a name="215080387"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215080387" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215080387">(Oct 30 2020 at 11:07)</a>:</h4>
<p>Actually, if the only thing we need for benchmarking rustc is to count user-mode instructions, then it can be done by a ~0%-overhead DBI client too <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="215080540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215080540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215080540">(Oct 30 2020 at 11:09)</a>:</h4>
<p>This of course is not a replacement for hardware counters, because it would be <em>very</em> nice to count retired uops in addition to (or instead of) retired instructions + memory-related events etc are important too.</p>



<a name="215163483"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215163483" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215163483">(Oct 30 2020 at 23:49)</a>:</h4>
<p>heh uops are a good suggestion, IIRC when I last messed with that, <code>rustc</code> uops were somewhere above 1uop/instruction, maybe around 1.2</p>



<a name="215163553"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215163553" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215163553">(Oct 30 2020 at 23:50)</a>:</h4>
<p>I need to remember to note it down somewhere for future work (like a few other things)</p>



<a name="215163611"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215163611" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215163611">(Oct 30 2020 at 23:52)</a>:</h4>
<p>also, traces are great, ideally we could get something like <code>rr</code> to automatically detect the cause, or at least localize it, without needing special builds etc. - <code>qemu</code> is also good, it's not like I don't have the hardware to run a bunch of VMs on, it just... could lead to another month spent tracking down some other weirdness and I want to ship <em>something</em> <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="215163755"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215163755" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215163755">(Oct 30 2020 at 23:55)</a>:</h4>
<p>long-term I really want to have some kind of framework for measuring and detecting weird hardware quirks</p>



<a name="215163767"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215163767" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215163767">(Oct 30 2020 at 23:55)</a>:</h4>
<p>both by asking the hardware to tell us about itself, <em>and</em> by observing it misbehave</p>



<a name="215262026"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215262026" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215262026">(Nov 01 2020 at 20:59)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> heh, <a href="https://download.asrock.com/Manual/B450M%20Pro4.pdf">https://download.asrock.com/Manual/B450M%20Pro4.pdf</a> names <code>SpecLockMap</code>, idk why we had to rely on random reuploads</p>



<a name="215262028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215262028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215262028">(Nov 01 2020 at 20:59)</a>:</h4>
<p>maybe it blocks google from indexing it</p>



<a name="215433104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215433104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215433104">(Nov 03 2020 at 10:10)</a>:</h4>
<p><span aria-label="alert" class="emoji emoji-1f6a8" role="img" title="alert">:alert:</span> <a href="https://github.com/rust-lang/measureme/pull/143">https://github.com/rust-lang/measureme/pull/143</a></p>



<a name="215433144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215433144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215433144">(Nov 03 2020 at 10:10)</a>:</h4>
<p>the bulk of the write-up is on <a href="https://hackmd.io/sH315lO2RuicY-SEt7ynGA?view">https://hackmd.io/sH315lO2RuicY-SEt7ynGA?view</a> because uhhh it big</p>



<a name="215433647"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215433647" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215433647">(Nov 03 2020 at 10:16)</a>:</h4>
<p>can't believe it's done, even just the write-up took a whole week</p>



<a name="215434128"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215434128" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215434128">(Nov 03 2020 at 10:21)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> time to move those review comments to the right PR :P</p>



<a name="215438283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215438283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> davidtwco <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215438283">(Nov 03 2020 at 11:02)</a>:</h4>
<p>that write-up is fantastic, everything about this effort is just incredibly impressive</p>



<a name="215438503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215438503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215438503">(Nov 03 2020 at 11:04)</a>:</h4>
<p>blame hardware vendors for not making it trivial to get perfect results out of the box :P</p>



<a name="215438593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215438593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215438593">(Nov 03 2020 at 11:04)</a>:</h4>
<p>(place your bets on whether Zen 3 has fixed the <code>SpecLockMap</code> overcounting, or made everything worse in the name of IPC)</p>



<a name="215438730"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215438730" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215438730">(Nov 03 2020 at 11:06)</a>:</h4>
<p>oh speaking of which, feel free to play around with undocumented counters haha, lots of fun stuff left to be found in there</p>



<a name="215439966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215439966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215439966">(Nov 03 2020 at 11:19)</a>:</h4>
<p>I'd bet against it being fixed on zen 3... I don't have the impression that they consider that overcounting to be a big issue (given the comments from the person at AMD who mentioned that there was a different undisclosed reason for setting that bit for IBS, IIRC) and adding rollback logic to the performance counter sounds like a lot of extra engineering and verification effort</p>



<a name="215440830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215440830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215440830">(Nov 03 2020 at 11:28)</a>:</h4>
<p>I mean they already have to roll back registers, no? these are just 6 more registers</p>



<a name="215440867"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215440867" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215440867">(Nov 03 2020 at 11:28)</a>:</h4>
<p>(48-bit even :P)</p>



<a name="215440906"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215440906" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215440906">(Nov 03 2020 at 11:29)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> I wonder if they speculate and roll back AVX2 instructions, that seems like a lot more effort than perf counters :P</p>



<a name="215441010"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215441010" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215441010">(Nov 03 2020 at 11:30)</a>:</h4>
<p>Not saying that rolling back performance counters is more difficult than rolling back other state... but it's still a thing they'd have to implement that they don't do currently</p>



<a name="215442898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215442898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215442898">(Nov 03 2020 at 11:50)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> this is an awesome story, do you mind if I post it around reddit?</p>



<a name="215443164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215443164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215443164">(Nov 03 2020 at 11:52)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> fair</p>



<a name="215443206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215443206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215443206">(Nov 03 2020 at 11:53)</a>:</h4>
<p><span class="user-mention" data-user-id="232545">@Joshua Nelson</span> haha I forgot about reddit. sure thing :D</p>



<a name="215443243"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215443243" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215443243">(Nov 03 2020 at 11:53)</a>:</h4>
<p>wow almost 20 ppl on the hackmd o_O</p>



<a name="215444294"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215444294" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215444294">(Nov 03 2020 at 12:04)</a>:</h4>
<p>I did have it open in 3 tabs because I got distracted multiple times while reading it ^^ (not sure how it counts that)</p>



<a name="215444344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215444344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215444344">(Nov 03 2020 at 12:04)</a>:</h4>
<p>haha</p>



<a name="215445473"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215445473" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Nelson <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215445473">(Nov 03 2020 at 12:16)</a>:</h4>
<p><a href="https://www.reddit.com/r/rust/comments/jn9892/hardware_performance_counters_for_the_rust/">https://www.reddit.com/r/rust/comments/jn9892/hardware_performance_counters_for_the_rust/</a></p>



<a name="215457561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215457561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215457561">(Nov 03 2020 at 14:09)</a>:</h4>
<p>I see Reddit has arrived on Hackmd <a href="/user_uploads/4715/p3u-KI8qyuR_KgLm5T28iMLW/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/4715/p3u-KI8qyuR_KgLm5T28iMLW/image.png" title="image.png"><img src="/user_uploads/4715/p3u-KI8qyuR_KgLm5T28iMLW/image.png"></a></div>



<a name="215488372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215488372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215488372">(Nov 03 2020 at 17:51)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> oh no I found a way to make <code>SpecLockMapCommit</code> count with <code>SpecLockMap</code> (supposedly) disabled &gt;:(</p>



<a name="215488424"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215488424" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215488424">(Nov 03 2020 at 17:51)</a>:</h4>
<p>tiny values but still not great. it should be 0</p>



<a name="215488486"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215488486" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215488486">(Nov 03 2020 at 17:52)</a>:</h4>
<p>huh, that's quite strange</p>



<a name="215488520"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215488520" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215488520">(Nov 03 2020 at 17:52)</a>:</h4>
<p>too late now, time to pretend I never saw anything <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="215488617"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215488617" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215488617">(Nov 03 2020 at 17:53)</a>:</h4>
<p>does it matter as long as it doesn't make the SpecLockMap detection unreliable? (or does it do that?)</p>



<a name="215488732"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215488732" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215488732">(Nov 03 2020 at 17:54)</a>:</h4>
<p>no idea, this is for over a million <code>lock</code>s executed</p>



<a name="215488813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215488813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215488813">(Nov 03 2020 at 17:54)</a>:</h4>
<p>maybe it's a specific <code>lock</code> instruction that <code>rustc</code> doesn't use</p>



<a name="215488951"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215488951" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215488951">(Nov 03 2020 at 17:55)</a>:</h4>
<p>(I'm trying to make a counter example that's as simple as possible, C++ templates were my first attempt, now I'm testing with <code>xz</code>)</p>



<a name="215489841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215489841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jannis Harder <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215489841">(Nov 03 2020 at 18:02)</a>:</h4>
<p>Also on which CPU are you testing?</p>



<a name="215489988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215489988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215489988">(Nov 03 2020 at 18:03)</a>:</h4>
<p>During what query/activity does this <code>SpecLockMapCommit</code> counting happen?</p>



<a name="215490228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215490228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215490228">(Nov 03 2020 at 18:05)</a>:</h4>
<p><code>dd status=none if=/dev/zero count=1M | perf stat -e r002c:u,r0225:u,r0425:u,r0825:u,r0e25:u xz -e9 -T2 &gt; /dev/null</code><br>
(increase <code>count</code> to make it do more)</p>



<a name="215659228"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215659228" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Vadim Petrochenkov <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215659228">(Nov 05 2020 at 00:37)</a>:</h4>
<p>Whoa, I finally read the whole thread today. Great read.<br>
(I had a few comments to messages from months ago, but that's probably all irrelevant now.)</p>



<a name="215659260"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215659260" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215659260">(Nov 05 2020 at 00:38)</a>:</h4>
<p>I didn't expect anyone would, haha</p>



<a name="215659291"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215659291" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215659291">(Nov 05 2020 at 00:38)</a>:</h4>
<p>(hence trying to put as much as possible into the write-up)</p>



<a name="215714245"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215714245" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215714245">(Nov 05 2020 at 13:57)</a>:</h4>
<p>oh no... <code>proc_macro</code> uses non-<code>Fx</code> <code>HashMap</code>s</p>



<a name="215715180"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215715180" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215715180">(Nov 05 2020 at 14:04)</a>:</h4>
<p><code>core</code> doesn't use proc macros so this didn't show up before</p>



<a name="215741614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215741614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215741614">(Nov 05 2020 at 16:59)</a>:</h4>
<p>would you want to add <code>rustc_hash</code> as a user library dependency?</p>



<a name="215745056"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215745056" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215745056">(Nov 05 2020 at 17:22)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> nah, can just use <code>DefaultHasher</code> but with <code>::new()</code> instead of what <code>RandomState</code> does</p>



<a name="215745078"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215745078" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215745078">(Nov 05 2020 at 17:22)</a>:</h4>
<p>glad that exists <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="215745162"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215745162" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215745162">(Nov 05 2020 at 17:23)</a>:</h4>
<p>oh, just for defeating random state -- ok, yeah</p>



<a name="215745168"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215745168" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215745168">(Nov 05 2020 at 17:23)</a>:</h4>
<p>but it's worse than that because <code>serde_derive</code> and the <code>toml</code> crate (used by some other proc macros) use <code>HashMap</code>/<code>HashSet</code>, so there's no easy fix (had to resort to making <code>RandomState</code> actually deterministic to get some data)</p>



<a name="215745394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215745394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215745394">(Nov 05 2020 at 17:25)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> see the second and third paragraph here <a href="https://hackmd.io/sH315lO2RuicY-SEt7ynGA?view#Results-for-polkadot-runtime-common">https://hackmd.io/sH315lO2RuicY-SEt7ynGA?view#Results-for-polkadot-runtime-common</a></p>



<a name="215745565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215745565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215745565">(Nov 05 2020 at 17:26)</a>:</h4>
<p>yeah, makes sense, I just had raw perf in mind instead of measurement stability</p>



<a name="215747076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215747076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215747076">(Nov 05 2020 at 17:35)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span>  did you want someone to get std using libc getrandom? I could give that a shot...</p>



<a name="215747200"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215747200" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215747200">(Nov 05 2020 at 17:36)</a>:</h4>
<p>it would make hooking it much easier (not having to deal with intercepting syscalls) :D</p>



<a name="215747242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215747242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215747242">(Nov 05 2020 at 17:36)</a>:</h4>
<p>sadly there would need to be some runtime detection because older <code>glibc</code> just doesn't have it (at least AIUI)</p>



<a name="215747275"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215747275" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215747275">(Nov 05 2020 at 17:36)</a>:</h4>
<p>yeah, there's a <code>weak!</code> macro for that</p>



<a name="215747527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215747527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215747527">(Nov 05 2020 at 17:38)</a>:</h4>
<p>it was added in glibc 2.25</p>



<a name="215748640"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215748640" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215748640">(Nov 05 2020 at 17:45)</a>:</h4>
<p>oh, nice, I forgot about weak symbols. not having to <code>dlsym</code> is great :D (inb4 I'm wrong and <code>weak!</code> literally uses <code>dlsym</code>)</p>



<a name="215748713"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215748713" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215748713">(Nov 05 2020 at 17:46)</a>:</h4>
<p><span aria-label="alert" class="emoji emoji-1f6a8" role="img" title="alert">:alert:</span> just opened <a href="https://github.com/rust-lang/rust/issues/78781">#78781</a> (pretty boring tho, just a bit of integration)</p>



<a name="215755646"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215755646" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215755646">(Nov 05 2020 at 18:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="119009">eddyb</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/hardware.20counter.20(rdpmc).20measurements/near/215748640">said</a>:</p>
<blockquote>
<p>oh, nice, I forgot about weak symbols. not having to <code>dlsym</code> is great :D (inb4 I'm wrong and <code>weak!</code> literally uses <code>dlsym</code>)</p>
</blockquote>
<p>unfortunately, yes it does use <code>dlsym</code> -- there's some justification for this at the top of <a href="https://github.com/rust-lang/rust/blob/master/library/std/src/sys/unix/weak.rs"><code>weak.rs</code></a></p>



<a name="215802998"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215802998" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215802998">(Nov 06 2020 at 03:33)</a>:</h4>
<p>quick sketch: </p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nb">echo</span> <span class="s1">'#[no_mangle] pub extern fn getrandom(_: *const u8, len: usize, _: u32) -&gt; usize { len }'</span> <span class="p">|</span>
    rustc --crate-type<span class="o">=</span>cdylib - -O -o ~/.local/lib/unrand.so
</code></pre></div>
<p>followed by using <code>LD_PRELOAD=$HOME/.local/lib/unrand.so</code></p>



<a name="215803190"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215803190" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215803190">(Nov 06 2020 at 03:38)</a>:</h4>
<p>should probably zero tho:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nb">echo</span> <span class="s1">'#[no_mangle] pub unsafe extern fn getrandom(p: *mut u8, n: usize, _: u32) -&gt; usize { p.write_bytes(0, n); n }'</span> <span class="p">|</span>
    rustc --crate-type<span class="o">=</span>cdylib - -O -o ~/.local/lib/unrand.so
</code></pre></div>



<a name="215812194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215812194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215812194">(Nov 06 2020 at 07:14)</a>:</h4>
<p><span class="user-mention" data-user-id="137027">@Jannis Harder</span> <span class="user-mention" data-user-id="138448">@cuviper</span> lol, Zen 3 PPR was leaked around the time we were looking at <code>SpecLockMap</code> back in September <a href="https://www.google.com/search?q=%22Processor+Programming+Reference+(PPR)+for+AMD+Family+19h%22">https://www.google.com/search?q=%22Processor+Programming+Reference+(PPR)+for+AMD+Family+19h%22</a></p>



<a name="215812307"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215812307" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215812307">(Nov 06 2020 at 07:16)</a>:</h4>
<p>oh is it just one screenshot :(</p>



<a name="215994561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/215994561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Zoxc <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#215994561">(Nov 08 2020 at 07:42)</a>:</h4>
<p>Agner Fog has a Windows driver which enables rdpmc / MSR access in user mode, <a href="https://agner.org/optimize/#testp">https://agner.org/optimize/#testp</a></p>
<p>We may be able to modify that and possibly get Microsoft folks to help with signing</p>



<a name="216451409"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/216451409" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#216451409">(Nov 12 2020 at 10:36)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> so the person reviewing the report (for the grant it's part of) had a good point that I didn't think/forgot about: some of the details should go into <code>measureme</code>/<code>rustc</code> docummentation</p>



<a name="216451430"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/216451430" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#216451430">(Nov 12 2020 at 10:37)</a>:</h4>
<p>but I'm not super sure where. rustc-dev-guide?</p>



<a name="216455853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/216455853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#216455853">(Nov 12 2020 at 11:25)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> rustc dev guide seems like the best option to me.</p>



<a name="216515898"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/216515898" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#216515898">(Nov 12 2020 at 19:27)</a>:</h4>
<p>hmm he also wants <code>measureme</code> docs, I'm guessing those go into doc comments</p>



<a name="216516340"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/216516340" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#216516340">(Nov 12 2020 at 19:30)</a>:</h4>
<p>Ok or if you think it makes more sense, making a <code>measureme/docs</code> folder and adding markdown files there is fine too.</p>



<a name="217118186"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217118186" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217118186">(Nov 18 2020 at 10:36)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> just pushed to the PR, and you can see it here: <a href="http://build.lyken.rs/~eddy/measureme-rdpmc-doc/measureme/">http://build.lyken.rs/~eddy/measureme-rdpmc-doc/measureme/</a></p>



<a name="217118255"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217118255" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217118255">(Nov 18 2020 at 10:36)</a>:</h4>
<p>maybe it's too dense, idk, but I won't be able to mess with it again too soon, since I'm starting a different thing today</p>



<a name="217353967"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217353967" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217353967">(Nov 20 2020 at 02:02)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Merged! This is excellent. I pushed a small change to one of the doc comments to fix the CI error.</p>



<a name="217396076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217396076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217396076">(Nov 20 2020 at 12:47)</a>:</h4>
<p>wait, already?</p>



<a name="217396206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217396206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217396206">(Nov 20 2020 at 12:48)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> the <code>[...]</code> syntax was working for me, didn't know about <code>&lt;...&gt;</code> hmmm</p>



<a name="217396368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217396368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217396368">(Nov 20 2020 at 12:50)</a>:</h4>
<p>oh wait it wasn't working</p>



<a name="217396384"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217396384" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217396384">(Nov 20 2020 at 12:50)</a>:</h4>
<p>/me must've forgotten to check <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="217396385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217396385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217396385">(Nov 20 2020 at 12:50)</a>:</h4>
<p>I wasn't aware of it either but it looks like rustdoc nightly has started complaining about the <code>[...]</code> syntax</p>



<a name="217396487"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217396487" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217396487">(Nov 20 2020 at 12:51)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> have you published yet? if not, could you hold off a bit on that?</p>



<a name="217396568"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217396568" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217396568">(Nov 20 2020 at 12:52)</a>:</h4>
<p>No I haven't published yet</p>



<a name="217396571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217396571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217396571">(Nov 20 2020 at 12:52)</a>:</h4>
<p>Will do!</p>



<a name="217396597"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217396597" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217396597">(Nov 20 2020 at 12:52)</a>:</h4>
<p>there might be a couple small things to fix</p>



<a name="217397496"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217397496" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217397496">(Nov 20 2020 at 13:02)</a>:</h4>
<p><span class="user-mention" data-user-id="138448">@cuviper</span> just got a crazy idea for <a href="https://github.com/rust-lang/rust/issues/78785">#78785</a> - could <code>librustc_driver</code> <em>define</em> <code>getrandom</code> now? it would have to invoke <code>syscall</code> directly and I would probably override it via a new <code>-Z getrandom-seed</code> flag or w/e, buuut it would be easier to use than a separate <code>LD_PRELOAD</code> hack</p>



<a name="217431800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217431800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217431800">(Nov 20 2020 at 17:19)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> sure, that sounds reasonable</p>



<a name="217454159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217454159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217454159">(Nov 20 2020 at 20:21)</a>:</h4>
<p>You may have to define it in the main executable. If libc happens to be included before rustc_driver, it wouldn't get overridden I think. It is basically first come first serve.</p>



<a name="217475265"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217475265" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217475265">(Nov 21 2020 at 00:26)</a>:</h4>
<p>I think that will still obey the order of <code>NEEDED</code> entries, e.g. <code>readelf -d /usr/bin/rustc</code> shows me:</p>
<div class="codehilite"><pre><span></span><code>(NEEDED)             Shared library: [librustc_driver-a72897dcafce5996.so]
(NEEDED)             Shared library: [libstd-b2663731bc9f22d7.so]
(NEEDED)             Shared library: [libc.so.6]
</code></pre></div>



<a name="217579276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217579276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217579276">(Nov 23 2020 at 00:46)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> <a href="https://github.com/rust-lang/measureme/pull/129#issuecomment-731878205">https://github.com/rust-lang/measureme/pull/129#issuecomment-731878205</a></p>



<a name="217581530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217581530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217581530">(Nov 23 2020 at 01:42)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Let me take another look. I've pretty much paged this out of memory since it was WIP.</p>



<a name="217581540"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217581540" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217581540">(Nov 23 2020 at 01:42)</a>:</h4>
<p><a href="https://github.com/rust-lang/measureme/pull/147">https://github.com/rust-lang/measureme/pull/147</a> is more important but also not sure yet if that's final</p>



<a name="217581547"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217581547" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217581547">(Nov 23 2020 at 01:42)</a>:</h4>
<p>(getting out-of-band review comments, effectively)</p>



<a name="217821994"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217821994" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217821994">(Nov 24 2020 at 22:25)</a>:</h4>
<p>(deleted: sorry, I chimed in replying to a wildly out-of-date comment)</p>



<a name="217957947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/217957947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#217957947">(Nov 26 2020 at 01:37)</a>:</h4>
<p><span class="user-mention" data-user-id="119009">@eddyb</span> Is there anything else you want to do in <a href="https://github.com/rust-lang/measureme/pull/129">https://github.com/rust-lang/measureme/pull/129</a>? If not, I'll merge tomorrow.</p>



<a name="218021980"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/218021980" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> eddyb <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#218021980">(Nov 26 2020 at 16:55)</a>:</h4>
<p><span class="user-mention" data-user-id="125250">@Wesley Wiser</span> I think it's all settled, but I won't be able to look at it closer until the weekend</p>



<a name="218021993"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/hardware%20counter%20%28rdpmc%29%20measurements/near/218021993" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/hardware.20counter.20(rdpmc).20measurements.html#218021993">(Nov 26 2020 at 16:55)</a>:</h4>
<p>No rush :)</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>