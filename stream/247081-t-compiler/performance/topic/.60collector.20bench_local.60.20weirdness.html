<html>
<head><meta charset="utf-8"><title>`collector bench_local` weirdness · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html">`collector bench_local` weirdness</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="261185674"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261185674" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261185674">(Nov 11 2021 at 21:20)</a>:</h4>
<p>I'm following the benchmarking instructions at <a href="https://github.com/rust-lang/rustc-perf/tree/master/collector">https://github.com/rust-lang/rustc-perf/tree/master/collector</a>. It mostly works fine, but something strange happens in the middle. Just before the strangeness is this output:</p>
<div class="codehilite"><pre><span></span><code>18 benchmarks remaining
Preparing regression-31157
Running regression-31157: Check + [Full, IncrFull, IncrUnchanged, IncrPatched]
Running regression-31157: Debug + [Full, IncrFull, IncrUnchanged, IncrPatched]
Running regression-31157: Opt + [Full, IncrFull, IncrUnchanged, IncrPatched]
17 benchmarks remaining
Preparing ripgrep
Running ripgrep: Check + [Full, IncrFull, IncrUnchanged, IncrPatched]
Running ripgrep: Debug + [Full, IncrFull, IncrUnchanged, IncrPatched]
Running ripgrep: Opt + [Full, IncrFull, IncrUnchanged, IncrPatched]
</code></pre></div>
<p>Then things get weird:</p>
<div class="codehilite" data-code-language="16"><pre><span></span><code>Cloning into 'rust'...
remote: Enumerating objects: 1597398, done.
remote: Counting objects: 100% (21/21), done.
remote: Compressing objects: 100% (19/19), done.
remote: Total 1597398 (delta 2), reused 10 (delta 2), pack-reused 1597377
Receiving objects: 100% (1597398/1597398), 696.23 MiB | 9.04 MiB/s, done.
Resolving deltas: 100% (1278107/1278107), done.
fatal: ambiguous argument 'MyId': unknown revision or path not in the working tree.
Use '--' to separate paths from revisions, like this:
'git &lt;command&gt; [&lt;revision&gt;...] -- [&lt;file&gt;...]'
HEAD is now at 3d29b680774 Auto merge of #90648 - matthewjasper:assoc-item-cleanup, r=cjgillot
configure: processing command line
configure:
configure: llvm.download-ci-llvm := True
configure: build.print-step-timings := True
configure: rust.deny-warnings   := False
configure: build.rustc          := /home/njn/dev/rustc-perf-tmp/target/release/bo ...
configure: build.cargo          := /home/njn/.rustup/toolchains/nightly-x86_64-un ...
configure: build.configure-args := ['--set', 'llvm.download-ci-llvm=true', '--set ...
configure:
configure: writing `config.toml` in current directory
configure:
configure: run `python /home/njn/dev/rustc-perf-tmp/rust/x.py --help`
configure:
collector error: Failed to benchmark 'rustc', recorded: measure rustc: building rustc: expected success, got exit status: 1
</code></pre></div>
<p>It has cloned <code>rust</code>? It then tries to build it, but gets lots of errors, here's the first one:</p>
<div class="codehilite"><pre><span></span><code>[RUSTC-TIMING] build_script_build test:false 0.507
   Compiling core v0.0.0 (/home/njn/dev/rustc-perf-tmp/rust/library/core)
error: attributes starting with `rustc` are reserved for use by the `rustc` compiler
    --&gt; library/core/src/intrinsics.rs:2262:3
     |
2262 | #[rustc_do_not_const_check]
     |   ^^^^^^^^^^^^^^^^^^^^^^^^
</code></pre></div>



<a name="261185814"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261185814" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261185814">(Nov 11 2021 at 21:21)</a>:</h4>
<p>Then more weirdness, before going back to normal benchmarking:</p>
<div class="codehilite"><pre><span></span><code>downloading https://static.rust-lang.org/dist/2021-10-23/rustfmt-nightly-x86_64-unknown-linux-gnu.tar.xz
extracting /home/njn/dev/rustc-perf-tmp/rust/build/cache/2021-10-23/rustfmt-nightly-x86_64-unknown-linux-gnu.tar.xz
downloading https://ci-artifacts.rust-lang.org/rustc-builds/68ca579406f2fa9ec62710e4a4d5d3e07a168d3c/rust-dev-nightly-x86_64-unknown-linux-gnu.tar.xz
extracting /home/njn/dev/rustc-perf-tmp/rust/build/cache/llvm-68ca579406f2fa9ec62710e4a4d5d3e07a168d3c-False/rust-dev-nightly-x86_64-unknown-linux-gnu.tar.xz
[TIMING] Assemble { target_compiler: Compiler { stage: 0, host: TargetSelection { triple: &quot;x86_64-unknown-linux-gnu&quot;, file: None } } } -- 0.000
[TIMING] StartupObjects { compiler: Compiler { stage: 0, host: TargetSelection { triple: &quot;x86_64-unknown-linux-gnu&quot;, file: None } }, target: TargetSelection { triple: &quot;x86_64-unknown-linux-gnu&quot;, file: None } } -- 0.000
[TIMING] Sysroot { compiler: Compiler { stage: 0, host: TargetSelection { triple: &quot;x86_64-unknown-linux-gnu&quot;, file: None } } } -- 0.000
[TIMING] Libdir { compiler: Compiler { stage: 0, host: TargetSelection { triple: &quot;x86_64-unknown-linux-gnu&quot;, file: None } }, target: TargetSelection { triple: &quot;x86_64-unknown-linux-gnu&quot;, file: None } } -- 0.000
Building stage0 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)
Build completed unsuccessfully in 0:01:05


15 benchmarks remaining
Preparing serde
Running serde: Check + [Full, IncrFull, IncrUnchanged, IncrPatched]
Running serde: Debug + [Full, IncrFull, IncrUnchanged, IncrPatched]
Running serde: Opt + [Full, IncrFull, IncrUnchanged, IncrPatched]
</code></pre></div>



<a name="261185834"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261185834" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261185834">(Nov 11 2021 at 21:21)</a>:</h4>
<p>I end up with a <code>rust</code> dir within <code>rustc-perf</code>.</p>



<a name="261185952"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261185952" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261185952">(Nov 11 2021 at 21:22)</a>:</h4>
<p>I don't know what's going on. The weirdness occurs between <code>ripgrep</code> and <code>serde</code>, which makes me wonder if it's somehow related to <code>rust-mozjs</code>'s presence.</p>



<a name="261186080"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261186080" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261186080">(Nov 11 2021 at 21:24)</a>:</h4>
<p>I think that's the step where it tries to get timing information for rustc bootstrap.</p>



<a name="261186081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261186081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261186081">(Nov 11 2021 at 21:24)</a>:</h4>
<p><a href="https://github.com/rust-lang/rustc-perf/blob/master/collector/src/execute/rustc.rs#L25">https://github.com/rust-lang/rustc-perf/blob/master/collector/src/execute/rustc.rs#L25</a></p>



<a name="261186365"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261186365" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wesley Wiser <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261186365">(Nov 11 2021 at 21:27)</a>:</h4>
<p>Yeah, looks like we have a "rustc" benchmark that calls that code. <a href="https://github.com/rust-lang/rustc-perf/blob/de39bd2e01e95897e3e314de1ee10e6f0aa9019e/collector/src/execute.rs#L1349">https://github.com/rust-lang/rustc-perf/blob/de39bd2e01e95897e3e314de1ee10e6f0aa9019e/collector/src/execute.rs#L1349</a></p>



<a name="261186394"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261186394" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261186394">(Nov 11 2021 at 21:27)</a>:</h4>
<p>Aha, so I can use <code>--exclude rustc</code> locally</p>



<a name="261186422"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261186422" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261186422">(Nov 11 2021 at 21:28)</a>:</h4>
<p>Perhaps this should be cleaned up, but thanks for the pointer!</p>



<a name="261186517"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261186517" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261186517">(Nov 11 2021 at 21:29)</a>:</h4>
<p>So I'm guessing this is somehow a special benchmark that's different to the others. I'll take a look, try to work out the mechanism</p>



<a name="261186711"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261186711" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261186711">(Nov 11 2021 at 21:31)</a>:</h4>
<p>Right, so the second link from <span class="user-mention" data-user-id="125250">@Wesley Wiser</span> is where it's run, and here is where it gets added to the list of benchmarks: <a href="https://github.com/rust-lang/rustc-perf/blob/de39bd2e01e95897e3e314de1ee10e6f0aa9019e/collector/src/main.rs#L369">https://github.com/rust-lang/rustc-perf/blob/de39bd2e01e95897e3e314de1ee10e6f0aa9019e/collector/src/main.rs#L369</a></p>



<a name="261744558"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261744558" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261744558">(Nov 17 2021 at 05:10)</a>:</h4>
<p>Back on this topic: am I right to think that <code>bench_next</code> is the only subcommand where we actually want to run the "rustc" benchmark? <code>bench_local</code> is for local benchmarking and I don't think "rustc" should run there. <code>bench_published</code> is for <a href="https://perf.rust-lang.org/dashboard.html">https://perf.rust-lang.org/dashboard.html</a> and "rustc" also isn't relevant there.</p>



<a name="261767256"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261767256" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Gemmell <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261767256">(Nov 17 2021 at 10:38)</a>:</h4>
<p>bumping up <code>RUST_LOG</code> makes the execution of collector a lot more understandable. I did make some changes there a while back that should stop this <code>ID</code> issue from failing the whole collector run (it should default to <code>origin/HEAD</code> now)</p>



<a name="261767281"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261767281" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Gemmell <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261767281">(Nov 17 2021 at 10:39)</a>:</h4>
<p><a href="https://perf.rust-lang.org/bootstrap.html">https://perf.rust-lang.org/bootstrap.html</a> is where the bootstrap timings go - they're definitely published</p>



<a name="261767942"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261767942" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Gemmell <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261767942">(Nov 17 2021 at 10:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/.60collector.20bench_local.60.20weirdness/near/261744558">said</a>:</p>
<blockquote>
<p><code>bench_local</code> is for local benchmarking and I don't think "rustc" should run there.</p>
</blockquote>
<p>why? It's still a valid data point. perhaps the README should be updated to explain this benchmark and explain how it can be skipped for quicker local runs</p>



<a name="261991800"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261991800" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261991800">(Nov 18 2021 at 21:15)</a>:</h4>
<p>The rustc benchmark was broken with <code>bench_local</code> when I last tried it a few days ago. And it confused the heck out of me, because I had no idea that this benchmark had been added, and it's kind of magical. If it's not broken now that's an improvement. But I still think for local profiling it's probably something that should be opted into.</p>



<a name="261992159"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261992159" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261992159">(Nov 18 2021 at 21:18)</a>:</h4>
<p>It would be great if it were less special in general. It only reports wall-times on perf.rlo instead of the different perf-stat results for example.</p>



<a name="261992973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261992973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> pnkfelix <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261992973">(Nov 18 2021 at 21:24)</a>:</h4>
<p>I’m glad I’m not the only one who finds that benchmark hard to work with. I spent some idle time over some number of weeks (months?) trying to figure out how to generalize the rustc benchmark to also cover incremental bootstrapping time (e.g. how much does editing a comment in rustc_xxx cost? How much does adding a <code>debug!</code> statement cost?). I eventually gave up. I probably should have been asking questions in here along the way.</p>



<a name="261997975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/261997975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#261997975">(Nov 18 2021 at 22:04)</a>:</h4>
<p>It's a unique benchmark kind in the sense that it collects for a bunch of different crates in one go, but yeah, it probably makes sense to invest in fine-tuning the collection to include other stats and such. It's mostly not done because of the rustc wrapper bootstrap requires (and since perf.rlo has its own, you can't as easily stack those).</p>



<a name="267151357"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/267151357" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#267151357">(Jan 07 2022 at 04:54)</a>:</h4>
<p>I just tried bench_local again, the <code>rustc</code> benchmark is still busted.</p>



<a name="267151463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/267151463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#267151463">(Jan 07 2022 at 04:57)</a>:</h4>
<p>Compile errors:</p>
<div class="codehilite"><pre><span></span><code>error[E0557]: feature has been removed
   --&gt; library/core/src/lib.rs:164:12
    |
164 | #![feature(doc_primitive)]
    |            ^^^^^^^^^^^^^ feature has been removed
    |
    = note: merged into `#![feature(rustdoc_internals)]`

error[E0277]: the trait bound `[u8; 768]: Clone` is not satisfied
   --&gt; library/core/src/num/dec2flt/decimal.rs:23:5
    |
14  |   #[derive(Clone)]
    |            ----- in this derive macro expansion
...
23  |       pub digits: [u8; Self::MAX_DIGITS],
    |       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `Clone` is not implemented for `[u8; 768]`
    |
   ::: library/core/src/clone.rs:139:1
    |
139 | / pub macro Clone($item:item) {
140 | |     /* compiler built-in */
141 | | }
    | |_- in this expansion of `#[derive(Clone)]`
</code></pre></div>
<p>plus a few more like that second <code>Clone</code> one</p>



<a name="267153467"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/267153467" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#267153467">(Jan 07 2022 at 05:36)</a>:</h4>
<p>I created a PR to restrict the <code>rustc</code> benchmark to the <code>bench_next</code> subcommand: <a href="https://github.com/rust-lang/rustc-perf/pull/1139">https://github.com/rust-lang/rustc-perf/pull/1139</a></p>



<a name="267194581"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/267194581" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adam Gemmell <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#267194581">(Jan 07 2022 at 14:26)</a>:</h4>
<p>fwiw, I've been running bootstrap performances on every nightly via <code>bench_local</code> and haven't seen this issue, so it doesn't seem to be fundamentally broken.</p>
<p>couple potential ideas:</p>
<ul>
<li>Delete the <code>rust/</code> checkout the collector makes. Maybe it's stale and not being updated correctly.</li>
<li>Maybe the rustc under test can't compile the <code>rust-lang/rust</code> ref given as the run ID. You could rebase your branch or provide a ref close to the base of your branch</li>
</ul>



<a name="267374277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/267374277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#267374277">(Jan 09 2022 at 19:51)</a>:</h4>
<p>Deleting the <code>rust</code> directory fixed it, thanks!</p>



<a name="267374328"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/267374328" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#267374328">(Jan 09 2022 at 19:52)</a>:</h4>
<p>Good to know you run this often. I have what I think is a better idea: to exclude <code>rustc</code> from the normal list of benchmarks, but add a <code>--bench-rustc</code> option to <code>bench_local</code> and <code>bench_next</code> that opts into it.</p>



<a name="267374353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/267374353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#267374353">(Jan 09 2022 at 19:53)</a>:</h4>
<p>I like this because the rustc benchmark is very different from the others, so it's good to treat it differently. E.g. it would be excluded from <code>--include</code>/<code>--exclude</code> handling</p>



<a name="267385685"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60collector%20bench_local%60%20weirdness/near/267385685" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60collector.20bench_local.60.20weirdness.html#267385685">(Jan 10 2022 at 00:24)</a>:</h4>
<p>I've done this in <a href="https://github.com/rust-lang/rustc-perf/pull/1140">https://github.com/rust-lang/rustc-perf/pull/1140</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>