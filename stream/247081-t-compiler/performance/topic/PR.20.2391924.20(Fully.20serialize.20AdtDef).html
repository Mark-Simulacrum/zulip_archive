<html>
<head><meta charset="utf-8"><title>PR #91924 (Fully serialize AdtDef) · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391924.20(Fully.20serialize.20AdtDef).html">PR #91924 (Fully serialize AdtDef)</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="265423051"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391924%20%28Fully%20serialize%20AdtDef%29/near/265423051" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aaron Hill <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391924.20(Fully.20serialize.20AdtDef).html#265423051">(Dec 18 2021 at 15:03)</a>:</h4>
<p>I've having trouble understanding where the regression on <a href="https://github.com/rust-lang/rust/pull/91924">https://github.com/rust-lang/rust/pull/91924</a> on webrender-wrench is coming from. On the comparison page, there doesn't seem to be anything significantly slower for the new run</p>



<a name="265423220"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391924%20%28Fully%20serialize%20AdtDef%29/near/265423220" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391924.20(Fully.20serialize.20AdtDef).html#265423220">(Dec 18 2021 at 15:06)</a>:</h4>
<p>hm -- I'm for some reason not seeing data for webrender-wrench in opt/debug/doc</p>



<a name="265423614"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391924%20%28Fully%20serialize%20AdtDef%29/near/265423614" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391924.20(Fully.20serialize.20AdtDef).html#265423614">(Dec 18 2021 at 15:15)</a>:</h4>
<p>in any case, locally it looks like the increased instruction counts are in DepKind decoding</p>



<a name="265423621"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391924%20%28Fully%20serialize%20AdtDef%29/near/265423621" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391924.20(Fully.20serialize.20AdtDef).html#265423621">(Dec 18 2021 at 15:15)</a>:</h4>
<div class="codehilite"><pre><span></span><code> 8,047,994  ???:&lt;rustc_middle::dep_graph::dep_node::DepKind as rustc_serialize::serialize::Decodable&lt;rustc_serialize::opaque::Decoder&gt;&gt;::decode
-2,597,076  ???:&lt;rustc_query_system::dep_graph::serialized::SerializedDepGraph&lt;rustc_middle::dep_graph::dep_node::DepKind&gt; as rustc_serialize::serialize::Decodable&lt;rustc_serialize::opaque::Decoder&gt;&gt;::decode
   986,284  ???:&lt;hashbrown::raw::RawTable&lt;(rustc_span::def_id::DefId, rustc_span::def_id::DefId)&gt;&gt;::insert::&lt;hashbrown::map::make_hasher&lt;rustc_span::def_id::DefId, rustc_span::def_id::DefId, rustc_span::def_id::&gt;
  -626,270  ???:&lt;rustc_query_impl::on_disk_cache::CacheDecoder as rustc_serialize::serialize::Decoder&gt;::read_map::&lt;std::collections::hash::map::HashMap&lt;rustc_span::def_id::DefId, rustc_span::def_id::DefId, core:&gt;
  -408,025  ???:&lt;rustc_metadata::creader::CStore as rustc_session::cstore::CrateStore&gt;::stable_crate_id_to_crate_num
   365,597  ???:&lt;alloc::rc::Rc&lt;alloc::vec::Vec&lt;(rustc_ast::tokenstream::TokenTree, rustc_ast::tokenstream::Spacing)&gt;&gt; as core::ops::drop::Drop&gt;::drop
  -343,697  ???:&lt;alloc::vec::Vec&lt;(rustc_ast::tokenstream::TokenTree, rustc_ast::tokenstream::Spacing)&gt; as core::ops::drop::Drop&gt;::drop
  -178,323  ???:&lt;&amp;rustc_middle::ty::TyS as rustc_serialize::serialize::Encodable&lt;rustc_query_impl::on_disk_cache::CacheEncoder&lt;rustc_serialize::opaque::FileEncoder&gt;&gt;&gt;::encode
  -154,728  ???:rustc_data_structures::stack::ensure_sufficient_stack::&lt;core::option::Option&lt;(rustc_middle::ty::generics::GenericPredicates, rustc_query_system::dep_graph::graph::DepNodeIndex)&gt;, rustc_query_syst&gt;
   153,891  ???:rustc_query_system::query::plumbing::incremental_verify_ich::&lt;rustc_query_impl::plumbing::QueryCtxt, rustc_span::def_id::DefId, rustc_middle::ty::generics::GenericPredicates&gt;
  -147,826  ???:&lt;rustc_typeck::check::wfcheck::CheckTypeWellFormedVisitor as rustc_hir::intravisit::Visitor&gt;::visit_ty
   106,926  ???:&lt;rustc_span::symbol::Symbol&gt;::intern
   104,858  ???:&lt;[rustc_middle::ty::subst::GenericArg] as rustc_serialize::serialize::Encodable&lt;rustc_query_impl::on_disk_cache::CacheEncoder&lt;rustc_serialize::opaque::FileEncoder&gt;&gt;&gt;::encode
   100,986  ???:rustc_hir::intravisit::walk_ty::&lt;rustc_typeck::check::wfcheck::CheckTypeWellFormedVisitor&gt;
    84,725  ???:&lt;rustc_parse::parser::Parser&gt;::is_import_coupler
    74,683  ???:&lt;rustc_typeck::check::wfcheck::CheckTypeWellFormedVisitor as rustc_hir::intravisit::Visitor&gt;::visit_path
   -67,316  ???:&lt;rustc_middle::dep_graph::dep_node::DepKind as rustc_query_system::dep_graph::DepKind&gt;::read_deps::&lt;&lt;rustc_query_system::dep_graph::graph::DepGraph&lt;rustc_middle::dep_graph::dep_node::DepKind&gt;&gt;::r&gt;
   -56,942  ???:&lt;rustc_data_structures::sorted_map::index_map::SortedIndexMultiMap&lt;u32, rustc_span::symbol::Symbol, &amp;rustc_middle::ty::assoc::AssocItem&gt; as rustc_data_structures::stable_hasher::HashStable&lt;rustc_&gt;
    56,942  ???:&lt;rustc_index::vec::IndexVec&lt;u32, (rustc_span::symbol::Symbol, &amp;rustc_middle::ty::assoc::AssocItem)&gt; as rustc_data_structures::stable_hasher::HashStable&lt;rustc_query_system::ich::hcx::StableHashing&gt;
   -54,642  ???:&lt;rustc_parse::parser::Parser&gt;::parse_stmt_path_start
    52,975  ???:&lt;rustc_parse::parser::Parser&gt;::parse_outer_attributes
    52,714  ???:rustc_query_system::query::plumbing::incremental_verify_ich::&lt;rustc_query_impl::plumbing::QueryCtxt, rustc_span::def_id::LocalDefId, &amp;std::collections::hash::set::HashSet&lt;rustc_span::def_id::Loca&gt;
   -49,205  ???:&lt;alloc::rc::Rc&lt;rustc_ast::token::Nonterminal&gt; as core::ops::drop::Drop&gt;::drop
   -45,953  ???:&lt;hashbrown::raw::RawIterHash&lt;((usize, usize), rustc_data_structures::fingerprint::Fingerprint)&gt; as core::iter::traits::iterator::Iterator&gt;::next
    38,850  ???:&lt;rustc_middle::dep_graph::dep_node::DepKind as rustc_query_system::dep_graph::DepKind&gt;::with_deps::&lt;rustc_query_system::query::plumbing::try_load_from_disk_and_cache_in_memory&lt;rustc_query_impl::p&gt;
   -38,075  ???:&lt;rustc_data_structures::sip128::SipHasher128&gt;::slice_write_process_buffer
   -36,826  ???:&lt;rustc_query_system::dep_graph::graph::DepGraph&lt;rustc_middle::dep_graph::dep_node::DepKind&gt;&gt;::prev_fingerprint_of
   -32,220  ???:&lt;rustc_query_system::dep_graph::graph::DepGraph&lt;rustc_middle::dep_graph::dep_node::DepKind&gt;&gt;::is_green
   -31,429  ???:&lt;rustc_span::symbol::Ident as rustc_serialize::serialize::Decodable&lt;rustc_metadata::rmeta::decoder::DecodeContext&gt;&gt;::decode
    31,122  ???:&lt;rustc_data_structures::sip128::SipHasher128&gt;::short_write_process_buffer::&lt;u64&gt;
    30,722  /build/glibc-eX1tMB/glibc-2.31/elf/dl-lookup.c:_dl_lookup_symbol_x
    30,040  ???:&lt;rustc_typeck::check::wfcheck::CheckTypeWellFormedVisitor as rustc_hir::intravisit::Visitor&gt;::visit_generic_args
    28,697  ???:core::ptr::drop_in_place::&lt;rustc_ast::token::Nonterminal&gt;
    27,451  ???:core::slice::sort::recurse::&lt;(rustc_span::def_id::DefPathHash, &amp;rustc_span::def_id::DefId), &lt;[(rustc_span::def_id::DefPathHash, &amp;rustc_span::def_id::DefId)]&gt;::sort_unstable_by&lt;rustc_data_structur&gt;
   -24,544  ???:rustc_hir::intravisit::walk_path::&lt;rustc_typeck::check::wfcheck::CheckTypeWellFormedVisitor&gt;
</code></pre></div>



<a name="265423673"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/PR%20%2391924%20%28Fully%20serialize%20AdtDef%29/near/265423673" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/PR.20.2391924.20(Fully.20serialize.20AdtDef).html#265423673">(Dec 18 2021 at 15:16)</a>:</h4>
<p>but it seems ok to move ahead for now.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>