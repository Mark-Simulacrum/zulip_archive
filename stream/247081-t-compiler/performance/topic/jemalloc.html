<html>
<head><meta charset="utf-8"><title>jemalloc · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html">jemalloc</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="263958722"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263958722" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263958722">(Dec 07 2021 at 04:58)</a>:</h4>
<p>As far as I can tell:</p>
<ul>
<li>By default rustc is not built with jemalloc.</li>
<li>But if you specify <code>[rust] jemalloc = true</code> in <code>config.toml</code> jemalloc is used</li>
<li>The compiler uses the <code>tikv-jemallocator</code> crate, which is "is a simplified fork of jemallocator focus on server", according to its docs. (What does that mean?)</li>
</ul>



<a name="263958758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263958758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263958758">(Dec 07 2021 at 04:59)</a>:</h4>
<p>I just tried turning it on, I get widespread perf improvements of up to 10% instruction counts, and even more for cycles.</p>



<a name="263958810"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263958810" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263958810">(Dec 07 2021 at 05:00)</a>:</h4>
<p>IIRC it was the default in the past, why did this change?</p>



<a name="263960276"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960276" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960276">(Dec 07 2021 at 05:26)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> Almost all of the prebuilt rustc distributions enable jemalloc.   The default used to be that all rust programs used jemalloc, but that was changed in <a href="https://github.com/rust-lang/rust/issues/55238">#55238</a> (because it was huge IIRC).</p>



<a name="263960292"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960292" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960292">(Dec 07 2021 at 05:26)</a>:</h4>
<p>(at least the pre-built rustc distributed by rust-lang, I don't know what distros do)</p>



<a name="263960316"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960316" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960316">(Dec 07 2021 at 05:27)</a>:</h4>
<p>Yes, I think that was a reasonable decision as the default for all Rust programs.</p>



<a name="263960326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960326">(Dec 07 2021 at 05:27)</a>:</h4>
<p>But for the compiler itself, which is already big...</p>



<a name="263960334"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960334" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960334">(Dec 07 2021 at 05:27)</a>:</h4>
<p>What does "prebuilt rustc distributions" mean?</p>



<a name="263960414"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960414" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960414">(Dec 07 2021 at 05:29)</a>:</h4>
<p>I mean the rustc distributed by rustup.</p>



<a name="263960425"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960425" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960425">(Dec 07 2021 at 05:29)</a>:</h4>
<p>I guess I shouldn't say most of them.  x86 linux and macos use jemalloc.</p>



<a name="263960452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960452">(Dec 07 2021 at 05:29)</a>:</h4>
<p>Do you know about the builds for CI perf runs, do they use jemalloc?</p>



<a name="263960603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960603">(Dec 07 2021 at 05:32)</a>:</h4>
<p>I would assume they do, but I don't know much about perf.  IIRC, it uses a normal linux dist build, so it should.</p>



<a name="263960734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960734">(Dec 07 2021 at 05:34)</a>:</h4>
<p>Hmm, I don't see any jemalloc symbols in my installed <code>rustc</code> on Linux</p>



<a name="263960745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263960745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Thom Chiovoloni <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263960745">(Dec 07 2021 at 05:34)</a>:</h4>
<p>If you're investingating allocators, it's perhaps worth noting: not too long ago there was some experimentation about using mimalloc, and it looked very promising over jemalloc (perf numbers are in here: <a href="https://github.com/rust-lang/rust/pull/81782">https://github.com/rust-lang/rust/pull/81782</a> ).</p>
<p>People who know more about jemalloc than I were arguing that this is because using jemalloc to override system malloc/free is not ideal (jemalloc really wants to know size in the deallocator), but when I looked it seemed ...difficult to change, given how many allocations come from inside llvm.</p>
<p>I don't know exactly what happened here, but if you're looking at this, it's possibly worth figuring out if this change is worth it. My Those numbers are relatively close to my own experience with mimalloc vs jemalloc (switching to mimalloc often gave boosts on the order of ~5-10% across the whole application — but it was a while ago and was with jemallocator (not tikv's) so maybe that helps explain).</p>



<a name="263961835"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263961835" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eric Huss <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263961835">(Dec 07 2021 at 05:54)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> The jemalloc symbols are prefixed on linux with rjem.  <code>nm $(rustup which rustc) | grep rjem</code> should show a bunch</p>



<a name="263964197"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263964197" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263964197">(Dec 07 2021 at 06:38)</a>:</h4>
<p>I see, thanks! I had tried <code>nm $(which rustc) | grep jem</code> and that gave me nothing</p>



<a name="263987978"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263987978" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263987978">(Dec 07 2021 at 11:30)</a>:</h4>
<p>To sum it up, Linux dist builds still use jemalloc through tikv-jemallocator as that was found to give nice improvements across the board: <a href="https://perf.rust-lang.org/compare.html?start=36f1f04f18b89ba4a999bcfd6584663fd6fc1c5d&amp;end=33fa9f15639c420e2e76b65192553337d67a7e0a">https://perf.rust-lang.org/compare.html?start=36f1f04f18b89ba4a999bcfd6584663fd6fc1c5d&amp;end=33fa9f15639c420e2e76b65192553337d67a7e0a</a> <br>
This implementaion uses sized deallocation as one of the key changes.</p>



<a name="263988412"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263988412" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263988412">(Dec 07 2021 at 11:34)</a>:</h4>
<p>Thanks! I was wondering how tikv-jemallocator differed from jemallocator, good to have the explanation.</p>



<a name="263988667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263988667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263988667">(Dec 07 2021 at 11:37)</a>:</h4>
<p>If you want more details on how that was achieved you can look at my comment at <a href="https://github.com/rust-lang/rust/pull/83152#issuecomment-804717951">https://github.com/rust-lang/rust/pull/83152#issuecomment-804717951</a></p>
<blockquote>
<p>Those 2 lines <a href="https://github.com/rust-lang/rust/pull/83152/files#diff-43914724af6e464c1da2171e4a9b6c7e607d5bc1203fa95c0ab85be4122605efR3-R4">https://github.com/rust-lang/rust/pull/83152/files#diff-43914724af6e464c1da2171e4a9b6c7e607d5bc1203fa95c0ab85be4122605efR3-R4</a> lead to <a href="https://docs.rs/tikv-jemallocator/0.4.1/src/tikv_jemallocator/lib.rs.html#125">https://docs.rs/tikv-jemallocator/0.4.1/src/tikv_jemallocator/lib.rs.html#125</a>. sdallocx is sized deallocation.</p>
</blockquote>



<a name="263988870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/263988870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> mati865 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#263988870">(Dec 07 2021 at 11:39)</a>:</h4>
<p>Hmm, this made me wonder what happened to jemalloc. There are n new releases since mid 2019.</p>



<a name="264024683"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/264024683" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#264024683">(Dec 07 2021 at 16:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/jemalloc/near/263960452">said</a>:</p>
<blockquote>
<p>Do you know about the builds for CI perf runs, do they use jemalloc?</p>
</blockquote>



<a name="264025076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/264025076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#264025076">(Dec 07 2021 at 16:21)</a>:</h4>
<p>Perf uses try builds, which are built the same  way artifacts that get distributed are</p>



<a name="268620282"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268620282" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268620282">(Jan 19 2022 at 23:40)</a>:</h4>
<p>Revisiting this: so how is the configuration for try/distributed builds specified?</p>



<a name="268620289"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268620289" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268620289">(Jan 19 2022 at 23:40)</a>:</h4>
<p>And why isn't jemalloc=true on by default for local builds of rustc, given that it makes things much faster?</p>



<a name="268620707"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268620707" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268620707">(Jan 19 2022 at 23:46)</a>:</h4>
<p>most of it starts here <a href="https://github.com/rust-lang/rust/blob/5e57faa78aa7661c6000204591558f6665f11abc/src/ci/run.sh#L46">https://github.com/rust-lang/rust/blob/5e57faa78aa7661c6000204591558f6665f11abc/src/ci/run.sh#L46</a></p>



<a name="268620715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268620715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268620715">(Jan 19 2022 at 23:46)</a>:</h4>
<p>Q1: <a href="https://github.com/rust-lang/rust/blob/master/src/ci/docker/host-x86_64/dist-x86_64-linux/Dockerfile#L124">https://github.com/rust-lang/rust/blob/master/src/ci/docker/host-x86_64/dist-x86_64-linux/Dockerfile#L124</a><br>
Q2: I guess because it's not the default on all platforms and config.toml hasn't had platform-specific defaults, I think.</p>



<a name="268620756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268620756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268620756">(Jan 19 2022 at 23:47)</a>:</h4>
<p>I'd personally have no objections to a PR which turns it on locally by default on the platforms it works on (linux + macOS, I guess, to start)</p>



<a name="268623466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268623466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> cuviper <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268623466">(Jan 20 2022 at 00:16)</a>:</h4>
<p>Is that benefit still true against current glibc? I thought that gap was mostly closed</p>



<a name="268626033"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268626033" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268626033">(Jan 20 2022 at 00:48)</a>:</h4>
<p>It may depend on what "current glibc" means, but on my Ubuntu 21.10 box jemalloc is still much better, e.g. makes rustc 5-10% faster</p>



<a name="268626188"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268626188" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268626188">(Jan 20 2022 at 00:50)</a>:</h4>
<p>Maybe I should be setting <code>llvm.thin-lto=true</code> locally. (I build my own LLVM because I increase the debuginfo to get line numbers)</p>



<a name="268626221"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268626221" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268626221">(Jan 20 2022 at 00:51)</a>:</h4>
<div class="codehilite"><pre><span></span><code># Indicates whether LLVM should be built with ThinLTO. Note that this will
# only succeed if you use clang, lld, llvm-ar, and llvm-ranlib in your C/C++
# toolchain (see the `cc`, `cxx`, `linker`, `ar`, and `ranlib` options below).
# More info at: https://clang.llvm.org/docs/ThinLTO.html#clang-bootstrap
#thin-lto = false
</code></pre></div>



<a name="268626269"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268626269" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268626269">(Jan 20 2022 at 00:52)</a>:</h4>
<p>But that Dockerfile only sets <code>linker</code>, <code>ar</code>, and <code>ranlib</code>,hmm</p>



<a name="268628793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268628793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268628793">(Jan 20 2022 at 01:26)</a>:</h4>
<p>I think we set CC/CXX to clang independently</p>



<a name="268628812"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268628812" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268628812">(Jan 20 2022 at 01:26)</a>:</h4>
<p>ENV CC=clang CXX=clang++</p>



<a name="268628830"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268628830" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268628830">(Jan 20 2022 at 01:27)</a>:</h4>
<p>not sure on lld not being used, though.</p>



<a name="268631283"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268631283" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268631283">(Jan 20 2022 at 02:06)</a>:</h4>
<p>Other possible allocators to look into are mimalloc, rpmalloc, snmalloc. Source: <a href="https://lists.llvm.org/pipermail/llvm-dev/2020-July/143015.html">https://lists.llvm.org/pipermail/llvm-dev/2020-July/143015.html</a></p>



<a name="268648880"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268648880" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268648880">(Jan 20 2022 at 06:46)</a>:</h4>
<p>mimalloc seems to perform better on our benchmarks but still is a sizable max-rss regression (although one would expect it could improve things on windows ?). I have been trying snmalloc recently and it looks promising over jemalloc (but have not tested on macOS). Maybe tcmalloc is also worth trying.</p>



<a name="268683526"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268683526" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> The 8472 <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268683526">(Jan 20 2022 at 12:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="120989">nnethercote</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/jemalloc/near/268626033">said</a>:</p>
<blockquote>
<p>It may depend on what "current glibc" means, but on my Ubuntu 21.10 box jemalloc is still much better, e.g. makes rustc 5-10% faster</p>
</blockquote>
<p>And maybe the allocator settings?</p>



<a name="268743204"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268743204" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268743204">(Jan 20 2022 at 19:16)</a>:</h4>
<p>Is it currently possible for us to ship a rustc built with jemalloc (or mimalloc) while shipping std built with the system allocator, or is that not supported today?</p>



<a name="268743278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268743278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268743278">(Jan 20 2022 at 19:16)</a>:</h4>
<p>Because building rustc with an alternate allocator seems fine, but std needs to use the system allocator by default and let users decide what allocator they want for their programs.</p>



<a name="268743306"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268743306" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268743306">(Jan 20 2022 at 19:17)</a>:</h4>
<p>std is always using the default system allocator today</p>



<a name="268743326"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268743326" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268743326">(Jan 20 2022 at 19:17)</a>:</h4>
<p>(unless otherwise configured with global_allocator)</p>



<a name="268743355"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268743355" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268743355">(Jan 20 2022 at 19:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> Even in a jemalloc=true build? That's great.</p>



<a name="268743385"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/jemalloc/near/268743385" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/jemalloc.html#268743385">(Jan 20 2022 at 19:18)</a>:</h4>
<p>Yeah.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>