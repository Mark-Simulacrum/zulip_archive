<html>
<head><meta charset="utf-8"><title>`log` build script removal · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html">`log` build script removal</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274056144"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274056144" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274056144">(Mar 03 2022 at 23:27)</a>:</h4>
<p>I just filed an issue on <code>log</code> to remove its build script: <a href="https://github.com/rust-lang/log/issues/489">https://github.com/rust-lang/log/issues/489</a>. Details are in the issue.</p>



<a name="274056218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274056218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274056218">(Mar 03 2022 at 23:28)</a>:</h4>
<p>This is an interesting example of an improvement that isn't obvious when looking at crates in isolation, but fell out of the large scale data gathering and analysis.</p>



<a name="274056241"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274056241" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274056241">(Mar 03 2022 at 23:28)</a>:</h4>
<p>It seems like a pretty easy change, could be a good one for <span class="user-mention" data-user-id="481680">@Michael Wigard</span> or <span class="user-mention" data-user-id="266526">@Jakub Beránek</span></p>



<a name="274056819"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274056819" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274056819">(Mar 03 2022 at 23:33)</a>:</h4>
<p>FWIW, it might be worthwhile for them to wait for the stabilization of <code>cfg(target_has_atomic)</code> to show up in stable Rust: <a href="https://github.com/rust-lang/rust/issues/32976">https://github.com/rust-lang/rust/issues/32976</a></p>



<a name="274058339"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274058339" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274058339">(Mar 03 2022 at 23:51)</a>:</h4>
<p>Hm, it might also be a use case for the load store atomic cfg we discussed in lang</p>



<a name="274060678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274060678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274060678">(Mar 04 2022 at 00:16)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> Would that cover both the <code>has_atomics</code> and <code>atomic_cas</code> cases in <code>log</code>?</p>



<a name="274060846"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274060846" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274060846">(Mar 04 2022 at 00:18)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> <code>cfg(target_has_atomic)</code> would imply both.</p>
<p>We might potentially add a <code>target_has_atomic_load_store</code> or similar in the future, which would cover the case where <code>has_atomics</code> is true but <code>atomic_cas</code> is false; however, we haven't settled the question of whether we want to do that yet.</p>



<a name="274060904"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274060904" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274060904">(Mar 04 2022 at 00:19)</a>:</h4>
<p>Ok, sounds like it's probably not worth waiting on</p>



<a name="274060983"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274060983" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274060983">(Mar 04 2022 at 00:20)</a>:</h4>
<p>I'm suggesting that they might want to just replace all of both cfg instances with <code>cfg(target_has_atomic)</code>, which AFAICT will be stable soon.</p>



<a name="274061142"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274061142" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274061142">(Mar 04 2022 at 00:22)</a>:</h4>
<p>Ok, I've added a note to the issue about it, can be discussed when someone works on it</p>



<a name="274065303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274065303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274065303">(Mar 04 2022 at 01:12)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> Do you know if checking the rustc version in <code>#[cfg(...)]</code> has ever been discussed? That seems to be a common use case for which build scripts are currently used, especially for critical crates like <code>syn</code>.</p>



<a name="274065368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274065368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274065368">(Mar 04 2022 at 01:13)</a>:</h4>
<p>I.e. <a href="https://github.com/dtolnay/syn/blob/master/build.rs">https://github.com/dtolnay/syn/blob/master/build.rs</a> just does a few version tests plus one "is this nightly?" test</p>



<a name="274065446"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274065446" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274065446">(Mar 04 2022 at 01:14)</a>:</h4>
<p>Likewise <a href="https://github.com/serde-rs/serde/blob/master/serde_derive/build.rs">https://github.com/serde-rs/serde/blob/master/serde_derive/build.rs</a>, which does just two version checks</p>



<a name="274065745"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274065745" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274065745">(Mar 04 2022 at 01:19)</a>:</h4>
<p>Yes, it's been discussed -- in fact, is basically implemented IIRC</p>



<a name="274065758"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274065758" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274065758">(Mar 04 2022 at 01:19)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/64796">https://github.com/rust-lang/rust/issues/64796</a></p>



<a name="274069028"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274069028" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274069028">(Mar 04 2022 at 02:01)</a>:</h4>
<p>Lovely, thank you</p>



<a name="274069030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274069030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274069030">(Mar 04 2022 at 02:01)</a>:</h4>
<p>@lqd ^^^</p>



<a name="274089928"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274089928" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274089928">(Mar 04 2022 at 07:22)</a>:</h4>
<p>yay</p>



<a name="274093371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274093371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274093371">(Mar 04 2022 at 08:05)</a>:</h4>
<p>ah right right, it's still waiting on some progress for <code>cfg(accessible)</code></p>



<a name="274104341"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274104341" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274104341">(Mar 04 2022 at 09:46)</a>:</h4>
<p><span class="user-mention" data-user-id="116113">@lqd</span> FWIW, unblocking that doesn't require a full impl of <code>cfg(accessible(...))</code>, just an implementation of <code>cfg(accessible(::cratename::...))</code>, which compiler folks have said would be easier.</p>



<a name="274104530"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274104530" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274104530">(Mar 04 2022 at 09:48)</a>:</h4>
<p>good news indeed, thank you. maybe we could even help there</p>



<a name="274105478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274105478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274105478">(Mar 04 2022 at 09:56)</a>:</h4>
<p>That would be wonderful.</p>



<a name="274105523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274105523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274105523">(Mar 04 2022 at 09:57)</a>:</h4>
<p>I'm quite interested in seeing an implementation of that.</p>



<a name="274176561"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274176561" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274176561">(Mar 04 2022 at 19:20)</a>:</h4>
<p>I realized something unfortunate: even if <code>cfg(version)</code> shipped in 1.60, <code>syn</code> would be unable to use it until 1.60 is the MSRV, right? And that's likely to be years down the track?</p>



<a name="274176720"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274176720" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274176720">(Mar 04 2022 at 19:22)</a>:</h4>
<p>It's not obvious that <code>syn</code> needs to use a years-old version as its MSRV, but I don't know its MSRV policy.</p>



<a name="274176968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274176968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274176968">(Mar 04 2022 at 19:24)</a>:</h4>
<p>How much slower is compiling the build script as-is vs. an empty stub (fn main() {})? If the latter is even 10-15% faster, it might be worth using cfg(not(version)) or something to detect that version is supported and then almost not compiling the build script (or Cargo support for conditional build scripts).</p>



<a name="274180320"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274180320" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274180320">(Mar 04 2022 at 19:52)</a>:</h4>
<p>I haven't measured that specifically, but I suspect it won't help much, i.e. that the minimal file is not much faster than the existing build script</p>



<a name="274182160"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274182160" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274182160">(Mar 04 2022 at 20:07)</a>:</h4>
<p>Hmm, I'm really having trouble understanding the problem in <a href="https://github.com/rust-lang/log/pull/490">https://github.com/rust-lang/log/pull/490</a></p>



<a name="274185821"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274185821" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274185821">(Mar 04 2022 at 20:41)</a>:</h4>
<p><a href="https://github.com/rust-lang/rfcs/pull/2991">https://github.com/rust-lang/rfcs/pull/2991</a> seems relevant, at least</p>



<a name="274185975"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274185975" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274185975">(Mar 04 2022 at 20:43)</a>:</h4>
<p><span class="user-mention" data-user-id="239881">@Josh Triplett</span> I seem to recall a lang meeting around that RFC where it was felt that the components <em>should</em> always be present in various target_ bits - I'm a little surprised that's not the case here</p>



<a name="274186053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274186053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274186053">(Mar 04 2022 at 20:44)</a>:</h4>
<p>I will say that as a tier-3 target there's presumably ~zero usage on actual stable, so IMO it should be fine to rely on the newly-stabilized target_has_atomic family here, if possible</p>



<a name="274186070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274186070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274186070">(Mar 04 2022 at 20:44)</a>:</h4>
<p>I guess the fact that those were explicitly unstable (rather than just unknown) prior to 1.60(?) means that they can't actually be used?</p>



<a name="274186635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274186635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nnethercote <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274186635">(Mar 04 2022 at 20:51)</a>:</h4>
<p>Oh... I thought <code>target</code> was already a thing in <code>cfg</code></p>



<a name="274187431"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274187431" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274187431">(Mar 04 2022 at 20:58)</a>:</h4>
<p>It looks like this is only necessary for the set_logger API</p>



<a name="274187500"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274187500" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274187500">(Mar 04 2022 at 20:59)</a>:</h4>
<p>(Everything else in the crate is fine with just atomics, doesn't need CAS)</p>



<a name="274187510"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274187510" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274187510">(Mar 04 2022 at 20:59)</a>:</h4>
<p>Is thumbv4t the only problem?</p>



<a name="274187811"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274187811" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274187811">(Mar 04 2022 at 21:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/.60log.60.20build.20script.20removal/near/274185975">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> I seem to recall a lang meeting around that RFC where it was felt that the components <em>should</em> always be present in various target_ bits - I'm a little surprised that's not the case here</p>
</blockquote>
<p>I'm not sure what you mean by this, can you clarify?</p>



<a name="274187848"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274187848" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274187848">(Mar 04 2022 at 21:01)</a>:</h4>
<p>Do you mean that there's nothing that you should be able to do with <code>target</code> that you <em>can't</em> do with more specific cfg?</p>



<a name="274187919"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274187919" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274187919">(Mar 04 2022 at 21:02)</a>:</h4>
<p>I mean that I would expect something like target_arch=thumbv4t to be possible for thumbv4t-none-eabi; right now target_arch=arm for that target</p>



<a name="274187920"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274187920" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274187920">(Mar 04 2022 at 21:02)</a>:</h4>
<p>Yeah</p>



<a name="274188014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274188014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274188014">(Mar 04 2022 at 21:03)</a>:</h4>
<p>IIRC, the last state of that RFC was that we want the <code>target(abi = "...", os = "...", ...)</code> shorthand.</p>



<a name="274188105"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274188105" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274188105">(Mar 04 2022 at 21:04)</a>:</h4>
<p>Right, but it seems like that implies that is <em>enough</em>, which to differentiate thumbv4t-none-eabi from thumbv6m-none-eabi it isn't</p>



<a name="274188293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274188293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274188293">(Mar 04 2022 at 21:06)</a>:</h4>
<p>Hm. It looks like log's <a href="http://build.rs">build.rs</a> is wrong in any case:</p>
<ul>
<li>atomic_cas is set for thumbv4t-none-eabi, but rustc claims CAS is not supported for that target: <code>log</code> probably doesn't compile today for thumbv4t-none-eabi</li>
<li>target_has_atomics is false for thumbv4t-none-eabi, but the target <em>does</em> have atomics, just not CAS</li>
</ul>



<a name="274188371"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274188371" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274188371">(Mar 04 2022 at 21:07)</a>:</h4>
<p><span class="user-mention" data-user-id="120989">@nnethercote</span> so at least for thumbv4t-none-eabi it seems like making a change here is probably fine without a new major version of log, though someone should double check what I said -- maybe we can just break thumbv4t-none-eabi on older Rust compilers or something like that?</p>



<a name="274332503"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274332503" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274332503">(Mar 06 2022 at 22:40)</a>:</h4>
<p>ldrex/strex are available in ARMv6/thumb2 onwards. IIRC any attempts to utilize atomics would lower down to calls to a runtime/compiler-rt function on earlier revisions, which requires OS support of some sort to implement and will typically be implemented by disabling interrupts (possibly via syscall)</p>



<a name="274332592"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/274332592" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#274332592">(Mar 06 2022 at 22:43)</a>:</h4>
<p>CAS can be implemented in terms of <code>ldrex</code>/<code>strex</code>. So in general as far as Arm architectures are concerned, you either both have atomics and cas support or neither (at least not at an architectural level)</p>



<a name="276156772"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/276156772" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#276156772">(Mar 22 2022 at 08:38)</a>:</h4>
<p>Are build scripts that large of a problem if we switch to <code>lld</code> as planned? Even if enough <code>#[cfg(target)]</code> options are added, <code>log</code> will start using them in three years or so. Hopefully <code>lld</code> will be the default by then.</p>



<a name="276164636"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/276164636" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> lqd <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#276164636">(Mar 22 2022 at 10:01)</a>:</h4>
<p>lld helps a lot for all build dependencies (I have a check run with it that's arguably a close facsimile, but we could hack such a thing in the cargo profile and test it out) but when such a node is in the critical path, it's also the fact that the node is in the schedule in the first place, not only the time it takes (and it's scheduled twice, it needs to be built and then needs to execute) and that can delay the rest of the subgraph. </p>
<p>The rationale here was that if we could avoid them altogether it would ofc be faster than using lld :) For example, removing the build scripts in syn and proc-macro2 had noticeable improvements (but I can try to compare doing that with using lld if you want).</p>



<a name="276179890"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/276179890" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Laurențiu <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#276179890">(Mar 22 2022 at 12:22)</a>:</h4>
<p>I don't disagree that we should do both, but adding those <code>target</code> attributes and making <code>log</code> use them is a multi-year project.</p>



<a name="276252694"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/%60log%60%20build%20script%20removal/near/276252694" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nagisa <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/.60log.60.20build.20script.20removal.html#276252694">(Mar 22 2022 at 20:54)</a>:</h4>
<p>Build scripts in general are quite a significant of a problem with regards to build times, in my experience, yes.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>