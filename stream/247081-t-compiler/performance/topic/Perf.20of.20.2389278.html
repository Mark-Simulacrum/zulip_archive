<html>
<head><meta charset="utf-8"><title>Perf of #89278 · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html">Perf of #89278</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="270382662"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270382662" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270382662">(Feb 02 2022 at 13:26)</a>:</h4>
<p>Can some explain to me what <a href="https://github.com/rust-lang/rust/pull/89278">https://github.com/rust-lang/rust/pull/89278</a> is doing? The PR was closed in favor of two other PRs to control the perf regressions (<a href="https://github.com/rust-lang/rust/issues/93301">#93301</a> and <a href="https://github.com/rust-lang/rust/issues/93373">#93373</a>), and the perf impact was limited in those sub PRs, but I couldn't find an explanation of why the change was necessary in the first place. cc <span class="user-mention" data-user-id="116266">@Santiago Pastorino</span></p>



<a name="270382734"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270382734" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270382734">(Feb 02 2022 at 13:27)</a>:</h4>
<p>hi <span class="user-mention" data-user-id="224872">@rylev</span></p>



<a name="270382853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270382853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270382853">(Feb 02 2022 at 13:28)</a>:</h4>
<p>we've started taking pieces of that code in new PRs to see how much we could lower the perf regressions</p>



<a name="270382963"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270382963" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270382963">(Feb 02 2022 at 13:29)</a>:</h4>
<p>the change is needed to be able to make AST -&gt; HIR lowering incremental</p>



<a name="270383009"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270383009" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270383009">(Feb 02 2022 at 13:29)</a>:</h4>
<p>and it served me to make some refactors on RPITs that are needed to support RPITIT and at the end async fns in traits</p>



<a name="270383036"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270383036" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270383036">(Feb 02 2022 at 13:29)</a>:</h4>
<p>but the original motivation is to support incremental AST -&gt; HIR lowering</p>



<a name="270383104"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270383104" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270383104">(Feb 02 2022 at 13:30)</a>:</h4>
<p><a href="https://github.com/rust-lang/rust/issues/88186">#88186</a></p>



<a name="270383132"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270383132" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270383132">(Feb 02 2022 at 13:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Perf.20of.20.2389278/near/270382853">said</a>:</p>
<blockquote>
<p>we've started taking pieces of that code in new PRs to see how much we could lower the perf regressions</p>
</blockquote>
<p>Yep totally get that - and I see that the total regression was minimized which is great <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span>, but there is still a regression, and I didn't see any written justification for why a regression is still acceptable in this case</p>
<p>It would be awesome for you to just write this in the PR with the largest regression (<a href="https://github.com/rust-lang/rust/pull/93373">https://github.com/rust-lang/rust/pull/93373</a>) and then add the perf-regression-triaged label.</p>



<a name="270383182"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270383182" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270383182">(Feb 02 2022 at 13:31)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="124288">@oli</span> did write something somewhere ... <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="270383236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270383236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270383236">(Feb 02 2022 at 13:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/Perf.20of.20.2389278/near/270383182">said</a>:</p>
<blockquote>
<p>I think <span class="user-mention silent" data-user-id="124288">oli</span> did write something somewhere ... <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>
</blockquote>
<p>Ah I didn't see that. If you could point me to it, I'd love that. Then we just need to add the label.</p>



<a name="270383277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270383277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270383277">(Feb 02 2022 at 13:31)</a>:</h4>
<p><span class="user-mention" data-user-id="124288">@oli</span>? I remember you writing some stuff about this and adding <code>perf-regression-triaged</code></p>



<a name="270383303"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270383303" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270383303">(Feb 02 2022 at 13:32)</a>:</h4>
<p>but now I don't see that in the mentioned PR, maybe was in another one? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="270383345"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270383345" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270383345">(Feb 02 2022 at 13:32)</a>:</h4>
<p>We might want to add a @rust-timer justify command that attaches a link to that comment to the PR's comparison pages (easiest is just all of them, or latest, whatever)</p>



<a name="270384332"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270384332" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> oli <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270384332">(Feb 02 2022 at 13:38)</a>:</h4>
<p>I only wrote a comment in the one PR, but both of them remove a global untracked-by-incremental map that exists in TyCtxt. Such data frequently causes ICEs, and while we have not yet been able to observe any ICEs with these two cases, the very fact that they exist makes splitting up ast-&gt;hir lowering into queries impossible. The hope is that splitting lowering into queries will give us back more than we lost</p>



<a name="270386395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270386395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270386395">(Feb 02 2022 at 13:52)</a>:</h4>
<p>OK I made note of this in one of the PRs and added the triage label: <a href="https://github.com/rust-lang/rust/pull/93373#issuecomment-1027962065">https://github.com/rust-lang/rust/pull/93373#issuecomment-1027962065</a></p>



<a name="270386410"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/Perf%20of%20%2389278/near/270386410" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/Perf.20of.20.2389278.html#270386410">(Feb 02 2022 at 13:52)</a>:</h4>
<p>Thanks y'all!</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>