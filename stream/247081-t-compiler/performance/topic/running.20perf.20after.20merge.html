<html>
<head><meta charset="utf-8"><title>running perf after merge · t-compiler/performance · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/index.html">t-compiler/performance</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html">running perf after merge</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="258197853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258197853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258197853">(Oct 19 2021 at 13:52)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> is there anything preventing us from queuing an already merged PR (through a rollup) to see if it introduces performance issues? Is there any reason why this wouldn't already just work?</p>



<a name="258211891"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258211891" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258211891">(Oct 19 2021 at 15:10)</a>:</h4>
<p>not sure I follow</p>



<a name="258211927"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258211927" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258211927">(Oct 19 2021 at 15:10)</a>:</h4>
<p>we need artifacts, individual PRs in a rollup don't have them (and in theory aren't even guaranteed to build)</p>



<a name="258212781"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258212781" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258212781">(Oct 19 2021 at 15:15)</a>:</h4>
<p>I mean we could get bors to build them using the try mechanism</p>



<a name="258212960"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258212960" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258212960">(Oct 19 2021 at 15:16)</a>:</h4>
<p>yeah that's the partial support we have in-tree (pull-request-build command) and such, it doesn't get the commit list quite right today</p>



<a name="258213203"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258213203" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258213203">(Oct 19 2021 at 15:17)</a>:</h4>
<p>I think it may be worth considering the impact of having bors automatically enqueue try builds for all PRs merged via rollup, as-if they were merged in sequence (i.e., not trying to base them on master), with the goal of easing bisection and such</p>



<a name="258213973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258213973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258213973">(Oct 19 2021 at 15:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/running.20perf.20after.20merge/near/258212960">said</a>:</p>
<blockquote>
<p>yeah that's the partial support we have in-tree (pull-request-build command) and such, it doesn't get the commit list quite right today</p>
</blockquote>
<p>I think what I want is slightly different. I simply want bors to build the PR branch (just like we do for try builds). I'm not asking to fast forward the commits on top of the latest master</p>



<a name="258214048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258214048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258214048">(Oct 19 2021 at 15:21)</a>:</h4>
<p>But perhaps I'm miss understanding how the pull-request-build command works</p>



<a name="258214174"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258214174" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258214174">(Oct 19 2021 at 15:22)</a>:</h4>
<p>Individual PR test should only be needed if rollup has significant perf change, right?</p>



<a name="258215029"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258215029" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258215029">(Oct 19 2021 at 15:27)</a>:</h4>
<p>try builds rebase atop latest master?</p>



<a name="258215048"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258215048" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258215048">(Oct 19 2021 at 15:27)</a>:</h4>
<p>but regardless, yes, you want something a little different.</p>



<a name="258215107"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258215107" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258215107">(Oct 19 2021 at 15:27)</a>:</h4>
<p>(in the sense that what you want I think is the same goal just different means of achieving it)</p>



<a name="258216826"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258216826" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258216826">(Oct 19 2021 at 15:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/running.20perf.20after.20merge/near/258215029">said</a>:</p>
<blockquote>
<p>try builds rebase atop latest master?</p>
</blockquote>
<p>Ah this makes sense but I actually didn't realize this.</p>



<a name="258216947"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258216947" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258216947">(Oct 19 2021 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="303710">Gary Guo</span> <a href="#narrow/stream/247081-t-compiler.2Fperformance/topic/running.20perf.20after.20merge/near/258214174">said</a>:</p>
<blockquote>
<p>Individual PR test should only be needed if rollup has significant perf change, right?</p>
</blockquote>
<p>Yes I think we could automatically kick this off in the case that a perf change was found</p>



<a name="258217077"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258217077" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> rylev <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258217077">(Oct 19 2021 at 15:38)</a>:</h4>
<p>The issue is that it's often easier for a person to tell when a particular PR is definitely not to blame (e.g., only tests or markdown files were changed)</p>



<a name="258217794"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258217794" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258217794">(Oct 19 2021 at 15:42)</a>:</h4>
<p>I think doing it after the fact is actually probably somewhat harder than having it automatically happen on r+ for a rollup, but I could be wrong</p>



<a name="258217870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258217870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258217870">(Oct 19 2021 at 15:43)</a>:</h4>
<p>IIRC my thinking at one point was for rust-timer to actually queue these up itself, by setting up permissions appropriately and pushing to the right branch</p>



<a name="258218038"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258218038" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258218038">(Oct 19 2021 at 15:43)</a>:</h4>
<p>We can change the try command to:</p>
<ul>
<li>Check if the PR is already merged</li>
<li>If not, rebase on master</li>
<li>If merged, find the rollup merge commit, and rebase on its parent</li>
</ul>



<a name="258218471"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258218471" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258218471">(Oct 19 2021 at 15:46)</a>:</h4>
<p>that... seems a bit excessive to try to put into try</p>



<a name="258218578"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258218578" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258218578">(Oct 19 2021 at 15:46)</a>:</h4>
<p>I think doing this after the PR merges quickly runs into CI breakage trouble, especially if it's a while afterwards, and I don't think we benefit that much from trying to avoid some of the try builds</p>



<a name="258218862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258218862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258218862">(Oct 19 2021 at 15:48)</a>:</h4>
<p>What trouble?</p>



<a name="258218922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258218922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258218922">(Oct 19 2021 at 15:48)</a>:</h4>
<p>The parent commit should have its perf run available already</p>



<a name="258219472"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258219472" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258219472">(Oct 19 2021 at 15:51)</a>:</h4>
<p>a try build currently rebases on latest master, because we may have landed CI-fixing commits that will otherwise prevent running CI regardless of the state of the branch</p>



<a name="258219808"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258219808" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258219808">(Oct 19 2021 at 15:52)</a>:</h4>
<p>my recommendation would be to immediately run try build equivalents on r+ of a rollup for each of the contained PRs, though likely bypassing bors entirely -- we can have rustc-perf push directly to the appropriate branch and enqueue a build that way.</p>



<a name="258220179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258220179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258220179">(Oct 19 2021 at 15:54)</a>:</h4>
<p>If all PRs will be individually build anyway then probably the whole flow could be improved.</p>



<a name="258220214"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258220214" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258220214">(Oct 19 2021 at 15:55)</a>:</h4>
<p>E.g. try build all PRs regardless rollup</p>



<a name="258220432"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258220432" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gary Guo <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258220432">(Oct 19 2021 at 15:56)</a>:</h4>
<p>And then only consider a PR approved once try build is also completed</p>



<a name="258220675"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258220675" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258220675">(Oct 19 2021 at 15:57)</a>:</h4>
<p>well, you want to time it synchronous to the merge, basically</p>



<a name="258220753"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258220753" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258220753">(Oct 19 2021 at 15:57)</a>:</h4>
<p>but in theory, yes, you could also do this on r+ immediately</p>



<a name="258220787"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/247081-t-compiler/performance/topic/running%20perf%20after%20merge/near/258220787" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/247081-t-compiler/performance/topic/running.20perf.20after.20merge.html#258220787">(Oct 19 2021 at 15:57)</a>:</h4>
<p>which is probably ~80% good enough</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>