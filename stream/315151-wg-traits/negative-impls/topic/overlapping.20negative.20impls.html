<html>
<head><meta charset="utf-8"><title>overlapping negative impls · wg-traits/negative-impls · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/index.html">wg-traits/negative-impls</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html">overlapping negative impls</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="274459523"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274459523" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274459523">(Mar 07 2022 at 21:21)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// check-pass</span>

<span class="cp">#![feature(negative_impls)]</span><span class="w"></span>
<span class="cp">#![feature(with_negative_coherence)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">B</span>: <span class="nc">A</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="o">!</span><span class="n">A</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="o">!</span><span class="n">B</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="274459552"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274459552" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274459552">(Mar 07 2022 at 21:21)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span></p>



<a name="274459575"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274459575" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274459575">(Mar 07 2022 at 21:21)</a>:</h4>
<p>it's being a while since a don't touch negative impls :)</p>



<a name="274459595"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274459595" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274459595">(Mar 07 2022 at 21:22)</a>:</h4>
<p>we've talked about overlapping negative traits</p>



<a name="274459641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274459641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274459641">(Mar 07 2022 at 21:22)</a>:</h4>
<p>this example compiles</p>



<a name="274459706"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274459706" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274459706">(Mar 07 2022 at 21:22)</a>:</h4>
<p>may try out other kind of cases but I remember you wanted to check some overlapping examples, is there some specific one that comes to your mind?</p>



<a name="274460936"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274460936" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274460936">(Mar 07 2022 at 21:31)</a>:</h4>
<p>and there's this example ...</p>



<a name="274460968"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274460968" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274460968">(Mar 07 2022 at 21:31)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// check-pass</span>

<span class="cp">#![feature(negative_impls)]</span><span class="w"></span>
<span class="cp">#![feature(rustc_attrs)]</span><span class="w"></span>
<span class="cp">#![feature(with_negative_coherence)]</span><span class="w"></span>

<span class="k">trait</span><span class="w"> </span><span class="n">Trait1</span>: <span class="nc">Trait2</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">Trait2</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">MyType</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="o">!</span><span class="n">Trait2</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyType</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="cp">#[rustc_strict_coherence]</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">Trait1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyType</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>



<a name="274461019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274461019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274461019">(Mar 07 2022 at 21:31)</a>:</h4>
<p>where we get ...</p>



<a name="274461030"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274461030" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274461030">(Mar 07 2022 at 21:32)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0119]: conflicting implementations of trait `Foo` for type `MyType`
  --&gt; /home/spastorino/src/oss/rust1/src/test/ui/coherence/coherence-overlap-double-negative2.rs:16:1
   |
LL | impl&lt;T: Trait1&gt; Foo for T {}
   | ------------------------- first implementation here
LL | impl Foo for MyType {}
   | ^^^^^^^^^^^^^^^^^^^ conflicting implementation for `MyType`

error: aborting due to previous error

For more information about this error, try `rustc --explain E0119`.
</code></pre></div>



<a name="274461115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274461115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274461115">(Mar 07 2022 at 21:32)</a>:</h4>
<p>which clearly should work but doesn't :)</p>



<a name="274461344"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274461344" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274461344">(Mar 07 2022 at 21:34)</a>:</h4>
<p>so a couple of questions ...</p>



<a name="274461400"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274461400" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274461400">(Mar 07 2022 at 21:35)</a>:</h4>
<p>1) should this example work before stabilizing this?</p>



<a name="274461417"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274461417" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274461417">(Mar 07 2022 at 21:35)</a>:</h4>
<p>2) is there any other overlapping example that you can think of?</p>



<a name="274461847"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274461847" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274461847">(Mar 07 2022 at 21:39)</a>:</h4>
<p>3) a way to fix this overlapping example would be to check if any of its super traits have a negative impl, right?</p>



<a name="274534999"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274534999" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274534999">(Mar 08 2022 at 12:41)</a>:</h4>
<p>Question: what does <code>rustc_strict_coherence</code> do? Is it to make the coherence checker treat <code>MyType</code> as a remote/non-local type (so that lack of <code>impl Trait1 for MyType {}</code> does not imply <code>impl !Trait1 for MyType {}</code>?)</p>
<ul>
<li>(Aside: that could be a nifty tool for future-proofing the soundness of <code>pin_project</code>, so it could be worth considering keeping it around, later on, outside of <code>rustc_</code>-only usage)</li>
</ul>



<a name="274535374"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274535374" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274535374">(Mar 08 2022 at 12:45)</a>:</h4>
<p>Regarding <code>1)</code> (and/or <code>3)</code>?), from a <em>semver</em> / language semantics point of view, it does look that way to me: by definition <code>Trait1 : Trait2</code> states that we can rely on <code>T : Trait2</code> whenever <code>T :  Trait1</code>. Since the former is known never to hold, even in the future, for <code>MyType</code>, then the latter can't hold for it either. So <code>impl Foo for MyType {}</code> ought to be allowed.<br>
(I don't know how hard it would be to implement in the compiler though)</p>



<a name="274535970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274535970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Daniel Henry-Mantilla <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274535970">(Mar 08 2022 at 12:50)</a>:</h4>
<p>Regarding <code>3)</code>, I'd hope for negative impls to be allowed to overlap, since they're kind of a <code>#[marker]</code> property.<br>
It would be annoying if something like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="w"> </span>: <span class="nb">Copy</span><span class="o">&gt;</span><span class="w"> </span><span class="o">!</span><span class="n">Trait1</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w">   </span><span class="p">{}</span><span class="w"></span>
<span class="k">impl</span><span class="w">           </span><span class="o">!</span><span class="n">Trait2</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
</code></pre></div>
<p>were to be denied, imho.</p>



<a name="274562724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274562724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274562724">(Mar 08 2022 at 16:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315151-wg-traits.2Fnegative-impls/topic/overlapping.20negative.20impls/near/274459641">said</a>:</p>
<blockquote>
<p>this example compiles</p>
</blockquote>
<p>interesting example. I don't see a problem with it compiling, but it does make me wonder -- </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">B</span>: <span class="nc">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="o">!</span><span class="n">A</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#[rustc_strict_coherence]</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I expect this gets an error?</p>



<a name="274562769"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274562769" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274562769">(Mar 08 2022 at 16:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315151-wg-traits.2Fnegative-impls/topic/overlapping.20negative.20impls/near/274461115">said</a>:</p>
<blockquote>
<p>which clearly should work but doesn't :)</p>
</blockquote>
<p>oh, ok, I should have read more :)</p>



<a name="274562813"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274562813" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274562813">(Mar 08 2022 at 16:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="232018">Daniel Henry-Mantilla</span> <a href="#narrow/stream/315151-wg-traits.2Fnegative-impls/topic/overlapping.20negative.20impls/near/274534999">said</a>:</p>
<blockquote>
<p>Question: what does <code>rustc_strict_coherence</code> do? Is it to make the coherence checker treat <code>MyType</code> as a remote/non-local type (so that lack of <code>impl Trait1 for MyType {}</code> does not imply <code>impl !Trait1 for MyType {}</code>?)</p>
</blockquote>
<p>yes.</p>



<a name="274562966"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/274562966" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#274562966">(Mar 08 2022 at 16:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315151-wg-traits.2Fnegative-impls/topic/overlapping.20negative.20impls/near/274461847">said</a>:</p>
<blockquote>
<p>3) a way to fix this overlapping example would be to check if any of its super traits have a negative impl, right?</p>
</blockquote>
<p>yeah, we could add an implicit rule for <code>trait A: B</code> like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Implemented</span><span class="p">(</span><span class="n">T</span>: <span class="o">!</span><span class="n">A</span><span class="p">)</span><span class="w"> </span>:<span class="o">-</span><span class="w"> </span><span class="n">Implemented</span><span class="p">(</span><span class="n">T</span>: <span class="o">!</span><span class="n">B</span><span class="p">)</span><span class="w"></span>
</code></pre></div>



<a name="275303129"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275303129" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275303129">(Mar 14 2022 at 21:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/315151-wg-traits.2Fnegative-impls/topic/overlapping.20negative.20impls/near/274562724">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315151-wg-traits.2Fnegative-impls/topic/overlapping.20negative.20impls/near/274459641">said</a>:</p>
<blockquote>
<p>this example compiles</p>
</blockquote>
<p>interesting example. I don't see a problem with it compiling, but it does make me wonder -- </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">B</span>: <span class="nc">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="o">!</span><span class="n">A</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#[rustc_strict_coherence]</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">A</span><span class="o">&gt;</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>I expect this gets an error?</p>
</blockquote>
<p>this example compiles, why shouldn't it?</p>



<a name="275303219"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275303219" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275303219">(Mar 14 2022 at 21:54)</a>:</h4>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> sorry</p>



<a name="275303222"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275303222" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275303222">(Mar 14 2022 at 21:54)</a>:</h4>
<p>I messed up the example</p>



<a name="275303234"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275303234" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275303234">(Mar 14 2022 at 21:54)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">B</span>: <span class="nc">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="k">impl</span><span class="w"> </span><span class="o">!</span><span class="n">A</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="cp">#[rustc_strict_coherence]</span><span class="w"></span>
<span class="k">trait</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span>: <span class="nc">B</span><span class="o">&gt;</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="275303242"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275303242" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275303242">(Mar 14 2022 at 21:54)</a>:</h4>
<p>ahh let me try out just in case ...</p>



<a name="275303295"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275303295" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275303295">(Mar 14 2022 at 21:55)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0119]: conflicting implementations of trait `C` for type `u32`
  --&gt; src/test/ui/coherence/coherence-overlap-double-negative3.rs:15:1
   |
14 | impl C for u32 {}
   | -------------- first implementation here
15 | impl&lt;T: B&gt; C for T {}
   | ^^^^^^^^^^^^^^^^^^ conflicting implementation for `u32`

error: aborting due to previous error

For more information about this error, try `rustc --explain E0119`.
</code></pre></div>



<a name="275303390"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275303390" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275303390">(Mar 14 2022 at 21:56)</a>:</h4>
<p>I guess the error is not great but that one shouldn't compile</p>



<a name="275303466"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275303466" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275303466">(Mar 14 2022 at 21:57)</a>:</h4>
<p>not great in the sense of ... maybe this should point that <code>impl !A for u32 {}</code> exists and is what causes the error</p>



<a name="275401862"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275401862" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275401862">(Mar 15 2022 at 16:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116266">Santiago Pastorino</span> <a href="#narrow/stream/315151-wg-traits.2Fnegative-impls/topic/overlapping.20negative.20impls/near/275303390">said</a>:</p>
<blockquote>
<p>I guess the error is not great but that one shouldn't compile</p>
</blockquote>
<p><span class="user-mention" data-user-id="116266">@Santiago Pastorino</span> ideally, though, I think this one <em>would</em> compile (the second example)</p>



<a name="275401901"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275401901" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275401901">(Mar 15 2022 at 16:55)</a>:</h4>
<p>after all, there is no way to implement <code>B</code> for <code>u32</code> (since implementing <code>B</code> requires implementing <code>A</code>)</p>



<a name="275421970"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275421970" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275421970">(Mar 15 2022 at 19:12)</a>:</h4>
<p>ohh yeah, I've misread the example, <code>impl&lt;T: A&gt; C for T { }</code> this always hold unless when <code>T</code> if <code>u32</code> if there where an impl for <code>u32</code> it would fail but as is, is correct yeah</p>



<a name="275424293"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275424293" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275424293">(Mar 15 2022 at 19:33)</a>:</h4>
<p>should be relatively easy to fix, I imagine</p>



<a name="275548698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275548698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275548698">(Mar 16 2022 at 17:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="116009">nikomatsakis</span> <a href="#narrow/stream/315151-wg-traits.2Fnegative-impls/topic/overlapping.20negative.20impls/near/275424293">said</a>:</p>
<blockquote>
<p>should be relatively easy to fix, I imagine</p>
</blockquote>
<p>Niko, just in case, I guess this problem is the same we've already talked about, right?</p>



<a name="275548724"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275548724" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275548724">(Mar 16 2022 at 17:31)</a>:</h4>
<p>I meant, not considering super traits in the check</p>



<a name="275554631"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275554631" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> nikomatsakis <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275554631">(Mar 16 2022 at 18:09)</a>:</h4>
<p>right</p>



<a name="275577477"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275577477" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275577477">(Mar 16 2022 at 21:08)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> does this <a href="https://github.com/spastorino/rust/commit/5e058eda232456fbb3bf144b3a429f0e12651412">https://github.com/spastorino/rust/commit/5e058eda232456fbb3bf144b3a429f0e12651412</a> sound reasonable?</p>



<a name="275577485"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275577485" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275577485">(Mar 16 2022 at 21:08)</a>:</h4>
<p>just quickly tried it and doesn't work, need to debug it a bit :)</p>



<a name="275580067"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275580067" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275580067">(Mar 16 2022 at 21:31)</a>:</h4>
<p>ok, <code>super_predicates_of</code> is always empty</p>



<a name="275580527"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275580527" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275580527">(Mar 16 2022 at 21:36)</a>:</h4>
<p>unsure why :/</p>



<a name="275580761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275580761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275580761">(Mar 16 2022 at 21:38)</a>:</h4>
<p>What is the <code>DefId</code> here?</p>



<a name="275580815"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275580815" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jack Huey <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275580815">(Mar 16 2022 at 21:38)</a>:</h4>
<p>For <code>Trait1</code>?</p>



<a name="275581076"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275581076" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275581076">(Mar 16 2022 at 21:41)</a>:</h4>
<p>yes</p>



<a name="275581122"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275581122" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275581122">(Mar 16 2022 at 21:41)</a>:</h4>
<p>well this compares 2 impl headers</p>



<a name="275581218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275581218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275581218">(Mar 16 2022 at 21:42)</a>:</h4>
<p>def_id of the trait that's in the left of the equation but we equate, impl1, impl2 and impl2, impl1</p>



<a name="275583044"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275583044" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275583044">(Mar 16 2022 at 21:59)</a>:</h4>
<p>trait_ref is definitely wrong :)</p>



<a name="275585213"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275585213" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275585213">(Mar 16 2022 at 22:24)</a>:</h4>
<p>I guess we may want to grab the trait_ref from the obligation rather than use that one</p>



<a name="275668748"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/315151-wg-traits/negative-impls/topic/overlapping%20negative%20impls/near/275668748" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Santiago Pastorino <a href="https://zulip-archive.rust-lang.org/stream/315151-wg-traits/negative-impls/topic/overlapping.20negative.20impls.html#275668748">(Mar 17 2022 at 15:17)</a>:</h4>
<p><span class="user-mention" data-user-id="116009">@nikomatsakis</span> opened <a href="https://github.com/rust-lang/rust/issues/95039">#95039</a></p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>