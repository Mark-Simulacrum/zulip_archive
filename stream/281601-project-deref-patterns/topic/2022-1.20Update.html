<html>
<head><meta charset="utf-8"><title>2022-1 Update · project-deref-patterns · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/index.html">project-deref-patterns</a></h2>
<h3>Topic: <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html">2022-1 Update</a></h3>

<hr>

<base href="https://rust-lang.zulipchat.com">

<head><link href="https://zulip-archive.rust-lang.org/style.css" rel="stylesheet"></head>

<a name="269298973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/269298973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#269298973">(Jan 25 2022 at 18:12)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="257758">@Connor Horman</span> have you had a chance to look at this?  i'd be happy to help poke around at the code if you have any questions!</p>



<a name="269299042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/269299042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#269299042">(Jan 25 2022 at 18:13)</a>:</h4>
<p>If you don't have time for it, that's totally okay, too.</p>



<a name="269300421"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/269300421" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#269300421">(Jan 25 2022 at 18:22)</a>:</h4>
<p>Oh, I completely forgot. I'll get that opened up right now.</p>



<a name="269306656"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/269306656" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#269306656">(Jan 25 2022 at 19:02)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> Sweet! I'm so excited for this :)</p>



<a name="271332529"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271332529" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271332529">(Feb 09 2022 at 19:18)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> checking in again to see if there's anything I can help with!</p>



<a name="271339817"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271339817" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271339817">(Feb 09 2022 at 20:06)</a>:</h4>
<p>Sorry. Ended up getting busy with lccc's frontend <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>. I keep forgetting.</p>



<a name="271363236"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271363236" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271363236">(Feb 09 2022 at 23:27)</a>:</h4>
<p>No worries! I did some poking around myself. and it looks like this is the relevant bit of code that exists today: <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/pat.rs#L340">https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/pat.rs#L340</a></p>



<a name="271363359"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271363359" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271363359">(Feb 09 2022 at 23:28)</a>:</h4>
<p>It's currently set to strip specifically references, but we also want it to be able to strip types which implement <code>Deref</code>/<code>DerefMut</code>/<code>Box</code> (since <code>Box</code> is fancy/<code>DerefMove</code>)</p>



<a name="271363453"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271363453" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271363453">(Feb 09 2022 at 23:29)</a>:</h4>
<p>For dereferencing, there's some handy code in <code>autoderef.rs:overloaded_deref_ty</code> that I wonder if we could re-use.</p>



<a name="271364381"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271364381" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271364381">(Feb 09 2022 at 23:39)</a>:</h4>
<p>One thing that isn't totally clear to me is what the easiest way to calculate the resulting binding mode is. For example, if the resulting patterns bind a <code>mut ref</code> rather than a <code>ref</code>, we need to <code>.deref()</code> rather than <code>.deref_mut()</code>. However, this would both make the code more complex and mean that the actual code that runs at runtime would depend (<code>deref</code> vs <code>deref_mut</code>) on whether there was a <code>ref</code> vs a <code>mut ref</code> underneath, which doesn't feel great to me. Maybe I should get over it, but it feels clumsy.</p>
<p>An alternative, for now, could be to require that there is already an existing  non-by-value binding mode, then we can just use <code>Deref</code> if the binding mode is <code>BindByReference(hir::Mutability::Not)</code>, and <code>DerefMut</code> if the binding mode is <code>BindByReference(hir::Mutability::Mut)</code>. One side-effect of this would be that types which only implement <code>Deref</code> and not <code>DerefMut</code> wouldn't be able to be matched under a mutable binding mode, which is pretty surprising. Another option would be to fall back to <code>Deref</code> and shift the binding mode to <code>BindByReference(hir::Mutability::Not)</code>, but this would mean that adding a <code>DerefMut</code> impl to a type could break code by changing it to shift to a different binding mode, making <code>DerefMut</code> a kind of "fundamental" trait.</p>
<p>TBH none of these options feel super great to me :)</p>



<a name="271364650"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271364650" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271364650">(Feb 09 2022 at 23:42)</a>:</h4>
<p>There's a sort of sense to requiring the binding mode switch, though, which is that if you want to bind by-reference, you start with a reference, and if you want to bind by-mut, you start with a mutable reference. It isn't perfect by any means since you can't easily have different subpatterns with different binding modes, but that's already an issue with the existing binding modes setup.</p>



<a name="271364805"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271364805" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> simulacrum <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271364805">(Feb 09 2022 at 23:44)</a>:</h4>
<p>It seems like for many of the initial use-cases, a Deref-only support may suffice -- e.g., matching on String fields doesn't really benefit at all from DerefMut. Similarly a lot of the matches on Box I've seen don't actually want to mutate.</p>



<a name="271365416"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271365416" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271365416">(Feb 09 2022 at 23:50)</a>:</h4>
<p><span class="user-mention" data-user-id="116122">@simulacrum</span> <code>Box</code> is sort of an interesting special-case because we know that it implements <code>Deref + DerefMut + DerefMove</code> and that it's impls of those are "pure", so we don't really care about people doing weird side-effect-y things in the impls, and thus don't have to be concerned with about deciding which impl to call.</p>



<a name="271365518"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271365518" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271365518">(Feb 09 2022 at 23:51)</a>:</h4>
<p>But yeah, I think what I'm suggesting is initially you'd just have to write something like <code>match &amp;my_thing_in_box { ThingInBox { ... } }</code> rather than being able to do <code>match my_thing_in_box { ThingInBox { ... } }</code> and have the compiler "figure out" that you wanted a move vs. ref vs. ref mut</p>



<a name="271370655"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271370655" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271370655">(Feb 10 2022 at 00:38)</a>:</h4>
<p>Also somewhat annoying is that the existing <code>AdjustMode</code> calculation no longer works, as it would naively tell us to Peel off all ADTs that implement Deref, when you could easily have a pattern that matched one of them.</p>



<a name="271372600"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271372600" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271372600">(Feb 10 2022 at 01:02)</a>:</h4>
<p>Or, for example, how the existing code doesn't peel off any references when matching against a reference-typed literal pattern, such as a string or byte-slice literals. We <em>definitely</em> need to do stripping of Derefs in that case, as that's exactly what's needed to make <code>match &amp;my_string { "some_string" =&gt; { ... }}</code> work (aside: that's a case where it's particularly annoying that you need the initial <code>&amp;</code>...)</p>



<a name="271383100"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271383100" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271383100">(Feb 10 2022 at 03:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271365416">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="116122">simulacrum</span> <code>Box</code> is sort of an interesting special-case because we know that it implements <code>Deref + DerefMut + DerefMove</code> and that it's impls of those are "pure", so we don't really care about people doing weird side-effect-y things in the impls, and thus don't have to be concerned with about deciding which impl to call.</p>
</blockquote>
<p>Note that all of the applicable types in the MVP will be. An explicit idea was that the implementation could be clever about which Deref functions it's calling, when, and how many times. It's currently limited to a subset of standard library types.</p>



<a name="271480973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271480973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271480973">(Feb 10 2022 at 19:21)</a>:</h4>
<blockquote>
<p>It's currently limited to a subset of standard library types</p>
</blockquote>
<p>TBH I had completely forgotten this was scoped that way</p>



<a name="271481452"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271481452" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271481452">(Feb 10 2022 at 19:24)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> is there a doc on this somewhere, or is this just collected from past conversations? I looked at <a href="https://github.com/rust-lang/project-deref-patterns">the project group repo</a> but couldn't find details. <code>Box</code> is straightforward, but I think the issues I'm talking about all exist for Vec, String, Rc, and Arc, since none of them currently provide a by-move deref operator, but at least <code>Vec</code> and <code>String</code> could, theoretically.</p>



<a name="271481516"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271481516" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271481516">(Feb 10 2022 at 19:25)</a>:</h4>
<p>and <code>Rc</code> and <code>Arc</code> you could imagine having by-move semantics which would work if their contents are copy types</p>



<a name="271481593"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271481593" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271481593">(Feb 10 2022 at 19:25)</a>:</h4>
<p>that is <code>match Rc::new(MyStruct(5)) { MyStruct(x) =&gt; { ... } }</code> what is the type of <code>x</code>?</p>



<a name="271481697"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271481697" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271481697">(Feb 10 2022 at 19:26)</a>:</h4>
<p>I can see arguments for it either being <code>i32</code> or <code>&amp;i32</code> (based on whether you think <code>Rc</code> should behave similar to <code>Box</code> or whether it should behave similar to <code>&amp;</code>)</p>



<a name="271481868"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271481868" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271481868">(Feb 10 2022 at 19:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271481452">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> is there a doc on this somewhere, or is this just collected from past conversations? I looked at <a href="https://github.com/rust-lang/project-deref-patterns">the project group repo</a> but couldn't find details. <code>Box</code> is straightforward, but I think the issues I'm talking about all exist for Vec, String, Rc, and Arc, since none of them currently provide a by-move deref operator, but at least <code>Vec</code> and <code>String</code> could, theoretically.</p>
</blockquote>
<p>It's kinda all over the place. Really the best source is the lang-team conversations (88 and 77 IIRC), and the hackmd linked in 77.</p>



<a name="271481982"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271481982" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271481982">(Feb 10 2022 at 19:28)</a>:</h4>
<p>For <code>Vec</code>, I'd imagine the behavior we'd <em>want</em>, but would not be trivial to implement, would be for it to behave like <code>Box&lt;[T]&gt;</code>, which would mean that you could do <code>match vec!["foo".to_string()] { [x] =&gt; { ... } _ =&gt; { ... }</code> and have <code>x</code> be a <code>String</code>, not an <code>&amp;String</code>.</p>



<a name="271482023"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482023" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482023">(Feb 10 2022 at 19:28)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> Got it. I remember having those discussions, but didn't remember what we'd concluded :)</p>



<a name="271482171"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482171" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482171">(Feb 10 2022 at 19:29)</a>:</h4>
<p>I'd assume that it would act like normal match ergonomics - doesn't add a reference to the binding by default.</p>



<a name="271482215"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482215" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482215">(Feb 10 2022 at 19:30)</a>:</h4>
<p>(But you can't move out of it unless it's <code>Copy</code> or possibly <code>Box</code>)</p>



<a name="271482349"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482349" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482349">(Feb 10 2022 at 19:30)</a>:</h4>
<p>But <code>&amp;</code> does add a reference to the binding by default in normal match ergonomics!</p>



<a name="271482373"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482373" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482373">(Feb 10 2022 at 19:30)</a>:</h4>
<p>Oh, does it?</p>



<a name="271482404"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482404" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482404">(Feb 10 2022 at 19:31)</a>:</h4>
<p>For some reason I thought it didn't.</p>



<a name="271482429"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482429" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482429">(Feb 10 2022 at 19:31)</a>:</h4>
<p>sure, <code>match &amp;MyStruct(5) { MyStruct(x) =&gt; { ... } }</code> &lt;- <code>x</code> here has type <code>&amp;i32</code>, not <code>i32</code></p>



<a name="271482478"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482478" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482478">(Feb 10 2022 at 19:31)</a>:</h4>
<p>Ah yeah, then I'd expect the same thing here.</p>



<a name="271482555"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482555" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482555">(Feb 10 2022 at 19:32)</a>:</h4>
<p>The same thing where? For <code>Rc</code>? certainly not for <code>Box</code></p>



<a name="271482603"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482603" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482603">(Feb 10 2022 at 19:32)</a>:</h4>
<p>Hmm...</p>



<a name="271482637"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482637" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482637">(Feb 10 2022 at 19:32)</a>:</h4>
<p>That is, you want <code>match Box::new(MyStruct(5)) { MyStruct(x) =&gt; { ... } }</code> &lt;- <code>x</code> here should most definitely be <code>i32</code>, not <code>&amp;i32</code></p>



<a name="271482678"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482678" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482678">(Feb 10 2022 at 19:33)</a>:</h4>
<p>because we're aiming to make explicit <code>box</code> patterns obsolete.</p>



<a name="271482729"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482729" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482729">(Feb 10 2022 at 19:33)</a>:</h4>
<p>Oh, I think this actually got talked about.</p>



<a name="271482761"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482761" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482761">(Feb 10 2022 at 19:33)</a>:</h4>
<p>I think we want <code>Vec</code> and <code>String</code> to act the same way since they own their contents, but I don't know what I'd expect for <code>Rc</code> and <code>Arc</code></p>



<a name="271482827"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482827" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482827">(Feb 10 2022 at 19:34)</a>:</h4>
<p>It should be ill-formed to deref through a value, until DerefMove is more of a thing.</p>



<a name="271482852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482852">(Feb 10 2022 at 19:34)</a>:</h4>
<p>(Except maybe Box)</p>



<a name="271482931"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482931" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482931">(Feb 10 2022 at 19:35)</a>:</h4>
<p>And I'd like to avoid making stdlib types even <em>more</em> magic.</p>



<a name="271482933"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271482933" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271482933">(Feb 10 2022 at 19:35)</a>:</h4>
<p>Yeah, so that was my proposal above: that for now, we error if dereferencing through a non-<code>Box/&amp;/&amp;mut</code> if we don't already have a by-reference binding mode set.</p>



<a name="271483003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271483003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271483003">(Feb 10 2022 at 19:35)</a>:</h4>
<p>So then you'd need to do (at least for now) <code>match &amp;some_string { "..." =&gt; ... }</code> rather than <code>match some_string { "...." =&gt; ... }</code></p>



<a name="271483053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271483053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271483053">(Feb 10 2022 at 19:36)</a>:</h4>
<p>If it's a <code>&amp;String</code> or <code>&amp;Rc</code>, it seems clear that you can just make it <code>&amp;str</code></p>



<a name="271483081"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271483081" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271483081">(Feb 10 2022 at 19:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271483003">said</a>:</p>
<blockquote>
<p>So then you'd need to do (at least for now) <code>match &amp;some_string { "..." =&gt; ... }</code> rather than <code>match some_string { "...." =&gt; ... }</code></p>
</blockquote>
<p>Yeah. And then save <code>match some_string</code> for the future.</p>



<a name="271483097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271483097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271483097">(Feb 10 2022 at 19:36)</a>:</h4>
<p>Agreed, <code>&amp;String</code>/<code>&amp;Rc</code> are pretty clear, but <code>String</code> and <code>Rc</code> are not</p>



<a name="271483362"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271483362" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271483362">(Feb 10 2022 at 19:38)</a>:</h4>
<p><code>String</code> has its own weirdness aside from that because the literal form is an <code>&amp;str</code>, not a <code>str</code>, so naiively deref-ing until you get a matching type won't work.</p>



<a name="271483389"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271483389" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271483389">(Feb 10 2022 at 19:38)</a>:</h4>
<p>I imagine that's just going to require some special-casing.</p>



<a name="271483463"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271483463" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271483463">(Feb 10 2022 at 19:39)</a>:</h4>
<p>Couldn't that just be done by making string-literal patterns generally <code>str</code> and letting match ergonomics pick up the existing cases?</p>



<a name="271483634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271483634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271483634">(Feb 10 2022 at 19:40)</a>:</h4>
<p>Hm, I don't think so, because then things like <code>match "..." { x @ " ..." =&gt; { ...</code> would result in <code>x</code> having the type <code>str</code></p>



<a name="271483853"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271483853" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271483853">(Feb 10 2022 at 19:42)</a>:</h4>
<p>well, actually, I guess it wouldn't, because <code>x</code>'s type would still be determined by the scrutinee there, not by the pattern</p>



<a name="271484123"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271484123" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Taylor Cramer <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271484123">(Feb 10 2022 at 19:44)</a>:</h4>
<p><span class="user-mention" data-user-id="257758">@Connor Horman</span> thanks for the discussion! This is interesting-- I'm excited to see what we can do here :)</p>



<a name="271508353"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271508353" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271508353">(Feb 10 2022 at 23:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="127859">Taylor Cramer</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271482933">said</a>:</p>
<blockquote>
<p>Yeah, so that was my proposal above: that for now, we error if dereferencing through a non-<code>Box/&amp;/&amp;mut</code> if we don't already have a by-reference binding mode set.</p>
</blockquote>
<p>What does "already have a by-reference binding mode set" mean though? I would expect <code>match Box::new(MyStruct(5)) { MyStruct(ref x) =&gt; ... }</code> to work even though the binding mode is set "later"</p>



<a name="271508380"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271508380" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271508380">(Feb 10 2022 at 23:10)</a>:</h4>
<p>I think that <em>requiring</em> match ergonomics style matching is a bad idea because it is more limited in some areas</p>



<a name="271793566"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271793566" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271793566">(Feb 14 2022 at 08:00)</a>:</h4>
<p>Hi all,</p>
<p>I would love to get involved and see how I could help. I think this feature would be an amazing addition to rust.</p>
<p>Would it be possible to have a kind of "path" based pure de-referencing system, so it wouldn't involve arbitrary code execution?</p>
<p>Eg</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="n">pointer</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">deref</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// OR</span>
<span class="k">struct</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">pointer</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">pattern</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// OR (this involves no new keywords) &amp; fully backwards compatible</span>
<span class="k">struct</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">pointer</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">match</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// and then...</span>

<span class="k">enum</span> <span class="nc">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">A</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">B</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="kd">let</span><span class="w"> </span><span class="n">item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">Foo</span>::<span class="n">A</span><span class="p">);</span><span class="w"></span>
<span class="k">match</span><span class="w"> </span><span class="n">a_box</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Foo</span>::<span class="n">A</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.,</span><span class="w"></span>
<span class="w">  </span><span class="n">Foo</span>::<span class="n">B</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Can anyone foresee any issues with this kind of syntax? I'd love to see if something like this would be possible. It should remove the arbitrary code execution issue</p>



<a name="271793870"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271793870" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271793870">(Feb 14 2022 at 08:04)</a>:</h4>
<p>It might have the added benefit of making match syntax much more ergonomic and simpler for new rust developers, avoiding additional sigils inside of match statements</p>



<a name="271797053"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271797053" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271797053">(Feb 14 2022 at 08:42)</a>:</h4>
<p>If it's viable, it would solve the following issues</p>
<ul>
<li>no need for new keyword</li>
<li>fully backwards compatible </li>
<li>it's sound &amp; can be checked statically for exhaustiveness</li>
<li>it would support safely defining user-defined match extensions</li>
<li>no additional sigil required</li>
<li>no need for "deref" keyword</li>
<li><code>for match</code> syntax could probably be nested (eg: <code>Pin&lt;Box&lt;str&gt;&gt;</code>)</li>
</ul>



<a name="271798164"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271798164" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271798164">(Feb 14 2022 at 08:53)</a>:</h4>
<p>How would you handle <code>Vec&lt;T&gt;</code> which has separate pointer and length fields?</p>



<a name="271798973"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271798973" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271798973">(Feb 14 2022 at 09:00)</a>:</h4>
<p>Good point, possibly some syntax like <code>as [..len]</code> eg:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">buf</span>: <span class="nc">RawVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">[</span><span class="o">..</span><span class="n">len</span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="n">len</span>: <span class="kt">usize</span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">RawVec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">ptr</span>: <span class="nc">Unique</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">match</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="n">cap</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p><span class="user-mention" data-user-id="133247">@bjorn3</span></p>



<a name="271800156"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271800156" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271800156">(Feb 14 2022 at 09:11)</a>:</h4>
<p>Since we probably want deref patterns to probably avoid execution of arbitrary user code, I think this solution would probably solve many of those kinds of issues. Things such as collections anything that references a <code>*mut</code> or <code>*const</code>  would probably need to be <code>unsafe</code> and would "panic" or be undefined behavior if there was a null pointer, or over-defining the range of a collection</p>



<a name="271801181"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271801181" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271801181">(Feb 14 2022 at 09:20)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nb">String</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">vec</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>it could potentially be possible to define more than one target of dereferences  for strings too using an "or" syntax</p>



<a name="271801351"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271801351" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271801351">(Feb 14 2022 at 09:22)</a>:</h4>
<p>I think it helps, but adding new syntax has a high cost in complexity and I fear pattern matching is not common enough or dangerous enough to justify it. The null-solution here is just that we either limit deref patterns to well-known types, or we trust the user not to do anything stupid in their Deref impls (note that they can't do anything unsafe, only unexpected), neither of which seems like too bad a situation</p>



<a name="271802211"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271802211" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271802211">(Feb 14 2022 at 09:31)</a>:</h4>
<p>I'm not sure how they implemented the <code>box</code> pattern, but I think it would not be significantly more complex than so.</p>
<p>I see where you're coming from, but based on writing language parsers and executors, I feel like this might not be a significant change and seems like it could solve most of the deref patterns needed for most container &amp; collection types (eg: <code>Box</code>, <code>String</code>, <code>Arc</code>, <code>Vec</code>, <code>Pin</code>)</p>
<p>It would be worth attempting a simpler version of this that supports types such as <code>Box</code>, <code>Pin</code>, <code>Arc</code> eg:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">match</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="271802277"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271802277" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271802277">(Feb 14 2022 at 09:31)</a>:</h4>
<p>Someone suggested something like "Place"s <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.Place.html">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/mir/struct.Place.html</a> could be used from the MIR</p>



<a name="271803715"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271803715" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271803715">(Feb 14 2022 at 09:47)</a>:</h4>
<p>Patterns are supposed to act as units of code with no expressions, I'd argue it would become significantly more complex if we were to start executing arbitrary expressions from <code>Deref</code> <code>impl</code>s . We have things like match guards for these more complex cases.</p>
<p>For the above proposal, I believe it would solve a large percentage of the needs that most people that have wanted from deref patterns. On top of this, it seems like it would safely support user-defined <code>for match</code> syntax</p>



<a name="271806135"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271806135" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> scottmcm <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271806135">(Feb 14 2022 at 10:11)</a>:</h4>
<p>To echo Nick's point, syntax <em>in the struct definition especially</em> is extra-complicated.  Is this worth breaking basically all the proc macros that could be applied to the type?  Probably not.</p>
<p>Doing this somehow in a trait impl (and/or an attribute, perhaps) seems far more likely.  But really, the specifics of syntax (like <code>for match</code> or <code>in match</code> or whatever) are the least important part of a proposal.</p>



<a name="271812089"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271812089" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert Marashi <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271812089">(Feb 14 2022 at 11:08)</a>:</h4>
<p>Ah, I see</p>



<a name="271814635"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271814635" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271814635">(Feb 14 2022 at 11:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="125270">scottmcm</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271806135">said</a>:</p>
<blockquote>
<p>To echo Nick's point, syntax <em>in the struct definition especially</em> is extra-complicated.  Is this worth breaking basically all the proc macros that could be applied to the type?  Probably not.</p>
<p>Doing this somehow in a trait impl (and/or an attribute, perhaps) seems far more likely.  But really, the specifics of syntax (like <code>for match</code> or <code>in match</code> or whatever) are the least important part of a proposal.</p>
</blockquote>
<p>I see doing it for user-defined code as a trait impl as a certainty:  You can have pure dereference without a pointer. Heck a ZST can functionally have a pure deref.<br>
The question is what implementing that trait would entail: What promises are you unsafely guaranteeing, on penalty of UB or potential UB.<br>
The current answer for the question is that it's being deferred (and only standard library types are considered at this time), though I think it's reasonable to continue having that discussion concurrently to the MVP impl.</p>



<a name="271915619"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271915619" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271915619">(Feb 15 2022 at 01:43)</a>:</h4>
<p>Another option is having a distinct trait for "my deref has no side effects".</p>



<a name="271915667"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271915667" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271915667">(Feb 15 2022 at 01:44)</a>:</h4>
<p>Rather than assuming no current type has such a deref impl.</p>



<a name="271929169"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271929169" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271929169">(Feb 15 2022 at 05:30)</a>:</h4>
<p>This would probably be a significant change, but creating a new item type specifically for telling the compiler what should happen in match patterns.</p>
<p>It's somewhat concerning to allow user-code to execute arbitrary code inside of match patterns. I think of a pattern as a "stateless" comparison. But then again, it's up to the developer to safely do this and avoid undefined behavior.</p>
<p>My idea would be more limited in terms of what's possible with dereferencing, but I think it should be limited tbh, and be able to be statically checked for exhaustiveness</p>



<a name="271929179"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271929179" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271929179">(Feb 15 2022 at 05:31)</a>:</h4>
<p>It would be a pain to debug UB when you expected the compiler to check for all invariants</p>



<a name="271929266"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271929266" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271929266">(Feb 15 2022 at 05:32)</a>:</h4>
<p>It could trip new users</p>



<a name="271930489"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271930489" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271930489">(Feb 15 2022 at 05:56)</a>:</h4>
<p>UB is absolutely not enabled by any of this</p>



<a name="271930502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271930502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271930502">(Feb 15 2022 at 05:57)</a>:</h4>
<p>and as already mentioned, all derefs supported in the initial implementation are pure</p>



<a name="271930565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271930565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Mario Carneiro <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271930565">(Feb 15 2022 at 05:58)</a>:</h4>
<p>In the future this may either be extended to (1) non-pure deref and live with the side effects or (2) pure deref via a trait, but even with (1) UB is not on the table, it is at worst a panic</p>



<a name="271957098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271957098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271957098">(Feb 15 2022 at 10:59)</a>:</h4>
<p>IMO, deref should always be 'morally' pure if not technically pure ('morally' in the same way that clone should not mutate the thing being cloned, but updating a reference count is ok), and anyone who does otherwise in their deref impl is begging for trouble. Thus it is not worth a new trait, but is worth more explicit docs</p>



<a name="271992571"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271992571" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271992571">(Feb 15 2022 at 15:46)</a>:</h4>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span> It "should", but it's not an unsafe trait, so I don't think we can count on that to prevent incorrect or unexpected behavior.</p>



<a name="271992723"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271992723" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271992723">(Feb 15 2022 at 15:47)</a>:</h4>
<p>(The trait I'm suggesting wouldn't have a separate method, it would just indicate that your existing <code>Deref</code> impl had that property.)</p>



<a name="271992763"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271992763" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271992763">(Feb 15 2022 at 15:47)</a>:</h4>
<p>The general idea for user-defined extensions was a <code>DerefPure</code> trait, which, imo <em>should</em> be an unsafe marker-only trait, and it should be on penalty of UB to violate.<br>
Otherwise, the implementation would have to insert <code>_ =&gt; unreachable!()</code> arms when deref patterns are used.</p>



<a name="271992843"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271992843" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271992843">(Feb 15 2022 at 15:48)</a>:</h4>
<p>Exactly.</p>



<a name="271992849"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271992849" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271992849">(Feb 15 2022 at 15:48)</a>:</h4>
<p>(And if it can't look into the Deref impl, those arms will basically have to stick arround)</p>



<a name="271993152"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271993152" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271993152">(Feb 15 2022 at 15:50)</a>:</h4>
<p>I don't see why it should be unsafe? There is no way to cause memory safety errors or UB, only to cause unexpected behaviour (i.e., logic errors). AIUI, we only use unsafe for memory safety, soundness etc, not to prevent foot guns</p>



<a name="271993278"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271993278" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271993278">(Feb 15 2022 at 15:51)</a>:</h4>
<p>It's being used to assert exhaustiveness.</p>



<a name="271993368"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271993368" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271993368">(Feb 15 2022 at 15:51)</a>:</h4>
<p>What exactly happens when you match a pattern, that's considered exhaustive statically, but doesn't end up being at compile time, and you miss all the arms</p>



<a name="271993497"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271993497" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271993497">(Feb 15 2022 at 15:52)</a>:</h4>
<blockquote>
<p>Otherwise, the implementation would have to insert _ =&gt; unreachable!() arms when deref patterns are used.</p>
</blockquote>
<p>The compiler could just insert this implicitly if it sees a custom deref. I think that is morally equivalent to integer bounds checks</p>



<a name="271993661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271993661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271993661">(Feb 15 2022 at 15:53)</a>:</h4>
<p>That changes how it could be implemented.</p>



<a name="271993698"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271993698" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271993698">(Feb 15 2022 at 15:53)</a>:</h4>
<p>How?</p>



<a name="271993915"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271993915" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271993915">(Feb 15 2022 at 15:54)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">enum</span> <span class="nc">Foo</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">A</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">B</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">C</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">foo</span><span class="p">(</span><span class="n">x</span>: <span class="nc">Foo</span><span class="p">){</span><span class="w"></span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">x</span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="n">Foo</span>::<span class="n">A</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="cm">/*a*/</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">Foo</span>::<span class="n">B</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="cm">/*b*/</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="n">Foo</span>::<span class="n">C</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="cm">/*c*/</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Can be implemented as a jump table.<br>
Ideally, deref patterns would allow the same.</p>



<a name="271994027"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271994027" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271994027">(Feb 15 2022 at 15:55)</a>:</h4>
<p>(IE, if <code>x</code> was &amp;Rc&lt;Foo&gt;` instead)</p>



<a name="271994098"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271994098" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271994098">(Feb 15 2022 at 15:56)</a>:</h4>
<p>Deref may also be expensive to call, so the ability to remove Deref calls is something that I think is paramount for optimization.</p>



<a name="271994583"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271994583" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271994583">(Feb 15 2022 at 15:58)</a>:</h4>
<p>Deref really shouldn't be expensive to call, that seems like another mistake by the implementer (like impurity). IMO, we should rely on deref being inlined and LLVM optimising away redundant calls, relying on a pure annotation in the form of an unsafe trait feels like a situation-specific hack around not having a general purity effect</p>



<a name="271994922"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271994922" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271994922">(Feb 15 2022 at 16:00)</a>:</h4>
<p>We can't always do that, though. <br>
Many cases of <code>Deref</code> use will originate from outside the crate. If that's not generic, then no inlining without <code>#[inline]</code>.</p>



<a name="271995062"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995062" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995062">(Feb 15 2022 at 16:01)</a>:</h4>
<p>Not being unsafe means the compiler can't collapse it into a single Deref, followed by a jump table, because it could have different behaviour from derefing in each arm.</p>



<a name="271995148"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995148" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995148">(Feb 15 2022 at 16:01)</a>:</h4>
<p>LTO could help, I think?</p>



<a name="271995194"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995194" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995194">(Feb 15 2022 at 16:02)</a>:</h4>
<p>LTO always can help. That doesn't mean we should rely on it here.</p>



<a name="271995590"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995590" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995590">(Feb 15 2022 at 16:04)</a>:</h4>
<p>IMO I think it is a mistake to pursue this last drop of performance at the expense of increased complexity and potential unsafety. With no extra traits and no unsafety (and the accompanying potential for errors) you get an implementation which is pretty close to optimal in all cases and optimal in many cases (esp with LTO).</p>



<a name="271995616"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995616" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995616">(Feb 15 2022 at 16:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271993497">said</a>:</p>
<blockquote>
<blockquote>
<p>Otherwise, the implementation would have to insert _ =&gt; unreachable!() arms when deref patterns are used.</p>
</blockquote>
<p>The compiler could just insert this implicitly if it sees a custom deref. I think that is morally equivalent to integer bounds checks</p>
</blockquote>
<p>But it shouldn't have to, given that most Deref impls are well-behaved.</p>



<a name="271995721"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995721" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995721">(Feb 15 2022 at 16:05)</a>:</h4>
<p>It has to do this pessimistically, but 95% of the time, it's redundant, but just can't see it.</p>



<a name="271995756"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995756" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995756">(Feb 15 2022 at 16:05)</a>:</h4>
<p>I don't think this is just an issue of performance. Inserting <code>_ =&gt; unreachable!()</code> means inserting a panic, which means the panic machinery.</p>



<a name="271995777"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995777" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995777">(Feb 15 2022 at 16:05)</a>:</h4>
<p>A program might otherwise not <em>need</em> the panic machinery, or the format machinery.</p>



<a name="271995793"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995793" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995793">(Feb 15 2022 at 16:05)</a>:</h4>
<p>That to.</p>



<a name="271995818"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995818" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995818">(Feb 15 2022 at 16:05)</a>:</h4>
<p>(e.g. WebAssembly trying to optimize for size)</p>



<a name="271995988"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271995988" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271995988">(Feb 15 2022 at 16:06)</a>:</h4>
<p>It also means that unsafe code may now has to deal with the possibility of a match panicking.</p>



<a name="271996007"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271996007" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271996007">(Feb 15 2022 at 16:06)</a>:</h4>
<p>A program which does no arithmetic and no array indexing but absolutely must use deref patterns seems like a pretty niche use case :-)</p>



<a name="271996047"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271996047" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271996047">(Feb 15 2022 at 16:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271996007">said</a>:</p>
<blockquote>
<p>A program which does no arithmetic and no array indexing but absolutely must use deref patterns seems like a pretty niche use case :-)</p>
</blockquote>
<p><code>-C overflow-checks=n</code> for the first.</p>



<a name="271996252"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271996252" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271996252">(Feb 15 2022 at 16:08)</a>:</h4>
<p>Also, deref patterns can be used to avoid the bounds checks for indexing, especially of vectors.</p>



<a name="271997239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271997239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271997239">(Feb 15 2022 at 16:14)</a>:</h4>
<p>Also, the compiler is pretty good at eliminating bounds checks, and people who use iterators don't get bounds checks.</p>



<a name="271997427"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271997427" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271997427">(Feb 15 2022 at 16:15)</a>:</h4>
<p>So, to step back, let me go over why I don't like the DerefPure trait: it's one more trait for people to implement, but moreover what happens if it is not implemented? Either we silently have a sub-optimal path for deref patterns and there is no notification that the impl is missing, or there is an error and so users don't get to use deref patterns until their libraries upgrade. It feels bad to assert a property (one that affects soundness in fact) non-locally - it seems too easy to change the deref impl and forget to delete the DerefPure impl. Also, it doesn't scale - we'd need a DerefMutPure and perhaps someday a DerefMovePure traits too.</p>



<a name="271997957"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271997957" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271997957">(Feb 15 2022 at 16:18)</a>:</h4>
<p><span class="user-mention" data-user-id="256841">@Nick Cameron</span> I think one marker trait could opt in for all deref traits.</p>



<a name="271998032"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271998032" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271998032">(Feb 15 2022 at 16:19)</a>:</h4>
<p>Yeah, <code>DerefPure</code> would imply purity of <code>DerefMut</code> and <code>DerefMove</code> (in the future), as well as consistency.</p>



<a name="271998239"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271998239" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271998239">(Feb 15 2022 at 16:20)</a>:</h4>
<p>If it's not implemented, then Deref patterns would be unavailable for the type, yes.</p>



<a name="271998372"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271998372" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271998372">(Feb 15 2022 at 16:21)</a>:</h4>
<p>This implies a generic Deref type that want's to use deref patterns would also need to bound on <code>DerefPure</code>.</p>



<a name="271998864"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271998864" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271998864">(Feb 15 2022 at 16:25)</a>:</h4>
<p>An alternative is that non-pure Deref types would not be treated as having exhaustive patterns, so the user, not the compiler, would have to insert a wildcard pattern and handle it as they would.</p>



<a name="271998914"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271998914" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271998914">(Feb 15 2022 at 16:25)</a>:</h4>
<p>So, I would propose that we implement the more ergonomic, safer version first and if while it is unstable we have evidence that it prevents the compiler optimising where it is important to optimise (and not to workaround), then we can add the more performant version. Otherwise, this feels like the language design equivalent of premature optimisation.</p>



<a name="271999042"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271999042" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271999042">(Feb 15 2022 at 16:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271998864">said</a>:</p>
<blockquote>
<p>An alternative is that non-pure Deref types would not be treated as having exhaustive patterns, so the user, not the compiler, would have to insert a wildcard pattern and handle it as they would.</p>
</blockquote>
<p>I prefer this to the trait, but I would still rather it were implicit unless we can show that that causes actual real-life problems</p>



<a name="271999133"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271999133" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271999133">(Feb 15 2022 at 16:27)</a>:</h4>
<p>I don't want to add implicit panics. TBH, that seems like far more of a footgun then any kind of unsafe trait, that most Deref impls satisfy anyways.</p>



<a name="271999531"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/271999531" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#271999531">(Feb 15 2022 at 16:29)</a>:</h4>
<p>Implicit panics are everywhere in Rust already - literally every single function can implicitly panic if it wants to. I'd want to see evidence that adding such implicit panics actually causes problems for users</p>



<a name="272001705"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272001705" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272001705">(Feb 15 2022 at 16:45)</a>:</h4>
<p>I'd love to come up with some code that this is a problem, though I can't think of anything specific at this time.</p>
<p>I would note that all other cases of implicit panics from primitive operations, there are opt outs:<br>
<code>.wrapping_*</code>, <code>.get</code>, <code>.get_unchecked</code>.</p>



<a name="272002841"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272002841" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272002841">(Feb 15 2022 at 16:52)</a>:</h4>
<p>I've seen write-ups of size optimization for WebAssembly that specifically talk about avoiding the format machinery.</p>



<a name="272003019"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272003019" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272003019">(Feb 15 2022 at 16:53)</a>:</h4>
<p>(Note that to give credit, I don't think that the implicit <code>_ =&gt; unreachable!()</code> would actually be <code>_ =&gt; unreachable!()</code>, but something like <code>_ =&gt; unreachable_deref_pattern()</code>  which wouldn't involve the format machinery)</p>



<a name="272003114"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272003114" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272003114">(Feb 15 2022 at 16:54)</a>:</h4>
<p>There would be a workaround here too which is just to do what we do today rather than use deref</p>



<a name="272003201"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272003201" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272003201">(Feb 15 2022 at 16:54)</a>:</h4>
<p>Patterns</p>



<a name="272003238"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272003238" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272003238">(Feb 15 2022 at 16:55)</a>:</h4>
<p>Which can be significantly worse, ergonomics wise.</p>



<a name="272003309"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272003309" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272003309">(Feb 15 2022 at 16:55)</a>:</h4>
<p>I actually have some code that would really love to use deref patterns. Right now it's panic heavy, but in the future, I want to replace all panics with proper diagnostics.</p>



<a name="272003625"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272003625" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272003625">(Feb 15 2022 at 16:57)</a>:</h4>
<p><a href="https://github.com/LightningCreations/lccc/blob/main/xir/src/parser.rs#L22">https://github.com/LightningCreations/lccc/blob/main/xir/src/parser.rs#L22</a></p>
<p>I'd love to replace the <code>Token::Ident(id) if id=="function"</code> with <code>Token::Ident("function")</code>, likewise for other keywords, which is heavilly used here. And also in the rust parser in the same project.</p>



<a name="272005737"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272005737" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272005737">(Feb 15 2022 at 17:09)</a>:</h4>
<p>I'd love to see performance comparisons between a deref pattern impl with implicit _ =&gt; panic!() and without that for that kind of application</p>



<a name="272005875"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272005875" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272005875">(Feb 15 2022 at 17:10)</a>:</h4>
<p>The issue with panics is that it's technically unsound: <a href="https://github.com/LightningCreations/lccc/issues/6">https://github.com/LightningCreations/lccc/issues/6</a></p>



<a name="272005976"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272005976" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272005976">(Feb 15 2022 at 17:11)</a>:</h4>
<p>(Not that it's stopping me, but I'd like to clean up issue 6 at some point)</p>



<a name="272006093"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272006093" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272006093">(Feb 15 2022 at 17:11)</a>:</h4>
<p>It's very hard to do that, if I can't reason about where the compiler might be inserting panics.</p>



<a name="272011946"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272011946" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272011946">(Feb 15 2022 at 17:50)</a>:</h4>
<p>In particular, I don't want "write panic-free code" to include "carefully avoid using deref patterns".</p>



<a name="272012003"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272012003" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272012003">(Feb 15 2022 at 17:50)</a>:</h4>
<p>(As one of many many possible reasons: carefully avoiding potential panics inside a locked region, to avoid dealing with lock poisoning.)</p>



<a name="272012024"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272012024" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272012024">(Feb 15 2022 at 17:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271994098">said</a>:</p>
<blockquote>
<p>Deref may also be expensive to call, so the ability to remove Deref calls is something that I think is paramount for optimization.</p>
</blockquote>
<p>I agree with this</p>



<a name="272012254"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272012254" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272012254">(Feb 15 2022 at 17:52)</a>:</h4>
<p>Also, having the ability to optimize over Deref impls means it may be possible to optimize string comparisons to happen in a multi-way fashion. For instance, if you're comparing against a hundred fixed short strings, it might make sense to read the first 8 bytes of the string out into a register and optimize like a fast "numeric" switch.</p>



<a name="272012298"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272012298" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272012298">(Feb 15 2022 at 17:52)</a>:</h4>
<p>That doesn't work as well if we semantically require that Deref must be called a hundred times.</p>



<a name="272012393"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272012393" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272012393">(Feb 15 2022 at 17:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271802211">said</a>:</p>
<blockquote>
<p>I'm not sure how they implemented the <code>box</code> pattern, but I think it would not be significantly more complex than so.</p>
<p>I see where you're coming from, but based on writing language parsers and executors, I feel like this might not be a significant change and seems like it could solve most of the deref patterns needed for most container &amp; collection types (eg: <code>Box</code>, <code>String</code>, <code>Arc</code>, <code>Vec</code>, <code>Pin</code>)</p>
<p>It would be worth attempting a simpler version of this that supports types such as <code>Box</code>, <code>Pin</code>, <code>Arc</code> eg:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Pin</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">data</span>: <span class="nc">T</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">match</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div><br>
</p>
</blockquote>
<p>That's why I thought a solution like this, where everything can be checked statically, no <code>Deref</code> required, and it should be able to support user-defined cases and cover most of the deref patterns people are asking for</p>



<a name="272012565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272012565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272012565">(Feb 15 2022 at 17:55)</a>:</h4>
<p>since these would cover 90% of use-cases. If people need some more complex <code>Deref</code> code, then they can just use match guards / additional matches</p>



<a name="272012884"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272012884" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272012884">(Feb 15 2022 at 17:57)</a>:</h4>
<p>It should be much more performant, since it would be doing some simple offsets to the bytes in structs, and they could be nested too... eg:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span> <span class="nc">Data</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">data</span>:  <span class="nc">Inner</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">match</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">struct</span> <span class="nc">Inner</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">ptr</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">match</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>



<a name="272015206"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272015206" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272015206">(Feb 15 2022 at 18:13)</a>:</h4>
<p>my pseudo-code for the ops would be something like:</p>
<ul>
<li>pattern type is inferred based on first <code>match</code> pattern (variant of <code>T</code>)</li>
<li>the variable being matched is a <code>Data&lt;T&gt;</code></li>
<li>the ast contains a map of the possible things that <code>Data&lt;T&gt;</code> can map to, eg: <code>T -&gt; data: Inner&lt;T&gt;</code></li>
<li>we look for T, get the offset &amp; <code>sizeof</code> the particular field, since <code>Inner&lt;T&gt;</code> is embedded in the struct, we read the <code>ptr</code> which is an <code>unsafe</code> for the deref pattern</li>
<li>let location = data.address + offset_to_t as T</li>
</ul>



<a name="272015231"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272015231" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272015231">(Feb 15 2022 at 18:13)</a>:</h4>
<blockquote>
<p>In particular, I don't want "write panic-free code" to include "carefully avoid using deref patterns".</p>
</blockquote>
<p>Could you explain why? It seems easier to spot than a panic buried deep down some call chain of functions</p>



<a name="272015454"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272015454" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Josh Triplett <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272015454">(Feb 15 2022 at 18:14)</a>:</h4>
<p>It's harder to spot through superficial code inspection and/or grep.</p>



<a name="272015502"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272015502" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272015502">(Feb 15 2022 at 18:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272012024">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/271994098">said</a>:</p>
<blockquote>
<p>Deref may also be expensive to call, so the ability to remove Deref calls is something that I think is paramount for optimization.</p>
</blockquote>
<p>I agree with this</p>
</blockquote>
<p>Do you have examples of expense deref impls? (I am morbidly curious)</p>



<a name="272015634"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272015634" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272015634">(Feb 15 2022 at 18:16)</a>:</h4>
<p><code>Lazy</code></p>



<a name="272015661"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272015661" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272015661">(Feb 15 2022 at 18:16)</a>:</h4>
<p>a function itself has overhead, unless it's inlined</p>



<a name="272015670"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272015670" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272015670">(Feb 15 2022 at 18:16)</a>:</h4>
<p>The inner type produced from a <code>lazy_static!</code></p>



<a name="272015918"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272015918" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272015918">(Feb 15 2022 at 18:18)</a>:</h4>
<p>I'm not all that fussed, but I really want to be able to use deref patterns with <code>Box&lt;str&gt;</code>, <code>String</code>, and possibly things like <code>Vec</code>s would be amazing. I don't particularly plan on implementing it on my own types, but I can see where it would be useful sometimes</p>



<a name="272015989"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272015989" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272015989">(Feb 15 2022 at 18:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="239881">Josh Triplett</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272015454">said</a>:</p>
<blockquote>
<p>It's harder to spot through superficial code inspection and/or grep.</p>
</blockquote>
<p>I don't understand this (though I think I am just generally sceptical of the idea of writing panic-free code). AIUI, you see a function call <code>foo()</code> and you have no idea if it might panic or not, but you see a match and you have a pretty good idea if it might panic if there is a smart pointer in the thing being matched. Of course you might not know the type, but that is probably because it is coming from a function, which might panic</p>



<a name="272016043"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272016043" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272016043">(Feb 15 2022 at 18:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272015918">said</a>:</p>
<blockquote>
<p>I'm not all that fussed, but I really want to be able to use deref patterns with <code>Box&lt;str&gt;</code>, <code>String</code>, and possibly things like <code>Vec</code>s would be amazing. I don't particularly plan on implementing it on my own types, but I can see where it would be useful sometimes</p>
</blockquote>
<p>I have some user-defined types I'd like to implement.</p>



<a name="272016208"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272016208" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272016208">(Feb 15 2022 at 18:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272016043">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272015918">said</a>:</p>
<blockquote>
<p>I'm not all that fussed, but I really want to be able to use deref patterns with <code>Box&lt;str&gt;</code>, <code>String</code>, and possibly things like <code>Vec</code>s would be amazing. I don't particularly plan on implementing it on my own types, but I can see where it would be useful sometimes</p>
</blockquote>
<p>I have some user-defined types I'd like to implement.</p>
</blockquote>
<p>How complex would your derefs typically be if they were functions? Is it just returning some pointers or borrows of certain things, or are they doing more complex operations?</p>



<a name="272016218"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272016218" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272016218">(Feb 15 2022 at 18:20)</a>:</h4>
<p>Out of curiosity</p>



<a name="272016522"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272016522" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272016522">(Feb 15 2022 at 18:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272015634">said</a>:</p>
<blockquote>
<p><code>Lazy</code></p>
</blockquote>
<p>This is a great example!</p>



<a name="272016641"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272016641" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Cameron <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272016641">(Feb 15 2022 at 18:23)</a>:</h4>
<p>I think it's a good example of a not-pure-but-morally-pure-enough-for-deref-patterns deref too</p>



<a name="272016665"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272016665" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272016665">(Feb 15 2022 at 18:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272016208">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272016043">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272015918">said</a>:</p>
<blockquote>
<p>I'm not all that fussed, but I really want to be able to use deref patterns with <code>Box&lt;str&gt;</code>, <code>String</code>, and possibly things like <code>Vec</code>s would be amazing. I don't particularly plan on implementing it on my own types, but I can see where it would be useful sometimes</p>
</blockquote>
<p>I have some user-defined types I'd like to implement.</p>
</blockquote>
<p>How complex would your derefs typically be if they were functions? Is it just returning some pointers or borrows of certain things, or are they doing more complex operations?</p>
</blockquote>
<p>Currently, many of them are just reimplementations of standard library types. xlang_abi (in lccc) has it's own allocator, it's own <code>Box</code>, it's own <code>Vec</code>, it's own <code>String</code>, etc. <br>
One type involves a pointer subtraction +from_raw_parts+from_utf8_unchecked (<code>StringView</code>, which derefs into <code>&amp;str</code>, and is an abi-safe version of the latter), and two types involve from_raw_parts{,_mut} (<code>Span</code> and <code>SpanMut</code>, which are respectively <code>&amp;[T}</code> and <code>&amp;mut [T]</code>)</p>



<a name="272016911"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272016911" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272016911">(Feb 15 2022 at 18:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="256841">Nick Cameron</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272016641">said</a>:</p>
<blockquote>
<p>I think it's a good example of a not-pure-but-morally-pure-enough-for-deref-patterns deref too</p>
</blockquote>
<p>Yeah, the MVP will likely exclude <code>Lazy</code>/<code>SyncLazy</code>, but I'm fairly certain most definitions of <code>DerefPure</code> could permit it.</p>



<a name="272017014"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272017014" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272017014">(Feb 15 2022 at 18:26)</a>:</h4>
<p>That would be quite useful for the OS i'm working on</p>



<a name="272017070"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272017070" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272017070">(Feb 15 2022 at 18:26)</a>:</h4>
<p>I've needed deref patterns hundreds of times, especially when I'm writing ASTs and tests for parsers and such</p>



<a name="272017097"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272017097" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272017097">(Feb 15 2022 at 18:26)</a>:</h4>
<p>It'd literally cut out like 50% of my code I think</p>



<a name="272017333"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272017333" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272017333">(Feb 15 2022 at 18:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272017070">said</a>:</p>
<blockquote>
<p>I've needed deref patterns hundreds of times, especially when I'm writing ASTs and tests for parsers and such</p>
</blockquote>
<p>Yeah, parsers are one of my major use cases. I'd love deref patterns for writing lccc (although I probably won't see them for a long time because MSRV 1.54 - need bootstrap via mrustc or gcc-rs, and the latter isn't functional enough).</p>



<a name="272642889"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/272642889" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#272642889">(Feb 21 2022 at 05:25)</a>:</h4>
<p>Anything I can do to help move this forward? Happy to get my hands dirty in the compiler but I will need guidance</p>



<a name="273265852"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/273265852" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#273265852">(Feb 25 2022 at 18:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272642889">said</a>:</p>
<blockquote>
<p>Anything I can do to help move this forward? Happy to get my hands dirty in the compiler but I will need guidance</p>
</blockquote>
<p>I'm really not the right person to give advice, sorry for barging in (I've literally discovered this project group an hour ago), but I hope this can help nonetheless, I just couldn't ignore your motivation <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span><br>
This looks like a big endeavor for a first contribution though, so if you want to help, I'd suggest to at least get comfortable with the overall structure of the compiler. The <a href="https://rustc-dev-guide.rust-lang.org/overview.html">dev guide</a> is probably a good place to start.</p>
<p>The first thing that'll need to be done is adding a new <code>#![feature(deref_patterns)]</code> gate, see the relevant <a href="https://rustc-dev-guide.rust-lang.org/feature-gates.html#adding-a-feature-gate">rustc-dev-guide chapter</a>.</p>
<p>All subsequent work will need to ensure that behavior is unchanged when the feature gate is unset. You can check whether a feature is set through <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.TyCtxt.html#method.features"><code>TyCtxt::features</code></a>, where <code>TyCtxt</code> is passed through most of the compiler and often named <code>tcx</code>.</p>
<p>My understanding is that the first implementation will be the "no syntax" option, otherwise implementation work in the parser will be needed, as well as modifications in the AST and HIR to pass down the additional information to the later compilation steps.</p>
<p>Since there is no syntax, detecting deref patterns will take place in type checking and type inference. The goal is to make the type checker understand that it can unify the scrutinee type and the pattern type through dereferences. I don't know more than that, type checking is just magic to me <span aria-label="sparkles" class="emoji emoji-2728" role="img" title="sparkles">:sparkles:</span></p>
<p>Based on that information, any deref pattern should be made explicit in the THIR. Relevant code is in <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_build/src/thir/pattern/mod.rs#L45"><code>rustc_mir_build::thir::pattern</code></a>. Introducing a <a href="https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/thir/enum.PatKind.html#variant.Deref"><code>PatKind::Deref</code></a> (which currently represents <code>&amp;</code> and <code>box</code> patterns) might be enough.</p>
<p>The last thing should be lowering to MIR. In the best case, this is close enough to <code>box</code> patterns that there is little to change <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="273270115"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/273270115" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#273270115">(Feb 25 2022 at 18:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272642889">said</a>:</p>
<blockquote>
<p>Anything I can do to help move this forward? Happy to get my hands dirty in the compiler but I will need guidance</p>
</blockquote>
<p>Sorry I keep getting busy with other projects ( One of them was a DR for inline asm which got superpriority because of the urgency - it basically got in on the buzzer - as well as work on lccc). I don't know if I've linked it before, but the work is currently in my fork of rust-lang/rust, <a href="https://github.com/chorman0773/rust">https://github.com/chorman0773/rust</a>, in the deref-patterns branch (LMK if you want to be added, I can certainly do that). <br>
It already has the feature added, but the rest needs to be done.<br>
When I'm done what I'm currently working on (which is redoing a modr/m emitter so lccc can support reading from/writing to memory addresses, so heh) I should be able to do some work from my side. Hopefully later today (Not going to make any specific promises this time though because its ModR/M).</p>



<a name="275646703"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/275646703" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Léo Lanteri Thauvin <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#275646703">(Mar 17 2022 at 12:51)</a>:</h4>
<p>(I'm currently looking at the typeck side of things)</p>



<a name="277913116"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/277913116" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#277913116">(Apr 05 2022 at 17:16)</a>:</h4>
<p>Hey, I just read through a bit, I've missed the last few months of development ^^</p>



<a name="277913249"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/277913249" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#277913249">(Apr 05 2022 at 17:17)</a>:</h4>
<p>I'm thinking that if we really want an MVP, piggy-backing on top of box-patterns sounds much better to me. Both because there's almost no risk of breaking existing code and because most of what's needed is already in place throughout the compiler</p>



<a name="277913491"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/277913491" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#277913491">(Apr 05 2022 at 17:19)</a>:</h4>
<p>I expect the no-syntax option to run into subtle inference breakage</p>



<a name="277913565"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/277913565" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#277913565">(Apr 05 2022 at 17:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="245339">Nadrieril</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/277913249">said</a>:</p>
<blockquote>
<p>I'm thinking that if we really want an MVP, piggy-backing on top of box-patterns sounds much better to me. Both because there's almost no risk of breaking existing code and because most of what's needed is already in place throughout the compiler</p>
</blockquote>
<p>by which I mean, literally reuse the <code>box foo</code> syntax but have it work for Rc, String etc too</p>



<a name="277914002"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/277914002" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#277914002">(Apr 05 2022 at 17:22)</a>:</h4>
<p>Happy to do the pattern exhaustiveness part since I know that part of rustc</p>



<a name="278668474"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/278668474" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#278668474">(Apr 12 2022 at 09:31)</a>:</h4>
<p>It kinda doesn't make a whole lot of sense though</p>



<a name="278668560"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/278668560" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#278668560">(Apr 12 2022 at 09:32)</a>:</h4>
<p>I really just wanna see this come out soon though. It's a really important feature</p>



<a name="278673273"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/278673273" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Albert <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#278673273">(Apr 12 2022 at 10:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/273270115">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272642889">said</a>:</p>
<blockquote>
<p>Anything I can do to help move this forward? Happy to get my hands dirty in the compiler but I will need guidance</p>
</blockquote>
<p>Sorry I keep getting busy with other projects ( One of them was a DR for inline asm which got superpriority because of the urgency - it basically got in on the buzzer - as well as work on lccc). I don't know if I've linked it before, but the work is currently in my fork of rust-lang/rust, <a href="https://github.com/chorman0773/rust">https://github.com/chorman0773/rust</a>, in the deref-patterns branch (LMK if you want to be added, I can certainly do that). <br>
It already has the feature added, but the rest needs to be done.<br>
When I'm done what I'm currently working on (which is redoing a modr/m emitter so lccc can support reading from/writing to memory addresses, so heh) I should be able to do some work from my side. Hopefully later today (Not going to make any specific promises this time though because its ModR/M).</p>
</blockquote>
<p>How are things going with this?</p>
<p>Happy to allocate some time to this but I will need some mentoring &amp; direction.</p>



<a name="278693484"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/278693484" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nadrieril <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#278693484">(Apr 12 2022 at 13:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/278668474">said</a>:</p>
<blockquote>
<p>It kinda doesn't make a whole lot of sense though</p>
</blockquote>
<p>yeah, I meant only as an MVP so we get some sort of implementation out there</p>



<a name="278715395"></a>
<h4><a href="https://rust-lang.zulipchat.com#narrow/stream/281601-project-deref-patterns/topic/2022-1%20Update/near/278715395" class="zl"><img src="https://zulip-archive.rust-lang.org/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Connor Horman <a href="https://zulip-archive.rust-lang.org/stream/281601-project-deref-patterns/topic/2022-1.20Update.html#278715395">(Apr 12 2022 at 16:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/278673273">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="257758">Connor Horman</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/273270115">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="478671">Albert</span> <a href="#narrow/stream/281601-project-deref-patterns/topic/2022-1.20Update/near/272642889">said</a>:</p>
<blockquote>
<p>Anything I can do to help move this forward? Happy to get my hands dirty in the compiler but I will need guidance</p>
</blockquote>
<p>Sorry I keep getting busy with other projects ( One of them was a DR for inline asm which got superpriority because of the urgency - it basically got in on the buzzer - as well as work on lccc). I don't know if I've linked it before, but the work is currently in my fork of rust-lang/rust, <a href="https://github.com/chorman0773/rust">https://github.com/chorman0773/rust</a>, in the deref-patterns branch (LMK if you want to be added, I can certainly do that). <br>
It already has the feature added, but the rest needs to be done.<br>
When I'm done what I'm currently working on (which is redoing a modr/m emitter so lccc can support reading from/writing to memory addresses, so heh) I should be able to do some work from my side. Hopefully later today (Not going to make any specific promises this time though because its ModR/M).</p>
</blockquote>
<p>How are things going with this?</p>
<p>Happy to allocate some time to this but I will need some mentoring &amp; direction.</p>
</blockquote>
<p>I've still been rather busy, and I expect to remain that way at least until the end of april, as I have my exams coming up.<br>
After that, though, I'm done uni until september so I should have time to work on this. <br>
I'm still prioritizing backend work on lccc, though. We've made some fairly quick advances, and we might have an MVP of it by the end of the year.</p>



<hr><p>Last updated: Apr 12 2022 at 20:01 UTC</p>
</html>