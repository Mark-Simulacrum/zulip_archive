[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> Does the <code>__umulh</code> error look familiar to you?</p>",
        "id": 252670872,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631211414
    },
    {
        "content": "<p>No, seems new</p>",
        "id": 252670997,
        "sender_full_name": "simulacrum",
        "timestamp": 1631211468
    },
    {
        "content": "<p>Maybe an update to the windows runners environment?</p>",
        "id": 252671017,
        "sender_full_name": "simulacrum",
        "timestamp": 1631211478
    },
    {
        "content": "<p>Looks like it was updated yesterday.</p>",
        "id": 252671753,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631211729
    },
    {
        "content": "<p>but nothing obvious looks like a culprit</p>",
        "id": 252671821,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631211759
    },
    {
        "content": "<p>hm</p>",
        "id": 252671870,
        "sender_full_name": "simulacrum",
        "timestamp": 1631211775
    },
    {
        "content": "<p>I likely won't have time to investigate too much today/tomorrow, unfortunately</p>",
        "id": 252671900,
        "sender_full_name": "simulacrum",
        "timestamp": 1631211785
    },
    {
        "content": "<p>i'll keep looking</p>\n<p>Oh, they updated windows 10 sdk</p>",
        "id": 252671956,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631211808
    },
    {
        "content": "<p>Microsoft.VisualStudio.Component.Windows10SDK.20348</p>",
        "id": 252671961,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631211809
    },
    {
        "content": "<p>we can probably rustbot ping windows on the PR</p>",
        "id": 252672091,
        "sender_full_name": "simulacrum",
        "timestamp": 1631211852
    },
    {
        "content": "<p>Oh, it looks like all PRs are failing, I didn't notice.</p>",
        "id": 252672401,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631211993
    },
    {
        "content": "<p>Should probably close the tree.</p>",
        "id": 252672414,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631211998
    },
    {
        "content": "<p>haha:</p>\n<p>Clang/LLVM for Windows v11 targeting ARM64 is not compatible with the latest winnt.h</p>\n<p>As a workaround, use the previous version of the Windows 10 SDK (build 19041), or clang/LLVM for Windows v10 when targeting ARM64 platforms</p>",
        "id": 252677437,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631214063
    },
    {
        "content": "<p>Don't suppose anyone happens do know how to control which version of the SDK is used?</p>",
        "id": 252677525,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631214102
    },
    {
        "content": "<p>Hm. Not sure we have control of that.</p>",
        "id": 252677957,
        "sender_full_name": "simulacrum",
        "timestamp": 1631214274
    },
    {
        "content": "<p>Are we using clang for windows 11 though?</p>",
        "id": 252678236,
        "sender_full_name": "simulacrum",
        "timestamp": 1631214378
    },
    {
        "content": "<p>I'd... not expect us to be doing that</p>",
        "id": 252678251,
        "sender_full_name": "simulacrum",
        "timestamp": 1631214386
    },
    {
        "content": "<p>I don't know what \"LLVM for Windows v11\" means specifically.</p>",
        "id": 252678566,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631214524
    },
    {
        "content": "<p>For reference, I'm reading the release notes here: <a href=\"https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk/#serverdev\">https://developer.microsoft.com/en-us/windows/downloads/windows-10-sdk/#serverdev</a></p>",
        "id": 252679015,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631214717
    },
    {
        "content": "<p>So I'm thinking that it may need to pass the SDK version to <code>vcvarsall.bat</code> if we were to go the route of downgrading.</p>",
        "id": 252679821,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631215074
    },
    {
        "content": "<p>Is there a better place to coordinate the fix for this, and other people to possibly rope in?</p>",
        "id": 252690250,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631219446
    },
    {
        "content": "<p>I'm able to reproduce the NatVis error locally.</p>",
        "id": 252690268,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631219458
    },
    {
        "content": "<p>I'm going to write up a summary issue, but otherwise I'll probably not be able to investigate more.  Hopefully we can find a way to fix it without using vcvarsall, since running that is awkward.</p>",
        "id": 252699553,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631223173
    },
    {
        "content": "<p>also looking into it now, but not sure if i can be of much help</p>",
        "id": 252699790,
        "sender_full_name": "Mara",
        "timestamp": 1631223284
    },
    {
        "content": "<p>(staring at <a href=\"https://github.com/rust-lang/rust/blob/497ee321af3b8496eaccd7af7b437f18bab81abf/library/profiler_builtins/build.rs#L37-L45\">these lines</a> now)</p>",
        "id": 252699837,
        "sender_full_name": "Mara",
        "timestamp": 1631223304
    },
    {
        "content": "<p>(and <a href=\"https://bugs.llvm.org/show_bug.cgi?id=51128\">this bug report</a>)</p>",
        "id": 252700708,
        "sender_full_name": "Mara",
        "timestamp": 1631223734
    },
    {
        "content": "<p>Posted <a href=\"https://github.com/rust-lang/rust/issues/88796\">#88796</a> with a summary.</p>",
        "id": 252701252,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631223983
    },
    {
        "content": "<p>oh, the pipeline links have expired</p>",
        "id": 252701865,
        "sender_full_name": "Mara",
        "timestamp": 1631224292
    },
    {
        "content": "<p>oh, that's silly</p>",
        "id": 252702055,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631224391
    },
    {
        "content": "<p>Randomly, I was looking at some Appveyor runs for rust from <em>3 years ago</em> and the logs were still there, and were like 10x faster than GitHub's UI.</p>",
        "id": 252702109,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631224426
    },
    {
        "content": "<p>this looks helpful: &lt;<a href=\"https://github.com/slurps-mad-rips/VCVars\">https://github.com/slurps-mad-rips/VCVars</a>&gt;</p>",
        "id": 252703380,
        "sender_full_name": "Mara",
        "timestamp": 1631225118
    },
    {
        "content": "<p>I installed Windows 10 SDK 20348, but for the life of me I can't get it to fail to build aarch64 with profilers enabled.  I'm using msvc build tools instead of Visual Studio Enterprise, so I'm not sure if that is a significant difference.</p>",
        "id": 252703930,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631225421
    },
    {
        "content": "<p>trying some stuff here: <a href=\"https://github.com/rust-lang/rust/pull/88797\">https://github.com/rust-lang/rust/pull/88797</a></p>",
        "id": 252709577,
        "sender_full_name": "Mara",
        "timestamp": 1631228793
    },
    {
        "content": "<p>(now with help from @slurps-mad-rips)</p>",
        "id": 252709618,
        "sender_full_name": "Mara",
        "timestamp": 1631228831
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"310399\">@Mara</span> Any luck?</p>\n<p>I took a quick peek at your experiment.  I <em>think</em> you only need to set the host as amd64, and leave the target unset (or maybe set to amd64).  Those affect the defaults, and cmake and other tools will set the target when needed.  At least, that's how it worked in my local testing building for arm64.</p>",
        "id": 252716441,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631234145
    },
    {
        "content": "<p>izzy is saying that we can just use cmake to do this for us instead of using vcvars</p>",
        "id": 252716504,
        "sender_full_name": "Mara",
        "timestamp": 1631234181
    },
    {
        "content": "<p>Ah, that would be great.</p>",
        "id": 252716516,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631234195
    },
    {
        "content": "<p>the problem is that it first builds a compiler for x64, and then builds a compiler for arm64. if we use vcvars, only one of them will work. (or we'll have to switch in the middle)</p>",
        "id": 252716999,
        "sender_full_name": "Mara",
        "timestamp": 1631234589
    },
    {
        "content": "<p>but cmake already supports <code>-D CMAKE_VS_WINDOWS_TARGET_PLATFORM_VERSION</code> for this</p>",
        "id": 252717009,
        "sender_full_name": "Mara",
        "timestamp": 1631234600
    },
    {
        "content": "<p>so trying that out now</p>",
        "id": 252717010,
        "sender_full_name": "Mara",
        "timestamp": 1631234603
    },
    {
        "content": "<p>Oh, that sounds perfect, I hadn't seen that option.  Hopefully it works.</p>\n<p>I would also mention that the debugger tests will still probably fail, and I would suggest just disabling them and open a new issue to track fixing it.</p>",
        "id": 252717143,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631234740
    },
    {
        "content": "<p>yeah, not going to try to solve that for now</p>",
        "id": 252717264,
        "sender_full_name": "Mara",
        "timestamp": 1631234858
    },
    {
        "content": "<p>once this part passes i'm going to sleep</p>",
        "id": 252717270,
        "sender_full_name": "Mara",
        "timestamp": 1631234863
    },
    {
        "content": "<p>almost 3 am here <span aria-label=\"zzz\" class=\"emoji emoji-1f4a4\" role=\"img\" title=\"zzz\">:zzz:</span></p>",
        "id": 252717275,
        "sender_full_name": "Mara",
        "timestamp": 1631234869
    },
    {
        "content": "<p>oh bleh. <code>rust/library/profiler_builtins</code> is not built by cmake. but directly with the <code>cc</code> crate.</p>",
        "id": 252717386,
        "sender_full_name": "Mara",
        "timestamp": 1631234987
    },
    {
        "content": "<p>okay, i give up for now. time to sleep</p>",
        "id": 252717513,
        "sender_full_name": "Mara",
        "timestamp": 1631235105
    },
    {
        "content": "<p>I did a little more poking and understand the situation a little better. profiler_builtins is using LLVM 12.0.0 clang-cl, and AFAIK, <code>clang-cl</code> does not honor the WindowsSDKVersion environment variables set by vcvarsall. Newer versions support setting it in flags via <a href=\"https://reviews.llvm.org/D95472\">https://reviews.llvm.org/D95472</a> (which also nicely added some FIXMEs to add env var support). I'm a bit at a loss on how to set the appropriate paths with 12.0. If I am reading it correctly, it only looks at the registry entry. Maybe ci.yml should try setting the registry entry?</p>",
        "id": 252732745,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631249875
    },
    {
        "content": "<p>oh, ugh, yeah. that's a problem. there's almost no way to influence that version of clang-cl to pick another sdk. :/</p>",
        "id": 252762303,
        "sender_full_name": "Mara",
        "timestamp": 1631268524
    },
    {
        "content": "<p>i can't find a way to make it stop using it. even if i <code>rm -rf</code> that sdk, it still tries to use it and just fails to find include files.<br>\nso now i'm just removing that directory, and renaming the old sdk to the new name so it'll be used instead. super ugly, but it might work :/</p>",
        "id": 252763094,
        "sender_full_name": "Mara",
        "timestamp": 1631268994
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> <span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> here's a horrible workaround for unblocking the CI for now: <a href=\"https://github.com/rust-lang/rust/pull/88797\">https://github.com/rust-lang/rust/pull/88797</a></p>",
        "id": 252774650,
        "sender_full_name": "Mara",
        "timestamp": 1631275159
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"241545\" href=\"/#narrow/stream/241545-t-release/topic/beta.20rollup\">#t-release &gt; beta rollup</a> by <span class=\"user-mention silent\" data-user-id=\"310399\">Mara</span></p>",
        "id": 252774937,
        "sender_full_name": "Notification Bot",
        "timestamp": 1631275214
    },
    {
        "content": "<p>ok approved</p>",
        "id": 252778336,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1631276815
    },
    {
        "content": "<p>i'm not the right person to try to find a better way to do this though, so someone else will have to follow up to remove the hack. are there any windows experts in the infra team?</p>",
        "id": 252780790,
        "sender_full_name": "Mara",
        "timestamp": 1631277928
    },
    {
        "content": "<p>no</p>",
        "id": 252780852,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1631277962
    },
    {
        "content": "<p>I'll check in after work</p>",
        "id": 252780897,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1631277969
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"310399\">@Mara</span> for making a fix!  </p>\n<p>It's curious that just removing the directory didn't work completely.  If I am reading <a href=\"https://github.com/llvm/llvm-project/blob/llvmorg-12.0.0/clang/lib/Driver/ToolChains/MSVC.cpp#L1067-L1093\"><code>getWindows10SDKVersionFromPath</code></a> correctly, it <em>should</em> be scanning the <code>Include</code> directory for the largest numbered version.</p>",
        "id": 252796958,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631284754
    },
    {
        "content": "<p>yeah,that part probably works but something else probably refers to that directory too</p>",
        "id": 252797094,
        "sender_full_name": "Mara",
        "timestamp": 1631284816
    },
    {
        "content": "<p>idk</p>",
        "id": 252797101,
        "sender_full_name": "Mara",
        "timestamp": 1631284818
    },
    {
        "content": "<p>oh hey, it was merged. <span aria-label=\"relieved\" class=\"emoji emoji-1f60c\" role=\"img\" title=\"relieved\">:relieved:</span></p>",
        "id": 252828728,
        "sender_full_name": "Mara",
        "timestamp": 1631298334
    },
    {
        "content": "<p>hopefully we can have a few succesful big rollups now to get through the huge queue</p>",
        "id": 252828756,
        "sender_full_name": "Mara",
        "timestamp": 1631298350
    },
    {
        "content": "<p>I would be cautious -- big rollups sounds like a pain for perf. The queue seems like it'll sort itself out, and we can go for smaller rollups without too much pain.</p>",
        "id": 252828974,
        "sender_full_name": "simulacrum",
        "timestamp": 1631298439
    },
    {
        "content": "<p>also I would like to get <a href=\"https://github.com/rust-lang/rust/pull/87073\">https://github.com/rust-lang/rust/pull/87073</a> merged soonish and it can't be rolled up</p>",
        "id": 252830857,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1631299223
    }
]