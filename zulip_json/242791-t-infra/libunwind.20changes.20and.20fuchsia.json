[
    {
        "content": "<p>Hi, I'm trying to figure out how to fix a build breakage in fuchsia caused by <a href=\"https://github.com/rust-lang/rust/pull/85600\">https://github.com/rust-lang/rust/pull/85600</a>. We're unable to generate our prebuilts anymore and get the following error:</p>\n<div class=\"codehilite\"><pre><span></span><code>running: &quot;/b/s/w/ir/x/w/cipd/bin/llvm-ar&quot; &quot;cq&quot; &quot;/b/s/w/ir/x/w/staging/build/fuchsia-build/x86_64-unknown-linux-gnu/native/libunwind/libunwind.a&quot; ... &lt;lots snipped out&gt;\nexit status: 0\nrunning: &quot;/b/s/w/ir/x/w/cipd/bin/llvm-ar&quot; &quot;s&quot; &quot;/b/s/w/ir/x/w/staging/build/fuchsia-build/x86_64-unknown-linux-gnu/native/libunwind/libunwind.a&quot;\nexit status: 0\nBuilding stage0 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)\n   Compiling cc v1.0.69\n   Compiling core v0.0.0 (/b/s/w/ir/x/w/rust/library/core)\n   Compiling libc v0.2.99\n   Compiling memchr v2.4.1\n   Compiling std v0.0.0 (/b/s/w/ir/x/w/rust/library/std)\n   Compiling compiler_builtins v0.1.49\n   Compiling unwind v0.0.0 (/b/s/w/ir/x/w/rust/library/unwind)\n   Compiling profiler_builtins v0.0.0 (/b/s/w/ir/x/w/rust/library/profiler_builtins)\n   Compiling rustc-std-workspace-core v1.99.0 (/b/s/w/ir/x/w/rust/library/rustc-std-workspace-core)\n   Compiling alloc v0.0.0 (/b/s/w/ir/x/w/rust/library/alloc)\n   Compiling cfg-if v0.1.10\n   Compiling adler v0.2.3\n   Compiling rustc-demangle v0.1.21\n   Compiling rustc-std-workspace-alloc v1.99.0 (/b/s/w/ir/x/w/rust/library/rustc-std-workspace-alloc)\n   Compiling panic_unwind v0.0.0 (/b/s/w/ir/x/w/rust/library/panic_unwind)\n   Compiling panic_abort v0.0.0 (/b/s/w/ir/x/w/rust/library/panic_abort)\n   Compiling gimli v0.25.0\n   Compiling hashbrown v0.11.0\n   Compiling object v0.26.1\n   Compiling std_detect v0.1.5 (/b/s/w/ir/x/w/rust/library/stdarch/crates/std_detect)\n   Compiling miniz_oxide v0.4.0\n   Compiling addr2line v0.16.0\nerror: linking with `/b/s/w/ir/x/w/cipd/bin/clang++` failed: exit status: 1\n  |\n  = note: &quot;/b/s/w/ir/x/w/cipd/bin/clang++&quot; &quot;-Wl,--version-script=/b/s/w/ir/x/t/rustcPa9TC3/list&quot; ... &lt;lots snipped out&gt;  = note: ld.lld: error: unable to find library -lunwind\n          clang-14: error: linker command failed with exit code 1 (use -v to see invocation)\n</code></pre></div>",
        "id": 251783581,
        "sender_full_name": "Paul Faria",
        "timestamp": 1630615506
    },
    {
        "content": "<p>Following the PR comments, I added <code>-Clink-self-contained=yes</code> to <code>RUSTFLAGS</code> in our build env.</p>",
        "id": 251783692,
        "sender_full_name": "Paul Faria",
        "timestamp": 1630615548
    },
    {
        "content": "<p>This gets past stage0, but when building stage1, calls to <code>rustc -vV</code> fail with a seg fault. The binary seems much smaller than normal, at 2.2KB, and lldb and gdb both disagree on the assembly line where the crash occurs.</p>",
        "id": 251783843,
        "sender_full_name": "Paul Faria",
        "timestamp": 1630615621
    },
    {
        "content": "<p>This is fixed by in <a href=\"https://github.com/rust-lang/rust/pull/88483\">https://github.com/rust-lang/rust/pull/88483</a>.</p>",
        "id": 251793809,
        "sender_full_name": "Vadim Petrochenkov",
        "timestamp": 1630620395
    },
    {
        "content": "<p>Could you actually answer the questions from <a href=\"https://github.com/rust-lang/rust/pull/88483#issuecomment-908567110\">https://github.com/rust-lang/rust/pull/88483#issuecomment-908567110</a> but in application to Fuchsia?</p>",
        "id": 251793985,
        "sender_full_name": "Vadim Petrochenkov",
        "timestamp": 1630620494
    },
    {
        "content": "<blockquote>\n<p>calls to <code>rustc -vV</code> fail with a seg fault. The binary seems much smaller than normal, at 2.2KB, and lldb and gdb both disagree on the assembly line where the crash occurs.</p>\n</blockquote>\n<p>Ok, this looks worse.<br>\nDoes <a href=\"https://github.com/rust-lang/rust/issues/88483\">#88483</a> fixes the crash? (That would mean some kind of inconsistent use of <code>-Clink-self-contained</code> in the build, or wrong <code>libunwind.a</code> being found).<br>\nIf the crash is not fixed, it means <code>libunwind.a</code> is built incorrectly now and we need to figure out what is the difference with the old build.</p>",
        "id": 251794503,
        "sender_full_name": "Vadim Petrochenkov",
        "timestamp": 1630620797
    },
    {
        "content": "<p>Let me build that change locally and see if it fixes the issue</p>",
        "id": 251888286,
        "sender_full_name": "Paul Faria",
        "timestamp": 1630678962
    },
    {
        "content": "<p>It looks like our builders are starting to pass (faster than my local :D). I'll monitor our test suites to see if this introduces any issues.</p>",
        "id": 251894317,
        "sender_full_name": "Paul Faria",
        "timestamp": 1630681377
    },
    {
        "content": "<p>Do you still want me to get someone to comment on the question? I'm on call this week for the rolls but am not very familiar with what the unwind story looks like in our build.</p>",
        "id": 251894414,
        "sender_full_name": "Paul Faria",
        "timestamp": 1630681423
    },
    {
        "content": "<p>Updating: all of our builds are passing again. Thanks <span class=\"user-mention\" data-user-id=\"123856\">@Vadim Petrochenkov</span> !</p>",
        "id": 251941213,
        "sender_full_name": "Paul Faria",
        "timestamp": 1630702790
    },
    {
        "content": "<blockquote>\n<p>Do you still want me to get someone to comment on the question?</p>\n</blockquote>\n<p>Yes, that would be nice, we may want to switch to the alternative scheme from <a href=\"https://github.com/rust-lang/rust/pull/88483#issuecomment-908584797\">https://github.com/rust-lang/rust/pull/88483#issuecomment-908584797</a> in the future.</p>",
        "id": 251951829,
        "sender_full_name": "Vadim Petrochenkov",
        "timestamp": 1630709480
    }
]