[
    {
        "content": "<p><span class=\"user-group-mention\" data-user-group-id=\"2943\">@T-infra</span> T-7min</p>",
        "id": 240853579,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622479977
    },
    {
        "content": "<p>I’m traveling today so mostly read-only. (Holiday in the US today)</p>",
        "id": 240853621,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1622480023
    },
    {
        "content": "<p>huh TIL may 31 is holiday in the US <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 240853841,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480166
    },
    {
        "content": "<p><span class=\"user-group-mention\" data-user-group-id=\"2943\">@T-infra</span> meeting time!</p>",
        "id": 240854331,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480526
    },
    {
        "content": "<p>o/</p>",
        "id": 240854341,
        "sender_full_name": "simulacrum",
        "timestamp": 1622480535
    },
    {
        "content": "<p>o/</p>",
        "id": 240854346,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622480539
    },
    {
        "content": "<p>huh, also happens to be holiday in uk</p>",
        "id": 240854361,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622480559
    },
    {
        "content": "<p>am I the only one <em>not</em> on holiday here? <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 240854406,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480595
    },
    {
        "content": "<p>ok let's start</p>",
        "id": 240854503,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480652
    },
    {
        "content": "<p>we don't have any issues to look at, and the only item on the agenda is <a href=\"http://crates.io\">crates.io</a> monitoring</p>",
        "id": 240854521,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480668
    },
    {
        "content": "<p>I actually have news!</p>",
        "id": 240854542,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480681
    },
    {
        "content": "<p>this morning I looked if there were any out-of-the-box solutions that would allow us to both collect heroku postgresql metrics and instance-level <a href=\"http://crates.io\">crates.io</a> metrics, and I stumbled upon <a href=\"https://vector.dev/\">https://vector.dev/</a></p>",
        "id": 240854684,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480771
    },
    {
        "content": "<p>oh oops, I've been using that personally for a while <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 240854706,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622480802
    },
    {
        "content": "<p>Vector is a tool (written in Rust <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span>) that allows to receive, transform and forward <em>both</em> metrics and logs</p>",
        "id": 240854708,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480802
    },
    {
        "content": "<p>and it has support for custom lua scripts doing transformations</p>",
        "id": 240854735,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480830
    },
    {
        "content": "<p>I spent this afternoon playing around with it, and I now have a proof-of-concept docker container that receives the postgres log messages and exports them as prometheus metrics</p>",
        "id": 240854789,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480870
    },
    {
        "content": "<p>oh wait - so it can transform logs <em>into</em> metrics?</p>",
        "id": 240854854,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622480895
    },
    {
        "content": "<p>with custom lua scripts yes</p>",
        "id": 240854866,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480903
    },
    {
        "content": "<p>that I did not realise</p>",
        "id": 240854868,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622480904
    },
    {
        "content": "<p><a href=\"https://github.com/pietroalbini/crates-io-heroku-metrics/blob/7bb68389cc61d817817e45f8aef00a003c05a702/src/vector.toml#L34-L71\">https://github.com/pietroalbini/crates-io-heroku-metrics/blob/7bb68389cc61d817817e45f8aef00a003c05a702/src/vector.toml#L34-L71</a></p>",
        "id": 240854874,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480911
    },
    {
        "content": "<p>took me a while to realize it too after looking how to do it in the docs</p>",
        "id": 240854879,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480922
    },
    {
        "content": "<p>nifty</p>",
        "id": 240854887,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622480932
    },
    {
        "content": "<p>looks a bit hacky, but not too bad</p>",
        "id": 240854921,
        "sender_full_name": "simulacrum",
        "timestamp": 1622480965
    },
    {
        "content": "<p>it's a bit hacky but it relies on fully documented behavior</p>",
        "id": 240854928,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622480970
    },
    {
        "content": "<p>yeah seems pretty good</p>",
        "id": 240855047,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481065
    },
    {
        "content": "<p>sounds brill</p>",
        "id": 240855076,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622481094
    },
    {
        "content": "<p>so, my current thinking would be to use vector and:</p>\n<ul>\n<li>for heroku postgres use a custom lua transform to parse the log line and turn it into multiple metrics</li>\n<li>for instance-level, have the application output the datastructures Vector expects into a single log line, and have a custom lua transform to split them into multiple events/metrics</li>\n</ul>",
        "id": 240855084,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481098
    },
    {
        "content": "<p>so this would be reimplementing some of the instance-level datagathering? that would clasically be done by <code>node_exporter</code></p>",
        "id": 240855227,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622481203
    },
    {
        "content": "<p>Does that start to give us anything towards an actual logging platform?</p>",
        "id": 240855236,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1622481213
    },
    {
        "content": "<p>in my proof of concept I also have nginx in the container, adding authentication and merging the multiple ports into a single one (the heroku source and the prometheus sink otherwise have different ports)</p>",
        "id": 240855255,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481234
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"117568\">Aidan Hobson Sayers</span> <a href=\"#narrow/stream/242791-t-infra/topic/meeting.202021-05-31/near/240855227\">said</a>:</p>\n<blockquote>\n<p>so this would be reimplementing some of the instance-level datagathering? that would clasically be done by <code>node_exporter</code></p>\n</blockquote>\n<p>during this thing for instance-level I meant instance-level <em>application</em> metrics, like request counts, in-flight requests and database pool status</p>",
        "id": 240855335,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481294
    },
    {
        "content": "<p>this doesn't cover <code>node_exporter</code>-like metrics on the dyno unfortunately, worst case scenario we could have <code>vector</code> on the dynos too writing to our main <code>vector</code> instance</p>",
        "id": 240855384,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481339
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116155\">Jake Goulding</span> <a href=\"#narrow/stream/242791-t-infra/topic/meeting.202021-05-31/near/240855236\">said</a>:</p>\n<blockquote>\n<p>Does that start to give us anything towards an actual logging platform?</p>\n</blockquote>\n<p>hmm, we're already using cloudwatch logs for stuff on aws and papertrail for heroku, is there something you'd need on the playground?</p>",
        "id": 240855449,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481368
    },
    {
        "content": "<p>so, is there any concern on this approach or should we go with it?</p>",
        "id": 240855587,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481499
    },
    {
        "content": "<p>I'm still a bit unhappy but it doesn't sound like there's not <em>really</em> significantly better options</p>",
        "id": 240855633,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481540
    },
    {
        "content": "<p>When doing Prometheus stuff, it was recommended to avoid having “too much” in Prometheus and to try and do more via logs. I didn’t think we had a way to aggregate logs and then surface pretty graphs from them</p>",
        "id": 240855650,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1622481556
    },
    {
        "content": "<p>I think writing up the options we considered -- similar to the doc you had already prepared for the remote write option -- and posting a bit to internals or so to see if there's any strongly negative reactions or so</p>",
        "id": 240855661,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481573
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <a href=\"#narrow/stream/242791-t-infra/topic/meeting.202021-05-31/near/240855633\">said</a>:</p>\n<blockquote>\n<p>I'm still a bit unhappy but it doesn't sound like there's not <em>really</em> significantly better options</p>\n</blockquote>\n<p>I'm wondering what improvement would you like to see</p>",
        "id": 240855778,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481672
    },
    {
        "content": "<p>oh, mostly just feels unfortunate to have so many moving pieces and services</p>",
        "id": 240855807,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481718
    },
    {
        "content": "<p>but I'm not actually seeing ways to avoid it really</p>",
        "id": 240855852,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481725
    },
    {
        "content": "<p>just feels like there's something wrong underlying it all, so to speak</p>",
        "id": 240855872,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481740
    },
    {
        "content": "<p>heh, mainly it's that heroku doesn't expose the metrics in any way other than log messages :(</p>",
        "id": 240855892,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481767
    },
    {
        "content": "<p>IMO that's the underlying thing that's wrong</p>",
        "id": 240855915,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481786
    },
    {
        "content": "<p>well, sure, though that's not the full scope, but yeah -- I mean ultimately I'm not against this, just unhappy :)</p>",
        "id": 240855919,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481788
    },
    {
        "content": "<p>the eternal cry when working with computers - \"there must be a better way\" <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 240855952,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622481824
    },
    {
        "content": "<p>certainly it doesn't feel elegant</p>",
        "id": 240855961,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481839
    },
    {
        "content": "<p>but oh well</p>",
        "id": 240856007,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481846
    },
    {
        "content": "<p>I do think the internals post is not a bad idea, as it lets us source from a lot more knowledge/history</p>",
        "id": 240856064,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481871
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <a href=\"#narrow/stream/242791-t-infra/topic/meeting.202021-05-31/near/240855661\">said</a>:</p>\n<blockquote>\n<p>I think writing up the options we considered -- similar to the doc you had already prepared for the remote write option -- and posting a bit to internals or so to see if there's any strongly negative reactions or so</p>\n</blockquote>\n<p>hmm, how useful do you think this would be? I'd really like to have metrics up soon and I'm not sure whether there are a lot of people with experience in our exact stack on internals</p>",
        "id": 240856100,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481903
    },
    {
        "content": "<p>I mean our exact stack is ... heroku and prometheus, right?</p>",
        "id": 240856178,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481961
    },
    {
        "content": "<p>that seems 'hopefully common'</p>",
        "id": 240856224,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481969
    },
    {
        "content": "<p>I don't think it needs to block metrics, to be clear</p>",
        "id": 240856232,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481978
    },
    {
        "content": "<p>well, due to the limitations I'm not sure how common it is <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 240856239,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622481982
    },
    {
        "content": "<p>but I think having it up even as a documentation piece that we can refer back to when looking back would be good</p>",
        "id": 240856261,
        "sender_full_name": "simulacrum",
        "timestamp": 1622481998
    },
    {
        "content": "<p>and, hey, if someone proposes a much better option we can always put migrating to it on the issue log</p>",
        "id": 240856284,
        "sender_full_name": "simulacrum",
        "timestamp": 1622482022
    },
    {
        "content": "<p>one option is implementation to try it out and shake out any issues, then documenting with architecture diagrams/whatever and posting on internals for feedback</p>",
        "id": 240856328,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622482074
    },
    {
        "content": "<p>yeah</p>",
        "id": 240856385,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622482095
    },
    {
        "content": "<p>sure, that seems reasonable, order doesn't matter as much to me</p>",
        "id": 240856393,
        "sender_full_name": "simulacrum",
        "timestamp": 1622482108
    },
    {
        "content": "<p>ok, so, I'll move the proof of concept repo to the rust-lang org, polish it up and deploy it to Fargate in the coming days</p>",
        "id": 240856394,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622482109
    },
    {
        "content": "<p>I just want some documentation-y stuff, and posting that just seems like an easy possible (though unlikely) win</p>",
        "id": 240856405,
        "sender_full_name": "simulacrum",
        "timestamp": 1622482125
    },
    {
        "content": "<p>I'll definitely write docs on its design</p>",
        "id": 240856421,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622482143
    },
    {
        "content": "<p>ok! I have a really quick thing to discuss in private, otherwise thanks everyone!</p>",
        "id": 240856435,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622482158
    },
    {
        "content": "<p>\\o</p>",
        "id": 240856436,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622482159
    },
    {
        "content": "<p>\\o</p>",
        "id": 240856461,
        "sender_full_name": "Aidan Hobson Sayers",
        "timestamp": 1622482185
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116155\">Jake Goulding</span> <a href=\"#narrow/stream/242791-t-infra/topic/meeting.202021-05-31/near/240855650\">said</a>:</p>\n<blockquote>\n<p>When doing Prometheus stuff, it was recommended to avoid having “too much” in Prometheus and to try and do more via logs. I didn’t think we had a way to aggregate logs and then surface pretty graphs from them</p>\n</blockquote>\n<p>hmm, we don't have that right now -- we're at a scale where moving every metric and graph to prometheus should work just fine, unless it's something hard to gather with prometheus</p>",
        "id": 240856855,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1622482451
    },
    {
        "content": "<p>I also am not sure how much that recommendation really makes sense -- it's my understanding that there's basically just two separate <em>kinds</em> of data, some is best sourced through logs, some is best sourced through metrics -- basically unbounded value sets vs. bounded value sets</p>",
        "id": 240857069,
        "sender_full_name": "simulacrum",
        "timestamp": 1622482667
    },
    {
        "content": "<p>I could definitely be wrong though!</p>",
        "id": 240857081,
        "sender_full_name": "simulacrum",
        "timestamp": 1622482677
    }
]