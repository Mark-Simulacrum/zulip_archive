[
    {
        "content": "<p>I can't find any discussion or issues about this, but I was waiting for today's nightly (i.e. the one that should've been released ~16h ago), as it has one of my PRs in it, and it's just not there</p>",
        "id": 254237191,
        "sender_full_name": "eddyb",
        "timestamp": 1632241958
    },
    {
        "content": "<p>Hm this could be the terraform changes fault</p>",
        "id": 254237371,
        "sender_full_name": "simulacrum",
        "timestamp": 1632242024
    },
    {
        "content": "<p>I don't know if this is the right place to discuss it, but I can't quickly find anywhere that would let me see the logs for the automated promotion of a build to nightly, so I'm guessing that stuff is private and maintained by T-infra</p>",
        "id": 254237373,
        "sender_full_name": "eddyb",
        "timestamp": 1632242024
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <a href=\"#narrow/stream/242791-t-infra/topic/2021-09-21.20nightly.20missing/near/254237371\">said</a>:</p>\n<blockquote>\n<p>Hm this could be the terraform changes fault</p>\n</blockquote>\n<p>hmm and nobody wanted specifically today's nightly yet?</p>",
        "id": 254237483,
        "sender_full_name": "eddyb",
        "timestamp": 1632242053
    },
    {
        "content": "<p>so nobody noticed?</p>",
        "id": 254237522,
        "sender_full_name": "eddyb",
        "timestamp": 1632242068
    },
    {
        "content": "<p>Yeah seems possible let me look</p>",
        "id": 254237543,
        "sender_full_name": "simulacrum",
        "timestamp": 1632242079
    },
    {
        "content": "<p>looking at recent issues, there's <a href=\"https://github.com/rust-lang/rust/issues/89085#issuecomment-923344467\">https://github.com/rust-lang/rust/issues/89085#issuecomment-923344467</a> so maybe <span class=\"user-mention\" data-user-id=\"307537\">@Noah Lev</span> could've run into it, but only if trying to test the fix (yay timezones)</p>",
        "id": 254237785,
        "sender_full_name": "eddyb",
        "timestamp": 1632242184
    },
    {
        "content": "<blockquote>\n<p>Error: No space left on device (os error 28)</p>\n</blockquote>",
        "id": 254238356,
        "sender_full_name": "simulacrum",
        "timestamp": 1632242399
    },
    {
        "content": "<p>well that's awkward</p>",
        "id": 254238362,
        "sender_full_name": "simulacrum",
        "timestamp": 1632242401
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> -- looks like nightly is \"too big\"</p>",
        "id": 254238497,
        "sender_full_name": "simulacrum",
        "timestamp": 1632242448
    },
    {
        "content": "<p>looks like we're on BUILD_GENERAL1_LARGE with a linux container right now</p>",
        "id": 254239223,
        "sender_full_name": "simulacrum",
        "timestamp": 1632242707
    },
    {
        "content": "<p>that gives us 128 GB</p>",
        "id": 254239265,
        "sender_full_name": "simulacrum",
        "timestamp": 1632242721
    },
    {
        "content": "<p>unfortunately it looks like the next tier is <em>way</em> bigger</p>",
        "id": 254239567,
        "sender_full_name": "simulacrum",
        "timestamp": 1632242826
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/242791-t-infra/topic/2021-09-21.20nightly.20missing/near/254237785\">said</a>:</p>\n<blockquote>\n<p>looking at recent issues, there's <a href=\"https://github.com/rust-lang/rust/issues/89085#issuecomment-923344467\">https://github.com/rust-lang/rust/issues/89085#issuecomment-923344467</a> so maybe <span class=\"user-mention silent\" data-user-id=\"307537\">Noah Lev</span> could've run into it, but only if trying to test the fix (yay timezones)</p>\n</blockquote>\n<p>Yeah, I haven't tried to download the nightly because I don't have a machine to test that issue on. I was just notifying the people on the issue who would be able to test.</p>",
        "id": 254240409,
        "sender_full_name": "Noah Lev",
        "timestamp": 1632243148
    },
    {
        "content": "<p>But, indeed, <code>rustup update nightly</code> for me says the latest release was 2021-09-19, not 2021-09-20. (EDIT: fixed incorrect date)</p>",
        "id": 254240537,
        "sender_full_name": "Noah Lev",
        "timestamp": 1632243203
    },
    {
        "content": "<p>Okay, I'm going to temporarily bump us up to the next tier -- it is more expensive, but in the short term that seems like the right fix</p>",
        "id": 254240607,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243236
    },
    {
        "content": "<p>I'm wondering, what artifacts are taking up so much space?</p>",
        "id": 254240805,
        "sender_full_name": "Noah Lev",
        "timestamp": 1632243307
    },
    {
        "content": "<p>Well, each release is pretty large, currently we try to store everything on the same disk</p>",
        "id": 254241003,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243373
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/promote-release/\">https://github.com/rust-lang/promote-release/</a> is where the code running here lives</p>",
        "id": 254241084,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243398
    },
    {
        "content": "<p>Are all targets' artifacts on one disk, or one target per disk?</p>",
        "id": 254241127,
        "sender_full_name": "Noah Lev",
        "timestamp": 1632243415
    },
    {
        "content": "<p>I think the fix is probably to make it more of a streaming computation rather than \"download everything\", then process, then reupload</p>",
        "id": 254241153,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243426
    },
    {
        "content": "<p>all artifacts (targets, hosts, etc.) for a given release</p>",
        "id": 254241201,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243445
    },
    {
        "content": "<p>does AWS not have a remote copy command or something?</p>",
        "id": 254241215,
        "sender_full_name": "eddyb",
        "timestamp": 1632243454
    },
    {
        "content": "<p>it does</p>",
        "id": 254241223,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243458
    },
    {
        "content": "<p>I'm surprised they're downloaded at all</p>",
        "id": 254241246,
        "sender_full_name": "eddyb",
        "timestamp": 1632243468
    },
    {
        "content": "<p>well, I think so, it's just that we do some processing too</p>",
        "id": 254241247,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243469
    },
    {
        "content": "<p>like recompression and such</p>",
        "id": 254241262,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243473
    },
    {
        "content": "<p>aaah interesting</p>",
        "id": 254241277,
        "sender_full_name": "eddyb",
        "timestamp": 1632243479
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307537\">Noah Lev</span> <a href=\"#narrow/stream/242791-t-infra/topic/2021-09-21.20nightly.20missing/near/254240409\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/242791-t-infra/topic/2021-09-21.20nightly.20missing/near/254237785\">said</a>:</p>\n<blockquote>\n<p>looking at recent issues, there's <a href=\"https://github.com/rust-lang/rust/issues/89085#issuecomment-923344467\">https://github.com/rust-lang/rust/issues/89085#issuecomment-923344467</a> so maybe <span class=\"user-mention silent\" data-user-id=\"307537\">Noah Lev</span> could've run into it, but only if trying to test the fix (yay timezones)</p>\n</blockquote>\n<p>Yeah, I haven't tried to download the nightly because I don't have a machine to test that issue on. I was just notifying the people on the issue who would be able to test.</p>\n</blockquote>\n<p>Ok, I left a comment on the issue so people aren't confused about why the nightly didn't get released.</p>",
        "id": 254241577,
        "sender_full_name": "Noah Lev",
        "timestamp": 1632243584
    },
    {
        "content": "<p>I'm off to back to back meetings for the next 6 hours or something, but we should have a nightly in ~7 hours? it's 5pm utc</p>",
        "id": 254241825,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243638
    },
    {
        "content": "<p>yeah, I'll check tomorrow morning. thanks a lot!</p>",
        "id": 254241952,
        "sender_full_name": "eddyb",
        "timestamp": 1632243683
    },
    {
        "content": "<p>(I am not issuing a nightly right now because don't want to break things more on accident, though I think it would've been fine)</p>",
        "id": 254242035,
        "sender_full_name": "simulacrum",
        "timestamp": 1632243720
    },
    {
        "content": "<p>no worries, it's pretty late over here anyway</p>",
        "id": 254242124,
        "sender_full_name": "eddyb",
        "timestamp": 1632243742
    },
    {
        "content": "<p>I also took the step of setting up a notification for <a href=\"mailto:admin@rust-lang.org\">admin@rust-lang.org</a> from aws that should <em>hopefully</em> tell us when this happens in the future</p>",
        "id": 254262932,
        "sender_full_name": "simulacrum",
        "timestamp": 1632252144
    },
    {
        "content": "<p>it's not quite the eventual way to do it probably (should integrate into our prometheus/grafana setup, I guess), but seems like a good step</p>",
        "id": 254262995,
        "sender_full_name": "simulacrum",
        "timestamp": 1632252172
    },
    {
        "content": "<p>OK, looks like the build failed, probably due to my changes -- some permissions error</p>",
        "id": 254296944,
        "sender_full_name": "simulacrum",
        "timestamp": 1632269441
    },
    {
        "content": "<p>and we have a nightly after fixing those!</p>",
        "id": 254300719,
        "sender_full_name": "simulacrum",
        "timestamp": 1632272630
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307537\">Noah Lev</span> <a href=\"#narrow/stream/242791-t-infra/topic/2021-09-21.20nightly.20missing/near/254241577\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"307537\">Noah Lev</span> <a href=\"#narrow/stream/242791-t-infra/topic/2021-09-21.20nightly.20missing/near/254240409\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/242791-t-infra/topic/2021-09-21.20nightly.20missing/near/254237785\">said</a>:</p>\n<blockquote>\n<p>looking at recent issues, there's <a href=\"https://github.com/rust-lang/rust/issues/89085#issuecomment-923344467\">https://github.com/rust-lang/rust/issues/89085#issuecomment-923344467</a> so maybe <span class=\"user-mention silent\" data-user-id=\"307537\">Noah Lev</span> could've run into it, but only if trying to test the fix (yay timezones)</p>\n</blockquote>\n<p>Yeah, I haven't tried to download the nightly because I don't have a machine to test that issue on. I was just notifying the people on the issue who would be able to test.</p>\n</blockquote>\n<p>Ok, I left a comment on the issue so people aren't confused about why the nightly didn't get released.</p>\n</blockquote>\n<p>Btw, OP closed issue because they say the new nightly fixes it <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 254306229,
        "sender_full_name": "Noah Lev",
        "timestamp": 1632277445
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> this is really weird</p>",
        "id": 254329973,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1632297867
    },
    {
        "content": "<p>.xz artifacts for a nightly are 19.8gb</p>",
        "id": 254330009,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1632297898
    },
    {
        "content": "<p>so 128gb should be really really enough</p>",
        "id": 254330042,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1632297919
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <a href=\"#narrow/stream/242791-t-infra/topic/2021-09-21.20nightly.20missing/near/254262932\">said</a>:</p>\n<blockquote>\n<p>I also took the step of setting up a notification for <a href=\"mailto:admin@rust-lang.org\">admin@rust-lang.org</a> from aws that should <em>hopefully</em> tell us when this happens in the future</p>\n</blockquote>\n<p>is that on terraform?</p>",
        "id": 254330171,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1632297984
    },
    {
        "content": "<p>hmm... <a href=\"https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-compute-types.html\">https://docs.aws.amazon.com/codebuild/latest/userguide/build-env-ref-compute-types.html</a></p>\n<blockquote>\n<p>The disk space listed for each build environment is available only in the directory specified by the CODEBUILD_SRC_DIR environment variable.</p>\n</blockquote>",
        "id": 254330333,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1632298083
    },
    {
        "content": "<p>ok I think if we change <code>/release</code> <a href=\"https://github.com/rust-lang/simpleinfra/blob/cd173bfafb96561d601159157e41d569824bf53a/terraform/releases/impl/promote-release.tf#L29\">here</a> to <code>\"${CODEBUILD_SRC_DIR}/work\"</code> it <em>should</em> work again?</p>",
        "id": 254330733,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1632298330
    },
    {
        "content": "<p>I can try making and debugging the changes if you confirm terraform is up to date <span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span></p>",
        "id": 254330854,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1632298410
    },
    {
        "content": "<p>I haven't pushed yet <span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> no</p>",
        "id": 254345876,
        "sender_full_name": "simulacrum",
        "timestamp": 1632306486
    },
    {
        "content": "<p>I'll take a look this morning and update that, maybe do a dev static nightly to test it or something</p>",
        "id": 254345952,
        "sender_full_name": "simulacrum",
        "timestamp": 1632306548
    },
    {
        "content": "<p>sounds good!</p>",
        "id": 254345987,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1632306572
    },
    {
        "content": "<p>ok, changed to that locally and kicked off dev-static nightly</p>",
        "id": 254354953,
        "sender_full_name": "simulacrum",
        "timestamp": 1632312038
    },
    {
        "content": "<p><span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span> .</p>",
        "id": 254355492,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1632312325
    }
]