[
    {
        "content": "<p>Guess that's an ordering issue.\u0010 Will need to trigger the scheduled job manually.</p>",
        "id": 272698428,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645455378
    },
    {
        "content": "<p>It probably will magically fix itself before I do anything though, as the job will run soonish.</p>",
        "id": 272698475,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645455411
    },
    {
        "content": "<p>hmm ok, could you fix the ansible config so that the job gets executed as part of the initial deploy?</p>",
        "id": 272698508,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645455427
    },
    {
        "content": "<p>That should have set up the <code>shep</code> user and my public key from <a href=\"https://github.com/rust-lang/simpleinfra/blob/master/ansible/roles/common/files/ssh-keys/shep.pub\">https://github.com/rust-lang/simpleinfra/blob/master/ansible/roles/common/files/ssh-keys/shep.pub</a> right?</p>",
        "id": 272700354,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645456259
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>shep@play-next.infra.rust-lang.org: Permission denied (publickey).\n</code></pre></div>",
        "id": 272700513,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645456326
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>Feb 21 14:58:35 play-next.infra.rust-lang.org update.sh[1400]: 3465bfb19f73: Download complete\nFeb 21 14:58:36 play-next.infra.rust-lang.org update.sh[1400]: 1fc18b827f25: Verifying Checksum\nFeb 21 14:58:36 play-next.infra.rust-lang.org update.sh[1400]: 1fc18b827f25: Download complete\nFeb 21 14:58:36 play-next.infra.rust-lang.org update.sh[1400]: 4e5154cd88c2: Verifying Checksum\nFeb 21 14:58:36 play-next.infra.rust-lang.org update.sh[1400]: 4e5154cd88c2: Download complete\nFeb 21 14:58:42 play-next.infra.rust-lang.org update.sh[1400]: write /var/lib/docker/tmp/GetImageBlob847869486: no space left on device\n</code></pre></div>\n<p><span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 272705433,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645458732
    },
    {
        "content": "<p>I did see that it was allocated 8GB, which was surprising.</p>",
        "id": 272707298,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645459613
    },
    {
        "content": "<p>what size do you recommend?</p>",
        "id": 272707595,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645459748
    },
    {
        "content": "<p>As the containers themselves total ~8GB, and you'd need an OS on top of that. Plus another few GB to be able to download the next day's containers.</p>",
        "id": 272707644,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645459778
    },
    {
        "content": "<p>My instance is <code>/dev/xvda1       39G   24G   15G  62% /</code></p>",
        "id": 272707655,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645459787
    },
    {
        "content": "<p>ok</p>",
        "id": 272707679,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645459801
    },
    {
        "content": "<p>so 30GB is probably a minimum</p>",
        "id": 272707699,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645459802
    },
    {
        "content": "<p>bumped to 100gb</p>",
        "id": 272710175,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645461153
    },
    {
        "content": "<p>just to be sure</p>",
        "id": 272710179,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645461155
    },
    {
        "content": "<p>started playground-update</p>",
        "id": 272710408,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645461275
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>Feb 21 16:38:05 play-next.infra.rust-lang.org update.sh[1945]: aws s3 sync --region=us-east-2 s3://playground-artifacts-i32 &quot;${artifacts_path}&quot;\nFeb 21 16:38:06 play-next.infra.rust-lang.org update.sh[2614]: fatal error: Unable to locate credentials\n</code></pre></div>",
        "id": 272710992,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645461560
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116155\">Jake Goulding</span> <a href=\"#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272700513\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\"><pre><span></span><code>shep@play-next.infra.rust-lang.org: Permission denied (publickey).\n</code></pre></div><br>\n</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> anything I'm missing here?</p>\n<div class=\"codehilite\"><pre><span></span><code>Host playground-next\nHostname  play-next.infra.rust-lang.org\nProxyJump bastion\nUser shep\n</code></pre></div>",
        "id": 272753246,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645496313
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"121055\">Pietro Albini</span> <a href=\"#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272710992\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\"><pre><span></span><code>Feb 21 16:38:05 play-next.infra.rust-lang.org update.sh[1945]: aws s3 sync --region=us-east-2 s3://playground-artifacts-i32 &quot;${artifacts_path}&quot;\nFeb 21 16:38:06 play-next.infra.rust-lang.org update.sh[2614]: fatal error: Unable to locate credentials\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>So these creds should be coming from <code>vars_playground_aws</code> <a href=\"https://github.com/rust-lang/simpleinfra/blob/421f6a4429c8e6a60349ffd5f5192a89892ff08d/ansible/envs/dev-example/group_vars/playground.yml#L5-L7\">e.g.</a> but it doesn't look like the <a href=\"https://github.com/rust-lang/simpleinfra/blob/master/ansible/envs/prod/group_vars/playground.yml\">production file</a> has them</p>",
        "id": 272753450,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645496591
    },
    {
        "content": "<p>but AFAIK I don't have access to the data in <code>ssm_playground: \"{{ lookup('aws_ssm', '/prod/ansible/playground/', region='us-west-1', shortnames=true, bypath=true, recursive=true) }}\"</code> so I don't think I know what the field(s) should be.</p>",
        "id": 272753511,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645496650
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116155\">Jake Goulding</span> <a href=\"#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272753246\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"116155\">Jake Goulding</span> <a href=\"#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272700513\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\"><pre><span></span><code>shep@play-next.infra.rust-lang.org: Permission denied (publickey).\n</code></pre></div><br>\n</p>\n</blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"121055\">Pietro Albini</span> anything I'm missing here?</p>\n<p><div class=\"codehilite\"><pre><span></span><code>Host playground-next\nHostname  play-next.infra.rust-lang.org\nProxyJump bastion\nUser shep\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>looks correct, I'll check what's wrong later today</p>",
        "id": 272770552,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645517278
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116155\">Jake Goulding</span> <a href=\"#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/272753511\">said</a>:</p>\n<blockquote>\n<p>but AFAIK I don't have access to the data in <code>ssm_playground: \"{{ lookup('aws_ssm', '/prod/ansible/playground/', region='us-west-1', shortnames=true, bypath=true, recursive=true) }}\"</code> so I don't think I know what the field(s) should be.</p>\n</blockquote>\n<p>those are not configured in SSM either. the question I have is, what resources do these credentials need to have access to?</p>",
        "id": 272770627,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645517322
    },
    {
        "content": "<p>I upload the binary and asset files to my S3 bucket (<code>s3://playground-artifacts-i32</code>).</p>\n<p>Remembering now, <a href=\"https://github.com/rust-lang/simpleinfra/pull/78#discussion_r724509310\">you said</a> that in production we wouldn't actually set those values as environment variables:</p>\n<blockquote>\n<p>in production we shouldn't use IAM Users with hardcoded access keys, we should use a IAM Role attached to the EC2 instance.</p>\n</blockquote>",
        "id": 272808045,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645539334
    },
    {
        "content": "<p>yes, but that works if everything is in the same aws account</p>",
        "id": 272808249,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645539422
    },
    {
        "content": "<p>(you <em>can</em> make that work with cross-account role assumption, but that's more complex)</p>",
        "id": 272808279,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645539438
    },
    {
        "content": "<p>that data should probably be in a bucket in our aws account</p>",
        "id": 272808309,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645539456
    },
    {
        "content": "<p>Then I'll need access keys to upload from CI and download to my instance.</p>",
        "id": 272808445,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645539504
    },
    {
        "content": "<p>Or figure out how to make the assets public for download/sync but somehow prevent some malicious person from putting it in a loop and running up my S3 bill (the only reason I put the download behind auth to start with)</p>",
        "id": 272808621,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645539596
    },
    {
        "content": "<p>I'll think of something later today</p>",
        "id": 272808828,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645539683
    },
    {
        "content": "<p>And there's also \"grab the creds from the current playground and put them in SSM\"</p>",
        "id": 272815395,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1645542479
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116155\">@Jake Goulding</span> ok I think the best solution in this case is for the playground's CI to upload to both the rust bucket and whatever bucket you want to use for your own instances</p>",
        "id": 273405041,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645970340
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116155\">@Jake Goulding</span> created the <code>rust-playground-artifacts</code> s3 bucket. The instances has read access to it, and GitHub Actions on the <code>master</code> branch in the <a href=\"https://github.com/integer32llc/rust-playground\">https://github.com/integer32llc/rust-playground</a> has access to it as well (through OIDC federation). You can configure credentials on GitHub Actions with:</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code><span class=\"p p-Indicator\">-</span><span class=\"w\"> </span><span class=\"nt\">name</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">Configure AWS Credentials</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">uses</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">aws-actions/configure-aws-credentials@v1</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nt\">with</span><span class=\"p\">:</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">role-to-assume</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">arn:aws:iam::890664054962:role/upload-playground-artifacts</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nt\">aws-region</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"l l-Scalar l-Scalar-Plain\">us-west-1</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 273407200,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645973269
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> by the way, I created the infra needed to authenticate to AWS from GitHub Actions in <a href=\"https://github.com/rust-lang/simpleinfra/commit/72524e9668ec27eb1e5d4dff5fa826919f4be647\">this commit</a>, and here's an example of <a href=\"https://github.com/rust-lang/simpleinfra/blob/54d93a21e9d017f9825299e47c06e86c004990a3/terraform/playground/artifacts.tf\">a role using that</a></p>",
        "id": 273407289,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645973400
    },
    {
        "content": "<p>I've been using OIDC authentication at work for a while and it's so so so useful, eventually we should migrate most of the things to use it rather than hardcoding credentials in GHA secrets</p>",
        "id": 273407332,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1645973415
    },
    {
        "content": "<p>yeah, this looks like quite nice</p>",
        "id": 273407346,
        "sender_full_name": "simulacrum",
        "timestamp": 1645973449
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> practical question — I've got an environment flag to switch between the two server implementations. The default is the original server, but I've manually tweaked the current playground to have the flag on. What's the appropriate way to toggle that flag on play-next and going forward?</p>",
        "id": 273542452,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646077147
    },
    {
        "content": "<p>hmm? wouldn't we just switch the dns?</p>",
        "id": 273542551,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077185
    },
    {
        "content": "<p>Maybe I was unclear — the environment variable switches between the Iron implementation and the Axum implementation.</p>",
        "id": 273542713,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646077248
    },
    {
        "content": "<p>oooh</p>",
        "id": 273542735,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077255
    },
    {
        "content": "<p>ok got it!</p>",
        "id": 273542750,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077262
    },
    {
        "content": "<p>hmm</p>",
        "id": 273542753,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077263
    },
    {
        "content": "<p>I'd probably have an <code>env:</code> variable in the playground role that generates an environment file loaded by systemd</p>",
        "id": 273542836,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077313
    },
    {
        "content": "<p>or well just the <code>Environment</code> systemd directives <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 273542918,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077339
    },
    {
        "content": "<p>OK, so add it next to the existing env vars in the config file. For actually turning it on and off, would I change my local file and redeploy it?</p>",
        "id": 273543037,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646077397
    },
    {
        "content": "<p>yes, and commit/push that change</p>",
        "id": 273543070,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077416
    },
    {
        "content": "<p>Also:</p>\n<div class=\"codehilite\"><pre><span></span><code>% ssh playground-next\nshep@play-next.infra.rust-lang.org: Permission denied (publickey).\n</code></pre></div>",
        "id": 273543086,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646077425
    },
    {
        "content": "<p>did you jump through the bastion?</p>",
        "id": 273543154,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077443
    },
    {
        "content": "<p>The trick with commit / push is the timing. Like, I want to be able to test it quickly and rollback quickly if needed. More than happy to push it after it being stable for \"long enough\" (1 hr or whatever). That sound cool?</p>",
        "id": 273543311,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646077515
    },
    {
        "content": "<p>oh yeah definitely!</p>",
        "id": 273543329,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077529
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>Host playground\nHostName ec2-18-221-135-24.us-east-2.compute.amazonaws.com\nUser ubuntu\nIdentityFile ~/.ssh/i32Playground-i32account.pem\n\nHost bastion\nHostname bastion.infra.rust-lang.org\nProxyJump playground\nUser shep\n\nHost playground-next\nHostname  play-next.infra.rust-lang.org\nProxyJump bastion\nUser shep\n</code></pre></div>",
        "id": 273543369,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646077548
    },
    {
        "content": "<p>I copy-pasta'd my existing playground ssh config and changed the username to <code>shep</code></p>",
        "id": 273543446,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646077588
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116155\">Jake Goulding</span> <a href=\"#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/273543311\">said</a>:</p>\n<blockquote>\n<p>The trick with commit / push is the timing. Like, I want to be able to test it quickly and rollback quickly if needed. More than happy to push it after it being stable for \"long enough\" (1 hr or whatever). That sound cool?</p>\n</blockquote>\n<p>the point is that if anyone needs to redeploy it in a week or a month they have the updated config <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 273543541,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077617
    },
    {
        "content": "<p>the ssh problem sounds weird, I'll check in a bit</p>",
        "id": 273543565,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646077627
    },
    {
        "content": "<p>Yeah, definitely want the expected state to be what's in GH</p>",
        "id": 273543605,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646077651
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"121055\">Pietro Albini</span> <a href=\"#narrow/stream/242791-t-infra/topic/playground.20ansible.20deploy/near/273407200\">said</a>:</p>\n<blockquote>\n<p>You can configure credentials on GitHub Actions with:</p>\n</blockquote>\n<p>That's in <a href=\"https://github.com/integer32llc/rust-playground/pull/784\">https://github.com/integer32llc/rust-playground/pull/784</a> but I can't merge because nightly is missing Miri at the moment. Next few days or so.</p>",
        "id": 273577377,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646096351
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> <a href=\"https://github.com/integer32llc/rust-playground/runs/5411551756?check_suite_focus=true#step:12:1\">https://github.com/integer32llc/rust-playground/runs/5411551756?check_suite_focus=true#step:12:1</a></p>",
        "id": 274016618,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646332014
    },
    {
        "content": "<p>Looks like not quite right permission?</p>",
        "id": 274016661,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646332030
    },
    {
        "content": "<p>try adding <code>role-skip-session-tagging: true</code>?</p>",
        "id": 274051040,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646347152
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> <a href=\"https://github.com/integer32llc/rust-playground/runs/5489785033?check_suite_focus=true\">https://github.com/integer32llc/rust-playground/runs/5489785033?check_suite_focus=true</a></p>",
        "id": 274823147,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646912554
    },
    {
        "content": "<p>uff</p>",
        "id": 274823190,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646912583
    },
    {
        "content": "<p>you might have to unset the existing aws credentials somehow</p>",
        "id": 274823198,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646912594
    },
    {
        "content": "<p>that error means <code>awscli</code> is trying to authenticate with the existing credentials as the new role, instead of authenticating with the OIDC credentials as the new role</p>",
        "id": 274823247,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646912631
    },
    {
        "content": "<p>And I guess the environment variables are still set. I’ll have to poke around to see about unsetting them.</p>",
        "id": 274823435,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646912752
    },
    {
        "content": "<p>Should I undo the skip session tagging setting change?</p>",
        "id": 274823497,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1646912774
    },
    {
        "content": "<p>hmm, I dunno whether that was caused by the same issue or not</p>",
        "id": 274823589,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646912843
    },
    {
        "content": "<p>I'd try unsetting the environment variables, seeing whether that work, and then try to unset the session tagging</p>",
        "id": 274823610,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1646912860
    },
    {
        "content": "<p>Finally able to unset; not better <a href=\"https://github.com/integer32llc/rust-playground/runs/5772976974?check_suite_focus=true#step:12:14\">https://github.com/integer32llc/rust-playground/runs/5772976974?check_suite_focus=true#step:12:14</a></p>",
        "id": 277292569,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1648738022
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> I know you are doing work things this week, but when you have time next week, perhaps you can explain how you expect the authentication to work.</p>",
        "id": 277292787,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1648738114
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> again, no hurry, just doing a weekly ping.</p>",
        "id": 277749288,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1649086538
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span></p>",
        "id": 278698295,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1649772768
    },
    {
        "content": "<p>huh that's weird</p>",
        "id": 278743078,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792297
    },
    {
        "content": "<p>I have a horrible thought <span class=\"user-mention\" data-user-id=\"116155\">@Jake Goulding</span>: I'm fairly sure authenticating to the rust account first, upload there and <em>then</em> authenticating to the i32 account would actually work</p>",
        "id": 278743272,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792409
    },
    {
        "content": "<p>I'm willing to try — why do you think it will differ?</p>",
        "id": 278743360,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1649792463
    },
    {
        "content": "<p>the main problem you're encountering is that authenticating to the rust account requires assuming a role, and the aws cli is being \"smart\" and trying to do that with the credentials currently configured in the VM (the i32 ones) rather than the oidc token provided by github</p>",
        "id": 278743395,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792482
    },
    {
        "content": "<p>Should I literally just move the command earlier, keeping all the unsetting of env vars?</p>",
        "id": 278743431,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1649792504
    },
    {
        "content": "<p>while authenticating to the i32 account is just setting these two environment variables</p>",
        "id": 278743438,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792508
    },
    {
        "content": "<p>actually, wait</p>",
        "id": 278743513,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792539
    },
    {
        "content": "<p>that <em>might</em> work, or aws cli might get even more confused if you then have <code>AWS_ACCESS_KEY_ID</code>/<code>AWS_SECRET_ACCESS_KEY</code> of the i32 account and <code>AWS_SESSION_TOKEN</code> of the rust account :/</p>",
        "id": 278743600,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792585
    },
    {
        "content": "<p>I guess, try swapping (removing the <code>env:</code> from the aws action) and if it doesn't work we can think of something else</p>",
        "id": 278743762,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792676
    },
    {
        "content": "<p>uff</p>",
        "id": 278743763,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792677
    },
    {
        "content": "<p>it certainly feels like there should be a \"logout\" action, doesn't it?</p>",
        "id": 278743803,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1649792701
    },
    {
        "content": "<p>I didn't see anything directly relevant on the action's issues list</p>",
        "id": 278743822,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1649792714
    },
    {
        "content": "<p>there should indeed be, can't find it</p>",
        "id": 278743857,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792741
    },
    {
        "content": "<p>fairly sure swapping will work, if it doesn't uff</p>",
        "id": 278743918,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649792763
    },
    {
        "content": "<p><a href=\"https://github.com/integer32llc/rust-playground/pull/795\">https://github.com/integer32llc/rust-playground/pull/795</a> — diff look like what you expect?</p>",
        "id": 278745664,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1649793638
    }
]