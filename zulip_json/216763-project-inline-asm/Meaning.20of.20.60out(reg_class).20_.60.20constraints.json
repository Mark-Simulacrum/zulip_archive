[
    {
        "content": "<p>I'm working on the GCC backend and I'm trying to get inline assembly working. I'm a bit unsure how to deal with some corner cases so it'd be great if somebody from rustc dev team could comment on them. </p>\n<p>I see this syntax is allowed:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"fm\">asm!</span><span class=\"p\">(</span><span class=\"s\">\"mov {0}, {0}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"p\">(</span><span class=\"n\">reg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">options</span><span class=\"p\">(</span><span class=\"n\">preserves_flags</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nomem</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nostack</span><span class=\"p\">));</span><span class=\"w\"></span>\n</code></pre></div>\n<p>LLVM translates it to this IR, allocating a spare register for the out operand:</p>\n<div class=\"codehilite\" data-code-language=\"LLVM-MIR\"><pre><span></span><code>%0 = call i32 asm sideeffect inteldialect \"mov ${0:q}, ${0:q}\", \"=&amp;r\"() <span class=\"c\">#7, !dbg !223, !srcloc !224</span>\n</code></pre></div>\n<p>But it doesn't make much sense to me. What is <code>out(reg_class) _</code> is supposed to mean in the first place? Should it clobber all registers in the class? Or is this behaviour correct? Should I then mimic it in GCC backend?</p>",
        "id": 250211409,
        "sender_full_name": "Commeownist",
        "timestamp": 1629543492
    },
    {
        "content": "<p>Answered in <a href=\"https://github.com/rust-lang/rust/issues/72016#issuecomment-903101015\">https://github.com/rust-lang/rust/issues/72016#issuecomment-903101015</a></p>",
        "id": 250212665,
        "sender_full_name": "Commeownist",
        "timestamp": 1629545498
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"434274\">@Commeownist</span> Thank you for working on inline asm for rustc_codegen_gcc!</p>",
        "id": 250228956,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1629567874
    }
]