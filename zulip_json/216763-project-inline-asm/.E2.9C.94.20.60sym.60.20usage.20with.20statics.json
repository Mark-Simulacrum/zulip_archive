[
    {
        "content": "<p>Given the code</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#![feature(asm)]</span><span class=\"w\"></span>\n\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">INDEX</span>: <span class=\"kt\">usize</span> <span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">ARR</span>: <span class=\"p\">[</span><span class=\"kt\">u64</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">];</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">val</span>: <span class=\"kt\">u64</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"fm\">asm!</span><span class=\"p\">(</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"s\">\"mov rax, [{2}]\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"s\">\"mov {0}, [{1}+rax]\"</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">out</span><span class=\"p\">(</span><span class=\"n\">reg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"n\">ARR</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">sym</span><span class=\"w\"> </span><span class=\"n\">INDEX</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">dbg!</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I would have expected the code to compile and act as an index into ARR with the index INDEX.  However there is an odd linker error related to relocations I think?  Is this because of a misuse of <code>asm</code> or <code>sym</code> or is there something else going on?</p>\n<p>The exact linker error is <code>relocation R_X86_64_32S against `.rodata._ZN3asm5INDEX17hdeb7ef37bb2b4172E' can not be used when making a PIE object; recompile with -fPIE</code></p>",
        "id": 256342305,
        "sender_full_name": "asquared31415",
        "timestamp": 1633481765
    },
    {
        "content": "<p><code>{2} + rip</code> is needed because in PIC code the symbols don't have an absolute address. Same with <code>{1}</code>.</p>",
        "id": 256342399,
        "sender_full_name": "Amanieu",
        "timestamp": 1633481840
    },
    {
        "content": "<p>For the second one you'll need a separate <code>lea $reg, [{1} + rip]</code> to do the PIC address calculation separately.</p>",
        "id": 256342514,
        "sender_full_name": "Amanieu",
        "timestamp": 1633481921
    },
    {
        "content": "<p>That seems to have worked, now the code is just incorrect for other reasons thanks!<br>\n(I just realized I'm missing a clobber that I meant to add, perhaps that's related)</p>",
        "id": 256342731,
        "sender_full_name": "asquared31415",
        "timestamp": 1633482034
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"384759\">asquared31415</span> has marked this topic as resolved.</p>",
        "id": 256342877,
        "sender_full_name": "Notification Bot",
        "timestamp": 1633482150
    }
]