[
    {
        "content": "<p>I wrote a blog post on <a href=\"https://tmandry.gitlab.io/blog/posts/2021-12-21-context-capabilities/\">contexts and capabilities</a>, also known as with clauses</p>",
        "id": 265719026,
        "sender_full_name": "tmandry",
        "timestamp": 1640111399
    },
    {
        "content": "<p>Why do you need the capability keyword rather than using a with clause there?</p>",
        "id": 265724295,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640114442
    },
    {
        "content": "<p>(As a high level comment on the whole with clause idea, I think solving the ‘passing around context’ problem is very desirable, but I also feel like adding with clauses is spending like three years of rust’s complexity budget in one go)</p>",
        "id": 265724552,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640114588
    },
    {
        "content": "<p>The question is specifically about the example, by the way (on mobile so I can’t grab a helpful quote)</p>",
        "id": 265724618,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640114627
    },
    {
        "content": "<p><code>capability</code> defines a new name that can be used in <code>with</code> clauses</p>",
        "id": 265730902,
        "sender_full_name": "tmandry",
        "timestamp": 1640118604
    },
    {
        "content": "<p>i.e. <code>capability</code> is an item</p>",
        "id": 265730960,
        "sender_full_name": "tmandry",
        "timestamp": 1640118637
    },
    {
        "content": "<p>also yes, the complexity cost is something to consider :)</p>",
        "id": 265731041,
        "sender_full_name": "tmandry",
        "timestamp": 1640118695
    },
    {
        "content": "<p>Why can’t you just use ‘x: T’, why the extra keyword?</p>",
        "id": 265736557,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640122296
    },
    {
        "content": "<p>I'm not sure what you mean.</p>",
        "id": 265745842,
        "sender_full_name": "tmandry",
        "timestamp": 1640128228
    },
    {
        "content": "<p>OK, so I've had a chance to read again and I'm not on mobile.</p>",
        "id": 265925626,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640272712
    },
    {
        "content": "<p>I mean why do we need the <code>capability</code> declaration at all? In the example,  I could imagine deserialize declared with <code> with a: &amp;'a arena::BasicArena</code> and called inside <code>with a = &amp;arena::BasicArena::new() { ... }</code> (obviously in real life, one would use a more descriptive name than <code>a</code>). But I don't see why the name of the 'with variable' has to be declared in the <code>arena</code> module?</p>",
        "id": 265925836,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640272877
    },
    {
        "content": "<p>Also, the fact that the <code>capability</code> is declared with a variable name on the left of the <code>=</code> and a type on the right is confusing to me.</p>",
        "id": 265925990,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640273009
    },
    {
        "content": "<p>And another question, if we extend the example, we have the <code>with</code> clause on deserialize and the <code>with</code> block in main, but rather than main calling deserialize directly, main calls foo which calls deserialize, does foo require a <code>with</code> clause? Or does the compiler infer an implicit <code>with</code> clause that must be satisfied by all callers of foo?</p>",
        "id": 265926212,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640273193
    },
    {
        "content": "<p>and if you are going to require the <code>capability</code> declaration, it seems like you shouldn't need the type (only the path) in a with clause?</p>",
        "id": 265929016,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640275142
    },
    {
        "content": "<p>(also, I'm not a fan of the keyword capability - where does it come from? To me a capability means something like a permission (or the combination of a reference + permissions) as in capability-based security or (in PL) read/write capabilities in systems like fractional permissions)</p>",
        "id": 265929478,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640275404
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256841\">Nick Cameron</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/with.20clauses/near/265925836\">said</a>:</p>\n<blockquote>\n<p>I mean why do we need the <code>capability</code> declaration at all? In the example,  I could imagine deserialize declared with <code> with a: &amp;'a arena::BasicArena</code> and called inside <code>with a = &amp;arena::BasicArena::new() { ... }</code> (obviously in real life, one would use a more descriptive name than <code>a</code>). But I don't see why the name of the 'with variable' has to be declared in the <code>arena</code> module?</p>\n</blockquote>\n<p>this prevents conflicts that would arise from different code using the same name to mean different things</p>",
        "id": 265929654,
        "sender_full_name": "tmandry",
        "timestamp": 1640275554
    },
    {
        "content": "<p>it doesn't have to be declared in <code>arena</code>, it could be declared anywhere, but that example is meant to drive the point home that it's a standalone item</p>",
        "id": 265929713,
        "sender_full_name": "tmandry",
        "timestamp": 1640275573
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256841\">Nick Cameron</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/with.20clauses/near/265925990\">said</a>:</p>\n<blockquote>\n<p>Also, the fact that the <code>capability</code> is declared with a variable name on the left of the <code>=</code> and a type on the right is confusing to me.</p>\n</blockquote>\n<p>fair enough, I'm anticipating it will be more common to use trait bounds rather than types, but we could use <code>:</code> to specify the type and a <code>where</code> clause for trait bounds</p>",
        "id": 265929839,
        "sender_full_name": "tmandry",
        "timestamp": 1640275684
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256841\">Nick Cameron</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/with.20clauses/near/265926212\">said</a>:</p>\n<blockquote>\n<p>And another question, if we extend the example, we have the <code>with</code> clause on deserialize and the <code>with</code> block in main, but rather than main calling deserialize directly, main calls foo which calls deserialize, does foo require a <code>with</code> clause? Or does the compiler infer an implicit <code>with</code> clause that must be satisfied by all callers of foo?</p>\n</blockquote>\n<p>foo would require a <code>with</code> clause, unless it's \"implied\" by some generic bound of foo</p>",
        "id": 265929949,
        "sender_full_name": "tmandry",
        "timestamp": 1640275801
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256841\">Nick Cameron</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/with.20clauses/near/265929016\">said</a>:</p>\n<blockquote>\n<p>and if you are going to require the <code>capability</code> declaration, it seems like you shouldn't need the type (only the path) in a with clause?</p>\n</blockquote>\n<p>yes, you could leave off the type and rely on the type or bounds on the declaration</p>",
        "id": 265930038,
        "sender_full_name": "tmandry",
        "timestamp": 1640275865
    },
    {
        "content": "<blockquote>\n<p>fair enough, I'm anticipating it will be more common to use trait bounds rather than types, but we could use : to specify the type and a where clause for trait bounds</p>\n</blockquote>\n<p>or <code>impl Bound</code>?</p>",
        "id": 265930194,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640276010
    },
    {
        "content": "<p>yeah, I had that originally, but thought</p>\n<div class=\"codehilite\"><pre><span></span><code>capability foo: impl Allocator;\n</code></pre></div>\n<p>on an item looked weird</p>",
        "id": 265930262,
        "sender_full_name": "tmandry",
        "timestamp": 1640276052
    },
    {
        "content": "<p>It seems to me that there is no point in having with clauses on functions? They can always be replaced by function arguments, it's with clauses on impls which are doing something useful?</p>",
        "id": 265930283,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640276081
    },
    {
        "content": "<p>for functions they could be replaced by arguments, yes</p>",
        "id": 265930349,
        "sender_full_name": "tmandry",
        "timestamp": 1640276141
    },
    {
        "content": "<p>For the scoped bounds section, could you give an example with non-'static lifetime? I don't really understand what the notation in the example means and 'static is often kinda special</p>",
        "id": 265930434,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640276182
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256841\">Nick Cameron</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/with.20clauses/near/265929478\">said</a>:</p>\n<blockquote>\n<p>(also, I'm not a fan of the keyword capability - where does it come from? To me a capability means something like a permission (or the combination of a reference + permissions) as in capability-based security or (in PL) read/write capabilities in systems like fractional permissions)</p>\n</blockquote>\n<p>I think the concepts are related, see the \"function coloring\" section of <a href=\"https://jam1.re/blog/thoughts-on-contexts-and-capabilities-in-rust\">this blog post</a> to see how. that said, I was thinking maybe it should be called <code>context</code> and am beginning to favor that more</p>",
        "id": 265930441,
        "sender_full_name": "tmandry",
        "timestamp": 1640276188
    },
    {
        "content": "<blockquote>\n<p>it doesn't have to be declared in arena, it could be declared anywhere, but that example is meant to drive the point home that it's a standalone item</p>\n</blockquote>\n<p>I think the fact that it can be declared anywhere is part of the weirdness of it for me</p>",
        "id": 265930957,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640276572
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256841\">Nick Cameron</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/with.20clauses/near/265930434\">said</a>:</p>\n<blockquote>\n<p>For the scoped bounds section, could you give an example with non-'static lifetime? I don't really understand what the notation in the example means and 'static is often kinda special</p>\n</blockquote>\n<p>So if instead of spawning a thread we returned a closure, we would want the closure to only be valid when the <code>where</code> clause is valid. Something like</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">make_deserialize_and_print_fn</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">()</span><span class=\"w\"></span>\n<span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"p\">(</span><span class=\"o\">'</span><span class=\"na\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">T</span>: <span class=\"nc\">Deserialize</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">Debug</span><span class=\"w\"></span>\n-&gt; <span class=\"nc\">impl</span><span class=\"w\"> </span><span class=\"nb\">Fn</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">a</span><span class=\"w\"></span>\n<span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">T</span>::<span class=\"n\">deserialize</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Successfully deserialized an object: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 265931073,
        "sender_full_name": "tmandry",
        "timestamp": 1640276647
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116883\">tmandry</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/with.20clauses/near/265930262\">said</a>:</p>\n<blockquote>\n<p>yeah, I had that originally, but thought</p>\n<div class=\"codehilite\"><pre><span></span><code>capability foo: impl Allocator;\n</code></pre></div>\n<p>on an item looked weird</p>\n</blockquote>\n<p>I want to be able to write <code>impl Bound</code> as a hint to to the compiler in <code>let</code> clauses and type ascription, etc., so in then it might not look so weird with capability/context decls too</p>",
        "id": 265931082,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640276656
    },
    {
        "content": "<p>..originally I was using <code>in</code> instead of <code>with</code> for this specifically, i.e.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"p\">(</span><span class=\"o\">'</span><span class=\"na\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">T</span>: <span class=\"nc\">Deserialize</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">Debug</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 265931151,
        "sender_full_name": "tmandry",
        "timestamp": 1640276714
    },
    {
        "content": "<p>what's happening here is the closure is actually capturing the context it needs to run</p>",
        "id": 265931247,
        "sender_full_name": "tmandry",
        "timestamp": 1640276765
    },
    {
        "content": "<p>the reason I switched to <code>where with()</code> is because I realized that I would need more than just lifetime bounds, e.g. <code>Send</code>, and <code>in</code> doesn't really work for that</p>",
        "id": 265931288,
        "sender_full_name": "tmandry",
        "timestamp": 1640276807
    },
    {
        "content": "<p>will need to noodle on the scoped bounds a bit later, need to do some parenting soon. Thanks for the example and explanations</p>",
        "id": 265931639,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1640277023
    }
]