[
    {
        "content": "<p>looks like we are getting false positives on must_not_suspend due to the generator analysis, <a href=\"https://github.com/rust-lang/rust/issues/89562\">#89562</a></p>",
        "id": 256689478,
        "sender_full_name": "tmandry",
        "timestamp": 1633669820
    },
    {
        "content": "<p>Yeah, that's a more general limitation of liveness analysis <em>w.r.t</em> the unsugaring of generator and its resolved captures: the lint will automagically be fixed when that bigger issue is.</p>",
        "id": 256732020,
        "sender_full_name": "Daniel Henry-Mantilla",
        "timestamp": 1633696188
    },
    {
        "content": "<p>Yah I believe this is related to <span class=\"user-mention\" data-user-id=\"421986\">@eholk</span>'s work,  where <code>drop</code> doesn't actually work!</p>\n<p>If we want to wait for that, we can definitely remove the attribute from std for now (it should only be on nightly for now)?</p>",
        "id": 256753622,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633705518
    },
    {
        "content": "<p>Yeah, these false positives should be fixed once generator captures are more precise, but unfortunately that's turning out to be trickier to do than I'd hoped.</p>",
        "id": 256769536,
        "sender_full_name": "eholk",
        "timestamp": 1633711917
    },
    {
        "content": "<p>I wonder if we could do the <code>must_not_suspend</code> analysis on MIR? It has more precise knowledge of what actually goes in the generator at that point.</p>",
        "id": 256769886,
        "sender_full_name": "eholk",
        "timestamp": 1633712076
    },
    {
        "content": "<p>But I also thinking remove the attribute from std is a good idea in the meantime, at least at some point before the change makes it to beta.</p>",
        "id": 256769944,
        "sender_full_name": "eholk",
        "timestamp": 1633712107
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"421986\">eholk</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/must_not_suspend.20false.20positives/near/256769886\">said</a>:</p>\n<blockquote>\n<p>I wonder if we could do the <code>must_not_suspend</code> analysis on MIR? It has more precise knowledge of what actually goes in the generator at that point.</p>\n</blockquote>\n<p>I thought the mir  generator directly pulled from the typeck analysis? does it do something different?</p>",
        "id": 256770413,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633712290
    },
    {
        "content": "<p>The mir generator gets a subset of the typeck analysis (and there's a check to make sure that anything the mir generator found was also found by typeck)</p>",
        "id": 256770752,
        "sender_full_name": "eholk",
        "timestamp": 1633712403
    },
    {
        "content": "<p>Here's the MIR version: <a href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/generator.rs#L449\">https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/generator.rs#L449</a></p>",
        "id": 256771137,
        "sender_full_name": "eholk",
        "timestamp": 1633712527
    },
    {
        "content": "<p>Here's the check to make sure the things MIR found is a subset of the things typeck found: <a href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/generator.rs#L750\">https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/generator.rs#L750</a></p>",
        "id": 256771629,
        "sender_full_name": "eholk",
        "timestamp": 1633712728
    },
    {
        "content": "<p>That'd actually be a tidy place to check <code>must_not_suspend</code>, I bet.</p>",
        "id": 256771758,
        "sender_full_name": "eholk",
        "timestamp": 1633712764
    },
    {
        "content": "<p>FWIW, rather than delaying the release of the lint altogether, it could be released but as an <code>allow</code>-by-default one. For those use to the <code>Future</code> is not <code>Send</code> despite the <code>drop</code>ped <code>Mutex</code>es, this lint won't be worse, and it's a lint which can prove itself useful on its own <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 256772326,
        "sender_full_name": "Daniel Henry-Mantilla",
        "timestamp": 1633712998
    },
    {
        "content": "<p>allow-by-default as opposed to warn-by-default? that seems reasonable</p>\n<p><span class=\"user-mention\" data-user-id=\"421986\">@eholk</span> , do you think its worth moving the analysis to mir, if we probably will want to move it back once we resolve the typeck analysis?</p>",
        "id": 256781802,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633716754
    },
    {
        "content": "<p>It depends. Is there a reason it's better to do this in typeck analysis? The nice thing about going it at the MIR level is that it will always have the most precise information about the types that are live across an await.</p>",
        "id": 256792396,
        "sender_full_name": "eholk",
        "timestamp": 1633721069
    },
    {
        "content": "<p>I think it might be easier to attach <code>#[must_not_suspend]</code> to functions in typeck than in MIR, but I'm not sure.</p>",
        "id": 256792504,
        "sender_full_name": "eholk",
        "timestamp": 1633721122
    }
]