[
    {
        "content": "<p>Hi folks!</p>\n<p>I'm experimenting with riscv32gc-unknown-linux-gnu target using qemu-system-riscv32 and a buildroot environment. When compiled for <code>release</code>, a simple hello world runs successfully. When compiled dev, It panics with <code>attempt to create unaligned or null slice</code>. </p>\n<p>Full stack trace is in this gist: <a href=\"https://gist.github.com/jared-s/641fa6108c23fd5b6f08a37b441b3e01\">https://gist.github.com/jared-s/641fa6108c23fd5b6f08a37b441b3e01</a></p>",
        "id": 258583498,
        "sender_full_name": "Jared S",
        "timestamp": 1634836481
    },
    {
        "content": "<p>The buildroot emulated environment created by buildroot <code>make qemu_riscv32_virt_defconfig</code> reproduces the issue. I'm using the latest riscv-gnu-toolchain for linking, built for ilp32d abi</p>",
        "id": 258584637,
        "sender_full_name": "Jared S",
        "timestamp": 1634836903
    },
    {
        "content": "<p>Where's the code?</p>",
        "id": 258624774,
        "sender_full_name": "Gary Guo",
        "timestamp": 1634854009
    },
    {
        "content": "<p>I think it was just the <code>cargo new</code> output (<span class=\"user-mention\" data-user-id=\"451520\">@Jared S</span> is my coworker, I suggested they ask here), but they can confirm.</p>",
        "id": 258654456,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1634870719
    },
    {
        "content": "<p>or an equivalent, anyway</p>",
        "id": 258654563,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1634870823
    },
    {
        "content": "<p>I uploaded an example project and buildroot environment here <a href=\"https://github.com/jared-s/rv32_debug_panic\">https://github.com/jared-s/rv32_debug_panic</a> <span class=\"user-mention\" data-user-id=\"303710\">@Gary Guo</span></p>",
        "id": 258738909,
        "sender_full_name": "Jared S",
        "timestamp": 1634921251
    },
    {
        "content": "<p>Oh so it's really just a hello world. That's weird.</p>",
        "id": 258770674,
        "sender_full_name": "Gary Guo",
        "timestamp": 1634934937
    },
    {
        "content": "<p>Yeah, the slice comes from a <code>&lt;Vec&lt;u8&gt; as Deref&gt;::deref</code> call, and the pointer is null, which doesn't make a lot of sense, since that should never be possible.</p>",
        "id": 258770903,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1634935050
    },
    {
        "content": "<p>I'm wondering if somehow align_of::&lt;u8&gt;() happens to be 0 on that platform</p>",
        "id": 258770955,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1634935080
    },
    {
        "content": "<p>(due to an incorrect <code>data-layout</code> or something, idk)</p>",
        "id": 258771023,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1634935104
    },
    {
        "content": "<p><code>BufWriter</code> also creates and uses <code>Vec</code> internally</p>",
        "id": 258771037,
        "sender_full_name": "Gary Guo",
        "timestamp": 1634935113
    },
    {
        "content": "<p>right</p>",
        "id": 258771064,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1634935135
    },
    {
        "content": "<p>that much makes sense, the part where the pointer is null doesnt â€” either rawvec should catch the allocator returning null, or its the pointer from <code>NonNull::dangling()</code> (or, whatever the equivalent <code>Unique</code> function is, if it uses that, IDR)</p>",
        "id": 258771151,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1634935191
    },
    {
        "content": "<p>It's <code>Unique::dangling()</code></p>",
        "id": 258771405,
        "sender_full_name": "Gary Guo",
        "timestamp": 1634935315
    },
    {
        "content": "<p>So baiscally from aling_of</p>",
        "id": 258771455,
        "sender_full_name": "Gary Guo",
        "timestamp": 1634935324
    },
    {
        "content": "<p><a href=\"https://godbolt.org/z/6nz6daMva\">https://godbolt.org/z/6nz6daMva</a> The alignment is correct</p>",
        "id": 258771509,
        "sender_full_name": "Gary Guo",
        "timestamp": 1634935350
    },
    {
        "content": "<p>I wonder if it could be miscompilation..</p>",
        "id": 258771900,
        "sender_full_name": "Gary Guo",
        "timestamp": 1634935538
    },
    {
        "content": "<p>I'd suggest try older versions of Rust and see if issue persists</p>",
        "id": 258771997,
        "sender_full_name": "Gary Guo",
        "timestamp": 1634935572
    },
    {
        "content": "<p>LLVM 13 update breaks a few targets like PowerPC, so RV32 could be broken as well</p>",
        "id": 258772043,
        "sender_full_name": "Gary Guo",
        "timestamp": 1634935596
    },
    {
        "content": "<p>I don't think riscv32 is actually that important to us (it would have been neat, but IIUC riscv64 works for us to), so I'll file an issue for it (unless you want to <span class=\"user-mention\" data-user-id=\"451520\">@Jared S</span>).</p>",
        "id": 259793045,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1635694373
    }
]