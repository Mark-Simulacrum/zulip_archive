[
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"216206\">@lcnr</span></p>\n<p>I'm trying to fix <a href=\"https://github.com/rust-lang/rust/issues/89334\">#89334</a>:</p>\n<div class=\"codehilite\"><pre><span></span><code>#![feature(generic_const_exprs)]\n#![allow(unused_braces, incomplete_features)]\n\npub trait Foo&lt;const N: usize&gt; {}\npub trait Bar: Foo&lt;{ 1 }&gt; { }\n</code></pre></div>\n<p>This fails as a result of the changes you've introduced in <a href=\"https://github.com/rust-lang/rust/pull/87280\">87280</a>, specifically the problem is that we generate \"duplicate\" caller bounds candidates (they only differ in the substs of the the <code>Unevaluated</code> constant, one being None, the other having its default substs inserted in the elaborate call <code>[Self]</code> in this case, which match the default substs) during wfcheck, resulting in ambiguity.</p>\n<p>I'm not sure I understand why you chose to wrap the substs in an Option. Will using None during the initialization of <code>Unevaluated</code> in <a href=\"https://github.com/rust-lang/rust/blob/91b931926fd49fc97d1e39f2b8206abf1d77ce7d/compiler/rustc_middle/src/ty/consts.rs#L100-L104\"><code>from_opt_const_arg_anon_const</code></a> actually be necessary to prevent cycles or could we call <code>default_anon_consts_substs</code> here and use an enum (with variants, say, <code>DefaultSubsts(SubstsRef)</code> and <code>Initialized(Substsref)</code>) instead of an option, which would allow us to still test for equality of substs even if one is the 'default subst' version and the other is already the initialized version? If not why would postponing (through substs_: None) the call  to <code>default_anon_consts_substs</code> mitigate the cycle problem and how will the upcoming 'filtering parent substs' PR help with the cycle problem (I didn't completely understand the zulip topics related to that solution)?</p>",
        "id": 258841672,
        "sender_full_name": "BN",
        "timestamp": 1635021651
    },
    {
        "content": "<p>I think yes using <code>None</code> in <code>from_opt_const_arg_anon_const</code> is required to prevent cycles, (and if it isnt now, it will be when we actualy implement filtering)</p>",
        "id": 258841678,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635021675
    },
    {
        "content": "<p>the idea being that we wanted to create the paramenv with <code>None</code> for substs of everything and then compute the real substs for all the consts</p>",
        "id": 258841684,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635021696
    },
    {
        "content": "<p>kinda oof that array repeat exprs have substs though... I forgot about that <span aria-label=\"frowning\" class=\"emoji emoji-1f626\" role=\"img\" title=\"frowning\">:frowning:</span></p>",
        "id": 258841727,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635021734
    },
    {
        "content": "<p>ok interesting. But I don't really understand why we can still call <code>default_opt_const_arg_anon_const</code> for an Unevaluated whose substs are None then, why would calling this later avoid cycles? I haven't read too deeply into the PR though, so I may be missing something here.</p>",
        "id": 258841873,
        "sender_full_name": "BN",
        "timestamp": 1635021974
    },
    {
        "content": "<p>(not sure what <code>default_opt_const_arg_anon_const</code> is, i cant find it with ctrl-f <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>)</p>",
        "id": 258841889,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022023
    },
    {
        "content": "<p>im not super familiar with <a href=\"https://github.com/rust-lang/rust/issues/87280\">#87280</a> tbh it went over my head a bit</p>",
        "id": 258841901,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022040
    },
    {
        "content": "<p>the cycles we're hoping to avoid is that when we are filtering out unused substs (i.e. inside <code>default_anon_const_substs</code>) we dont call code that tries to get the actual substs</p>",
        "id": 258841952,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022090
    },
    {
        "content": "<p>I expect <code>from_opt_const_arg_anon_const</code> would be a thing we call when filtering out unused substs</p>",
        "id": 258841959,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022121
    },
    {
        "content": "<p>im not sure I'll be much help here <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 258841977,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022168
    },
    {
        "content": "<p>from my (limited) knowledge i'd assume the solution is adding a <code>.substs(tcx)</code> call somewhere... no idea where that'd be tho</p>",
        "id": 258842120,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022430
    },
    {
        "content": "<blockquote>\n<p>we dont call code that tries to get the actual substs</p>\n</blockquote>\n<p>What do you mean by actual substs here? I assume not the default substs, but I don't understand why we would call <code>default_anon_const_substs</code> when we have the real substs.</p>",
        "id": 258842161,
        "sender_full_name": "BN",
        "timestamp": 1635022467
    },
    {
        "content": "<p>Do you maybe have an example for a cycle involving substs?</p>",
        "id": 258842172,
        "sender_full_name": "BN",
        "timestamp": 1635022496
    },
    {
        "content": "<p>I mean that when we're in <code>default_anon_const_substs</code> and are working with an <code>Unevaluated</code> with <code>None</code> substs we dont want to call <code>default_anon_const_substs</code></p>",
        "id": 258842188,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022539
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"326176\">Boxy [she/her]</span> <a href=\"#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258842120\">said</a>:</p>\n<blockquote>\n<p>from my (limited) knowledge i'd assume the solution is adding a <code>.substs(tcx)</code> call somewhere... no idea where that'd be tho</p>\n</blockquote>\n<p>Yes that's what I was thinking, although that seems kind of like a hack to me. But you don't think that the filtering PR will fix this issue?</p>",
        "id": 258842189,
        "sender_full_name": "BN",
        "timestamp": 1635022541
    },
    {
        "content": "<p>the filtering PR would just change the returned value from <code>default_anon_const_substs</code></p>",
        "id": 258842190,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022559
    },
    {
        "content": "<p>the \"infrastructure\" for actually adding the logic for filtering was what was added in that PR that caused this bug</p>",
        "id": 258842233,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022583
    },
    {
        "content": "<p>(i.e. the None/Some substs)</p>",
        "id": 258842236,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022591
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"328097\">BN</span> <a href=\"#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258842172\">said</a>:</p>\n<blockquote>\n<p>Do you maybe have an example for a cycle involving substs?</p>\n</blockquote>\n<p>basically if in <code>predicates_of</code> we call <code>default_anon_const_substs</code> of an unevaluted const then we will get a cycle</p>",
        "id": 258842266,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022677
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">foo</span><span class=\"o\">&lt;</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">N</span>: <span class=\"kt\">usize</span><span class=\"o\">&gt;</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"p\">[();</span><span class=\"w\"> </span><span class=\"n\">N</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">]</span>: <span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">loop</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 258842320,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022705
    },
    {
        "content": "<p>i.e for this fn we cant call <code>default_anon_const_substs(that_N_plus_1_const)</code> while in the <code>predicates_of(foo)</code> query</p>",
        "id": 258842334,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022731
    },
    {
        "content": "<p>because <code>default_anon_const_substs(that_const)</code> gets the parent defid (which in this case is <code>foo</code>) and calls <code>predicates_of(foo)</code></p>",
        "id": 258842362,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022793
    },
    {
        "content": "<p>(which im now realising is a different cycle than what I was talking about before... sorry, this is the cycle we dont want ^)</p>",
        "id": 258842450,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022821
    },
    {
        "content": "<p>(have you tried calling <code>default_anon_const_substs</code> from <code>from_opt_const_arg_anon_const</code> and seeing if it cycles?)</p>",
        "id": 258842553,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022926
    },
    {
        "content": "<p>(if it does it might give a nice query backtrace when run with <code>-Ztreat-err-as-bug</code>)</p>",
        "id": 258842559,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635022938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"326176\">Boxy [she/her]</span> <a href=\"#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258842553\">said</a>:</p>\n<blockquote>\n<p>(have you tried calling <code>default_anon_const_substs</code> from <code>from_opt_const_arg_anon_const</code> and seeing if it cycles?)</p>\n</blockquote>\n<p>yes I have, it fixes the issue and all tests also pass, but I feel that its not really a solution, since we basically get rid of all the <code>substs_: None</code> initializations</p>",
        "id": 258842586,
        "sender_full_name": "BN",
        "timestamp": 1635022997
    },
    {
        "content": "<p>oh... fun <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 258842590,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635023010
    },
    {
        "content": "<p>ig will just have to wait for lcnr to see why we dont do that</p>",
        "id": 258842636,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635023045
    },
    {
        "content": "<p>i'd have thought that cycles...</p>",
        "id": 258842639,
        "sender_full_name": "Boxy [she/her]",
        "timestamp": 1635023050
    },
    {
        "content": "<p>yes, thanks for your help and the example.</p>",
        "id": 258842649,
        "sender_full_name": "BN",
        "timestamp": 1635023074
    },
    {
        "content": "<blockquote>\n<p>it fixes the issue and all tests also pas</p>\n</blockquote>\n<p>that doesn't seem right</p>",
        "id": 258872628,
        "sender_full_name": "lcnr",
        "timestamp": 1635073076
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code>lcnr@lcnr-pc:~/rust4$ git diff HEAD\n<span class=\"gh\">diff --git a/compiler/rustc_middle/src/ty/consts.rs b/compiler/rustc_middle/src/ty/consts.rs</span>\n<span class=\"gh\">index 869b2ab9dbc..a4e2e497f3c 100644</span>\n<span class=\"gd\">--- a/compiler/rustc_middle/src/ty/consts.rs</span>\n<span class=\"gi\">+++ b/compiler/rustc_middle/src/ty/consts.rs</span>\n<span class=\"gu\">@@ -99,7 +99,7 @@ pub fn from_opt_const_arg_anon_const(</span>\n             }\n             _ =&gt; ty::ConstKind::Unevaluated(ty::Unevaluated {\n                 def: def.to_global(),\n<span class=\"gd\">-                substs_: None,</span>\n<span class=\"gi\">+                substs_: Some(tcx.default_anon_const_substs(def.did)),</span>\n                 promoted: None,\n             }),\n         };\n</code></pre></div>",
        "id": 258872672,
        "sender_full_name": "lcnr",
        "timestamp": 1635073101
    },
    {
        "content": "<p>results in 82 failed tests for me</p>",
        "id": 258872685,
        "sender_full_name": "lcnr",
        "timestamp": 1635073130
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"326176\">Boxy [she/her]</span> <a href=\"#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258842120\">said</a>:</p>\n<blockquote>\n<p>from my (limited) knowledge i'd assume the solution is adding a <code>.substs(tcx)</code> call somewhere... no idea where that'd be tho</p>\n</blockquote>\n<p>yes, the \"where\" here would be during candidate assembly</p>",
        "id": 258872831,
        "sender_full_name": "lcnr",
        "timestamp": 1635073251
    },
    {
        "content": "<p>either by adding a subst call every time we call <code>impl_trait_ref</code> for an <code>ImplCandidate</code></p>",
        "id": 258872999,
        "sender_full_name": "lcnr",
        "timestamp": 1635073484
    },
    {
        "content": "<p>or by actually doing that inside of the <code>impl_trait_ref</code> query</p>",
        "id": 258873002,
        "sender_full_name": "lcnr",
        "timestamp": 1635073497
    },
    {
        "content": "<p>i think calling <code>subst</code> inside of <code>impl_trait_ref</code>should not cycle, but not 100% sure about that</p>",
        "id": 258873028,
        "sender_full_name": "lcnr",
        "timestamp": 1635073533
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"216206\">lcnr</span> <a href=\"#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258872672\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code>lcnr@lcnr-pc:~/rust4$ git diff HEAD\n<span class=\"gh\">diff --git a/compiler/rustc_middle/src/ty/consts.rs b/compiler/rustc_middle/src/ty/consts.rs</span>\n<span class=\"gh\">index 869b2ab9dbc..a4e2e497f3c 100644</span>\n<span class=\"gd\">--- a/compiler/rustc_middle/src/ty/consts.rs</span>\n<span class=\"gi\">+++ b/compiler/rustc_middle/src/ty/consts.rs</span>\n<span class=\"gu\">@@ -99,7 +99,7 @@ pub fn from_opt_const_arg_anon_const(</span>\n             }\n             _ =&gt; ty::ConstKind::Unevaluated(ty::Unevaluated {\n                 def: def.to_global(),\n<span class=\"gd\">-                substs_: None,</span>\n<span class=\"gi\">+                substs_: Some(tcx.default_anon_const_substs(def.did)),</span>\n                 promoted: None,\n             }),\n         };\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>sorry, the change I made was:</p>\n<div class=\"codehilite\"><pre><span></span><code>@@ -99,7 +100,7 @@ pub fn from_opt_const_arg_anon_const(\n             }\n             _ =&gt; ty::ConstKind::Unevaluated(ty::Unevaluated {\n                 def: def.to_global(),\n-                substs_: None,\n+                substs_: Some(InternalSubsts::identity_for_item(tcx, def.did.to_def_id())),\n                 promoted: None,\n             }),\n         };\n</code></pre></div>",
        "id": 258873189,
        "sender_full_name": "BN",
        "timestamp": 1635073710
    },
    {
        "content": "<p>ah yes</p>",
        "id": 258873194,
        "sender_full_name": "lcnr",
        "timestamp": 1635073720
    },
    {
        "content": "<p>that's what <code>default_anon_const_substs</code> is returning rn</p>",
        "id": 258873202,
        "sender_full_name": "lcnr",
        "timestamp": 1635073731
    },
    {
        "content": "<p>but this will change in the future once I - or someone else - implements the filtering of anon const generics</p>",
        "id": 258873242,
        "sender_full_name": "lcnr",
        "timestamp": 1635073782
    },
    {
        "content": "<p>i wrote <a href=\"https://rustc-dev-guide.rust-lang.org/constants.html\">https://rustc-dev-guide.rust-lang.org/constants.html</a> but tbh, after rereading it, that explanation doesn't seem too clear to me</p>",
        "id": 258873303,
        "sender_full_name": "lcnr",
        "timestamp": 1635073818
    },
    {
        "content": "<p>hm I'm puzzled why the test suites passes for me, but not you</p>",
        "id": 258873331,
        "sender_full_name": "BN",
        "timestamp": 1635073865
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">generics</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcx</span><span class=\"p\">.</span><span class=\"n\">generics_of</span><span class=\"p\">(</span><span class=\"n\">def_id</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">parent</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">generics</span><span class=\"p\">.</span><span class=\"n\">parent</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"c1\">// This is the reason we bother with having optional anon const substs.</span>\n<span class=\"w\">        </span><span class=\"c1\">//</span>\n<span class=\"w\">        </span><span class=\"c1\">// In the future the substs of an anon const will depend on its parents predicates</span>\n<span class=\"w\">        </span><span class=\"c1\">// at which point eagerly looking at them will cause a query cycle.</span>\n<span class=\"w\">        </span><span class=\"c1\">//</span>\n<span class=\"w\">        </span><span class=\"c1\">// So for now this is only an assurance that this approach won't cause cycle errors in</span>\n<span class=\"w\">        </span><span class=\"c1\">// the future.</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_cycle_check</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcx</span><span class=\"p\">.</span><span class=\"n\">predicates_of</span><span class=\"p\">(</span><span class=\"n\">parent</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 258873334,
        "sender_full_name": "lcnr",
        "timestamp": 1635073879
    },
    {
        "content": "<p>because of this in <code>default_anon_const_substs</code></p>",
        "id": 258873335,
        "sender_full_name": "lcnr",
        "timestamp": 1635073889
    },
    {
        "content": "<p>ah i see, thanks</p>",
        "id": 258873341,
        "sender_full_name": "BN",
        "timestamp": 1635073902
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"216206\">lcnr</span> <a href=\"#narrow/stream/260443-project-const-generics/topic/optional.20substs.20unevaluated/near/258873028\">said</a>:</p>\n<blockquote>\n<p>i think calling <code>subst</code> inside of <code>impl_trait_ref</code>should not cycle, but not 100% sure about that</p>\n</blockquote>\n<p>ah, don't use <code>subst</code> in <code>impl_trait_ref</code>, use <code>expose_anon_const_default_substs</code> instead <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 258886859,
        "sender_full_name": "lcnr",
        "timestamp": 1635093756
    }
]