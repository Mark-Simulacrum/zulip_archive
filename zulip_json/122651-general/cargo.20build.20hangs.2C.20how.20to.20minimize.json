[
    {
        "content": "<p>Hi! I've found a regression in compilation introduced in <a href=\"https://github.com/rust-lang/rust/issues/85499\">#85499</a>,</p>\n<p>searched nightlies: from nightly-2021-08-17 to nightly-2021-09-10<br>\nregressed nightly: nightly-2021-08-26<br>\nsearched commits: from <a href=\"https://github.com/rust-lang/rust/commit/b03ccace573bb91e27625c190a0f7807045a1012\">https://github.com/rust-lang/rust/commit/b03ccace573bb91e27625c190a0f7807045a1012</a> to <a href=\"https://github.com/rust-lang/rust/commit/0afc20860eb98a29d9bbeea80f2acc5be38c6bf3\">https://github.com/rust-lang/rust/commit/0afc20860eb98a29d9bbeea80f2acc5be38c6bf3</a><br>\nregressed commit: <a href=\"https://github.com/rust-lang/rust/commit/0afc20860eb98a29d9bbeea80f2acc5be38c6bf3\">https://github.com/rust-lang/rust/commit/0afc20860eb98a29d9bbeea80f2acc5be38c6bf3</a></p>\n<p>&lt;details&gt;<br>\n&lt;summary&gt;bisected with &lt;a href='<a href=\"https://github.com/rust-lang/cargo-bisect-rustc'&gt;cargo-bisect-rustc&lt;/a\">https://github.com/rust-lang/cargo-bisect-rustc'&gt;cargo-bisect-rustc&lt;/a</a>&gt; v0.6.0&lt;/summary&gt;</p>\n<p>Host triple: x86_64-pc-windows-msvc<br>\nReproduce with:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code># bisect-script.bat\npwsh.exe -noexit -Command \"stop-job -Name cargobuild_bisect; if ((start-job -Name cargobuild_bisect { cargo build -p server 2&gt;&amp;1 } | wait-job -timeout 600).State -ne 'Completed') {receive-job -Name cargobuild_bisect; receive-job -Name cargobuild_bisect | remove-job -Force; exit 10} else {receive-job -Name cargobuild_bisect; receive-job -Name cargobuild_bisect | remove-job -Force; exit 0}\"\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cargo bisect-rustc --start<span class=\"o\">=</span><span class=\"m\">2021</span>-08-17 --script .<span class=\"se\">\\b</span>isect-script.bat\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>The issue is that compilation succeeds in a acceptable time before this change, but now it's seemingly taking forever, I have not tried this on linux, only windows so far. I'm not sure how I should report this because I'm not able to reproduce it outside my large workspace where I bisected this. Does anyone have an idea to what this could be or have a good way to figure out what the cause is?</p>\n<p>some notable dependencies: actix-web, sqlx, serde, chrono, ring, tokio, tracing, reqwest,anyhow,eyre,async-trait and many more</p>\n<p>I've tried</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\">$ </span><span class=\"nb\">export</span> <span class=\"nv\">CARGO_LOG</span><span class=\"o\">=</span><span class=\"s2\">\"info\"</span>\n<span class=\"gp\">$ </span><span class=\"nb\">export</span> <span class=\"nv\">RUSTC_LOG</span><span class=\"o\">=</span><span class=\"s2\">\"info\"</span> <span class=\"c1\"># to stop massive console spam I use this instead = \"info,rustc_trait_selection=warn,rustc_codegen_ssa=warn,rustc_metadata=warn,rustc_mir=warn,rustc_query_system=warn,rustc_const_eval=warn\"</span>\n<span class=\"gp\">$ </span>cargo build -p server\n</code></pre></div>\n<p>which outputs at the end</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-573328205f4d7f81), fingerprint: Fingerprint(12749739837320991735, 10040035723298659737), edges: [2870] }\n┘\n┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-6f459134164ff719), fingerprint: Fingerprint(8361987967435134197, 5478714612052799554), edges: [2870] }\n┘\n[2021-09-11T16:54:37Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 0)\n┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-82cb26faded76d4), fingerprint: Fingerprint(12749739837320991735, 10040035723298659737), edges: [2870] }\n[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 1)\n┘\n[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 0)\n┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-7c40a2b5f026df66), fingerprint: Fingerprint(12526569172406770563, 17126563881511896260), edges: [2870] }\n[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 1)\n┘\n[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 0)\n┐rustc_query_system::dep_graph::serialized::encode_node node=NodeInfo { node: variances_of(7b5e03ed597c3c33-c7d9e80976e93c5), fingerprint: Fingerprint(12526569172406770563, 17126563881511896260), edges: [2870] }\n[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 1)\n┘\n[2021-09-11T16:54:40Z INFO  cargo::core::compiler::job_queue] tokens in use: 0, rustc_tokens: [], waiting_rustcs: [] (events this tick: 0)\n    Building [=======================&gt; ] 445/446: server(bin)\n</code></pre></div>\n<p>and then just hangs. </p>\n<p>How do I proceed?</p>",
        "id": 252922141,
        "sender_full_name": "Emil Gardström",
        "timestamp": 1631379642
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"300380\">@Emil Gardström</span> go ahead and open an issue so we don't lose track of it :)</p>",
        "id": 252922220,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1631379723
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"232957\">@Jack Huey</span></p>",
        "id": 252922229,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1631379733
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/issues/88862\">#88862</a></p>",
        "id": 252922339,
        "sender_full_name": "Emil Gardström",
        "timestamp": 1631379858
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"300380\">@Emil Gardström</span> can you do <code>RUSTC_LOG=rustc_trait_selection=debug</code> and post that?</p>",
        "id": 252922358,
        "sender_full_name": "Jack Huey",
        "timestamp": 1631379889
    },
    {
        "content": "<p>And it might be an infinite loop, so might grow large; you can truncate</p>",
        "id": 252922368,
        "sender_full_name": "Jack Huey",
        "timestamp": 1631379906
    },
    {
        "content": "<p>on what commit do you want the rustc build?</p>",
        "id": 252922399,
        "sender_full_name": "Emil Gardström",
        "timestamp": 1631379960
    },
    {
        "content": "<p>whatever nightly you're using</p>",
        "id": 252922446,
        "sender_full_name": "Jack Huey",
        "timestamp": 1631379973
    },
    {
        "content": "<p>iirc debug is removed at compile in nightlies</p>",
        "id": 252922460,
        "sender_full_name": "Emil Gardström",
        "timestamp": 1631379992
    },
    {
        "content": "<p>err, you're right</p>",
        "id": 252922467,
        "sender_full_name": "Jack Huey",
        "timestamp": 1631380004
    },
    {
        "content": "<p>I would say the best way forward is maybe some kind of minimization</p>",
        "id": 252922565,
        "sender_full_name": "Jack Huey",
        "timestamp": 1631380099
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"300380\">Emil Gardström</span> <a href=\"#narrow/stream/122651-general/topic/cargo.20build.20hangs.2C.20how.20to.20minimize/near/252922460\">said</a>:</p>\n<blockquote>\n<p>iirc debug is removed at compile in nightlies</p>\n</blockquote>\n<p>(opened <a href=\"https://github.com/rust-lang/rust/pull/88864\">https://github.com/rust-lang/rust/pull/88864</a> and <a href=\"https://github.com/rust-lang/rust/pull/88863\">https://github.com/rust-lang/rust/pull/88863</a> to see how hard this would be to change)</p>",
        "id": 252923029,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1631380636
    },
    {
        "content": "<p>reminder for myself: if those land, ping <span class=\"user-mention silent\" data-user-id=\"120791\">RalfJ</span> about changing the logging in miri to debug instead of info</p>",
        "id": 252923104,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1631380688
    },
    {
        "content": "<p>The log as requested didn't pin point me anywhere (and it's 8GB), and I don't think it's going to be useful as there seems to be something that is causing something to become very deep, it is however not a loop (or atleast, no debug output after the same last line as in first log output). I've  managed to isolate the module where the halt occurs, so I think I can minimize it soon(tm)</p>",
        "id": 252933478,
        "sender_full_name": "Emil Gardström",
        "timestamp": 1631392372
    },
    {
        "content": "<p>I let the build run overnight with <code>info,rustc_trait_selection=debug</code> and it completed (with a stack failure)<br>\nhere's the log<br>\n<a href=\"https://gist.github.com/Emilgardis/954c2aeefc0cca270a421a90ecc5067a#file-output-cargo-issue88862-log-L988\">https://gist.github.com/Emilgardis/954c2aeefc0cca270a421a90ecc5067a#file-output-cargo-issue88862-log-L988</a> </p>\n<p>seems it actually does build, just takes much longer time. Do we have some more modules I could enable debug on to see if they are the cause?</p>",
        "id": 252967816,
        "sender_full_name": "Emil Gardström",
        "timestamp": 1631432813
    },
    {
        "content": "<p>tried on linux now, limited to 2GB, the build fails with a sigkill on nightly &gt; 2021-08-26, but is successful on 2021-08-25. Trying to hook into rustc to debug a bit more.</p>",
        "id": 252993883,
        "sender_full_name": "Emil Gardström",
        "timestamp": 1631460598
    },
    {
        "content": "<p>debugging rustc proved way to hard, instead I managed to minimize more and posted a gist in the issue</p>",
        "id": 253011737,
        "sender_full_name": "Emil Gardström",
        "timestamp": 1631480495
    }
]