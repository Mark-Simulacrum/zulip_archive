[
    {
        "content": "<p>I would like to call <code>backtrace::Backtrace::new_unresolved()</code>, but limit it to a certain number of stack frames. AFAICT there is no easy way to do this. I can use <code>backtrace::trace</code> and stop after a certain number of frame, but parts of <code>Backtrace</code>'s internals aren't public, so I can't create a <code>Backtrace</code> myself.</p>\n<p>So it seems like I'll need to create my own <code>ShortBacktrace</code> type. I think it's doable, but it'll require duplicating a bunch of <code>Backtrace's</code> internals for storing frames, resolving them later, printing them nicely, etc. Unless I'm overlooking something?</p>",
        "id": 263247639,
        "sender_full_name": "nnethercote",
        "timestamp": 1638337919
    },
    {
        "content": "<p>(If you're wondering why I'm asking this, it's for <a href=\"https://github.com/nnethercote/dhat-rs/\">https://github.com/nnethercote/dhat-rs/</a>. It gets <em>many</em> backtraces, which is the major source of overhead. But you never need to look past the top 10 or maybe 20 frames. Given that in big programs the stack can easily exceed 100 frames, limiting the depth will help speed a lot.)</p>",
        "id": 263247911,
        "sender_full_name": "nnethercote",
        "timestamp": 1638338258
    },
    {
        "content": "<p>You can use BacktraceFmt to print the individual frames when using <code>trace</code>.</p>",
        "id": 263257400,
        "sender_full_name": "bjorn3",
        "timestamp": 1638347146
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116015\">@Alex Crichton</span> pointed me in the right direction: turns out <code>From&lt;Frame&gt; for BacktraceFrame</code> and <code>From&lt;Vec&lt;BacktraceFrame&gt;&gt; for Backtrace</code> exist in recent versions of <code>backtrace</code>, which makes it easy:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">new_unresolved</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">Self</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">frames</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Vec</span>::<span class=\"n\">new</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">backtrace</span>::<span class=\"n\">trace</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">frame</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">frames</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">frame</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">().</span><span class=\"n\">into</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">frames</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"c1\">// stop after this many frames</span>\n<span class=\"w\">        </span><span class=\"p\">});</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">Backtrace</span><span class=\"p\">(</span><span class=\"n\">frames</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">())</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 263379602,
        "sender_full_name": "nnethercote",
        "timestamp": 1638406321
    }
]