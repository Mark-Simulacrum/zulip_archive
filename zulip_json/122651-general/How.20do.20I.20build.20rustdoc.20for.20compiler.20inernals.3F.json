[
    {
        "content": "<p><code>./x.py doc compiler/rustc_middle --open</code> doesn't open anything?</p>",
        "id": 252041689,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1630807521
    },
    {
        "content": "<p>Do you have <code>compiler-docs</code> enabled in config.toml?</p>",
        "id": 252045362,
        "sender_full_name": "Eric Huss",
        "timestamp": 1630811823
    },
    {
        "content": "<p>Actually, that would be very convenient to have a command to do so, like <code>x.py doc compiler</code>. I'll open a PR to add it because I need it quite often.</p>",
        "id": 252072239,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1630843688
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"257428\">@Gus Wynn</span> Here you go: <a href=\"https://github.com/rust-lang/rust/pull/88666\">https://github.com/rust-lang/rust/pull/88666</a></p>",
        "id": 252083262,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1630855575
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"210316\">@GuillaumeGomez</span>  this is awesome! Does this not require that <code>compiler-docs</code> be on in config.toml?</p>",
        "id": 252083521,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1630855908
    },
    {
        "content": "<p>I got this panic thread 'rustc' panicked at 'no entry found for key', compiler/rustc_query_impl/src/on_disk_cache.rs:175:20 when compiling rustc_serialize when using <code>compiler-docs = true</code> as <span class=\"user-mention\" data-user-id=\"120518\">@Eric Huss</span> suggested, is it worth it to open an issue for this? or because I have local changes, i should just move on?</p>\n<p>query stack:</p>\n<div class=\"codehilite\"><pre><span></span><code>query stack during panic:\n#0 [predicates_of] computing predicates of `json::FormatShim`\n#1 [param_env] computing normalized predicates of `json::FormatShim`\n#2 [check_item_well_formed] checking that `json::FormatShim` is well-formed\n#3 [analysis] running analysis passes on this crate\nend of query stack\nerror: could not compile `rustc_serialize`\nwarning: build failed, waiting for other jobs to finish...\nerror: build failed\n</code></pre></div>",
        "id": 252084126,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1630856599
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"257428\">@Gus Wynn</span> there should be more to that message - can you paste the whole thing?</p>",
        "id": 252084424,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630856915
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>    Checking object v0.26.2\n Documenting rustc_serialize v0.0.0 (/Users/azw/repos/rust/compiler/rustc_serialize)\nthread &#39;rustc&#39; panicked at &#39;no entry found for key&#39;, compiler/rustc_query_impl/src/on_disk_cache.rs:175:20\nstack backtrace:\n   0: _rust_begin_unwind\n   1: core::panicking::panic_fmt\n   2: core::option::expect_failed\n   3: rustc_query_impl::on_disk_cache::CacheDecoder::file_index_to_file\n   4: rustc_query_impl::on_disk_cache::&lt;impl rustc_serialize::serialize::Decodable&lt;rustc_query_impl::on_disk_cache::CacheDecoder&gt; for rustc_span::span_encoding::Span&gt;::decode\n   5: &lt;core::iter::adapters::map::Map&lt;I,F&gt; as core::iter::traits::iterator::Iterator&gt;::try_fold\n   6: &lt;alloc::vec::Vec&lt;T&gt; as alloc::vec::spec_from_iter::SpecFromIter&lt;T,I&gt;&gt;::from_iter\n   7: &lt;[(rustc_middle::ty::Predicate,rustc_span::span_encoding::Span)] as rustc_middle::ty::codec::RefDecodable&lt;D&gt;&gt;::decode\n   8: rustc_query_impl::on_disk_cache::OnDiskCache::try_load_query_result\n   9: rustc_query_impl::plumbing::&lt;impl rustc_query_system::query::config::QueryDescription&lt;rustc_query_impl::plumbing::QueryCtxt&gt; for rustc_query_impl::queries::predicates_of&gt;::try_load_from_disk\n  10: rustc_query_system::query::plumbing::load_from_disk_and_cache_in_memory\n  11: rustc_data_structures::stack::ensure_sufficient_stack\n  12: rustc_query_system::query::plumbing::get_query_impl\n  13: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::predicates_of\n  14: rustc_ty_utils::ty::param_env\n  15: rustc_query_system::dep_graph::graph::DepGraph&lt;K&gt;::with_task_impl\n  16: rustc_data_structures::stack::ensure_sufficient_stack\n  17: rustc_query_system::query::plumbing::force_query_with_job\n  18: rustc_query_system::query::plumbing::get_query_impl\n  19: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::param_env\n  20: rustc_typeck::check::wfcheck::for_id\n  21: rustc_typeck::check::wfcheck::check_item_well_formed\n  22: rustc_query_system::dep_graph::graph::DepGraph&lt;K&gt;::with_task_impl\n  23: rustc_data_structures::stack::ensure_sufficient_stack\n  24: rustc_query_system::query::plumbing::force_query_with_job\n  25: rustc_query_system::query::plumbing::get_query_impl\n  26: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::check_item_well_formed\n  27: &lt;rustc_typeck::check::wfcheck::CheckTypeWellFormedVisitor as rustc_hir::intravisit::Visitor&gt;::visit_item\n  28: rustc_data_structures::sync::par_for_each_in\n  29: rustc_hir::hir::Crate::par_visit_all_item_likes\n  30: rustc_session::session::Session::track_errors\n  31: rustc_typeck::check_crate\n  32: rustc_interface::passes::analysis\n  33: rustc_query_system::dep_graph::graph::DepGraph&lt;K&gt;::with_task_impl\n  34: rustc_data_structures::stack::ensure_sufficient_stack\n  35: rustc_query_system::query::plumbing::force_query_with_job\n  36: rustc_query_system::query::plumbing::get_query_impl\n  37: &lt;rustc_query_impl::Queries as rustc_middle::ty::query::QueryEngine&gt;::analysis\n  38: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter\n  39: rustc_span::with_source_map\n  40: rustc_interface::interface::create_compiler_and_run\n  41: scoped_tls::ScopedKey&lt;T&gt;::set\nnote: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.\n\nerror: internal compiler error: unexpected panic\n\nnote: the compiler unexpectedly panicked. this is a bug.\n\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/issues/new?labels=C-bug%2C+I-ICE%2C+T-compiler&amp;template=ice.md\nnote: rustc 1.55.0-beta.1 (739f8f0a8 2021-07-28) running on x86_64-apple-darwin\n\nnote: compiler flags: -Z macro-backtrace -Z osx-rpath-install-name -Z tls-model=initial-exec -Z unstable-options -Z binary-dep-depinfo -Z force-unstable-if-unmarked -C opt-level=3 -C embed-bitcode=no -C debuginfo=0 -C incremental -C link-args=-Wl,-rpath,@loader_path/../lib -C split-debuginfo=unpacked -C prefer-dynamic -C llvm-args=-import-instr-limit=10 --crate-type lib\n\nnote: some of the compiler flags provided by cargo are hidden\n\nquery stack during panic:\n#0 [predicates_of] computing predicates of `json::FormatShim`\n#1 [param_env] computing normalized predicates of `json::FormatShim`\n#2 [check_item_well_formed] checking that `json::FormatShim` is well-formed\n#3 [analysis] running analysis passes on this crate\nend of query stack\nerror: could not compile `rustc_serialize`\nwarning: build failed, waiting for other jobs to finish...\nerror: build failed\n\n\ncommand did not execute successfully: &quot;/Users/azw/repos/rust/build/x86_64-apple-darwin/stage0/bin/cargo&quot; &quot;doc&quot; &quot;--target&quot; &quot;x86_64-apple-darwin&quot; &quot;-Zbinary-dep-depinfo&quot; &quot;-j&quot; &quot;8&quot; &quot;--release&quot; &quot;--features&quot; &quot; llvm&quot; &quot;--manifest-path&quot; &quot;/Users/azw/repos/rust/compiler/rustc/Cargo.toml&quot; &quot;-Zskip-rustdoc-fingerprint&quot; &quot;--no-deps&quot; &quot;-p&quot; &quot;rustc_codegen_llvm&quot; &quot;-p&quot; &quot;rustc_attr&quot; &quot;-p&quot; &quot;rustc_query_system&quot; &quot;-p&quot; &quot;rustc_ast_pretty&quot;&quot;-p&quot; &quot;rustc_driver&quot; &quot;-p&quot; &quot;rustc_plugin_impl&quot; &quot;-p&quot; &quot;rustc_symbol_mangling&quot; &quot;-p&quot; &quot;rustc_mir&quot; &quot;-p&quot; &quot;rustc_save_analysis&quot; &quot;-p&quot; &quot;rustc_interface&quot; &quot;-p&quot; &quot;rustc_parse&quot; &quot;-p&quot; &quot;rustc_data_structures&quot; &quot;-p&quot; &quot;rustc_session&quot; &quot;-p&quot; &quot;rustc_mir_build&quot; &quot;-p&quot; &quot;rustc_incremental&quot;\nexpected success, got: exit status: 101\n</code></pre></div>",
        "id": 252084450,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1630856953
    },
    {
        "content": "<p>even after x.py clean it happened but with </p>\n<div class=\"codehilite\"><pre><span></span><code>error[E0460]: found possibly newer version of crate `std` which `synstructure` depends on\n --&gt; compiler/rustc_macros/src/lib.rs:5:5\n  |\n5 | use synstructure::decl_derive;\n  |     ^^^^^^^^^^^^\n  |\n  = note: perhaps that crate needs to be recompiled?\n  = note: the following crate versions were found:\n          crate `std`: /Users/azw/repos/rust/build/x86_64-apple-darwin/stage0-sysroot/lib/rustlib/x86_64-apple-darwin/lib/libstd-060cee09e2e82134.rlib\n          crate `std`: /Users/azw/repos/rust/build/x86_64-apple-darwin/stage0-sysroot/lib/rustlib/x86_64-apple-darwin/lib/libstd-060cee09e2e82134.dylib\n          crate `synstructure`: /Users/azw/repos/rust/build/x86_64-apple-darwin/stage0-rustc/release/deps/libsynstructure-2b52aba3557a132b.rmeta\n\nerror: build failed\n\n\ncommand did not execute successfully: &quot;/Users/azw/repos/rust/build/x86_64-apple-darwin/stage0/bin/cargo&quot; &quot;doc&quot; &quot;--target&quot; &quot;x86_64-apple-darwin&quot; &quot;-Zbinary-dep-depinfo&quot; &quot;-j&quot; &quot;8&quot; &quot;--release&quot; &quot;--features&quot; &quot; llvm&quot; &quot;--manifest-path&quot; &quot;/Users/azw/repos/rust/compiler/rustc/Cargo.toml&quot; &quot;-Zskip-rustdoc-fingerprint&quot; &quot;--no-deps&quot; &quot;-p&quot; &quot;rustc_fs_util&quot; &quot;-p&quot; &quot;rustc_session&quot; &quot;-p&quot; &quot;rustc_resolve&quot; &quot;-p&quot; &quot;rustc_codegen_llvm&quot; &quot;-p&quot; &quot;rustc_feature&quot; &quot;-p&quot; &quot;rustc_parse_format&quot; &quot;-p&quot; &quot;rustc_privacy&quot; &quot;-p&quot; &quot;rustc_hir_pretty&quot; &quot;-p&quot; &quot;rustc_lint_defs&quot; &quot;-p&quot; &quot;rustc_codegen_ssa&quot; &quot;-p&quot; &quot;coverage_test_macros&quot; &quot;-p&quot; &quot;rustc_llvm&quot; &quot;-p&quot; &quot;rustc_driver&quot; &quot;-p&quot; &quot;rustc_ast&quot; &quot;-p&quot; &quot;rustc_apfloat&quot; &quot;-p&quot; &quot;rustc_macros&quot; &quot;-p&quot; &quot;rustc_ast_pretty&quot; &quot;-p&quot; &quot;rustc_symbol_mangling&quot; &quot;-p&quot; &quot;rustc_infer&quot; &quot;-p&quot; &quot;rustc_lint&quot; &quot;-p&quot; &quot;rustc_lexer&quot; &quot;-p&quot; &quot;rustc_ty_utils&quot; &quot;-p&quot; &quot;rustc_builtin_macros&quot; &quot;-p&quot; &quot;rustc_hir&quot; &quot;-p&quot; &quot;rustc_query_impl&quot; &quot;-p&quot; &quot;rustc_query_system&quot; &quot;-p&quot; &quot;rustc_errors&quot; &quot;-p&quot; &quot;rustc_serialize&quot; &quot;-p&quot; &quot;rustc_data_structures&quot; &quot;-p&quot; &quot;rustc_parse&quot; &quot;-p&quot; &quot;rustc_error_codes&quot; &quot;-p&quot; &quot;rustc_graphviz&quot; &quot;-p&quot; &quot;rustc_expand&quot; &quot;-p&quot; &quot;rustc_span&quot; &quot;-p&quot; &quot;rustc_target&quot; &quot;-p&quot; &quot;rustc_typeck&quot; &quot;-p&quot; &quot;rustc_metadata&quot; &quot;-p&quot; &quot;rustc_mir_build&quot; &quot;-p&quot; &quot;rustc_type_ir&quot; &quot;-p&quot; &quot;rustc_middle&quot; &quot;-p&quot; &quot;rustc_trait_selection&quot; &quot;-p&quot;\n&quot;rustc_attr&quot; &quot;-p&quot; &quot;rustc_ast_passes&quot; &quot;-p&quot; &quot;rustc_ast_lowering&quot; &quot;-p&quot; &quot;rustc_mir&quot; &quot;-p&quot; &quot;rustc_save_analysis&quot; &quot;-p&quot; &quot;rustc_plugin_impl&quot; &quot;-p&quot; &quot;rustc_incremental&quot; &quot;-p&quot; &quot;rustc_passes&quot; &quot;-p&quot; &quot;rustc_arena&quot; &quot;-p&quot; &quot;rustc_interface&quot; &quot;-p&quot; &quot;rustc_index&quot; &quot;-p&quot; &quot;rustc_traits&quot;\nexpected success, got: exit status: 101\n</code></pre></div>\n<p>in addition</p>\n<p>but i guess ./x.py clean doesnt clean the build/cache/ dir?</p>",
        "id": 252084538,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1630857023
    },
    {
        "content": "<p>clean --all seemed to work</p>",
        "id": 252085332,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1630857899
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"257428\">Gus Wynn</span> <a href=\"#narrow/stream/122651-general/topic/How.20do.20I.20build.20rustdoc.20for.20compiler.20inernals.3F/near/252084538\">said</a>:</p>\n<blockquote>\n<p>even after x.py clean it happened but with </p>\n<div class=\"codehilite\"><pre><span></span><code>error[E0460]: found possibly newer version of crate `std` which `synstructure` depends on\n --&gt; compiler/rustc_macros/src/lib.rs:5:5\n  |\n5 | use synstructure::decl_derive;\n  |     ^^^^^^^^^^^^\n  |\n  = note: perhaps that crate needs to be recompiled?\n  = note: the following crate versions were found:\n          crate `std`: /Users/azw/repos/rust/build/x86_64-apple-darwin/stage0-sysroot/lib/rustlib/x86_64-apple-darwin/lib/libstd-060cee09e2e82134.rlib\n          crate `std`: /Users/azw/repos/rust/build/x86_64-apple-darwin/stage0-sysroot/lib/rustlib/x86_64-apple-darwin/lib/libstd-060cee09e2e82134.dylib\n          crate `synstructure`: /Users/azw/repos/rust/build/x86_64-apple-darwin/stage0-rustc/release/deps/libsynstructure-2b52aba3557a132b.rmeta\n\nerror: build failed\n\n\ncommand did not execute successfully: &quot;/Users/azw/repos/rust/build/x86_64-apple-darwin/stage0/bin/cargo&quot; &quot;doc&quot; &quot;--target&quot; &quot;x86_64-apple-darwin&quot; &quot;-Zbinary-dep-depinfo&quot; &quot;-j&quot; &quot;8&quot; &quot;--release&quot; &quot;--features&quot; &quot; llvm&quot; &quot;--manifest-path&quot; &quot;/Users/azw/repos/rust/compiler/rustc/Cargo.toml&quot; &quot;-Zskip-rustdoc-fingerprint&quot; &quot;--no-deps&quot; &quot;-p&quot; &quot;rustc_fs_util&quot; &quot;-p&quot; &quot;rustc_session&quot; &quot;-p&quot; &quot;rustc_resolve&quot; &quot;-p&quot; &quot;rustc_codegen_llvm&quot; &quot;-p&quot; &quot;rustc_feature&quot; &quot;-p&quot; &quot;rustc_parse_format&quot; &quot;-p&quot; &quot;rustc_privacy&quot; &quot;-p&quot; &quot;rustc_hir_pretty&quot; &quot;-p&quot; &quot;rustc_lint_defs&quot; &quot;-p&quot; &quot;rustc_codegen_ssa&quot; &quot;-p&quot; &quot;coverage_test_macros&quot; &quot;-p&quot; &quot;rustc_llvm&quot; &quot;-p&quot; &quot;rustc_driver&quot; &quot;-p&quot; &quot;rustc_ast&quot; &quot;-p&quot; &quot;rustc_apfloat&quot; &quot;-p&quot; &quot;rustc_macros&quot; &quot;-p&quot; &quot;rustc_ast_pretty&quot; &quot;-p&quot; &quot;rustc_symbol_mangling&quot; &quot;-p&quot; &quot;rustc_infer&quot; &quot;-p&quot; &quot;rustc_lint&quot; &quot;-p&quot; &quot;rustc_lexer&quot; &quot;-p&quot; &quot;rustc_ty_utils&quot; &quot;-p&quot; &quot;rustc_builtin_macros&quot; &quot;-p&quot; &quot;rustc_hir&quot; &quot;-p&quot; &quot;rustc_query_impl&quot; &quot;-p&quot; &quot;rustc_query_system&quot; &quot;-p&quot; &quot;rustc_errors&quot; &quot;-p&quot; &quot;rustc_serialize&quot; &quot;-p&quot; &quot;rustc_data_structures&quot; &quot;-p&quot; &quot;rustc_parse&quot; &quot;-p&quot; &quot;rustc_error_codes&quot; &quot;-p&quot; &quot;rustc_graphviz&quot; &quot;-p&quot; &quot;rustc_expand&quot; &quot;-p&quot; &quot;rustc_span&quot; &quot;-p&quot; &quot;rustc_target&quot; &quot;-p&quot; &quot;rustc_typeck&quot; &quot;-p&quot; &quot;rustc_metadata&quot; &quot;-p&quot; &quot;rustc_mir_build&quot; &quot;-p&quot; &quot;rustc_type_ir&quot; &quot;-p&quot; &quot;rustc_middle&quot; &quot;-p&quot; &quot;rustc_trait_selection&quot; &quot;-p&quot;\n&quot;rustc_attr&quot; &quot;-p&quot; &quot;rustc_ast_passes&quot; &quot;-p&quot; &quot;rustc_ast_lowering&quot; &quot;-p&quot; &quot;rustc_mir&quot; &quot;-p&quot; &quot;rustc_save_analysis&quot; &quot;-p&quot; &quot;rustc_plugin_impl&quot; &quot;-p&quot; &quot;rustc_incremental&quot; &quot;-p&quot; &quot;rustc_passes&quot; &quot;-p&quot; &quot;rustc_arena&quot; &quot;-p&quot; &quot;rustc_interface&quot; &quot;-p&quot; &quot;rustc_index&quot; &quot;-p&quot; &quot;rustc_traits&quot;\nexpected success, got: exit status: 101\n</code></pre></div>\n<p>in addition</p>\n<p>but i guess ./x.py clean doesnt clean the build/cache/ dir?</p>\n</blockquote>\n<p>weirdly, I keep getting this \"found possibly newer version of crate <code>std</code>\" error, which manifests with different deps, but it seems to be transient with <code>build</code> and consistent with <code>doc</code>?</p>",
        "id": 252085868,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1630858443
    },
    {
        "content": "<p>there are some other zulip streams with people reporting RA as causing it, and there is this: <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Can't.20document.20compiler.20crate\">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/Can't.20document.20compiler.20crate</a> that is specifically about <code>doc</code>, seems like <code>--stage 1</code> works? looks like the original issue is unresolved tho</p>",
        "id": 252086241,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1630858901
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"257428\">@Gus Wynn</span> this is probably <a href=\"https://github.com/rust-lang/rust/pull/88310\">https://github.com/rust-lang/rust/pull/88310</a></p>",
        "id": 252087520,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630860295
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"257428\">Gus Wynn</span> <a href=\"#narrow/stream/122651-general/topic/How.20do.20I.20build.20rustdoc.20for.20compiler.20inernals.3F/near/252083521\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"210316\">GuillaumeGomez</span>  this is awesome! Does this not require that <code>compiler-docs</code> be on in config.toml?</p>\n</blockquote>\n<p>No, not with this option. However if you run more \"global\" commands, then it'll be skipped just like currently.</p>",
        "id": 252091426,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1630864595
    },
    {
        "content": "<p>Something that I feel is missing from <code>x.py doc</code> is skipping <em>building</em> the thing first that’s then going to be documented. If I do <code>x.py doc library/std</code>, it’s doing a full <code>Building stage0 std artifacts</code> before documenting <code>std</code>. Similarly, <code>x.py doc compiler/rustc --stage 1</code> or similar commands (e.g. <code>compiler/rustc_middle</code>) will (after building <code>stage1</code> compiler) do a full <code>Building stage1 compiler artifacts</code> before documenting them, in effect building the compiler <em>twice</em>, then documenting it (which takes a long time). I could understand that <code>stage1 std artifacts</code> might be necessary to be built for documenting <code>stage1</code> compiler artifacts, but compiling the whole <code>stage2</code> compile goes too far (i.e. shouldn’t be necessary; please correct me if I’m wrong) and is IMO something that should be fixed.</p>",
        "id": 252097256,
        "sender_full_name": "Frank Steffahn",
        "timestamp": 1630870905
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"280891\">@Frank Steffahn</span> I think you're expecting --stage 0 to be the default for documenting the compiler (actually, I was under the impression it was). If you pass --stage 0 does it behave like you expect?</p>",
        "id": 252097763,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630871429
    },
    {
        "content": "<p>x.py doc does need to <em>check</em> the artifacts, it needs metadata available. But it doesn't need a full build.</p>",
        "id": 252097796,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630871473
    },
    {
        "content": "<p>for <code>doc</code>, --stage indicates the compiler used to <em>generate</em> the docs, not the one being documented: <a href=\"https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#understanding-stages-of-bootstrap\">https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#understanding-stages-of-bootstrap</a></p>",
        "id": 252097922,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630871594
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232545\">@Joshua Nelson</span> It does a full build though, AFAICT. You’ll see <code>Compiling …</code> for the whole rust compiler <em>twice</em> before it starts <code>Documenting</code> anything with <code>x.py doc compiler/rustc --stage 1</code>; similarly for <code>library/std</code> (<a href=\"https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#default-stages\">and b.t.w. for <code>doc</code> command <code>--stage 0</code> *is* the default</a>).</p>\n<p>Can’t give you an output for <code>x.py doc compiler/rustc --stage 1</code> (because that would take forever), but for example for <code>std</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ x.px doc library/std --stage 0\nUpdating only changed submodules\nSubmodules updated in 0.01 seconds\n    Finished dev [unoptimized + debuginfo] target(s) in 0.14s\nDocumenting stage0 std (x86_64-unknown-linux-gnu)\nBuilding stage0 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)\n   Compiling cc v1.0.69\n   Compiling core v0.0.0 (/home/frank/forks/rust/library/core)\n   Compiling libc v0.2.99\n   Compiling memchr v2.4.1\n   Compiling std v0.0.0 (/home/frank/forks/rust/library/std)\n   Compiling compiler_builtins v0.1.49\n   Compiling unwind v0.0.0 (/home/frank/forks/rust/library/unwind)\n   Compiling rustc-std-workspace-core v1.99.0 (/home/frank/forks/rust/library/rustc-std-workspace-core)\n   Compiling alloc v0.0.0 (/home/frank/forks/rust/library/alloc)\n   Compiling cfg-if v0.1.10\n   Compiling adler v0.2.3\n   Compiling rustc-demangle v0.1.21\n   Compiling rustc-std-workspace-alloc v1.99.0 (/home/frank/forks/rust/library/rustc-std-workspace-alloc)\n   Compiling panic_unwind v0.0.0 (/home/frank/forks/rust/library/panic_unwind)\n   Compiling panic_abort v0.0.0 (/home/frank/forks/rust/library/panic_abort)\n   Compiling gimli v0.25.0\n   Compiling hashbrown v0.11.0\n   Compiling std_detect v0.1.5 (/home/frank/forks/rust/library/stdarch/crates/std_detect)\n   Compiling miniz_oxide v0.4.0\n   Compiling object v0.26.2\n   Compiling addr2line v0.16.0\n   Compiling rustc-std-workspace-std v1.99.0 (/home/frank/forks/rust/library/rustc-std-workspace-std)\n   Compiling proc_macro v0.0.0 (/home/frank/forks/rust/library/proc_macro)\n   Compiling unicode-width v0.1.8\n   Compiling getopts v0.2.21\n   Compiling test v0.0.0 (/home/frank/forks/rust/library/test)\n    Finished release [optimized] target(s) in 50.10s\nCopying stage0 std from stage0 (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu / x86_64-unknown-linux-gnu)\n Documenting core v0.0.0 (/home/frank/forks/rust/library/core)\n    Finished release [optimized] target(s) in 16.24s\n    Checking core v0.0.0 (/home/frank/forks/rust/library/core)\n    Checking rustc-std-workspace-core v1.99.0 (/home/frank/forks/rust/library/rustc-std-workspace-core)\n    Checking compiler_builtins v0.1.49\n Documenting alloc v0.0.0 (/home/frank/forks/rust/library/alloc)\n    Finished release [optimized] target(s) in 23.22s\n    Checking libc v0.2.99\n   Compiling std v0.0.0 (/home/frank/forks/rust/library/std)\n    Checking alloc v0.0.0 (/home/frank/forks/rust/library/alloc)\n    Checking cfg-if v0.1.10\n    Checking adler v0.2.3\n    Checking memchr v2.4.1\n    Checking rustc-demangle v0.1.21\n    Checking unwind v0.0.0 (/home/frank/forks/rust/library/unwind)\n    Checking rustc-std-workspace-alloc v1.99.0 (/home/frank/forks/rust/library/rustc-std-workspace-alloc)\n    Checking panic_unwind v0.0.0 (/home/frank/forks/rust/library/panic_unwind)\n    Checking panic_abort v0.0.0 (/home/frank/forks/rust/library/panic_abort)\n    Checking gimli v0.25.0\n    Checking std_detect v0.1.5 (/home/frank/forks/rust/library/stdarch/crates/std_detect)\n    Checking hashbrown v0.11.0\n    Checking miniz_oxide v0.4.0\n    Checking object v0.26.2\n    Checking addr2line v0.16.0\n Documenting std v0.0.0 (/home/frank/forks/rust/library/std)\n    Finished release [optimized] target(s) in 14.06s\nBuild completed successfully in 0:01:45\n</code></pre></div>",
        "id": 252098081,
        "sender_full_name": "Frank Steffahn",
        "timestamp": 1630871731
    },
    {
        "content": "<p>Hmm, ok, that does look incorrect. I wonder if it regressed at some point, I don't remember it doing that before</p>",
        "id": 252098175,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630871824
    },
    {
        "content": "<p>yeah this bit looks odd: <a href=\"https://github.com/rust-lang/rust/blob/e2750baf53aaa60db95f10759f6cf9463dc5a6bd/src/bootstrap/doc.rs#L569\">https://github.com/rust-lang/rust/blob/e2750baf53aaa60db95f10759f6cf9463dc5a6bd/src/bootstrap/doc.rs#L569</a></p>",
        "id": 252098406,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630872043
    },
    {
        "content": "<p>(it's also possible I've just never tried to use --stage 1 with <code>doc compiler/rustc</code> before)</p>",
        "id": 252098600,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630872263
    },
    {
        "content": "<blockquote>\n<p>weirdly, I keep getting this \"found possibly newer version of crate std\" error, which manifests with different deps, but it seems to be transient with build and consistent with doc?</p>\n</blockquote>\n<p>oh, yeah that one is <a href=\"https://github.com/rust-lang/rust/issues/79980\">https://github.com/rust-lang/rust/issues/79980</a></p>",
        "id": 252099279,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630872991
    },
    {
        "content": "<blockquote>\n<p>/home/joshua/rustc/build/x86_64-unknown-linux-gnu/stage1/bin/rustdoc: error while loading shared libraries: <a href=\"http://libtest-3be2459aaa99892c.so\">libtest-3be2459aaa99892c.so</a>: cannot open shared object file: No such file or directory</p>\n</blockquote>\n<p>well this is odd - this is after I changed <code>doc</code> not to build the standard library:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/src/bootstrap/doc.rs b/src/bootstrap/doc.rs</span>\n<span class=\"gh\">index c8714117930..6eb8df13689 100644</span>\n<span class=\"gd\">--- a/src/bootstrap/doc.rs</span>\n<span class=\"gi\">+++ b/src/bootstrap/doc.rs</span>\n<span class=\"gu\">@@ -446,7 +446,6 @@ fn run(self, builder: &amp;Builder&lt;'_&gt;) {</span>\n         t!(fs::create_dir_all(&amp;out));\n         let compiler = builder.compiler(stage, builder.config.build);\n\n<span class=\"gd\">-        builder.ensure(compile::Std { compiler, target });</span>\n         let out_dir = builder.stage_out(compiler, Mode::Std).join(target.triple).join(\"doc\");\n\n         t!(fs::copy(builder.src.join(\"src/doc/rust.css\"), out.join(\"rust.css\")));\n<span class=\"gu\">@@ -564,9 +563,10 @@ fn run(self, builder: &amp;Builder&lt;'_&gt;) {</span>\n         let out = builder.compiler_doc_out(target);\n         t!(fs::create_dir_all(&amp;out));\n\n<span class=\"gd\">-        // Build rustc.</span>\n<span class=\"gi\">+        // Build the standard library, so that proc-macros can use it.</span>\n<span class=\"gi\">+        // (Normally, only the metadata would be necessary, but proc-macros are special since they run at compile-time.)</span>\n         let compiler = builder.compiler(stage, builder.config.build);\n<span class=\"gd\">-        builder.ensure(compile::Rustc { compiler, target });</span>\n<span class=\"gi\">+        builder.ensure(compile::Std { compiler, target: builder.config.build });</span>\n\n         // This uses a shared directory so that librustdoc documentation gets\n         // correctly built and merged with the rustc documentation. This is\n</code></pre></div>\n<p>But that library was built, it just wasn't uplifted to the correct sysroot for some reason:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ fd libtest-3be2459aaa99892c.so build/x86_64-unknown-linux-gnu/\nbuild/x86_64-unknown-linux-gnu/stage0-std/x86_64-unknown-linux-gnu/release/deps/libtest-3be2459aaa99892c.so\nbuild/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib/libtest-3be2459aaa99892c.so\n</code></pre></div>",
        "id": 252099720,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630873475
    },
    {
        "content": "<p>instead it seems to have a completely different version of libstd???</p>\n<div class=\"codehilite\"><pre><span></span><code>$ fd libtest build/x86_64-unknown-linux-gnu/stage1\nbuild/x86_64-unknown-linux-gnu/stage1/lib/libtest-6860eda207d50773.so\nbuild/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libtest-6860eda207d50773.rlib\nbuild/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu/lib/libtest-6860eda207d50773.so\n$ fd libtest build/x86_64-unknown-linux-gnu/stage0\nbuild/x86_64-unknown-linux-gnu/stage0/lib/libtest-6e9019ff2cdb2237.so\nbuild/x86_64-unknown-linux-gnu/stage0/lib/rustlib/x86_64-unknown-linux-gnu/lib/libtest-6e9019ff2cdb2237.rlib\nbuild/x86_64-unknown-linux-gnu/stage0/lib/rustlib/x86_64-unknown-linux-gnu/lib/libtest-6e9019ff2cdb2237.so\n$ fd libtest build/x86_64-unknown-linux-gnu/stage0-sysroot\nbuild/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib/libtest-3be2459aaa99892c.rlib\nbuild/x86_64-unknown-linux-gnu/stage0-sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib/libtest-3be2459aaa99892c.so\n</code></pre></div>",
        "id": 252099866,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630873667
    },
    {
        "content": "<p>ok, according to what I wrote in <a href=\"https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#what-is-a-sysroot\">https://rustc-dev-guide.rust-lang.org/building/bootstrapping.html#what-is-a-sysroot</a>, <code>lib/</code> is for rustc and <code>lib/rustlib</code> is for the standard library. I think it's wrong for the versions in lib/ and rustlib/ to be the same, <code>stage1/lib/libtest.so</code> should be the same as the one in <code>stage0-std</code>.</p>",
        "id": 252100060,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630873866
    },
    {
        "content": "<p>and in fact that <em>is</em> the case for <code>stage0-sysroot</code>, it's only wrong for <code>stage1</code> <span aria-label=\"confused\" class=\"emoji emoji-1f615\" role=\"img\" title=\"confused\">:confused:</span></p>",
        "id": 252100085,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630873907
    },
    {
        "content": "<p>and it's even being copied, because it's in the stamp file! is it being deleted ??</p>\n<div class=\"codehilite\"><pre><span></span><code>$ tr &#39;\\0&#39; &#39;\\n&#39; &lt; build/x86_64-unknown-linux-gnu/stage0-std/x86_64-unknown-linux-gnu/release/.libstd.stamp | grep libtest\nt/home/joshua/rustc/build/x86_64-unknown-linux-gnu/stage0-std/x86_64-unknown-linux-gnu/release/deps/libtest-3be2459aaa99892c.rlib\nt/home/joshua/rustc/build/x86_64-unknown-linux-gnu/stage0-std/x86_64-unknown-linux-gnu/release/deps/libtest-3be2459aaa99892c.so\n</code></pre></div>",
        "id": 252100452,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1630874284
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/122651-general/topic/How.20do.20I.20build.20rustdoc.20for.20compiler.20inernals.3F/near/252087520\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"257428\">Gus Wynn</span> this is probably <a href=\"https://github.com/rust-lang/rust/pull/88310\">https://github.com/rust-lang/rust/pull/88310</a></p>\n</blockquote>\n<p>oh sweeet, so ra's x.py check and manual x.py runs wont interfere!</p>",
        "id": 252114814,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1630891079
    }
]