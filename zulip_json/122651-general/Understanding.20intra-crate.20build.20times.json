[
    {
        "content": "<p>I know that there's the great <code>cargo -Z timings</code> to understand how your build time is spent across crates, but how can I break down the build time <em>within</em> a crate.</p>\n<p>My main crate takes 13s to build, which sure isn't the end of the world but could be better, and I'd like to understand where that time is going so I can do any low-hanging work</p>",
        "id": 254216008,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1632234445
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/measureme/\">https://github.com/rust-lang/measureme/</a> helps, but it's not always useful</p>",
        "id": 254216141,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632234487
    },
    {
        "content": "<p>Is <code>cargo clean -p crate_name; cargo check</code> considerably faster? If yes, <code>self-profile</code> probably won't help much.</p>",
        "id": 254216212,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632234519
    },
    {
        "content": "<p>Other tips are disabling/reducing debug info (but that's disabled on release) and using the <code>lld</code> linker, which is faster (especially when you have debug info enabled)</p>",
        "id": 254216632,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632234675
    },
    {
        "content": "<p>So if <code>cargo check</code> is slow, it's probably something that <code>rustc</code> doesn't like and <code>self-profile</code> helps. If it's slow with debug info and fast without it, it's the debug info and/or the linker. If <code>cargo check</code> is fast and <code>cargo build</code> is slow even without debug info and with <code>lld</code>, it's probably spending time in LLVM, but <code>self-profile</code> won't tell you why.</p>",
        "id": 254217006,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632234812
    },
    {
        "content": "<p><code>cargo-llvm-lines</code> and <code>cargo-bloat</code> can help too, they will pinpoint functions with a lot of LLVM IR or compiled code.</p>",
        "id": 254217170,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632234869
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"203546\">@Laurențiu</span> this is an amazing summary <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span> would you be interested in putting this in the rust performance book?<br>\n<a href=\"https://nnethercote.github.io/perf-book/\">https://nnethercote.github.io/perf-book/</a></p>",
        "id": 254225116,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1632237633
    },
    {
        "content": "<p>Maybe? But I think most of it is already in there, including <code>cargo-llvm-lines</code></p>",
        "id": 254225294,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632237703
    },
    {
        "content": "<p>Is there anyway to get link times from rustc?</p>",
        "id": 254233370,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1632240482
    },
    {
        "content": "<p>I have a hunch it’s an issue since I’m linking a rustc driver which thus links against a bunch of large rustc cratea</p>",
        "id": 254233484,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1632240517
    },
    {
        "content": "<p>I suppose I can also just try lld on my Linux box</p>",
        "id": 254233570,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1632240551
    },
    {
        "content": "<p>Hmm, I'm not sure how linking shows up in <code>self-profile</code>. It probably does, but..</p>",
        "id": 254234975,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632241100
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"203546\">@Laurențiu</span> it does, not from queries but from miscellaneous interval tracking (that is, there is manual code somewhere around that part). you can see it show up on <a href=\"http://perf.rust-lang.org\">perf.rust-lang.org</a> (alongside with various aspects of our use of LLVM) in the \"query\" view</p>",
        "id": 254235434,
        "sender_full_name": "eddyb",
        "timestamp": 1632241302
    },
    {
        "content": "<p>e.g. <a href=\"https://perf.rust-lang.org/detailed-query.html?commit=49c0861ed0fa1d95186d88df0cd4310103e70957&amp;base_commit=e7958d35ca2c898a223efe402481e0ecb854310a&amp;benchmark=unused-warnings-opt&amp;run_name=full\">https://perf.rust-lang.org/detailed-query.html?commit=49c0861ed0fa1d95186d88df0cd4310103e70957&amp;base_commit=e7958d35ca2c898a223efe402481e0ecb854310a&amp;benchmark=unused-warnings-opt&amp;run_name=full</a></p>",
        "id": 254235803,
        "sender_full_name": "eddyb",
        "timestamp": 1632241430
    },
    {
        "content": "<p>you can see <code>run_linker</code> at the top</p>",
        "id": 254235816,
        "sender_full_name": "eddyb",
        "timestamp": 1632241436
    },
    {
        "content": "<p>(<code>expand_crate</code>, <code>parse_crate</code> etc. are also manual in the same sense, and not part of queries)</p>",
        "id": 254235912,
        "sender_full_name": "eddyb",
        "timestamp": 1632241457
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/b3HglIheoM2-DBnSl9XLXZZ3/image.png\">image.png</a>  Yeah, it's there.</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/b3HglIheoM2-DBnSl9XLXZZ3/image.png\" title=\"image.png\"><img src=\"/user_uploads/4715/b3HglIheoM2-DBnSl9XLXZZ3/image.png\"></a></div>",
        "id": 254237307,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632242001
    },
    {
        "content": "<p>You can also use <code>-Ztime-passes</code> and then grep for link_binary.</p>",
        "id": 254237593,
        "sender_full_name": "bjorn3",
        "timestamp": 1632242103
    },
    {
        "content": "<p>Oh, that's nicer than running <code>crox</code> and starting Chrome</p>",
        "id": 254238431,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632242416
    },
    {
        "content": "<p><code>-Zself-profile-events=llvm</code> also sounds nice, but <code>-Znew-llvm-pass-manager</code> <code>SIGSEGV</code>s on my machine</p>",
        "id": 254239496,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632242801
    },
    {
        "content": "<p>you don't have to run crox and launch chrome btw, you can use <code>summarize</code> to display this data as a list of text, and can grep that as well. More info here <a href=\"https://github.com/rust-lang/measureme/blob/master/summarize/Readme.md\">https://github.com/rust-lang/measureme/blob/master/summarize/Readme.md</a></p>",
        "id": 254246513,
        "sender_full_name": "lqd",
        "timestamp": 1632245486
    }
]