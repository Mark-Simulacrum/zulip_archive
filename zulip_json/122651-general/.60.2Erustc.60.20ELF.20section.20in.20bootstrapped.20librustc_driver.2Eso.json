[
    {
        "content": "<p>I'm trying to get a better understanding of the <code>rustc</code> bootstrapping process by comparing a stage2 compiler with a stage3 compiler. (I'm using 1.54.0 for my experimentation, with the ultimate goal being a DDC verification against <code>mrustc</code>.) The <code>rustc</code> binaries themselves are identical, but stage2's librustc_driver library (<code>librustc_driver-9a7a3804a42def03.so</code>) differs from stage3's librustc_driver library (despite them having identical names). A diffoscope comparison reveals differences in a <code>.rustc</code> ELF section, differences in 2 symbol's sizes (which may be a result of this <code>.rustc</code> section difference), and a warning about stage2 being modified after NT_GNU_BUILD_ID was applied (which is probably an artifact of how I'm building the stages currently). Where can I find documentation as to what purpose the <code>.rustc</code> section serves, and why it might be different between stage2 and stage3?</p>",
        "id": 266541548,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641014650
    },
    {
        "content": "<p>The <code>.rustc</code> section contains the crate metadata. This is has a similar role to header files in C/C++.</p>",
        "id": 266547915,
        "sender_full_name": "bjorn3",
        "timestamp": 1641026106
    },
    {
        "content": "<p>Which two symbols have different sizes?</p>",
        "id": 266547940,
        "sender_full_name": "bjorn3",
        "timestamp": 1641026142
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/T22KRW8HQKdi5sAxjlXZmNb-/diffoscope_rustc_driver_stage2_3.zip\">diffoscope_rustc_driver_stage2_3.zip</a> I've attached the HTML output of diffoscope here. The two symbols are both named <code>rust_metadata_rustc_driver_68b647559aa1518f91864c6c3e2842c6</code>, under the comparison of <code>readelf --wide --symbols {}</code> in the <code>.zip</code> I attached.</p>",
        "id": 266568962,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641061694
    },
    {
        "content": "<blockquote>\n<p>The two symbols are both named <code>rust_metadata_rustc_driver_68b647559aa1518f91864c6c3e2842c6</code></p>\n</blockquote>\n<p>This is the symbol in the <code>.rustc</code> section.</p>",
        "id": 266569123,
        "sender_full_name": "bjorn3",
        "timestamp": 1641061938
    },
    {
        "content": "<p>The <code>.rustc</code> section is compressed using snappy. Could you post the <code>rustc_driver.rmeta</code> files produced by <code>objcopy -O binary --only-section=.rustc librustc_driver-9a7a3804a42def03.so rustc_driver.rmeta</code> on both versions of <code>librustc_driver.so</code>?</p>",
        "id": 266569217,
        "sender_full_name": "bjorn3",
        "timestamp": 1641062128
    },
    {
        "content": "<p>This could be non-deterministic compression or it could be a small change in the data before compressing causing a ripple effect on the entire compressed data.</p>",
        "id": 266569276,
        "sender_full_name": "bjorn3",
        "timestamp": 1641062196
    },
    {
        "content": "<p>Weirdly enough, using your <code>objcopy</code> command leads to identical empty <code>.rmeta</code> files for both stages. However, using <code>objcopy --dump-section .rustc=stage2_librustc_driver_rustc.bin stage2/lib/librustc_driver-9a7a3804a42def03.so</code> (and analogously for stage3) leads to nonempty distinct outputs. I've attached the <code>--dump-section</code> outputs here instead: <a href=\"/user_uploads/4715/SXfJocN9nJz30v_dNN1l9e2h/stage2_librustc_driver_rustc.bin\">stage2_librustc_driver_rustc.bin</a> <a href=\"/user_uploads/4715/9FuscPa3EbkCyaN5ABZJqjjM/stage3_librustc_driver_rustc.bin\">stage3_librustc_driver_rustc.bin</a></p>",
        "id": 266569663,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641062810
    },
    {
        "content": "<p>Both files look fine. Let me quickly write some code to decompress them.</p>",
        "id": 266569830,
        "sender_full_name": "bjorn3",
        "timestamp": 1641063054
    },
    {
        "content": "<p>Decompressed them both. The decompressed content is different. Even in the first 16 bytes there is a difference:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">-│00000000│ 72 75 73 74 00 00 00 05 ┊ 00 05 29 25 23 72 75 73 │rust000•┊0•)%#rus│</span>\n<span class=\"gi\">+│00000000│ 72 75 73 74 00 00 00 05 ┊ 00 05 29 1b 23 72 75 73 │rust000•┊0•)•#rus│</span>\n</code></pre></div>",
        "id": 266570548,
        "sender_full_name": "bjorn3",
        "timestamp": 1641063944
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/AjANuY7rCHqxePTRh0KIbseq/stage3_librustc_driver_rustc.bin.decompressed\">stage3_librustc_driver_rustc.bin.decompressed</a> <a href=\"/user_uploads/4715/IJY-Hdv8a6_jhil16PnAf3bS/stage2_librustc_driver_rustc.bin.decompressed\">stage2_librustc_driver_rustc.bin.decompressed</a></p>",
        "id": 266570593,
        "sender_full_name": "bjorn3",
        "timestamp": 1641063967
    },
    {
        "content": "<p>The difference here is the pointer to the crate root. That matches with the metadata size differing 10 bytes between the two files.</p>",
        "id": 266570697,
        "sender_full_name": "bjorn3",
        "timestamp": 1641064114
    },
    {
        "content": "<p>The next difference is the crate hash for dependencies being different: <a href=\"https://github.com/rust-lang/rust/blob/78fd0f633faaa5b6dd254fc1456735f63a1b1238/compiler/rustc_metadata/src/rmeta/encoder.rs#L1734\">https://github.com/rust-lang/rust/blob/78fd0f633faaa5b6dd254fc1456735f63a1b1238/compiler/rustc_metadata/src/rmeta/encoder.rs#L1734</a></p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code> │00000400│ 39 36 34 32 11 72 75 73 ┊ 74 63 5f 70 6c 75 67 69 │9642•rus┊tc_plugi│\n<span class=\"gd\">-│00000410│ 6e 5f 69 6d 70 6c c1 f5 ┊ 98 ef bb be 8d e7 db 01 │n_impl××┊×××××××•│</span>\n<span class=\"gi\">+│00000410│ 6e 5f 69 6d 70 6c b5 8f ┊ a0 d3 d3 dc ff bd ab 01 │n_impl××┊×××××××•│</span>\n │00000420│ 00 02 11 2d 63 35 39 34 ┊ 36 32 64 39 37 30 39 39 │0••-c594┊62d97099│\n<span class=\"gd\">-│00000430│ 32 30 61 32 0a 72 75 73 ┊ 74 63 5f 6c 69 6e 74 dd │20a2_rus┊tc_lint×│</span>\n</code></pre></div>",
        "id": 266570797,
        "sender_full_name": "bjorn3",
        "timestamp": 1641064280
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"438223\">@Ryan Lee</span> Can you check that all dependencies of <code>rustc_driver</code> are the same?</p>",
        "id": 266570850,
        "sender_full_name": "bjorn3",
        "timestamp": 1641064329
    },
    {
        "content": "<p>note to self: saved all files at ~/Projects/diffoscope_compare</p>",
        "id": 266570927,
        "sender_full_name": "bjorn3",
        "timestamp": 1641064472
    },
    {
        "content": "<p>I'm not sure how I would check this; would you mind telling me how I'd do that? Do you mean the files in the <code>rustlib</code> folder or something else?</p>",
        "id": 266570932,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641064489
    },
    {
        "content": "<p>all the rlibs in <code>build/&lt;target&gt;/stage*-rustc/&lt;target&gt;/release/deps</code></p>",
        "id": 266571012,
        "sender_full_name": "bjorn3",
        "timestamp": 1641064603
    },
    {
        "content": "<p>Slightly off-topic - I wonder if we have the CI budget to write a test verifying that stage2 is identical to stage3</p>",
        "id": 266571015,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1641064615
    },
    {
        "content": "<p>That would be nice to have.</p>",
        "id": 266571022,
        "sender_full_name": "bjorn3",
        "timestamp": 1641064644
    },
    {
        "content": "<p>I agree that that'd be nice to have</p>",
        "id": 266571024,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641064655
    },
    {
        "content": "<p>As to the rlibs: it'll take me a while to get those but I'll update here once I've gone through them</p>",
        "id": 266571029,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641064669
    },
    {
        "content": "<p>If the divergence happens early it may already become apperant after checking a single file.</p>",
        "id": 266571085,
        "sender_full_name": "bjorn3",
        "timestamp": 1641064745
    },
    {
        "content": "<p>My understanding is the stage2 compiler's rustc_driver rlibs, etc. would be under <code>build/&lt;target&gt;/stage1-rustc/...</code>, and that the stage3 compiler's rustc_driver rlibs would be under <code>build/&lt;target&gt;/stage2-rustc/...</code>.</p>\n<p>A diffoscope comparison of the <code>.rlibs</code> shows differences in the embedded <code>lib.rmeta</code> for the following libraries (I manually assembled this list from the output so I may have missed some):</p>\n<div class=\"codehilite\"><pre><span></span><code>libblock_buffer-27f8249cbecae6b3.rlib\nlibdigest-80bfb6ce5737f916.rlib\nlibgeneric_array-d4364c1bb6647e99.rlib\nlibmd5-78eb033b877821f6.rlib\nlibrustc_ast-ebbc1fed82dfbbc2.rlib\nlibrustc_ast_lowering-c78224541fc11b6e.rlib\nlibrustc_ast_passes-5077c03364232bcb.rlib\nlibrustc_ast_pretty-d878c7a1fbd74e7d.rlib\nlibrustc_attr-71ef4e56e1e89fa6.rlib\nlibrustc_builtin_macros-69e3708ae1a2957b.rlib\nlibrustc_codegen_llvm-5548122be175cf40.rlib\nlibrustc_codegen_ssa-5c9a9dd4855e2df6.rlib\nlibrustc_errors-0b579100d527fb69.rlib\nlibrustc_expand-c7e6387ebde4caa7.rlib\nlibrustc_feature-1e216cf483c46fc6.rlib\nlibrustc_hir-dfc85577a70dc94b.rlib\nlibrustc_hir_pretty-e0de61504504f866.rlib\nlibrustc_incremental-84be4c7135e6652d.rlib\nlibrustc_infer-5a107c16124ad3c5.rlib\nlibrustc_interface-f4ba77c25b837a2e.rlib\nlibrustc_lint-fdf9f9431ab85a47.rlib\nlibrustc_lint_defs-af3bac89685d93f1.rlib\nlibrustc_metadata-43628d0ca56eb369.rlib\nlibrustc_middle-78697aa04d9e3c2b.rlib\nlibrustc_mir-7bfe08ca0a076948.rlib\nlibrustc_mir_build-87b1787081b2adc2.rlib\nlibrustc_parse-ab45b8133cb1a0df.rlib\nlibrustc_parse_format-f903682b0b544f7a.rlib\nlibrustc_passes-c2d23231003b380b.rlib\nlibrustc_plugin_impl-c59462d9709920a2.rlib\nlibrustc_privacy-4e5eb7e8ff09fe09.rlib\nlibrustc_query_impl-28a9f91f48bfd1f4.rlib\nlibrustc_query_system-2af0d1992930e55c.rlib\nlibrustc_resolve-57a233c0705fce7a.rlib\nlibrustc_save_analysis-be92a3a5003fc32a.rlib\nlibrustc_session-6105d6767c90656c.rlib\nlibrustc_span-fbfea3eeb779cfd8.rlib\nlibrustc_symbol_mangling-37ae3679defc4a4c.rlib\nlibrustc_target-00c1f81fb0648789.rlib\nlibrustc_trait_selection-3a47c62368a189d3.rlib\nlibrustc_traits-77d1cf64dc0c8421.rlib\nlibrustc_ty_utils-83d34e630a504484.rlib\nlibrustc_typeck-853babdf51ad4a89.rlib\nlibsha1-550c688167608572.rlib\nlibsha2-ef7844cf312c5e69.rlib\nlibsnap-77974ddbea3b9311.rlib\nlibtypenum-4b0b8c8c94695584.rlib\n</code></pre></div>\n<p><a href=\"/user_uploads/4715/M0ZRwphUEf6KCZlIGoIJEKhJ/diffoscope_rustc_driver_rlibs.zip\">diffoscope_rustc_driver_rlibs.zip</a> All the file pairs will show different timestamps, but that is an artifact of how I copied them over for comparison purposes.</p>\n<p>I'll most likely be busy with other things for the rest of today, so I'll send the associated <code>.rmeta</code> files as well if you want to take a closer look at them in the meantime: <a href=\"https://we.tl/t-zviOXzh7ws\">https://we.tl/t-zviOXzh7ws</a> (sha256sum c11cc0d798b3b4b3fa7f16267c2e64264a0f1b041897262216880c88cf260742; link expires in 1 week; if you're reading this in the future and want a copy later ping me)</p>",
        "id": 266574738,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641070453
    },
    {
        "content": "<p>Thanks for the help you've provided so far</p>",
        "id": 266574745,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641070473
    },
    {
        "content": "<p>I will try to take a look tomorrow. Could you ping me in a couple of hours so I don't forget? Or alternatively you could ping me immediately in which case I won't click on the notification.</p>",
        "id": 266578011,
        "sender_full_name": "bjorn3",
        "timestamp": 1641074731
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133247\">@bjorn3</span> ping as you requested, and noting for synchronization purposes that I'm currently in the UTC-8 timezone</p>",
        "id": 266588562,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641089834
    },
    {
        "content": "<p>I looked at libmd5-78eb033b877821f6.rmeta. For stage 3 the crate hash is 0x7d00000000000000 encoded as ULEB128. For stage 2 it gives a value larger than representable in 64bit when decoding as ULEB128. The stage 3 crate hash is highly unlikely to randomly happen. The stage 2 crate hash may be a mistake on my end.</p>",
        "id": 266620207,
        "sender_full_name": "bjorn3",
        "timestamp": 1641139211
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"438223\">@Ryan Lee</span></p>",
        "id": 266620390,
        "sender_full_name": "bjorn3",
        "timestamp": 1641139398
    },
    {
        "content": "<p>Huh, interesting</p>",
        "id": 266627131,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641148793
    },
    {
        "content": "<p>I don't know enough about the compiler internals to really know where to go from here, but I'll post updates to this thread if I find anything interesting</p>",
        "id": 266627227,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641148898
    },
    {
        "content": "<p>Found the root divergence I think! libtypenum ends up containing a compilation path:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code> │0027b230│ 35 34 2e 30 2d 77 2d 6c ┊ 6c 76 6d 2f 62 75 69 6c │54.0-w-l┊lvm/buil│\n │0027b240│ 64 2f 78 38 36 5f 36 34 ┊ 2d 75 6e 6b 6e 6f 77 6e │d/x86_64┊-unknown│\n │0027b250│ 2d 6c 69 6e 75 78 2d 67 ┊ 6e 75 2f 73 74 61 67 65 │-linux-g┊nu/stage│\n<span class=\"gd\">-│0027b260│ 31 2d 72 75 73 74 63 2f ┊ 78 38 36 5f 36 34 2d 75 │1-rustc/┊x86_64-u│</span>\n<span class=\"gi\">+│0027b260│ 32 2d 72 75 73 74 63 2f ┊ 78 38 36 5f 36 34 2d 75 │2-rustc/┊x86_64-u│</span>\n │0027b270│ 6e 6b 6e 6f 77 6e 2d 6c ┊ 69 6e 75 78 2d 67 6e 75 │nknown-l┊inux-gnu│\n │0027b280│ 2f 72 65 6c 65 61 73 65 ┊ 2f 62 75 69 6c 64 2f 74 │/release┊/build/t│\n │0027b290│ 79 70 65 6e 75 6d 2d 34 ┊ 36 30 33 30 34 66 35 36 │ypenum-4┊60304f56│\n</code></pre></div>",
        "id": 266627616,
        "sender_full_name": "bjorn3",
        "timestamp": 1641149425
    },
    {
        "content": "<p>More context:</p>\n<div class=\"codehilite\"><pre><span></span><code>│0027b210│ 97 c2 74 00 00 00 00 98 ┊ 01 2f 68 6f 6d 65 2f 72 │××t0000×┊•/home/r│\n│0027b220│ 75 73 74 63 5f 64 64 63 ┊ 2f 72 75 73 74 2d 31 2e │ustc_ddc┊/rust-1.│\n│0027b230│ 35 34 2e 30 2d 77 2d 6c ┊ 6c 76 6d 2f 62 75 69 6c │54.0-w-l┊lvm/buil│\n│0027b240│ 64 2f 78 38 36 5f 36 34 ┊ 2d 75 6e 6b 6e 6f 77 6e │d/x86_64┊-unknown│\n│0027b250│ 2d 6c 69 6e 75 78 2d 67 ┊ 6e 75 2f 73 74 61 67 65 │-linux-g┊nu/stage│\n│0027b260│ 31 2d 72 75 73 74 63 2f ┊ 78 38 36 5f 36 34 2d 75 │1-rustc/┊x86_64-u│\n│0027b270│ 6e 6b 6e 6f 77 6e 2d 6c ┊ 69 6e 75 78 2d 67 6e 75 │nknown-l┊inux-gnu│\n│0027b280│ 2f 72 65 6c 65 61 73 65 ┊ 2f 62 75 69 6c 64 2f 74 │/release┊/build/t│\n│0027b290│ 79 70 65 6e 75 6d 2d 34 ┊ 36 30 33 30 34 66 35 36 │ypenum-4┊60304f56│\n│0027b2a0│ 62 32 38 30 39 35 33 2f ┊ 6f 75 74 2f 6f 70 2e 72 │b280953/┊out/op.r│\n│0027b2b0│ 73 00 20 1d 14 0b 83 9b ┊ 74 88 9b b7 29 63 11 4c │s0 •••××┊t×××)c•L│\n</code></pre></div>",
        "id": 266627676,
        "sender_full_name": "bjorn3",
        "timestamp": 1641149533
    },
    {
        "content": "<p>Looks like typenum uses a custom env var instead of the <code>OUT_DIR</code> provided by cargo by default. Maybe enabling the <code>force_unix_path_separator</code> feature of typenum fixes the divergence?</p>",
        "id": 266627771,
        "sender_full_name": "bjorn3",
        "timestamp": 1641149678
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"438223\">@Ryan Lee</span></p>",
        "id": 266627774,
        "sender_full_name": "bjorn3",
        "timestamp": 1641149684
    },
    {
        "content": "<p>Nice find: are the rmeta files already decompressed, or would I need to decompress them myself</p>",
        "id": 266627779,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641149700
    },
    {
        "content": "<p>I'll look but it seems then that I'd need to modify the 1.54.0 source slightly to prevent this divergence</p>",
        "id": 266627801,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641149733
    },
    {
        "content": "<p>The metadata in rlibs is uncompressed only dylibs have compressed metadata as they are expected to be shipped and thus disk space matters.</p>",
        "id": 266627805,
        "sender_full_name": "bjorn3",
        "timestamp": 1641149741
    },
    {
        "content": "<p>Looks like the next step for me would be seeing if setting the feature and rebuilding would fix this: it'd take a while to rebuild so I'll update once I've looked at how to set the feature and what happens after I rebuild with the feature on</p>",
        "id": 266627920,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641149892
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"438223\">@Ryan Lee</span> You can add <code>typenum = { version = \"...\", features = [\"force_unix_path_separator\"] }</code> to the <code>[dependencies]</code> section in <code>compiler/rustc_driver/Cargo.toml</code>. (replace <code>...</code> with the actual version of typenum that is being built)</p>",
        "id": 266629051,
        "sender_full_name": "bjorn3",
        "timestamp": 1641151614
    },
    {
        "content": "<p>After making this change, I am getting errors with <code>x.py build</code> saying that the root <code>Cargo.lock</code> needs to be updated but that Cargo received the <code>--frozen</code> flag and could not update the lock file. I tried for a while to figure it out (including moving aside <code>Cargo.lock</code> to see if it'd generate a new one), but I've been unable to even run <code>python3 x.py build --help</code> without undoing the modification. How can I get <code>x.py</code> to update the <code>Cargo.lock</code>?</p>",
        "id": 266631648,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641155542
    },
    {
        "content": "<p>you need to set <code>locked-deps = false</code> in the config.toml (in the <code>[build]</code> section)</p>",
        "id": 266632066,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1641156226
    },
    {
        "content": "<p>Can you post the diff of the <code>Cargo.lock</code>? I suspect you are accidentally specifying a newer version of typenum than was previously used.</p>",
        "id": 266632376,
        "sender_full_name": "bjorn3",
        "timestamp": 1641156730
    },
    {
        "content": "<p>It is also possible you need to add <code>default-features = false</code> when specifying the typenum dependency.</p>",
        "id": 266632400,
        "sender_full_name": "bjorn3",
        "timestamp": 1641156769
    },
    {
        "content": "<p>I haven't succeeded in generating a new Cargo.lock yet: even after setting <code>locked-deps = false</code> in config.toml I'm still getting the same error</p>",
        "id": 266632480,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641156875
    },
    {
        "content": "<p>I specified <code>version = \"*\"</code> when adding the typenum dependency to use whatever version the other dependencies pulled in</p>",
        "id": 266632494,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641156905
    },
    {
        "content": "<p>One sec I'll attach my current <code>config.toml</code></p>",
        "id": 266632508,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641156930
    },
    {
        "content": "<p><code>version = \"*\"</code> may not select the right version. <code>version = \"1.12.0\"</code> should work.</p>",
        "id": 266632637,
        "sender_full_name": "bjorn3",
        "timestamp": 1641157098
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/1EbtYFxtfE6iUKAbu-7zt_RF/config_w_llvm_vendored_no_lockdeps.toml\">config_w_llvm_vendored_no_lockdeps.toml</a> </p>\n<p>I'll try changing that to \"1.12.0\" and see if that fixes the error I'm getting</p>",
        "id": 266632656,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641157164
    },
    {
        "content": "<p>Nope I'm still getting an error about the root Cargo.lock no being modifiable because of <code>--frozen</code>, even after setting <code>locked-deps = false</code></p>",
        "id": 266632781,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641157244
    },
    {
        "content": "<p>can you post the exact error?</p>",
        "id": 266632850,
        "sender_full_name": "bjorn3",
        "timestamp": 1641157329
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>error: the lock file /home/rustc_ddc/rust-1.54.0-w-llvm/Cargo.lock needs to be updated but --frozen was passed to prevent this\nIf you want to try to generate the lock file without accessing the network, use the --offline flag.\n</code></pre></div>",
        "id": 266632888,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641157426
    },
    {
        "content": "<p>could you run <code>cargo check -p bootstrap</code>? you can abort it as soon as it starts to listing crates it is checking. this should force the lockfile to be updated. if you don't have cargo installed you should be able to find the cargo used to bootstrap rustc in build/x86_64-unknown-linux-gnu/stage0/bin I think.</p>",
        "id": 266633021,
        "sender_full_name": "bjorn3",
        "timestamp": 1641157566
    },
    {
        "content": "<p>Now <code>python3 x.py build --help</code> works, thanks</p>",
        "id": 266633117,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641157747
    },
    {
        "content": "<p>I'll try building again with the typenum feature specified and see what happens</p>",
        "id": 266633129,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641157779
    },
    {
        "content": "<p>what is the <code>Cargo.lock</code> diff?</p>",
        "id": 266633193,
        "sender_full_name": "bjorn3",
        "timestamp": 1641157878
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/F1vWyYMEKZxtXbvOIXEBIpiy/typenum_cargo_lock_diff\">typenum_cargo_lock_diff</a> <a href=\"/user_uploads/4715/n8nH-TGOHAA2gBdbOUtU86Nc/rustc_driver_cargo_toml_typenum.patch\">rustc_driver_cargo_toml_typenum.patch</a></p>",
        "id": 266633388,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641158165
    },
    {
        "content": "<p>ah, right. the lockfile needs to be updated to list typenum as dependency of rustc_driver. the patch looks good to me.</p>",
        "id": 266633461,
        "sender_full_name": "bjorn3",
        "timestamp": 1641158305
    },
    {
        "content": "<p>As a side note, I was building rustc by running <code>x.py build --stage 2</code> and then <code>x.py build --stage 3</code>. I saved the directories before building with <code>--stage 3</code> and found that the <code>stage2</code> directory has many more files under <code>rustlib</code>: <a href=\"/user_uploads/4715/EOweQNVeidx77xswKvnnp09_/diffoscope_stage2_new_after_stage3_build.tar.gz\">diffoscope_stage2_new_after_stage3_build.tar.gz</a>. I'm guessing this is expected but just wanted to make sure.</p>\n<p>Making the patch discussed above and doing a clean rebuild did not remove the discrepancy between the libraries: <a href=\"/user_uploads/4715/LBvhF7ylhstdokDsM1ez33lp/diffoscope_stage2_3_rlibs_typenum.tar.gz\">diffoscope_stage2_3_rlibs_typenum.tar.gz</a>, and the existence of absolute paths in the final artifacts is much clearer now that I figured out how to tell diffoscope to ignore timestamp differences. (I did not do a full diff between the final rustc driver <code>.so</code>s as that takes over an hour and 20 minutes, so I'm assuming that only the metadata differs as per the last build.)</p>\n<p>Here are the typenum rlibs, rmetas, and d's : <a href=\"/user_uploads/4715/0oeWoIKoPTCCzL-9XGCKA39L/typenum_stage2_driver.tar.gz\">typenum_stage2_driver.tar.gz</a> <a href=\"/user_uploads/4715/DmGwkeP9F1AKWl0wvrM8e5ha/typenum_stage3_driver.tar.gz\">typenum_stage3_driver.tar.gz</a> if you want tarball downloads of all the rmeta files, please ping me and I can provide a download link like last time.</p>",
        "id": 266640109,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641168210
    },
    {
        "content": "<p>Dropping a ping for <span class=\"user-mention\" data-user-id=\"133247\">@bjorn3</span> like last time as I'm assuming you're asleep/away in your time zone</p>",
        "id": 266640184,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641168249
    },
    {
        "content": "<p>I was indeed asleep.</p>",
        "id": 266658605,
        "sender_full_name": "bjorn3",
        "timestamp": 1641195994
    },
    {
        "content": "<p>Which <code>--remap-path-prefix</code> arguments do you use <span class=\"user-mention\" data-user-id=\"438223\">@Ryan Lee</span>?</p>",
        "id": 266658626,
        "sender_full_name": "bjorn3",
        "timestamp": 1641196025
    },
    {
        "content": "<p>I did not use any such arguments, so it used whatever the default was. I see it described in docs as a rustc flag, so would I pass this in the <code>RUSTFLAGS</code> environment variable, or somewhere else?</p>",
        "id": 266720674,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641234692
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/blob/master/config.toml.example#L585-L586\">https://github.com/rust-lang/rust/blob/master/config.toml.example#L585-L586</a></p>",
        "id": 266720831,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1641234787
    },
    {
        "content": "<p>Thanks, missed that earlier, and will see if that makes a difference</p>",
        "id": 266721092,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641234948
    },
    {
        "content": "<p><code>librustc_driver-12f086198d610792.so</code>s of stage2 and stage3 still not the same (and the hash at the end of the filename changed after enabling the <code>remap-debuginfo</code> key in <code>config.toml</code>). I'm currently analyzing what the differences are, and will update here once I do</p>",
        "id": 266729624,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641239549
    },
    {
        "content": "<p><a href=\"https://gist.github.com/rlee287/88d37a8fbff3775757eaf01045a01569\">https://gist.github.com/rlee287/88d37a8fbff3775757eaf01045a01569</a> is a gist tracking what I've tried so far</p>",
        "id": 266729641,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641239568
    },
    {
        "content": "<p>The paths without the option look like <code>/home/rustc_ddc/rust-1.54.0-w-llvm/build/x86_64-unknown-linux-gnu/stage2-rustc/x86_64-unknown-linux-gnu/release/build/typenum-efa46e53f9e34f87/out/op.rs</code>, and the paths with the option look like <code>/rustc/a178d0322ce20e33eac124758e837cbd80a6f633/build/x86_64-unknown-linux-gnu/stage2-rustc/x86_64-unknown-linux-gnu/release/build/typenum-efa46e53f9e34f87/out/op.rs</code>, so I'll leave this option on even though it didn't settle the metadata differences</p>",
        "id": 266731247,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641240510
    },
    {
        "content": "<p>On further thought I'm thinking of trying <code>--remap-path-prefix stage1-rustc=stage#-rustc</code> and <code>--remap-path-prefix stage2-rustc=stage#-rustc</code>; I'll try setting RUSTFLAGS with this and see what happens</p>",
        "id": 266733414,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641241905
    },
    {
        "content": "<p><code>RUSTFLAGS='--remap-path-prefix stage1-rustc=stage#-rustc --remap-path-prefix stage2-rustc=stage#-rustc' python3 x.py build --stage=3</code> had no effect</p>",
        "id": 266740759,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641246659
    },
    {
        "content": "<p>Am I setting the right environment variable? If so I'll try disabling the <code>config.toml</code> remap later and using an actual prefix instead</p>",
        "id": 266740831,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641246719
    },
    {
        "content": "<p>Going to try <code>RUSTFLAGS='--remap-path-prefix /home/rustc_ddc/rust-1.54.0-w-llvm/build/x86_64-unknown-linux-gnu/stage1-rustc/=/home/rustc_ddc/rust-1.54.0-w-llvm/build/x86_64-unknown-linux-gnu/stage#-rustc/ --remap-path-prefix /home/rustc_ddc/rust-1.54.0-w-llvm/build/x86_64-unknown-linux-gnu/stage2-rustc/=/home/rustc_ddc/rust-1.54.0-w-llvm/build/x86_64-unknown-linux-gnu/stage#-rustc/' python3 x.py build</code> without the <code>remap-debuginfo</code> config to see what happens</p>",
        "id": 266746889,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641250874
    },
    {
        "content": "<p>I can finally report success for <code>librustc_driver-&lt;hash&gt;.so</code>, using the long <code>RUSTFLAGS</code> without the <code>remap-debuginfo</code> config change:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ sha256sum stage2/lib/*.so stage3/lib/*.so\n825af767b1805cd99d8f282b4218c48cbf32927acfc9b3bc01bd4d038d3ed28c  stage2/lib/librustc_driver-12f086198d610792.so\n9a9ce71f1f60666f99e3e17d5fcc984523c687405d6a7c952ee65037facd56b4  stage2/lib/libstd-da4419d8945e99df.so\n21ae0cf0e2b469f3eaf32e22d4827f45f526f78357981affb704a0e8167fde9f  stage2/lib/libtest-0720167bfb89cd7c.so\n825af767b1805cd99d8f282b4218c48cbf32927acfc9b3bc01bd4d038d3ed28c  stage3/lib/librustc_driver-12f086198d610792.so\n9a9ce71f1f60666f99e3e17d5fcc984523c687405d6a7c952ee65037facd56b4  stage3/lib/libstd-da4419d8945e99df.so\n21ae0cf0e2b469f3eaf32e22d4827f45f526f78357981affb704a0e8167fde9f  stage3/lib/libtest-0720167bfb89cd7c.so\n</code></pre></div>\n<p><code>stage2/lib/rustlib/x86_64-unknown-linux-gnu/lib</code> has a lot more <code>.rlib</code>s than <code>stage3/lib/rustlib/x86_64-unknown-linux-gnu/lib</code>, but the files inside are identical otherwise, so it looks like I succeeded in getting stage2 to equal stage3. Thanks to <span class=\"user-mention\" data-user-id=\"133247\">@bjorn3</span> and <span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> for the help that you gave me in uncovering the source of the discrepancies initially.</p>\n<p>I'm not going to mark this as resolved until I can reproduce this exact matching in a fresh VM, to ensure that I did not make any settings changes that I forgot to note down. After this, I'm going to start figuring out <code>mrustc</code>'s build process (for the DDC goal which I mentioned at the start of the thread), which I'll ask about in a new thread if I run into issues with that.</p>",
        "id": 266754455,
        "sender_full_name": "Ryan Lee",
        "timestamp": 1641256277
    },
    {
        "content": "<p>awesome!</p>",
        "id": 266778138,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1641282436
    },
    {
        "content": "<p>tbh we should either fix remap-debuginfo or add another config option to add those flags</p>",
        "id": 266778199,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1641282486
    }
]