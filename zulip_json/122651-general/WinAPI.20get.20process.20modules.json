[
    {
        "content": "<p>I'm trying to get modules of a process using bindings from <a href=\"https://docs.rs/winapi/0.3.9/winapi/index.html\">winapi</a> with the following code</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cm\">/* imports */</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"c1\">// Get process handle</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">OpenProcess</span><span class=\"p\">(</span><span class=\"n\">PROCESS_QUERY_INFORMATION</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PROCESS_VM_READ</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">FALSE</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">process_id</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Make array for modules with size of 100</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buffer</span>: <span class=\"p\">[</span><span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">HMODULE</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">std</span>::<span class=\"n\">ptr</span>::<span class=\"n\">null_mut</span>::<span class=\"o\">&lt;</span><span class=\"n\">HMODULE</span><span class=\"o\">&gt;</span><span class=\"p\">();</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">];</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">EnumProcessModules</span><span class=\"p\">(</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">handle</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"o\">*</span><span class=\"n\">buffer</span><span class=\"p\">.</span><span class=\"n\">as_mut_ptr</span><span class=\"p\">(),</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">mem</span>::<span class=\"n\">size_of_val</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">buffer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">u32</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">null_mut</span><span class=\"p\">(),</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Modules: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">.</span><span class=\"n\">to_vec</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Which seems pretty easy to accomplish. <br>\nThe first problem is the first argument of <code>OpenProcess</code>, with desired access of <code>PROCESS_QUERY_INFORMATION | PROCESS_VM_READ</code> produces <code>ERROR_NOACCESS - Invalid access to memory location</code>. <br>\nThe second problem is even if the result of <code>OpenProcess</code> is not <code>NULL</code> then <code>EnumProcessModules</code> fails with <code>ERROR_ACCESS_DENIED - Access is denied.</code></p>\n<p>P.S: I spent more than 4 hours on this problem and have no idea what could be done</p>",
        "id": 254005385,
        "sender_full_name": "Si",
        "timestamp": 1632121154
    },
    {
        "content": "<p>Does <code>buffer.as_mut_ptr()</code> instead of <code>*buffer.as_mut_ptr()</code> work?</p>",
        "id": 254008660,
        "sender_full_name": "bjorn3",
        "timestamp": 1632123204
    },
    {
        "content": "<p>Only if i change <code>let mut buffer: [*mut HMODULE; 100] = [std::ptr::null_mut::&lt;HMODULE&gt;(); 100];</code> to <code>let mut buffer: [HMODULE; 100] = [0 as HMODULE; 100];</code> for example. But this won't fix anything</p>",
        "id": 254009103,
        "sender_full_name": "Si",
        "timestamp": 1632123491
    }
]