[
    {
        "content": "<p>Hi, I have this <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=fcbf4ebabf31e6a08122773b0520118d\">code snippet</a> from a project I'm working on. Maybe a bit contrived and I didn't try too hard to squeeze it down, but the question is regarding the different between closure syntax and method reference syntax at the end of <code>main</code> here. The closure version (<code>.new_closure(&amp;|shim| { shim.the_method(); }</code>) is compiling, and all is fine, but I'm wondering if anyone has some clue to why the compiler has a problem with lifetimes when I use method-reference syntax (<code>.new_closure(&amp;FooShim::the_method)</code>).</p>",
        "id": 256296447,
        "sender_full_name": "Audun Halland",
        "timestamp": 1633458987
    },
    {
        "content": "<p>I was kind of hoping for the two to be somewhat equivalent :)</p>",
        "id": 256299139,
        "sender_full_name": "Audun Halland",
        "timestamp": 1633460050
    },
    {
        "content": "<p>Thats curious, even removing the un-needed reference to the <code>Fn</code> type causes the same problem: <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=d4a78ebe49997b435a53bf67d338ef8a\">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=d4a78ebe49997b435a53bf67d338ef8a</a></p>\n<p>I wonder if this is a rustc bug, or if I don't understand the lifetimes</p>",
        "id": 256300258,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633460469
    },
    {
        "content": "<p>I also wonder if I can get the same result without any GATs</p>",
        "id": 256303090,
        "sender_full_name": "Audun Halland",
        "timestamp": 1633461543
    },
    {
        "content": "<p>I'll try for a bit.</p>",
        "id": 256303179,
        "sender_full_name": "Audun Halland",
        "timestamp": 1633461584
    },
    {
        "content": "<p>Also I wonder if there's any syntax I can use to convince the compiler to accept the method reference syntax, because I really, _really_ want it <span aria-label=\"grimacing\" class=\"emoji emoji-1f62c\" role=\"img\" title=\"grimacing\">:grimacing:</span></p>",
        "id": 256303885,
        "sender_full_name": "Audun Halland",
        "timestamp": 1633461877
    },
    {
        "content": "<p>If the associated type <code>Shim</code> is not generic, I get no lifetime problems.</p>",
        "id": 256307347,
        "sender_full_name": "Audun Halland",
        "timestamp": 1633463292
    },
    {
        "content": "<p>Much smaller example: <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=0c872d9c651c77d48d3a3534e369779c\">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2018&amp;gist=0c872d9c651c77d48d3a3534e369779c</a></p>",
        "id": 256309387,
        "sender_full_name": "Audun Halland",
        "timestamp": 1633464102
    },
    {
        "content": "<p>Filed a bug: <a href=\"https://github.com/rust-lang/rust/issues/89573\">#89573</a></p>",
        "id": 256314159,
        "sender_full_name": "Audun Halland",
        "timestamp": 1633465837
    },
    {
        "content": "<p>This is \"expected\" (albeit perhaps surprising) behavior: <a href=\"https://github.com/rust-lang/rust/issues/89573#issuecomment-937770435\">https://github.com/rust-lang/rust/issues/89573#issuecomment-937770435</a></p>",
        "id": 256574057,
        "sender_full_name": "Daniel Henry-Mantilla",
        "timestamp": 1633612110
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232957\">Jack Huey</span> has marked this topic as resolved.</p>",
        "id": 256582426,
        "sender_full_name": "Notification Bot",
        "timestamp": 1633615398
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232957\">Jack Huey</span> has marked this topic as resolved.</p>",
        "id": 256582431,
        "sender_full_name": "Notification Bot",
        "timestamp": 1633615399
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232957\">Jack Huey</span> has marked this topic as unresolved.</p>",
        "id": 256582439,
        "sender_full_name": "Notification Bot",
        "timestamp": 1633615406
    },
    {
        "content": "<p>Whoops</p>",
        "id": 256582461,
        "sender_full_name": "Jack Huey",
        "timestamp": 1633615415
    },
    {
        "content": "<p>Anyways, I looked a bit at the issue yesterday and basically was thinking that this doesn't look like a GAT specific issue</p>",
        "id": 256591658,
        "sender_full_name": "Jack Huey",
        "timestamp": 1633618673
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"232018\">@Daniel Henry-Mantilla</span> for the reduction</p>",
        "id": 256591723,
        "sender_full_name": "Jack Huey",
        "timestamp": 1633618685
    },
    {
        "content": "<p>I think the issue can stay open. Probably as a diagnostic issue, maybe</p>",
        "id": 256591930,
        "sender_full_name": "Jack Huey",
        "timestamp": 1633618758
    },
    {
        "content": "<p>Added an example with a function instead of a closure.</p>",
        "id": 256592454,
        "sender_full_name": "Gary Guo",
        "timestamp": 1633618898
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232018\">@Daniel Henry-Mantilla</span> your comment is one of the best Ive ever seen in rust-lang/rust! When I was trying to fix <span class=\"user-mention\" data-user-id=\"294358\">@Audun Halland</span>'s code, I didn't think to be able to control the <code>self</code> reference lifetime independently of the parameter of the type, like <code>this: &amp;Bar&lt;'_&gt;</code>, very cool!</p>\n<p><span class=\"user-mention\" data-user-id=\"303710\">@Gary Guo</span> am I correct in my understanding that in</p>\n<div class=\"codehilite\"><pre><span></span><code>fn hello_shim&lt;&#39;s&gt;(v: &amp;Bar&lt;&#39;s&gt;) {\n    v.hello();\n}\n</code></pre></div>\n<p>the elided lifetime of the reference and <code>'s</code>, and at least the elided lifetime is late-bound (actually, it appears both are: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=cceb0af3a2e6af424d3d3547583b29d8\">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=cceb0af3a2e6af424d3d3547583b29d8</a>)? is that just a product of how fn's are different than impl blocks?</p>",
        "id": 256758286,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633707372
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"257428\">@Gus Wynn</span> it's a matter of where the lifetime parameter for <code>Bar</code> is introduced: when it's introduced at a function (or closure) level, and when it has not \"lifetime lower bounds\", then the lifetime parameter is free by the time we are referring to the function, and thus the function gets to feature a higher-order / universal-over-that-lifetime-parameter-at-least signature.</p>\n<p>In the case of an impl over <code>Bar&lt;'_&gt;</code>, the lifetime parameter for that <code>Bar&lt;'_&gt;</code> (whether it has been elided or not) is thus introduced <em>before</em> the associated items \"even exist\", we could say: <code>Bar::hello</code> only makes sense when <code>Bar</code> is an actual type, <em>i.e.</em>, when it has been given a lifetime parameter (which is inferred at call site). Now, this doesn't necessarily have to affect the signature of <code>Bar::hello</code>; but the outer lifetime parameter does {in,af}fect <code>Self</code>, and so will only affect the signature of the associated function if/when it does mention <code>Self</code> (or when it does explicitly mention that outer lifetime param, of course). In the case of methods, <em>i.e.</em>, associated functions whose first parameter is the <code>self</code> receiver (or borrow of it), we do have that <code>Self</code> type appearing amongst the type of that first function argument. So, for <em>each fixed choice of the outer lifetime parameter</em> (choice made at each call-site often by inference), there is a specific / fixed <code>hello</code> associated function which use that fixed outer lifetime parameter: its signature won't be higher-order (over that lifetime).</p>",
        "id": 256760085,
        "sender_full_name": "Daniel Henry-Mantilla",
        "timestamp": 1633708102
    },
    {
        "content": "<p>This is fascinating, I'm not sure I understand what <code>Late</code> meant in the region code in rustc before this</p>\n<p>for \"So, for each fixed choice of the outer lifetime parameter (choice made at each call-site often by inference), there is a specific / fixed hello associated function which use that fixed outer lifetime parameter: its signature won't be higher-order (over that lifetime).\" are we talking about the <code>'_</code> in <code>Bar&lt;'_&gt;</code>?</p>",
        "id": 256768683,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633711523
    },
    {
        "content": "<p>Yes, because that lifetime parameter, when referring to associated items, is introduced in the <code>impl</code> block \"outer\" level:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"o\">&lt;'</span><span class=\"na\">outer</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Bar</span><span class=\"o\">&lt;'</span><span class=\"na\">outer</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"c1\">// &lt;- these parameters don't get to be higher-order</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">assoc_func</span><span class=\"o\">&lt;'</span><span class=\"na\">inner</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"c1\">// &lt;- this one does (which is why it can't be turbofished)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Bar</span>::<span class=\"o\">&lt;'</span><span class=\"na\">fixed_outer</span><span class=\"o\">&gt;</span>::<span class=\"n\">assoc_func</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 256769371,
        "sender_full_name": "Daniel Henry-Mantilla",
        "timestamp": 1633711816
    },
    {
        "content": "<p>\"But I'd say that that's just the syntax hiding stuff under the rug.\" definitely!</p>\n<p>We should write this conversation down someone more permanent than zulip!</p>",
        "id": 256784176,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633717722
    },
    {
        "content": "<p>also, the fact that <code>.map_err(anyhow::Error::msg)</code> is such a common pattern, but works, is because <code>msg</code> is a static method on Error, v interesting</p>",
        "id": 256784269,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633717760
    },
    {
        "content": "<p>\"I'd say that introducing a higher-order lifetime parameter that the closure's body can then pick is kind of similar in that it allows some invisible mechanics to kick in (#IsThisC++)\" ripp</p>",
        "id": 256784422,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633717809
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232018\">@Daniel Henry-Mantilla</span> when are you going to admit it and just join the language team? <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span></p>",
        "id": 256793077,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1633721377
    },
    {
        "content": "<p>:3 I am humbled by the idea, very much <span aria-label=\"smiling face\" class=\"emoji emoji-263a\" role=\"img\" title=\"smiling face\">:smiling_face:</span> But I wouldn't event know where to start / what to do <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> nah my thing is trying to explain stuff, favoring rigor / a consistent full picture to simplicity / \"beginner-friendly-ness\" (which regarding the lang stuff, seems to go at odds with the sentiment that Rust ought to be made simpler (I, for instance, like <code>ref {mut,}</code> very much; I'd also prefer to see full move references over specific unsized values (such as <code>unsized_fn_params</code>), <em>etc.</em>); all of which could be another practical argument against my being in any lang team <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span>).</p>\n<p>Some day, though, I'll try to find the motivation and time to go and write full guides / books on some Rust topics (full guide on lifetimes, full guide on macros (and maybe a detailed guide about unsafe-misconceptions))</p>\n<p><a href=\"/user_uploads/4715/n85apjJ_mz4fyLe1DQB8FUnh/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/n85apjJ_mz4fyLe1DQB8FUnh/image.png\" title=\"image.png\"><img src=\"/user_uploads/4715/n85apjJ_mz4fyLe1DQB8FUnh/image.png\"></a></div>",
        "id": 256856672,
        "sender_full_name": "Daniel Henry-Mantilla",
        "timestamp": 1633772781
    },
    {
        "content": "<p>I also like to explain stuff, but I didn't know anything about Late-bound-regions!</p>",
        "id": 257080675,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1633966298
    }
]