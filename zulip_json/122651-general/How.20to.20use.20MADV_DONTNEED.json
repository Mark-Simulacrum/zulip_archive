[
    {
        "content": "<p>Hi, all</p>\n<p>I've encountered high memory usage(looks like \"memory leak\") in production environment(container in k8s), and want to check if it's because of the \"MADV_FREE\" behaviour.</p>\n<p>Is there a way to change to use MADV_DONTNEED instead of MADV_FREE in rust?</p>\n<p>Thanks!</p>",
        "id": 266145705,
        "sender_full_name": "Pure White",
        "timestamp": 1640580100
    },
    {
        "content": "<p>Are you explicitly setting a global allocator in Rust? If not, then it should be using the system allocator</p>",
        "id": 266145763,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1640580181
    },
    {
        "content": "<p>in which case it's probably either an \"ordinary\" memory leak (some code isn't dropping a Vec/Box/Arc/etc), or just the system allocator deciding not to release memory back (independent of Rust)</p>",
        "id": 266145826,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1640580277
    },
    {
        "content": "<p>Thanks for your reply!</p>\n<p>I've tried multiple allocators, including the system allocator, mimalloc and jemallocator, though their growing curves are different(mimalloc &gt; system allocator &gt; jemallocator), they all results in a memory continuously growing and caused OOM(in containers with memory limit) in the end.</p>",
        "id": 266145904,
        "sender_full_name": "Pure White",
        "timestamp": 1640580460
    },
    {
        "content": "<p>That sounds like it's something specific to your application</p>",
        "id": 266146058,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1640580705
    },
    {
        "content": "<p>I've tried to use asan, and asan didn't report any error. I've also reviewed code with my colleagues several times, and we didn't find anything which may lead to memory leak.</p>\n<p>I've used Go before and this problem is very much similar to the problem in Go when Go defaults to use MADV_FREE.</p>",
        "id": 266146068,
        "sender_full_name": "Pure White",
        "timestamp": 1640580715
    },
    {
        "content": "<p>It's possible that the memory is getting correctly freed on shutdown, so asan is missing it</p>",
        "id": 266146131,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1640580790
    },
    {
        "content": "<p>I would recommend using a heap profiler like heaptrack: <a href=\"https://github.com/KDE/heaptrack\">https://github.com/KDE/heaptrack</a></p>",
        "id": 266146147,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1640580814
    },
    {
        "content": "<p>So I want to ask the allocator to use MADV_DONTNEED instead of MADV_FREE to check if it's cause by MADV_FREE.</p>",
        "id": 266146152,
        "sender_full_name": "Pure White",
        "timestamp": 1640580833
    },
    {
        "content": "<p>Thanks! I'll try it!</p>",
        "id": 266146157,
        "sender_full_name": "Pure White",
        "timestamp": 1640580841
    },
    {
        "content": "<p>I'm not sure if there's a way to do that - if there is, I think it would be the same way as a C program would do it</p>",
        "id": 266146201,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1640580887
    },
    {
        "content": "<p>If you're hitting an OOM, then I strongly suspect that MADV_FREE isn't the problem - the kernel should be reclaiming those pages before triggering an OOM</p>",
        "id": 266146278,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1640581070
    },
    {
        "content": "<p>Allocators have some tuning functions where you can tell them to retain more or less memory instead of immediately returning it to the OS. But considering that you already tried multiple allocators it's unlikely to be that.</p>",
        "id": 266147278,
        "sender_full_name": "The 8472",
        "timestamp": 1640582452
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125294\">Aaron Hill</span> <a href=\"#narrow/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED/near/266146278\">said</a>:</p>\n<blockquote>\n<p>If you're hitting an OOM, then I strongly suspect that MADV_FREE isn't the problem - the kernel should be reclaiming those pages before triggering an OOM</p>\n</blockquote>\n<p>No, because it's in container, containers will not reclaiming those pages.</p>",
        "id": 266148608,
        "sender_full_name": "Pure White",
        "timestamp": 1640584593
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"445531\">Pure White</span> <a href=\"#narrow/stream/122651-general/topic/How.20to.20use.20MADV_DONTNEED/near/266146152\">said</a>:</p>\n<blockquote>\n<p>So I want to ask the allocator to use MADV_DONTNEED instead of MADV_FREE to check if it's cause by MADV_FREE.</p>\n</blockquote>\n<p>glibc's malloc does this automatically if the system is in <code>vm.overcommit_memory=2</code> mode.</p>",
        "id": 266155576,
        "sender_full_name": "Florian Weimer",
        "timestamp": 1640593539
    },
    {
        "content": "<p>you could check with <code>strace -e brk,mmap,munmap,madvise</code> which calls are getting used</p>",
        "id": 266169508,
        "sender_full_name": "The 8472",
        "timestamp": 1640608746
    },
    {
        "content": "<p>Kernel is usually able to reclaim pages from a container as long as you donâ€™t set memory.low or memory.min (or if your usage is above those limits). It would be unusual for your container to have those set.</p>",
        "id": 266295219,
        "sender_full_name": "Daniel Xu",
        "timestamp": 1640728005
    }
]