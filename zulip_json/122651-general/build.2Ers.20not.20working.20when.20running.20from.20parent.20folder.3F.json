[
    {
        "content": "<p>I'm not sure if this the right place to ask this, but... I'm writing a small library for working with PDF files, and I need support for DEFLATE compression. I decided to write my own bindings for libdeflate: <a href=\"https://github.com/ebiggers/libdeflate\">https://github.com/ebiggers/libdeflate</a>, and I put them in a <code>deflate-sys</code> crate, like so:</p>\n<div class=\"codehilite\"><pre><span></span><code>pdf-rs/\n    src/\n    Cargo.toml\n    deflate-sys/\n        ...\n        build.rs\n        third-party/libdeflate/\n</code></pre></div>\n<p>I keep libdeflate source code in the <code>third-party</code> folder, and expect it to be built and in that folder before running <code>cargo build</code>. Then, when running <code>cargo build</code> in the <code>deflate-sys</code> folder, everything works fine... but not when I try to build <code>pdf-rs</code>, when depending on <code>deflate-sys</code>. I instead get an error</p>\n<div class=\"codehilite\"><pre><span></span><code>error: could not find native static library `deflate`, perhaps an -L flag is missing?\n\nerror: could not compile `deflate-sys` due to previous error\nwarning: build failed, waiting for other jobs to finish...\nerror: build failed\n</code></pre></div>\n<p>This is how the <code>build.rs</code> file looks like in the <code>deflate-sys</code> folder</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"cargo:rustc-link-lib=static=deflate\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"cargo:rustc-link-search=./third-party/libdeflate\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I'm not really sure what is going on?</p>",
        "id": 254184975,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632220100
    },
    {
        "content": "<p>Just for the reference, these are the cargo and rustc versions I'm using</p>\n<div class=\"codehilite\"><pre><span></span><code>~/d/pdf-rs$ cargo --version\ncargo 1.56.0-nightly (18751dd3f 2021-09-01)\n~/d/pdf-rs$ rustc --version\nrustc 1.57.0-nightly (97032a6df 2021-09-08)\n</code></pre></div>",
        "id": 254185048,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632220162
    },
    {
        "content": "<p>(Obviously, changing <code>rustc-link-search</code> to <code>./deflate-sys/third-party/libdeflate</code> works when compiling from <code>pdf-rs</code> folder. But that's not really useful, since then I can't test the <code>deflate-sys</code> library alone.)</p>",
        "id": 254185839,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632220660
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 254193890,
        "sender_full_name": "bjorn3",
        "timestamp": 1632225213
    },
    {
        "content": "<ol>\n<li>I think you should use an absolute path.</li>\n<li>It is advised to build the library within <a href=\"http://build.rs\">build.rs</a>. You need to build it in the location pointed to by the OUT_DIR env var. If you do it in the source directory cargo will refuse to upload it to <a href=\"http://crates.io\">crates.io</a> if you want to do this.</li>\n<li>There is already the flate2 crate you can use. It can use zlib or by default a pure-rust implementation.</li>\n</ol>",
        "id": 254194559,
        "sender_full_name": "bjorn3",
        "timestamp": 1632225579
    },
    {
        "content": "<blockquote>\n<ol>\n<li>I think you should use an absolute path.</li>\n</ol>\n</blockquote>\n<p>I'm not really sure I understand what you mean, do you mean path like <code>/home/aodhnait/dev/pdf-rs/deflate-sys/third-party/libdeflate</code>? But then what if someone wanted to use it, they would have to change that path...</p>\n<blockquote>\n<ol start=\"2\">\n<li>It is advised to build the library within <a href=\"http://build.rs\">build.rs</a>. You need to build it in the location pointed to by the OUT_DIR env var. If you do it in the source directory cargo will refuse to upload it to <a href=\"http://crates.io\">crates.io</a> if you want to do this.</li>\n</ol>\n</blockquote>\n<p>I wanted to avoid making the crate build process depend on the build system of libdeflate. I also wasn't really planning to publish it to <a href=\"http://crates.io\">crates.io</a>, the idea being that if someone (on the very slim chance) wanted to use it, they would just clone it and adjust the path to it in their <code>Cargo.toml</code>.</p>\n<blockquote>\n<ol start=\"3\">\n<li>There is already the flate2 crate you can use. It can use zlib or by default a pure-rust implementation.</li>\n</ol>\n</blockquote>\n<p>I don't want to use any dependencies, and libdeflate is much faster than zlib, that's why I wanted to write bindings to it (I also distrust turning my code into node_modules mess.)</p>",
        "id": 254206391,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632230873
    },
    {
        "content": "<p>Published <code>libdeflate</code> bindings would be pretty nice though.</p>",
        "id": 254206622,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632230960
    },
    {
        "content": "<ol>\n<li>Yes. You can take the absolute path of the current working directory inside <a href=\"http://build.rs\">build.rs</a> instead of hard-coding it.</li>\n</ol>",
        "id": 254206643,
        "sender_full_name": "bjorn3",
        "timestamp": 1632230973
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"203546\">Laurențiu</span> <a href=\"#narrow/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F/near/254206622\">said</a>:</p>\n<blockquote>\n<p>Published <code>libdeflate</code> bindings would be pretty nice though.</p>\n</blockquote>\n<p>There's already libdeflater which does that: <a href=\"https://github.com/adamkewley/libdeflater\">https://github.com/adamkewley/libdeflater</a>.</p>",
        "id": 254206779,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632231008
    },
    {
        "content": "<p>And there seems to be the libdeflate-sys crate with raw libdeflate bindings.</p>",
        "id": 254206926,
        "sender_full_name": "bjorn3",
        "timestamp": 1632231069
    },
    {
        "content": "<p>And generally you don't have to interact much with the build system of the native library, see <a href=\"https://github.com/adamkewley/libdeflater/blob/master/libdeflate-sys/build.rs\">https://github.com/adamkewley/libdeflater/blob/master/libdeflate-sys/build.rs</a>.</p>",
        "id": 254207144,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632231145
    },
    {
        "content": "<blockquote>\n<ol>\n<li>Yes. You can take the absolute path of the current working directory inside <a href=\"http://build.rs\">build.rs</a> instead of hard-coding it.</li>\n</ol>\n</blockquote>\n<p>Does cargo expose any environmental variable for that?</p>",
        "id": 254207224,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632231186
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"203546\">Laurențiu</span> <a href=\"#narrow/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F/near/254207144\">said</a>:</p>\n<blockquote>\n<p>And generally you don't have to interact much with the build system of the native library, see <a href=\"https://github.com/adamkewley/libdeflater/blob/master/libdeflate-sys/build.rs\">https://github.com/adamkewley/libdeflater/blob/master/libdeflate-sys/build.rs</a>.</p>\n</blockquote>\n<p>That means that if libdeflate adds new source files, I have to update the <a href=\"http://build.rs\">build.rs</a> script, which is what I wanted to avoid. I just want to expect that there is <code>libdeflate.a</code> in the <code>third-party/libdeflate</code> directory, regardless of where it came from, whether user built it themselves, copied it from somewhere, it's a symlink, whatever.</p>",
        "id": 254207568,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632231343
    },
    {
        "content": "<p>Yeah, but your <code>-sys</code> crate would be building (or linking to) one specific version anyway. Of course, it's fine if you don't plan to publish it, but as a <code>-sys</code> crate user, I would very much prefer not having to manually build anything.</p>",
        "id": 254207936,
        "sender_full_name": "Laurențiu",
        "timestamp": 1632231491
    },
    {
        "content": "<blockquote>\n<p>Does cargo expose any environmental variable for that?</p>\n</blockquote>\n<p>Found it! It's <code>CARGO_MANIFEST_DIR</code>, and using it in <code>build.rs</code> makes it work properly now, yay!</p>",
        "id": 254208099,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632231563
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"203546\">Laurențiu</span> <a href=\"#narrow/stream/122651-general/topic/build.2Ers.20not.20working.20when.20running.20from.20parent.20folder.3F/near/254207936\">said</a>:</p>\n<blockquote>\n<p>Yeah, but your <code>-sys</code> crate would be building (or linking to) one specific version anyway. Of course, it's fine if you don't plan to publish it, but as a <code>-sys</code> crate user, I would very much prefer not having to manually build anything.</p>\n</blockquote>\n<p>Yeah, understandable, I wasn't really planning on publishing it anyway... I have a very specific vision in mind, and can't really express it properly in words.</p>",
        "id": 254208450,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632231706
    },
    {
        "content": "<p>Now my only question is why do I need to use <code>CARGO_MANIFEST_DIR</code> in the first place? Shouldn't relative path work just as fine, considering that (presumably) cargo just copies the entire crate? Then relative paths should still point to the same thing, shouldn't they?</p>",
        "id": 254208681,
        "sender_full_name": "aodhneine [she/her]",
        "timestamp": 1632231802
    },
    {
        "content": "<p>The path is relative to the current working directory of the rustc invocation that calls the linker as it cargo passes it verbatim to rustc and cargo doesn't resolve relative paths AFAIK. In this case the current working directory of the linking rustc is pdf-rs, so rustc will look in pdf-rs/third-party/libdeflate.</p>",
        "id": 254209386,
        "sender_full_name": "bjorn3",
        "timestamp": 1632232087
    }
]