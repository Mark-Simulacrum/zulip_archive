[
    {
        "content": "<p>Turns out sync::mpsc has a ptr-int transmute somewhere that Miri failed to detect since I screwed up the check for that (fixed in <a href=\"https://github.com/rust-lang/rust/pull/95340\">https://github.com/rust-lang/rust/pull/95340</a>):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">Undefined</span><span class=\"w\"> </span><span class=\"n\">Behavior</span>: <span class=\"nc\">type</span><span class=\"w\"> </span><span class=\"n\">validation</span><span class=\"w\"> </span><span class=\"n\">failed</span>: <span class=\"nc\">encountered</span><span class=\"w\"> </span><span class=\"n\">pointer</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mh\">0x2afc8</span><span class=\"p\">[</span><span class=\"n\">alloc1995</span><span class=\"p\">]</span><span class=\"o\">&lt;</span><span class=\"n\">untagged</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">initialized</span><span class=\"w\"> </span><span class=\"n\">plain</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">non</span><span class=\"o\">-</span><span class=\"n\">pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">-</span>-&gt; <span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">r</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">/</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">sync</span><span class=\"o\">/</span><span class=\"n\">mpsc</span><span class=\"o\">/</span><span class=\"n\">blocking</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">54</span>:<span class=\"mi\">9</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"n\">mem</span>::<span class=\"n\">transmute</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">inner</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">         </span><span class=\"o\">^^^^^^^^^^^^^^^^^^^^^^^^^^</span><span class=\"w\"> </span><span class=\"k\">type</span> <span class=\"nc\">validation</span><span class=\"w\"> </span><span class=\"n\">failed</span>: <span class=\"nc\">encountered</span><span class=\"w\"> </span><span class=\"n\">pointer</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mh\">0x2afc8</span><span class=\"p\">[</span><span class=\"n\">alloc1995</span><span class=\"p\">]</span><span class=\"o\">&lt;</span><span class=\"n\">untagged</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">expected</span><span class=\"w\"> </span><span class=\"n\">initialized</span><span class=\"w\"> </span><span class=\"n\">plain</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">non</span><span class=\"o\">-</span><span class=\"n\">pointer</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">help</span>: <span class=\"nc\">this</span><span class=\"w\"> </span><span class=\"n\">indicates</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">bug</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">program</span>: <span class=\"nc\">it</span><span class=\"w\"> </span><span class=\"n\">performed</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">operation</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">caused</span><span class=\"w\"> </span><span class=\"n\">Undefined</span><span class=\"w\"> </span><span class=\"n\">Behavior</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">help</span>: <span class=\"nc\">see</span><span class=\"w\"> </span><span class=\"n\">https</span>:<span class=\"c1\">//doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information</span>\n\n<span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">inside</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">std</span>::<span class=\"n\">sync</span>::<span class=\"n\">mpsc</span>::<span class=\"n\">blocking</span>::<span class=\"n\">SignalToken</span>::<span class=\"n\">cast_to_usize</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">r</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">/</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">sync</span><span class=\"o\">/</span><span class=\"n\">mpsc</span><span class=\"o\">/</span><span class=\"n\">blocking</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">54</span>:<span class=\"mi\">9</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">inside</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">std</span>::<span class=\"n\">sync</span>::<span class=\"n\">mpsc</span>::<span class=\"n\">oneshot</span>::<span class=\"n\">Packet</span>::<span class=\"o\">&lt;</span><span class=\"kt\">i32</span><span class=\"o\">&gt;</span>::<span class=\"n\">recv</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">r</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">/</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">sync</span><span class=\"o\">/</span><span class=\"n\">mpsc</span><span class=\"o\">/</span><span class=\"n\">oneshot</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">129</span>:<span class=\"mi\">32</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">inside</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">std</span>::<span class=\"n\">sync</span>::<span class=\"n\">mpsc</span>::<span class=\"n\">Receiver</span>::<span class=\"o\">&lt;</span><span class=\"kt\">i32</span><span class=\"o\">&gt;</span>::<span class=\"n\">recv</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">r</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">/</span><span class=\"n\">library</span><span class=\"o\">/</span><span class=\"n\">std</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">sync</span><span class=\"o\">/</span><span class=\"n\">mpsc</span><span class=\"o\">/</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">1161</span>:<span class=\"mi\">49</span><span class=\"w\"></span>\n<span class=\"n\">note</span>: <span class=\"nc\">inside</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">simple_send</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"o\">-</span><span class=\"n\">pass</span><span class=\"o\">/</span><span class=\"n\">concurrency</span><span class=\"o\">/</span><span class=\"n\">channels</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">15</span>:<span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">tests</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"o\">-</span><span class=\"n\">pass</span><span class=\"o\">/</span><span class=\"n\">concurrency</span><span class=\"o\">/</span><span class=\"n\">channels</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">15</span>:<span class=\"mi\">16</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"mi\">15</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">rx</span><span class=\"p\">.</span><span class=\"n\">recv</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">                </span><span class=\"o\">^^^^^^^^^</span><span class=\"w\"></span>\n<span class=\"n\">note</span>: <span class=\"nc\">inside</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">main</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"o\">-</span><span class=\"n\">pass</span><span class=\"o\">/</span><span class=\"n\">concurrency</span><span class=\"o\">/</span><span class=\"n\">channels</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">54</span>:<span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">tests</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"o\">-</span><span class=\"n\">pass</span><span class=\"o\">/</span><span class=\"n\">concurrency</span><span class=\"o\">/</span><span class=\"n\">channels</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">54</span>:<span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"mi\">54</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">simple_send</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"o\">^^^^^^^^^^^^^</span><span class=\"w\"></span>\n</code></pre></div>\n<p><span class=\"user-mention\" data-user-id=\"120827\">@Ben Kimock (Saethlin)</span> FWIW this also means such transmutes would be missed during your Miri runs so far</p>",
        "id": 276739538,
        "sender_full_name": "RalfJ",
        "timestamp": 1648319936
    },
    {
        "content": "<p>Very interesting</p>",
        "id": 276739553,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1648319959
    },
    {
        "content": "<p>the comments are very honest about what they are doing though ;)<br>\n<a href=\"https://github.com/rust-lang/rust/blob/828d4ace4dee856b376fa44cc095d490ee799c30/library/std/src/sync/mpsc/blocking.rs#L54\">https://github.com/rust-lang/rust/blob/828d4ace4dee856b376fa44cc095d490ee799c30/library/std/src/sync/mpsc/blocking.rs#L54</a></p>",
        "id": 276739575,
        "sender_full_name": "RalfJ",
        "timestamp": 1648319999
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"137587\">@Gankra</span> ah you are going to love this, this 'casts' an <code>Arc</code> to <code>usize</code> via <code>transmute</code> <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span></p>",
        "id": 276739643,
        "sender_full_name": "RalfJ",
        "timestamp": 1648320053
    },
    {
        "content": "<p><em>WHY</em></p>",
        "id": 276739667,
        "sender_full_name": "Gankra",
        "timestamp": 1648320115
    },
    {
        "content": "<p>There's a PR to replace this module with crossbeam, so I'm much more interested in what transmutes I will find elsewhere</p>",
        "id": 276739712,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1648320135
    },
    {
        "content": "<p>they just don't want the into_raw weird offset semantic??</p>",
        "id": 276739713,
        "sender_full_name": "Gankra",
        "timestamp": 1648320136
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"137587\">Gankra</span> <a href=\"#narrow/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc/near/276739713\">said</a>:</p>\n<blockquote>\n<p>they just don't want the into_raw weird offset semantic??</p>\n</blockquote>\n<p>this is OLD code. maybe into_raw didnt exist yet...</p>",
        "id": 276739903,
        "sender_full_name": "RalfJ",
        "timestamp": 1648320441
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120827\">Ben Kimock (Saethlin)</span> <a href=\"#narrow/stream/269128-miri/topic/ptr-int.20transmute.20in.20sync.3A.3Ampsc/near/276739712\">said</a>:</p>\n<blockquote>\n<p>There's a PR to replace this module with crossbeam, so I'm much more interested in what transmutes I will find elsewhere</p>\n</blockquote>\n<p>ah fair. we'll have to wait until my PR lands for that I guess.</p>",
        "id": 276739912,
        "sender_full_name": "RalfJ",
        "timestamp": 1648320481
    },
    {
        "content": "<p>Ah, here's where I heard about this problem before.</p>\n<p>This is breaking a lot of crates test suites. I think a lot of concurrency crates use <code>std::sync::mpsc</code> to test themselves.</p>\n<p>I want to fix this but so far my attempts are going poorly. All I've managed to do is deadlock the stage1 compiler.</p>",
        "id": 277656946,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1649014491
    },
    {
        "content": "<p>Never mind, I'm a dumdum</p>",
        "id": 277657954,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1649015846
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/pull/95621\">https://github.com/rust-lang/rust/pull/95621</a></p>",
        "id": 277658052,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1649015993
    },
    {
        "content": "<p>oh nice :)</p>",
        "id": 277658952,
        "sender_full_name": "RalfJ",
        "timestamp": 1649017184
    },
    {
        "content": "<p>Oh great this is now starting to block other projects</p>",
        "id": 278384677,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1649474487
    },
    {
        "content": "<p><code>crossbeam</code>'s CI is broken now:<br>\n<a href=\"https://github.com/crossbeam-rs/crossbeam/pull/811#issuecomment-1092879060\">https://github.com/crossbeam-rs/crossbeam/pull/811#issuecomment-1092879060</a></p>",
        "id": 278384679,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1649474511
    }
]