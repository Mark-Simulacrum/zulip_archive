[
    {
        "content": "<p><a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=262e0d299bdd4b8e38ac25faaa0b8887\">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=262e0d299bdd4b8e38ac25faaa0b8887</a></p>\n<p>I've explored some of the ideas brought up in the RFC, and found a few new parts of the design. Simplifying it like this has helped find some nice names too!</p>",
        "id": 271006259,
        "sender_full_name": "Plecra",
        "timestamp": 1644252198
    },
    {
        "content": "<p>Most importantly, this gives a strong answer to the questions about language features: <strong>yes</strong>, language additions could absolutely help improve this API</p>",
        "id": 271006504,
        "sender_full_name": "Plecra",
        "timestamp": 1644252314
    },
    {
        "content": "<p>And specifically, what we're doing can actually be cleanly simplified into an <code>AnyWithLifetime&lt;'a&gt;</code> trait. If we can pack the complexity into that (a perfect implementation needs full <code>feature(specialization)</code>), <code>Demand</code> can become a fairly tidy usage of this more general API</p>",
        "id": 271006766,
        "sender_full_name": "Plecra",
        "timestamp": 1644252418
    },
    {
        "content": "<p>Note that <code>Erased</code>/<code>Resolve</code> are mostly analogous to <code>TypeTag</code> from the current design. By making it a reflexive implementation, the implementations are (hopefully) correct by construction: the trait bounds ensure they're well behaved.<br>\nThe compiler could easily implement it as an autotrait in most cases, though we ought to consider cases where types want to use <code>'static</code> instead, and you could imagine a case like:</p>\n<div class=\"codehilite\"><pre><span></span><code>pub trait Borrows&lt;&#39;a&gt; {\n    fn provide&lt;&#39;b&gt;(&amp;&#39;b self, demand: &amp;mut Demand&lt;???&gt;) {}\n}\nimpl&lt;&#39;a&gt; dyn Borrows&lt;&#39;a&gt; {\n    /// A `T` could contain a &amp;&#39;a str, which could outlive the &amp;&#39;b self borrow\n    pub fn get&lt;&#39;b, T: LivesFor&lt;&#39;b&gt; + HasLongerBorrow&lt;&#39;a&gt;&gt;(&amp;&#39;b self) -&gt; Option&lt;T&gt;;\n}\n</code></pre></div>",
        "id": 271008012,
        "sender_full_name": "Plecra",
        "timestamp": 1644252961
    },
    {
        "content": "<p>It's hard to tell how useful this would be... it should also be possible to use <code>T: LivesFor&lt;'a&gt;</code> in a second method</p>",
        "id": 271008427,
        "sender_full_name": "Plecra",
        "timestamp": 1644253154
    },
    {
        "content": "<p>I have a sense it falls into the same bucket as <a href=\"#narrow/stream/257204-project-error-handling/topic/provide_any.20with.20Send.2FSync/near/268028735\">https://rust-lang.zulipchat.com/#narrow/stream/257204-project-error-handling/topic/provide_any.20with.20Send.2FSync/near/268028735</a></p>",
        "id": 271008518,
        "sender_full_name": "Plecra",
        "timestamp": 1644253200
    },
    {
        "content": "<p>(as a note: we could technically support as many lifetimes as we like by passing <code>(&amp;'a ()) | (&amp;'a (), &amp;'b ()) | (&amp;'a (), &amp;'b (), &amp;'c ())</code> to a <code>Resolve&lt;Lifetimes&gt;</code>. that's awfully ugly though)</p>",
        "id": 271009008,
        "sender_full_name": "Plecra",
        "timestamp": 1644253362
    },
    {
        "content": "<p>This is all beside the point though :D Just fun ideas. The conclusion is that our API could look more like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">mod</span> <span class=\"nn\">any</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"c1\">// autotrait. We can reintroduce `LivesFor&lt;'a&gt;` as `any::EraseLifetime`if we want to let users extend the behaviour</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">AnyUnowned</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span>: <span class=\"o\">'</span><span class=\"na\">a</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">fn</span> <span class=\"nf\">erased_type_id</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">TypeId</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">impl</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">AnyUnowned</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">downcast</span><span class=\"o\">&lt;</span><span class=\"n\">T</span>: <span class=\"nc\">AnyUnowned</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Option</span><span class=\"o\">&lt;&amp;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span> <span class=\"nc\">Demand</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">impl</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">Demand</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">make</span><span class=\"o\">&lt;</span><span class=\"n\">T</span>: <span class=\"nc\">AnyUnowned</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"n\">fulfill</span>: <span class=\"nc\">impl</span><span class=\"w\"> </span><span class=\"nb\">FnOnce</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">provide</span><span class=\"o\">&lt;</span><span class=\"n\">T</span>: <span class=\"nc\">AnyUnowned</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fulfill</span>: <span class=\"nc\">impl</span><span class=\"w\"> </span><span class=\"nb\">FnOnce</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">T</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">mod</span> <span class=\"nn\">error</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">Error</span>: <span class=\"nc\">fmt</span>::<span class=\"n\">Debug</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">fn</span> <span class=\"nf\">provide_context</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;'</span><span class=\"na\">a</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">any</span>::<span class=\"n\">Demand</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"sd\">/// Request typed context for the Error. This is used for extra details that</span>\n<span class=\"w\">        </span><span class=\"sd\">/// can be surfaced to the user, like [`std::backtrace::Backtrace`].</span>\n<span class=\"w\">        </span><span class=\"sd\">/// Implementors of [`Error`] should provide their context types in</span>\n<span class=\"w\">        </span><span class=\"sd\">/// [`Error::provide_context`]</span>\n<span class=\"w\">        </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">get_context</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">T</span>: <span class=\"nc\">crate</span>::<span class=\"n\">any</span>::<span class=\"n\">AnyUnowned</span><span class=\"o\">&lt;'</span><span class=\"na\">a</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;'</span><span class=\"na\">a</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">any</span>::<span class=\"n\">Demand</span>::<span class=\"n\">make</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">demand</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">provide_context</span><span class=\"p\">(</span><span class=\"n\">demand</span><span class=\"p\">))</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 271013617,
        "sender_full_name": "Plecra",
        "timestamp": 1644255322
    },
    {
        "content": "<p>Hi! Thanks for these! It's late here (I'm in London) and I've just finished a round of meetings so I haven't had a chance to read through it, but I look forward to doing that tomorrow and then I'll get back to you :-)</p>",
        "id": 271020432,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1644257979
    },
    {
        "content": "<p><span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span></p>",
        "id": 271021704,
        "sender_full_name": "Plecra",
        "timestamp": 1644258521
    },
    {
        "content": "<p>The concept of this makes sense, and I'd love to leave the door open for such a design in the future. This kind of approach is part of why, on the RFC thread, I proposed hiding this behind simpler <code>provide_mut</code> and <code>provide_ref</code> and <code>provide_value</code> interfaces, and not including any of the TypeTag bits in the public API. I'm hoping that leaves room in the future to modify the design, whether along the lines of what's in this thread, or something else.</p>",
        "id": 271033072,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1644263643
    },
    {
        "content": "<p>The problem with not supporting generic code is that it will force users to write unnecessary unsafe code. Newtyping a <code>&amp;str</code> with a more specific type (as <code>Suggestion</code> is doing in the current code) is a fairly normal usage of this api, and if we only allow references to static types, uses would be forced to write the <code>unsafe { &amp;*(&amp;s as *const str as *const Suggestion) }</code> conversion themselves. Especially with the more towards encouraging forbid(unsafe_code), that's bound to cause friction</p>",
        "id": 271277985,
        "sender_full_name": "Plecra",
        "timestamp": 1644414077
    },
    {
        "content": "<p>Also I do agree to an extent - keeping the API surface small enough to expand upon is a good goal, and allows us to get the feature available sooner. Even so, <code>provide_{mut, ref}</code> don't really help us do that - if we choose to use that design, it'd be just as easy to implement the <code>LivesFor&lt;'a&gt;</code> trait for <code>&amp;'a T</code> and <code>&amp;'a mut T</code> and release it like that. The implementations could be expanded later</p>",
        "id": 271278521,
        "sender_full_name": "Plecra",
        "timestamp": 1644414209
    },
    {
        "content": "<p>I'm confused; I had the impression that the <code>provide_*</code> APIs were still generic, and worked just fine with newtypes.</p>",
        "id": 271296702,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1644421294
    },
    {
        "content": "<p>Nah, check it out: <a href=\"https://github.com/nrc/provide-any/blob/dfff4e26f8f21842a7dcc19fc6a544f14bf4b18b/src/provide_any.rs#L141\">https://github.com/nrc/provide-any/blob/dfff4e26f8f21842a7dcc19fc6a544f14bf4b18b/src/provide_any.rs#L141</a></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">provide_ref</span><span class=\"o\">&lt;</span><span class=\"n\">T</span>: <span class=\"o\">?</span><span class=\"nb\">Sized</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"nb\">static</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span>: <span class=\"kp\">&amp;</span><span class=\"o\">'</span><span class=\"na\">a</span> <span class=\"nc\">T</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">;</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 271320665,
        "sender_full_name": "Plecra",
        "timestamp": 1644429492
    },
    {
        "content": "<p>That's specifically an implementation for references, no generics involved.</p>",
        "id": 271320793,
        "sender_full_name": "Plecra",
        "timestamp": 1644429540
    },
    {
        "content": "<p><code>T</code> is generic, though.</p>",
        "id": 271321558,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1644429765
    },
    {
        "content": "<p>And AFAICT you could still explicitly <code>provide_value</code> a newtype around a <code>&amp;'static str</code>.</p>",
        "id": 271321694,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1644429822
    },
    {
        "content": "<p>Hmmm. I wonder if there's any reason we couldn't have a version of <code>provide_ref</code> that allows borrowing from self rather than 'static?</p>",
        "id": 271321931,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1644429889
    },
    {
        "content": "<p>The point is that we want to newtype <code>&amp;'a str</code>, not <code>&amp;'static str</code></p>",
        "id": 271322613,
        "sender_full_name": "Plecra",
        "timestamp": 1644430116
    },
    {
        "content": "<p>And yes, there are ways to do that :P That's what this design does</p>",
        "id": 271322697,
        "sender_full_name": "Plecra",
        "timestamp": 1644430144
    },
    {
        "content": "<p>And when you make the API generic like that, the distinction between _ref and _mut becomes meaningless. Which is why were left only needing <code>provide</code></p>",
        "id": 271322806,
        "sender_full_name": "Plecra",
        "timestamp": 1644430192
    },
    {
        "content": "<p>note that <code>provide_ref</code> <em>does</em> borrow from self: <code>value: &amp;'a T</code>. It just can't borrow a generic struct from self.</p>",
        "id": 271322989,
        "sender_full_name": "Plecra",
        "timestamp": 1644430246
    },
    {
        "content": "<p>There are a few ways to implement that generic borrow, and I made this thread to talk about adding language support so that we don't have to use a hacky solution :)</p>",
        "id": 271323073,
        "sender_full_name": "Plecra",
        "timestamp": 1644430280
    },
    {
        "content": "<p><span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> for considering lang solutions, to be clear.</p>",
        "id": 271330802,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1644433506
    },
    {
        "content": "<p>But it does seem like it <em>might</em> be possible to handle a newtype, if the generic for provide_ref is something like <code>T: ... + 'a</code>.</p>",
        "id": 271330907,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1644433555
    }
]