[
    {
        "content": "<p>I want to create a new clippy lint. I was following the guides in the repo, but when I execute <code>TESTNAME=my_new_list cargo uitest</code>, I get the following error: </p>\n<div class=\"codehilite\"><pre><span></span><code>...\nwarning: `clippy_lints` (lib) generated 2 warnings\n    Finished test [unoptimized + debuginfo] target(s) in 0.03s\n     Running tests/compile-test.rs (target/debug/deps/compile_test-5f00544648835871)\n\nrunning 1 test\ntest compile_test ... FAILED\n\nfailures:\n\n---- compile_test stdout ----\nthread &#39;compile_test&#39; panicked at &#39;dependencies not found in depinfo: [&quot;clippy_utils&quot;, &quot;derive_new&quot;, &quot;if_chain&quot;, &quot;itertools&quot;, &quot;quote&quot;, &quot;regex&quot;, &quot;serde&quot;, &quot;serde_derive&quot;, &quot;syn&quot;]&#39;, tests/compile-test.rs:94:9\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n\n\nfailures:\n    compile_test\n\ntest result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s\n\nerror: test failed, to rerun pass &#39;--test compile-test&#39;\n</code></pre></div>\n<p>any ideas how to fix this?</p>",
        "id": 254398408,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1632328961
    },
    {
        "content": "<p>The new lint that you just created does not compile when you run the test</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;compile_test&#39; panicked at &#39;dependencies not found in depinfo: [&quot;clippy_utils&quot;, &quot;derive_new&quot;, &quot;if_chain&quot;, &quot;itertools&quot;, &quot;quote&quot;, &quot;regex&quot;, &quot;serde&quot;, &quot;serde_derive&quot;, &quot;syn&quot;]&#39;, tests/compile-test.rs:94:9\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n</code></pre></div>",
        "id": 254469681,
        "sender_full_name": "dswijj",
        "timestamp": 1632363299
    },
    {
        "content": "<p>I guess the output of the test is indeed a bit too much, but you can always go and look at the clean ouput of the failed test from <code>target/debug/test_build_base/{lint_name}.stage_id.*</code></p>",
        "id": 254469960,
        "sender_full_name": "dswijj",
        "timestamp": 1632363490
    },
    {
        "content": "<p>I don't quite get it... I see warnings about unused imports in the new lint, so it should be compiled, right?</p>",
        "id": 254485049,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1632376753
    },
    {
        "content": "<p>Hmm, I've just checked and <code>cargo uitest</code> fails for me even without any changes to the repo, ie with a fresh <code>git clone</code></p>",
        "id": 254485089,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1632376795
    },
    {
        "content": "<p><code>cargo test</code> doesn't work either (error is the same)</p>",
        "id": 254486486,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1632377782
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust-clippy/blob/master/doc/basics.md\">https://github.com/rust-lang/rust-clippy/blob/master/doc/basics.md</a> doesn't mention any setup besides the git clone so I'm confused</p>",
        "id": 254486810,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1632378049
    },
    {
        "content": "<p>yeah basically you don't need to setup extra stuff. Are you on Linux?</p>",
        "id": 254488359,
        "sender_full_name": "ThibsG",
        "timestamp": 1632379266
    },
    {
        "content": "<p>yes, I'm on linux</p>",
        "id": 254488454,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1632379338
    },
    {
        "content": "<p>do you have more information with <code>RUST_BACKTRACE=1</code>?</p>",
        "id": 254488919,
        "sender_full_name": "ThibsG",
        "timestamp": 1632379644
    },
    {
        "content": "<p>There is the backtrace:</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;compile_test&#39; panicked at &#39;dependencies not found in depinfo: [&quot;clippy_utils&quot;, &quot;derive_new&quot;, &quot;if_chain&quot;, &quot;itertools&quot;, &quot;quote&quot;, &quot;regex&quot;, &quot;serde&quot;, &quot;serde_derive&quot;, &quot;syn&quot;]&#39;, tests/compile-test.rs:94:9\nstack backtrace:\n   0: rust_begin_unwind\n             at /rustc/fdf65053e99e8966f9bd83b5a8491326cb33d638/library/std/src/panicking.rs:517:5\n   1: std::panicking::begin_panic_fmt\n             at /rustc/fdf65053e99e8966f9bd83b5a8491326cb33d638/library/std/src/panicking.rs:460:5\n   2: compile_test::extern_flags\n             at ./tests/compile-test.rs:94:9\n   3: compile_test::default_config\n             at ./tests/compile-test.rs:128:9\n   4: compile_test::compile_test\n             at ./tests/compile-test.rs:309:22\n   5: compile_test::compile_test::{{closure}}\n             at ./tests/compile-test.rs:307:1\n   6: core::ops::function::FnOnce::call_once\n             at /rustc/fdf65053e99e8966f9bd83b5a8491326cb33d638/library/core/src/ops/function.rs:227:5\n   7: core::ops::function::FnOnce::call_once\n             at /rustc/fdf65053e99e8966f9bd83b5a8491326cb33d638/library/core/src/ops/function.rs:227:5\n</code></pre></div>",
        "id": 254489034,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1632379713
    },
    {
        "content": "<p>Does <code>cargo build</code> run well?</p>",
        "id": 254489095,
        "sender_full_name": "ThibsG",
        "timestamp": 1632379779
    },
    {
        "content": "<p>It does</p>",
        "id": 254490931,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1632380950
    },
    {
        "content": "<p>There where some changes to UI test dependencies in <a href=\"https://github.com/rust-lang/rust-clippy/issues/7631\">rust-clippy#7631</a>. I'm not sure if this is related tough.<br>\n<span class=\"user-mention\" data-user-id=\"360405\">@Cameron Steffen</span> could this maybe be a result of these changes? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 254493147,
        "sender_full_name": "xFrednet",
        "timestamp": 1632382245
    },
    {
        "content": "<p>I cloned a fresh master, and it works like a charm by my side</p>",
        "id": 254494524,
        "sender_full_name": "ThibsG",
        "timestamp": 1632383033
    },
    {
        "content": "<p>Turns out it was coused by </p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[target.x86_64-unknown-linux-gnu]</span>\n<span class=\"n\">rustflags</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s\">\"-C\"</span><span class=\"p\">,</span> <span class=\"s\">\"link-arg=-fuse-ld=lld\"</span><span class=\"p\">]</span>\n</code></pre></div>\n<p>In my <code>~/.cargo/config</code></p>",
        "id": 254495336,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1632383425
    },
    {
        "content": "<p>The cargo config in the project doesn't override/amend that? Wonder if that's fixable... Or if we can at least detect the scenario.</p>",
        "id": 254527233,
        "sender_full_name": "Cameron Steffen",
        "timestamp": 1632400651
    },
    {
        "content": "<p>Why does using a different linker change the location of the dependencies? Or is it that the linker args for some reason don't apply when the UI tests are run? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 254552159,
        "sender_full_name": "flip1995",
        "timestamp": 1632409923
    },
    {
        "content": "<p>I think it is overriding <a href=\"https://github.com/rust-lang/rust-clippy/blob/ef2e2f0a0c61ac29986ac1cee5c06406783a89a2/.cargo/config#L9\">our rustflags</a></p>",
        "id": 254556468,
        "sender_full_name": "Cameron Steffen",
        "timestamp": 1632411586
    },
    {
        "content": "<p>So I think we can detect the problem by reading CARGO_BUILD_RUSTFLAGS. Maybe even at compile time?</p>",
        "id": 254556985,
        "sender_full_name": "Cameron Steffen",
        "timestamp": 1632411761
    },
    {
        "content": "<p>According to the <a href=\"https://doc.rust-lang.org/cargo/reference/config.html#hierarchical-structure\"><code>.cargo/config</code></a> documentation, the <code>rustflags</code> should get merged together. But I guess they don't get merged, because the <code>rustflags</code> in the <code>$HOME</code> config is under the <code>target.</code> key and our <code>rustflags</code> is under the <code>build</code> key. I guess the behavior in this case is not really defined? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 254557477,
        "sender_full_name": "flip1995",
        "timestamp": 1632411957
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/cargo/issues/5376\">https://github.com/rust-lang/cargo/issues/5376</a></p>",
        "id": 254557905,
        "sender_full_name": "Cameron Steffen",
        "timestamp": 1632412107
    },
    {
        "content": "<p>looks like rustflags is an exception</p>",
        "id": 254558011,
        "sender_full_name": "Cameron Steffen",
        "timestamp": 1632412168
    },
    {
        "content": "<p>Yeah. The funny thing is that Mara also complained about this 40 minutes ago <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 254558906,
        "sender_full_name": "flip1995",
        "timestamp": 1632412498
    },
    {
        "content": "<p>I improved the error message <a href=\"https://github.com/rust-lang/rust-clippy/pull/7711\">https://github.com/rust-lang/rust-clippy/pull/7711</a></p>",
        "id": 254580330,
        "sender_full_name": "Cameron Steffen",
        "timestamp": 1632421060
    }
]