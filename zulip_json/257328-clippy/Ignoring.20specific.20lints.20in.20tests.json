[
    {
        "content": "<p>Is there an easy way to enable a lint, but only for non-test code? I would like to enable  the <code>print_stdout</code> and <code>dbg_macro</code> lints to catch stray debug statements but still allow those to be used in tests (that is: <code>cfg(test)</code>). I realize that I can add an <code>allow</code> for each test module, but I was looking for something that would apply across the entire crate.</p>",
        "id": 262372838,
        "sender_full_name": "Jesse Szwedko",
        "timestamp": 1637612627
    },
    {
        "content": "<p>I think you can use <code>tcx.sess.parse_sess.config.contains_key(sym::test)</code></p>",
        "id": 262373608,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1637613060
    },
    {
        "content": "<p>I would have expected <code>#![cfg_attr(not(test), warn(clippy::print_stdout, clippy::dbg_macro))]</code> to work. But testing it out myself, it doesn't. It seems like Clippy lints are run on tests by default, but no other lints or errors are emitted. See <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=30f793f842c8e86b2d0595790489b7bc\">Playground</a>, see the different behavior whe using \"Test\", \"Build\", and \"Clippy\".</p>",
        "id": 262374038,
        "sender_full_name": "flip1995",
        "timestamp": 1637613308
    },
    {
        "content": "<p>oh oh I thought Jesse was modifying clippy</p>",
        "id": 262374262,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1637613421
    },
    {
        "content": "<p>I wonder if it makes sense to make those two lints have a different default for test modules than for other modules?</p>",
        "id": 262374301,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1637613443
    },
    {
        "content": "<p>I wouldn't say so. stdout output in tests is suppressed by default IIRC and dbg! macro usage in tests also seems a bit of a edge case to me.</p>",
        "id": 262374458,
        "sender_full_name": "flip1995",
        "timestamp": 1637613503
    },
    {
        "content": "<p>Thanks for the thoughts! And yeah, I could see having these specific lints (perhaps along with <code>print_stderr</code>) not apply to tests. Is there precedent for that for other lints?</p>",
        "id": 262383977,
        "sender_full_name": "Jesse Szwedko",
        "timestamp": 1637618716
    },
    {
        "content": "<p>We often have <code>println</code> and <code>dbg</code> in tests to provide additional context if the test fails. By default it is suppressed if the test passes, but output if it fails.</p>",
        "id": 262384368,
        "sender_full_name": "Jesse Szwedko",
        "timestamp": 1637618903
    },
    {
        "content": "<p>To run clippy on tests, you can use <code>--tests</code> (or <code>--all-targets</code>).</p>",
        "id": 262449655,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1637671193
    },
    {
        "content": "<p>Yeah, but for some reason Clippy runs on tests by default. I haven't really looked into that yet though. But it also happens with clippy-driver, so it probably is Clippy's fault and not something cargo does.</p>",
        "id": 262450602,
        "sender_full_name": "flip1995",
        "timestamp": 1637671791
    },
    {
        "content": "<p>When you say \"runs on tests\", do you just mean any function with a <code>#[test]</code> attribute? Because those are still compiled normally unless you add <code>#[cfg(test)]</code> somewhere</p>",
        "id": 262451043,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1637672046
    },
    {
        "content": "<p>So it doesn't seem like a bug that clippy looks at them</p>",
        "id": 262451064,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1637672063
    },
    {
        "content": "<p>See this <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=30f793f842c8e86b2d0595790489b7bc\">Playground</a> link. Even though the module is marked with <code>cfg(test)</code>, Clippy runs on the functions inside the module. But even if there are compile errors or things rustc lints should complain about, only Clippy lints are triggered inside the <code>cfg(test)</code> module.</p>",
        "id": 262451229,
        "sender_full_name": "flip1995",
        "timestamp": 1637672169
    },
    {
        "content": "<p>Oh interesting, yeah that does seem strange. I would expect that module to get stripped altogether before clippy even sees it</p>",
        "id": 262453955,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1637673662
    },
    {
        "content": "<p>Yes, <code>cfg</code> attributes should be resolved before Clippy actually runs. ....unless those lints are pre-expansion passes. Let me check that.</p>",
        "id": 262454702,
        "sender_full_name": "flip1995",
        "timestamp": 1637674003
    },
    {
        "content": "<p>Yes, they are. So the fix is to not have them as pre-expansion passes. Which we want to do anyway. But linting on macro usage is hard when they are already expended. And we don't want to add more code that matches the exact expansion of the macro...</p>",
        "id": 262455033,
        "sender_full_name": "flip1995",
        "timestamp": 1637674166
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"452655\">@Jesse Szwedko</span> So  <code>#![cfg_attr(not(test), warn(clippy::lints))]</code> should work in general. But sadly for the exact two lints you asked about, it doesn't work.</p>",
        "id": 262457336,
        "sender_full_name": "flip1995",
        "timestamp": 1637675280
    },
    {
        "content": "<blockquote>\n<p>And we don't want to add more code that matches the exact expansion of the macro...</p>\n</blockquote>\n<p>I'm getting close to a general solution for this.</p>",
        "id": 262464271,
        "sender_full_name": "Cameron Steffen",
        "timestamp": 1637678479
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"264664\">flip1995</span> <a href=\"#narrow/stream/257328-clippy/topic/Ignoring.20specific.20lints.20in.20tests/near/262457336\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"452655\">Jesse Szwedko</span> So  <code>#![cfg_attr(not(test), warn(clippy::lints))]</code> should work in general. But sadly for the exact two lints you asked about, it doesn't work.</p>\n</blockquote>\n<p>Ah, gotcha, yeah I see. Well, it's good to know how to do this for other lints at least :)</p>\n<p><a href=\"https://github.com/vectordotdev/vector/pull/10125\">https://github.com/vectordotdev/vector/pull/10125</a> is what I ended up with after adding these new restriction lints. Allowing for the places where we do actually want to print was a bit messy since I couldn't put the attribute directly on the macro and instead had to wrap the println macros with their own blocks and add the attribute there. It seemed worth the trade-off to me though as we accidentally left a stray debug println in our last release.</p>\n<p>Thanks for the discussion all!</p>",
        "id": 262473405,
        "sender_full_name": "Jesse Szwedko",
        "timestamp": 1637682391
    }
]