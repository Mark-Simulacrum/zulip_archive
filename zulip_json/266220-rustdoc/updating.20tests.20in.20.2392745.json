[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"316352\">@pierwill</span> let's move the discussion about the tests to Zulip. It'll be easier to discuss here.</p>",
        "id": 267917177,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642101580
    },
    {
        "content": "<p>You're very close, you only have 2 tests left to be updated</p>",
        "id": 267917270,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642101613
    },
    {
        "content": "<p>One just needs its IDs updated:</p>\n<div class=\"codehilite\"><pre><span></span><code>39: @has check failed\n1832\n    `XPATH PATTERN` did not match\n1833\n    // @has foo/struct.Foo.html &#39;//div[@id=&quot;impl-Foo&quot;]/h3[@class=&quot;code-header in-band&quot;]&#39; &#39;impl&lt;const M: usize&gt; Foo&lt;M&gt; where u8: Trait&lt;M&gt;&#39;\n1834\n50: @has check failed\n1835\n    `XPATH PATTERN` did not match\n1836\n    // @has foo/struct.Bar.html &#39;//div[@id=&quot;impl-Bar&quot;]/h3[@class=&quot;code-header in-band&quot;]&#39; &#39;impl&lt;const M: usize&gt; Bar&lt;u8, M&gt;&#39;\n1837\n\n1838\nEncountered 2 errors\n1839\n</code></pre></div>",
        "id": 267917297,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642101629
    },
    {
        "content": "<p>(I think just <code>impl-Foo</code> to <code>impl-Foo&lt;M&gt;</code> etc.)</p>",
        "id": 267917374,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642101665
    },
    {
        "content": "<p>The other one I think just needs its quotes fixed:</p>\n<div class=\"codehilite\"><pre><span></span><code>KeyError: (&#39;.//div[@id=&quot;impl-Escape&lt;r#&quot;&lt;script&gt;alert(&quot;Escape&quot;)%3B&lt;/script&gt;&quot;#&gt;&quot;]/h3[@class=&quot;code-header in-band&quot;]&#39;,)\n1797\n</code></pre></div>",
        "id": 267917425,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642101693
    },
    {
        "content": "<p>Notice how you have <code>[@id=\"</code> but then <code>r#\"</code>; the quotes within the ID are messing with the quotes enclosing the ID</p>",
        "id": 267917604,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642101771
    },
    {
        "content": "<p>So I think you just need to escape the <code>\"</code> inside the ID with <code>\\\"</code>. If that doesn't work, we'll try to come up with a different solution</p>",
        "id": 267917664,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642101804
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"315412\">@jsha</span> as well</p>",
        "id": 267917680,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642101810
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"307537\">@Noah Lev</span> Thanks for the help! Those two suggestions aren't working, tho: <a href=\"https://github.com/rust-lang/rust/pull/92745/commits/d5d98a27c2fac7816b7e5a620cddaf5cc2c240be\">https://github.com/rust-lang/rust/pull/92745/commits/d5d98a27c2fac7816b7e5a620cddaf5cc2c240be</a></p>",
        "id": 267920892,
        "sender_full_name": "pierwill",
        "timestamp": 1642103376
    },
    {
        "content": "<p>Maybe i'll try this again: <a href=\"https://github.com/rust-lang/rust/pull/92745/commits/d5d98a27c2fac7816b7e5a620cddaf5cc2c240be#r782702781\">https://github.com/rust-lang/rust/pull/92745/commits/d5d98a27c2fac7816b7e5a620cddaf5cc2c240be#r782702781</a></p>",
        "id": 267920933,
        "sender_full_name": "pierwill",
        "timestamp": 1642103401
    },
    {
        "content": "<p>BTW, just making sure you know about a couple of tricks to shorten the debug cycle:</p>\n<ul>\n<li>You can run a single test with <code>./x.py test src/test/rustdoc/const-generics/const-generics-docs.rs</code></li>\n<li>The built HTML for a given test case is in build/x86_64-unknown-linux-gnu/test/rustdoc/const-generics/const-generics-docs/ (but I assume you know this since you mentioned copy-pasting from the HTML)</li>\n</ul>",
        "id": 267921231,
        "sender_full_name": "jsha",
        "timestamp": 1642103521
    },
    {
        "content": "<p>Also, I haven't used this, but there's an XPath evaluator in JS that might enable you to try out different expressions faster: <a href=\"https://developer.mozilla.org/en-US/docs/Web/XPath/Introduction_to_using_XPath_in_JavaScript\">https://developer.mozilla.org/en-US/docs/Web/XPath/Introduction_to_using_XPath_in_JavaScript</a></p>\n<p>Though note that our tests use a bit of a custom XPath library that might not be exactly like other systems.</p>",
        "id": 267921367,
        "sender_full_name": "jsha",
        "timestamp": 1642103570
    },
    {
        "content": "<p>why oh why can't this test show the expected and actual output?</p>",
        "id": 267921579,
        "sender_full_name": "pierwill",
        "timestamp": 1642103670
    },
    {
        "content": "<p>Yeah, I know it's frustrating :(</p>",
        "id": 267922097,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642103965
    },
    {
        "content": "<p>This difficulty in updating tests is part of why I added <a href=\"https://github.com/rust-lang/rust/blob/256721ee519f6ff15dc5c1cfaf3ebf9af75efa4a/src/etc/htmldocck.py#L97-L105\">snapshot tests</a> to rustdoc, but I don't know if they'd work for this purpose</p>",
        "id": 267922292,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642104030
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"316352\">@pierwill</span> can you post the relevant parts of the HTML for both tests that you're having trouble with?</p>",
        "id": 267922436,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642104090
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307537\">Noah Lev</span> <a href=\"#narrow/stream/266220-rustdoc/topic/updating.20tests.20in.20.2392745/near/267922436\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"316352\">pierwill</span> can you post the relevant parts of the HTML for both tests that you're having trouble with?</p>\n</blockquote>\n<p>this is probably all my fault... I've just been grabbing it from the url bar at the top of the browser after clicking... i'll go in and inspect the actual source....</p>",
        "id": 267922567,
        "sender_full_name": "pierwill",
        "timestamp": 1642104140
    },
    {
        "content": "<p>okay only one failing now!</p>",
        "id": 267922901,
        "sender_full_name": "pierwill",
        "timestamp": 1642104269
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/pMVLxh-GYTmhX-S1KZBbBrrp/Screen-Shot-2022-01-13-at-2.06.32-PM.png\">Screen-Shot-2022-01-13-at-2.06.32-PM.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/pMVLxh-GYTmhX-S1KZBbBrrp/Screen-Shot-2022-01-13-at-2.06.32-PM.png\" title=\"Screen-Shot-2022-01-13-at-2.06.32-PM.png\"><img src=\"/user_uploads/4715/pMVLxh-GYTmhX-S1KZBbBrrp/Screen-Shot-2022-01-13-at-2.06.32-PM.png\"></a></div><p><code>#impl-Escape%3Cr#%22%3Cscript%3Ealert(%22Escape%22)%3B%3C/script%3E%22#%3E</code></p>",
        "id": 267923239,
        "sender_full_name": "pierwill",
        "timestamp": 1642104431
    },
    {
        "content": "<p>it's still not happy tho...</p>",
        "id": 267923270,
        "sender_full_name": "pierwill",
        "timestamp": 1642104448
    },
    {
        "content": "<p>ah!</p>",
        "id": 267923438,
        "sender_full_name": "pierwill",
        "timestamp": 1642104506
    },
    {
        "content": "<p>FWIW, the version you see in Dev Tools in your browser is transformed in subtle ways. That may not always matter, but if you want to look at the exact thing the tests are operating on, you should open the HTML source - either with View Source, or opening it in your favorite editor.</p>",
        "id": 267923534,
        "sender_full_name": "jsha",
        "timestamp": 1642104551
    },
    {
        "content": "<p>Feel free to post any errors :)</p>",
        "id": 267923553,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642104566
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315412\">jsha</span> <a href=\"#narrow/stream/266220-rustdoc/topic/updating.20tests.20in.20.2392745/near/267923534\">said</a>:</p>\n<blockquote>\n<p>FWIW, the version you see in Dev Tools in your browser is transformed in subtle ways. That may not always matter, but if you want to look at the exact thing the tests are operating on, you should open the HTML source - either with View Source, or opening it in your favorite editor.</p>\n</blockquote>\n<p>Interesting, I didn't know that!</p>",
        "id": 267923578,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642104581
    },
    {
        "content": "<p>passing <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> </p>\n<p>now there's more test suites, right lol</p>",
        "id": 267923677,
        "sender_full_name": "pierwill",
        "timestamp": 1642104615
    },
    {
        "content": "<p>That's the main one though <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 267923735,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642104647
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>stdoc-gui (12 concurrently) ...\n........F. (10/57)\n......F... (20/57)\nF......... (30/57)\n..F....... (40/57)\n.......... (50/57)\n.......    (57/57)\n\n\n/Users/user/repos/rust/src/test/rustdoc-gui/anchors.goml anchors... FAILED\n[ERROR] (line 31) Error: No node found for selector: #impl: for command `move-cursor-to: &quot;#impl&quot;`\n\n/Users/user/repos/rust/src/test/rustdoc-gui/headings.goml headings... FAILED\n[ERROR] (line 37) &quot;#impl &gt; h3.code-header&quot; not found: for command `assert-css: (&quot;#impl &gt; h3.code-header&quot;, {&quot;font-size&quot;: &quot;17.6px&quot;})`\n\n/Users/user/repos/rust/src/test/rustdoc-gui/headers-color.goml headers-color... FAILED\n[ERROR] (line 27) &quot;#impl&quot; not found: for command `assert-css: (\n    &quot;#impl&quot;,\n    {&quot;color&quot;: &quot;rgb(197, 197, 197)&quot;, &quot;background-color&quot;: &quot;rgba(255, 236, 164, 0.06)&quot;},\n)`\n\n/Users/user/repos/rust/src/test/rustdoc-gui/search-filter.goml search-filter... FAILED\n[ERROR] (line 17) assert didn&#39;t fail: for command `assert-false: &quot;#results .externcrate&quot;`\n\n\n\ncommand did not execute successfully: &quot;/usr/local/bin/node&quot; &quot;/Users/user/repos/rust/src/tools/rustdoc-gui/tester.js&quot; &quot;--jobs&quot; &quot;12&quot; &quot;--doc-folder&quot; &quot;/Users/user/repos/rust/build/x86_64-apple-darwin/test/rustdoc-gui/doc&quot; &quot;--tests-folder&quot; &quot;/Users/user/repos/rust/src/test/rustdoc-gui&quot;\nexpected success, got: exit status: 1\n\n\nBuild completed unsuccessfully in 0:00:34\n</code></pre></div>",
        "id": 267923811,
        "sender_full_name": "pierwill",
        "timestamp": 1642104692
    },
    {
        "content": "<p>Yeah, basically, you need to update the same things <code>impl</code> -&gt; <code>impl-...-for-...</code> or <code>impl-...</code></p>",
        "id": 267923854,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642104718
    },
    {
        "content": "<p>And this one? </p>\n<div class=\"codehilite\"><pre><span></span><code>Users/user/repos/rust/src/test/rustdoc-gui/search-filter.goml search-filter... FAILED\n[ERROR] (line 17) assert didn&#39;t fail: for command `assert-false: &quot;#results .externcrate&quot;`\n</code></pre></div>",
        "id": 267923950,
        "sender_full_name": "pierwill",
        "timestamp": 1642104760
    },
    {
        "content": "<p>If you change the DOM, pretty much all tests fail yes ^^'</p>",
        "id": 267923969,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1642104768
    },
    {
        "content": "<p>DOM?</p>",
        "id": 267923979,
        "sender_full_name": "pierwill",
        "timestamp": 1642104777
    },
    {
        "content": "<p>HTML</p>",
        "id": 267923989,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1642104783
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"316352\">pierwill</span> <a href=\"#narrow/stream/266220-rustdoc/topic/updating.20tests.20in.20.2392745/near/267923950\">said</a>:</p>\n<blockquote>\n<p>And this one? </p>\n<p><div class=\"codehilite\"><pre><span></span><code>Users/user/repos/rust/src/test/rustdoc-gui/search-filter.goml search-filter... FAILED\n[ERROR] (line 17) assert didn&#39;t fail: for command `assert-false: &quot;#results .externcrate&quot;`\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Um... no clue</p>",
        "id": 267924328,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642104974
    },
    {
        "content": "<p>Maybe leave that one as-is for now and we'll come back to it <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 267924342,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642104984
    },
    {
        "content": "<p>To be more exact, DOM is how we call the structure of your HTML document</p>",
        "id": 267924343,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1642104984
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"307537\">Noah Lev</span> <a href=\"#narrow/stream/266220-rustdoc/topic/updating.20tests.20in.20.2392745/near/267924328\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"316352\">pierwill</span> <a href=\"#narrow/stream/266220-rustdoc/topic/updating.20tests.20in.20.2392745/near/267923950\">said</a>:</p>\n<blockquote>\n<p>And this one? </p>\n<p><div class=\"codehilite\"><pre><span></span><code>Users/user/repos/rust/src/test/rustdoc-gui/search-filter.goml search-filter... FAILED\n[ERROR] (line 17) assert didn&#39;t fail: for command `assert-false: &quot;#results .externcrate&quot;`\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Um... no clue</p>\n</blockquote>\n<p>It means that the command was supposed to fail and didn't haha</p>",
        "id": 267924375,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1642105003
    },
    {
        "content": "<p>let me check what it checks</p>",
        "id": 267924390,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1642105013
    },
    {
        "content": "<p>In my changes, I removed some code from implIds about <code>is_foreign_type</code> or something like that... maybe that has to do with this externcrate test?</p>",
        "id": 267924402,
        "sender_full_name": "pierwill",
        "timestamp": 1642105018
    },
    {
        "content": "<p>foreign types are different</p>",
        "id": 267924428,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642105037
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"210316\">GuillaumeGomez</span> <a href=\"#narrow/stream/266220-rustdoc/topic/updating.20tests.20in.20.2392745/near/267924343\">said</a>:</p>\n<blockquote>\n<p>To be more exact, DOM is how we call the structure of your HTML document</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"316352\">@pierwill</span> <a href=\"https://en.wikipedia.org/wiki/Document_Object_Model\">https://en.wikipedia.org/wiki/Document_Object_Model</a></p>",
        "id": 267924447,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642105048
    },
    {
        "content": "<p>So, the test which fails is checking that the search results doesn't contain something. In your case, this something is showing up (which is very surprising), meaning the filter isn't working?</p>",
        "id": 267924563,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1642105105
    },
    {
        "content": "<p>Right - if we want to get really precise, HTML is the raw bytes, and when the browser loads them into a page, that becomes the DOM - which can be manipulated by JS.</p>\n<p>That's the main way in which the Dev Tools view is different - it represents the DOM, which is after parsing and after any JS manipulations.</p>",
        "id": 267924574,
        "sender_full_name": "jsha",
        "timestamp": 1642105110
    },
    {
        "content": "<p>How do I find the HTML for these <code>goml</code> tests? <a href=\"https://github.com/pierwill/rust/blob/4575f5fc7a12fb883c0fba18e039d04f1bc57b76/src/test/rustdoc-gui/anchors.goml#L31\">https://github.com/pierwill/rust/blob/4575f5fc7a12fb883c0fba18e039d04f1bc57b76/src/test/rustdoc-gui/anchors.goml#L31</a></p>",
        "id": 267925013,
        "sender_full_name": "pierwill",
        "timestamp": 1642105354
    },
    {
        "content": "<p>it's generated in <code>build/[arch]/tests/rustdoc-gui</code></p>",
        "id": 267925115,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1642105409
    },
    {
        "content": "<p>In this case, <code>goto</code> is in the <code>test_docs</code> crate, so <code>test_docs/index.html</code></p>",
        "id": 267925224,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1642105447
    },
    {
        "content": "<p>just open it with your web browser</p>",
        "id": 267925235,
        "sender_full_name": "GuillaumeGomez",
        "timestamp": 1642105456
    },
    {
        "content": "<p>and if you want to run a single test and see it in the browser, run something like:</p>\n<div class=\"codehilite\"><pre><span></span><code>node src/tools/rustdoc-gui/tester.js --no-headless --tests-folder src/test/rustdoc-gui/ --doc-folder $PWD/build/x86_64-unknown-linux-gnu/test/rustdoc-gui/doc --show-text --file type-declation-overflow.goml\n</code></pre></div>\n<p>Note: you'll also have to add a <code>wait-for: 100000</code> before whatever assertion is failing, so the browser will stay open long enough to debug</p>",
        "id": 267926304,
        "sender_full_name": "jsha",
        "timestamp": 1642105993
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"315412\">jsha</span> <a href=\"#narrow/stream/266220-rustdoc/topic/updating.20tests.20in.20.2392745/near/267926304\">said</a>:</p>\n<blockquote>\n<p>and if you want to run a single test and see it in the browser...</p>\n</blockquote>\n<p>Thanks but this makes my brain hurt <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 267926949,
        "sender_full_name": "pierwill",
        "timestamp": 1642106360
    },
    {
        "content": "<p>Still getting</p>\n<div class=\"codehilite\"><pre><span></span><code>/repos/rust/src/test/rustdoc-gui/anchors.goml anchors... FAILED\n[ERROR] (line 31) Error: No node found for selector: impl-Foo: for command `move-cursor-to: &quot;impl-Foo&quot;`\n</code></pre></div>\n<p>despite</p>\n<div class=\"codehilite\"><pre><span></span><code>&lt;a href=&quot;#impl-Foo&quot; class=&quot;anchor&quot;&gt;&lt;/a&gt;\n</code></pre></div>",
        "id": 267927088,
        "sender_full_name": "pierwill",
        "timestamp": 1642106424
    },
    {
        "content": "<p>in the goml file:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">-move-cursor-to: \"#impl\"</span>\n<span class=\"gi\">+move-cursor-to: \"#impl-Foo\"</span>\n</code></pre></div>",
        "id": 267927153,
        "sender_full_name": "pierwill",
        "timestamp": 1642106459
    },
    {
        "content": "<p>ah! maybe....</p>",
        "id": 267928293,
        "sender_full_name": "pierwill",
        "timestamp": 1642107028
    },
    {
        "content": "<p><code>&lt;a href=\"#impl-Foo&gt;</code> means \"here's a link that will take you to #impl-Foo\".</p>\n<p>What this test failure is telling you is: There should be something like <code>&lt;h3 id=\"#impl-Foo\"&gt;</code> somewhere, and I can't find it.</p>",
        "id": 267928326,
        "sender_full_name": "jsha",
        "timestamp": 1642107049
    },
    {
        "content": "<p>Or in other words, <code>&lt;a&gt;</code> is like the pointer, and <code>&lt;h3 id=\"....\"&gt;</code> is the pointed-to object :-D</p>",
        "id": 267928386,
        "sender_full_name": "jsha",
        "timestamp": 1642107082
    },
    {
        "content": "<p>Finally got <code>x test src/test/rustdoc-gui*</code> to pass! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 267930295,
        "sender_full_name": "pierwill",
        "timestamp": 1642107910
    },
    {
        "content": "<p><code>@rustbot ready</code> <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span></p>",
        "id": 267930648,
        "sender_full_name": "pierwill",
        "timestamp": 1642108060
    },
    {
        "content": "<p>congratulations! thanks for working through all those test failures. sorry it was such a slog.</p>",
        "id": 267931107,
        "sender_full_name": "jsha",
        "timestamp": 1642108258
    }
]