[
    {
        "content": "<p>I have library code that casts an <code>extern \"C\" fn()</code> pointer into an <code>AtomicUsize</code> and back. I looked into making it work under strict provenance using <code>AtomicPtr</code>, but it seems that's limited to <code>*mut T</code> pointers, and there's currently no <code>AtomicFn</code>. Are there any other options?</p>",
        "id": 277230520,
        "sender_full_name": "Dan Gohman",
        "timestamp": 1648699136
    },
    {
        "content": "<p>If an Oxford cast to <code>usize</code> was sufficiently good so far, an Oxford cast to <code>*mut ()</code> would be a provenance preserving alternative (which doesn't necessarily work for harvards)</p>",
        "id": 277540725,
        "sender_full_name": "nagisa",
        "timestamp": 1648919532
    },
    {
        "content": "<p><code>AtomicFn</code> isn't a thing because there isn't a (yet) type that allows arbitrary code pointers.</p>",
        "id": 277540739,
        "sender_full_name": "nagisa",
        "timestamp": 1648919578
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> ah you haven't seen my <del>joke</del> <del>non-</del>proposal of <code>unsafe fn(!)</code>,</p>",
        "id": 277568212,
        "sender_full_name": "eddyb",
        "timestamp": 1648957703
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"404395\">Dan Gohman</span> <a href=\"#narrow/stream/136281-t-lang.2Fwg-unsafe-code-guidelines/topic/Atomic.20for.20function.20pointers.3F/near/277230520\">said</a>:</p>\n<blockquote>\n<p>I have library code that casts an <code>extern \"C\" fn()</code> pointer into an <code>AtomicUsize</code> and back. I looked into making it work under strict provenance using <code>AtomicPtr</code>, but it seems that's limited to <code>*mut T</code> pointers, and there's currently no <code>AtomicFn</code>. Are there any other options?</p>\n</blockquote>\n<p>I would actually want <span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span>'s input on whether it's okay to <code>transmute</code> from <code>*mut u8</code> back to <code>fn()</code> - my intuition says \"yes\" but there might be caveats wrt how we might want to distinguish provenance between those two</p>",
        "id": 277568221,
        "sender_full_name": "eddyb",
        "timestamp": 1648957781
    },
    {
        "content": "<p>(alternatively, the question could be \"do we want to assume <code>(f: fn()) as *mut u8</code> is equivalent to <code>transmute</code> or is there cause to avoid that?\")</p>",
        "id": 277568297,
        "sender_full_name": "eddyb",
        "timestamp": 1648957860
    },
    {
        "content": "<p>given provenance is practically a compile time thing, is there any reason for fn pointers to have provenance in the first place? Any valid use on say x86 requires inline asm as a barrier as well, and in general any platform-specific effects you might want to fold into provenance aren't going to be automatically handled anyways.</p>",
        "id": 277570239,
        "sender_full_name": "Talchas",
        "timestamp": 1648959788
    },
    {
        "content": "<p>(actually I suppose it's not even inline asm, you need an mprotect syscall to go from RW to RX, and a compiler certainly can't migrate writes past the mprotect)</p>",
        "id": 277570535,
        "sender_full_name": "Talchas",
        "timestamp": 1648959945
    },
    {
        "content": "<p>(All of this is assuming self-modifying code / JIT, otherwise provenance is entirely irrelevant for readonly data)</p>",
        "id": 277570853,
        "sender_full_name": "Talchas",
        "timestamp": 1648960121
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> I dont see any issue with allowing provenance in <code>fn()</code>. so yeah I'd think transmuting and casting from <code>fn()</code> to <code>*mut</code> or vice versa is completely lossless.</p>",
        "id": 277627554,
        "sender_full_name": "RalfJ",
        "timestamp": 1648991825
    },
    {
        "content": "<p>but indeed as <span class=\"user-mention\" data-user-id=\"143798\">@Talchas</span> says there is also the question of whether <code>fn()</code> even have provenance. right now I dont think they need it on the AM. maybe they need they need it for CHERI. it seems safer to say yes they do have provenance, we can always relax this later if it becomes a problem.</p>",
        "id": 277627628,
        "sender_full_name": "RalfJ",
        "timestamp": 1648991880
    },
    {
        "content": "<p>(in Miri they do have provenance and with strict provenance checking it will detect when you lose that)</p>",
        "id": 277627699,
        "sender_full_name": "RalfJ",
        "timestamp": 1648991901
    },
    {
        "content": "<p>Function pointers definitely need provenance (bounds and execute permissions) for CHERI, but since we always represent them the same way as data pointers we can just cast between function and data pointers in C/C++. Well they are slightly different: function pointers have execute permissions and are generally marked as immutable, so any address manipulation will trap. But casting still works fine.</p>",
        "id": 277641308,
        "sender_full_name": "Alexander Richardson",
        "timestamp": 1648999350
    }
]