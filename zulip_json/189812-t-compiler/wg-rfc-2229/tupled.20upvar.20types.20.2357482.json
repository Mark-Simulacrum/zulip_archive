[
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"128294\">@blitzerr</span>, so I <a href=\"https://github.com/rust-lang/rust/issues/57482#issuecomment-607164261\" title=\"https://github.com/rust-lang/rust/issues/57482#issuecomment-607164261\">wrote up instructions</a> for what needs to happen next here.</p>",
        "id": 192507736,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1585736483
    },
    {
        "content": "<p>Thanks a lot <span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span>  I will take a look</p>",
        "id": 192522907,
        "sender_full_name": "blitzerr",
        "timestamp": 1585746007
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span>  I have added a comment <a href=\"https://github.com/rust-lang/rust/issues/57482#issuecomment-609109767\" title=\"https://github.com/rust-lang/rust/issues/57482#issuecomment-609109767\">here</a>. I was thinking how about we break the rfc into an ordered list of sub-issues so that we have them as the steps to final goal. What do you think ?</p>",
        "id": 192934462,
        "sender_full_name": "blitzerr",
        "timestamp": 1586047727
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128294\">@blitzerr</span> seems good, I responded to your comment. Indeed we had already started to do that, as I recall, in the <a href=\"https://github.com/rust-lang/rust/issues/53488\" title=\"https://github.com/rust-lang/rust/issues/53488\">tracking issue</a> -- but we didn't get past <a href=\"https://github.com/rust-lang/rust/issues/57482\" title=\"https://github.com/rust-lang/rust/issues/57482\">#57482</a>. </p>\n<p>And, crossing the streams, I see that <span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> and some of their friends were planning on working on this, which is great, seems like reason enough to try and rejuvenate the effort.</p>",
        "id": 193078220,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1586195871
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> can you say a bit about the timeline -- i.e., when would you be expecting to start, how much time do you think you'll have to invest, and how many people are you? (With how much familiarity with Rust and rustc?)</p>",
        "id": 193078339,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1586195924
    },
    {
        "content": "<p>We will work on it over the next year, accounting for exams and an internship we (3-4 of us) will spend about 4-6 months 5-8hrs/week. We have beginner experience in rust, but are decently familiar with C++.  All of us have taken a basic course on compilers and some of us have also taken courses on type theory. Our current plan is to get better at Rust and try get a E-easy/E-mentor task in my the end of April. Early may we want to make headway on the the RFC. </p>\n<p>Ideally we want to finish most it by January.</p>\n<p>cc: <span class=\"user-mention\" data-user-id=\"281952\">@Chris Pardy</span></p>",
        "id": 193085259,
        "sender_full_name": "Aman Arora",
        "timestamp": 1586199190
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> ok -- let me see -- I think we can start to carve out some issues. I'm not sure how \"easy\" they will be exactly, but I guess you could also pick up some PRs that are unrelated to this work, just to get familiar with Rust codebase.</p>",
        "id": 193086694,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1586199794
    },
    {
        "content": "<p>It would be nice if the issues that we start with are related but getting to know the code base is what is we are going after with those initial issues.</p>",
        "id": 193087061,
        "sender_full_name": "Aman Arora",
        "timestamp": 1586199970
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/193078220\" title=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/193078220\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"128294\">blitzerr</span> seems good, I responded to your comment. Indeed we had already started to do that, as I recall, in the <a href=\"https://github.com/rust-lang/rust/issues/53488\" title=\"https://github.com/rust-lang/rust/issues/53488\">tracking issue</a> -- but we didn't get past <a href=\"https://github.com/rust-lang/rust/issues/57482\" title=\"https://github.com/rust-lang/rust/issues/57482\">#57482</a>. </p>\n</blockquote>\n<p>Thanks a lot <span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span> . I have a few questions. I am unsure if I should put them here or on the issue .. For this iteration, I left them on the issue <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 193130109,
        "sender_full_name": "blitzerr",
        "timestamp": 1586232815
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> and <span class=\"user-mention\" data-user-id=\"281952\">@Chris Pardy</span> when do y'all plan to start?</p>",
        "id": 194052120,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1586966065
    },
    {
        "content": "<p>We are all working full time on internships this term. I don't know when everybody's last day is, but we will all be done work by the end of this month. At that point we can start devoting real time to this project. </p>\n<p>So to answer your question directly, May 1st.</p>",
        "id": 194063166,
        "sender_full_name": "Chris Pardy",
        "timestamp": 1586971081
    },
    {
        "content": "<p>OK, I better start laying out some plans =)</p>",
        "id": 194232620,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1586987563
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128294\">@blitzerr</span> did you ever have a chance to look at that issue?</p>",
        "id": 194232641,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1586987572
    },
    {
        "content": "<p>I look at that last weekend. I am still thinking if undoing parts of <span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> 's PR is a good idea. I am trying to think if we can side step that.</p>",
        "id": 194236401,
        "sender_full_name": "blitzerr",
        "timestamp": 1586989740
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span></p>",
        "id": 194236410,
        "sender_full_name": "blitzerr",
        "timestamp": 1586989749
    },
    {
        "content": "<p>which parts?</p>",
        "id": 194236543,
        "sender_full_name": "eddyb",
        "timestamp": 1586989822
    },
    {
        "content": "<p>the part where I build a tuple of inference variables is fine to replace</p>",
        "id": 194236557,
        "sender_full_name": "eddyb",
        "timestamp": 1586989835
    },
    {
        "content": "<p>Right, that one</p>",
        "id": 194236620,
        "sender_full_name": "blitzerr",
        "timestamp": 1586989900
    },
    {
        "content": "<p>I think that part has to be undone, I don't see another way</p>",
        "id": 194317628,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1587049341
    },
    {
        "content": "<p>Sounds good <span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span></p>",
        "id": 194329584,
        "sender_full_name": "blitzerr",
        "timestamp": 1587053742
    },
    {
        "content": "<p>EDIT: sorry, wrong stream</p>",
        "id": 194462594,
        "sender_full_name": "mark-i-m",
        "timestamp": 1587139265
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128294\">@blitzerr</span> any jupdates here?</p>",
        "id": 195739613,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1588179375
    },
    {
        "content": "<p>I am working on this. There are just a lot of places which needs to be reverted back. <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span> <span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span></p>",
        "id": 196226217,
        "sender_full_name": "blitzerr",
        "timestamp": 1588619303
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"128294\">@blitzerr</span> what's the status here? I just opened <a href=\"https://github.com/rust-lang/rust/issues/74314\">#74314</a> which should help (cc <span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span>)</p>",
        "id": 203803798,
        "sender_full_name": "eddyb",
        "timestamp": 1594709864
    },
    {
        "content": "<p>it should be even easier now, the hard part is anything assuming the type is a tuple</p>",
        "id": 203803854,
        "sender_full_name": "eddyb",
        "timestamp": 1594709903
    },
    {
        "content": "<p>but most things shouldn't be looking at upvars, during inference, I don't think</p>",
        "id": 203803878,
        "sender_full_name": "eddyb",
        "timestamp": 1594709938
    },
    {
        "content": "<p>so just defer it and see what breaks <em>shrug</em></p>",
        "id": 203803895,
        "sender_full_name": "eddyb",
        "timestamp": 1594709962
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span>  that's one of next tasks for this RFC. We are trying to get <a href=\"https://github.com/rust-lang/project-rfc-2229/issues/7\">https://github.com/rust-lang/project-rfc-2229/issues/7</a> done first</p>",
        "id": 203804275,
        "sender_full_name": "Aman Arora",
        "timestamp": 1594710343
    },
    {
        "content": "<p>to be clear: this shouldn't be a big thing</p>",
        "id": 203805150,
        "sender_full_name": "eddyb",
        "timestamp": 1594711167
    },
    {
        "content": "<p>not sure how it hasn't happened yet</p>",
        "id": 203805175,
        "sender_full_name": "eddyb",
        "timestamp": 1594711187
    },
    {
        "content": "<p>I can try to help, maybe, not sure how much time I have in general</p>",
        "id": 203805265,
        "sender_full_name": "eddyb",
        "timestamp": 1594711262
    },
    {
        "content": "<p>There is a sync meeting on Zulip scheduled for today (14th July) 3:30pm Eastern Time -- I'll bring this up.</p>",
        "id": 203805544,
        "sender_full_name": "Aman Arora",
        "timestamp": 1594711613
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span>  Looks like NIko isn't avaiable for the meeting today, I'll bring the tupled upvars next week. </p>\n<p>Also we are a bunch of 4th year students working on it as our Design Project. These couple weeks have been busy because of exams and project deliverables, so progress is a little slow. If you think this change needs to go in soon and let me know, and we can priortize it over <a href=\"https://github.com/rust-lang/project-rfc-2229/issues/7\">https://github.com/rust-lang/project-rfc-2229/issues/7</a></p>",
        "id": 203873764,
        "sender_full_name": "Aman Arora",
        "timestamp": 1594753588
    },
    {
        "content": "<p>ah no it's just there shouldn't be a lot of work</p>",
        "id": 203876997,
        "sender_full_name": "eddyb",
        "timestamp": 1594755249
    },
    {
        "content": "<p>not to move it to a variable number of upvars, but just making it less eagerly a tuple</p>",
        "id": 203877085,
        "sender_full_name": "eddyb",
        "timestamp": 1594755295
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/203877085\">said</a>:</p>\n<blockquote>\n<p>not to move it to a variable number of upvars, but just making it less eagerly a tuple</p>\n</blockquote>\n<p>One or two of us might have some time this week, I'll bring this up</p>",
        "id": 203877560,
        "sender_full_name": "Aman Arora",
        "timestamp": 1594755535
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/203803798\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"128294\">blitzerr</span> what's the status here? I just opened <a href=\"https://github.com/rust-lang/rust/issues/74314\">#74314</a> which should help (cc <span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span>)</p>\n</blockquote>\n<p>Sorry for the late response <span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> .  Unfortunately, I am currently not working on this issue and it is being taken care of by <span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span>  and friends. They are making great progress, much better than I did and this will soon be addressed.</p>",
        "id": 203913883,
        "sender_full_name": "blitzerr",
        "timestamp": 1594784589
    },
    {
        "content": "<p>alright, no worries, good to know</p>",
        "id": 203913903,
        "sender_full_name": "eddyb",
        "timestamp": 1594784641
    },
    {
        "content": "<p>(I'm not waiting for it or anything, just wanted to make sure it's not stuck on a simple step)</p>",
        "id": 203913946,
        "sender_full_name": "eddyb",
        "timestamp": 1594784662
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/203876997\">said</a>:</p>\n<blockquote>\n<p>ah no it's just there shouldn't be a lot of work</p>\n</blockquote>\n<p>the last time we tried it we got a bit stuck on fixing some diagnostics issues that arose</p>",
        "id": 204217680,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1594998673
    },
    {
        "content": "<p>but I don't think it should be so hard to fix, and honestly the \"regression\" wasn't that bad either</p>",
        "id": 204217723,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1594998692
    },
    {
        "content": "<p>basically the backtrace included an extra tuple here and there that we had a hard time suppressing</p>",
        "id": 204217744,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1594998704
    },
    {
        "content": "<p>(the backtrace for auto-trait-related errors and the like)</p>",
        "id": 204217770,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1594998717
    },
    {
        "content": "<p>hmm</p>",
        "id": 204233372,
        "sender_full_name": "eddyb",
        "timestamp": 1595006278
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span> because some logic that iterated over tuple fields didn't get to do that?</p>",
        "id": 204233459,
        "sender_full_name": "eddyb",
        "timestamp": 1595006311
    },
    {
        "content": "<p>I'd say treat <code>Closure { tupled_upvars: _ }: AutoTrait</code> the same as <code>_: AutoTrait</code> so that it gets retried later</p>",
        "id": 204233524,
        "sender_full_name": "eddyb",
        "timestamp": 1595006348
    },
    {
        "content": "<p>and the tuple never leaks</p>",
        "id": 204233538,
        "sender_full_name": "eddyb",
        "timestamp": 1595006354
    },
    {
        "content": "<p>at least that seems plausible to me that it would work</p>",
        "id": 204233560,
        "sender_full_name": "eddyb",
        "timestamp": 1595006368
    },
    {
        "content": "<p>So, what we did in that first PR was just to have <code>Closure { tupled_upvars: T, }: AutoTrait</code> convert to <code>T: AutoTrait</code> always, which is simpler and I think more the approach I'd prefer. However, we then found it leaked into the trace, so we toying a bit with the \"origin\" field to know not to print it out, and we never quite got that right.</p>",
        "id": 204242694,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595011105
    },
    {
        "content": "<p>It's true we could just make it delay.</p>",
        "id": 204242707,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595011112
    },
    {
        "content": "<p>I was trying to get the core logic as simple as possible so that we generally passed around the \"tupled upvars\" type without inspecting it to see that it was a tuple</p>",
        "id": 204242739,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595011135
    },
    {
        "content": "<p>Just want to make sure that we have all the main components here:</p>\n<p>1) src/librustc_typechk/check/closure.rs -&gt; creates a tuple of inference variables. This will become just a single inference variable with kind ClosureSynthetic ( can someone confirm the kind?, i'm not sure what synthetic means here)<br>\n2) src/librustc_typechk/check/upvar.rs -&gt; fills the the tuple of inference variable with actual types, around the end of analyse_closures. This will now create the tuple with the type infromation and then set the inference variable we had created in <a href=\"http://closure.rs\">closure.rs</a> with this tuple.<br>\n3) We will add another method to ClosureSubts to return the <a href=\"https://github.com/rust-lang/rust/pull/74341/files#diff-4cbc928241996c3226a17d1a924c6ebaR327\"><code>tupled_upvars_ty</code></a> directly instead of an iterator.  <br>\n4) Before we use the tuple returned we will check <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_infer/infer/struct.InferCtxt.html#method.shallow_resolve\"><code>self.infcx.shallow_resolve</code></a><br>\nIf this fails in trait selection we return Ambigous (and then the compiler figure the trait that later?)<br>\nWhat about if this check fails in other parts of  the compiler? </p>\n<p>Should we wrap 3 and 4 together to return Some&lt;T&gt; where it will be Some(Ty&lt;'tcx&gt;) if the tuple has been evaluated/inferred and None otherwise</p>\n<p>cc: <span class=\"user-mention\" data-user-id=\"300388\">@Logan Mosier</span> <span class=\"user-mention\" data-user-id=\"307184\">@rocksand</span></p>",
        "id": 204258099,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595019410
    },
    {
        "content": "<p>That sounds roughly correct. I guess that having trait selection return ambiguous is probably a good idea, even if it seems 'less pure' to me. Good enough for now. We'll have to check the other parts of the compiler, in terms of figuring out what they should do. I think one other problem we will encounter is pretty-printing, which doesn't have access to the infcx, but it should just not print out information about the upvars in that case.</p>",
        "id": 204260104,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595020510
    },
    {
        "content": "<p>We can use closure_captures for <a href=\"http://pretty.rs\">pretty.rs</a> because <del>going forward</del> near future they will have type information when they use Place</p>",
        "id": 204261942,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595021457
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281950\">Aman Arora</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204261942\">said</a>:</p>\n<blockquote>\n<p>We can use closure_captures for <a href=\"http://pretty.rs\">pretty.rs</a> because <del>going forward</del> near future they will have type information when they use Place</p>\n</blockquote>\n<p>Actually this is wrong. If the tuple isn't  resolved that means we haven't done capture anlysis, which means we can't use closure_captures</p>",
        "id": 204389239,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595225292
    },
    {
        "content": "<p>you can just not print the captures if they're not there yet</p>",
        "id": 204390422,
        "sender_full_name": "eddyb",
        "timestamp": 1595226879
    },
    {
        "content": "<p>I think the current code should already be fine? like IIRC that's why <code>is_valid</code> even exists</p>",
        "id": 204390433,
        "sender_full_name": "eddyb",
        "timestamp": 1595226900
    },
    {
        "content": "<p>if it's confusing we could rename it</p>",
        "id": 204390440,
        "sender_full_name": "eddyb",
        "timestamp": 1595226910
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204390422\">said</a>:</p>\n<blockquote>\n<p>you can just not print the captures if they're not there yet</p>\n</blockquote>\n<p>Exactly.</p>",
        "id": 204390511,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595226995
    },
    {
        "content": "<p>like that's what this does <a href=\"https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/print/pretty.rs#L678-L685\">https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/print/pretty.rs#L678-L685</a></p>",
        "id": 204390554,
        "sender_full_name": "eddyb",
        "timestamp": 1595227049
    },
    {
        "content": "<p>Okay that's better, I thought it only checked we had atleast three entried. This is better than shallow_resolve, because we don't need <code>infcx</code> anymore</p>",
        "id": 204390644,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595227162
    },
    {
        "content": "<p>I think the only reason it even checks that is to not panic while checking the thing it wants to check</p>",
        "id": 204394752,
        "sender_full_name": "eddyb",
        "timestamp": 1595231384
    },
    {
        "content": "<p>allowing some level of debugging :P</p>",
        "id": 204394754,
        "sender_full_name": "eddyb",
        "timestamp": 1595231389
    },
    {
        "content": "<p>and yeah it would be impossible rn to make printing work with inference. well, less impossible than a while back but still hard. there's no good solution for this, you either double down on hacks, or you make a lot of diagnostics generation more explicit</p>",
        "id": 204394842,
        "sender_full_name": "eddyb",
        "timestamp": 1595231453
    },
    {
        "content": "<p>(but maybe we want something like <code>format_args!</code> that is specialized to diagnostics and plumbs through relevant context around)</p>",
        "id": 204394862,
        "sender_full_name": "eddyb",
        "timestamp": 1595231474
    },
    {
        "content": "<p>What do you mean by diagnostic generation? Like just more information about the current stage/pass of the compiler to print produce better information for debugging?</p>",
        "id": 204396843,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595233227
    },
    {
        "content": "<p>no, \"diagnostics\" specifically refers to warnings/errors output to the user</p>",
        "id": 204396858,
        "sender_full_name": "eddyb",
        "timestamp": 1595233251
    },
    {
        "content": "<p>or at least I like to think we use it consistently :P</p>",
        "id": 204396871,
        "sender_full_name": "eddyb",
        "timestamp": 1595233268
    },
    {
        "content": "<p>I see</p>",
        "id": 204396980,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595233340
    },
    {
        "content": "<p>that makes sense</p>",
        "id": 204396988,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595233353
    },
    {
        "content": "<p>because they're the main reason we print types (and other typesystem entities), we could use macros to make it more easy for inference information to be available to e.g. <code>ty::print::pretty</code></p>",
        "id": 204397006,
        "sender_full_name": "eddyb",
        "timestamp": 1595233376
    },
    {
        "content": "<p>I think almost all of the printing is either for user-facing diagnostics, or <code>debug!</code> logging, and we could arguably specialize each of them for those usecases</p>",
        "id": 204397036,
        "sender_full_name": "eddyb",
        "timestamp": 1595233423
    },
    {
        "content": "<p>but I am not aware of any plans to do so any time soon</p>",
        "id": 204397044,
        "sender_full_name": "eddyb",
        "timestamp": 1595233432
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204397036\">said</a>:</p>\n<blockquote>\n<p>I think almost all of the printing is either for user-facing diagnostics, or <code>debug!</code> logging, and we could arguably specialize each of them for those usecases</p>\n</blockquote>\n<p>yes, I think we really want two distinct paths...</p>",
        "id": 204454457,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595267989
    },
    {
        "content": "<p>...but that'd be a lot of work</p>",
        "id": 204454465,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595267993
    },
    {
        "content": "<p>So this might be dumb question but if I understand the code <a href=\"https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/upvar.rs#L90\">here</a></p>\n<p>We have an immutable copy of ClosureSubsts that hold immutable reference to the internal substs.</p>\n<p>And code here is what checks if the types can be unified? <a href=\"https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/upvar.rs#L205\">https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/upvar.rs#L205</a></p>\n<p>Since the substs copy we have,  has immut reference to the Internal Substs. Will it/How does it update the substs (not the copy) to be the correct bound/resolved type?  Call to demand_suptype also uses a immut reference to the function context, so don't see it update any inference tables (Not sure how they are stored, table is a guess here). <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_typeck/check/struct.FnCtxt.html#method.demand_suptype\">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_typeck/check/struct.FnCtxt.html#method.demand_suptype</a></p>\n<p>Because I'm trying to figure out if <code>is_valid</code> will start returning correct results or do we need to call shallow_resolve on the  substs at some point</p>",
        "id": 204587070,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595357372
    },
    {
        "content": "<blockquote>\n<p>And code here is what checks if the types can be unified? <a href=\"https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/upvar.rs#L205\">https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/upvar.rs#L205</a></p>\n</blockquote>\n<p>Well, sort of, I that these unifications can never fail, because the upvar types are always unbound until the unification occurs. But I misremembering some detail.</p>",
        "id": 204593781,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595360497
    },
    {
        "content": "<blockquote>\n<p>Since the substs copy we have, has immut reference to the Internal Substs. Will it/How does it update the substs (not the copy) to be the correct bound/resolved type? </p>\n</blockquote>\n<p>So, it never \"updates the type\". The type remains the same -- it is a reference to the inference variable. <em>But the state  of the inference variable changes</em> to be bound.</p>",
        "id": 204593895,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595360550
    },
    {
        "content": "<p>The state of the inference variables is stored in a <code>RefCell</code> inside the <code>InferCtxt</code></p>",
        "id": 204593914,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595360560
    },
    {
        "content": "<p>When we talk about \"resolving\" an inference variable, it means replacing the variable with the type to which it is bound</p>",
        "id": 204593947,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595360575
    },
    {
        "content": "<p>The \"writeback\" phase of type checking, which comes at the very end, replaces all inference variables with the types to which they were ultimately bound</p>",
        "id": 204593979,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595360592
    },
    {
        "content": "<p>But this happens outside of upvar inference</p>",
        "id": 204593994,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595360602
    },
    {
        "content": "<blockquote>\n<p>I'm trying to figure out if is_valid will start returning correct results or do we need to call shallow_resolve on the substs at some point</p>\n</blockquote>\n<p>If <code>is_valid</code> is just testing if this is an inference variable, you will need to call <code>shallow_resolve</code> (that name, as a side note, could be clearer...)</p>",
        "id": 204594178,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595360657
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204594178\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>I'm trying to figure out if is_valid will start returning correct results or do we need to call shallow_resolve on the substs at some point</p>\n</blockquote>\n<p>If <code>is_valid</code> is just testing if this is an inference variable, you will need to call <code>shallow_resolve</code> (that name, as a side note, could be clearer...)</p>\n</blockquote>\n<p>Yeah is valid checks if the susts.upvars_ty_tuple is a tuple or not</p>",
        "id": 204594273,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595360707
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204593979\">said</a>:</p>\n<blockquote>\n<p>The \"writeback\" phase of type checking, which comes at the very end, replaces all inference variables with the types to which they were ultimately bound</p>\n</blockquote>\n<p>This makes sense, I forgot about that step</p>",
        "id": 204594930,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595361018
    },
    {
        "content": "<p>I'm assuming once write back is done we won't require shallow_resolve? Also when does the trait_selection code run</p>",
        "id": 204595034,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595361090
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281950\">Aman Arora</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204595034\">said</a>:</p>\n<blockquote>\n<p>I'm assuming once write back is done we won't require shallow_resolve? </p>\n</blockquote>\n<p>Correct</p>\n<blockquote>\n<p>Also when does the trait_selection code run</p>\n</blockquote>\n<p>both before and after writeback</p>",
        "id": 204595293,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361236
    },
    {
        "content": "<p>And when/how can a user  run <a href=\"http://pretty.rs\">pretty.rs</a>? It is defined as part of librustc_mir, so my inital expectation is it deals with things around time we are building MIR and typeck/inference information would've ideally resolved</p>",
        "id": 204595375,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595361262
    },
    {
        "content": "<p>one option would be to add a method like <code>upvar_types(cx: &amp;InferCtxt) -&gt; Option&lt;&amp;[Ty]&gt;</code> or something</p>",
        "id": 204595380,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361265
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204595380\">said</a>:</p>\n<blockquote>\n<p>one option would be to add a method like <code>upvar_types(cx: &amp;InferCtxt) -&gt; Option&lt;&amp;[Ty]&gt;</code> or something</p>\n</blockquote>\n<p>Yeah that's something I was thinking as well</p>",
        "id": 204595412,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595361291
    },
    {
        "content": "<p>and have another method that <em>asserts</em> that they are inferred, and is only meant to be used when you know that writeback has occcurred</p>",
        "id": 204595413,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361292
    },
    {
        "content": "<p>I think this is what we did initially</p>",
        "id": 204595417,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361295
    },
    {
        "content": "<p><a href=\"http://pretty.rs\">pretty.rs</a> .. I'm not sure what that is anymore, is that type pretty printing?</p>",
        "id": 204595461,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361322
    },
    {
        "content": "<p>if so, it runs all the time and has to be prepared for anything</p>",
        "id": 204595473,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361330
    },
    {
        "content": "<p>which is a pain in the neck sometimes :)</p>",
        "id": 204595491,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361339
    },
    {
        "content": "<p>nvm it's rust middle, and I yes it's printing type info</p>",
        "id": 204595706,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595361449
    },
    {
        "content": "<p>Since we don't have infcx context we can just let is_valid fail here for pre-writeback printing</p>",
        "id": 204595805,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595361491
    },
    {
        "content": "<p>yeah that should be fine</p>",
        "id": 204595816,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361497
    },
    {
        "content": "<p>honestly dumping out the types of all the upvars.. I'm not sure how helpful it is</p>",
        "id": 204595839,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361510
    },
    {
        "content": "<p>I can imagine it can be</p>",
        "id": 204595842,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361514
    },
    {
        "content": "<p>but it's also a lot of verbosity for users</p>",
        "id": 204595847,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361518
    },
    {
        "content": "<p>I bet it does more harm than good</p>",
        "id": 204595856,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361523
    },
    {
        "content": "<p>but that's a discussion for another time :)</p>",
        "id": 204595861,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595361526
    },
    {
        "content": "<p>Also looking at the code, it alreayd checks <code>is_valid</code>, so that really doesn't need to change lol</p>",
        "id": 204595924,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595361573
    },
    {
        "content": "<p>yeah I was explaining that earlier, I had to add that so that e.g. <code>debug!</code> printing when the type isn't known at all doesn't ICE</p>",
        "id": 204596540,
        "sender_full_name": "eddyb",
        "timestamp": 1595361843
    },
    {
        "content": "<p>we thankfully have a test that runs the compiler with a <code>RUSTC_LOG</code> value that will catch stuff like that :P</p>",
        "id": 204596584,
        "sender_full_name": "eddyb",
        "timestamp": 1595361865
    },
    {
        "content": "<p>could rename <code>is_valid</code> to something else, no idea. the name is too general anyway</p>",
        "id": 204596642,
        "sender_full_name": "eddyb",
        "timestamp": 1595361895
    },
    {
        "content": "<p><code>is_shallowly_known</code> maybe <em>shrug</em></p>",
        "id": 204596681,
        "sender_full_name": "eddyb",
        "timestamp": 1595361916
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204595413\">said</a>:</p>\n<blockquote>\n<p>and have another method that <em>asserts</em> that they are inferred, and is only meant to be used when you know that writeback has occcurred</p>\n</blockquote>\n<p><del>From a quick sweep I think, this is only being used in trait_selection. Unless there are parts of trait selection that run only after writeback, not sure if this will be helpful</del> This is super incorrect, ignore this</p>",
        "id": 204597223,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595362201
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204596540\">said</a>:</p>\n<blockquote>\n<p>yeah I was explaining that earlier, I had to add that so that e.g. <code>debug!</code> printing when the type isn't known at all doesn't ICE</p>\n</blockquote>\n<p>I see what you mean now, I confused it for we can rely on is_valid being correct all the time. by bad</p>",
        "id": 204597368,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595362269
    },
    {
        "content": "<p>I kinda did a poor job, should've come up with a better name and docs for that hack (I basically wanted to not bother exposing the tupled type to <code>ty::print::pretty</code>)</p>",
        "id": 204599587,
        "sender_full_name": "eddyb",
        "timestamp": 1595363519
    },
    {
        "content": "<p>How about names like <code>is_resolved</code> or <code>is_inferred</code>, with comment about this returns true  only after typeck writeback stage is complete.</p>\n<p>Or something more explicit <code>is_post_writeback</code></p>",
        "id": 204602555,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595365384
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> that's not even the problem I was solving, which is that closures types can exist in an unsubstituted form for a brief moment, and there is at least one <code>debug!</code> that will try to print that form</p>",
        "id": 204603220,
        "sender_full_name": "eddyb",
        "timestamp": 1595365769
    },
    {
        "content": "<p>that's why I'd use \"known\". maybe \"complete\" would work too</p>",
        "id": 204603248,
        "sender_full_name": "eddyb",
        "timestamp": 1595365799
    },
    {
        "content": "<p>Yeah also not just debug statements, coerce relies on it too:<br>\n<a href=\"https://github.com/rust-lang/rust/commit/2c8aef2316284cc90d27fae707586552e8679511\">https://github.com/rust-lang/rust/commit/2c8aef2316284cc90d27fae707586552e8679511</a></p>",
        "id": 204603356,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595365867
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> we could just grab the tupled upvars type and check it against <code>ty::Tuple(_)</code> with <code>matches!</code> in <code>pretty</code> if there are no other users</p>",
        "id": 204603369,
        "sender_full_name": "eddyb",
        "timestamp": 1595365882
    },
    {
        "content": "<p>oh, spoke too soon?</p>",
        "id": 204603377,
        "sender_full_name": "eddyb",
        "timestamp": 1595365884
    },
    {
        "content": "<p>ah that's different</p>",
        "id": 204603397,
        "sender_full_name": "eddyb",
        "timestamp": 1595365913
    },
    {
        "content": "<p>the fix there makes sense I guess</p>",
        "id": 204603457,
        "sender_full_name": "eddyb",
        "timestamp": 1595365938
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204603369\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"281950\">Aman Arora</span> we could just grab the tupled upvars type and check it against <code>ty::Tuple(_)</code> with <code>matches!</code> in <code>pretty</code> if there are no other users</p>\n</blockquote>\n<p>I think this is better just because it's more explicit</p>",
        "id": 204603521,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595365995
    },
    {
        "content": "<p>Not the <a href=\"http://pretty.rs\">pretty.rs</a> problem but as niko suggested we probably should've two sets of api one that asserts that the type has been resolved. </p>\n<p>The error message when debugging the coerce issue wasn't hard to track using traceback, but it would've been nice to know why it was erroring out. </p>\n<p>Also currently the error is thrown by <code>bug!</code> about some method on non tuple type, which has the formatting and writer stuff at the top of the traceback where as assert will just be a clean this failed and comment around the assert can explain that the tuple  is not resolved</p>",
        "id": 204605383,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595367217
    },
    {
        "content": "<p>not sure what you mean tbh, backtraces always start with like a dozen unnecessary frames</p>",
        "id": 204605811,
        "sender_full_name": "eddyb",
        "timestamp": 1595367523
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204605811\">said</a>:</p>\n<blockquote>\n<p>not sure what you mean tbh, backtraces always start with like a dozen unnecessary frames</p>\n</blockquote>\n<p>and assert failure would much more noticable</p>",
        "id": 204606014,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595367657
    },
    {
        "content": "<p>but the assert would also have that kind of stuff on it?</p>",
        "id": 204606100,
        "sender_full_name": "eddyb",
        "timestamp": 1595367719
    },
    {
        "content": "<p>if you show me a backtrace I can probably understand easier what the problem is</p>",
        "id": 204606152,
        "sender_full_name": "eddyb",
        "timestamp": 1595367733
    },
    {
        "content": "<p>(there's also <code>#[track_caller]</code>, look at how I've used it on <code>fn typeck_results</code> methods to get better quality ICEs)</p>",
        "id": 204606198,
        "sender_full_name": "eddyb",
        "timestamp": 1595367764
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204606152\">said</a>:</p>\n<blockquote>\n<p>if you show me a backtrace I can probably understand easier what the problem is</p>\n</blockquote>\n<p>I guess point was if we have asserts fail we won't need the backtrace</p>",
        "id": 204606309,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595367842
    },
    {
        "content": "<p>aaaaaah</p>",
        "id": 204607672,
        "sender_full_name": "eddyb",
        "timestamp": 1595368741
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> that's not assert vs bug, it's <code>#[track_caller]</code> vs not :P</p>",
        "id": 204607693,
        "sender_full_name": "eddyb",
        "timestamp": 1595368760
    },
    {
        "content": "<p>although which <code>bug!</code> gives you a not useful location?</p>",
        "id": 204607720,
        "sender_full_name": "eddyb",
        "timestamp": 1595368788
    },
    {
        "content": "<p>I don't think I'm understanding where it fails that makes it worse for debugging</p>",
        "id": 204607835,
        "sender_full_name": "eddyb",
        "timestamp": 1595368834
    },
    {
        "content": "<p>Nvm I incorrectly rememberedd error message with assert was, I remember seeing a caller somewhere. Sorry for derailing the conversation</p>",
        "id": 204608323,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595369162
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span> <a href=\"#narrow/stream/189812-t-compiler.2Fwg-rfc-2229/topic/tupled.20upvar.20types.20.2357482/near/204595380\">said</a>:</p>\n<blockquote>\n<p>one option would be to add a method like <code>upvar_types(cx: &amp;InferCtxt) -&gt; Option&lt;&amp;[Ty]&gt;</code> or something</p>\n</blockquote>\n<p>If I'm not wrong this is expected to be part of the ClosureSubsts api?</p>\n<p>That is defined in middle and rustc_infer depends on middle.So circular dependency<br>\nso either we need to move the substs to another create or have sort of a util function in the infer crate.</p>",
        "id": 204755889,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595472556
    },
    {
        "content": "<p>the traditional thing is a method on <code>InferCtxt</code></p>",
        "id": 204761228,
        "sender_full_name": "eddyb",
        "timestamp": 1595481026
    },
    {
        "content": "<p>like we used to have this</p>",
        "id": 204761236,
        "sender_full_name": "eddyb",
        "timestamp": 1595481042
    },
    {
        "content": "<p>Can u point me to it? Also why was it removed?</p>",
        "id": 204762264,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595482666
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> I think look at <code>closure_kind</code>? we should still have something closure-related on <code>InferCtxt</code>. I removed at least one method because it became unnecessary, I think?</p>",
        "id": 204779622,
        "sender_full_name": "eddyb",
        "timestamp": 1595498948
    },
    {
        "content": "<p>I could be misremembering  though</p>",
        "id": 204779631,
        "sender_full_name": "eddyb",
        "timestamp": 1595498956
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/blob/e8b55a4ad230ebec762fdfc4f241ba98a98560af/src/librustc_infer/infer/mod.rs#L1499\">https://github.com/rust-lang/rust/blob/e8b55a4ad230ebec762fdfc4f241ba98a98560af/src/librustc_infer/infer/mod.rs#L1499</a></p>",
        "id": 204779727,
        "sender_full_name": "eddyb",
        "timestamp": 1595499004
    },
    {
        "content": "<p>hmm I changed its signature <a href=\"https://github.com/rust-lang/rust/commit/10f08abd2e27785496ddfe92a9e6a4f9cd18443d#diff-d2b6d3d8d756534498ab3927843ebcbaL1499-R1500\">https://github.com/rust-lang/rust/commit/10f08abd2e27785496ddfe92a9e6a4f9cd18443d#diff-d2b6d3d8d756534498ab3927843ebcbaL1499-R1500</a></p>",
        "id": 204779780,
        "sender_full_name": "eddyb",
        "timestamp": 1595499054
    },
    {
        "content": "<p>but I guess didn't remove anything</p>",
        "id": 204779794,
        "sender_full_name": "eddyb",
        "timestamp": 1595499060
    },
    {
        "content": "<p>aaah we used to have <code>closure_sig</code>, that's what got removed</p>",
        "id": 204779830,
        "sender_full_name": "eddyb",
        "timestamp": 1595499108
    },
    {
        "content": "<p>apparently nothing about upvars</p>",
        "id": 204779835,
        "sender_full_name": "eddyb",
        "timestamp": 1595499113
    },
    {
        "content": "<p>I don't have a strong opinion about whether to write <code>infcx.closure_upvar_tys(substs)</code> or the reverse, but I would say that <code>substs.upvar_tys(infcx)</code> seems more 'discoverable' to me</p>",
        "id": 204809594,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595516761
    },
    {
        "content": "<p>but if there is a rustdoc comment pointing back-and-forth that perhaps suffices</p>",
        "id": 204809707,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1595516798
    },
    {
        "content": "<p>I'll take a look later, the substs.upvars... api wont be feasible until we handle the circular dependency</p>",
        "id": 204820476,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595521791
    },
    {
        "content": "<p>I think we should rename some of these closure substs apis to be <code>capture_</code> so that it denotes that the information is about what the closure captures and not the root variables that were mentioned. </p>\n<p>This is similar to how we renamed the map in typeck tables to from upvars to closure_captues. Closure_captures is also generated along with/where the upvars_ty (captures_ty if we rename it) inference  will now  happen</p>",
        "id": 204872304,
        "sender_full_name": "Aman Arora",
        "timestamp": 1595555593
    },
    {
        "content": "<p>We now have most testings _passing_.</p>\n<p><a href=\"https://github.com/sexxi-goose/rust/pull/23\">https://github.com/sexxi-goose/rust/pull/23</a> (needs some cleaning)</p>\n<ul>\n<li>issue-70818 is failing (PR has the updated failing .stderr)</li>\n<li>add an extra to the error output (don't think that is entierly incorrect, other than the last last element of the tuple missing) <br>\n    - src/test/ui/no-send-res-ports.stderr<br>\n    - src/test/ui/kindck/kindck-nonsendable-1.stderr<br>\n    - src/test/ui/interior-mutability/interior-mutability.stderr<br>\n    -  src/test/ui/generator/not-send-sync.stderr</li>\n</ul>\n<p>The upvar printing diffs here will go away once closure printing is merged</p>",
        "id": 211507503,
        "sender_full_name": "Aman Arora",
        "timestamp": 1601306682
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"307184\">@rocksand</span></p>",
        "id": 211547078,
        "sender_full_name": "Aman Arora",
        "timestamp": 1601325430
    },
    {
        "content": "<p>PR for this is up</p>\n<p><a href=\"https://github.com/rust-lang/rust/pull/77873\">https://github.com/rust-lang/rust/pull/77873</a></p>\n<p>I think the r? Didn't work.</p>\n<p><span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span> </p>\n<p>cc: <span class=\"user-mention\" data-user-id=\"128294\">@blitzerr</span> in case you're curious what happened to this <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 213093374,
        "sender_full_name": "Aman Arora",
        "timestamp": 1602542531
    },
    {
        "content": "<p>Thanks a lot <span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> I was curious. <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 213105974,
        "sender_full_name": "blitzerr",
        "timestamp": 1602556125
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> I left some comments btw</p>",
        "id": 213164075,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1602599783
    },
    {
        "content": "<p>Thanks, Roxane is planning on address them tonight</p>",
        "id": 213171154,
        "sender_full_name": "Aman Arora",
        "timestamp": 1602602296
    },
    {
        "content": "<p>This resulted in an ICE, <a href=\"https://github.com/rust-lang/rust/issues/77993\">https://github.com/rust-lang/rust/issues/77993</a></p>",
        "id": 214133942,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603329114
    },
    {
        "content": "<p>Can get a fix in over the weekend</p>",
        "id": 214133990,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603329135
    },
    {
        "content": "<p>I think we should also switch our if cases to  <code>if (subssts. ... tupled(), Ty::Tuple)</code>, though not sure when we will end up with TyKind::Error there.</p>",
        "id": 214134209,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603329375
    },
    {
        "content": "<p>interesting</p>",
        "id": 214191224,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603375355
    },
    {
        "content": "<p>we should probably be prepared for error regardless</p>",
        "id": 214191247,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603375368
    },
    {
        "content": "<p>if we see an <em>error</em> I think returning an empty iterator <em>probably</em> makes sense</p>",
        "id": 214191290,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603375389
    },
    {
        "content": "<p>(though it might lead to some weird diagnostics or other behavior)</p>",
        "id": 214191305,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603375398
    },
    {
        "content": "<p>this is always kind of annoying; ideal would probably be to return a <code>Result&lt;&gt;</code> but that may be annoying in practice</p>",
        "id": 214191333,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603375410
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> I left a <a href=\"https://github.com/rust-lang/rust/pull/78392#pullrequestreview-516768171\">review comment</a> on PR <a href=\"https://github.com/rust-lang/rust/issues/78392\">#78392</a></p>",
        "id": 214572659,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603718922
    },
    {
        "content": "<p>So Roxane and I tried doing the Result on upvar_tys, but we weren't able to get that to work. </p>\n<p>I think main reason behind that was tuple_fieleds returns an impl Trait which is opaque, so returning an Err from that function didn't quite work out</p>\n<p>Also since it breaks some production tests (and looks like multiple people have encountered this), we wanted to have some fix out soon as we continue to refine it to be more future proof code</p>",
        "id": 214589752,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603726634
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> ah, I see</p>",
        "id": 214607852,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603733831
    },
    {
        "content": "<p>ok, then I am willing to r+ with some more comments</p>",
        "id": 214607878,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603733847
    },
    {
        "content": "<p>Is this regarding the quick fix or returning Result from upvar_tys ? The latter might be because of my less experience with Rust so if you have any suggestions we can try for Result there, we can try that out tonight as well</p>",
        "id": 214608562,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603734181
    },
    {
        "content": "<p>I pushed a fixup with the comments. </p>\n<p>Also just read the return type here, <a href=\"https://github.com/sexxi-goose/rust/blob/master/compiler/rustc_mir/src/borrow_check/universal_regions.rs#L118-L128\">https://github.com/sexxi-goose/rust/blob/master/compiler/rustc_mir/src/borrow_check/universal_regions.rs#L118-L128</a></p>\n<p>This should solve the opaque tys problem but I'm not 100% sure how this works + this would add an additional dependency on rustc_middle.</p>\n<p>I can do a take-3 on a fix here tomorrow, using this approach with Eiterh</p>",
        "id": 214663167,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603777327
    },
    {
        "content": "<p>Actually does it work out because the type returned from the match is Either&lt;imp Iter, Either &lt;impl Iter, impl Iter&gt;&gt; which kind of allows us to have 3 different iterators there. </p>\n<p>and the implementation of Iterator kind of handles the part of dealing with Iterators being in left of right. It's pretty neatly  done with macros <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span></p>",
        "id": 214663636,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603778184
    },
    {
        "content": "<p>Just finished this, but here is PR with modified upvars_ty which returns empty iterator. If tests fail and we need to handle things more properly in some places I'll convert this into a result. <a href=\"https://github.com/rust-lang/rust/pull/78432\">https://github.com/rust-lang/rust/pull/78432</a></p>",
        "id": 214667061,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603783062
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> left a comment on that PR, but I couldn't quite tell whether it is meant as an alternative to <a href=\"https://github.com/rust-lang/rust/pull/78392\">https://github.com/rust-lang/rust/pull/78392</a> ?</p>",
        "id": 214695915,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603803977
    },
    {
        "content": "<p>(I think it could be)</p>",
        "id": 214695921,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603803981
    },
    {
        "content": "<p>that would work, not sure why I disregarded this idea earlier</p>",
        "id": 214721350,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603814417
    },
    {
        "content": "<p>Fyi we pushed a fix-up last night <span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span></p>",
        "id": 214861790,
        "sender_full_name": "Aman Arora",
        "timestamp": 1603902396
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> i r+'d <a href=\"https://github.com/rust-lang/rust/issues/78432\">#78432</a></p>",
        "id": 214890489,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1603915449
    },
    {
        "content": "<p>So the fix seems to have improved some benchmarks <a href=\"https://github.com/rust-lang/rust/pull/78432#issuecomment-721388323\">https://github.com/rust-lang/rust/pull/78432#issuecomment-721388323</a></p>",
        "id": 215514027,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604440082
    },
    {
        "content": "<p>Also this PR had another ICE, I have a fix here: <a href=\"https://github.com/rust-lang/rust/pull/78725\">https://github.com/rust-lang/rust/pull/78725</a></p>\n<p>I'm concerned that this might not be future proof, since someone can call upvar_tys without having read the updated docs. </p>\n<p>We had kind of discussed this previously, something around, adding an API to infcx to do the shallow_resolve before calling upvar_tys. If it's an inference variable it returns an empty iterator.</p>\n<p>Maybe we replace upvar_tys with that across the compiler. I haven't gotten a to check if this possible everywhere (i.e. we have access to infcx everywhere)</p>",
        "id": 215566181,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604487510
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> I <a href=\"https://github.com/rust-lang/rust/pull/78725#issuecomment-721741228\">left a comment</a> here -- in general I'd prefer to rewrite things to operate on <code>tupled_upvars_ty</code> where we can, as that is just more robust</p>",
        "id": 215581894,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604497654
    },
    {
        "content": "<p>I think there are many places we can</p>",
        "id": 215581903,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604497660
    },
    {
        "content": "<p>Yeah I think the regression happened because we were trying to move towards tupled_upvar_tys but missed to remove the upvar_tys call</p>",
        "id": 215622580,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604514706
    },
    {
        "content": "<p>I was reviewing the video from yesterday and you had mentioned that you'll be sharing some pattern that might be useful for work that needs to be done for the fix here. Just posting this here as a reminder for that</p>",
        "id": 215915282,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604703913
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> hmm I'm not sure what I meant :P</p>",
        "id": 216091067,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604932298
    },
    {
        "content": "<p>do you remember more specifically what problem we were trying to address?</p>",
        "id": 216091190,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604932353
    },
    {
        "content": "<p>We were discussing using tupled_upvar_tys everywhere possible</p>",
        "id": 216104948,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604937911
    },
    {
        "content": "<p>Instead of upvar_tys</p>",
        "id": 216105003,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604937939
    },
    {
        "content": "<p>You mentioned that it was based on another pr you reviewed on Thursday</p>",
        "id": 216111089,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604940410
    },
    {
        "content": "<p>hmm</p>",
        "id": 216124546,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604946297
    },
    {
        "content": "<p>so I left a comment on some PR about this</p>",
        "id": 216124553,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604946302
    },
    {
        "content": "<p>is that what you mean?</p>",
        "id": 216124574,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604946314
    },
    {
        "content": "<p><a href=\"https://youtu.be/-8simqmm8t4\">https://youtu.be/-8simqmm8t4</a></p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"-8simqmm8t4\" href=\"https://youtu.be/-8simqmm8t4\"><img src=\"https://i.ytimg.com/vi/-8simqmm8t4/default.jpg\"></a></div>",
        "id": 216124820,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604946442
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span> first 30secs-1min here</p>",
        "id": 216124838,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604946456
    },
    {
        "content": "<p>I think what you were going for was a way for making sure no more issues pop up around upvar_tys</p>",
        "id": 216124926,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604946493
    },
    {
        "content": "<p>yeah ok I think I was thinking that <code>upvar_tys</code> could return a <code>Result</code></p>",
        "id": 216125227,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604946659
    },
    {
        "content": "<p>or just an empty iterator</p>",
        "id": 216125235,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604946666
    },
    {
        "content": "<p>the latter is easier but a bit less \"safe\"</p>",
        "id": 216125257,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1604946672
    },
    {
        "content": "<p>When it's an Infer?</p>",
        "id": 216125275,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604946682
    },
    {
        "content": "<p>We already return empty if it's error, we bug on ty:: Infer</p>",
        "id": 216125398,
        "sender_full_name": "Aman Arora",
        "timestamp": 1604946716
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span> ^</p>",
        "id": 216381004,
        "sender_full_name": "Aman Arora",
        "timestamp": 1605119057
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> Ah. I would expect us to continue to <code>bug!</code> on things besides tuple and err</p>",
        "id": 216387882,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1605122694
    },
    {
        "content": "<p>since it should not be used when inference variables are a possibility</p>",
        "id": 216387894,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1605122702
    },
    {
        "content": "<p>ok, sounds good</p>",
        "id": 216388519,
        "sender_full_name": "Aman Arora",
        "timestamp": 1605123082
    },
    {
        "content": "<p>Roxane pushed the fix. This was a stable -&gt; nightly regression and we cut beta recently. Do we want to beta backport this?</p>",
        "id": 217363966,
        "sender_full_name": "Aman Arora",
        "timestamp": 1605849950
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281950\">@Aman Arora</span> where was the fix pushed?</p>",
        "id": 217465287,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1605910220
    },
    {
        "content": "<p>the PR itself</p>",
        "id": 217465315,
        "sender_full_name": "Aman Arora",
        "timestamp": 1605910239
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/pull/78725\">https://github.com/rust-lang/rust/pull/78725</a></p>",
        "id": 217465362,
        "sender_full_name": "Aman Arora",
        "timestamp": 1605910281
    },
    {
        "content": "<p>nvm there is a merge conflict, lemme ask her to take a look again</p>",
        "id": 217466077,
        "sender_full_name": "Aman Arora",
        "timestamp": 1605910745
    },
    {
        "content": "<p>Also <span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span>  can take a look again at  this PR? Thanks</p>",
        "id": 218359118,
        "sender_full_name": "Aman Arora",
        "timestamp": 1606777478
    }
]