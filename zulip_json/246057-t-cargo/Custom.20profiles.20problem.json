[
    {
        "content": "<p>I just updated to 1.57.0 and I'm seeing unexpected behaviour changes. I'm wondering if it's a bug related to custom profiles.</p>",
        "id": 263538821,
        "sender_full_name": "nnethercote",
        "timestamp": 1638510817
    },
    {
        "content": "<p>My crates has this in the <code>Cargo.toml</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code># This profile is used for `cargo test --release`, and some tests depend on\n# having debug info.\n[profile.bench]\ndebug = 1\n</code></pre></div>",
        "id": 263538826,
        "sender_full_name": "nnethercote",
        "timestamp": 1638510832
    },
    {
        "content": "<p>The tests mentioned by the comment are passing with 1.56.0, and failing with 1.57.0.</p>",
        "id": 263538902,
        "sender_full_name": "nnethercote",
        "timestamp": 1638510913
    },
    {
        "content": "<p>The repo is <a href=\"https://github.com/nnethercote/dhat-rs/tree/dhat-0.3\">https://github.com/nnethercote/dhat-rs/tree/dhat-0.3</a>. (Note that's a non-master branch.)</p>",
        "id": 263539023,
        "sender_full_name": "nnethercote",
        "timestamp": 1638511078
    },
    {
        "content": "<p>When I run <code>cargo test --release -vv</code> with 1.56 I see lots of <code>-C debuginfo=1</code> in the output, I don't see that with 1.57.0.</p>",
        "id": 263539423,
        "sender_full_name": "nnethercote",
        "timestamp": 1638511464
    },
    {
        "content": "<p>I found <a href=\"https://github.com/rust-lang/cargo/issues/6988#issuecomment-888991198\">https://github.com/rust-lang/cargo/issues/6988#issuecomment-888991198</a>, which seems relevant: \"turns out my bug was depending on lto specifically, and, when two profiles are active (cargo test --release), lto is implicitly disabled when it's not enabled in at least one profile.\"</p>",
        "id": 263539619,
        "sender_full_name": "nnethercote",
        "timestamp": 1638511730
    },
    {
        "content": "<p>Anyway, it's very unclear to me if this is an intended behaviour change. As the comment in the <code>Cargo.toml</code> makes clear, my goal here is to build tests with debug info for both debug and release.</p>",
        "id": 263539797,
        "sender_full_name": "nnethercote",
        "timestamp": 1638511949
    },
    {
        "content": "<p><a href=\"https://doc.rust-lang.org/cargo/reference/profiles.html#bench\">https://doc.rust-lang.org/cargo/reference/profiles.html#bench</a> says</p>\n<blockquote>\n<p>The bench profile is used for building benchmarks, or when tests are built with the --release flag.</p>\n</blockquote>",
        "id": 263539876,
        "sender_full_name": "nnethercote",
        "timestamp": 1638512075
    },
    {
        "content": "<p>But <a href=\"https://doc.rust-lang.org/cargo/reference/profiles.html#profile-selection\">https://doc.rust-lang.org/cargo/reference/profiles.html#profile-selection</a> says (my emphasis):</p>\n<blockquote>\n<p>The default profile if none is specified is:</p>\n<ul>\n<li>Build commands like cargo build, cargo rustc, cargo check, and cargo run: dev profile</li>\n<li><strong>cargo test: test profile</strong></li>\n<li>cargo bench: bench profile</li>\n<li>cargo install: release profile</li>\n</ul>\n</blockquote>",
        "id": 263539916,
        "sender_full_name": "nnethercote",
        "timestamp": 1638512134
    },
    {
        "content": "<p>Those two sections disagree?</p>",
        "id": 263540023,
        "sender_full_name": "nnethercote",
        "timestamp": 1638512282
    },
    {
        "content": "<p>I tried adding <code>[profile.test] debug = 1</code>, but with that <code>cargo test --release</code> still fails on 1.57.0.</p>",
        "id": 263540080,
        "sender_full_name": "nnethercote",
        "timestamp": 1638512320
    },
    {
        "content": "<p>Then I tried adding this instead:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[profile.foo]</span>\n<span class=\"n\">inherits</span> <span class=\"o\">=</span> <span class=\"s\">\"test\"</span>\n<span class=\"n\">debug</span> <span class=\"o\">=</span> <span class=\"mi\">1</span>\n</code></pre></div>\n<p>And then <code>cargo test --profile=foo</code> works. But I'd rather just type <code>cargo test --release</code>...</p>",
        "id": 263540178,
        "sender_full_name": "nnethercote",
        "timestamp": 1638512430
    },
    {
        "content": "<p>Aha! <a href=\"https://doc.rust-lang.org/cargo/commands/cargo-test.html#compilation-options\">https://doc.rust-lang.org/cargo/commands/cargo-test.html#compilation-options</a> says:</p>\n<blockquote>\n<p>--release<br>\n   Test optimized artifacts with the release profile. </p>\n</blockquote>\n<p>And I tried adding <code>[profile.release] debug = 1</code> and now <code>cargo test --release</code> succeeds with 1.57.0.</p>",
        "id": 263540394,
        "sender_full_name": "nnethercote",
        "timestamp": 1638512717
    },
    {
        "content": "<p>So it's clear the behaviour has changed, and I've found three places in the docs that all say different things about which profile is used for <code>cargo test --release</code>.</p>",
        "id": 263540413,
        "sender_full_name": "nnethercote",
        "timestamp": 1638512753
    },
    {
        "content": "<p>The very confusing behavior about what happens to dependencies of tests in release, was changed to be more compatible with custom profiles and to make more sense. The fact that our docs are inconsistent and incorrect, is definitely a bug.</p>",
        "id": 263598245,
        "sender_full_name": "Eh2406",
        "timestamp": 1638546696
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120989\">@nnethercote</span> Sorry about the confusion. I have posted <a href=\"https://github.com/rust-lang/cargo/pull/10153\">https://github.com/rust-lang/cargo/pull/10153</a> with a fix to the docs.</p>",
        "id": 263617869,
        "sender_full_name": "Eric Huss",
        "timestamp": 1638555483
    },
    {
        "content": "<p>Thanks, that's a clear improvement.</p>\n<p>Is this an accurate thing to put in my Cargo.toml file?</p>\n<div class=\"codehilite\"><pre><span></span><code># Some tests require debug info. `cargo test` always enables debug info, but\n# `cargo test --release` does not, so we enable it here. In Rust 1.56 and\n# earlier, `profile.bench` was used for `cargo test --release`. In Rust 1.57\n# and later, `profile.release` is used instead. So we specify both.\n[profile.bench]\ndebug = 1\n[profile.release]\ndebug = 1\n</code></pre></div>",
        "id": 263658459,
        "sender_full_name": "nnethercote",
        "timestamp": 1638568591
    },
    {
        "content": "<p>Yea, that seems right.</p>",
        "id": 263660318,
        "sender_full_name": "Eric Huss",
        "timestamp": 1638569609
    },
    {
        "content": "<p>Ok, thank you. I guess an alternative would be to specify 1.57 as the minimum version.</p>",
        "id": 263785877,
        "sender_full_name": "nnethercote",
        "timestamp": 1638734162
    }
]