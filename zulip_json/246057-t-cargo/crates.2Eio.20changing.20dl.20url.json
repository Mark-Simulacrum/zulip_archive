[
    {
        "content": "<p>hey cargo team!</p>",
        "id": 265175166,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639669742
    },
    {
        "content": "<p>the <a href=\"http://crates.io\">crates.io</a> team is making some changes to improve its resiliency to aws or heroku outages (prompted by the recent aws outage), and to add new ways for on-call people to mitigate outages</p>",
        "id": 265175271,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639669796
    },
    {
        "content": "<p>the full plan is in <a href=\"https://github.com/rust-lang/crates.io/issues/4282\">https://github.com/rust-lang/crates.io/issues/4282</a> if y'all are curious, but there's a specific piece I'd love feedback from y'all on</p>",
        "id": 265175372,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639669818
    },
    {
        "content": "<p>namely, we're adding a way for on-call operators to change the <code>dl</code> key of <code>config.json</code>, allowing them to bypass the faulty piece of infrastructure and keeping downloads going</p>",
        "id": 265175469,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639669864
    },
    {
        "content": "<p>(pointing to the cdn if ec2/heroku is down, to the primary s3 bucket if the cdn is down, or the new fallback s3 bucket if the primary s3 bucket and the cdn are both down)</p>",
        "id": 265175568,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639669903
    },
    {
        "content": "<p>this shouldn't be a problem for CIs, as they clone a fresh index every time (getting the new <code>config.json</code>), but I'm wondering about developers on their machines</p>",
        "id": 265175741,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639669953
    },
    {
        "content": "<p>my understanding is that cargo won't update the index if it just needs to download crates that are already in the index and there's no need to do dependency resolution, is that correct?</p>",
        "id": 265176005,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670057
    },
    {
        "content": "<p>now I'm wondering if and how we can make that experience better for users on the cargo side</p>",
        "id": 265176096,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670100
    },
    {
        "content": "<p>Yes, so in that case it won't notice the change of URL. But it also wouldn't have noticed the outage.</p>",
        "id": 265176121,
        "sender_full_name": "Eh2406",
        "timestamp": 1639670114
    },
    {
        "content": "<p>sorry, with \"crates in the index\" I meant crates that are referenced in the local copy of the index but are not locally cached</p>",
        "id": 265176196,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670149
    },
    {
        "content": "<p>so it should fail when it tries to download them from <a href=\"http://crates.io\">crates.io</a></p>",
        "id": 265176282,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670166
    },
    {
        "content": "<p>it's correct yeah that the index is not updated in some situations, namely you have <code>Cargo.lock</code> but you haven't downloaded all the packages</p>",
        "id": 265176331,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1639670187
    },
    {
        "content": "<p>and the current state of the index has all the packages in <code>Cargo.lock</code></p>",
        "id": 265176354,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1639670198
    },
    {
        "content": "<p>so, whenever we're going to update the <code>dl</code> url we'll also have to update the status page, so we can say \"run this command to update the index\" in the status page update</p>",
        "id": 265176554,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670273
    },
    {
        "content": "<p>I believe so, yeah, although.... I dunno what that command is</p>",
        "id": 265176740,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1639670344
    },
    {
        "content": "<p>other than like <code>cargo install nonexistent-package</code></p>",
        "id": 265176753,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1639670350
    },
    {
        "content": "<p>Or <code>cargo update --dry-run</code>?</p>",
        "id": 265176974,
        "sender_full_name": "bjorn3",
        "timestamp": 1639670421
    },
    {
        "content": "<p>would such a command be feasible to implement?</p>",
        "id": 265176981,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670422
    },
    {
        "content": "<p>oh <code>cargo update --dry-run</code> is good!</p>",
        "id": 265177131,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670491
    },
    {
        "content": "<p>I don't think that works if you don't actually have any <a href=\"http://crates.io\">crates.io</a> dependencies, e.g. if you run that in an empty project it won't do anything</p>",
        "id": 265177171,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1639670519
    },
    {
        "content": "<p>hmm</p>",
        "id": 265177284,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670569
    },
    {
        "content": "<p>that's true of any solution within cargo, there's not really a great way to say \"please go update the <a href=\"http://crates.io\">crates.io</a> index\" in cargo's model of interpretation of sources</p>",
        "id": 265177363,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1639670624
    },
    {
        "content": "<p>We could say that you need to run <code>cargo update --dry-run</code> inside the project which failed to download crates.</p>",
        "id": 265177388,
        "sender_full_name": "bjorn3",
        "timestamp": 1639670639
    },
    {
        "content": "<p>would a <code>cargo update-git-indexes</code> command be feasible to implement?</p>",
        "id": 265177556,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670699
    },
    {
        "content": "<p>(that would also be nice for rustwide btw)</p>",
        "id": 265177598,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639670720
    },
    {
        "content": "<p>cargo doesn't really have a notion of \"iterate over all the registry sources\", it could perhaps have something very specific for <a href=\"http://crates.io\">crates.io</a></p>",
        "id": 265177970,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1639670865
    },
    {
        "content": "<p>but... again none of this really fits within cargo's model of sources, not to say it can't be done just that it's wierd</p>",
        "id": 265178047,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1639670886
    },
    {
        "content": "<p>hmm ok</p>",
        "id": 265178333,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639671009
    },
    {
        "content": "<p>then I think the best way would be to just recommend people to run <code>cargo install empty-library</code>, noting it's expected it would fail</p>",
        "id": 265178373,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639671025
    },
    {
        "content": "<p>What if we generalized the command to be <code>cargo registry</code> with <code>cargo registry --update</code> (updates registry), <code>cargo registry --download pkgid</code> (forces downloading of a package) and <code>cargo registry --locate pkdid</code> (tells where a downloaded package is on disk)</p>\n<p>This would give us the option to call <code>cargo registry</code> like <code>cargo metadata</code> instead of having to split out the registry logic for cargo subcommands to reuse.</p>\n<p>The download and locate are more for some analysis I want to do and can be added later :)</p>",
        "id": 265178440,
        "sender_full_name": "Ed Page",
        "timestamp": 1639671061
    },
    {
        "content": "<p>I don't really want to make the implementation too complex for this, as I expect we will need to exercise this capability <em>extremely</em> rarely (we never had an aws outage affecting us ever so far)</p>",
        "id": 265178526,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639671104
    },
    {
        "content": "<p>(look at how badly I jinxed it now, well, at least <strong><em>I</em></strong> am not on-call during the holidays)</p>",
        "id": 265178533,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639671111
    },
    {
        "content": "<p>(watching all these messes and so glad I'm not on call)</p>",
        "id": 265178729,
        "sender_full_name": "Eh2406",
        "timestamp": 1639671190
    },
    {
        "content": "<p>We've had requests like this a number of times.</p>",
        "id": 265178769,
        "sender_full_name": "Eh2406",
        "timestamp": 1639671213
    },
    {
        "content": "<p>Mostly by people who want to be able to do name search without network access.</p>",
        "id": 265178852,
        "sender_full_name": "Eh2406",
        "timestamp": 1639671243
    },
    {
        "content": "<p>Should it be <code>cargo install rustc</code> or another reserved crate? That would avoid someone registering <code>empty-library</code> and eg put a fake rustc executable in it.</p>",
        "id": 265178870,
        "sender_full_name": "bjorn3",
        "timestamp": 1639671257
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133247\">bjorn3</span> <a href=\"#narrow/stream/246057-t-cargo/topic/crates.2Eio.20changing.20dl.20url/near/265178870\">said</a>:</p>\n<blockquote>\n<p>Should it be <code>cargo install rustc</code> or another reserved crate? That would avoid someone registering <code>empty-library</code> and eg put a fake rustc executable in it.</p>\n</blockquote>\n<p>empty-library is reserved :)</p>",
        "id": 265179227,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639671410
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120179\">Eh2406</span> <a href=\"#narrow/stream/246057-t-cargo/topic/crates.2Eio.20changing.20dl.20url/near/265178729\">said</a>:</p>\n<blockquote>\n<p>(watching all these messes and so glad I'm not on call)</p>\n</blockquote>\n<p>hey at least now I'm paid when I'm actually on-call <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 265179300,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639671439
    },
    {
        "content": "<p>it wasn't that much fun when me and justin were doing it completely unpaid</p>",
        "id": 265179352,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639671469
    },
    {
        "content": "<p>\"If you're getting paged you should be paid.\"<br>\nI said it repeatedly to anyone who would listen (including Shane). Not that I have a lot of influence.</p>",
        "id": 265179765,
        "sender_full_name": "Eh2406",
        "timestamp": 1639671616
    },
    {
        "content": "<p>heh agreed</p>",
        "id": 265179839,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639671662
    },
    {
        "content": "<p>It would also be nice if someone tested that cargo works correctly when the <code>dl</code> url changes.<br>\nLike:</p>\n<ul>\n<li>use source replacement too point at a personal copy of the index</li>\n<li>build a project with a significant number of dependencies</li>\n<li>change the personal copy of the index to have a different <code>dl</code> url .</li>\n<li>add 1 dependency to the project. make sure that cargo downloads only the one file, and does not rebuild the world.</li>\n</ul>\n<p>I think this should work, but we should check.</p>",
        "id": 265182343,
        "sender_full_name": "Eh2406",
        "timestamp": 1639672737
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120179\">@Eh2406</span> I landed the infra to change the <code>dl</code> url on the staging index already</p>",
        "id": 265182454,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639672787
    },
    {
        "content": "<p>if you want to test with a real index</p>",
        "id": 265182542,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639672811
    },
    {
        "content": "<p>(or well, I can test it in the coming days)</p>",
        "id": 265182647,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639672856
    },
    {
        "content": "<p>I don't think it's critical, re downloading and rebuilding the world is better then an outage. but it would be nice if somebody checked.</p>",
        "id": 265182976,
        "sender_full_name": "Eh2406",
        "timestamp": 1639672965
    },
    {
        "content": "<p>IIRC (<a href=\"https://github.com/rust-lang/cargo/issues/7617\">https://github.com/rust-lang/cargo/issues/7617</a>), changing <code>config.json</code> doesn't currently work.</p>",
        "id": 265210245,
        "sender_full_name": "Eric Huss",
        "timestamp": 1639684333
    },
    {
        "content": "<p>worst case we can recommend to remove the index directory</p>",
        "id": 265216788,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639687432
    },
    {
        "content": "<p>Um... <a href=\"https://www.cloudflarestatus.com/\">https://www.cloudflarestatus.com/</a></p>",
        "id": 265217424,
        "sender_full_name": "Eh2406",
        "timestamp": 1639687729
    },
    {
        "content": "<p>(we're on cloudfront, not cloudflare, still, hugops)</p>",
        "id": 265217773,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639687908
    },
    {
        "content": "<p>Sorry got my wires crossed.</p>",
        "id": 265218110,
        "sender_full_name": "Eh2406",
        "timestamp": 1639688057
    },
    {
        "content": "<p>that would've been perfect timing tho</p>",
        "id": 265218744,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1639688362
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> I think you meant to respond to the changing dl url topic?</p>\n<p>If you are referring to <a href=\"https://github.com/rust-lang/cargo/issues/7617\">cargo#7617</a>, that issue is that you have to run cargo twice for it to work (the first time it uses the wrong value).  If you <code>rm -rf</code>, that will also wipe out the cache.</p>",
        "id": 265575684,
        "sender_full_name": "Eric Huss",
        "timestamp": 1640013258
    },
    {
        "content": "<p>woops <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 265575737,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1640013286
    },
    {
        "content": "<p>changed topic</p>",
        "id": 265575771,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1640013299
    },
    {
        "content": "<p>oooh ok I think I know what you mean</p>",
        "id": 265575809,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1640013311
    },
    {
        "content": "<p>the <code>cargo</code> invocation <em>that updated the index</em> won't reflect the changes in <code>config.json</code></p>",
        "id": 265575862,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1640013338
    },
    {
        "content": "<p>but any following invocation will</p>",
        "id": 265575880,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1640013347
    },
    {
        "content": "<p>so if we tell people to run</p>\n<div class=\"codehilite\"><pre><span></span><code>cargo install empty-library\n</code></pre></div>\n<p>that's all good because that command will update the index, fail as expected and then people will be able to use <code>cargo</code> normally</p>",
        "id": 265575984,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1640013383
    },
    {
        "content": "<p>is my understanding correct?</p>",
        "id": 265576002,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1640013391
    },
    {
        "content": "<p>I think so? </p>\n<p>I'm also a bit confused as to why it isn't working.  It looks like it reloads the config after an update.</p>",
        "id": 265579250,
        "sender_full_name": "Eric Huss",
        "timestamp": 1640014911
    },
    {
        "content": "<p>anyway, the current behavior is enough for what we need to handle incidents</p>",
        "id": 265579463,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1640015013
    },
    {
        "content": "<p>thanks for all the feedback!</p>",
        "id": 265579486,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1640015022
    }
]