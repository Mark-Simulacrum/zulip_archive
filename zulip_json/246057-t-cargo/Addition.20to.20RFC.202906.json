[
    {
        "content": "<p>Handling finding a workspace for Inheritable Fields is one part of what makes this RFC tough. Since we are taking a process that typically is linear and making it stop and search for things it adds a lot of complexity. To mitigate some of this I think it would be good to make users of <code>{ workspace = true }</code> define the workspace they pull from in <code>[package]</code>, or make it so only defined members of a <code>[workspace]</code> can inherit from that workspace. Requireing both of theses things could be good as well.</p>\n<p>The first idea would probably be the better option if we are only doing one. This is because it would make the time spent looking for a workapce almost zero, the workspace is either there or it is not. To reduce constantly parsing the same file you would just have a cache of <code>&lt;Path, InheritableFields&gt;</code>.  This idea might cause issues with a <code>Cargo.toml</code> that defines both a <code>[workspace]</code> and a <code>[package]</code> as you cannot have both of these things and <code>package.workspace</code> defined in one toml, but we could work around that with minimal effort.</p>\n<p>The second idea would require us to search for a root workspace but if we add an extra cache for <code>&lt;member path, workspace path&gt;</code>, we would only search once for each workspace (for the most part). This would run slightly longer than the first as we would have to search for a workspace as well as use slightly more memory if there are lots of workspaces with lots of members for some reason.</p>\n<p>I personally like requiring both since it would lower the burden of implementation as well as could have benefits to <code>cargo add</code> down the line. This could be a temporary requirement while we are implementing the whole RFC, but it also wouldn't be a bad idea to leave it in as it would be less to maintain.</p>",
        "id": 276643837,
        "sender_full_name": "Muscraft",
        "timestamp": 1648225317
    },
    {
        "content": "<p>The second seems like the smallest change for people using this, since they <em>already</em> need to list the package in the workspace.</p>",
        "id": 276645758,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1648226162
    },
    {
        "content": "<p>Part of the goal here is convenience; if we require adding something else that isn't currently required then that would make this feature less convenient to use.</p>",
        "id": 276645855,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1648226204
    },
    {
        "content": "<p>I'm not a fan of having to specify the workspace.  I keep my workspace management simple by just doing a <code>crates/*</code> in my workspace.  I'd rather not have to manage extra links in the process.</p>",
        "id": 276650355,
        "sender_full_name": "Ed Page",
        "timestamp": 1648228166
    },
    {
        "content": "<p>In that case should we just leave everything the same as the RFC?</p>",
        "id": 276652342,
        "sender_full_name": "Muscraft",
        "timestamp": 1648229096
    },
    {
        "content": "<p>If so, I think it will require at least one cache (<code>&lt;WS Path, InheritableFields&gt;</code>) but the member one (<code>&lt;member path, workspace path&gt;</code>) might be a nice addition as well</p>",
        "id": 276653022,
        "sender_full_name": "Muscraft",
        "timestamp": 1648229313
    },
    {
        "content": "<p>Having such a cache seems perfectly reasonable.</p>",
        "id": 276654708,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1648230010
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"239881\">Josh Triplett</span> <a href=\"#narrow/stream/246057-t-cargo/topic/Addition.20to.20RFC.202906/near/276654708\">said</a>:</p>\n<blockquote>\n<p>Having such a cache seems perfectly reasonable.</p>\n</blockquote>\n<p>Where do you think this should be located? Last time we talked about putting it in <code>Config</code> but I know that it's not supposed to be specific to a build</p>",
        "id": 276655882,
        "sender_full_name": "Muscraft",
        "timestamp": 1648230605
    },
    {
        "content": "<p>I think we need to look at this again. Requiring users of <code>{ workspace = true }</code> to define the workspace they pull from in <code>[package]</code>, while it may make this feature less convenient, it makes the implementation significantly easier. Currently, all of the solutions I have come up with can cause multiple parsing of a manifest while searching for a workspace root. This is mostly down to not being able to save the manifests we have parsed while searching for a workspace root.</p>\n<p>Currently, they call</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">packages</span><span class=\"p\">.</span><span class=\"n\">load</span><span class=\"p\">(</span><span class=\"n\">manifest_path</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"w\"></span>\n</code></pre></div>\n<p>which would then parse the manifest and if it stated <code>workspace = true</code> anywhere it would go and search for a workspace itself. This wouldn't complete until you find a workspace root or throw an error. Depending on how you search for a workspace root in <code>to_real_manifest</code> it would cause cargo to parse the same manifest many times while searching. Since we do not have access to<code>self.packages</code> we cannot update manifests we have parsed while searching inside <code>to_real_manifest</code>.</p>\n<p>If anyone has suggestions on how we should go about this I would appreciate the help!</p>",
        "id": 276928747,
        "sender_full_name": "Muscraft",
        "timestamp": 1648500243
    },
    {
        "content": "<p>Not sure about others, but I'd focus first on having a working implementation and them work on speeding it up, so long as we are not impacting performance without this feature.</p>",
        "id": 276931036,
        "sender_full_name": "Ed Page",
        "timestamp": 1648501450
    },
    {
        "content": "<p>I think it should logically be possible to cache the discovered workspace root. If that's currently difficult, that seems like an implementation issue.</p>",
        "id": 276932664,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1648502259
    },
    {
        "content": "<p>And one we should fix.</p>",
        "id": 276932673,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1648502265
    },
    {
        "content": "<p>I was slightly mistaken about how <code>paths::ancestors</code> worked and assumed it would search in folders but that's not the case. That caused some confusion about how often things get parsed but even then it could still be more than 0. That being said we can cache a workspace root, it's more about doing it in a good way, which I will work on. I think it will require something to track inheritable fields (<code>HashMap&lt;PathBuf, InheritableFields&gt;</code>(We have this currently)). That is the cache for workspace path to inheritable fields but it doesn't catch cases of ws/foo/bar. Where foo is a folder and has a <code>Cargo.toml</code>. I think it would require another <code>HashMap&lt;PathBuf, Pathbuf&gt;</code> but this time for package root -&gt; workspace root. Most of these issues are so small they wouldn't happen that often but it is still good to design for. I assume most workspace setups are ws/folder of crates. Which in this case would work with how I have it designed now without parsing anything multiple times.</p>",
        "id": 276937965,
        "sender_full_name": "Muscraft",
        "timestamp": 1648505950
    }
]