[
    {
        "content": "<p>I have a virtual workspace:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[workspace]</span>\n<span class=\"n\">members</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s\">\"a\"</span><span class=\"p\">,</span> <span class=\"s\">\"b\"</span><span class=\"p\">]</span>\n<span class=\"n\">resolver</span> <span class=\"o\">=</span> <span class=\"s\">\"2\"</span>\n</code></pre></div>\n<p><strong>A</strong> has a dependency on Tokio with feature <code>net</code>:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[dependencies]</span>\n<span class=\"n\">tokio</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"n\">version</span> <span class=\"o\">=</span> <span class=\"s\">\"1.0\"</span><span class=\"p\">,</span> <span class=\"n\">features</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s\">\"net\"</span><span class=\"p\">]</span> <span class=\"p\">}</span>\n</code></pre></div>\n<p>And <strong>B</strong> has the same dependency on Tokio with feature <code>time</code>:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[dependencies]</span>\n<span class=\"n\">tokio</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"n\">version</span> <span class=\"o\">=</span> <span class=\"s\">\"1.0\"</span><span class=\"p\">,</span> <span class=\"n\">features</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s\">\"time\"</span><span class=\"p\">]</span> <span class=\"p\">}</span>\n</code></pre></div>\n<p>When I build each crate, Tokio is rebuilt:</p>\n<div class=\"codehilite\"><pre><span></span><code>% cargo build -p a\n   Compiling libc v0.2.107\n   Compiling log v0.4.14\n   Compiling cfg-if v1.0.0\n   Compiling autocfg v1.0.1\n   Compiling pin-project-lite v0.2.7\n   Compiling tokio v1.14.0\n   Compiling mio v0.7.14\n   Compiling a v0.1.0 (/private/tmp/ws/a)\n    Finished dev [unoptimized + debuginfo] target(s) in 1.74s\n\n% cargo build -p b\n   Compiling tokio v1.14.0\n   Compiling b v0.1.0 (/private/tmp/ws/b)\n    Finished dev [unoptimized + debuginfo] target(s) in 0.62s\n</code></pre></div>\n<p>Is there a way to say \"I'd like to build Tokio only once for the workspace, enabling both features\"?</p>",
        "id": 261989907,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1637269225
    },
    {
        "content": "<p>not really. the traditional solution is something like <a href=\"https://searchfox.org/mozilla-central/source/build/workspace-hack/Cargo.toml\">https://searchfox.org/mozilla-central/source/build/workspace-hack/Cargo.toml</a> but</p>",
        "id": 261991001,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1637269741
    },
    {
        "content": "<p>it's definitely not ideal</p>",
        "id": 261991008,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1637269745
    },
    {
        "content": "<p>see also <a href=\"https://github.com/rust-lang/rust/tree/master/src/tools/rustc-workspace-hack\">https://github.com/rust-lang/rust/tree/master/src/tools/rustc-workspace-hack</a>, and i think servo has one too? there are definitely other crates as well</p>",
        "id": 261991233,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1637269847
    },
    {
        "content": "<p>Do you know if there's any tooling to help keep those master lists of features up-to-date as \"normal\" dependencies change?</p>",
        "id": 261991559,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1637270011
    },
    {
        "content": "<p>i'd love a way to specify this on the workspace in cargo.toml</p>",
        "id": 261991563,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1637270013
    },
    {
        "content": "<p>hm, i don't know of any. i think you could get the info you need to build such tooling out of <code>cargo metadata</code>, but i dont know if anybody's done it</p>",
        "id": 261991692,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1637270069
    },
    {
        "content": "<p>Ah, perhaps <a href=\"https://crates.io/crates/cargo-hakari\">https://crates.io/crates/cargo-hakari</a></p>",
        "id": 261992030,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1637270242
    }
]