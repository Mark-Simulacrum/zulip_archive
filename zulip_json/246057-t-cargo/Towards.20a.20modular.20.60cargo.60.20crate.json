[
    {
        "content": "<p>Is splitting up the monolithic <code>cargo</code> API welcome?  What pointers, suggestions, or requirements do people have before I get started?  Especially crate organization and naming so we can minimize churn later :)</p>\n<p><code>cargo</code> as-is has problems in being used as an API</p>\n<ul>\n<li>Slow to build</li>\n<li>Ties the <code>[[bin]]</code> to a specific version of for parsing <code>Cargo.toml</code>, leading to user-warnings (vs parsing with the user's current cargo version)</li>\n<li>Hard to navigate to find functionality or figure out how to adapt to one's needs</li>\n<li>Adds just enough friction to the process, people duplicate the behavior in their own crates, rather than reuse (e.g. <a href=\"https://github.com/rust-lang/rustfmt/issues/5010#issuecomment-929793411\">cargo-fmt</a>).</li>\n</ul>\n<p><code>cargo-add</code> is another example of this prob.  To <a href=\"https://github.com/rust-lang/cargo/issues/5586#issuecomment-924970579\">prepare cargo-add for merging</a>, I need fork it, rewrite it, re-test it, and then I cantry to get it merged.</p>\n<p>However, there has been a lot of interest over time in being able to use subsections of the monolithic cargo crate</p>\n<ul>\n<li><a href=\"https://github.com/rust-lang/cargo/issues/4614\">Issue #4614 Expose manifest.rs as a standalone crate</a><ul>\n<li>Handled by the third party <a href=\"https://crates.io/crates/cargo_toml\">cargo_toml</a></li>\n</ul>\n</li>\n<li>A message and metadata crate as discussed in <a href=\"https://github.com/rust-lang/cargo/issues/4614\">How can Cargo help #63</a></li>\n<li>Third-party <a href=\"https://crates.io/crates/cargo-lock\">cargo-lock</a> for reading the lock file</li>\n<li>Third-party <a href=\"https://github.com/crate-ci/clap-cargo\">clap-cargo</a> making it easier to have a native cargo-like CLI</li>\n<li>Third-party <a href=\"https://github.com/frewsxcv/rust-crates-index\">crates-index</a> for updating and reading the local registry index</li>\n<li>Just now a zulip topic on <a href=\"#narrow/stream/246057-t-cargo/topic/Cargo.20configuration.20crate\">the cargo config schema</a>.  How's that for timing!</li>\n</ul>\n<p>Instead of forking <code>cargo-add</code>, I could instead spend a little more time helping to make cargo more modular, allowing cargo-add to be incrementally improved and validated.</p>\n<p><code>cargo-add</code> would ideally have access to:</p>\n<ul>\n<li><code>cargo metadata</code> schema so it can make a switch over from a crate like <code>cargo_metadata</code> to cargo with ease<ul>\n<li>I say \"like <code>cargo_metadata</code>\" because I do no want to prescribe for <code>cargo_metadata</code> design decisions that might need to differ (e.g. <code>cargo_metadata</code> uses the <code>camino</code> crate for UTF-8 paths)</li>\n<li>This does get into compatibility issues.  One idea I've been playing with with my crates is allowing <code>#[non_exhaustive]</code> to be disabled with a feature flag <code>unstable</code> and having other crates in my workspace enable <code>unstable</code> while pinning the version with a <code>=</code> requirement.</li>\n</ul>\n</li>\n<li>An equivalent of <code>clap-cargo</code><ul>\n<li>I would first start this out with minimal logic, just the ability to define arguments and read the values, typed.  As this overall effort progresses, we can find ways to ease reuse of CLI logic, like <code>--workspace</code> / <code>--package</code> / <code>--exclude</code> selection</li>\n</ul>\n</li>\n<li>An equivalent of <code>crates-index</code> for updating and reading the local index<ul>\n<li>This has a lot of dependencies (types like PackageId, tools like InternString and file locks, config support, etc)</li>\n</ul>\n</li>\n</ul>\n<p>A big issue with all of proliferating the number of crates is release management but we now have <a href=\"https://github.com/crate-ci/cargo-release\">cargo-release</a>, <a href=\"https://lib.rs/crates/cargo-smart-release\">cargo-smart-release</a>, and <a href=\"https://github.com/pksunkara/cargo-workspaces\">cargo-workspace</a> as options to help.  I know at least for <code>cargo-release</code>, it will help by</p>\n<ul>\n<li>Release crates in a workspace in-order</li>\n<li>Uses standard package-selection arguments for controlling what will be released</li>\n<li>Reports what packaged files in a crate have changed since the last tag (I'd like to add commit summaries so you can try to look for breaking changes)</li>\n<li>Reports what crates depend on crates being released, in case you re-export types and need to bump major</li>\n<li>Can help <a href=\"https://github.com/crate-ci/cargo-release/blob/master/Cargo.toml#L21\">update changelog boilerplate</a></li>\n</ul>\n<p>Of course if there are more needs, we can find ways to help solve them.</p>",
        "id": 256591167,
        "sender_full_name": "Ed Page",
        "timestamp": 1633618520
    },
    {
        "content": "<p>That is a lot to chew on all at once.</p>",
        "id": 256594077,
        "sender_full_name": "Eh2406",
        "timestamp": 1633619412
    },
    {
        "content": "<p>The fundamental problem is that cargo needs (or may need) something different from its API then other users. And the tools maintained by the cargo team need to be focused on cargos needs.</p>",
        "id": 256594386,
        "sender_full_name": "Eh2406",
        "timestamp": 1633619525
    },
    {
        "content": "<p>So far we have dealt with that tension by discouraging the use of the API. That has real costs as you have articulated.</p>",
        "id": 256594645,
        "sender_full_name": "Eh2406",
        "timestamp": 1633619620
    },
    {
        "content": "<p>One cost I didn't get into is that, as people here are probably aware :), crates-index is a surprisingly challenging problem and the crates-index maintainers have been punting on fixing it up to be parity with cargo (<a href=\"https://github.com/frewsxcv/rust-crates-index/issues/37\">one example</a>).</p>",
        "id": 256595180,
        "sender_full_name": "Ed Page",
        "timestamp": 1633619783
    },
    {
        "content": "<p>I can understand the tensions between Cargo's own needs and the rest of the ecosystem.  I have a hope, maybe foolish, that we can at least define subsets that work for both of us :).</p>",
        "id": 256595265,
        "sender_full_name": "Ed Page",
        "timestamp": 1633619819
    },
    {
        "content": "<p>For example we tried to do this for <a href=\"https://github.com/oli-obk/cargo_metadata/issues/63\">cargo_metadata</a>, after some discussion the first step was for cargo to maintain a crate describing the types. So that we could be sure that what was outputted by cargo and what read by the other libraries came from the same types. But this turned out to be harder than we imagined. cargo_metadata needs a type that can read the output of any version of cargo. Where as cargo only needs to be able to express the types it currently produces.<br>\nWhen cargo removed and output. Cargo just removes the line. cargo_metadata needs to make it an Option.<br>\nWhen cargo adds an output. Cargo just adds the line. cargo_metadata needs to make it an Option. (and in this case Cargo having and Option moves bugs from compile time to run time.)</p>",
        "id": 256596225,
        "sender_full_name": "Eh2406",
        "timestamp": 1633620151
    },
    {
        "content": "<p>I've been wondering hat happened to that conversation.  From my perspective, it seemed to just die off.</p>",
        "id": 256596392,
        "sender_full_name": "Ed Page",
        "timestamp": 1633620213
    },
    {
        "content": "<p>Ya, oops. Sorry.</p>",
        "id": 256596556,
        "sender_full_name": "Eh2406",
        "timestamp": 1633620264
    },
    {
        "content": "<p>So overall, the goal makes sense. I would love to see progress on it. But there are clear pressures that will need to be overcome to move out of the status quo.</p>",
        "id": 256598468,
        "sender_full_name": "Eh2406",
        "timestamp": 1633620908
    },
    {
        "content": "<p>Yeah I can't imagine anyone is <em>against</em> the idea of Cargo being more modular, it's more of that it's a pretty tricky problem. The Cargo team is small and making a crate with a great-to-use API with only a handful of people is extremely difficult. This would basically amount to adding more to the Cargo team's list of responsibilities which it's already barely keeping up with</p>",
        "id": 256602605,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1633622354
    },
    {
        "content": "<p>In that I can definitely imagine a point in the design space where a modular crate is great-to-use, but getting there and staying there requires a considerable amount of effort.</p>",
        "id": 256602663,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1633622376
    },
    {
        "content": "<p>Another issue with splitting it up more is that we currently can't use a workspace, and having multiple crates without a workspace can be annoying to use.</p>",
        "id": 256604017,
        "sender_full_name": "Eric Huss",
        "timestamp": 1633622834
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120518\">Eric Huss</span> <a href=\"#narrow/stream/246057-t-cargo/topic/Towards.20a.20modular.20.60cargo.60.20crate/near/256604017\">said</a>:</p>\n<blockquote>\n<p>Another issue with splitting it up more is that we currently can't use a workspace, and having multiple crates without a workspace can be annoying to use.</p>\n</blockquote>\n<p>Ouch.  How come?</p>",
        "id": 256604426,
        "sender_full_name": "Ed Page",
        "timestamp": 1633622991
    },
    {
        "content": "<p>It is nested in the <code>rust-lang/rust</code> workspace, and cargo doesn't allow nested workspaces.</p>",
        "id": 256604660,
        "sender_full_name": "Eric Huss",
        "timestamp": 1633623059
    },
    {
        "content": "<p>And splitting cargo up into an API workspace and the bins pulled into the Rust workspace would increase friction, further hurting the already strapped team (and might have other ramifications).</p>",
        "id": 256620652,
        "sender_full_name": "Ed Page",
        "timestamp": 1633629029
    },
    {
        "content": "<p>This is tough.  There is a clear community need and people are trying to fill it independently but combining of code bases doesn't necessarily lead to a combining of contributors.  People will see that its in rust-lang and will filter it out with a Somebody Else's Problem perceptual filter.  The only way I see this helping the cargo team is if it makes the code base easy to contribute to so that people who might have been discouraged by it  might be more willing to help out.</p>",
        "id": 256621275,
        "sender_full_name": "Ed Page",
        "timestamp": 1633629249
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"424212\">@Ed Page</span> So, one obvious possibility would be contributing nested workspace support. :)</p>",
        "id": 256645209,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1633638801
    },
    {
        "content": "<p>I think that would be widely used.</p>",
        "id": 256645240,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1633638820
    },
    {
        "content": "<p>and a lot of work.</p>",
        "id": 256645269,
        "sender_full_name": "Eh2406",
        "timestamp": 1633638841
    },
    {
        "content": "<p>No argument there.</p>",
        "id": 256645833,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1633639116
    },
    {
        "content": "<p>It feels like there are different styles of module here, and some would be more easily extracted than others - in particular, pulling out a <code>crates-index</code> (either so that cargo extracts its own code, or by merging with <code>crates-index</code>) as a standalone public crate which <code>cargo</code> could depend on seems relatively simple? It's a long-term stable serialisation format, which <code>cargo</code> could quite easily depend on, with probably the only fiddlyness being a handful of common types?</p>\n<p>AIUI the <code>cargo</code> crate itself currently is free to make incompatible changes in every minor release - perhaps a somewhat volatile (\"We're happy to do major version bumps whenever it suits <code>cargo</code>\") versioning policy would make extracting a common <code>crates-index</code> crate worthwhile?</p>\n<p>Concretely, right now we have two implementations, we suffer from the implementations being different, and <code>crates-index</code> is pretty happy to make breaking changes and bump versions accordingly. Given that, reducing that to one implementation, with the same breaking change frequency, doesn't feel too scary...</p>",
        "id": 256666136,
        "sender_full_name": "Daniel Wagner-Hall",
        "timestamp": 1633649512
    },
    {
        "content": "<p>For crates-index, I imagine one of the big concerns is continuing to meet cargo's performance requirements.  Most callers probably don't need the extra caching that cargo uses, so if we went below that layer, the performance requirements are probably not as strict, so long as the API is sufficient for cargo <em>and</em> everyone else.</p>\n<p>This also gets back to my other comment about \"who will maintain it going forward\"?  How much does cargo want to keep critical stuff in-house?  Will the current crates-index maintainers continue to contribute or will it just be \"somebody else's problem\" and all of the burden fall on the cargo team without any of the benefit (to them).</p>\n<p>All o the incentives in this are less than ideal.  I knew there was at least the hurdle of taking on the splitting work, which I am willing to take on, but I did not predict these other impacts and challenges.</p>",
        "id": 256669447,
        "sender_full_name": "Ed Page",
        "timestamp": 1633651771
    },
    {
        "content": "<p><code>crates-index</code> may indeed be workable, definitely worth thinking about.<br>\nIn addition to the performance point above, I can see two other things to think through.</p>\n<ol>\n<li><code>crates-index</code> API surface that Cargo does not need.  Like a non bare <a href=\"https://docs.rs/crates-index/0.17.0/crates_index/struct.Index.html\">Index</a>, and the iterators. </li>\n<li>What interface do we want for <a href=\"https://github.com/rust-lang/rfcs/blob/master/text/2789-sparse-index.md\">RFC 2789</a>, and is there an interface that works for Cargo and other users.</li>\n</ol>",
        "id": 256679924,
        "sender_full_name": "Eh2406",
        "timestamp": 1633660520
    },
    {
        "content": "<blockquote>\n<p>All o the incentives in this are less than ideal.</p>\n</blockquote>\n<p>We get plenty of \"why don't you just solve your technical debt by doing\" suggestions. Thank you for sticking around for the \"it is complicated\" conversations.</p>",
        "id": 256680154,
        "sender_full_name": "Eh2406",
        "timestamp": 1633660768
    },
    {
        "content": "<p>Let me summarize current situation. We are facing two possible blocker for a more modular <code>cargo</code> crate.</p>\n<ol>\n<li><strong>Support nested-workspace:</strong> This is a technical problem since <code>cargo</code>  is nested in <code>rust-lang/cargo</code>. Although the feature is considerably large, it still can follow the old way how other feature is implemented in Cargo. That means the RFC/feature authors dedicate an amount of time, and after that the maintenance work shifts to Cargo team.</li>\n<li><strong>Lack of longterm maintainer:</strong> This is the long lingering problem of cargo. Splitting crates introduce more compatibility works to do, more discussion and design need to perform. The situation won't be better until Cargo team seeks enough maintainers involving for longterm. I use <em>maintainer</em> here because I see a maintainer has more resposibilities upon the healthy of cargo project than a random bug hunter like me.</li>\n</ol>\n<p>In regard to modularizing <code>cargo</code> crate, the <a href=\"https://rust-lang.github.io/rfcs/3119-rust-crate-ownership.html\">\"Rust crate ownership policy\" RFC</a> comes up to my mind. I know it's just a postponence of the problem, but would it be possible to put them in \"Internal use\" or \"Experiment\" category that we can happily do modularization without considering compatibility? In that way, we may able to collect more discussion on the usecases, and attract maintainers since the mental burden looks relatively smaller than the whole cargo project (though they might still entangled with each others <span aria-label=\"disappointed\" class=\"emoji emoji-1f61e\" role=\"img\" title=\"disappointed\">:disappointed:</span>). Anyway, this would be the first step. </p>\n<p>I personally like to know to what level of the maintenance capacity is considered as \"good to go\" for a more modular cargo crate. Also, how a contributor reaches that level to be seen as a \"longterm helpful contributor\"? I know that no one commits to contribute Rust for lifetime and we're ok to leave at anytime. However, I can see the members of cargo team making their own commitment in mind for longterm maintenance, and I deeply appriciate that. It's not saying anything bad for a random expert popping up and fixing things. It is just that the team need to take its capacity into account, and people who want to contribute constantly need to know the how much effort they need to commit.</p>",
        "id": 256681804,
        "sender_full_name": "Weihang Lo",
        "timestamp": 1633662342
    },
    {
        "content": "<p>We do have some crates we maintain on the \"brakes whenever Cargo needs a change\" basses. <a href=\"https://github.com/rust-lang/cargo/tree/master/crates\"><code>cargo-platform, crates-io, cargo-credential-*</code></a>.</p>",
        "id": 256684693,
        "sender_full_name": "Eh2406",
        "timestamp": 1633665293
    },
    {
        "content": "<blockquote>\n<p>crates-index API surface that Cargo does not need. Like a non bare Index, and the iterators. </p>\n</blockquote>\n<p>At least non-bare index has been removed in <code>master</code>.  As a user of crates-index, all I care about is </p>\n<ul>\n<li>matches cargo's behavior</li>\n<li>allows me to walk the index according to my needs</li>\n</ul>",
        "id": 256742402,
        "sender_full_name": "Ed Page",
        "timestamp": 1633701074
    },
    {
        "content": "<p>It is interesting to consider what theoretical cargo crates need minimal API breakages and which don't (which is also independent of the \"supports multiple versions\" problem).  At least crates-index and a <code>cargo-clap</code> aren't really the type of thing people need to put in their own APIs, so I see no reason for spending time trying to keep the API compatible or researching whether major needs to be bumped. Feel free to bump on every release for all I care :)</p>",
        "id": 256742990,
        "sender_full_name": "Ed Page",
        "timestamp": 1633701312
    },
    {
        "content": "<blockquote>\n<p>We get plenty of \"why don't you just solve your technical debt by doing\" suggestions. Thank you for sticking around for the \"it is complicated\" conversations.</p>\n</blockquote>\n<p>In case it was clear, my intention was \"hey, I see a community-wide problem, how can I help?\"  I was planning to implement any of the outcomes from the discussion.  I also would be willing to stick around to help with them.  In general, I am wanting to put some more time towards cargo (cargo-add is a first step), I'm just distracted at the moment trying to get clap3 released.</p>",
        "id": 256743279,
        "sender_full_name": "Ed Page",
        "timestamp": 1633701423
    },
    {
        "content": "<p>So you are probably one of the most qualified people to decide is a <code>cargo-clap</code> worth trying.<br>\nIt sounds like there may be a <code>cargo-crates-index</code> that can work.<br>\nIf someone wants to spend a day or two extracting a mod/crate, and report back about what works and what dos/not work. It would be a very useful piece of information!</p>",
        "id": 256797715,
        "sender_full_name": "Eh2406",
        "timestamp": 1633723359
    },
    {
        "content": "<p>Without a big pressing need, I'll hold off on a <code>cargo-clap</code> until clap3 because one API will be able to support both people using the builder API (clap2-style) or the derive API (a fork of structopt)</p>\n<p>I'll look into a cargo-crates-index next week.</p>",
        "id": 256797999,
        "sender_full_name": "Ed Page",
        "timestamp": 1633723502
    }
]