[
    {
        "content": "<p>I have a probably fairly niche problem, but one I'm hoping there's a way to align with Cargo on so that things work out as desired. Basically, I'm using Cargo in the context of a larger build system (called Brazil). For various reasons, that build system constructs a local registry for each Brazil package that holds exactly the Cargo packages that that Brazil package is permitted to access. Some of those are mirrored from <a href=\"http://crates.io\">crates.io</a>, and others are first-party packages (for <span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span> reasons <span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span>  we're not using multiple registries).</p>\n<p>Now, Brazil _also_ has a notion of workspaces, separate from Cargo workspaces, where you can have multiple Brazil packages checked out \"as a group\". When that happens, I'd like those packages to shared a Cargo target/ directory so that if you build Brazil package 1, and then Brazil package 2, any Cargo dependencies shared between them don't have to be compiled twice. Unfortunately, that doesn't work today, since (as far as I can tell) Cargo includes the _path_ to each dependency in the fingerprint used for artifact tracking. So even if Brazil packages 1 and 2 both take a dependency on, say, <code>autocfg 1.0.1</code>, and share both a <code>CARGO_HOME</code> and a <code>CARGO_TARGET_DIR</code>, <code>autocfg 1.0.1</code> will still be re-compiled because its fingerprint in package 1 includes <code>CARGO_HOME/registry/src/-&lt;hash of pkg1 local registry path&gt;/autocfg-1.0.1</code>, whereas its fingerprint in package 2 has the same path except with the hash of package 2's local registry path instead.</p>\n<p>Worse yet, any time a user switches between the two Brazil packages, they'll re-compile _all_ the shared artifacts, because they'll all be tagged with the fingerprint from the _other_ package's path.</p>\n<p>Now, this feels silly since in all of this, it's the _same_ <code>autocfg 1.0.1</code> â€” the one from <a href=\"http://crates.io\">crates.io</a>, and that's at least partially expressed by the fact that each local registry is a source replacement for <code>[source.crates-io]</code>. I realize that what Cargo does here is more safe since it's _possible_ for two registries to have the same coordinate be represented by different backing sources, but I wonder if that would be better represented by, say, (name, version, checksum)?</p>\n<p>Anyway, I know this is very open-ended, but wanted to get the team's take on the \"right\" thing to do for a build system wrapping Cargo in this way where each project gets its own local registry.</p>",
        "id": 262647994,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637793537
    },
    {
        "content": "<p>Note that it's quite <em>easy</em> for two registries to have different sources for the same crate name/version. If they live in two separate directories, <em>nothing</em> checks that they're the same. You can put a hash into the file in the directory registry, but nothing checks that the contents of the directory match that hash.</p>",
        "id": 262648115,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637793631
    },
    {
        "content": "<p>Two questions:</p>",
        "id": 262648128,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637793644
    },
    {
        "content": "<p>Does anything you're doing guarantee that two copies of the same crate will be identical, in your system? (Are the sources obtained from the same place even if your build system then constructs different local registries for each user of them?)</p>",
        "id": 262648135,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637793651
    },
    {
        "content": "<p>And could you arrange for your build system to share the actual crate directories between local registries for packages in a Brazil workspace, rather than having separate ones?</p>",
        "id": 262648216,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637793735
    },
    {
        "content": "<p>Note that this is a \"local registry\" _not_ a \"directory registry\". As I understand it, the former does check checksums.</p>",
        "id": 262648306,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637793836
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"239881\">Josh Triplett</span> <a href=\"#narrow/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries/near/262648135\">said</a>:</p>\n<blockquote>\n<p>Does anything you're doing guarantee that two copies of the same crate will be identical, in your system? (Are the sources obtained from the same place even if your build system then constructs different local registries for each user of them?)</p>\n</blockquote>\n<p>This is a subset mirror of <a href=\"http://crates.io\">crates.io</a> with first-party crates added, so yes, the same coordinate in two of these registries should be the same.</p>",
        "id": 262648432,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637793946
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"239881\">Josh Triplett</span> <a href=\"#narrow/stream/246057-t-cargo/topic/Sharing.20target.2F.20with.20multiple.20local.20registries/near/262648216\">said</a>:</p>\n<blockquote>\n<p>And could you arrange for your build system to share the actual crate directories between local registries for packages in a Brazil workspace, rather than having separate ones?</p>\n</blockquote>\n<p>I don't see how that's possible with a local registry if you want to make different subsets of crates to be available to each Brazil package? Basically, say I want Brazil package 1 to have access to <code>serde</code>, but _not_ Brazil package 2. But both have access to <code>autocfg</code>, and should share the build artifacts of that if they both use it.</p>",
        "id": 262648551,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637794018
    },
    {
        "content": "<p>I see. This is not about local modifications, just about \"you can't use anything except\"?</p>",
        "id": 262648662,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637794093
    },
    {
        "content": "<p>Exactly.</p>",
        "id": 262648736,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637794167
    },
    {
        "content": "<p>Could you have the same paths to crates, but different index files?</p>",
        "id": 262649557,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637794891
    },
    {
        "content": "<p>A directory registry looks at everything in the directory, but a local registry needs an index.</p>",
        "id": 262649569,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637794910
    },
    {
        "content": "<p>One directory of crates, many indexes.</p>",
        "id": 262649655,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637795003
    },
    {
        "content": "<p>I'm not sure I follow? Are you proposing I switch from a local registry to a directory registry? I _believe_ the input to Cargo's target artifact fingerprint is the path to the index, so in either case it would still fingerprint differently if the index differs</p>",
        "id": 262649846,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637795201
    },
    {
        "content": "<p>Oh, I thought it was the path to the crate source.</p>",
        "id": 262649874,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637795233
    },
    {
        "content": "<p>(And no, not proposing a switch.)</p>",
        "id": 262649886,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1637795250
    },
    {
        "content": "<p>Ah, so, it _is_ the crate source, but that path _includes_ the hash of the path to the registry</p>",
        "id": 262649938,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637795298
    },
    {
        "content": "<p>e.g.: <code>~/.cargo/registry/src/github.com-1ecc6299db9ec823/autocfg-1.0.1/</code></p>",
        "id": 262649962,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637795321
    },
    {
        "content": "<p>for a local registry, <code>github.com</code> is the empty string, but the hash is the hash of the path to the local registry index</p>",
        "id": 262649969,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637795337
    },
    {
        "content": "<p>at least from what I can tell</p>",
        "id": 262649973,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637795341
    },
    {
        "content": "<p>which means that different indexes yield different crate paths, which then go into the fingerprint</p>",
        "id": 262649987,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1637795362
    },
    {
        "content": "<p>FYI: I filed a subset of this that I _do_ think is an outright bug as &lt;<a href=\"https://github.com/rust-lang/cargo/issues/10179\">https://github.com/rust-lang/cargo/issues/10179</a>&gt;.</p>",
        "id": 264066078,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1638908493
    }
]