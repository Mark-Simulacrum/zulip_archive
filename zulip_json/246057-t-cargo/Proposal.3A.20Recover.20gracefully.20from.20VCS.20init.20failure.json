[
    {
        "content": "<p>At <span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span>'s re:Invent workshop, a new-to-Rust participant was stymied by <code>cargo new</code> and <code>cargo init</code> failing with an obtuse error message. </p>\n<p><strong>The cause:</strong> they had a broken <a href=\"https://git-template.readthedocs.io/en/latest/\">Git Template</a> install. This issue presumably would have surfaced if they had run <code>git init</code> in any context, but I imagine the participant was mostly cloning repos for work, not init-ing them.</p>\n<p><strong>The immediate solution:</strong> We had them run <code>cargo init --vcs none</code>.</p>\n<p>Had we not been there and able to help so quickly, I think this participant might have just given up. Nothing about <code>cargo new</code> screams \"I'm calling <code>git</code>\", so it's not obvious to new-to-rust users that git would be involved at all; this made the hard error all-the-more confusing.</p>\n<p><strong>Proposal 1:</strong> <em>The error message should advise the user to run <code>cargo init --vcs none</code>.</em></p>\n<p><strong>Proposal 2:</strong> <em>VCS init failures should be a warning.</em></p>",
        "id": 263923733,
        "sender_full_name": "Jack Wrenn",
        "timestamp": 1638824403
    },
    {
        "content": "<p><em>Proposal 2</em> is my preferred fix, because:</p>\n<ol>\n<li>cargo inits VCS as a convenience (so it should rarely be an <em>inconvenience</em>)</li>\n<li>â€‹if the programmer <em>really</em> wants VCS to work, they'll confront it the first time they try to commit, anyways (which doesn't involve cargo).</li>\n</ol>",
        "id": 263923881,
        "sender_full_name": "Jack Wrenn",
        "timestamp": 1638824424
    },
    {
        "content": "<p>Thoughts?</p>",
        "id": 263923916,
        "sender_full_name": "Jack Wrenn",
        "timestamp": 1638824444
    },
    {
        "content": "<p>Always +1 for better error messages!</p>",
        "id": 263924456,
        "sender_full_name": "Eh2406",
        "timestamp": 1638824680
    },
    {
        "content": "<p>As long as <code>cargo</code> exits with a non-zero status (so that careful scripts written with <code>set -e</code> do fail), making it a warning seems OK.</p>",
        "id": 263930325,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638827789
    },
    {
        "content": "<p>I had a related situation come up where a user had a <code>.gitconfig</code> with the result of running</p>\n<div class=\"codehilite\"><pre><span></span><code>git config --global url.&quot;git@github.com:&quot;.insteadOf https://github.com/\n</code></pre></div>\n<p>(see also &lt;<a href=\"https://www.jvt.me/posts/2019/03/20/git-rewrite-url-https-ssh/\">https://www.jvt.me/posts/2019/03/20/git-rewrite-url-https-ssh/</a>&gt;).</p>\n<p>This had the awful impact that when Cargo tries to clone crates.io-index, it fails with a permission denied error from git saying that <code>git@github.com/rust-lang/crates.io-index</code> can't be cloned. Now, to me this configuration is absolutely insane, but it seems like it's a thing people use to avoid having to remember the distinction between <code>git@</code> and <code>https://</code> when cloning GitHub repositories. It'd be nice if Cargo could detect this, or at least give a nicer error.</p>",
        "id": 263932509,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1638828858
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120054\">@Jon Gjengset</span> FWIW, we've had this <em>exact</em> issue come up before.</p>",
        "id": 263933284,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829204
    },
    {
        "content": "<p>With pretty much that exact config.</p>",
        "id": 263933332,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829230
    },
    {
        "content": "<p>In terms of how to fix configurations, I would generally suggest that people use <code>pushInsteadOf</code> rather than <code>insteadOf</code>.</p>",
        "id": 263933340,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829236
    },
    {
        "content": "<p>It was _really_ confusing to try to debug, that's for sure!</p>",
        "id": 263933352,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1638829245
    },
    {
        "content": "<p>(FWIW, I'm the one who added <code>pushInsteadOf</code> to git, for just such purposes. :) )</p>",
        "id": 263933376,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829265
    },
    {
        "content": "<p>That said, there are <em>valid</em> reasons to want to use <code>insteadOf</code> here.</p>",
        "id": 263933397,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829287
    },
    {
        "content": "<p>For instance, it'd mean that cloning private repositories works with just copy-paste.</p>",
        "id": 263933427,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829304
    },
    {
        "content": "<p>Oh, absolutely! My _only_ concern here is that Cargo should make it easier to identify that that's what went wrong.</p>",
        "id": 263933481,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1638829324
    },
    {
        "content": "<p>(Since you can't clone a private repo without authentication, and SSH authentication Just Works but HTTPS authentication requires configuration.)</p>",
        "id": 263933494,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829334
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120054\">Jon Gjengset</span> <a href=\"#narrow/stream/246057-t-cargo/topic/Proposal.3A.20Recover.20gracefully.20from.20VCS.20init.20failure/near/263933481\">said</a>:</p>\n<blockquote>\n<p>Oh, absolutely! My _only_ concern here is that Cargo should make it easier to identify that that's what went wrong.</p>\n</blockquote>\n<p>Yeah, I agree entirely.</p>",
        "id": 263933499,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829340
    },
    {
        "content": "<p>So, libgit2 and by extension git2-rs <em>should</em> make it possible to detect when configuration is remapping the URL.</p>",
        "id": 263933563,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829381
    },
    {
        "content": "<p>And anytime the URL for the index gets remapped, we might want to print a warning.</p>",
        "id": 263933589,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829399
    },
    {
        "content": "<p>Is <code>git@github.com/rust-lang/crates.io-index</code> failing because the user doesn't actually have SSH authentication configured, or because that configuration isn't picked up by Cargo?</p>",
        "id": 263933717,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638829464
    },
    {
        "content": "<p>This was about a week ago at a workshop, so don't have the actual configuration available. It seems likely they had GitHub configuration set up (given that they had that rule)</p>",
        "id": 263933963,
        "sender_full_name": "Jon Gjengset",
        "timestamp": 1638829611
    },
    {
        "content": "<p>Right, but I'm wondering if it was set up in a way that git would use but libgit2 wouldn't.</p>",
        "id": 263935359,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638830529
    },
    {
        "content": "<p>For instance, libgit2 can use git configuration, but libgit2 uses libssh2 and libssh2 doesn't use SSH configuration.</p>",
        "id": 263935389,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638830548
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"219211\">@Jack Wrenn</span> Do you know the exact error message that they received?  If the template was simply missing, then that has been fixed, but will be waiting for a new release of libgit2.</p>\n<p>Also, feel free to post suggestions for things like this as an issue at <a href=\"https://github.com/rust-lang/cargo/issues/\">https://github.com/rust-lang/cargo/issues/</a>.  It is easy for things to get lost on chat.</p>",
        "id": 263938558,
        "sender_full_name": "Eric Huss",
        "timestamp": 1638832490
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120518\">@Eric Huss</span> IIRC, the error was something like \"could not stat ~/.git_template\", because it didn't exist. My memory is a little hazy.</p>",
        "id": 263945245,
        "sender_full_name": "Jack Wrenn",
        "timestamp": 1638837773
    },
    {
        "content": "<p>Yea, then I believe that is <a href=\"https://github.com/rust-lang/cargo/issues/10038\">https://github.com/rust-lang/cargo/issues/10038</a>.</p>",
        "id": 263947704,
        "sender_full_name": "Eric Huss",
        "timestamp": 1638839892
    }
]