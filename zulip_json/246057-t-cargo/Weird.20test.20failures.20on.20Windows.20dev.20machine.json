[
    {
        "content": "<p>I'm trying to run <code>cargo test</code> in the cargo repo on a Windows 11 machine and I'm getting some weird behavior. Basically, several tests fail, but if I run the test individually then they succeed. The other weird thing is that while running <code>cargo test</code>, some other programs on my machine fail to save files, giving an <code>EBUSY: resource busy or locked</code> error.</p>",
        "id": 268589964,
        "sender_full_name": "eholk",
        "timestamp": 1642619868
    },
    {
        "content": "<p>That is odd. :-(</p>",
        "id": 268590052,
        "sender_full_name": "Eh2406",
        "timestamp": 1642619899
    },
    {
        "content": "<p>It seems like maybe one of the cargo tests is taking an overly broad file system lock?</p>",
        "id": 268590057,
        "sender_full_name": "eholk",
        "timestamp": 1642619900
    },
    {
        "content": "<p>If I run <code>cargo test fix</code> then I start noticing the save errors in other programs, so it seems like the culprit is a test that runs during that set, but I haven't been able to narrow it down further.</p>",
        "id": 268590457,
        "sender_full_name": "eholk",
        "timestamp": 1642620088
    },
    {
        "content": "<p>Sorry I don't have a win11 to test on. Please let use know what you find.</p>",
        "id": 268602259,
        "sender_full_name": "Eh2406",
        "timestamp": 1642625898
    },
    {
        "content": "<p>this is often related to antivirus things which generally wreak havoc with programs trying to access the filesystem, do you know if you have anything like that configured?</p>",
        "id": 268603184,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1642626255
    },
    {
        "content": "<p>an example is that antivirus things can often keep files open long after cargo closes them, preventing cargo from deleting files it thinks it should be able to delete</p>",
        "id": 268603234,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1642626273
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116015\">Alex Crichton</span> <a href=\"#narrow/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine/near/268603184\">said</a>:</p>\n<blockquote>\n<p>this is often related to antivirus things which generally wreak havoc with programs trying to access the filesystem, do you know if you have anything like that configured?</p>\n</blockquote>\n<p>As far as I know I just have the normal Windows Defender stuff running, although maybe this is causing the problem.</p>",
        "id": 268613239,
        "sender_full_name": "eholk",
        "timestamp": 1642631457
    },
    {
        "content": "<p>can you gist the failures that you're seeing?</p>",
        "id": 268614045,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1642631991
    },
    {
        "content": "<p>Hmm, adding the exclusion didn't help</p>",
        "id": 268614121,
        "sender_full_name": "eholk",
        "timestamp": 1642632030
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116015\">Alex Crichton</span> <a href=\"#narrow/stream/246057-t-cargo/topic/Weird.20test.20failures.20on.20Windows.20dev.20machine/near/268614045\">said</a>:</p>\n<blockquote>\n<p>can you gist the failures that you're seeing?</p>\n</blockquote>\n<p><a href=\"https://gist.github.com/eholk/07c54be54d345e259716af6c2cb872cc\">https://gist.github.com/eholk/07c54be54d345e259716af6c2cb872cc</a></p>",
        "id": 268614157,
        "sender_full_name": "eholk",
        "timestamp": 1642632061
    },
    {
        "content": "<p>hm ok so that looks like it's in cargo's cleanup code for tests, so probably unrelated to cargo itself, and I think that most likely has to do with something stray keeping it open like a process or something like that</p>",
        "id": 268614523,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1642632286
    },
    {
        "content": "<p>another random thought is that maybe your windows has nested job objects disabled? I thought that was enabled by default though in like windows 10 or years ago though</p>",
        "id": 268614561,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1642632308
    },
    {
        "content": "<p>Do you know how to check?</p>",
        "id": 268614595,
        "sender_full_name": "eholk",
        "timestamp": 1642632331
    },
    {
        "content": "<p>Unfortunately I don't know how to figure out what's keeping something open</p>",
        "id": 268614600,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1642632333
    },
    {
        "content": "<p>you can try poking around in cargo's jobserver bits</p>",
        "id": 268614614,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1642632341
    },
    {
        "content": "<p>I think there's a <code>CARGO_LOG</code> incantation to print things but I forget what itt is</p>",
        "id": 268614630,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1642632351
    },
    {
        "content": "<p>I assume you've run <code>cargo clean</code> at some point?  </p>\n<p>The <code>target</code> directory is supposed to be excluded from indexing, but I would double-check that is still working.  I'm uncertain how to do that exactly, but I would try just manually adding your work directory to the exclusion list.</p>\n<p>I would also temporarily disable the Defender real-time scanning.</p>\n<p>Presumably the locks are transient, which makes it hard to catch the bad-actor.  Process Explorer can be used to find those, but only if they hold the file open for a long period of time.</p>",
        "id": 268616011,
        "sender_full_name": "Eric Huss",
        "timestamp": 1642633178
    },
    {
        "content": "<p>Hmm, so deleting my <code>target</code> directory and rebooting, along with the Windows Defender exclusion fixed it. Maybe I just had some stale files in the target directory with bad permissions.</p>",
        "id": 268616015,
        "sender_full_name": "eholk",
        "timestamp": 1642633182
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120518\">@Eric Huss</span> - yeah, I hadn't run <code>cargo clean</code> yet, but that failed and then manually deleting the files fixed it.</p>",
        "id": 268616143,
        "sender_full_name": "eholk",
        "timestamp": 1642633224
    },
    {
        "content": "<p>Ah.  Hopefully it doesn't crop up again, that can be annoying to track down.</p>",
        "id": 268616219,
        "sender_full_name": "Eric Huss",
        "timestamp": 1642633255
    },
    {
        "content": "<p>At least now I'm armed with a few more troubleshooting tips if it does :)</p>",
        "id": 268616273,
        "sender_full_name": "eholk",
        "timestamp": 1642633290
    },
    {
        "content": "<p>Thanks for the help!</p>",
        "id": 268616277,
        "sender_full_name": "eholk",
        "timestamp": 1642633293
    }
]