[
    {
        "content": "<p>Am I doing something wrong or did I find a cargo bug? </p>\n<div class=\"codehilite\"><pre><span></span><code>[package]\nname = &quot;test_metadata&quot;\nversion = &quot;0.1.0&quot;\nedition = &quot;2018&quot;\n\n# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html\n\n[dependencies]\nalloca = &quot;*&quot;\nconsole-api = { git = &quot;https://github.com/guswynn/console.git&quot;, rev= &quot;55179438c7af5325bcf47f8092781c5c2298207c&quot;}\ntokio-console = { git = &quot;https://github.com/guswynn/console.git&quot;, rev= &quot;55179438c7af5325bcf47f8092781c5c2298207c&quot;}\n</code></pre></div>\n<p>with <code>cargo metadata</code>, I get <code>alloca</code> (a binary crate) as a package, and <code>console-api</code> (a git lib crate), but NOT <code>tokio-console</code>, which is a git, binary crate</p>",
        "id": 253178238,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1631577257
    },
    {
        "content": "<p>Cargo metadata doesn't currently report binary deps at all</p>",
        "id": 253178993,
        "sender_full_name": "Daniel Wagner-Hall",
        "timestamp": 1631577773
    },
    {
        "content": "<p>Hm, I can see how that is a little confusing.  <code>cargo metadata</code> only includes library dependencies in the \"resolve\" graph, as it needs something to put in for the \"name\" field.  A package without a library won't have a value to put there.</p>",
        "id": 253179025,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631577796
    },
    {
        "content": "<p>FWIW, cargo now warns about such dependencies.</p>",
        "id": 253179072,
        "sender_full_name": "Eric Huss",
        "timestamp": 1631577824
    },
    {
        "content": "<p><code>cargo metadata | jq .resolve.nodes | jq -r '.[]|select(.id | startswith(\"XXX\"))'</code> works if you want to play around</p>",
        "id": 253179159,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1631577848
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"336670\">Daniel Wagner-Hall</span> <a href=\"#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253178993\">said</a>:</p>\n<blockquote>\n<p>Cargo metadata doesn't currently report binary deps at all</p>\n</blockquote>\n<p>but it seems to work with alloca? is that because it has a binary and a lib dep?</p>",
        "id": 253179264,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1631577904
    },
    {
        "content": "<p>FWIW I've been meaning to chime in on <a href=\"https://github.com/rust-lang/rfcs/pull/3168\">https://github.com/rust-lang/rfcs/pull/3168</a> about this too, as it may be a reasonable place to reconsider this - I've been wanting binary deps in <code>cargo metadata</code> too :)</p>",
        "id": 253179353,
        "sender_full_name": "Daniel Wagner-Hall",
        "timestamp": 1631577955
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"257428\">Gus Wynn</span> <a href=\"#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253179264\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"336670\">Daniel Wagner-Hall</span> <a href=\"#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253178993\">said</a>:</p>\n<blockquote>\n<p>Cargo metadata doesn't currently report binary deps at all</p>\n</blockquote>\n<p>but it seems to work with alloca? is that because it has a binary and a lib dep?</p>\n</blockquote>\n<p>Yes, exactly - it's \"pure\" binary deps which are not reported</p>",
        "id": 253179443,
        "sender_full_name": "Daniel Wagner-Hall",
        "timestamp": 1631577973
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120518\">Eric Huss</span> <a href=\"#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253179025\">said</a>:</p>\n<blockquote>\n<p>Hm, I can see how that is a little confusing.  <code>cargo metadata</code> only includes library dependencies in the \"resolve\" graph, as it needs something to put in for the \"name\" field.  A package without a library won't have a value to put there.</p>\n</blockquote>\n<p>context is I am using a tool that consumes cargo vendor and cargo metadata to auto-generate build deps <br>\nI could make a PR to have the tokio-console have an empty lib dep, but that seems kindof heavy weight, is there no way  around this?</p>",
        "id": 253179506,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1631577997
    },
    {
        "content": "<p>We do something similar in <a href=\"https://github.com/google/cargo-raze\">https://github.com/google/cargo-raze</a> - our hack is pretty nasty, we create a workspace crate with the same name and use <a href=\"https://github.com/ehuss/cargo-clone-crate\">https://github.com/ehuss/cargo-clone-crate</a> to give it the same deps as the real crate, then we retrofit the data we need to the workspace crate (which _will_ appear in the resolve)</p>",
        "id": 253179654,
        "sender_full_name": "Daniel Wagner-Hall",
        "timestamp": 1631578088
    },
    {
        "content": "<p>But would be interested in getting binary-only deps into the resolve graph at some point! If we can sketch out the details, I'd be happy to give a go at implementing</p>",
        "id": 253179675,
        "sender_full_name": "Daniel Wagner-Hall",
        "timestamp": 1631578112
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"336670\">Daniel Wagner-Hall</span> <a href=\"#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253179654\">said</a>:</p>\n<blockquote>\n<p>We do something similar in <a href=\"https://github.com/google/cargo-raze\">https://github.com/google/cargo-raze</a> - our hack is pretty nasty, we create a workspace crate with the same name and use <a href=\"https://github.com/ehuss/cargo-clone-crate\">https://github.com/ehuss/cargo-clone-crate</a> to give it the same deps as the real crate, then we retrofit the data we need to the workspace crate (which _will_ appear in the resolve)</p>\n</blockquote>\n<p>oh thats quite brutal, i will look into that. I also will see if the tokio folks are okay with me adding an empty lib crate</p>",
        "id": 253179909,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1631578318
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"336670\">Daniel Wagner-Hall</span> <a href=\"#narrow/stream/246057-t-cargo/topic/cargo.20metadata.20with.20binary.20git.20dep/near/253179675\">said</a>:</p>\n<blockquote>\n<p>But would be interested in getting binary-only deps into the resolve graph at some point! If we can sketch out the details, I'd be happy to give a go at implementing</p>\n</blockquote>\n<p>is there an understanding of how ahrd this would be?</p>",
        "id": 253179950,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1631578328
    },
    {
        "content": "<p>(I'm not a cargo team person): I think just adding the data in isn't particularly hard, the tricky thing is what the presence in the resolve graph _means_ given there are multiple proposals out there to have binary deps actually have meaning</p>",
        "id": 253180135,
        "sender_full_name": "Daniel Wagner-Hall",
        "timestamp": 1631578486
    },
    {
        "content": "<p>If we just added them as nodes to the resolve graph, and didn't list them as deps, that's weird. If we did list them as deps in the graph, but as far as cargo is concerned the dep is meaningless and unused, that's also weird. We could maybe carve out a new <code>dep_kinds</code> value for them, but it would be kind of weird to do so given the only people actually using the metadata at the moment are people kind of cheating cargo...</p>",
        "id": 253180259,
        "sender_full_name": "Daniel Wagner-Hall",
        "timestamp": 1631578574
    },
    {
        "content": "<p>Which is why I was kind of hoping to piggy-back this onto <a href=\"https://github.com/rust-lang/rfcs/pull/3168\">https://github.com/rust-lang/rfcs/pull/3168</a> or <a href=\"https://github.com/rust-lang/rfcs/pull/3028\">https://github.com/rust-lang/rfcs/pull/3028</a>, so that we're actually attaching meaning to the dep in cargo, not just tacking on kinda-fake data</p>",
        "id": 253180344,
        "sender_full_name": "Daniel Wagner-Hall",
        "timestamp": 1631578659
    },
    {
        "content": "<p>I guess my argument is if \"you add an empty <code>lib.rs</code> to  a binary cargo package, then ur binary target shows up in the resolve graph\" is true (it is), then the semantics of binary targets in the resolve graph is already well-known, if not documented</p>",
        "id": 253182141,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1631580186
    },
    {
        "content": "<p>the dep is meaningless, but the presence of the target is not (also the dep is NOT meaningless, when running <code>cargo vendor</code></p>",
        "id": 253182164,
        "sender_full_name": "Gus Wynn",
        "timestamp": 1631580217
    }
]