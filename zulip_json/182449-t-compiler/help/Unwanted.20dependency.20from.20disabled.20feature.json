[
    {
        "content": "<p>In a PR updating the <code>chalk</code> version, I'm getting an unwanted dependency pulled in. If someone could take a look at the convo here, it'd be hugely appreciated! <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span>   <a href=\"https://github.com/rust-lang/rust/pull/92167#discussion_r773432638\">https://github.com/rust-lang/rust/pull/92167#discussion_r773432638</a> (cc <span class=\"user-mention\" data-user-id=\"232957\">@Jack Huey</span>)</p>",
        "id": 265814906,
        "sender_full_name": "pierwill",
        "timestamp": 1640185731
    },
    {
        "content": "<p>Hm... interesting <a href=\"https://doc.rust-lang.org/cargo/reference/features.html#dependency-features\">note in the Cargo book</a>: </p>\n<blockquote>\n<p>Note: This may not ensure the default features are disabled. If another dependency includes flate2 without specifying default-features = false, then the default features will be enabled. See feature unification below for more details.</p>\n</blockquote>",
        "id": 265816385,
        "sender_full_name": "pierwill",
        "timestamp": 1640186592
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>❯     cargo tree -f &quot;{p} {f}&quot; | grep chalk\n│   │   │   ├── chalk-ir v0.75.0\n│   │   │   │   ├── chalk-derive v0.75.0 (proc-macro)\n    │   │   │   ├── chalk-engine v0.75.0\n    │   │   │   │   ├── chalk-derive v0.75.0 (proc-macro)  (*)\n    │   │   │   │   ├── chalk-ir v0.75.0  (*)\n    │   │   │   │   ├── chalk-solve v0.75.0 default,tracing-full,tracing-subscriber,tracing-tree\n    │   │   │   │   │   ├── chalk-derive v0.75.0 (proc-macro)  (*)\n    │   │   │   │   │   ├── chalk-ir v0.75.0  (*)\n    │   │   │   ├── chalk-ir v0.75.0  (*)\n    │   │   │   ├── chalk-solve v0.75.0 default,tracing-full,tracing-subscriber,tracing-tree (*)\n</code></pre></div>\n<p>Grrr, I thought I'd disabled <code>tracing-full</code> <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 265817596,
        "sender_full_name": "pierwill",
        "timestamp": 1640187253
    },
    {
        "content": "<p>Wait cargo tree can show features ?!?</p>",
        "id": 265817623,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640187277
    },
    {
        "content": "<p>Ahhh I've been looking for this for ages</p>",
        "id": 265817642,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640187289
    },
    {
        "content": "<p>haha nice</p>",
        "id": 265817652,
        "sender_full_name": "pierwill",
        "timestamp": 1640187295
    },
    {
        "content": "<p>never used cargo tree b4. glad I could help <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span></p>",
        "id": 265817685,
        "sender_full_name": "pierwill",
        "timestamp": 1640187312
    },
    {
        "content": "<p>I've got default features disabled everywhere, and the offending version is still pulled in...</p>\n<div class=\"codehilite\"><pre><span></span><code>❯  rg --glob=*.toml chalk\ncompiler/rustc_middle/Cargo.toml:32:1:chalk-ir = { version = &quot;0.75.0&quot;, default-features = false }\ncompiler/rustc_traits/Cargo.toml:15:1:chalk-ir = { version = &quot;0.75.0&quot;, default-features = false }\ncompiler/rustc_traits/Cargo.toml:16:1:chalk-engine = { version = &quot;0.75.0&quot;, default-features = false }\ncompiler/rustc_traits/Cargo.toml:17:1:chalk-solve = { version = &quot;0.75.0&quot;, default-features = false }\n</code></pre></div>",
        "id": 265818212,
        "sender_full_name": "pierwill",
        "timestamp": 1640187615
    },
    {
        "content": "<p><code>librustdoc</code> uses version 0.1.9...</p>",
        "id": 265818268,
        "sender_full_name": "pierwill",
        "timestamp": 1640187650
    },
    {
        "content": "<p>why is rustdoc using chalk at all?</p>",
        "id": 265818911,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640187947
    },
    {
        "content": "<p>it's not</p>",
        "id": 265818982,
        "sender_full_name": "pierwill",
        "timestamp": 1640187973
    },
    {
        "content": "<p>it's using <code>tracing-tree</code></p>",
        "id": 265818988,
        "sender_full_name": "pierwill",
        "timestamp": 1640187979
    },
    {
        "content": "<p>ahh, yeah that would do it</p>",
        "id": 265818998,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640187991
    },
    {
        "content": "<p><code>tracing tree</code> v0.2.0 is the dependency we'd like to avoid bringing in</p>",
        "id": 265819009,
        "sender_full_name": "pierwill",
        "timestamp": 1640187998
    },
    {
        "content": "<p>feel free to bump the version in <code>src/librustdoc/Cargo.toml</code></p>",
        "id": 265819016,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640188003
    },
    {
        "content": "<p>ah okay thanks. that's probably acceptable</p>",
        "id": 265819122,
        "sender_full_name": "pierwill",
        "timestamp": 1640188067
    },
    {
        "content": "<p>Grr. Both 0.1.9 and 0.2.0 are still in the lock file...</p>",
        "id": 265819482,
        "sender_full_name": "pierwill",
        "timestamp": 1640188249
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"316352\">@pierwill</span> fwiw, I think the issue is that <code>chalk-engine</code>'s default features enable chalk-solve's default features:</p>\n<div class=\"codehilite\"><pre><span></span><code>│       ├── chalk-solve feature &quot;default&quot;\n│       │   └── chalk-engine v0.75.0\n│       │       └── chalk-engine feature &quot;default&quot;\n│       │           └── rustc_traits v0.0.0 (/home/jnelson/src/rust/compiler/rustc_traits) (*)\n</code></pre></div>",
        "id": 265819511,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640188269
    },
    {
        "content": "<p><span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span></p>",
        "id": 265819529,
        "sender_full_name": "pierwill",
        "timestamp": 1640188284
    },
    {
        "content": "<p>Yes, but doing <code>chalk-engine = { version = \"0.75.0\", default-features = false }</code> doesn't help!</p>",
        "id": 265819680,
        "sender_full_name": "pierwill",
        "timestamp": 1640188373
    },
    {
        "content": "<p>Very frustrating</p>",
        "id": 265819760,
        "sender_full_name": "pierwill",
        "timestamp": 1640188417
    },
    {
        "content": "<p><code>chalk-engine</code> unconditionally enables the default features in <code>chalk-solve</code>: <a href=\"https://docs.rs/crate/chalk-engine/latest/source/Cargo.toml.orig\">https://docs.rs/crate/chalk-engine/latest/source/Cargo.toml.orig</a></p>",
        "id": 265820127,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640188592
    },
    {
        "content": "<p>so <span class=\"user-mention\" data-user-id=\"232957\">@Jack Huey</span> probably needs to publish a new version that makes the features conditional</p>",
        "id": 265820153,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640188607
    },
    {
        "content": "<p>or we could figure out a way to get rid of tracing-tree 0.1</p>",
        "id": 265820183,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640188621
    },
    {
        "content": "<p>Okay, thanks <span class=\"user-mention\" data-user-id=\"232545\">@Joshua Nelson</span> ! I'll discuss it with <span class=\"user-mention\" data-user-id=\"232957\">@Jack Huey</span></p>",
        "id": 265820254,
        "sender_full_name": "pierwill",
        "timestamp": 1640188653
    },
    {
        "content": "<p>tracing-tree 0.1 only has a couple dependencies so should be much easier to bump:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ cargo tree -i tracing-tree:0.1.9\ntracing-tree v0.1.9\n├── rustc_driver v0.0.0 (/home/jnelson/src/rust/compiler/rustc_driver)\n│   └── rustc-main v0.0.0 (/home/jnelson/src/rust/compiler/rustc)\n└── rustdoc v0.0.0 (/home/jnelson/src/rust/src/librustdoc)\n    ├── error_index_generator v0.0.0 (/home/jnelson/src/rust/src/tools/error_index_generator)\n    └── rustdoc-tool v0.0.0 (/home/jnelson/src/rust/src/tools/rustdoc)\n</code></pre></div>",
        "id": 265820310,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640188682
    },
    {
        "content": "<p>/me needs to get around to removing <code>error_index_generator</code>'s dependency on rustdoc</p>",
        "id": 265820364,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640188700
    },
    {
        "content": "<p>Hm.. not sure how I'd go about doing that...</p>",
        "id": 265820391,
        "sender_full_name": "pierwill",
        "timestamp": 1640188716
    },
    {
        "content": "<p>just update the versions in cargo.toml</p>",
        "id": 265820433,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640188746
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>$ fd Cargo.toml | xargs rg tracing-tree\nsrc/librustdoc/Cargo.toml\n22:tracing-tree = &quot;0.1.9&quot;\n\ncompiler/rustc_driver/Cargo.toml\n14:tracing-tree = &quot;0.1.9&quot;\n</code></pre></div>",
        "id": 265820471,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640188766
    },
    {
        "content": "<p>Ah!</p>",
        "id": 265820690,
        "sender_full_name": "pierwill",
        "timestamp": 1640188834
    },
    {
        "content": "<p>wait...</p>",
        "id": 265820710,
        "sender_full_name": "pierwill",
        "timestamp": 1640188844
    },
    {
        "content": "<p>that worked! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 265820793,
        "sender_full_name": "pierwill",
        "timestamp": 1640188883
    },
    {
        "content": "<p>But nothing is ever easy lol </p>\n<div class=\"codehilite\"><pre><span></span><code>error[E0277]: the trait bound `HierarchicalLayer&lt;fn() -&gt; std::io::Stderr {stderr}&gt;: __tracing_subscriber_Layer&lt;Layered&lt;EnvFilter, tracing_subscriber::Registry&gt;&gt;` is not satisfied\n    --&gt; compiler/rustc_driver/src/lib.rs:1303:80\n     |\n1303 |     let subscriber = tracing_subscriber::Registry::default().with(filter).with(layer);\n     |                                                                           ---- ^^^^^ the trait `__tracing_subscriber_Layer&lt;Layered&lt;EnvFilter, tracing_subscriber::Registry&gt;&gt;` is not implemented for `HierarchicalLayer&lt;fn() -&gt; std::io::Stderr {stderr}&gt;`\n     |                                                                           |\n     |                                                                           required by a bound introduced by this call\n     |\nnote: required by a bound in `tracing_subscriber::layer::SubscriberExt::with`\n    --&gt; /Users/wpierce/.cargo/registry/src/github.com-1ecc6299db9ec823/tracing-subscriber-0.2.16/src/layer.rs:524:12\n     |\n524  |         L: Layer&lt;Self&gt;,\n     |            ^^^^^^^^^^^ required by this bound in `tracing_subscriber::layer::SubscriberExt::with`\n</code></pre></div>",
        "id": 265822054,
        "sender_full_name": "pierwill",
        "timestamp": 1640189507
    },
    {
        "content": "<p>Probably need to update tracing-subscriber too</p>",
        "id": 265822115,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1640189525
    },
    {
        "content": "<p><span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 265822394,
        "sender_full_name": "pierwill",
        "timestamp": 1640189687
    },
    {
        "content": "<p>I think a version bump for these is probably fine. But we should update chalk-engine to make those optional.</p>",
        "id": 265824900,
        "sender_full_name": "Jack Huey",
        "timestamp": 1640191127
    }
]