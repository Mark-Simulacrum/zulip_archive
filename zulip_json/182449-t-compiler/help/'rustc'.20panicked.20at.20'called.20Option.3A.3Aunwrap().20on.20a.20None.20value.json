[
    {
        "content": "<p>Hi.<br>\nAs part of my work on the gcc codegen, I got to the point where I seem to produce invalid <code>.so</code> files for proc-macros as I get the following error when trying to load them:</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;rustc&#39; panicked at &#39;called `Option::unwrap()` on a `None` value&#39;, compiler/rustc_metadata/src/rmeta/decoder.rs:675:31\nstack backtrace:\n   0: rust_begin_unwind\n             at /rustc/b41936b92cd8463020207cb2f62a4247942ef2e4/library/std/src/panicking.rs:515:5\n   1: core::panicking::panic_fmt\n             at /rustc/b41936b92cd8463020207cb2f62a4247942ef2e4/library/core/src/panicking.rs:92:14\n   2: core::panicking::panic\n             at /rustc/b41936b92cd8463020207cb2f62a4247942ef2e4/library/core/src/panicking.rs:50:5\n   3: rustc_metadata::rmeta::decoder::&lt;impl rustc_metadata::creader::CrateMetadataRef&gt;::raw_proc_macro\n   4: rustc_metadata::rmeta::decoder::cstore_impl::&lt;impl rustc_metadata::creader::CStore&gt;::item_children_untracked\n   5: rustc_resolve::Resolver::resolutions\n   6: rustc_resolve::imports::&lt;impl rustc_resolve::Resolver&gt;::resolve_ident_in_module_unadjusted_ext\n   7: rustc_resolve::Resolver::resolve_ident_in_module_ext\n   8: rustc_resolve::imports::ImportResolver::resolve_import::{{closure}}\n   9: rustc_resolve::imports::ImportResolver::resolve_imports\n  10: rustc_resolve::macros::&lt;impl rustc_expand::base::ResolverExpand for rustc_resolve::Resolver&gt;::resolve_imports\n  11: rustc_expand::expand::MacroExpander::fully_expand_fragment\n  12: rustc_expand::expand::MacroExpander::expand_crate\n  13: rustc_session::utils::&lt;impl rustc_session::session::Session&gt;::time\n  14: rustc_interface::passes::configure_and_expand\n  15: rustc_interface::queries::Queries::expansion\n  16: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter\n  17: rustc_span::with_source_map\n  18: rustc_interface::interface::create_compiler_and_run\n  19: scoped_tls::ScopedKey&lt;T&gt;::set\n</code></pre></div>\n<p><a href=\"https://github.com/rust-lang/rust/blob/41c1f39fa8317fc16779ceda7536fe93f1c89c34/compiler/rustc_metadata/src/rmeta/decoder.rs#L675\">This is the code where it panics.</a></p>\n<p>I tried loading the <code>.so</code> in the LLVM-based rustc and it cannot load it either. And loading in the gcc-based rustc a <code>.so</code> generated by LLVM works, so I assume my gcc codegen produces wrong <code>.so</code> for proc-macros.</p>\n<p>Maybe the metadata is wrong.</p>\n<p>I'm not sure what's the best way to look at metadata so I used <code>objcopy</code> and here's the result:</p>\n<p>GCC metadata<br>\n<a href=\"/user_uploads/4715/vWjlDNS16zC07l0x3-1BPY3Q/metadata_gcc.png\">metadata_gcc.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/vWjlDNS16zC07l0x3-1BPY3Q/metadata_gcc.png\" title=\"metadata_gcc.png\"><img src=\"/user_uploads/4715/vWjlDNS16zC07l0x3-1BPY3Q/metadata_gcc.png\"></a></div><p>LLVM metadata<br>\n<a href=\"/user_uploads/4715/gneyJxfuRftum349CMw3yeVO/metadata_llvm.png\">metadata_llvm.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/gneyJxfuRftum349CMw3yeVO/metadata_llvm.png\" title=\"metadata_llvm.png\"><img src=\"/user_uploads/4715/gneyJxfuRftum349CMw3yeVO/metadata_llvm.png\"></a></div><p>The results look different because I had to use a different command for LLVM which is why it has some extra stuff at the beginning.</p>\n<p>Any way on what could be the issue or how to debug this?</p>\n<p>Thanks!</p>",
        "id": 248724617,
        "sender_full_name": "antoyo",
        "timestamp": 1628354642
    },
    {
        "content": "<p>What is the code you use to create the metadata object file?</p>",
        "id": 248724809,
        "sender_full_name": "bjorn3",
        "timestamp": 1628354924
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"404242\">@antoyo</span></p>",
        "id": 248724901,
        "sender_full_name": "bjorn3",
        "timestamp": 1628355023
    },
    {
        "content": "<p>Is it the code on the master branch?</p>",
        "id": 248724994,
        "sender_full_name": "bjorn3",
        "timestamp": 1628355189
    },
    {
        "content": "<p>Yes, <a href=\"https://github.com/antoyo/rustc_codegen_gcc/blob/master/src/base.rs#L138\">here</a></p>",
        "id": 248725231,
        "sender_full_name": "antoyo",
        "timestamp": 1628355527
    },
    {
        "content": "<p>Could you do <code>readelf --hex-dump .rustc /path/to/proc-macro.so</code> on both proc-macros? What is the result? Are there any differences?</p>",
        "id": 248725306,
        "sender_full_name": "bjorn3",
        "timestamp": 1628355613
    },
    {
        "content": "<p>I'm wondering if the metadata is getting corrupted somehow - it shouldn't be possible to have <code>proc_macro_data</code> be <code>Some</code>, but <code>raw_proc_macros</code> be <code>None</code>: <a href=\"https://github.com/rust-lang/rust/blob/508b328c398b84126011f6fe74d018fe855bc242/compiler/rustc_metadata/src/creader.rs#L418\">https://github.com/rust-lang/rust/blob/508b328c398b84126011f6fe74d018fe855bc242/compiler/rustc_metadata/src/creader.rs#L418</a></p>",
        "id": 248725729,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1628356175
    },
    {
        "content": "<p>Probably. That was why I suggested <code>readelf --hexdump .rustc</code> to see if the metadata is different.</p>",
        "id": 248725777,
        "sender_full_name": "bjorn3",
        "timestamp": 1628356224
    },
    {
        "content": "<p>Here's the readelf for the .so generated with the gcc backend:</p>\n<div class=\"codehilite\"><pre><span></span><code>Vidange hexadécimale de la section « .rustc » :\n  0x01086200 72757374 00000005 ff060000 734e6150 rust........sNaP\n  0x01086210 70590074 0400815a bdb9bf0c 30727573 pY.t...Z....0rus\n  0x01086220 74000000 05000005 a02b010d f0496320 t........+...Ic\n  0x01086230 312e3535 2e302d6e 69676874 6c792028 1.55.0-nightly (\n  0x01086240 62343139 33366239 32203230 32312d30 b41936b92 2021-0\n  0x01086250 372d3230 29000000 52670338 41e04681 7-20)...Rg.8A.F.\n  0x01086260 012d76a9 edff4ca3 01000408 61747472 .-v...L.....attr\n  0x01086270 5f747275 00526703 051d30a2 5348e54a _tru.Rg...0.SH.J\n  0x01086280 35469a01 00040d61 011d1c69 64656e74 5F.....a...ident\n  0x01086290 69747915 3f305ab1 c60f6f51 7abb0100 ity.?0Z...oQz...\n  0x010862a0 0403741d 3a3c524e 972516f3 99110100 ..t.:&lt;RN.%......\n  0x010862b0 04077265 745f2e1c 002cc63b c2447e7b ..ret_...,.;.D~{\n  0x010862c0 820a0100 04084251 00780662 ee0ba817 ......BQ.x.b....\n  0x010862d0 07140000 00140205 06070809 0000cd02 ................\n  0x010862e0 020000db 02040000 e20105f0 4cae0404 ............L...\n  0x010862f0 00008205 06000089 05040000 0024c005 .............$..\n  0x01086300 00000027 0a010a63 72617465 5f747970 ...&#39;...crate_typ\n  0x01086310 65000027 0a020000 02000032 011f050a e..&#39;.......2....\n  0x01086320 70726f63 2d6d6163 726f0000 00340c00 proc-macro...4..\n  0x01086330 00010000 241d0000 00451536 0c6e616d ....$....E.6.nam\n  0x01086340 65011000 04053610 50011f05 0e013604 e.....6.P.....6.\n  0x01086350 5f6d0136 0c5f6465 66213554 10000001 _m.6._def!5T....\n  0x01086360 00004221 00000067 07010766 65617475 ..B!...g...featu\n  0x01086370 7265010d 0006051a 286e0100 007f0100 re......(n......\n  0x01086380 01002010 1d3d2871 756f7465 0000006f .. ..=(quote...o\n  0x01086390 10000526 38641d00 12011601 000000b3 ...&amp;8d..........\n  0x010863a0 01140114 1d2a2165 08696275 012e08b3 .....*!e.ibu....\n  0x010863b0 01142105 050118b1 01170100 0508011e ..!.............\n  0x010863c0 254a1000 00c90145 09050d49 04ef0262 %J.....E...I...b\n  0x010863d0 49000cef 02142c05 46100000 00ed0201 I.....,.F.......\n  0x010863e0 493acc01 10000085 034a0905 08120016 I:.......J......\n  0x010863f0 012710e9 030a010a 19970000 01110039 .&#39;.............9\n  0x01086400 01190101 14e7030d 01000525 ee100000 ...........%....\n  0x01086410 f5032b09 050d3a04 b9043a3a 000cb904 ..+...:...::....\n  0x01086420 0a420136 010104b7 04013a55 10100000 .B.6......:U....\n  0x01086430 c5042f09 050d3e04 95053a3e 000c9505 ../...&gt;...:&gt;....\n  0x01086440 0a4b013a 01010493 05013e04 08695183 .K.:......&gt;..iQ.\n  0x01086450 100000a1 052f0905 0003214c 3a010050 ...../....!L:..P\n  0x01086460 ba010000 03020000 51020000 8b020000 ........Q.......\n  0x01086470 c9020000 de3a2400 010150bc 01000005 .....:$...P.....\n  0x01086480 02000053 0200008d 020000cb 020000b9 ...S............\n  0x01086490 4a500050 02020000 50020000 8a020000 JP.P....P.......\n  0x010864a0 c8020000 07030000 044a2800 44fd0100 .........J(.D...\n  0x010864b0 004b0200 00850200 00c30200 00020301 .K..............\n  0x010864c0 66460100 50f80100 00460200 00800200 fF..P....F......\n  0x010864d0 00be0200 00fd0200 000901b4 462b0042 ............F+.B\n  0x010864e0 010008be 01004188 08000702 09080055 ......A........U\n  0x010864f0 0d08008f 0d0800cd 0d0800e0 0d3a0038 .............:.8\n  0x01086500 0d082e01 0050eb01 00003402 00007802 .....P....4...x.\n  0x01086510 0000b202 0000f002 00003b2e 21000d01 ..........;.!...\n  0x01086520 a0580000 007a0000 00920000 00ae0000 .X...z..........\n  0x01086530 00cb0000 00e50000 00ea0000 00ef0000 ................\n  0x01086540 00f40000 00f90000 00fe0530 0002818f ...........0....\n  0x01086550 6587010f 01ff0108 4a270124 00900400 e.......J&#39;.$....\n  0x01086560 009c0400 00ac61c3 b000732f 686f6d65 ......a...s/home\n  0x01086570 2f626f75 616e746f 2f4f7264 696e6174 /bouanto/Ordinat\n  0x01086580 6575722f 50726f67 72616d6d 6174696f eur/Programmatio\n  0x01086590 6e2f5275 73740113 106a6574 732f85f2 n/Rust...jets/..\n  0x010865a0 805f636f 64656765 6e5f6763 636a6974 ._codegen_gccjit\n  0x010865b0 2f676363 2d746573 742d6261 636b656e /gcc-test-backen\n  0x010865c0 642f59c8 61c66c2f 7372632f 6c69622e d/Y.a.l/src/lib.\n  0x010865d0 72730020 92c87c45 24ac349e 7aa4845f rs. ..|E$.4.z.._\n  0x010865e0 89ef8105 b4320100 88e50524 01000e15 .....2.....$....\n  0x010865f0 011e221e 01190113 01184831 28020118 ..&quot;.......H1(...\n  0x01086600 4d120201 0e2e1102 010e3219 01055c10 M.........2...\\.\n  0x01086610 0000c0ca dbf1d68e 80d8f5e6 f385d0e1 ................\n  0x01086620 cfb8edb8 0100003e 4204b818 7838365f .......&gt;B...x86_\n  0x01086630 36342d75 6e6b6e6f 776e2d6c 696e7578 64-unknown-linux\n  0x01086640 2d676e75 00f5a8b6 ada0c2d5 ba73d2ce -gnu.........s..\n  0x01086650 8dc09388 b8a38101 0100328b 0028010c ..........2..(..\n  0x01086660 0005bb09 28a30428 00090208 50000832 ....(..(....P..2\n  0x01086670 21006e01 00013244 18000004 2c040004 !.n...2D....,...\n  0x01086680 00010000 00000000 0000              ..........\n</code></pre></div>\n<p>and here's the one for the LLVM backend:</p>\n<div class=\"codehilite\"><pre><span></span><code>Vidange hexadécimale de la section « .rustc » :\n  0x00000000 72757374 00000005 ff060000 734e6150 rust........sNaP\n  0x00000010 70590074 04007a5b d8b5bf0c 30727573 pY.t..z[....0rus\n  0x00000020 74000000 05000005 a02b010d f0496320 t........+...Ic\n  0x00000030 312e3535 2e302d6e 69676874 6c792028 1.55.0-nightly (\n  0x00000040 62343139 33366239 32203230 32312d30 b41936b92 2021-0\n  0x00000050 372d3230 29000000 52670338 41e04681 7-20)...Rg.8A.F.\n  0x00000060 012d76a9 edff4ca3 01000408 61747472 .-v...L.....attr\n  0x00000070 5f747275 00526703 051d30a2 5348e54a _tru.Rg...0.SH.J\n  0x00000080 35469a01 00040d61 011d1c69 64656e74 5F.....a...ident\n  0x00000090 69747915 3f305ab1 c60f6f51 7abb0100 ity.?0Z...oQz...\n  0x000000a0 0403741d 3a3c524e 972516f3 99110100 ..t.:&lt;RN.%......\n  0x000000b0 04077265 745f2e1c 002cc63b c2447e7b ..ret_...,.;.D~{\n  0x000000c0 820a0100 04084251 00780662 ee0ba817 ......BQ.x.b....\n  0x000000d0 07140000 00140205 06070809 0000cd02 ................\n  0x000000e0 020000db 02040000 e20105f0 4cae0404 ............L...\n  0x000000f0 00008205 06000089 05040000 0024c005 .............$..\n  0x00000100 00000027 0a010a63 72617465 5f747970 ...&#39;...crate_typ\n  0x00000110 65000027 0a020000 02000032 011f050a e..&#39;.......2....\n  0x00000120 70726f63 2d6d6163 726f0000 00340c00 proc-macro...4..\n  0x00000130 00010000 241d0000 00451536 0c6e616d ....$....E.6.nam\n  0x00000140 65011000 04053610 50011f05 0e013604 e.....6.P.....6.\n  0x00000150 5f6d0136 0c5f6465 66213554 10000001 _m.6._def!5T....\n  0x00000160 00004221 00000067 07010766 65617475 ..B!...g...featu\n  0x00000170 7265010d 0006051a 286e0100 007f0100 re......(n......\n  0x00000180 01002010 1d3d2871 756f7465 0000006f .. ..=(quote...o\n  0x00000190 10000526 38641d00 12011601 000000b3 ...&amp;8d..........\n  0x000001a0 01140114 1d2a2165 08696275 012e08b3 .....*!e.ibu....\n  0x000001b0 01142105 050118b1 01170100 0508011e ..!.............\n  0x000001c0 254a1000 00c90145 09050d49 04ef0262 %J.....E...I...b\n  0x000001d0 49000cef 02142c05 46100000 00ed0201 I.....,.F.......\n  0x000001e0 493acc01 10000085 034a0905 08120016 I:.......J......\n  0x000001f0 012710e9 030a010a 19970000 01110039 .&#39;.............9\n  0x00000200 01190101 14e7030d 01000525 ee100000 ...........%....\n  0x00000210 f5032b09 050d3a04 b9043a3a 000cb904 ..+...:...::....\n  0x00000220 0a420136 010104b7 04013a55 10100000 .B.6......:U....\n  0x00000230 c5042f09 050d3e04 95053a3e 000c9505 ../...&gt;...:&gt;....\n  0x00000240 0a4b013a 01010493 05013e04 08695183 .K.:......&gt;..iQ.\n  0x00000250 100000a1 052f0905 0003214c 3a010050 ...../....!L:..P\n  0x00000260 ba010000 03020000 51020000 8b020000 ........Q.......\n  0x00000270 c9020000 de3a2400 010150bc 01000005 .....:$...P.....\n  0x00000280 02000053 0200008d 020000cb 020000b9 ...S............\n  0x00000290 4a500050 02020000 50020000 8a020000 JP.P....P.......\n  0x000002a0 c8020000 07030000 044a2800 44fd0100 .........J(.D...\n  0x000002b0 004b0200 00850200 00c30200 00020301 .K..............\n  0x000002c0 66460100 50f80100 00460200 00800200 fF..P....F......\n  0x000002d0 00be0200 00fd0200 000901b4 462b0042 ............F+.B\n  0x000002e0 010008be 01004188 08000702 09080055 ......A........U\n  0x000002f0 0d08008f 0d0800cd 0d0800e0 0d3a0038 .............:.8\n  0x00000300 0d082e01 0050eb01 00003402 00007802 .....P....4...x.\n  0x00000310 0000b202 0000f002 00003b2e 21000d01 ..........;.!...\n  0x00000320 a0580000 007a0000 00920000 00ae0000 .X...z..........\n  0x00000330 00cb0000 00e50000 00ea0000 00ef0000 ................\n  0x00000340 00f40000 00f90000 00fe0530 0002818f ...........0....\n  0x00000350 6587010f 01ff0108 4a270124 00900400 e.......J&#39;.$....\n  0x00000360 009c0400 00ac61c3 b000732f 686f6d65 ......a...s/home\n  0x00000370 2f626f75 616e746f 2f4f7264 696e6174 /bouanto/Ordinat\n  0x00000380 6575722f 50726f67 72616d6d 6174696f eur/Programmatio\n  0x00000390 6e2f5275 73740113 106a6574 732f85f2 n/Rust...jets/..\n  0x000003a0 805f636f 64656765 6e5f6763 636a6974 ._codegen_gccjit\n  0x000003b0 2f676363 2d746573 742d6261 636b656e /gcc-test-backen\n  0x000003c0 642f59c8 61c66c2f 7372632f 6c69622e d/Y.a.l/src/lib.\n  0x000003d0 72730020 92c87c45 24ac349e 7aa4845f rs. ..|E$.4.z.._\n  0x000003e0 89ef8105 b4320100 88e50524 01000e15 .....2.....$....\n  0x000003f0 011e221e 01190113 01184831 28020118 ..&quot;.......H1(...\n  0x00000400 4d120201 0e2e1102 010e3219 01055c10 M.........2...\\.\n  0x00000410 0000c0ca dbf1d68e 80d8f5e6 f385d0e1 ................\n  0x00000420 cfb8edb8 0100003e 4204b818 7838365f .......&gt;B...x86_\n  0x00000430 36342d75 6e6b6e6f 776e2d6c 696e7578 64-unknown-linux\n  0x00000440 2d676e75 00f8e5fa 9797c0f2 8b4fd2ce -gnu.........O..\n  0x00000450 8dc09388 b8a38101 0100328b 0028010c ..........2..(..\n  0x00000460 0005bb09 28a30428 00090208 50000832 ....(..(....P..2\n  0x00000470 21006e01 00013244 18000004 2c040004 !.n...2D....,...\n  0x00000480 00010000 00000000 0000              ..........\n</code></pre></div>\n<p>There are a few bytes at the beginning and at the end that are different. Not sure what those bytes mean.</p>",
        "id": 248739698,
        "sender_full_name": "antoyo",
        "timestamp": 1628376688
    },
    {
        "content": "<p>This shouldn't be the problem, but can you try using the snap version in the sysroot instead of from <a href=\"http://crates.io\">crates.io</a>? The difference could be different compression by different versions of snap or it could be actual corruption.</p>",
        "id": 248757955,
        "sender_full_name": "bjorn3",
        "timestamp": 1628408314
    },
    {
        "content": "<p>Same problem when using the sysroot version.</p>",
        "id": 248768154,
        "sender_full_name": "antoyo",
        "timestamp": 1628425549
    },
    {
        "content": "<p>I decompressed the data using</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#![feature(rustc_private)]</span><span class=\"w\"></span>\n\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"k\">crate</span><span class=\"w\"> </span><span class=\"n\">snap</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"k\">crate</span><span class=\"w\"> </span><span class=\"n\">rustc_metadata</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">io</span>::<span class=\"n\">Read</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">fs</span>::<span class=\"n\">read_to_string</span><span class=\"p\">(</span><span class=\"s\">\"cg_llvm.metadata.hex\"</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"n\">lines</span><span class=\"p\">().</span><span class=\"n\">skip</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">).</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">line</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">line</span><span class=\"p\">.</span><span class=\"n\">trim</span><span class=\"p\">().</span><span class=\"n\">split_once</span><span class=\"p\">(</span><span class=\"sc\">' '</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">().</span><span class=\"mf\">1.</span><span class=\"n\">split</span><span class=\"p\">(</span><span class=\"sc\">' '</span><span class=\"p\">).</span><span class=\"n\">take</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">).</span><span class=\"n\">collect</span>::<span class=\"o\">&lt;</span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">().</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"s\">\"\"</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}).</span><span class=\"n\">collect</span>::<span class=\"o\">&lt;</span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">().</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"s\">\"\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"{}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;*</span><span class=\"n\">data</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">raw_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"fm\">vec!</span><span class=\"p\">[];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">is_empty</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">byte</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"o\">..</span><span class=\"mi\">2</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">data</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"o\">..</span><span class=\"p\">];</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">byte</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kt\">u8</span>::<span class=\"n\">from_str_radix</span><span class=\"p\">(</span><span class=\"n\">byte</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">16</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">raw_data</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">byte</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">raw_data</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"o\">..</span><span class=\"n\">rustc_metadata</span>::<span class=\"n\">METADATA_HEADER</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">()],</span><span class=\"w\"> </span><span class=\"n\">rustc_metadata</span>::<span class=\"n\">METADATA_HEADER</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">compressed_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">raw_data</span><span class=\"p\">[</span><span class=\"n\">rustc_metadata</span>::<span class=\"n\">METADATA_HEADER</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">()</span><span class=\"o\">..</span><span class=\"p\">];</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">uncompressed_data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Vec</span>::<span class=\"n\">new</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">snap</span>::<span class=\"n\">read</span>::<span class=\"n\">FrameDecoder</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">compressed_data</span><span class=\"p\">).</span><span class=\"n\">read_to_end</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">uncompressed_data</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">byte</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">uncompressed_data</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"fm\">print!</span><span class=\"p\">(</span><span class=\"s\">\"{:02x}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">byte</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"fm\">println!</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 248770860,
        "sender_full_name": "bjorn3",
        "timestamp": 1628429452
    },
    {
        "content": "<p>The difference at the start of the compressed metadata doesn't change the decompressed data, but the one at the end does.</p>",
        "id": 248770888,
        "sender_full_name": "bjorn3",
        "timestamp": 1628429508
    },
    {
        "content": "<p>The hex dump diff is:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gd\">--- cg_llvm.hex 2021-08-08 15:33:21.752470348 +0200</span>\n<span class=\"gi\">+++ cg_gcc.hex  2021-08-08 15:33:13.912441424 +0200</span>\n<span class=\"gu\">@@ -91,8 +91,8 @@</span>\n │00000590│ 8e 80 d8 f5 e6 f3 85 d0 ┊ e1 cf b8 ed b8 01 00 00 │××××××××┊×××××•00│\n │000005a0│ 0e 70 72 6f 63 5f 6d 61 ┊ 63 72 6f 5f 64 65 66 00 │•proc_ma┊cro_def0│\n │000005b0│ 18 78 38 36 5f 36 34 2d ┊ 75 6e 6b 6e 6f 77 6e 2d │•x86_64-┊unknown-│\n<span class=\"gd\">-│000005c0│ 6c 69 6e 75 78 2d 67 6e ┊ 75 00 f8 e5 fa 97 97 c0 │linux-gn┊u0××××××│</span>\n<span class=\"gd\">-│000005d0│ f2 8b 4f d2 ce 8d c0 93 ┊ 88 b8 a3 81 01 01 00 00 │××O×××××┊××××••00│</span>\n<span class=\"gi\">+│000005c0│ 6c 69 6e 75 78 2d 67 6e ┊ 75 00 f5 a8 b6 ad a0 c2 │linux-gn┊u0××××××│</span>\n<span class=\"gi\">+│000005d0│ d5 ba 73 d2 ce 8d c0 93 ┊ 88 b8 a3 81 01 01 00 00 │××s×××××┊××××••00│</span>\n │000005e0│ 00 00 00 00 00 00 00 00 ┊ 00 00 00 00 01 0c 00 05 │00000000┊0000•_0•│\n │000005f0│ bb 09 28 a3 04 28 00 28 ┊ 00 28 00 28 00 50 00 08 │×_(×•(0(┊0(0(0P0•│\n │00000600│ 00 00 00 00 00 00 00 00 ┊ 00 00 00 00 00 00 00 00 │00000000┊00000000│\n</code></pre></div>",
        "id": 248771003,
        "sender_full_name": "bjorn3",
        "timestamp": 1628429647
    },
    {
        "content": "<p>I debug printed the decoded value I got in <code>write_compressed_metadata()</code> and I can tell those are the same as the green bytes.</p>",
        "id": 248771946,
        "sender_full_name": "antoyo",
        "timestamp": 1628430908
    },
    {
        "content": "<p>Ah, that is the crate hash: <a href=\"https://github.com/rust-lang/rust/blob/1f94abcda6884893d4723304102089198caa0839/compiler/rustc_metadata/src/rmeta/encoder.rs#L682\">https://github.com/rust-lang/rust/blob/1f94abcda6884893d4723304102089198caa0839/compiler/rustc_metadata/src/rmeta/encoder.rs#L682</a> Of course that one is different.</p>",
        "id": 248773905,
        "sender_full_name": "bjorn3",
        "timestamp": 1628433949
    },
    {
        "content": "<p>So, you're saying the metadata is basically the same between the two libraries?</p>",
        "id": 248775096,
        "sender_full_name": "antoyo",
        "timestamp": 1628435520
    },
    {
        "content": "<p>Yes, it seems so.</p>",
        "id": 248777267,
        "sender_full_name": "bjorn3",
        "timestamp": 1628438820
    },
    {
        "content": "<p>So I was thinking if maybe a detail in the way it is written to the object file differs in such a way that the metadata reader reads it incorrectly.</p>",
        "id": 248777329,
        "sender_full_name": "bjorn3",
        "timestamp": 1628438891
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"404242\">@antoyo</span></p>",
        "id": 248777336,
        "sender_full_name": "bjorn3",
        "timestamp": 1628438925
    },
    {
        "content": "<p>I'm not sure I understand what you mean.</p>\n<p>I just tried writing the LLVM metadata manually in my GCC backend (instead of using what rustc gives you) and I still get the same error.</p>\n<p>One thing I just noticed is that the LLVM output (metadata in the hexdump) is at address 0 while the gcc ouput is at a bigger address. Could this be an issue?</p>",
        "id": 248781953,
        "sender_full_name": "antoyo",
        "timestamp": 1628446436
    },
    {
        "content": "<p>The address being non-zero means that <a href=\"https://github.com/antoyo/rustc_codegen_gcc/blob/8b6a696e965e67ce9b3b45b8b66425dca728d81e/src/base.rs#L170\">https://github.com/antoyo/rustc_codegen_gcc/blob/8b6a696e965e67ce9b3b45b8b66425dca728d81e/src/base.rs#L170</a> doesn't work I think. It shouldn't cause any issues though I think.</p>",
        "id": 248788167,
        "sender_full_name": "bjorn3",
        "timestamp": 1628455645
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"404242\">@antoyo</span> could you share the proc macro generated by cg_gcc with me so I can try some things locally.</p>",
        "id": 248788222,
        "sender_full_name": "bjorn3",
        "timestamp": 1628455694
    },
    {
        "content": "<p>It is compiled for x86_64-unknown-linux-gnu, right?</p>",
        "id": 248788232,
        "sender_full_name": "bjorn3",
        "timestamp": 1628455732
    },
    {
        "content": "<p>Yup. I uploaded the proc macro <a href=\"https://framadrive.org/s/zrmPkC3fq6Srq6k\">there</a>.</p>",
        "id": 248791161,
        "sender_full_name": "antoyo",
        "timestamp": 1628460256
    },
    {
        "content": "<p>thanks</p>",
        "id": 248791325,
        "sender_full_name": "bjorn3",
        "timestamp": 1628460506
    },
    {
        "content": "<p>I haven't had much time to look at what it means, but here are the logs:</p>\n<div class=\"codehilite\"><pre><span></span><code> INFO rustc_metadata::creader resolving crate `proc_macro_def`\n INFO rustc_metadata::creader falling back to a load\n INFO rustc_metadata::locator dylib reading metadata from: /path/to/rustc_codegen_gccjit/libproc_macro_def.so\n INFO rustc_metadata::locator Rejecting via proc macro: expected false got true\n INFO rustc_metadata::locator metadata mismatch\n INFO rustc_metadata::locator dylib reading metadata from: /path/to/rustc_codegen_gccjit/libproc_macro_def.so\n INFO rustc_metadata::creader register crate `proc_macro_def` (cnum = 19. private_dep = false)\n</code></pre></div>\n<p>If I recall correctly the <code>falling back to a load</code> is what causes <code>proc_macro</code> to be false. I'll check that tomorrow.</p>",
        "id": 248931437,
        "sender_full_name": "antoyo",
        "timestamp": 1628560006
    },
    {
        "content": "<p>Err… maybe not actually. The output for the LLVM (working) version is the same:</p>\n<div class=\"codehilite\"><pre><span></span><code> INFO rustc_metadata::creader resolving crate `proc_macro_def`\n INFO rustc_metadata::creader falling back to a load\n INFO rustc_metadata::locator dylib reading metadata from: /path/to/rustc_codegen_gccjit/libproc_macro_def_llvm.so\n INFO rustc_metadata::locator Rejecting via proc macro: expected false got true\n INFO rustc_metadata::locator metadata mismatch\n INFO rustc_metadata::locator dylib reading metadata from: /path/to/rustc_codegen_gccjit/libproc_macro_def_llvm.so\n INFO rustc_metadata::creader register crate `proc_macro_def` (cnum = 19. private_dep = false)\n</code></pre></div>",
        "id": 248931621,
        "sender_full_name": "antoyo",
        "timestamp": 1628560206
    },
    {
        "content": "<p>I did some more debugging and found something really strange:<br>\n<a href=\"/user_uploads/4715/tqOKzE9azDagelYoa6tYRdLl/rustc-logs.png\">rustc-logs.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/tqOKzE9azDagelYoa6tYRdLl/rustc-logs.png\" title=\"rustc-logs.png\"><img src=\"/user_uploads/4715/tqOKzE9azDagelYoa6tYRdLl/rustc-logs.png\"></a></div><p>I don't understand how the value can be mutated from Some (at step 5) to None (the info line right after).</p>\n<p>A LLVM generated proc-macro .so file will show the correct log lines:</p>\n<div class=\"codehilite\"><pre><span></span><code> INFO rustc_metadata::creader 5: true\n INFO rustc_metadata::creader raw_proc_macros: true (true)\n</code></pre></div>\n<p>Any idea what could cause what looks like a memory corruption?</p>",
        "id": 250686986,
        "sender_full_name": "antoyo",
        "timestamp": 1629927700
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/blob/1f94abcda6884893d4723304102089198caa0839/compiler/rustc_metadata/src/creader.rs#L690\">https://github.com/rust-lang/rust/blob/1f94abcda6884893d4723304102089198caa0839/compiler/rustc_metadata/src/creader.rs#L690</a></p>\n<p>if <code>lib.symbol(&amp;sym)</code> returns a pointer to a null pointer you get a null pointer reference which is UB. <code>raw_proc_macros</code> is an <code>Option&lt;&amp;'static [ProcMacro]&gt;</code>. When using <code>Option&lt;&amp;T&gt;</code> the <code>None</code> variant is represented as null pointer.</p>",
        "id": 250733967,
        "sender_full_name": "bjorn3",
        "timestamp": 1629962790
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"404242\">@antoyo</span> Of course. I think I know what is going on. Your hack around the fact that libgccjit doesn't allow initializing static variables means that this symbol points to zero-initialized memory before the function initializing static variables is called.</p>",
        "id": 250734169,
        "sender_full_name": "bjorn3",
        "timestamp": 1629962929
    }
]