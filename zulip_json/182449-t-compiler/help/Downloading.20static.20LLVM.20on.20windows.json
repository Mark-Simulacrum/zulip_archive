[
    {
        "content": "<p>So I found that <code>download-ci-llvm = true</code> actually works without changes on windows if you do the following things:</p>\n<ul>\n<li>Build LLVM from source (<code>x.py --stage 0 compiler/rustc</code> and cancel it when it starts cargo)</li>\n<li><code>cp -r build/$TARGET/llvm build/$TARGET/ci-llvm</code></li>\n<li>Add <code>[llvm] download-ci-llvm = true</code> in config.toml</li>\n<li>Apply the following diff to bootstrap:</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/src/bootstrap/config.rs b/src/bootstrap/config.rs</span>\n<span class=\"gh\">index f4d89a89c14..448cdf7bbc7 100644</span>\n<span class=\"gd\">--- a/src/bootstrap/config.rs</span>\n<span class=\"gi\">+++ b/src/bootstrap/config.rs</span>\n<span class=\"gu\">@@ -817,7 +817,7 @@ pub fn parse(args: &amp;[String]) -&gt; Config {</span>\n                 check_ci_llvm!(llvm.polly);\n\n                 // CI-built LLVM is shared\n<span class=\"gd\">-                config.llvm_link_shared = true;</span>\n<span class=\"gi\">+                //config.llvm_link_shared = true;</span>\n             }\n\n             if config.llvm_thin_lto {\n</code></pre></div>\n<p>So I think this might actually be doable! As I see it, there are two things we need to do to actually make this work without hacks:</p>\n<ol>\n<li>Add the static LLVM libraries to <code>rust-dev</code> on CI. Right now the <code>lib/</code> folder is completely missing.</li>\n<li>Detect whether the downloaded LLVM is using dynamic or static linking in bootstrap. Right now it unconditionally assumes dynamic linking - maybe this is as easy as adding a sentinal file?</li>\n</ol>\n<p><span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> what do you think? :)<br>\ncc <span class=\"user-mention\" data-user-id=\"224471\">@Lokathor</span></p>",
        "id": 222369943,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610405791
    },
    {
        "content": "<p>I know this doesn't use dynamic linking which you wanted to do, but just saving the initial build is worth it I think</p>",
        "id": 222370058,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610405877
    },
    {
        "content": "<p>especially since I don't think ThinLTO runs at all in debug mode, and I expect most people to use this in debug mode</p>",
        "id": 222370126,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610405903
    },
    {
        "content": "<p>dynamic linking is not necessary on my side</p>",
        "id": 222371024,
        "sender_full_name": "simulacrum",
        "timestamp": 1610406411
    },
    {
        "content": "<p>that's more of a thinlto thing</p>",
        "id": 222371035,
        "sender_full_name": "simulacrum",
        "timestamp": 1610406416
    },
    {
        "content": "<p>we don't use thinlto on windows</p>",
        "id": 222371046,
        "sender_full_name": "simulacrum",
        "timestamp": 1610406422
    },
    {
        "content": "<p>ok great! should I make a PR uploading the static files to S3?</p>",
        "id": 222371145,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610406490
    },
    {
        "content": "<p>(also, is there a way to test the behavior without having to get it merged to master first?)</p>",
        "id": 222371168,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610406512
    },
    {
        "content": "<p>yep you can switch try to produce windows artifacts, just edit the file</p>",
        "id": 222371187,
        "sender_full_name": "simulacrum",
        "timestamp": 1610406526
    },
    {
        "content": "<p>which file, sorry? <a href=\"http://dist.rs\">dist.rs</a>?</p>",
        "id": 222371318,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610406604
    },
    {
        "content": "<p>Uh ci.yml somewhere, there's two, one should tell you to edit the other at the top</p>",
        "id": 222371377,
        "sender_full_name": "simulacrum",
        "timestamp": 1610406646
    },
    {
        "content": "<p>Sorry not at a computer</p>",
        "id": 222371391,
        "sender_full_name": "simulacrum",
        "timestamp": 1610406660
    },
    {
        "content": "<p>np, that gets me close enough</p>",
        "id": 222371407,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610406671
    },
    {
        "content": "<p>Look in .GitHub first that'll give you the non canonical one with instructions</p>",
        "id": 222371421,
        "sender_full_name": "simulacrum",
        "timestamp": 1610406687
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222371187\">said</a>:</p>\n<blockquote>\n<p>yep you can switch try to produce windows artifacts, just edit the file</p>\n</blockquote>\n<p>I found</p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code>  <span class=\"nt\">try</span><span class=\"p\">:</span>\n    <span class=\"nt\">&lt;&lt;</span><span class=\"p\">:</span> <span class=\"nv\">*base-ci-job</span>\n    <span class=\"nt\">name</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">try</span>\n    <span class=\"nt\">env</span><span class=\"p\">:</span>\n      <span class=\"nt\">&lt;&lt;</span><span class=\"p\">:</span> <span class=\"p p-Indicator\">[</span><span class=\"nv\">*shared-ci-variables</span><span class=\"p p-Indicator\">,</span> <span class=\"nv\">*prod-variables</span><span class=\"p p-Indicator\">]</span>\n    <span class=\"nt\">if</span><span class=\"p\">:</span> <span class=\"l l-Scalar l-Scalar-Plain\">github.event_name == 'push' &amp;&amp; (github.ref == 'refs/heads/try' || github.ref == 'refs/heads/try-perf') &amp;&amp; github.repository == 'rust-lang-ci/rust'</span>\n    <span class=\"nt\">strategy</span><span class=\"p\">:</span>\n      <span class=\"nt\">matrix</span><span class=\"p\">:</span>\n        <span class=\"nt\">include</span><span class=\"p\">:</span>\n          <span class=\"p p-Indicator\">-</span> <span class=\"nv\">*dist-x86_64-linux</span>\n</code></pre></div>\n<p>in <code>src/ci/githuib-actions/ci.yml</code>. Should I add <code>dist-x86_64-pc-windows-msvc</code>? That adds an extra job, which doesn't seem quite right</p>",
        "id": 222380529,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610413601
    },
    {
        "content": "<p>the only mention of LLVM I see in that file is <code>--set llvm.ninja=false</code></p>",
        "id": 222380634,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610413725
    },
    {
        "content": "<p>oh wait I think I misunderstood - was the bit about windows artifacts a way for me to test my changes with <code>rustup-toolchain-install-master</code>?</p>",
        "id": 222380658,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610413752
    },
    {
        "content": "<p>ok yes, and the bit where bootstrap actually uploads LLVM artifacts to s3 is <code>dist::maybe_install_llvm</code> I think</p>",
        "id": 222380851,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610413976
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/pull/80932\">https://github.com/rust-lang/rust/pull/80932</a> (but no idea if it works yet)</p>",
        "id": 222382324,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610415437
    },
    {
        "content": "<p>if someone uses windows and wants to help test, please let me know!</p>",
        "id": 222382334,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610415448
    },
    {
        "content": "<p>how do I cancel a <code>@bors try</code>? I forgot to run expand-yaml-anchors :/</p>",
        "id": 222382449,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610415561
    },
    {
        "content": "<p>does anyone understand this error?</p>\n<div class=\"codehilite\"><pre><span></span><code>error: failed to expand src/ci/github-actions/ci.yml into .github/workflows/ci.yml\ncaused by: failed to parse src/ci/github-actions/ci.yml\ncaused by: while parsing node, found unknown anchor at line 647 column 13\n</code></pre></div>\n<p>that line is </p>\n<div class=\"codehilite\" data-code-language=\"YAML\"><pre><span></span><code>        <span class=\"nt\">include</span><span class=\"p\">:</span>\n          <span class=\"p p-Indicator\">-</span> <span class=\"nv\">*dist-x86_64-msvc</span>\n</code></pre></div>",
        "id": 222382707,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610415798
    },
    {
        "content": "<p>I checked and there's a msvc job on line 580 :/</p>",
        "id": 222382783,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610415855
    },
    {
        "content": "<p>ok I think this worked:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/src/ci/github-actions/ci.yml b/src/ci/github-actions/ci.yml</span>\n<span class=\"gh\">index 56e9623b2c1..d4df212cd0c 100644</span>\n<span class=\"gd\">--- a/src/ci/github-actions/ci.yml</span>\n<span class=\"gi\">+++ b/src/ci/github-actions/ci.yml</span>\n<span class=\"gu\">@@ -577,7 +577,8 @@ jobs:</span>\n               CUSTOM_MINGW: 1\n             &lt;&lt;: *job-windows-xl\n\n<span class=\"gd\">-          - name: dist-x86_64-msvc</span>\n<span class=\"gi\">+          - &amp;dist-x86_64-msvc</span>\n<span class=\"gi\">+            name: dist-x86_64-msvc</span>\n             env:\n               RUST_CONFIGURE_ARGS: &gt;-\n                 --build=x86_64-pc-windows-msvc\n</code></pre></div>",
        "id": 222382901,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610415964
    },
    {
        "content": "<p>does anyone know what this means?</p>\n<div class=\"codehilite\"><pre><span></span><code>llvm-config: error: component libraries and shared library\n\n llvm-config: error: missing: D:\\a\\rust\\rust\\build\\x86_64-pc-windows-msvc\\llvm\\build\\lib\\gtest.lib\nllvm-config: error: missing: D:\\a\\rust\\rust\\build\\x86_64-pc-windows-msvc\\llvm\\build\\lib\\gtest_main.lib\nllvm-config: error: missing: D:\\a\\rust\\rust\\build\\x86_64-pc-windows-msvc\\llvm\\build\\lib\\LLVMTestingSupport.lib\nthread &#39;main&#39; panicked at &#39;command did not execute successfully: &quot;D:\\\\a\\\\rust\\\\rust\\\\build\\\\x86_64-pc-windows-msvc\\\\llvm\\\\build\\\\bin\\\\llvm-config.exe&quot; &quot;--libfiles&quot;\n</code></pre></div>",
        "id": 222386245,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610419998
    },
    {
        "content": "<p>I think it's coming from <a href=\"https://github.com/rust-lang/rust/blob/fe531d5a5f1404281e3fb237daaf87b8180bd13d/src/bootstrap/dist.rs#L1847\">https://github.com/rust-lang/rust/blob/fe531d5a5f1404281e3fb237daaf87b8180bd13d/src/bootstrap/dist.rs#L1847</a></p>",
        "id": 222386260,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610420026
    },
    {
        "content": "<p>the same command locally works fine :/ <a href=\"https://hastebin.com/acoborigor.apache\">https://hastebin.com/acoborigor.apache</a></p>",
        "id": 222386414,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610420264
    },
    {
        "content": "<p>oh boo it got deleted, but it was a bunch of <code>.lib</code> files in <code>build/$TARGET/llvm</code></p>",
        "id": 222386475,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610420293
    },
    {
        "content": "<p>the llvm-config error is emitted here: <a href=\"https://github.com/rust-lang/llvm-project/blob/fb115ee43b77601b237717c21ab0a8f5b5b9d50a/llvm/tools/llvm-config/llvm-config.cpp#L649\">https://github.com/rust-lang/llvm-project/blob/fb115ee43b77601b237717c21ab0a8f5b5b9d50a/llvm/tools/llvm-config/llvm-config.cpp#L649</a></p>",
        "id": 222387439,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610421496
    },
    {
        "content": "<p>my best guess is that LLVM expects the test libraries to be built but they aren't? I don't know why tests would be necessary just to run <code>--libfiles</code></p>",
        "id": 222387446,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610421518
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"138448\">@cuviper</span> do you happen to have ideas? or know who I would ask?</p>",
        "id": 222387448,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610421531
    },
    {
        "content": "<p>I'm not sure -- usually I build dynamic</p>",
        "id": 222390380,
        "sender_full_name": "cuviper",
        "timestamp": 1610425410
    },
    {
        "content": "<p>(and I haven't booted Windows in months... <span aria-label=\"wink\" class=\"emoji emoji-1f609\" role=\"img\" title=\"wink\">:wink:</span> )</p>",
        "id": 222390390,
        "sender_full_name": "cuviper",
        "timestamp": 1610425433
    },
    {
        "content": "<p>I don't think this is actually related to windows</p>",
        "id": 222390624,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610425759
    },
    {
        "content": "<p>it looks rustbuild has never called <code>llvm-config --libfiles</code> with  static linking before</p>",
        "id": 222390628,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610425775
    },
    {
        "content": "<p>I think for now I'll try enabling the test components and see if it helps</p>",
        "id": 222390738,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610425917
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232545\">@Joshua Nelson</span> it might help to look at llvm-config's help and explicitly tell it you are using static files, but it's quite possible that the tool itself is broken - I ran into quite a few bugs myself.</p>",
        "id": 222426334,
        "sender_full_name": "simulacrum",
        "timestamp": 1610456439
    },
    {
        "content": "<p>I'm waiting to work on this more until a friend with a windows machine has time to help - 45 minute turnaround times are really frustrating</p>",
        "id": 222436234,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610461097
    },
    {
        "content": "<p>is there a way to link statically on linux btw? that would let me test locally</p>",
        "id": 222436257,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610461110
    },
    {
        "content": "<p>not sure exactly but you can install .NET on linux</p>",
        "id": 222437139,
        "sender_full_name": "oliver",
        "timestamp": 1610461495
    },
    {
        "content": "<p>that's how you would compile C#</p>",
        "id": 222437306,
        "sender_full_name": "oliver",
        "timestamp": 1610461564
    },
    {
        "content": "<p>I don't need a windows runtime environment, I just need static linking to work</p>",
        "id": 222437341,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610461581
    },
    {
        "content": "<p>I'm trying link-shared = false for now</p>",
        "id": 222437364,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610461592
    },
    {
        "content": "<p>yeah I'm not certain</p>",
        "id": 222437398,
        "sender_full_name": "oliver",
        "timestamp": 1610461608
    },
    {
        "content": "<p>apparently that means I have to rebuild llvm <span aria-label=\"sob\" class=\"emoji emoji-1f62d\" role=\"img\" title=\"sob\">:sob:</span></p>",
        "id": 222438386,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610462014
    },
    {
        "content": "<p>ayyy that worked <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> only took 35 minutes to find out <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span> </p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;main&#39; panicked at &#39;Error: File &quot;/home/joshua/rustc2/build/x86_64-unknown-linux-gnu/llvm/build/lib/libLLVMXRay.a /home/joshua/rustc2/build/x86_64-unknown-linux-gnu/llvm/build/lib/libLLVMWindowsManifest.a /home/joshua/rustc2/build/x86_64-unknown-linux-gnu/llvm/build/lib/libLLVMTestingSupport.a /home/joshua/rustc2/build/x86_64-unknown-li\n</code></pre></div>",
        "id": 222443550,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610464107
    },
    {
        "content": "<p>what is libLLVMWindowsManifest.a?</p>",
        "id": 222448241,
        "sender_full_name": "oliver",
        "timestamp": 1610465906
    },
    {
        "content": "<p>these are static libraries used by LLVM</p>",
        "id": 222451089,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610467004
    },
    {
        "content": "<p>by default they're all shoved together into one giant <code>libLLVM.so</code> file, I changed it to use separate archive files to replicate the windows behavior</p>",
        "id": 222451141,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610467025
    },
    {
        "content": "<p>the 'file not found error' is a pre-existing bug - it should be splitting on spaces, not lines. It didn't show up before because when linking dynamically there's only one .so file.</p>",
        "id": 222451204,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610467053
    },
    {
        "content": "<p>is there a way to tell x.py dist 'run <code>RustDev</code> first'? Right now it takes like 5 minutes repackaging <code>rustc</code> and the docs every time</p>",
        "id": 222460615,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610470483
    },
    {
        "content": "<p>I tried</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/src/bootstrap/builder.rs b/src/bootstrap/builder.rs</span>\n<span class=\"gh\">index ec9ce4c820c..a49512cd4e4 100644</span>\n<span class=\"gd\">--- a/src/bootstrap/builder.rs</span>\n<span class=\"gi\">+++ b/src/bootstrap/builder.rs</span>\n<span class=\"gu\">@@ -450,6 +450,7 @@ fn get_step_descriptions(kind: Kind) -&gt; Vec&lt;StepDescription&gt; {</span>\n                 doc::EditionGuide,\n             ),\n             Kind::Dist =&gt; describe!(\n<span class=\"gi\">+                dist::RustDev,</span>\n                 dist::Docs,\n                 dist::RustcDocs,\n                 dist::Mingw,\n<span class=\"gu\">@@ -467,7 +468,6 @@ fn get_step_descriptions(kind: Kind) -&gt; Vec&lt;StepDescription&gt; {</span>\n                 dist::Clippy,\n                 dist::Miri,\n                 dist::LlvmTools,\n<span class=\"gd\">-                dist::RustDev,</span>\n                 dist::Extended,\n                 dist::BuildManifest,\n                 dist::ReproducibleArtifacts,\n</code></pre></div>\n<p>but it didn't seem to do anythign</p>",
        "id": 222460863,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610470564
    },
    {
        "content": "<p>oh I see it's there I just missed it</p>",
        "id": 222462039,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610471004
    },
    {
        "content": "<p>well this is certainly encouraging</p>\n<div class=\"codehilite\"><pre><span></span><code>&gt; tar -tf build/dist/rust-dev-1.51.0-dev-x86_64-unknown-linux-gnu.tar.xz  | grep &#39;\\.a$&#39; | head\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMMCA.a\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMDebugInfoPDB.a\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMMC.a\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMDebugInfoDWARF.a\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMDebugInfoMSF.a\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMSelectionDAG.a\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMTextAPI.a\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMObjectYAML.a\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMDebugInfoGSYM.a\nrust-dev-1.51.0-dev-x86_64-unknown-linux-gnu/rust-dev/lib/libLLVMLTO.a\n</code></pre></div>",
        "id": 222462230,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610471068
    },
    {
        "content": "<p>time for another try run :)</p>",
        "id": 222462243,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610471072
    },
    {
        "content": "<p>hmm, bors seems to be confused?</p>\n<p><a href=\"https://github.com/rust-lang/rust/pull/80932/#issuecomment-758804138\">https://github.com/rust-lang/rust/pull/80932/#issuecomment-758804138</a></p>",
        "id": 222464406,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610471852
    },
    {
        "content": "<p><span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span>  <a href=\"https://github.com/rust-lang/rust/pull/80932/#issuecomment-758845857\">https://github.com/rust-lang/rust/pull/80932/#issuecomment-758845857</a></p>",
        "id": 222473320,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610475748
    },
    {
        "content": "<p>does someone with a windows box have a second to try it out?</p>",
        "id": 222474009,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610476044
    },
    {
        "content": "<p>it should be as simple as on linux :) just <code>[llvm] download-ci-llvm = true</code> in config.toml</p>",
        "id": 222474046,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610476061
    },
    {
        "content": "<p>if you have a Mac I would also be interested to know if it works on MacOS</p>",
        "id": 222476902,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610477342
    },
    {
        "content": "<p>I have a windows VM with a checkout (which takes _ages_!) but currently busy T_T</p>",
        "id": 222495612,
        "sender_full_name": "nagisa",
        "timestamp": 1610486154
    },
    {
        "content": "<p>if nobody takes a step forward I'll get to it in ~hour</p>",
        "id": 222495676,
        "sender_full_name": "nagisa",
        "timestamp": 1610486168
    },
    {
        "content": "<blockquote>\n<p>Submodules updated in -7194.49 seconds</p>\n</blockquote>\n<p>heh.</p>",
        "id": 222505380,
        "sender_full_name": "nagisa",
        "timestamp": 1610490708
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232545\">@Joshua Nelson</span> it fails ooking for <code>build/i686-pc-windows-msvc/ci-llvm/lib/*.lib</code>. A bunch of <code>.lib</code>s are missing. Fails when invoking <code>llvm-config</code>.</p>",
        "id": 222505486,
        "sender_full_name": "nagisa",
        "timestamp": 1610490755
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> can you send the full error? I would be surprised if anything is missing, I uploaded a whole bunch of files</p>",
        "id": 222505529,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490788
    },
    {
        "content": "<p>uh, I don't have a mouse on this and I have no idea how to copy terminal buffer without one...</p>",
        "id": 222505555,
        "sender_full_name": "nagisa",
        "timestamp": 1610490808
    },
    {
        "content": "<p>oh hmm</p>",
        "id": 222505566,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490814
    },
    {
        "content": "<p>let me attach a wacom to it</p>",
        "id": 222505570,
        "sender_full_name": "nagisa",
        "timestamp": 1610490818
    },
    {
        "content": "<p>did you check out my PR first? (have to ask the silly questions, sorry)</p>",
        "id": 222505590,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490831
    },
    {
        "content": "<p><a href=\"https://paste.rs/TXZ\">https://paste.rs/TXZ</a></p>",
        "id": 222505697,
        "sender_full_name": "nagisa",
        "timestamp": 1610490883
    },
    {
        "content": "<p>hmm I guess another possibility is that bootstrap.py didn't invalidate its LLVM cache?</p>",
        "id": 222505704,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490884
    },
    {
        "content": "<p>what's in <code>C:\\Users\\nagisa\\Desktop\\rust\\build\\i686-pc-windows-msvc\\ci-llvm\\lib\\</code> ? That looks like <em>everything</em> is missing</p>",
        "id": 222505751,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490916
    },
    {
        "content": "<p>I can see that ahppening, let me nuke entire build</p>",
        "id": 222505759,
        "sender_full_name": "nagisa",
        "timestamp": 1610490922
    },
    {
        "content": "<p>no no you shouldn't need to</p>",
        "id": 222505772,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490932
    },
    {
        "content": "<p>that's a bootstrap bug I'd need to fix</p>",
        "id": 222505780,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490938
    },
    {
        "content": "<p>otherwise <em>everyone</em> will run into it</p>",
        "id": 222505793,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490950
    },
    {
        "content": "<p>ok I see the issue, the caching is by LLVM SHA and doesn't account for the version of bootstrap</p>",
        "id": 222505856,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490980
    },
    {
        "content": "<p>hmm, I'm not sure how to do this in a general way</p>",
        "id": 222505869,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610490989
    },
    {
        "content": "<p>sure, uh, I already did it, but I guess easily reproducible by running bootstrap on origin/master and then back on your branch</p>",
        "id": 222505873,
        "sender_full_name": "nagisa",
        "timestamp": 1610490994
    },
    {
        "content": "<p>I don't think everybody will start running into this</p>",
        "id": 222505925,
        "sender_full_name": "nagisa",
        "timestamp": 1610491033
    },
    {
        "content": "<p>because people are unlikely to have ever had set the option on windows in the first place.</p>",
        "id": 222505938,
        "sender_full_name": "nagisa",
        "timestamp": 1610491047
    },
    {
        "content": "<p>well, everybody until LLVM gets bumped</p>",
        "id": 222505952,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491054
    },
    {
        "content": "<p>so there was never a download or extraction of the llvm tar.xz</p>",
        "id": 222505955,
        "sender_full_name": "nagisa",
        "timestamp": 1610491059
    },
    {
        "content": "<p>the caching is against the <em>git</em> history, it doesn't care what's in ci-llvm/</p>",
        "id": 222505967,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491066
    },
    {
        "content": "<p>ok I'm going to hard code it for now, one sec</p>",
        "id": 222506029,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491089
    },
    {
        "content": "<p>still failed even after the nuke, gimme a sec to get you the contents of the dir</p>",
        "id": 222506121,
        "sender_full_name": "nagisa",
        "timestamp": 1610491142
    },
    {
        "content": "<p>try this:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/src/bootstrap/bootstrap.py b/src/bootstrap/bootstrap.py</span>\n<span class=\"gh\">index f60ae02bffe..e0d1768664e 100644</span>\n<span class=\"gd\">--- a/src/bootstrap/bootstrap.py</span>\n<span class=\"gi\">+++ b/src/bootstrap/bootstrap.py</span>\n<span class=\"gu\">@@ -443,13 +443,7 @@ class RustBuild(object):</span>\n             top_level = subprocess.check_output([\n                 \"git\", \"rev-parse\", \"--show-toplevel\",\n             ]).decode(sys.getdefaultencoding()).strip()\n<span class=\"gd\">-            llvm_sha = subprocess.check_output([</span>\n<span class=\"gd\">-                \"git\", \"log\", \"--author=bors\", \"--format=%H\", \"-n1\",</span>\n<span class=\"gd\">-                \"-m\", \"--first-parent\",</span>\n<span class=\"gd\">-                \"--\",</span>\n<span class=\"gd\">-                \"{}/src/llvm-project\".format(top_level),</span>\n<span class=\"gd\">-                \"{}/src/bootstrap/download-ci-llvm-stamp\".format(top_level),</span>\n<span class=\"gd\">-            ]).decode(sys.getdefaultencoding()).strip()</span>\n<span class=\"gi\">+            llvm_sha = \"3732cb605c03d534702b237eb667d313f6fd015c\"</span>\n             llvm_assertions = self.get_toml('assertions', 'llvm') == 'true'\n             if self.program_out_of_date(self.llvm_stamp(), llvm_sha + str(llvm_assertions)):\n                 self._download_ci_llvm(llvm_sha, llvm_assertions)\n</code></pre></div>",
        "id": 222506123,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491144
    },
    {
        "content": "<p>(if that's hard to copy paste you can get the SHA from <a href=\"https://github.com/rust-lang/rust/pull/80932/commits\">https://github.com/rust-lang/rust/pull/80932/commits</a>)</p>",
        "id": 222506148,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491159
    },
    {
        "content": "<p>it only has bin/ and include/</p>",
        "id": 222506162,
        "sender_full_name": "nagisa",
        "timestamp": 1610491167
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506162\">said</a>:</p>\n<blockquote>\n<p>it only has bin/ and include/</p>\n</blockquote>\n<p>yup, that's definitely a caching issue then</p>",
        "id": 222506187,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491182
    },
    {
        "content": "<p>oh waaaait</p>",
        "id": 222506277,
        "sender_full_name": "nagisa",
        "timestamp": 1610491206
    },
    {
        "content": "<p>you know wha</p>",
        "id": 222506281,
        "sender_full_name": "nagisa",
        "timestamp": 1610491208
    },
    {
        "content": "<p>I might have done the same thing previously and hardcoded llvm_sha to something else</p>",
        "id": 222506311,
        "sender_full_name": "nagisa",
        "timestamp": 1610491235
    },
    {
        "content": "<p>ah but no, its old code there, let me try the hash thing</p>",
        "id": 222506321,
        "sender_full_name": "nagisa",
        "timestamp": 1610491244
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222505869\">said</a>:</p>\n<blockquote>\n<p>hmm, I'm not sure how to do this in a general way</p>\n</blockquote>\n<p>the hack of course is to do the git version of <code>llvm_sha = newest(3732cb605c03d534702b237eb667d313f6fd015c, llvm_sha)</code> but I don't think <span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> would like that <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 222506594,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491391
    },
    {
        "content": "<p>hm?</p>",
        "id": 222506623,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491423
    },
    {
        "content": "<p>there should be a stamp file you can touch</p>",
        "id": 222506633,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491431
    },
    {
        "content": "<p>is the hash right? its saying 404.</p>",
        "id": 222506634,
        "sender_full_name": "nagisa",
        "timestamp": 1610491432
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> <code>llvm_sha</code> is calculated <em>only</em> based on the LLVM version</p>",
        "id": 222506670,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491443
    },
    {
        "content": "<p>the stamp file won't help, it will still download the wrong version</p>",
        "id": 222506696,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491450
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506670\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <code>llvm_sha</code> is calculated <em>only</em> based on the LLVM version</p>\n</blockquote>\n<p>I want it to include my changes to bootstrap, which only changed the tarball, not <code>src/llvm-project</code></p>",
        "id": 222506735,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491471
    },
    {
        "content": "<p>I don't know what you mean by llvm version I guess</p>",
        "id": 222506742,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491473
    },
    {
        "content": "<blockquote>\n<ul>\n<li>\"{}/src/bootstrap/download-ci-llvm-stamp\".format(top_level),</li>\n</ul>\n</blockquote>",
        "id": 222506759,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491486
    },
    {
        "content": "<p>this is the stamp</p>",
        "id": 222506770,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491498
    },
    {
        "content": "<p>fwiw, llvm will soon update to 11.0.1, so this may be a transient issue, right?</p>",
        "id": 222506780,
        "sender_full_name": "cuviper",
        "timestamp": 1610491504
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"138448\">cuviper</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506780\">said</a>:</p>\n<blockquote>\n<p>fwiw, llvm will soon update to 11.0.1, so this may be a transient issue, right?</p>\n</blockquote>\n<p>yeah I suppose so</p>",
        "id": 222506812,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491524
    },
    {
        "content": "<p>any LLVM update would fix the issue as long as the PR gets merged first</p>",
        "id": 222506824,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491533
    },
    {
        "content": "<p>this should not be a problem</p>",
        "id": 222506826,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491534
    },
    {
        "content": "<p>/me tries x86_64-pc-windows-msvc to see if that will have the llvm's tar.xz</p>",
        "id": 222506853,
        "sender_full_name": "nagisa",
        "timestamp": 1610491551
    },
    {
        "content": "<p>do you mean that the directory is not purged and replaced on a bump of the stamp file?</p>",
        "id": 222506864,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491561
    },
    {
        "content": "<p>if so, then we should include the stamp file's contents in the cache name</p>",
        "id": 222506922,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491574
    },
    {
        "content": "<p>(or whatever)</p>",
        "id": 222506929,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491577
    },
    {
        "content": "<p>no, I mean that's it's purged and replaced with the wrong tarball</p>",
        "id": 222506932,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491578
    },
    {
        "content": "<p>I continue to be a bit baffled, I admit</p>",
        "id": 222506956,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491593
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/commit/3732cb605c03d534702b237eb667d313f6fd015c\">3732cb605c03d534702b237eb667d313f6fd015c</a> will not have associated tarball</p>",
        "id": 222506996,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491612
    },
    {
        "content": "<p>so the tarball that gets downloaded is based on when LLVM last changed.</p>",
        "id": 222507001,
        "sender_full_name": "nagisa",
        "timestamp": 1610491615
    },
    {
        "content": "<p>folks testing need to check out the try commit, and the pr should likely bump the stamp file (which would then make that try commit the one bootstrap uses to download from)</p>",
        "id": 222507033,
        "sender_full_name": "simulacrum",
        "timestamp": 1610491640
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506634\">said</a>:</p>\n<blockquote>\n<p>is the hash right? its saying 404.</p>\n</blockquote>\n<p>oh, it's probably the hash of the <code>bors try</code>, not the commit I made - try using <code>f092cb6bc7133a66e68327189cb1cb39af7cc38e</code> instead</p>",
        "id": 222507058,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491662
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222507033\">said</a>:</p>\n<blockquote>\n<p>folks testing need to check out the try commit, and the pr should likely bump the stamp file (which would then make that try commit the one bootstrap uses to download from)</p>\n</blockquote>\n<p>this is not related to the stamp file. The bug happens <em>before</em> <code>self.program_out_of_date</code>. <code>git log src/llvm-project</code> shows <a href=\"https://github.com/rust-lang/rust/commit/26daa656624deb54a8f3c754893635ebe46eed10\">26daa656624deb54a8f3c754893635ebe46eed10</a> as the most recent commit way back in december. <em>regardless</em> of whether the stamp file is outdated or not, bootstrap will download the december tarball and put it in <code>ci-llvm</code>.</p>",
        "id": 222507203,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491759
    },
    {
        "content": "<p>but that tarball has a different contents than the tarball from my PR - it's missing all the static libraries</p>",
        "id": 222507242,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491791
    },
    {
        "content": "<p>right so what I did was...</p>",
        "id": 222507310,
        "sender_full_name": "nagisa",
        "timestamp": 1610491816
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>git fetch origin f092cb6bc7133a66e68327189cb1cb39af7cc38e\ngit checkout FETCH_HEAD -f\nrmdir ./build\npython x.py build\n</code></pre></div>\n<p>the error was <a href=\"https://paste.rs/oWL\">https://paste.rs/oWL</a>. Note that it still downloaded an old llvm tarball. Hardcoding the hash in bootstrap.py now.</p>",
        "id": 222507459,
        "sender_full_name": "nagisa",
        "timestamp": 1610491902
    },
    {
        "content": "<p>right, this is what I mean - the SHA bootstrap uses for LLVM is independent of the current commit you're on, it only cares about the commit <code>src/llvm-project</code> is on</p>",
        "id": 222507605,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610491965
    },
    {
        "content": "<p><em>or when the stamp file was bumped</em></p>",
        "id": 222507883,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492128
    },
    {
        "content": "<p>no ugh</p>",
        "id": 222507903,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492146
    },
    {
        "content": "<p>there should be no worry here, if you had bumped the stamp file, then checking out the try commit would just work</p>",
        "id": 222507905,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492148
    },
    {
        "content": "<p>look, this is the code:</p>\n<div class=\"codehilite\" data-code-language=\"Python\"><pre><span></span><code>            <span class=\"n\">llvm_sha</span> <span class=\"o\">=</span> <span class=\"n\">subprocess</span><span class=\"o\">.</span><span class=\"n\">check_output</span><span class=\"p\">([</span>\n                <span class=\"s2\">\"git\"</span><span class=\"p\">,</span> <span class=\"s2\">\"log\"</span><span class=\"p\">,</span> <span class=\"s2\">\"--author=bors\"</span><span class=\"p\">,</span> <span class=\"s2\">\"--format=%H\"</span><span class=\"p\">,</span> <span class=\"s2\">\"-n1\"</span><span class=\"p\">,</span>\n                <span class=\"s2\">\"-m\"</span><span class=\"p\">,</span> <span class=\"s2\">\"--first-parent\"</span><span class=\"p\">,</span>\n                <span class=\"s2\">\"--\"</span><span class=\"p\">,</span>\n                <span class=\"s2\">\"</span><span class=\"si\">{}</span><span class=\"s2\">/src/llvm-project\"</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">top_level</span><span class=\"p\">),</span>\n                <span class=\"s2\">\"</span><span class=\"si\">{}</span><span class=\"s2\">/src/bootstrap/download-ci-llvm-stamp\"</span><span class=\"o\">.</span><span class=\"n\">format</span><span class=\"p\">(</span><span class=\"n\">top_level</span><span class=\"p\">),</span>\n            <span class=\"p\">])</span><span class=\"o\">.</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"n\">sys</span><span class=\"o\">.</span><span class=\"n\">getdefaultencoding</span><span class=\"p\">())</span><span class=\"o\">.</span><span class=\"n\">strip</span><span class=\"p\">()</span>\n            <span class=\"n\">llvm_assertions</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">get_toml</span><span class=\"p\">(</span><span class=\"s1\">'assertions'</span><span class=\"p\">,</span> <span class=\"s1\">'llvm'</span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"s1\">'true'</span>\n            <span class=\"k\">if</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">program_out_of_date</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">llvm_stamp</span><span class=\"p\">(),</span> <span class=\"n\">llvm_sha</span> <span class=\"o\">+</span> <span class=\"nb\">str</span><span class=\"p\">(</span><span class=\"n\">llvm_assertions</span><span class=\"p\">)):</span>\n                <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_download_ci_llvm</span><span class=\"p\">(</span><span class=\"n\">llvm_sha</span><span class=\"p\">,</span> <span class=\"n\">llvm_assertions</span><span class=\"p\">)</span>\n</code></pre></div>",
        "id": 222507923,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492161
    },
    {
        "content": "<p>but you need to check out the try comit</p>",
        "id": 222507964,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492170
    },
    {
        "content": "<p>if the stamp file gets bumped, <code>_download_ci_llvm</code> <em>will</em> get called</p>",
        "id": 222507986,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492181
    },
    {
        "content": "<p>that lists src/llvm-project and the download-ci-llvm-stamp?</p>",
        "id": 222507991,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492183
    },
    {
        "content": "<p>but it will get called with the wrong llvm_sha</p>",
        "id": 222508002,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492188
    },
    {
        "content": "<p>why?</p>",
        "id": 222508013,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492198
    },
    {
        "content": "<p>I can bump the stamp locally and try it ^^</p>",
        "id": 222508015,
        "sender_full_name": "nagisa",
        "timestamp": 1610492199
    },
    {
        "content": "<p>you have to bump it and then have a bors-authored merge commit after it which has artifacts</p>",
        "id": 222508054,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492218
    },
    {
        "content": "<p>like, there's not a way to do this without a try build</p>",
        "id": 222508078,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492227
    },
    {
        "content": "<p>git commit --amend?</p>",
        "id": 222508079,
        "sender_full_name": "nagisa",
        "timestamp": 1610492229
    },
    {
        "content": "<p>oh I'm dumb I'm sorry - there are <em>two</em> different stamp files</p>",
        "id": 222508082,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492231
    },
    {
        "content": "<p>no, that would change the sha</p>",
        "id": 222508088,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492234
    },
    {
        "content": "<p>oh but that changes hash</p>",
        "id": 222508089,
        "sender_full_name": "nagisa",
        "timestamp": 1610492236
    },
    {
        "content": "<p>yeah</p>",
        "id": 222508090,
        "sender_full_name": "nagisa",
        "timestamp": 1610492237
    },
    {
        "content": "<p>you were talking about <code>download-ci-llvm-stamp</code>, I was talking about <code>llvm_stamp()</code></p>",
        "id": 222508101,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492246
    },
    {
        "content": "<p>ah</p>",
        "id": 222508111,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492250
    },
    {
        "content": "<p>yes</p>",
        "id": 222508113,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492253
    },
    {
        "content": "<p>side note</p>",
        "id": 222508139,
        "sender_full_name": "nagisa",
        "timestamp": 1610492268
    },
    {
        "content": "<p>ok, I'll bump that as part of the PR. <span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> will still have to hard-code the hash until I get another try run to finish</p>",
        "id": 222508155,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492281
    },
    {
        "content": "<p>does anyone know if you can prevent tidy from running/building for x.py test?</p>",
        "id": 222508194,
        "sender_full_name": "nagisa",
        "timestamp": 1610492285
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222508194\">said</a>:</p>\n<blockquote>\n<p>does anyone know if you can prevent tidy from running/building for x.py test?</p>\n</blockquote>\n<p><code>x.py test src/test/ui</code></p>",
        "id": 222508206,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492295
    },
    {
        "content": "<p>or any other subset of tests</p>",
        "id": 222508209,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492299
    },
    {
        "content": "<p>cool.</p>",
        "id": 222508216,
        "sender_full_name": "nagisa",
        "timestamp": 1610492303
    },
    {
        "content": "<p>or --exclude src/tools/tidy</p>",
        "id": 222508287,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492349
    },
    {
        "content": "<p>oh that's better <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 222508316,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492368
    },
    {
        "content": "<p>s0 it went past the original error, still waiting for it to build the backend to make absolutely sure things work</p>",
        "id": 222508449,
        "sender_full_name": "nagisa",
        "timestamp": 1610492436
    },
    {
        "content": "<p>yay <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 222508505,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492472
    },
    {
        "content": "<p>yeah the next place I would expect to break is <code>compiler/rustc_llvm</code></p>",
        "id": 222508613,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492526
    },
    {
        "content": "<p>if that works we might actually be ready to go :)</p>",
        "id": 222508628,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492541
    },
    {
        "content": "<p>building ... rustc_llvm (build) :suspense:</p>",
        "id": 222508672,
        "sender_full_name": "nagisa",
        "timestamp": 1610492577
    },
    {
        "content": "<p>looks like it went through.</p>",
        "id": 222508723,
        "sender_full_name": "nagisa",
        "timestamp": 1610492614
    },
    {
        "content": "<p>I'm not celebrating till we get std built :)</p>",
        "id": 222508825,
        "sender_full_name": "simulacrum",
        "timestamp": 1610492668
    },
    {
        "content": "<p>I'm already wondering if it will work on MacOS <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 222508892,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492726
    },
    {
        "content": "<p>I would expect it to, none of my changes were specific to windows</p>",
        "id": 222508905,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492737
    },
    {
        "content": "<p>hey <span class=\"user-mention\" data-user-id=\"307289\">@Poliorcetics</span> ;)</p>",
        "id": 222508987,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610492780
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> did you get stage1 std built?</p>",
        "id": 222510087,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610493508
    },
    {
        "content": "<p>(if that works I would expect tests to pass)</p>",
        "id": 222510111,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610493525
    },
    {
        "content": "<p>still waiting. I only have 6 cores on that VM and rustc_middle is making things difficult ^^</p>",
        "id": 222510138,
        "sender_full_name": "nagisa",
        "timestamp": 1610493545
    },
    {
        "content": "<p>well, if you want a problem to ponder, it baffles me why I needed to take out <code>LLVM_INCLUDE_TESTS=OFF</code> from the cmake config: <a href=\"https://github.com/rust-lang/rust/pull/80932/files#diff-ca6526d91d41c31fad645c46417e0f1ce61e324542994e8c8b72b1f7a08c91bdL174\">https://github.com/rust-lang/rust/pull/80932/files#diff-ca6526d91d41c31fad645c46417e0f1ce61e324542994e8c8b72b1f7a08c91bdL174</a></p>",
        "id": 222510495,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610493774
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222508892\">said</a>:</p>\n<blockquote>\n<p>I'm already wondering if it will work on MacOS <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>\n</blockquote>\n<p>I am happy to test on macOS (and Windows as well) if it would help <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 222510509,
        "sender_full_name": "J. Ryan Stinnett",
        "timestamp": 1610493787
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"220326\">J. Ryan Stinnett</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510509\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222508892\">said</a>:</p>\n<blockquote>\n<p>I'm already wondering if it will work on MacOS <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>\n</blockquote>\n<p>I am happy to test on macOS (and Windows as well) if it would help <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>\n</blockquote>\n<p>that would be great! you can test with <code>git fetch origin pull/80932/head &amp;&amp; git checkout FETCH_HEAD</code>, then edit bootstrap.py like in <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506123\">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506123</a>, but with the hash <code>f092cb6bc7133a66e68327189cb1cb39af7cc38e</code>. Then add <code>[llvm] download-ci-llvm = true</code> to config.toml and see if x.py build works.</p>",
        "id": 222510634,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610493875
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510495\">said</a>:</p>\n<blockquote>\n<p>well, if you want a problem to ponder, it baffles me why I needed to take out <code>LLVM_INCLUDE_TESTS=OFF</code> from the cmake config: <a href=\"https://github.com/rust-lang/rust/pull/80932/files#diff-ca6526d91d41c31fad645c46417e0f1ce61e324542994e8c8b72b1f7a08c91bdL174\">https://github.com/rust-lang/rust/pull/80932/files#diff-ca6526d91d41c31fad645c46417e0f1ce61e324542994e8c8b72b1f7a08c91bdL174</a></p>\n</blockquote>\n<p>here's the error without:</p>\n<div class=\"codehilite\"><pre><span></span><code>llvm-config: error: component libraries and shared library\n\nllvm-config: error: missing: /home/joshua/rustc2/build/x86_64-unknown-linux-gnu/llvm/build/lib/libgtest.a\nllvm-config: error: missing: /home/joshua/rustc2/build/x86_64-unknown-linux-gnu/llvm/build/lib/libgtest_main.a\nllvm-config: error: missing: /home/joshua/rustc2/build/x86_64-unknown-linux-gnu/llvm/build/lib/libLLVMTestingSupport.a\nthread &#39;main&#39; panicked at &#39;command did not execute successfully: &quot;/home/joshua/rustc2/build/x86_64-unknown-linux-gnu/llvm/build/bin/llvm-config&quot; &quot;--libfiles&quot;\n</code></pre></div>",
        "id": 222510727,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610493956
    },
    {
        "content": "<p>a bunch of link errors when linking librustc_driver, in the form of llvm stuff depending on __imp___std_init_once_complete and not finding it</p>",
        "id": 222510730,
        "sender_full_name": "nagisa",
        "timestamp": 1610493960
    },
    {
        "content": "<p>but that's the only symbol that's missing.</p>",
        "id": 222510774,
        "sender_full_name": "nagisa",
        "timestamp": 1610493966
    },
    {
        "content": "<p>do you know what <code>__imp___std_init_once_complete</code> is?</p>",
        "id": 222510789,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610493985
    },
    {
        "content": "<p>seems weird it would only break when downloading and re-uploading, it worked fine for me locally</p>",
        "id": 222510855,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494038
    },
    {
        "content": "<p>no idea what it is, sadly.</p>",
        "id": 222510871,
        "sender_full_name": "nagisa",
        "timestamp": 1610494049
    },
    {
        "content": "<p>and I don't know about intiricacies of linking on windows to investigate T_T</p>",
        "id": 222510885,
        "sender_full_name": "nagisa",
        "timestamp": 1610494064
    },
    {
        "content": "<p>hmm, I think this is the first time <code>rg</code> has failed me</p>",
        "id": 222510966,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494111
    },
    {
        "content": "<p>I do know for sure I could build llvm this weekend and have it work tho</p>",
        "id": 222510967,
        "sender_full_name": "nagisa",
        "timestamp": 1610494112
    },
    {
        "content": "<p>oh, I mean it is internal implementation function of msvc's standard library</p>",
        "id": 222510985,
        "sender_full_name": "nagisa",
        "timestamp": 1610494133
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510967\">said</a>:</p>\n<blockquote>\n<p>I do know for sure I could build llvm this weekend and have it work tho</p>\n</blockquote>\n<p>what do you mean? like build from source?</p>",
        "id": 222510986,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494134
    },
    {
        "content": "<p>not in rust.</p>",
        "id": 222510992,
        "sender_full_name": "nagisa",
        "timestamp": 1610494136
    },
    {
        "content": "<p>ahhh ok</p>",
        "id": 222511009,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494147
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510986\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510967\">said</a>:</p>\n<blockquote>\n<p>I do know for sure I could build llvm this weekend and have it work tho</p>\n</blockquote>\n<p>what do you mean? like build from source?</p>\n</blockquote>\n<p>yaeh, I built LLVM from source this weekend.</p>",
        "id": 222511016,
        "sender_full_name": "nagisa",
        "timestamp": 1610494151
    },
    {
        "content": "<p>So what I suspect could be happening is llvm-config not printing all the link arguments for some reason.</p>",
        "id": 222511059,
        "sender_full_name": "nagisa",
        "timestamp": 1610494187
    },
    {
        "content": "<p>ok, so this probably is actually the test thing going wrong, that's the only thing I changed in LLVM directly</p>",
        "id": 222511104,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494202
    },
    {
        "content": "<p>if you have another hour you could try commenting that out and see if it works <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span></p>",
        "id": 222511132,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494222
    },
    {
        "content": "<p>sadly I'm hitting bed in hour and I wont be able to wait for rustc build after that</p>",
        "id": 222511178,
        "sender_full_name": "nagisa",
        "timestamp": 1610494257
    },
    {
        "content": "<p>tomorrow maybe, even better if there's a try build to try ^^</p>",
        "id": 222511194,
        "sender_full_name": "nagisa",
        "timestamp": 1610494273
    },
    {
        "content": "<p>Ah, I guess I am hitting the python 2 vs. 3 fun on macOS?</p>\n<div class=\"codehilite\"><pre><span></span><code>error: XZ support is required to download LLVM\nhelp: consider disabling `download-ci-llvm` or using python3\n</code></pre></div>",
        "id": 222511206,
        "sender_full_name": "J. Ryan Stinnett",
        "timestamp": 1610494283
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"220326\">@J. Ryan Stinnett</span> yeah, use <code>python3</code> instead</p>",
        "id": 222511220,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494293
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>downloading https://ci-artifacts.rust-lang.org/rustc-builds/f092cb6bc7133a66e68327189cb1cb39af7cc38e/rust-dev-nightly-x86_64-apple-darwin.tar.xz\n#=#=-#   #\ncurl: (22) The requested URL returned error: 404\n</code></pre></div>",
        "id": 222511295,
        "sender_full_name": "J. Ryan Stinnett",
        "timestamp": 1610494339
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"220326\">J. Ryan Stinnett</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222511295\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\"><pre><span></span><code>downloading https://ci-artifacts.rust-lang.org/rustc-builds/f092cb6bc7133a66e68327189cb1cb39af7cc38e/rust-dev-nightly-x86_64-apple-darwin.tar.xz\n#=#=-#   #\ncurl: (22) The requested URL returned error: 404\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>oh right, the try build was only for windows</p>",
        "id": 222511307,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494354
    },
    {
        "content": "<p>booo</p>",
        "id": 222511309,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494356
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222511194\">said</a>:</p>\n<blockquote>\n<p>tomorrow maybe, even better if there's a try build to try ^^</p>\n</blockquote>\n<p>well the issue is that if I disable the tests again then llvm-config dies :(</p>",
        "id": 222511367,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494395
    },
    {
        "content": "<p>for reasons unknown</p>",
        "id": 222511379,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494401
    },
    {
        "content": "<p>so I guess the thing to do in the meantime is see if this works on mac, let me start a try run</p>",
        "id": 222511810,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494705
    },
    {
        "content": "<p>If you want to write down instructions somewhere in the issue I'm happy to spend some time tomorrow pointing my eyeballs to them</p>",
        "id": 222511843,
        "sender_full_name": "nagisa",
        "timestamp": 1610494727
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510634\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"220326\">J. Ryan Stinnett</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510509\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222508892\">said</a>:</p>\n<blockquote>\n<p>I'm already wondering if it will work on MacOS <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>\n</blockquote>\n<p>I am happy to test on macOS (and Windows as well) if it would help <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>\n</blockquote>\n<p>that would be great! you can test with <code>git fetch origin pull/80932/head &amp;&amp; git checkout FETCH_HEAD</code>, then edit bootstrap.py like in <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506123\">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506123</a>, but with the hash <code>f092cb6bc7133a66e68327189cb1cb39af7cc38e</code>. Then add <code>[llvm] download-ci-llvm = true</code> to config.toml and see if x.py build works.</p>\n</blockquote>\n<p>I've initiated these steps on a Windows machine.  I'll report back when complete.</p>",
        "id": 222511861,
        "sender_full_name": "Halkcyon",
        "timestamp": 1610494747
    },
    {
        "content": "<p>well I'm unsure how to move forward <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> the windows link error is super weird</p>",
        "id": 222511870,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494758
    },
    {
        "content": "<p>tbh I really want this to work because waiting for LLVM rebuild was _painful_.</p>",
        "id": 222511884,
        "sender_full_name": "nagisa",
        "timestamp": 1610494774
    },
    {
        "content": "<p>I should probably mark this directory as safe...<br>\n<a href=\"/user_uploads/4715/zmwNYMg36SZUEWE4BkKSkHqX/image.png\">!image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/zmwNYMg36SZUEWE4BkKSkHqX/image.png\" title=\"!image.png\"><img src=\"/user_uploads/4715/zmwNYMg36SZUEWE4BkKSkHqX/image.png\"></a></div>",
        "id": 222512007,
        "sender_full_name": "Halkcyon",
        "timestamp": 1610494859
    },
    {
        "content": "<p>oh yeah Antimalware Service Executable is the worst.</p>",
        "id": 222512056,
        "sender_full_name": "nagisa",
        "timestamp": 1610494905
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222511810\">said</a>:</p>\n<blockquote>\n<p>so I guess the thing to do in the meantime is see if this works on mac, let me start a try run</p>\n</blockquote>\n<p>done, will be another 45 minutes unfortunately</p>",
        "id": 222512123,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610494948
    },
    {
        "content": "<p>I cannot test right now on macOS but after sleep Ill be able too, what should I do ?</p>",
        "id": 222512127,
        "sender_full_name": "Poliorcetics",
        "timestamp": 1610494952
    },
    {
        "content": "<p>hard-coding hashes shouldn't be necessary now that I updated the stamp file, so:</p>\n<ul>\n<li><code>git fetch origin pull/80932/head &amp;&amp; git checkout FETCH_HEAD</code></li>\n<li>add <code>[llvm] download-ci-llvm = true</code> to config.toml</li>\n<li>see if <code>x.py build</code> works</li>\n</ul>",
        "id": 222512186,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495031
    },
    {
        "content": "<p>err actually I think the hash will still be wrong because I modified it in a separate commit and that one didn't have a try run?</p>",
        "id": 222512238,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495064
    },
    {
        "content": "<p>so use <a href=\"https://github.com/rust-lang/rust/commit/ef893ae3c016152f7efd5f5fbc14ce527d7146f3\">ef893ae3c016152f7efd5f5fbc14ce527d7146f3</a> as the hash instead (once it finishes building in half an hour)</p>",
        "id": 222512258,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495079
    },
    {
        "content": "<p>Starred the message, Ill come back to it tomorrow <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 222512296,
        "sender_full_name": "Poliorcetics",
        "timestamp": 1610495122
    },
    {
        "content": "<p>lol <code>\"__imp___std_init_once_complete\"</code> only has 3 hits on all of google<br>\n<a href=\"/user_uploads/4715/JD-vQ6FTHYke4Rpg99FWewnM/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/JD-vQ6FTHYke4Rpg99FWewnM/image.png\" title=\"image.png\"><img src=\"/user_uploads/4715/JD-vQ6FTHYke4Rpg99FWewnM/image.png\"></a></div>",
        "id": 222512536,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495307
    },
    {
        "content": "<p>try GH?</p>",
        "id": 222512578,
        "sender_full_name": "oliver",
        "timestamp": 1610495353
    },
    {
        "content": "<p>only hits are in the windows c++ template library <a href=\"https://github.com/microsoft/STL/search?q=__imp___std_init_once_complete\">https://github.com/microsoft/STL/search?q=__imp___std_init_once_complete</a></p>",
        "id": 222512595,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495380
    },
    {
        "content": "<p><a href=\"https://github.com/rust-skia/rust-skia/issues/431\">https://github.com/rust-skia/rust-skia/issues/431</a></p>\n<blockquote>\n<p>Thanks, updating VS build tools fixed it!</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span> maybe try that?</p>",
        "id": 222512670,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495426
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510495\">said</a>:</p>\n<blockquote>\n<p>well, if you want a problem to ponder, it baffles me why I needed to take out <code>LLVM_INCLUDE_TESTS=OFF</code> from the cmake config: <a href=\"https://github.com/rust-lang/rust/pull/80932/files#diff-ca6526d91d41c31fad645c46417e0f1ce61e324542994e8c8b72b1f7a08c91bdL174\">https://github.com/rust-lang/rust/pull/80932/files#diff-ca6526d91d41c31fad645c46417e0f1ce61e324542994e8c8b72b1f7a08c91bdL174</a></p>\n</blockquote>\n<p>usually passing these flags to cmake during build would cause an llvm build to fail</p>",
        "id": 222512713,
        "sender_full_name": "oliver",
        "timestamp": 1610495477
    },
    {
        "content": "<p>I am unsure why you say that. <code>LLVM_INCLUDE_TESTS=OFF</code> is hard-coded on in compiler/rustc_llvm and has been working fine since it was added several years ago.</p>",
        "id": 222512741,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495512
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>~/Library/llvm-project/build on  main via  v3.13.4\n cmake -DLLVM_INCLUDE_TESTS<span class=\"o\">=</span>OFF --build .\n-- Could NOT find LibXml2 <span class=\"o\">(</span>missing: LIBXML2_LIBRARY LIBXML2_INCLUDE_DIR<span class=\"o\">)</span>\n</code></pre></div>\n<p>^ this is not how it works</p>",
        "id": 222512836,
        "sender_full_name": "oliver",
        "timestamp": 1610495574
    },
    {
        "content": "<p>that just looks like you don't have libxml installed</p>",
        "id": 222512852,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495593
    },
    {
        "content": "<p>which is not related to this issue</p>",
        "id": 222512857,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495599
    },
    {
        "content": "<p>no it works like this</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code> cmake --build .\n<span class=\"o\">[</span><span class=\"m\">10</span>/2972<span class=\"o\">]</span> Building CXX object lib/Support/CMakeFiles/LLVMSupport.dir/Allocator.cpp.o\n</code></pre></div>",
        "id": 222512898,
        "sender_full_name": "oliver",
        "timestamp": 1610495641
    },
    {
        "content": "<p>I can try re updating VS build tools</p>",
        "id": 222513026,
        "sender_full_name": "nagisa",
        "timestamp": 1610495706
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281739\">@oliver</span> I don't know why it doesn't work for you locally, but INCLUDE_TESTS=OFF has been present since bootstrap was written in 2015: <a href=\"https://github.com/rust-lang/rust/commit/046e6874c47ec55e23b7a566bca51d2920562485\">046e6874c47ec55e23b7a566bca51d2920562485</a>. The errors you're getting don't look at all related to the errors llvm-config gave.</p>",
        "id": 222513152,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610495796
    },
    {
        "content": "<p>I'm on a completely different system and am building llvm from source</p>",
        "id": 222513321,
        "sender_full_name": "oliver",
        "timestamp": 1610495902
    },
    {
        "content": "<p>but I still run into problems passing these flags to cmake during build</p>",
        "id": 222513355,
        "sender_full_name": "oliver",
        "timestamp": 1610495934
    },
    {
        "content": "<p>and I have <code>libxml2</code> fwiw</p>",
        "id": 222513373,
        "sender_full_name": "oliver",
        "timestamp": 1610495956
    },
    {
        "content": "<p>steps taken:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$ git clone git@github.com:rust-lang/rust.git <span class=\"o\">&amp;&amp;</span> <span class=\"nb\">cd</span> rust\n$ git fetch origin pull/80932/head <span class=\"o\">&amp;&amp;</span> git checkout FETCH_HEAD\n<span class=\"c1\"># modify `src/bootstrap/bootstrap.py` line 446 to `llvm_sha='f092cb6bc7133a66e68327189cb1cb39af7cc38e'`</span>\n$ cp config.toml.example config.toml\n<span class=\"c1\"># modify `config.toml` line 46 to `download-ci-llvm = true`</span>\n$ py.exe -3.8 x.py build\n</code></pre></div>\n<p>results:</p>\n<div class=\"codehilite\"><pre><span></span><code>   Compiling rustdoc-tool v0.0.0 (R:\\rust\\src\\tools\\rustdoc)\n    Finished release [optimized] target(s) in 1m 49s\nBuild completed successfully in 0:23:44\n</code></pre></div>",
        "id": 222513741,
        "sender_full_name": "Halkcyon",
        "timestamp": 1610496154
    },
    {
        "content": "<p>Oh no way</p>",
        "id": 222514289,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610496571
    },
    {
        "content": "<p>And it said \"downloading llvm\" at the very start? You have a build/$TARGET/ci-llvm folder but no llvm/ folder?</p>",
        "id": 222514309,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610496600
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/bFUGNA0R40PFe6kM_z40r4es/build.log\">build.log</a> </p>\n<p>Console output from <code>x.py build</code> ^</p>\n<p>I don't see a <code>\"downloading llvm\"</code>, but I do see this:</p>\n<div class=\"codehilite\"><pre><span></span><code>extracting R:\\rust\\build\\cache\\llvm-f092cb6bc7133a66e68327189cb1cb39af7cc38e-False\\rust-dev-nightly-x86_64-pc-windows-msvc.tar.xz\n</code></pre></div>",
        "id": 222514488,
        "sender_full_name": "Halkcyon",
        "timestamp": 1610496719
    },
    {
        "content": "<p>Yes, that looks right</p>",
        "id": 222514588,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610496800
    },
    {
        "content": "<p>Oh man this is incredible <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 222514594,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610496809
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 222514598,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610496817
    },
    {
        "content": "<p>Also correct, I do not have a <code>llvm/</code> folder, just the <code>build/${TARGET}/ci-llvm/</code></p>\n<p><a href=\"user_uploads/4715/F1daDS4DdktXHcEZPAapquDu/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"user_uploads/4715/F1daDS4DdktXHcEZPAapquDu/image.png\" title=\"image.png\"><img src=\"user_uploads/4715/F1daDS4DdktXHcEZPAapquDu/image.png\"></a></div>",
        "id": 222514607,
        "sender_full_name": "Halkcyon",
        "timestamp": 1610496834
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232545\">@Joshua Nelson</span> Ok I guess I can see why the symbol problem could arise</p>",
        "id": 222514973,
        "sender_full_name": "nagisa",
        "timestamp": 1610497165
    },
    {
        "content": "<p>if LLVM on CI was built with a newer VC libraries, then linking to them with older VC build tools is prone to fail as we've seen</p>",
        "id": 222515048,
        "sender_full_name": "nagisa",
        "timestamp": 1610497210
    },
    {
        "content": "<p>Because the newer libraries could've gained new dependencies as a result of fixes, etc.</p>",
        "id": 222515080,
        "sender_full_name": "nagisa",
        "timestamp": 1610497245
    },
    {
        "content": "<p>That makes sense. I'm fine with just asking people to upgrade</p>",
        "id": 222515295,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610497424
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/bYrN5e50m2BMNdt6CbYXHqi5/image.png\">image.png</a> <br>\n<a href=\"/user_uploads/4715/qBW9Ic-vVDvq2CfIuVc8HaZ7/image.png\">image.png</a> </p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/bYrN5e50m2BMNdt6CbYXHqi5/image.png\" title=\"image.png\"><img src=\"/user_uploads/4715/bYrN5e50m2BMNdt6CbYXHqi5/image.png\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/4715/qBW9Ic-vVDvq2CfIuVc8HaZ7/image.png\" title=\"image.png\"><img src=\"/user_uploads/4715/qBW9Ic-vVDvq2CfIuVc8HaZ7/image.png\"></a></div><p>some environment details ^</p>",
        "id": 222515399,
        "sender_full_name": "Halkcyon",
        "timestamp": 1610497500
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"379356\">@Halkcyon</span> actually only the msvc version matters haha</p>",
        "id": 222515664,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610497686
    },
    {
        "content": "<p>Ok cool, so we can say vs 2019 14.28 and later are supported</p>",
        "id": 222515686,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610497713
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222515664\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"379356\">Halkcyon</span> actually only the msvc version matters haha</p>\n</blockquote>\n<p>just being thorough <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 222515692,
        "sender_full_name": "Halkcyon",
        "timestamp": 1610497722
    },
    {
        "content": "<p>(the Mac try run is <em>almost</em> done, needs maybe another 10 minutes)</p>",
        "id": 222519324,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610500473
    },
    {
        "content": "<p>anddd it failed :( no mac builds for now</p>",
        "id": 222520283,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610501163
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232545\">@Joshua Nelson</span> <a href=\"/user_uploads/4715/KowQNR0pUHKrTTfQdeg8EQnN/help-me-i-am-dying.png\">help-me-i-am-dying.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/KowQNR0pUHKrTTfQdeg8EQnN/help-me-i-am-dying.png\" title=\"help-me-i-am-dying.png\"><img src=\"/user_uploads/4715/KowQNR0pUHKrTTfQdeg8EQnN/help-me-i-am-dying.png\"></a></div>",
        "id": 222520755,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1610501558
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"276242\">@Riccardo D'Ambrosio</span> that was really some amazing timing <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span></p>",
        "id": 222520784,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610501587
    },
    {
        "content": "<p>right when I thought everything was working</p>",
        "id": 222520801,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610501596
    },
    {
        "content": "<p>just try it again, im sure it will work this time <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 222520811,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1610501606
    },
    {
        "content": "<p>you even did it at the exact same time as bors <a href=\"https://github.com/rust-lang/rust/pull/80932/files#issuecomment-759144296\">https://github.com/rust-lang/rust/pull/80932/files#issuecomment-759144296</a></p>",
        "id": 222520878,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610501646
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> is there a way to download the artifacts from a failed build? <code>build/tmp/tarball/rust-dev/x86_64-apple-darwin/image/lib</code> is missing for some reason and I don't know why.</p>",
        "id": 222521110,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610501850
    },
    {
        "content": "<p>Uh, if it's not in the standard place (ci-artifacts) then no</p>",
        "id": 222521283,
        "sender_full_name": "simulacrum",
        "timestamp": 1610501957
    },
    {
        "content": "<p>time for the tried and true debug method, \"stare really hard at the code\"</p>",
        "id": 222521306,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610501987
    },
    {
        "content": "<p>oh well that actually helped this time</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"c1\">// On macOS, rustc (and LLVM tools) link to an unversioned libLLVM.dylib</span>\n<span class=\"w\">    </span><span class=\"c1\">// instead of libLLVM-11-rust-....dylib, as on linux. It's not entirely</span>\n<span class=\"w\">    </span><span class=\"c1\">// clear why this is the case, though. llvm-config will emit the versioned</span>\n<span class=\"w\">    </span><span class=\"c1\">// paths and we don't want those in the sysroot (as we're expecting</span>\n<span class=\"w\">    </span><span class=\"c1\">// unversioned paths).</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">.</span><span class=\"n\">contains</span><span class=\"p\">(</span><span class=\"s\">\"apple-darwin\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">src_libdir</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">builder</span><span class=\"p\">.</span><span class=\"n\">llvm_out</span><span class=\"p\">(</span><span class=\"n\">target</span><span class=\"p\">).</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"s\">\"lib\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">llvm_dylib_path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">src_libdir</span><span class=\"p\">.</span><span class=\"n\">join</span><span class=\"p\">(</span><span class=\"s\">\"libLLVM.dylib\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">llvm_dylib_path</span><span class=\"p\">.</span><span class=\"n\">exists</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">builder</span><span class=\"p\">.</span><span class=\"n\">install</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">llvm_dylib_path</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dst_libdir</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mo\">0o644</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"o\">!</span><span class=\"n\">builder</span><span class=\"p\">.</span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">dry_run</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 222521373,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610502020
    },
    {
        "content": "<p>heh, I had similar code at one point that I gave up on</p>",
        "id": 222525820,
        "sender_full_name": "simulacrum",
        "timestamp": 1610505890
    },
    {
        "content": "<p>this issue in this case was that it assumed that LLVM would always be linked dynamically, so it wouldn't even try to copy the static files</p>",
        "id": 222525965,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610506071
    },
    {
        "content": "<p>I <em>think</em> I fixed it but <code>dist-x86_64-apple</code> takes 90 minutes to run so I'm not sure :(</p>",
        "id": 222526015,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610506102
    },
    {
        "content": "<p>yay it worked <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> <a href=\"https://github.com/rust-lang/rust/pull/80932#issuecomment-759189299\">https://github.com/rust-lang/rust/pull/80932#issuecomment-759189299</a></p>",
        "id": 222531580,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610511672
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510634\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"220326\">J. Ryan Stinnett</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222510509\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222508892\">said</a>:</p>\n<blockquote>\n<p>I'm already wondering if it will work on MacOS <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>\n</blockquote>\n<p>I am happy to test on macOS (and Windows as well) if it would help <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>\n</blockquote>\n<p>that would be great! you can test with <code>git fetch origin pull/80932/head &amp;&amp; git checkout FETCH_HEAD</code>, then edit bootstrap.py like in <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506123\">https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/Downloading.20static.20LLVM.20on.20windows/near/222506123</a>, but with the hash <code>f092cb6bc7133a66e68327189cb1cb39af7cc38e</code>. Then add <code>[llvm] download-ci-llvm = true</code> to config.toml and see if x.py build works.</p>\n</blockquote>\n<p><span class=\"user-mention\" data-user-id=\"220326\">@J. Ryan Stinnett</span> <span class=\"user-mention\" data-user-id=\"307289\">@Poliorcetics</span> if you want to help, those instructions still work, but the hash is now <code>dcd936b712817bb219ed8edbddb8e630353ef23d</code>.</p>",
        "id": 222531676,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610511747
    },
    {
        "content": "<p>There's indeed something to download this time, let's see if it builds...</p>",
        "id": 222555023,
        "sender_full_name": "J. Ryan Stinnett",
        "timestamp": 1610530467
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232545\">@Joshua Nelson</span> Seems to work here! </p>\n<div class=\"codehilite\"><pre><span></span><code>$ python3 x.py build library/std\nextracting /Users/jryans/Projects/Rust/rust/build/cache/llvm-dcd936b712817bb219ed8edbddb8e630353ef23d-False/rust-dev-nightly-x86_64-apple-darwin.tar.xz\n...\nBuild completed successfully in 0:17:14\n</code></pre></div>",
        "id": 222559140,
        "sender_full_name": "J. Ryan Stinnett",
        "timestamp": 1610532863
    },
    {
        "content": "<p>I think this is ready to go then :)</p>",
        "id": 222586788,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610548144
    },
    {
        "content": "<p>Currently running <code>python3 x.py clean &amp;&amp; python3 x.py test --stage 1</code>, it correctly downloaded LLVM and did not compile it</p>",
        "id": 222622702,
        "sender_full_name": "Poliorcetics",
        "timestamp": 1610561724
    },
    {
        "content": "<p><code>rustc_middle</code> is taking its time as usual, but everything seems to work just fine for now</p>",
        "id": 222622763,
        "sender_full_name": "Poliorcetics",
        "timestamp": 1610561757
    },
    {
        "content": "<p>tests started, see you in 30 minutes</p>",
        "id": 222623524,
        "sender_full_name": "Poliorcetics",
        "timestamp": 1610562072
    },
    {
        "content": "<p>if it gets that far I would expect it to work fine :) thank you for testing!</p>",
        "id": 222624228,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610562368
    },
    {
        "content": "<p>this is just waiting for review then :)</p>",
        "id": 222624245,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610562374
    },
    {
        "content": "<p>all clear <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 222630242,
        "sender_full_name": "Poliorcetics",
        "timestamp": 1610565012
    }
]