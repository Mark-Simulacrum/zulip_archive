[
    {
        "content": "<p>Hi everyone, I am working on a program verifier on Rust which encodes <code>mir</code> to <code>viper</code>. One issue we encountered is that we would like to develop a feature which allows users to write the specification and implmentation separately, especially when the functions they try to verify is in a dependency crate. However, looks like currently rustc only let us obtain <code>optimized_mir</code> if the function is not local, but we need the <code>mir</code> before optimization for encoding purpose. Is there any workaround?</p>",
        "id": 263092576,
        "sender_full_name": "Jerry Liu",
        "timestamp": 1638236546
    },
    {
        "content": "<p>You can use -Zmir-opt-level=0 to disable all MIR optimizations.</p>",
        "id": 263108022,
        "sender_full_name": "bjorn3",
        "timestamp": 1638256105
    },
    {
        "content": "<p>What if I only want to obtain the unoptimized version<code>mir</code> of a procedure's body with a specific <code>DefId</code>? I guess the arg you mentioned will disable all MIR optimizations?</p>",
        "id": 263108344,
        "sender_full_name": "Jerry Liu",
        "timestamp": 1638256537
    },
    {
        "content": "<p>For extern crates only the MIR after optimizations is stored. If you want MIR without optimizations you will have to disable optimizations when compiling it.</p>",
        "id": 263108417,
        "sender_full_name": "bjorn3",
        "timestamp": 1638256628
    },
    {
        "content": "<p>For local crates something similar applies because the mir_optimized query steals the generated MIR making it inaccessible from other places.</p>",
        "id": 263108485,
        "sender_full_name": "bjorn3",
        "timestamp": 1638256708
    },
    {
        "content": "<p>If we disable all mir optimization, I can directly load the <code>mir</code> without optimization from metadata?</p>",
        "id": 263108513,
        "sender_full_name": "Jerry Liu",
        "timestamp": 1638256768
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133247\">bjorn3</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Obtain.20External.20Mir/near/263108417\">said</a>:</p>\n<blockquote>\n<p>For extern crates only the MIR after optimizations is stored. If you want MIR without optimizations you will have to disable optimizations when compiling it.</p>\n</blockquote>\n<p>If we do compile external without optimization, what API should I use to obtain <code>mir</code> of external crate?</p>",
        "id": 263108719,
        "sender_full_name": "Jerry Liu",
        "timestamp": 1638257025
    },
    {
        "content": "<p>Yes to the first question and use <code>optimized_mir</code> for the second question.</p>",
        "id": 263120827,
        "sender_full_name": "bjorn3",
        "timestamp": 1638265618
    },
    {
        "content": "<p><code>optimized_mir</code> runs optimizations if enabled, but also a couple of required transformations like lowering generators to state machines (for async functions), drop elaboration (so the drop terminator doesn't run when a value is already moved out) and const propagation (required to report certain errors).</p>",
        "id": 263121127,
        "sender_full_name": "bjorn3",
        "timestamp": 1638265758
    }
]