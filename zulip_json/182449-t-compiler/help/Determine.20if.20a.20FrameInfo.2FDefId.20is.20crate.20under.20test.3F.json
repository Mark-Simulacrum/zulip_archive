[
    {
        "content": "<p>I am working on Miri diagnostics. One of the things Miri really wants to know is whether telling the user about a Frame is likely to be actionable. Currently, the heuristic for this is <code>FrameInfo.instance.def_id().is_local()</code>. The problem is that this seems to be false for the crate under test, when I'm running integration tests or doctests.</p>\n<p>I'm down for any kind of hackery. Currently I'm considering inverting the approach and taking the <code>CrateNum</code> from the <code>DefId</code> and putting that into <code>TyCtxt::crate_name</code> and checking if that's one of <code>core</code>, <code>std</code>, <code>alloc</code>, etc.</p>",
        "id": 275109972,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1647109246
    },
    {
        "content": "<p>Random ideas: </p>\n<ul>\n<li><code>used_crate_source</code> could be None for the sysroot crates</li>\n<li>add a diagnostic item to the crate root of the crates you want to exclude</li>\n<li>check if <code>lookup_stability</code> of the crate root is <code>None</code> (true for all crates not in the sysroot)</li>\n</ul>",
        "id": 275113134,
        "sender_full_name": "oli",
        "timestamp": 1647113440
    },
    {
        "content": "<p>I guess also filter out any kind of shims?</p>",
        "id": 275113149,
        "sender_full_name": "oli",
        "timestamp": 1647113492
    },
    {
        "content": "<p>Interesting. But if possible, I would rather figure out what crate's tests I'm running.</p>",
        "id": 275114167,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1647114879
    },
    {
        "content": "<p>Right... maybe the test crate's name gives something away? Probably doesn't work for integration tests just inline tests.</p>",
        "id": 275114986,
        "sender_full_name": "oli",
        "timestamp": 1647116009
    },
    {
        "content": "<p>Hmm... this backtrace filtering seems like something that regular backtraces could also benefit from. Maybe we should have something in rustc itself that both backtraces and miri backtraces can use</p>",
        "id": 275115153,
        "sender_full_name": "oli",
        "timestamp": 1647116209
    },
    {
        "content": "<p>I don't think we should hide anything more than what libstd already does currently. Unlike for miri errors, panics often originate in dependencies without the user crate being at fault. In those cases hiding the dependency frames would throw away valuable information and possibly confuse people.</p>",
        "id": 275117418,
        "sender_full_name": "bjorn3",
        "timestamp": 1647119407
    },
    {
        "content": "<p>It looks like crate names may give away that they are an integration test or doctest. Integration tests seem to be called <code>test</code> and doctests seem to be called <code>rust_out</code>. But I'm not sure how to work out the name of the crate that's being tested</p>",
        "id": 275120527,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1647124773
    },
    {
        "content": "<p>I came up with something, but it's pretty unholy. I'm running <code>cargo metadata</code> inside <code>cargo-miri</code> at startup to grab all the workspace crate names, then converting them to <code>CrateNum</code> when the machine starts up. Then I check if <code>def_id.is_local() || local_crates.contains(&amp;def_id.krate)</code> to see if we should consider the frame as local.</p>",
        "id": 275124025,
        "sender_full_name": "Ben Kimock (Saethlin)",
        "timestamp": 1647130913
    }
]