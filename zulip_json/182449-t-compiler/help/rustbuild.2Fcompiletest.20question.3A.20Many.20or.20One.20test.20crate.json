[
    {
        "content": "<p>Is this the right chanel to ask a question about modifying rustbuild/compiletest? If not, where can I ask?</p>",
        "id": 272851427,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645556676
    },
    {
        "content": "<p>Sure, this works!</p>",
        "id": 272851475,
        "sender_full_name": "simulacrum",
        "timestamp": 1645556701
    },
    {
        "content": "<p>We want to replace the current jsonpath based rustdoc-json test harness with one that allows us to write the tests in rust. <br>\n<a href=\"https://github.com/rust-lang/rust/issues/94140\">issue</a>. Should this be done so that each test lives in its own crate, so they can be compilled seperatly, or put all the tests in one big crate, and have compiletest call that one crate (probably as a binary, so avoid rebuilding compiletest) with details of which test is being run, and where to find the json</p>",
        "id": 272853184,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645557424
    },
    {
        "content": "<p>If each test is going to just depend on the one crate (i.e., you don't actually need full-fledged Cargo.toml) then it's probably best to have compiletest manage building the crate and then linking tests to it, similar to how we have auxiliary crates today for UI tests.</p>",
        "id": 272857007,
        "sender_full_name": "simulacrum",
        "timestamp": 1645559297
    },
    {
        "content": "<p>The tests will need to have dependencys (serde_json, rustdoc-json-types, and posssibly some common helpers), but these will be the same for each test. I'm not sure if it's possible to have one <code>Cargo.toml</code> with these in, and use it for each test crate</p>",
        "id": 272858950,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645560145
    },
    {
        "content": "<p>Hm</p>",
        "id": 272859229,
        "sender_full_name": "simulacrum",
        "timestamp": 1645560275
    },
    {
        "content": "<p>Generally the main reason to avoid cargo for each test is that it's somewhat heavyweight (project layout, more files, longer compilation times)</p>",
        "id": 272859269,
        "sender_full_name": "simulacrum",
        "timestamp": 1645560298
    },
    {
        "content": "<p>we don't currently have an amazing answer I think for this kind of use case</p>",
        "id": 272859338,
        "sender_full_name": "simulacrum",
        "timestamp": 1645560329
    },
    {
        "content": "<p>My sense is that you should try to frame this as a set of integration tests for rustdoc rather than through compiletest (basically using libtest standard interfaces, dev-deps, etc)</p>",
        "id": 272859497,
        "sender_full_name": "simulacrum",
        "timestamp": 1645560395
    },
    {
        "content": "<p>Well, I guess, you can't <em>quite</em> do it that directly -- you need rustdoc copied by bootstrap -- but a separate crate (src/test/rustdoc-json/Cargo.toml) that has the helper as the lib and either one test file or lots of separate test files seems right to me</p>",
        "id": 272859610,
        "sender_full_name": "simulacrum",
        "timestamp": 1645560465
    },
    {
        "content": "<p>with regular <code>#[test]</code> style tests, I suspect</p>",
        "id": 272859681,
        "sender_full_name": "simulacrum",
        "timestamp": 1645560486
    },
    {
        "content": "<p>So all the test's are <code>#[test]</code> tests in crate that <code>rustbuild</code> run's <code>cargo test</code> on, after ensuring that all the json is in place?</p>",
        "id": 272862683,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645562085
    },
    {
        "content": "<p>How would passing the json location work? How would you only run one of the tests in <code>./x.py test src/test/rustdoc-json/some_test.rs</code>?</p>",
        "id": 272862801,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645562158
    },
    {
        "content": "<p>cargo test or cargo run, either way</p>",
        "id": 272863050,
        "sender_full_name": "simulacrum",
        "timestamp": 1645562277
    },
    {
        "content": "<p>(depending on how you arrange things)</p>",
        "id": 272863107,
        "sender_full_name": "simulacrum",
        "timestamp": 1645562285
    },
    {
        "content": "<p>yeah, hooking the JSON up will be a little difficult</p>",
        "id": 272863160,
        "sender_full_name": "simulacrum",
        "timestamp": 1645562318
    },
    {
        "content": "<p>do you need multi-file inputs for rustdoc?</p>",
        "id": 272863204,
        "sender_full_name": "simulacrum",
        "timestamp": 1645562344
    },
    {
        "content": "<p>If they're all single-file, it may make sense to just have the helper crate handle this</p>",
        "id": 272863236,
        "sender_full_name": "simulacrum",
        "timestamp": 1645562359
    },
    {
        "content": "<blockquote>\n<p>do you need multi-file inputs for rustdoc?</p>\n</blockquote>\n<p>Yeah, Expecialy to test docmenting across crates.</p>\n<p>In the current out of tree draft, I have a function that documents a single file, but I'd like to replace this with compiletest, as it can handle multifile (and a load of other stuff, like editions and flags)</p>",
        "id": 272864308,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645562908
    },
    {
        "content": "<p>A way to get around this could be to pass info as CLI arguments, but then you don't get <code>#[test]</code>, so you'll end up with a poor imitation</p>",
        "id": 272864414,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645562960
    },
    {
        "content": "<p>the main problem is getting the helper crate linked to compiletest-style tests, I suspect</p>",
        "id": 272864580,
        "sender_full_name": "simulacrum",
        "timestamp": 1645563029
    },
    {
        "content": "<p>(particularly if it needs to depend on <a href=\"http://crates.io\">crates.io</a> - serde_json and such)</p>",
        "id": 272864635,
        "sender_full_name": "simulacrum",
        "timestamp": 1645563061
    },
    {
        "content": "<p>Yeah, that makes me lean towards one \"normal\" crate will all the tests in it</p>",
        "id": 272864681,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645563097
    },
    {
        "content": "<p>and compiletest in general is not really intended for 'dual' tests where you have one file for rustdoc and then actually process the output of that file via custom Rust code (rather than patterns and such)</p>",
        "id": 272864768,
        "sender_full_name": "simulacrum",
        "timestamp": 1645563131
    },
    {
        "content": "<p>I will note that the <em>general</em> shape this is looking a lot like <a href=\"https://github.com/rust-lang/rust/issues/40713\">https://github.com/rust-lang/rust/issues/40713</a></p>",
        "id": 272864788,
        "sender_full_name": "simulacrum",
        "timestamp": 1645563155
    },
    {
        "content": "<p>Oh wow, yeah</p>",
        "id": 272865185,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645563363
    },
    {
        "content": "<p>I guess I'll work on the \"one big crate\" (or possible 1 support and 1 test) approach, and see how bad it goes</p>",
        "id": 272865255,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645563400
    },
    {
        "content": "<p>Thanks so much for your help with this</p>",
        "id": 272865282,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1645563415
    },
    {
        "content": "<p>Further question about this: I've started implementing, and have run into a problem. If the test source (asserts) is changed, compiletest will not rerun the test, because it only knows about the test file being documented</p>",
        "id": 275063180,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1647042333
    },
    {
        "content": "<p>Is their a way to tell compiletest that if the tool it uses has been changed, then it needs to rerun the tests</p>",
        "id": 275063319,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1647042437
    },
    {
        "content": "<p>And when doing this, can we know if the rerun has been trigered by the test or tool being out of date, so we dont need to redocument unnessessarily?</p>",
        "id": 275063414,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1647042488
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> Any ideas on this?</p>",
        "id": 276051583,
        "sender_full_name": "Nixon Enraght-Moony",
        "timestamp": 1647870022
    },
    {
        "content": "<p>You can try grepping for stamp in compiletest, there's probably some logic you can add to there</p>",
        "id": 276051688,
        "sender_full_name": "simulacrum",
        "timestamp": 1647870089
    }
]