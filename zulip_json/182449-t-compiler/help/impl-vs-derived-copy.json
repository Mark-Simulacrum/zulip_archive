[
    {
        "content": "<p>Invoke <code>clone</code> on a enum with <code>impl</code>'ed <code>Copy</code> generates more asm than <code>derive(Copy)</code>, is this intentional?<br>\n<a href=\"https://rust.godbolt.org/z/76o181Yfb\">https://rust.godbolt.org/z/76o181Yfb</a></p>",
        "id": 272093552,
        "sender_full_name": "csmoe",
        "timestamp": 1645005001
    },
    {
        "content": "<p>For derived copy in the same <code>#[derive]</code> as the clone derive, the clone derive knows that it is possible to do <code>*self</code> which results in a memcpy. If there is no derived copy, each field has to be individually cloned.</p>",
        "id": 272093898,
        "sender_full_name": "bjorn3",
        "timestamp": 1645005182
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133247\">@bjorn3</span>  a bit surprised to know this, is it possible to eliminate the difference? never thought the macro would affect the final code.</p>",
        "id": 272094779,
        "sender_full_name": "csmoe",
        "timestamp": 1645005628
    },
    {
        "content": "<p>I once made a mir-opt that turns clones to copies on <code>Copy</code> types, but based on &lt;<a href=\"https://github.com/rust-lang/rfcs/pull/3197\">https://github.com/rust-lang/rfcs/pull/3197</a>&gt; we're not actually allowed to do that in general.</p>",
        "id": 272095615,
        "sender_full_name": "scottmcm",
        "timestamp": 1645006099
    },
    {
        "content": "<p>The optimization would still be allowable under the as-if rule. If the compiler sees the clone impl has no side-effects it could optimize it further to a memcpy.</p>",
        "id": 272096866,
        "sender_full_name": "The 8472",
        "timestamp": 1645006802
    },
    {
        "content": "<p>Plus that clarification PR isn't settled.</p>",
        "id": 272096982,
        "sender_full_name": "The 8472",
        "timestamp": 1645006866
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"330154\">The 8472</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/impl-vs-derived-copy/near/272096866\">said</a>:</p>\n<blockquote>\n<p>The optimization would still be allowable under the as-if rule. If the compiler sees the clone impl has no side-effects it could optimize it further to a memcpy.</p>\n</blockquote>\n<p>yep, the transformation <span class=\"user-mention\" data-user-id=\"125294\">@Aaron Hill</span> did for <code>derived(Clone)</code> benefited our binary size about 200k in a experiment.</p>",
        "id": 272097981,
        "sender_full_name": "csmoe",
        "timestamp": 1645007496
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rfcs/pull/3197#issuecomment-1024450110\">https://github.com/rust-lang/rfcs/pull/3197#issuecomment-1024450110</a></p>",
        "id": 272098013,
        "sender_full_name": "csmoe",
        "timestamp": 1645007517
    },
    {
        "content": "<p>your approach should benefit more if we can cover more no-side-effect cases.</p>",
        "id": 272098168,
        "sender_full_name": "csmoe",
        "timestamp": 1645007604
    }
]