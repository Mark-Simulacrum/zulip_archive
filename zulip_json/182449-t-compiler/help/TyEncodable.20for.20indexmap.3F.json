[
    {
        "content": "<p>I'm getting the following error in <a href=\"https://github.com/rust-lang/rust/pull/90842\">https://github.com/rust-lang/rust/pull/90842</a>:</p>\n<div class=\"codehilite\"><pre><span></span><code>error[E0277]: the trait bound `indexmap::map::IndexMap&lt;SimplifiedTypeGen&lt;rustc_span::def_id::DefId&gt;, Vec&lt;rustc_span::def_id::DefId&gt;, BuildHasherDefault&lt;FxHasher&gt;&gt;: Encodable&lt;__E&gt;` is not satisfied\n  --&gt; compiler/rustc_middle/src/traits/specialization_graph.rs:51:19\n   |\n51 |   #[derive(Default, TyEncodable, TyDecodable, Debug, HashStable)]\n   |                     ^^^^^^^^^^^\n   |                     |\n   |                     the trait `Encodable&lt;__E&gt;` is not implemented for `indexmap::map::IndexMap&lt;SimplifiedTypeGen&lt;rustc_span::def_id::DefId&gt;, Vec&lt;rustc_span::def_id::DefId&gt;, BuildHasherDefault&lt;FxHasher&gt;&gt;`\n   |                     in this derive macro expansion\n   |\n  ::: /Users/wpierce/.cargo/registry/src/github.com-1ecc6299db9ec823/synstructure-0.12.6/src/macros.rs:94:9\n   |\n94 | /         pub fn $derives(\n95 | |             i: $crate::macros::TokenStream\n96 | |         ) -&gt; $crate::macros::TokenStream {\n   | |________________________________________- in this expansion of `#[derive(TyEncodable)]`\n</code></pre></div>\n<p>(I'm using a temporary git dependency that's blocked by tidy in CI, so this error only shows up locally right now.)</p>\n<p>Is there a way to get this trait where I need it? Will I need some kind of wrapping type?</p>",
        "id": 267084106,
        "sender_full_name": "pierwill",
        "timestamp": 1641487846
    },
    {
        "content": "<p>Then again, maybe the indexmap isn't the problem? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 267084216,
        "sender_full_name": "pierwill",
        "timestamp": 1641487900
    },
    {
        "content": "<p>Or maybe I need to manually implement something? I also don't even know what TyEncodable is for <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span></p>",
        "id": 267084455,
        "sender_full_name": "pierwill",
        "timestamp": 1641488006
    },
    {
        "content": "<p>You will need to add an implementation of <code>Encodable</code> and <code>Decodable</code> for <code>IndexMap</code> to rustc_serialize. <code>(Ty)Encodable</code> and <code>(Ty)Decodable</code> are used to serialize and deserialize crate metadata and incremental caches.</p>",
        "id": 267084736,
        "sender_full_name": "bjorn3",
        "timestamp": 1641488157
    },
    {
        "content": "<p>Ah! So somewhere in here, maybe? <a href=\"https://github.com/rust-lang/rust/blob/03c49e62dbf5071e9c6f62fb25d8014f90243dca/compiler/rustc_serialize/src/serialize.rs#L589\">https://github.com/rust-lang/rust/blob/03c49e62dbf5071e9c6f62fb25d8014f90243dca/compiler/rustc_serialize/src/serialize.rs#L589</a></p>",
        "id": 267084900,
        "sender_full_name": "pierwill",
        "timestamp": 1641488240
    },
    {
        "content": "<p>Here I think: <a href=\"https://github.com/rust-lang/rust/blob/03c49e62dbf5071e9c6f62fb25d8014f90243dca/compiler/rustc_serialize/src/collection_impls.rs\">https://github.com/rust-lang/rust/blob/03c49e62dbf5071e9c6f62fb25d8014f90243dca/compiler/rustc_serialize/src/collection_impls.rs</a></p>",
        "id": 267085017,
        "sender_full_name": "bjorn3",
        "timestamp": 1641488302
    },
    {
        "content": "<p>Looks like IndexMap already has an implementation...</p>",
        "id": 267085039,
        "sender_full_name": "bjorn3",
        "timestamp": 1641488319
    },
    {
        "content": "<p>hmmmm</p>",
        "id": 267085069,
        "sender_full_name": "pierwill",
        "timestamp": 1641488337
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/blob/03c49e62dbf5071e9c6f62fb25d8014f90243dca/compiler/rustc_serialize/src/collection_impls.rs#L220-L225\">https://github.com/rust-lang/rust/blob/03c49e62dbf5071e9c6f62fb25d8014f90243dca/compiler/rustc_serialize/src/collection_impls.rs#L220-L225</a> is the <code>Eq</code> bound satisfied?</p>",
        "id": 267085074,
        "sender_full_name": "bjorn3",
        "timestamp": 1641488342
    },
    {
        "content": "<p>checking now</p>",
        "id": 267085172,
        "sender_full_name": "pierwill",
        "timestamp": 1641488392
    },
    {
        "content": "<p>I think the issue is that you are now using two versions of indexmap. The impl applies only to one of the versions. You should probably patch it using <code>[patch.crates-io]</code> instead of replacing the dependency specification.</p>",
        "id": 267085483,
        "sender_full_name": "bjorn3",
        "timestamp": 1641488497
    },
    {
        "content": "<p>looks to me like all the types in <code>indexmap::map::IndexMap&lt;SimplifiedTypeGen&lt;rustc_span::def_id::DefId&gt;, Vec&lt;rustc_span::def_id::DefId&gt;, BuildHasherDefault&lt;FxHasher&gt;&gt;</code> are Eq, but I could be wrong.</p>",
        "id": 267085487,
        "sender_full_name": "pierwill",
        "timestamp": 1641488498
    },
    {
        "content": "<p>That would be here: <a href=\"https://github.com/rust-lang/rust/blob/a77cc64af491a31db224109a76b9b81cd26cd07c/Cargo.toml#L123\">https://github.com/rust-lang/rust/blob/a77cc64af491a31db224109a76b9b81cd26cd07c/Cargo.toml#L123</a></p>",
        "id": 267085572,
        "sender_full_name": "bjorn3",
        "timestamp": 1641488528
    },
    {
        "content": "<p>ah, so use that for now, then when the version of indexmap with the fix is released, put it in the cargo.toml/lock?</p>",
        "id": 267085641,
        "sender_full_name": "pierwill",
        "timestamp": 1641488570
    },
    {
        "content": "<p>Yes</p>",
        "id": 267085671,
        "sender_full_name": "bjorn3",
        "timestamp": 1641488586
    },
    {
        "content": "<p>okay, I'll try that, thanks!</p>",
        "id": 267085698,
        "sender_full_name": "pierwill",
        "timestamp": 1641488600
    },
    {
        "content": "<p>With this line in the main Cargo.toml <code>indexmap = { git = 'https://github.com/cuviper/indexmap.git', branch='rustc-rayon' }</code> and nothing else, I'm not getting the right dependency, because we're back to the error this branch is supposed to fix: </p>\n<div class=\"codehilite\"><pre><span></span><code>error[E0277]: the trait bound `&amp;indexmap::set::IndexSet&lt;LocalDefId, BuildHasherDefault&lt;FxHasher&gt;&gt;: ParallelIterator` is not satisfied\n    --&gt; compiler/rustc_metadata/src/rmeta/encoder.rs:2098:14\n     |\n2098 |     par_iter(tcx.mir_keys(())).for_each(|&amp;def_id| {\n     |     -------- ^^^^^^^^^^^^^^^^ the trait `ParallelIterator` is not implemented for `&amp;indexmap::set::IndexSet&lt;LocalDefId, BuildHasherDefault&lt;FxHasher&gt;&gt;`\n     |     |\n     |     required by a bound introduced by this call\n     |\n     = note: required because of the requirements on the impl of `rustc_rayon::iter::IntoParallelIterator` for `&amp;indexmap::set::IndexSet&lt;LocalDefId, BuildHasherDefault&lt;FxHasher&gt;&gt;`\nnote: required by a bound in `par_iter`\n    --&gt; /Users/wpierce/repos/rust/compiler/rustc_data_structures/src/sync.rs:334:28\n     |\n334  |         pub fn par_iter&lt;T: IntoParallelIterator&gt;(t: T) -&gt; T::Iter {\n     |                            ^^^^^^^^^^^^^^^^^^^^ required by this bound in `par_iter`\n</code></pre></div>",
        "id": 267086757,
        "sender_full_name": "pierwill",
        "timestamp": 1641489055
    },
    {
        "content": "<p>Does it need to be in the crate Cargo.toml as well?</p>",
        "id": 267086780,
        "sender_full_name": "pierwill",
        "timestamp": 1641489068
    },
    {
        "content": "<p>Does it give a warning along the lines of unused patch?</p>",
        "id": 267086833,
        "sender_full_name": "bjorn3",
        "timestamp": 1641489101
    },
    {
        "content": "<p>I don't think so...</p>\n<div class=\"codehilite\"><pre><span></span><code>error: unused import: `FxIndexMap`\n --&gt; compiler/rustc_metadata/src/rmeta/encoder.rs:5:44\n  |\n5 | use rustc_data_structures::fx::{FxHashMap, FxIndexMap, FxIndexSet};\n  |                                            ^^^^^^^^^^\n  |\n  = note: `-D unused-imports` implied by `-D warnings`\n</code></pre></div>",
        "id": 267086911,
        "sender_full_name": "pierwill",
        "timestamp": 1641489130
    },
    {
        "content": "<p>And what does cargo list when compiling indexmap? Does it show the git path or just the version?</p>",
        "id": 267086949,
        "sender_full_name": "bjorn3",
        "timestamp": 1641489148
    },
    {
        "content": "<p>git path</p>",
        "id": 267086990,
        "sender_full_name": "pierwill",
        "timestamp": 1641489169
    },
    {
        "content": "<p>ah the error might be related to a change from rebasing on master</p>",
        "id": 267087046,
        "sender_full_name": "pierwill",
        "timestamp": 1641489199
    },
    {
        "content": "<p>i'll look into that and come back if i'm still stuck :)</p>",
        "id": 267087061,
        "sender_full_name": "pierwill",
        "timestamp": 1641489210
    },
    {
        "content": "<p>wait... maybe not... i'm still stuck lol</p>",
        "id": 267087110,
        "sender_full_name": "pierwill",
        "timestamp": 1641489240
    },
    {
        "content": "<p>i'll push my current code</p>",
        "id": 267087153,
        "sender_full_name": "pierwill",
        "timestamp": 1641489245
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/pull/90842/files\">https://github.com/rust-lang/rust/pull/90842/files</a></p>",
        "id": 267087315,
        "sender_full_name": "pierwill",
        "timestamp": 1641489329
    },
    {
        "content": "<p>(actually some of my changes may have fallen out ....)</p>",
        "id": 267087538,
        "sender_full_name": "pierwill",
        "timestamp": 1641489439
    },
    {
        "content": "<p>Weird. No idea what the problem is.</p>",
        "id": 267087946,
        "sender_full_name": "bjorn3",
        "timestamp": 1641489626
    },
    {
        "content": "<p>Ah!</p>",
        "id": 267089236,
        "sender_full_name": "pierwill",
        "timestamp": 1641490233
    },
    {
        "content": "<p>Maybe the upstream patch only added <code>ParallelIterator</code> for IndexMap, not IndexSet. Lemme check that..</p>",
        "id": 267089405,
        "sender_full_name": "pierwill",
        "timestamp": 1641490341
    },
    {
        "content": "<p>Nope, that's not it.</p>",
        "id": 267089915,
        "sender_full_name": "pierwill",
        "timestamp": 1641490638
    },
    {
        "content": "<p>yeah, it should work for both maps and sets</p>",
        "id": 267090452,
        "sender_full_name": "cuviper",
        "timestamp": 1641490894
    },
    {
        "content": "<p>we should merge and publish that already -- but now I want to be sure that it's actually working first... :)</p>",
        "id": 267090494,
        "sender_full_name": "cuviper",
        "timestamp": 1641490917
    },
    {
        "content": "<p>oh, <span class=\"user-mention\" data-user-id=\"316352\">@pierwill</span> it doesn't look like you're enabling the \"rustc-rayon\" feature</p>",
        "id": 267090592,
        "sender_full_name": "cuviper",
        "timestamp": 1641490966
    },
    {
        "content": "<p>Looks like that was it, <span class=\"user-mention\" data-user-id=\"138448\">@cuviper</span> ! <code>x.py check</code> is passing now</p>",
        "id": 267091394,
        "sender_full_name": "pierwill",
        "timestamp": 1641491396
    },
    {
        "content": "<p>Thank you :)</p>",
        "id": 267091797,
        "sender_full_name": "pierwill",
        "timestamp": 1641491584
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"316352\">pierwill</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/TyEncodable.20for.20indexmap.3F/near/267091394\">said</a>:</p>\n<blockquote>\n<p><code>x.py check</code> is passing now</p>\n</blockquote>\n<p>It's working locally, not in CI because of git dependency</p>",
        "id": 267093136,
        "sender_full_name": "pierwill",
        "timestamp": 1641492156
    },
    {
        "content": "<p>You can edit <code>src/tools/tidy/src/extdeps.rs</code> to fix CI for now.</p>",
        "id": 267094062,
        "sender_full_name": "bjorn3",
        "timestamp": 1641492540
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133247\">bjorn3</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/TyEncodable.20for.20indexmap.3F/near/267094062\">said</a>:</p>\n<blockquote>\n<p>You can edit <code>src/tools/tidy/src/extdeps.rs</code> to fix CI for now.</p>\n</blockquote>\n<p>Getting this error still. <a href=\"https://github.com/rust-lang/rust/runs/4730453134?check_suite_focus=true#step:25:137\">https://github.com/rust-lang/rust/runs/4730453134?check_suite_focus=true#step:25:137</a></p>",
        "id": 267095428,
        "sender_full_name": "pierwill",
        "timestamp": 1641493302
    },
    {
        "content": "<p>I think you accidentally reverted the <code>[patch.crates-io]</code> change.</p>",
        "id": 267096270,
        "sender_full_name": "bjorn3",
        "timestamp": 1641493761
    },
    {
        "content": "<p>I did. It gave a warning that said the patch mechanism won't work with features</p>",
        "id": 267096779,
        "sender_full_name": "pierwill",
        "timestamp": 1641493994
    },
    {
        "content": "<p><code>warning: patch for </code>indexmap<code> uses the features mechanism. default-features and features will not take effect because the patch dependency does not support this mechanism</code></p>",
        "id": 267096897,
        "sender_full_name": "pierwill",
        "timestamp": 1641494043
    }
]