[
    {
        "content": "<p>I'm trying to run crater locally, but it eventually fails, complaining that it is out of disk space. I'm running on an AWS instance with 2TB of disk space, and as far as I could tell the max disk space consumed was 1.1TB. Am I doing something wrong? </p>\n<p>This is my invocation:</p>\n<div class=\"codehilite\"><pre><span></span><code>cargo run --release -- define-ex  --ex experiment  --crate-select=full nightly nightly+rustflags=-Clink-args=-fuse-ld=lld\ncargo run --release -- run-graph  --ex experiment --docker-env=crates-build-env-local:latest\n</code></pre></div>",
        "id": 259886525,
        "sender_full_name": "Karl Meakin",
        "timestamp": 1635784418
    },
    {
        "content": "<p>Can you provide a more detailed failure description? In particular, is crater itself complaining? Maybe your docker mount is on a smaller partition?</p>",
        "id": 259887402,
        "sender_full_name": "simulacrum",
        "timestamp": 1635784828
    },
    {
        "content": "<p>I don't have the exact message to hand, because I'm trying to rerun it with fewer threads atm. I recall that after a certain point, all attempts at building a new crate from github would fail: it would attempt to <code>git clone</code> the repo, git would return a <code>no space left on device</code> error, so crater would mark the crate as failed and move on to the next one, which would fail in the same way</p>",
        "id": 259890502,
        "sender_full_name": "Karl Meakin",
        "timestamp": 1635786063
    },
    {
        "content": "<p>I don't recall similar problems with our production deployment (at least one runner there uses a 700 GB disk, iirc), so probably not much help without more debugging on your end unfortunately.</p>",
        "id": 259890976,
        "sender_full_name": "simulacrum",
        "timestamp": 1635786260
    },
    {
        "content": "<p>you can look at our ansible configs here <a href=\"https://github.com/rust-lang/simpleinfra/blob/master/ansible/\">https://github.com/rust-lang/simpleinfra/blob/master/ansible/</a> for how we set up crater agents</p>",
        "id": 259891049,
        "sender_full_name": "simulacrum",
        "timestamp": 1635786305
    },
    {
        "content": "<p>Which filesystem? Small btrfs partitions can have issues with too much metadata that would manifest as enospc even though there's still space left on the device. Other filesystems can run out of inodes. Some of the docker storage drivers might have their own limitations.</p>",
        "id": 259902671,
        "sender_full_name": "The 8472",
        "timestamp": 1635791876
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"330154\">The 8472</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Running.20crater.20locally/near/259902671\">said</a>:</p>\n<blockquote>\n<p>Which filesystem? Small btrfs partitions can have issues with too much metadata that would manifest as enospc even though there's still space left on the device. Other filesystems can run out of inodes. Some of the docker storage drivers might have their own limitations.</p>\n</blockquote>\n<p>It's running on ext4. I will investigate inodes or docker limitations</p>",
        "id": 260031586,
        "sender_full_name": "Karl Meakin",
        "timestamp": 1635874787
    },
    {
        "content": "<p><code>df -i</code> says only 2% of inodes have been used up, so its probably not that</p>",
        "id": 260033394,
        "sender_full_name": "Karl Meakin",
        "timestamp": 1635875584
    },
    {
        "content": "<p>If you created that ext4 partition on a system with a kernel older than 4.13 it might be lacking the large_dir feature.<br>\n<a href=\"https://github.com/torvalds/linux/commit/e08ac99fa2a25626f573cfa377ef3ddedf2cfe8f\">https://github.com/torvalds/linux/commit/e08ac99fa2a25626f573cfa377ef3ddedf2cfe8f</a></p>\n<p>That can also manifest in ENOSPC</p>",
        "id": 260033413,
        "sender_full_name": "The 8472",
        "timestamp": 1635875594
    },
    {
        "content": "<p>nope, im running <code>5.11.0-1020-aws</code></p>",
        "id": 260036806,
        "sender_full_name": "Karl Meakin",
        "timestamp": 1635877168
    },
    {
        "content": "<p>idk then, tons of things can cause enospc. maybe run it under strace and see which syscall fails, that might provide a hint.</p>",
        "id": 260040582,
        "sender_full_name": "The 8472",
        "timestamp": 1635878977
    },
    {
        "content": "<p>2nd crater run finished. This time I logged the disk space used every minute. The disk usage just climbs continuously, until it reaches 100%. Then crater crashes and cleans up after itself. Isn't crater supposed to clean up the cargo cache periodically?</p>",
        "id": 260289039,
        "sender_full_name": "Karl Meakin",
        "timestamp": 1636040646
    },
    {
        "content": "<p>Yes, I think so. Maybe that detection code isn't working? IIRC, the limit is 80% or so.</p>",
        "id": 260290090,
        "sender_full_name": "simulacrum",
        "timestamp": 1636041047
    }
]