[
    {
        "content": "<p>Hi all! I'm currently (as mentioned in my welcome message) attempting to get the rust compiler working with a custom llvm implementation. I thought I had succeeded in this but unfortunately, I'm getting issues when looking up my \"new\" target in llvm's target machine. (Specifically, this is in the function <code>LLVMRustCreateTargetMachine</code> in <code>PassWrapper.cpp</code>)</p>\n<p>I <em>believe</em> that my issue is with the way that the bootstrap compiler is finding <code>llvm-config</code>, but I'm struggling to diagnose/debug this exactly. I <em>believe</em> that I've set it correctly in <code>config.toml</code>, as follows: </p>\n<div class=\"codehilite\"><pre><span></span><code>[build]\nverbose = 2\n\ntarget = [&quot;x86_64-unknown-linux-gnu&quot;, &quot;my-special-target&quot;]\n\n[rust]\ndebug-logging = true\nincremental = true\ndebug = true\ncodegen-units = 0\ndebuginfo-level = 2\nbacktrace-on-ice = true\n\n[llvm]\ndownload-ci-llvm = false\n\n[target.x86_64-unknown-linux-gnu]\nllvm-config = &quot;/path/to/my/llvm/build/folder/bin/llvm-config&quot;\n\n[target.my-special-target]\nllvm-config = &quot;/path/to/my/llvm/build/folder/bin/llvm-config&quot;\n</code></pre></div>\n<p>Does anyone have any advice as to how I should diagnose this, or if there is another route that I should be taking to to specify the <code>llvm-config</code> program?</p>",
        "id": 256262429,
        "sender_full_name": "AdamH",
        "timestamp": 1633446438
    },
    {
        "content": "<p>You can always check what LLVM is being linked to by looking at the <code>ldd</code> output for <code>librustc_codegen_llvm.so</code></p>",
        "id": 256265427,
        "sender_full_name": "nagisa",
        "timestamp": 1633447344
    },
    {
        "content": "<p>Ah, that's a good shout!</p>",
        "id": 256265577,
        "sender_full_name": "AdamH",
        "timestamp": 1633447393
    },
    {
        "content": "<p>Hm, they're rlibs actuallyâ€¦ well, since its system llvm something must link to llvm dynamically either way.</p>",
        "id": 256266182,
        "sender_full_name": "nagisa",
        "timestamp": 1633447566
    },
    {
        "content": "<p>perhaps <a href=\"http://librustc_driver.so\">librustc_driver.so</a>... or something of the sort.</p>",
        "id": 256266283,
        "sender_full_name": "nagisa",
        "timestamp": 1633447602
    },
    {
        "content": "<p>I am currently re-compiling rustc_driver, but I shall take a look for that once it's done.</p>",
        "id": 256266885,
        "sender_full_name": "AdamH",
        "timestamp": 1633447804
    },
    {
        "content": "<p>Okay, I can confirm that the <code>llvm-config</code> in <code>rustc_llvm/build.rs</code> <em>is</em> seeing the correct my llvm.</p>",
        "id": 256269120,
        "sender_full_name": "AdamH",
        "timestamp": 1633448561
    },
    {
        "content": "<p>(And it sees our backend as one of the components)</p>",
        "id": 256269159,
        "sender_full_name": "AdamH",
        "timestamp": 1633448576
    },
    {
        "content": "<p>Hmm, so I can confirm that I see symbols from my backend in <code>librustc_driver.so</code>. I suppose there must be some other issue occuring.</p>",
        "id": 256270493,
        "sender_full_name": "AdamH",
        "timestamp": 1633449101
    },
    {
        "content": "<p>Did you add your backend initialization functions to <code>initialize_available_targets</code>?</p>",
        "id": 256272704,
        "sender_full_name": "nagisa",
        "timestamp": 1633449854
    },
    {
        "content": "<p>in compiler/rustc_llvm/src/lib.rs</p>",
        "id": 256272749,
        "sender_full_name": "nagisa",
        "timestamp": 1633449872
    },
    {
        "content": "<p>Ah, I did not! I wasn't aware of that.</p>",
        "id": 256273165,
        "sender_full_name": "AdamH",
        "timestamp": 1633450002
    },
    {
        "content": "<p>Giving that a try now.</p>",
        "id": 256273287,
        "sender_full_name": "AdamH",
        "timestamp": 1633450044
    }
]