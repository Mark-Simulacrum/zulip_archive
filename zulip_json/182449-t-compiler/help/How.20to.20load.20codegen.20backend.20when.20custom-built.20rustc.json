[
    {
        "content": "<p>Hi.<br>\nTo debug <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/'rustc'.20panicked.20at.20'called.20Option.3A.3Aunwrap.28.29.20on.20a.20None.20value\">an issue</a>, I want to use a rustc built with debug symbols.<br>\nI use to be able to do that, by creating a rustup toolchain link (named debug-current) and specifying that name in <code>rust-toolchain</code>, but it doesn't work anymore.<br>\nI get the error:</p>\n<div class=\"codehilite\"><pre><span></span><code>error: couldn&#39;t load codegen backend &quot;/projects/rustc_codegen_gccjit/target/debug/librustc_codegen_gcc.so&quot;: &quot;librustc_driver-d417e018100dedfd.so: cannot open shared object file: No such file or directory&quot;\n</code></pre></div>\n<p>My notes mention that I should add <code>~/.rustup/toolchains/debug-current/lib/rustlib/x86_64-unknown-linux-gnu/lib</code> to <code>LD_LIBRARY_PATH</code>, but that doesn't work either. In this case, I get the following error at run-time:</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;cannot access a scoped thread local variable without calling `set` first&#39;, /home/bouanto/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:168:9\n</code></pre></div>\n<p>What can I do to be able to load a codegen backend in a custom-built rustc?<br>\nThanks.</p>",
        "id": 250399857,
        "sender_full_name": "antoyo",
        "timestamp": 1629746895
    },
    {
        "content": "<p>the second error looks unrelated to the first - what's the backtrace on that? parts of the compiler you just can't use without being in the context of <code>with_default_session_globals()</code></p>",
        "id": 250400427,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1629747191
    },
    {
        "content": "<p>Here's the full backtrace:</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;cannot access a scoped thread local variable without calling `set` first&#39;, /home/bouanto/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:168:9\nstack backtrace:\n   0: std::panicking::begin_panic\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/library/std/src/panicking.rs:543:12\n   1: scoped_tls::ScopedKey&lt;T&gt;::with\n             at /home/bouanto/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:168:9\n   2: rustc_span::with_session_globals\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_span/src/lib.rs:144:5\n   3: rustc_span::symbol::with_interner\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_span/src/symbol.rs:1838:5\n   4: rustc_span::symbol::Symbol::as_str\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_span/src/symbol.rs:1594:9\n   5: &lt;rustc_span::symbol::Symbol as core::fmt::Display&gt;::fmt\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_span/src/symbol.rs:1628:28\n   6: core::fmt::run\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/library/core/src/fmt/mod.rs:1162:5\n   7: core::fmt::write\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/library/core/src/fmt/mod.rs:1130:26\n   8: core::fmt::Write::write_fmt\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/library/core/src/fmt/mod.rs:187:9\n   9: alloc::fmt::format\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/library/alloc/src/fmt.rs:583:5\n  10: rustc_middle::mir::mono::CodegenUnitNameBuilder::build_cgu_name_no_mangle::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_middle/src/mir/mono.rs:504:13\n  11: std::collections::hash::map::Entry&lt;K,V&gt;::or_insert_with\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/library/std/src/collections/hash/map.rs:2336:43\n  12: rustc_middle::mir::mono::CodegenUnitNameBuilder::build_cgu_name_no_mangle\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_middle/src/mir/mono.rs:488:28\n  13: rustc_middle::mir::mono::CodegenUnitNameBuilder::build_cgu_name\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_middle/src/mir/mono.rs:460:24\n  14: rustc_codegen_ssa::base::codegen_crate\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_codegen_ssa/src/base.rs:569:13\n  15: &lt;rustc_codegen_gcc::GccCodegenBackend as rustc_codegen_ssa::traits::backend::CodegenBackend&gt;::codegen_crate\n             at ./src/lib.rs:97:19\n  16: rustc_interface::passes::start_codegen::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/passes.rs:1056:9\n  17: rustc_data_structures::profiling::VerboseTimingGuard::run\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_data_structures/src/profiling.rs:611:9\n  18: rustc_session::utils::&lt;impl rustc_session::session::Session&gt;::time\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_session/src/utils.rs:16:9\n  19: rustc_interface::passes::start_codegen\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/passes.rs:1055:19\n  20: rustc_interface::queries::Queries::ongoing_codegen::{{closure}}::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/queries.rs:254:20\n  21: rustc_interface::passes::QueryContext::enter::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/passes.rs:780:42\n  22: rustc_middle::ty::context::tls::enter_context::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_middle/src/ty/context.rs:1784:50\n  23: rustc_middle::ty::context::tls::set_tlv\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_middle/src/ty/context.rs:1768:9\n  24: rustc_middle::ty::context::tls::enter_context\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_middle/src/ty/context.rs:1784:9\n  25: rustc_interface::passes::QueryContext::enter\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/passes.rs:780:9\n  26: rustc_interface::queries::Queries::ongoing_codegen::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/queries.rs:245:13\n  27: rustc_interface::queries::Query&lt;T&gt;::compute\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/queries.rs:38:28\n  28: rustc_interface::queries::Queries::ongoing_codegen\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/queries.rs:243:9\n  29: rustc_driver::run_compiler::{{closure}}::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_driver/src/lib.rs:407:13\n  30: rustc_interface::queries::&lt;impl rustc_interface::interface::Compiler&gt;::enter\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/queries.rs:390:19\n  31: rustc_driver::run_compiler::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_driver/src/lib.rs:312:22\n  32: rustc_interface::interface::create_compiler_and_run::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/interface.rs:209:13\n  33: rustc_span::with_source_map\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_span/src/lib.rs:911:5\n  34: rustc_interface::interface::create_compiler_and_run\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/interface.rs:203:5\n  35: rustc_interface::interface::run_compiler::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/interface.rs:225:12\n  36: rustc_interface::util::setup_callbacks_and_run_in_thread_pool_with_globals::{{closure}}::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/util.rs:157:13\n  37: scoped_tls::ScopedKey&lt;T&gt;::set\n             at /home/bouanto/.cargo/registry/src/github.com-1ecc6299db9ec823/scoped-tls-1.0.0/src/lib.rs:137:9\n  38: rustc_span::create_session_globals_then\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_span/src/lib.rs:105:5\n  39: rustc_interface::util::setup_callbacks_and_run_in_thread_pool_with_globals::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/util.rs:155:9\n  40: rustc_interface::util::scoped_thread::{{closure}}\n             at /home/bouanto/Ordinateur/Programmation/Rust/Projets/rust/compiler/rustc_interface/src/util.rs:130:24\n</code></pre></div>",
        "id": 250401282,
        "sender_full_name": "antoyo",
        "timestamp": 1629747643
    },
    {
        "content": "<p>hmm, that's weird, the globals should be set in that very first frame:</p>\n<blockquote>\n<p>39: rustc_interface::util::setup_callbacks_and_run_in_thread_pool_with_globals::{{closure}}</p>\n</blockquote>",
        "id": 250401495,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1629747753
    },
    {
        "content": "<p>not sure, sorry</p>",
        "id": 250401500,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1629747755
    },
    {
        "content": "<p>did you compile cg_gcc using the debug mode rustc? of not it is linked to the rustc_driver from your nightly, which means it is abi incompatible.</p>",
        "id": 250401644,
        "sender_full_name": "bjorn3",
        "timestamp": 1629747836
    },
    {
        "content": "<p>Yes, I did. Otherwise, it would probably be linked to a different librustc_driver and would not find it. (Though, I'm still surprised I have to set LD_LIBRARY_PATH.) Is there a way to check that for sure? Running <code>rustc -Vv</code> with the rust-toolchain containing <code>debug-current</code> and the nightly both give the same output. Is this normal?</p>",
        "id": 250402278,
        "sender_full_name": "antoyo",
        "timestamp": 1629748145
    },
    {
        "content": "<p>rustc -vV for a locally built rustc should report -dev instead of -nightly.</p>",
        "id": 250402452,
        "sender_full_name": "bjorn3",
        "timestamp": 1629748213
    },
    {
        "content": "<p>what does <code>rustup show</code> say?</p>",
        "id": 250402471,
        "sender_full_name": "bjorn3",
        "timestamp": 1629748226
    },
    {
        "content": "<p>I compiled with <code>channel = \"nightly\"</code>, so there's no <code>-dev</code>. I can't remember why I did this, but I did this when I was trying to make it work the previous time. Should I set it back to <code>dev</code>?</p>\n<p>The result of this command is (<strong>edit:</strong> I posted the wrong output the first time, so here is the good one):</p>\n<div class=\"codehilite\"><pre><span></span><code>Default host: x86_64-unknown-linux-gnu\nrustup home:  /home/bouanto/.rustup\n\ninstalled toolchains\n--------------------\n\nstable-x86_64-unknown-linux-gnu\nnightly-2021-05-18-x86_64-unknown-linux-gnu\nnightly-2021-06-08-x86_64-unknown-linux-gnu\nnightly-2021-06-14-x86_64-unknown-linux-gnu\nnightly-2021-06-17-x86_64-unknown-linux-gnu\nnightly-2021-06-30-x86_64-unknown-linux-gnu\nnightly-2021-07-21-x86_64-unknown-linux-gnu\nnightly-2021-08-12-x86_64-unknown-linux-gnu\nnightly-x86_64-unknown-linux-gnu (default)\ndebug-current\n\nactive toolchain\n----------------\n\ndebug-current (overridden by &#39;/home/bouanto/Ordinateur/Programmation/Rust/Projets/rustc_codegen_gccjit/rust-toolchain&#39;)\n(rustc does not exist)\n</code></pre></div>",
        "id": 250402915,
        "sender_full_name": "antoyo",
        "timestamp": 1629748503
    },
    {
        "content": "<p>I tried with <code>channel = \"dev\"</code> and I get the same problem.</p>",
        "id": 250406062,
        "sender_full_name": "antoyo",
        "timestamp": 1629750052
    },
    {
        "content": "<blockquote>\n<p>(rustc does not exist)</p>\n</blockquote>\n<p>Which path did you link the debug-current toolchain to?</p>",
        "id": 250470967,
        "sender_full_name": "bjorn3",
        "timestamp": 1629804506
    },
    {
        "content": "<p>I created the link with <code>rustup toolchain link debug-current build/x86_64-unknown-linux-gnu/stage1</code>.</p>",
        "id": 250535429,
        "sender_full_name": "antoyo",
        "timestamp": 1629833088
    },
    {
        "content": "<p>that should be fine.</p>",
        "id": 250535919,
        "sender_full_name": "bjorn3",
        "timestamp": 1629833336
    },
    {
        "content": "<p>can you look at which rustc_driver file is required by rustc and <a href=\"http://cg_gcc.so\">cg_gcc.so</a>?</p>",
        "id": 250536039,
        "sender_full_name": "bjorn3",
        "timestamp": 1629833396
    },
    {
        "content": "<p><code>readelf -d</code> shows NEEDED entries. one for each shared library dependency.</p>",
        "id": 250536319,
        "sender_full_name": "bjorn3",
        "timestamp": 1629833514
    },
    {
        "content": "<p>This command returns:</p>\n<div class=\"codehilite\"><pre><span></span><code>  Étiquettes Type                         Nom/Valeur\n 0x0000000000000001 (NEEDED)             Bibliothèque partagée: [librustc_driver-e5d2002997a86d0d.so]\n 0x0000000000000001 (NEEDED)             Bibliothèque partagée: [libstd-22d5f57fa309c135.so]\n 0x0000000000000001 (NEEDED)             Bibliothèque partagée: [libgccjit.so.0]\n 0x0000000000000001 (NEEDED)             Bibliothèque partagée: [libc.so.6]\n 0x0000000000000001 (NEEDED)             Bibliothèque partagée: [ld-linux-x86-64.so.2]\n 0x0000000000000001 (NEEDED)             Bibliothèque partagée: [libgcc_s.so.1]\n 0x000000000000000c (INIT)               0x391000\n 0x000000000000000d (FINI)               0x732f08\n 0x0000000000000019 (INIT_ARRAY)         0x822448\n 0x000000000000001b (INIT_ARRAYSZ)       8 (octets)\n 0x000000000000001a (FINI_ARRAY)         0x822450\n 0x000000000000001c (FINI_ARRAYSZ)       8 (octets)\n 0x0000000000000004 (HASH)               0x200\n 0x000000006ffffef5 (GNU_HASH)           0x26280\n 0x0000000000000005 (STRTAB)             0xd3578\n 0x0000000000000006 (SYMTAB)             0x4f548\n 0x000000000000000a (STRSZ)              2227061 (octets)\n 0x000000000000000b (SYMENT)             24 (octets)\n 0x0000000000000003 (PLTGOT)             0x82f568\n 0x0000000000000002 (PLTRELSZ)           72 (octets)\n 0x0000000000000014 (PLTREL)             RELA\n 0x0000000000000017 (JMPREL)             0x390340\n 0x0000000000000007 (RELA)               0x2fe258\n 0x0000000000000008 (RELASZ)             598248 (octets)\n 0x0000000000000009 (RELAENT)            24 (octets)\n 0x0000000000000018 (BIND_NOW)\n 0x000000006ffffffb (FLAGS_1)            Fanions: NOW\n 0x000000006ffffffe (VERNEED)            0x2fe0f8\n 0x000000006fffffff (VERNEEDNUM)         4\n 0x000000006ffffff0 (VERSYM)             0x2f30ee\n 0x000000006ffffff9 (RELACOUNT)          2368\n 0x0000000000000000 (NULL)               0x0\n</code></pre></div>\n<p>The hash changed because I compiled it with a different rustc when I changed the config, but this is the same hash I get in the error message.</p>",
        "id": 250609974,
        "sender_full_name": "antoyo",
        "timestamp": 1629892993
    },
    {
        "content": "<p>is this for rustc or cg_gcc?</p>",
        "id": 250610586,
        "sender_full_name": "bjorn3",
        "timestamp": 1629893307
    },
    {
        "content": "<p>i see it is for cg_gcc</p>",
        "id": 250610606,
        "sender_full_name": "bjorn3",
        "timestamp": 1629893325
    },
    {
        "content": "<p>what is it for rustc?</p>",
        "id": 250610613,
        "sender_full_name": "bjorn3",
        "timestamp": 1629893330
    },
    {
        "content": "<p>Yes, it is for <code>cg_gcc</code>.<br>\nFor rustc, it is:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ readelf -d (which ~/.rustup/toolchains/debug-current/bin/rustc)\n\nLa section dynamique à l&#39;offset 0x2dc8 contient 26 entrées :\n  Étiquettes Type                         Nom/Valeur\n 0x0000000000000001 (NEEDED)             Bibliothèque partagée: [librustc_driver-8f66983fa0148029.so]\n 0x0000000000000001 (NEEDED)             Bibliothèque partagée: [libstd-8e2976c77ad7560d.so]\n 0x0000000000000001 (NEEDED)             Bibliothèque partagée: [libc.so.6]\n 0x000000000000000f (RPATH)              Bibliothèque rpath: [$ORIGIN/../lib]\n 0x000000000000000c (INIT)               0x1000\n 0x000000000000000d (FINI)               0x1218\n 0x0000000000000019 (INIT_ARRAY)         0x3d88\n 0x000000000000001b (INIT_ARRAYSZ)       8 (octets)\n 0x000000000000001a (FINI_ARRAY)         0x3d90\n 0x000000000000001c (FINI_ARRAYSZ)       8 (octets)\n 0x000000006ffffef5 (GNU_HASH)           0x3a0\n 0x0000000000000005 (STRTAB)             0x498\n 0x0000000000000006 (SYMTAB)             0x3c0\n 0x000000000000000a (STRSZ)              357 (octets)\n 0x000000000000000b (SYMENT)             24 (octets)\n 0x0000000000000015 (DEBUG)              0x0\n 0x0000000000000007 (RELA)               0x630\n 0x0000000000000008 (RELASZ)             360 (octets)\n 0x0000000000000009 (RELAENT)            24 (octets)\n 0x0000000000000018 (BIND_NOW)\n 0x000000006ffffffb (FLAGS_1)            Fanions: NOW PIE\n 0x000000006ffffffe (VERNEED)            0x610\n 0x000000006fffffff (VERNEEDNUM)         1\n 0x000000006ffffff0 (VERSYM)             0x5fe\n 0x000000006ffffff9 (RELACOUNT)          7\n 0x0000000000000000 (NULL)               0x0\n</code></pre></div>\n<p>Seems like it has a different hash.</p>\n<p>I'm guessing this is the issue. What could make it link to a different librustc_driver?</p>",
        "id": 250611055,
        "sender_full_name": "antoyo",
        "timestamp": 1629893632
    },
    {
        "content": "<p>in build/x86_64-unknown-linux-gnu/stage1/lib/rustlib/x86_64-unknown-linux-gnu which hash does rustc_driver have?</p>",
        "id": 250611816,
        "sender_full_name": "bjorn3",
        "timestamp": 1629894145
    },
    {
        "content": "<p><code>librustc_driver-e5d2002997a86d0d.so</code></p>",
        "id": 250612226,
        "sender_full_name": "antoyo",
        "timestamp": 1629894376
    },
    {
        "content": "<p>Then that is the problem. I think you need to use a stage2 compiler to be able to compile things using rustc to be linked against the same rustc.</p>",
        "id": 250612700,
        "sender_full_name": "bjorn3",
        "timestamp": 1629894706
    }
]