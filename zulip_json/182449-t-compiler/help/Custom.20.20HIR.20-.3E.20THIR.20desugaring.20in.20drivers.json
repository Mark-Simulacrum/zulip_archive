[
    {
        "content": "<p>Is there any simple way to implement a custom desugaring within a rustc driver? In particular, I would like to change the desugaring of <code>for</code> expressions to include some additional (ghost) operations. I'm wondering if there's a query I could override or some other way for me to intercept the desugaring to add my transformation</p>",
        "id": 276936104,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1648504495
    },
    {
        "content": "<p>That's in AST lowering (&lt;<a href=\"https://github.com/rust-lang/rust/blob/ee915c34e2f33a07856a9e39be7e35e648bfbd5d/compiler/rustc_ast_lowering/src/expr.rs#L279-L283\">https://github.com/rust-lang/rust/blob/ee915c34e2f33a07856a9e39be7e35e648bfbd5d/compiler/rustc_ast_lowering/src/expr.rs#L279-L283</a>&gt;).  I don't know of any hooks for it, though I'm also a beginner in that part of the code.</p>",
        "id": 276940163,
        "sender_full_name": "scottmcm",
        "timestamp": 1648507888
    },
    {
        "content": "<p>Does overriding the thir_body query work?<br>\nEdit: right, for loop desugaring happens during ast-&gt;hir, not hir-&gt;thir.</p>",
        "id": 276940170,
        "sender_full_name": "bjorn3",
        "timestamp": 1648507897
    },
    {
        "content": "<p>there's no easy way to 'patch' / 'wrap' that is there?</p>",
        "id": 276940416,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1648508083
    },
    {
        "content": "<p>Nope, right now it's all one big operation. The best thing you can do right now is add a mir opt that looks for loop desugarings and insert your changes in the mir</p>",
        "id": 276969905,
        "sender_full_name": "oli",
        "timestamp": 1648540756
    }
]