[
    {
        "content": "<p>I havent contributed to libstd recently, but if I run <code>./x.py test library/std</code> (on <code>master</code> without changes — any stage I think), I get errors like the following on macOS:</p>\n<div class=\"codehilite\"><pre><span></span><code>malloc: can&#39;t allocate region\n:*** mach_vm_map(size=13835058055282167808, flags: 100) failed (error code=3)\nstd-d6a579ba8b5f87fe(88712,0x70000c738000) malloc: *** set a breakpoint in malloc_error_break to debug\n</code></pre></div>\n<p>This was pretty scary, since when I first saw it, I had added some unsafe code. But it happens on <code>master</code> too, and looking more closely... maybe it's just saying it failed to allocate an enormous region that we've requested? Not sure.</p>\n<p>Is there any way to do any of the following:</p>\n<ol>\n<li>fire up the test in question under LLDB. If i try to run the test executable, i get an rpath issue, so I guess there's some magic that x.py does to make this work.</li>\n<li>disable the test, whatever test it may be (no idea, nor how to figure that out without part 1).</li>\n<li>fix whatever the issue is in any other way?</li>\n</ol>\n<p>Note that this isn't related to the allocator the compiler uses — the jemalloc setting has no effect.</p>\n<hr>\n<p>Actually, looking again, I also get stuff like</p>\n<div class=\"codehilite\"><pre><span></span><code>..........thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;test panic in inner thread to poison RwLock&#39;, library/std/src/sync/rwlock/tests.rs:238:9\n...thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;test panic in inner thread to poison RwLock&#39;, library/std/src/sync/rwlock/tests.rs:214:9\n..thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;explicit panic&#39;, library/std/src/sync/rwlock/tests.rs:150:9\n.thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;explicit panic&#39;, library/std/src/sync/rwlock/tests.rs:78:9\n.thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;explicit panic&#39;, library/std/src/sync/rwlock/tests.rs:90:9\n.thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;explicit panic&#39;, library/std/src/sync/rwlock/tests.rs:52:9\n.thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;explicit panic&#39;, library/std/src/sync/rwlock/tests.rs:65:9\n</code></pre></div>\n<p>in the output as well. It seems that these aren't test failures...  Just noisy panics that happen as part of tests. Should something be getting redirected which is not? That might explain the malloc complaint too.</p>\n<p>Is there any way to make it only speak up about the errors, the way the libcore tests do? I <em>think</em> it didn't used to do this...</p>",
        "id": 248774824,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1628435087
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"209168\">@Thom Chiovoloni</span> One way to narrow down <em>which</em> test is printing the message is to run one at a time. With x.py, set <code>verbose-tests = true</code> in <code>config.toml</code>, and run it with RUST_TEST_THREADS=1 environment variable. It will print the test name just before it starts when it is single threaded. In this case, you can see it is <code>test_try_reserve</code> which attempts to allocate MAX_USIZE elements which will always fail. I think it would be possible to set one of the environment variables to hide that message (<code>MallocDebugReport</code> maybe?), but I don't think that is a good idea and probably not worth the hassle.</p>\n<p>libstd's tests use dynamic linking. I'm not entirely sure why the rpath isn't set, but you can make it work manually with <code>DYLD_LIBRARY_PATH=build/x86_64-apple-darwin/stage1/lib/rustlib/x86_64-apple-darwin/lib</code>.</p>",
        "id": 248777726,
        "sender_full_name": "Eric Huss",
        "timestamp": 1628439633
    },
    {
        "content": "<p>The rpath is only set when you explicitly use <code>-Crpath</code>.</p>",
        "id": 248778369,
        "sender_full_name": "bjorn3",
        "timestamp": 1628440700
    },
    {
        "content": "<p>some of the tests are intentionally triggering panics, leaks or huge allocations to test the unhappy path. so it might be intentional, but you'll have to look at the individual test to see if it really is</p>",
        "id": 248779981,
        "sender_full_name": "The 8472",
        "timestamp": 1628443258
    },
    {
        "content": "<p>The panics it just seems like they shouldn't be output (they aren't for the testrunner of normal rust code, after all). And for the malloc, im surprised im the only person hitting it is all. but i can think of ways to deal with it too, i guess</p>",
        "id": 248780640,
        "sender_full_name": "Thom Chiovoloni",
        "timestamp": 1628444459
    }
]