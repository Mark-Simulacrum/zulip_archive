[
    {
        "content": "<p>I have been tracking down an issue and I just don't know why a query would return <code>false</code> when it should return <code>true</code>.</p>\n<p>I was working on <code>const_trait_impl</code>, where I added a test that tests cross-crate behavior. I have added a test for when the feature is disabled, but when I added another case where the user of the auxiliary crate (of <code>impl const</code>) <em>has</em> the feature enabled, it errors:</p>\n<div class=\"codehilite\"><pre><span></span><code>error[E0015]: calls in constant functions are limited to constant functions, tuple structs and tuple variants\n  --&gt; src/test/ui/rfc-2632-const-trait-impl/cross-crate-feature-enabled.rs:16:5\n   |\n16 |     Const.func();\n   |     ^^^^^^^^^^^^\n</code></pre></div>\n<p>I added some debug output to test the logic, and here is the log from building the auxiliary crate:</p>\n<div class=\"codehilite\"><pre><span></span><code>&gt; RUSTC_LOG=&quot;rustc_mir::transform::check_consts,rustc_mir::const_eval&quot; build/x86_64-unknown-linux-gnu/stage1/bin/rustc --crate-type rlib src/test/ui/rfc-2632-const-trait-impl/auxiliary/cross-crate.rs\n\nDEBUG rustc_mir::const_eval::fn_queries is_const_fn_raw((...)kind: Fn(FnSig { header: FnHeader { unsafety: Normal, constness: NotConst, (...)\nDEBUG rustc_mir::const_eval::fn_queries is_const_impl_raw(def_id=DefId(0:7 ~ cross_crate[8787]::{impl#0}),(...) kind: Impl(Impl { unsafety: Normal, polarity: &quot;positive&quot;, defaultness: Final, defaultness_span: None, constness: NotConst(...)\nDEBUG rustc_mir::const_eval::fn_queries is_const_fn_raw((...)kind: Fn(FnSig { header: FnHeader { unsafety: Normal, constness: NotConst,(...)\nDEBUG rustc_mir::const_eval::fn_queries is_const_impl_raw(def_id=DefId(0:11 ~ cross_crate[8787]::{impl#1}),(...)kind: Impl(Impl { unsafety: Normal, polarity: &quot;positive&quot;, defaultness: Final, defaultness_span: None, constness: Const,(...)\n\n-snip-\n</code></pre></div>\n<p>Basically, the first impl  is not <code>const</code>, but the second is. Below is the log when compiling the test file:</p>\n<div class=\"codehilite\"><pre><span></span><code>&gt; RUSTC_LOG=&quot;rustc_mir::transform::check_consts,rustc_mir::const_eval&quot; build/x86_64-unknown-linux-gnu/stage1/bin/rustc --extern cross_crate=libcross_crate.rlib src/test/ui/rfc-2632-const-trait-impl/cross-crate-feature-enabled.rs\n\n├─0ms DEBUG rustc_mir::transform::check_consts::validation callee: DefId(19:8 ~ cross_crate[8787]::{impl#0}::func)\nerror[E0015]: calls in constant functions are limited to constant functions, tuple structs and tuple variants\n\n-snip-\n\n├─0ms DEBUG rustc_mir::transform::check_consts::validation callee: DefId(19:12 ~ cross_crate[8787]::{impl#1}::func)\nerror[E0015]: calls in constant functions are limited to constant functions, tuple structs and tuple variants\n\n-snip-\n</code></pre></div>\n<p>in this log, the <code>callee</code> variable will be checked with: (the only way that it would emit that error)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"n\">tcx</span><span class=\"p\">.</span><span class=\"n\">is_const_fn_raw</span><span class=\"p\">(</span><span class=\"n\">callee</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">check_op</span><span class=\"p\">(</span><span class=\"n\">ops</span>::<span class=\"n\">FnCallNonConst</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"k\">return</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>However, I get no logging output from <code>is_const_fn_raw</code> and on, so I think it must be using some cache on disk.<br>\nI am not familiar with the query system, so it would be great if someone can tell me if this has been reported before, or this is not related to the query (although I am 99% sure that nothing went wrong other than the query part)</p>",
        "id": 244431662,
        "sender_full_name": "fee1-dead",
        "timestamp": 1625063351
    },
    {
        "content": "<p>For an external crate, the query is implemented here: <a href=\"https://github.com/rust-lang/rust/blob/5d34076975cd7661dca4e40e0c66a646a78ad091/compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs#L127\">https://github.com/rust-lang/rust/blob/5d34076975cd7661dca4e40e0c66a646a78ad091/compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs#L127</a></p>",
        "id": 244438502,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1625065726
    },
    {
        "content": "<p>which calls this method: <a href=\"https://github.com/rust-lang/rust/blob/5d34076975cd7661dca4e40e0c66a646a78ad091/compiler/rustc_metadata/src/rmeta/decoder.rs#L1494\">https://github.com/rust-lang/rust/blob/5d34076975cd7661dca4e40e0c66a646a78ad091/compiler/rustc_metadata/src/rmeta/decoder.rs#L1494</a></p>",
        "id": 244438565,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1625065750
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125294\">Aaron Hill</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/query.20weird.20behavior/near/244438502\">said</a>:</p>\n<blockquote>\n<p>For an external crate, the query is implemented here: <a href=\"https://github.com/rust-lang/rust/blob/5d34076975cd7661dca4e40e0c66a646a78ad091/compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs#L127\">https://github.com/rust-lang/rust/blob/5d34076975cd7661dca4e40e0c66a646a78ad091/compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs#L127</a></p>\n</blockquote>\n<p>Thanks, I have found the issue to be how this is encoded.</p>",
        "id": 244442773,
        "sender_full_name": "fee1-dead",
        "timestamp": 1625067229
    }
]