[
    {
        "content": "<p>Imagine I had an enum:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">enum</span> <span class=\"nc\">E</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">A</span><span class=\"p\">(</span><span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"kt\">usize</span><span class=\"o\">&gt;</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">B</span><span class=\"p\">(</span><span class=\"nb\">String</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"n\">C</span><span class=\"p\">(</span><span class=\"kt\">usize</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Since it's not possible to know what variant is used statically. How does rust codegen know which <code>Drop::drop</code> instance to resolve when builds the drop call for this enum?</p>",
        "id": 273170173,
        "sender_full_name": "Jake Hughes",
        "timestamp": 1645749369
    },
    {
        "content": "<p>I believe the drop function for <code>E</code> checks the discriminant at runtime.</p>",
        "id": 273171622,
        "sender_full_name": "Eric Huss",
        "timestamp": 1645750665
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120518\">Eric Huss</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/how.20does.20rustc.20know.20which.20drop.20impl.20to.20call.20on.20an.20enum/near/273171622\">said</a>:</p>\n<blockquote>\n<p>I believe the drop function for <code>E</code> checks the discriminant at runtime.</p>\n</blockquote>\n<p>Thanks <span class=\"user-mention\" data-user-id=\"120518\">@Eric Huss</span> , any idea where this lives?</p>",
        "id": 273171770,
        "sender_full_name": "Jake Hughes",
        "timestamp": 1645750796
    },
    {
        "content": "<p>whereabouts in the rustc source I mean</p>",
        "id": 273171880,
        "sender_full_name": "Jake Hughes",
        "timestamp": 1645750826
    },
    {
        "content": "<p>I'm no expert, but I believe it lives somewhere in <a href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_dataflow/src/elaborate_drops.rs\"><code>elaborate_drops.rs</code></a>.</p>",
        "id": 273171918,
        "sender_full_name": "Eric Huss",
        "timestamp": 1645750862
    },
    {
        "content": "<p>If I had to guess, <code>adt_switch_block</code> is where the switch on the discriminant happens.</p>",
        "id": 273172219,
        "sender_full_name": "Eric Huss",
        "timestamp": 1645751094
    },
    {
        "content": "<p>I see yes. Not quite sure I understand whats happening in this elaborate_drops pass. I'll have to do some reading. Do you know if there are any docs about the internals of drop somewhere?</p>",
        "id": 273172462,
        "sender_full_name": "Jake Hughes",
        "timestamp": 1645751350
    },
    {
        "content": "<p><a href=\"https://rustc-dev-guide.rust-lang.org/mir/drop-elaboration.html\">https://rustc-dev-guide.rust-lang.org/mir/drop-elaboration.html</a> is the only thing that comes to mind.</p>",
        "id": 273172723,
        "sender_full_name": "Eric Huss",
        "timestamp": 1645751612
    },
    {
        "content": "<p>It is probably in <a href=\"https://github.com/rust-lang/rust/blob/ece55d416e65256e4da274988651c20e5d5cb4ea/compiler/rustc_mir_transform/src/shim.rs#L144\">https://github.com/rust-lang/rust/blob/ece55d416e65256e4da274988651c20e5d5cb4ea/compiler/rustc_mir_transform/src/shim.rs#L144</a></p>",
        "id": 273200273,
        "sender_full_name": "bjorn3",
        "timestamp": 1645777658
    }
]