[
    {
        "content": "<p>Hi! We've noticed a significant compile time regression when updating from rust 1.51 to 1.52. I've uploaded a minimal reproduction here: <a href=\"https://gist.github.com/GeorgeHahn/c427bc0a051956a31956f5da1070ef0a\">https://gist.github.com/GeorgeHahn/c427bc0a051956a31956f5da1070ef0a</a>. The target is <code>wasm32-unknown-unknown</code>. On version 1.51.0, this takes 3 minutes to build. On 1.52.1, it takes 30 minutes.</p>\n<p>My profiling so far points towards a handful of LLVM optimization passes. I'd like to investigate further and see this through to a bug report or a patch. I'm totally new to compiler work. Can anyone recommend a next step for investigating this?</p>",
        "id": 255141320,
        "sender_full_name": "George Hahn",
        "timestamp": 1632788273
    },
    {
        "content": "<p>Can you try nightly (1.57)?</p>",
        "id": 255142206,
        "sender_full_name": "Gary Guo",
        "timestamp": 1632788879
    },
    {
        "content": "<p>I tried on Friday's nightly and it also showed the regression. I can retest with the very latest if that would be helpful. Edit: running a build on 2021-09-26 nightly</p>",
        "id": 255142291,
        "sender_full_name": "George Hahn",
        "timestamp": 1632788925
    },
    {
        "content": "<p>It would be great to eliminate the external deps, but that's small enough that it would be reasonable to file an issue to track this.</p>",
        "id": 255143022,
        "sender_full_name": "simulacrum",
        "timestamp": 1632789429
    },
    {
        "content": "<p>It's probably something in the LLVM 12 upgrade.</p>",
        "id": 255143046,
        "sender_full_name": "simulacrum",
        "timestamp": 1632789457
    },
    {
        "content": "<p>I observed a handful of slow optimization passes on a serde generated function (<code>visit_map</code>). I'll see what I can do about expanding that and getting rid of the deps.</p>",
        "id": 255143550,
        "sender_full_name": "George Hahn",
        "timestamp": 1632789827
    },
    {
        "content": "<p>The nightly build for my minimal repro finished in 9 minutes. I don't recall seeing that much of an improvement on my work codebase. I'll give it another try just in case.</p>",
        "id": 255145844,
        "sender_full_name": "George Hahn",
        "timestamp": 1632791406
    },
    {
        "content": "<p>I seem to recall a major issue with the performance of derive on structures with a huge number of fields. cc <span class=\"user-mention\" data-user-id=\"224872\">@rylev</span> who might know more.</p>",
        "id": 255157735,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1632801490
    },
    {
        "content": "<p>The issue with derives is/was pre-codegen so that is probably not the issue here. I believe the llvm 12 upgrade did come with some perf loss in release builds but nothing of this magnitude. This will be interesting to look into.</p>",
        "id": 255199421,
        "sender_full_name": "rylev",
        "timestamp": 1632827859
    },
    {
        "content": "<p>omg 655 fields</p>",
        "id": 255214670,
        "sender_full_name": "pnkfelix",
        "timestamp": 1632835236
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/issues/68822\">Could this be related</a>?</p>",
        "id": 255229363,
        "sender_full_name": "Timothy Maloney",
        "timestamp": 1632840621
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"402099\">Timothy Maloney</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/1.2E52.20compile.20time.20regression/near/255229363\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://github.com/rust-lang/rust/issues/68822\">Could this be related</a>?</p>\n</blockquote>\n<p>That looks very similar to serde's generated deserialization code. The differences are that I only see this performance regression on wasm builds &amp; on LLVM 12 &amp; 13.</p>",
        "id": 255312394,
        "sender_full_name": "George Hahn",
        "timestamp": 1632868942
    }
]