[
    {
        "content": "<p>I just try to build a fairly simple program with the simple rustc wrapper (just calculate some callgraphs, all read-only operations for TyCtxt)</p>\n<p>and i have the following error (if remove the my custom analysis part, it works):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">warning</span>: <span class=\"nc\">Error</span><span class=\"w\"> </span><span class=\"n\">finalizing</span><span class=\"w\"> </span><span class=\"n\">incremental</span><span class=\"w\"> </span><span class=\"n\">compilation</span><span class=\"w\"> </span><span class=\"n\">session</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">xsh</span><span class=\"o\">/</span><span class=\"n\">code</span><span class=\"o\">/</span><span class=\"n\">myrustc</span><span class=\"o\">/</span><span class=\"n\">examples</span><span class=\"o\">/</span><span class=\"n\">rustsec20210053</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">incremental</span><span class=\"o\">/</span><span class=\"n\">rustsec20210053</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"n\">ab1nwbi37kht</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">-</span><span class=\"n\">g8ou2lzj4l</span><span class=\"o\">-</span><span class=\"mi\">11</span><span class=\"n\">dh7c</span><span class=\"o\">-</span><span class=\"n\">working</span><span class=\"err\">`</span>: <span class=\"nc\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">os</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"></span>\n\n<span class=\"n\">error</span>: <span class=\"nc\">internal</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"nc\">Encountered</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Unimplemented</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">selecting</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Binder</span><span class=\"p\">(</span><span class=\"o\">&lt;</span><span class=\"n\">U</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">convert</span>::<span class=\"nb\">From</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[])</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">during</span><span class=\"w\"> </span><span class=\"n\">codegen</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">delayed</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">rustc_trait_selection</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">traits</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">68</span>:<span class=\"mi\">32</span><span class=\"w\"></span>\n\n<span class=\"n\">error</span>: <span class=\"nc\">internal</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"nc\">Encountered</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Unimplemented</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">selecting</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Binder</span><span class=\"p\">(</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">cmp</span>::<span class=\"nb\">Ord</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[])</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">during</span><span class=\"w\"> </span><span class=\"n\">codegen</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">delayed</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">rustc_trait_selection</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">traits</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">68</span>:<span class=\"mi\">32</span><span class=\"w\"></span>\n\n<span class=\"n\">error</span>: <span class=\"nc\">internal</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"nc\">Encountered</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Unimplemented</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">selecting</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Binder</span><span class=\"p\">(</span><span class=\"o\">&lt;</span><span class=\"n\">F</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">convert</span>::<span class=\"nb\">From</span><span class=\"o\">&lt;</span><span class=\"n\">E</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[])</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">during</span><span class=\"w\"> </span><span class=\"n\">codegen</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">delayed</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">rustc_trait_selection</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">traits</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">68</span>:<span class=\"mi\">32</span><span class=\"w\"></span>\n\n<span class=\"n\">error</span>: <span class=\"nc\">internal</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"nc\">Encountered</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Unimplemented</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">selecting</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Binder</span><span class=\"p\">(</span><span class=\"o\">&lt;</span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">alloc</span>::<span class=\"n\">Allocator</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[])</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">during</span><span class=\"w\"> </span><span class=\"n\">codegen</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">delayed</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">rustc_trait_selection</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">traits</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">68</span>:<span class=\"mi\">32</span><span class=\"w\"></span>\n\n<span class=\"n\">error</span>: <span class=\"nc\">internal</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"w\"> </span><span class=\"n\">error</span>: <span class=\"nc\">Encountered</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Unimplemented</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">selecting</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Binder</span><span class=\"p\">(</span><span class=\"o\">&lt;</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">ops</span>::<span class=\"nb\">FnOnce</span><span class=\"o\">&lt;</span><span class=\"p\">(</span><span class=\"n\">E</span><span class=\"p\">,)</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">[])</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">during</span><span class=\"w\"> </span><span class=\"n\">codegen</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">delayed</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">rustc_trait_selection</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">traits</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">68</span>:<span class=\"mi\">32</span><span class=\"w\"></span>\n\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">rustc</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">no</span><span class=\"w\"> </span><span class=\"n\">errors</span><span class=\"w\"> </span><span class=\"n\">encountered</span><span class=\"w\"> </span><span class=\"n\">even</span><span class=\"w\"> </span><span class=\"n\">though</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">delay_span_bug</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">issued</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">rustc_errors</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">1167</span>:<span class=\"mi\">13</span><span class=\"w\"></span>\n<span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>:\n   <span class=\"mi\">0</span>:        <span class=\"mh\">0x1072588c1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">std</span>::<span class=\"n\">sys_common</span>::<span class=\"n\">backtrace</span>::<span class=\"n\">_print</span>::<span class=\"n\">DisplayBacktrace</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">fmt</span>::<span class=\"n\">Display</span><span class=\"o\">&gt;</span>::<span class=\"n\">fmt</span>::<span class=\"n\">hec762383110a7685</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">1</span>:        <span class=\"mh\">0x1072a97ab</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">fmt</span>::<span class=\"n\">write</span>::<span class=\"n\">h2d5ecb4b9764759c</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">2</span>:        <span class=\"mh\">0x107249eda</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">io</span>::<span class=\"n\">Write</span>::<span class=\"n\">write_fmt</span>::<span class=\"n\">h9d7d3ae333151289</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">3</span>:        <span class=\"mh\">0x10725ba25</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">panicking</span>::<span class=\"n\">default_hook</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>::<span class=\"n\">h552de0233eed7dab</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">4</span>:        <span class=\"mh\">0x10725b60f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">panicking</span>::<span class=\"n\">default_hook</span>::<span class=\"n\">hf4e8e1e5a5c43b90</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">5</span>:        <span class=\"mh\">0x10725c240</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">panicking</span>::<span class=\"n\">rust_panic_with_hook</span>::<span class=\"n\">h7c7e0153f3e14d6b</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">6</span>:        <span class=\"mh\">0x10725bcde</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">panicking</span>::<span class=\"n\">begin_panic_handler</span>::<span class=\"p\">{{</span><span class=\"n\">closure</span><span class=\"p\">}}</span>::<span class=\"n\">h3c7f7ffd2b05c635</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">7</span>:        <span class=\"mh\">0x107258d37</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">sys_common</span>::<span class=\"n\">backtrace</span>::<span class=\"n\">__rust_end_short_backtrace</span>::<span class=\"n\">h3bdf4f6c89eee6ea</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">8</span>:        <span class=\"mh\">0x10725bc4a</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">_rust_begin_unwind</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"mi\">9</span>:        <span class=\"mh\">0x1072d461f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">panicking</span>::<span class=\"n\">panic_fmt</span>::<span class=\"n\">h88a1b6fbb9084d2c</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">10</span>:        <span class=\"mh\">0x118a501a2</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">panicking</span>::<span class=\"n\">panic_display</span>::<span class=\"o\">&lt;&amp;</span><span class=\"kt\">str</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">11</span>:        <span class=\"mh\">0x118a57275</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">HandlerInner</span><span class=\"o\">&gt;</span>::<span class=\"n\">flush_delayed</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">12</span>:        <span class=\"mh\">0x118a535a8</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">HandlerInner</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">ops</span>::<span class=\"nb\">drop</span>::<span class=\"nb\">Drop</span><span class=\"o\">&gt;</span>::<span class=\"nb\">drop</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">13</span>:        <span class=\"mh\">0x11442775a</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">ptr</span>::<span class=\"n\">drop_in_place</span>::<span class=\"o\">&lt;</span><span class=\"n\">rustc_session</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"n\">d84db4fd929670d</span><span class=\"p\">]</span>::<span class=\"n\">parse</span>::<span class=\"n\">ParseSess</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">14</span>:        <span class=\"mh\">0x114431037</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">alloc</span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"n\">b2a4c4c8c58ee9a</span><span class=\"p\">]</span>::<span class=\"n\">rc</span>::<span class=\"n\">Rc</span><span class=\"o\">&lt;</span><span class=\"n\">rustc_session</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"n\">d84db4fd929670d</span><span class=\"p\">]</span>::<span class=\"n\">session</span>::<span class=\"n\">Session</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">ops</span>::<span class=\"nb\">drop</span>::<span class=\"nb\">Drop</span><span class=\"o\">&gt;</span>::<span class=\"nb\">drop</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">15</span>:        <span class=\"mh\">0x1143c6432</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">ptr</span>::<span class=\"n\">drop_in_place</span>::<span class=\"o\">&lt;</span><span class=\"n\">rustc_interface</span><span class=\"p\">[</span><span class=\"mi\">333</span><span class=\"n\">b44aaac6b850f</span><span class=\"p\">]</span>::<span class=\"n\">interface</span>::<span class=\"n\">Compiler</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">16</span>:        <span class=\"mh\">0x1143bfc2e</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">rustc_span</span><span class=\"p\">[</span><span class=\"mi\">5768</span><span class=\"n\">cebd3d858061</span><span class=\"p\">]</span>::<span class=\"n\">with_source_map</span>::<span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rustc_interface</span><span class=\"p\">[</span><span class=\"mi\">333</span><span class=\"n\">b44aaac6b850f</span><span class=\"p\">]</span>::<span class=\"n\">interface</span>::<span class=\"n\">create_compiler_and_run</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rustc_driver</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"n\">b55fea025b343ce</span><span class=\"p\">]</span>::<span class=\"n\">run_compiler</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">1</span><span class=\"p\">}</span><span class=\"o\">&gt;</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">17</span>:        <span class=\"mh\">0x1143fab5c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">scoped_tls</span><span class=\"p\">[</span><span class=\"mi\">504</span><span class=\"n\">a04b5a30bb02b</span><span class=\"p\">]</span>::<span class=\"n\">ScopedKey</span><span class=\"o\">&lt;</span><span class=\"n\">rustc_span</span><span class=\"p\">[</span><span class=\"mi\">5768</span><span class=\"n\">cebd3d858061</span><span class=\"p\">]</span>::<span class=\"n\">SessionGlobals</span><span class=\"o\">&gt;&gt;</span>::<span class=\"n\">set</span>::<span class=\"o\">&lt;</span><span class=\"n\">rustc_interface</span><span class=\"p\">[</span><span class=\"mi\">333</span><span class=\"n\">b44aaac6b850f</span><span class=\"p\">]</span>::<span class=\"n\">util</span>::<span class=\"n\">setup_callbacks_and_run_in_thread_pool_with_globals</span><span class=\"o\">&lt;</span><span class=\"n\">rustc_interface</span><span class=\"p\">[</span><span class=\"mi\">333</span><span class=\"n\">b44aaac6b850f</span><span class=\"p\">]</span>::<span class=\"n\">interface</span>::<span class=\"n\">run_compiler</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rustc_driver</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"n\">b55fea025b343ce</span><span class=\"p\">]</span>::<span class=\"n\">run_compiler</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">1</span><span class=\"p\">}</span><span class=\"o\">&gt;</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">0</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;&gt;</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">0</span><span class=\"p\">}</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">0</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">18</span>:        <span class=\"mh\">0x1143c6c32</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">[</span><span class=\"mi\">47</span><span class=\"n\">b77c5136b0281e</span><span class=\"p\">]</span>::<span class=\"n\">sys_common</span>::<span class=\"n\">backtrace</span>::<span class=\"n\">__rust_begin_short_backtrace</span>::<span class=\"o\">&lt;</span><span class=\"n\">rustc_interface</span><span class=\"p\">[</span><span class=\"mi\">333</span><span class=\"n\">b44aaac6b850f</span><span class=\"p\">]</span>::<span class=\"n\">util</span>::<span class=\"n\">setup_callbacks_and_run_in_thread_pool_with_globals</span><span class=\"o\">&lt;</span><span class=\"n\">rustc_interface</span><span class=\"p\">[</span><span class=\"mi\">333</span><span class=\"n\">b44aaac6b850f</span><span class=\"p\">]</span>::<span class=\"n\">interface</span>::<span class=\"n\">run_compiler</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rustc_driver</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"n\">b55fea025b343ce</span><span class=\"p\">]</span>::<span class=\"n\">run_compiler</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">1</span><span class=\"p\">}</span><span class=\"o\">&gt;</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">0</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;&gt;</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">0</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">19</span>:        <span class=\"mh\">0x11442ef45</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"n\">std</span><span class=\"p\">[</span><span class=\"mi\">47</span><span class=\"n\">b77c5136b0281e</span><span class=\"p\">]</span>::<span class=\"n\">thread</span>::<span class=\"n\">Builder</span><span class=\"o\">&gt;</span>::<span class=\"n\">spawn_unchecked</span><span class=\"o\">&lt;</span><span class=\"n\">rustc_interface</span><span class=\"p\">[</span><span class=\"mi\">333</span><span class=\"n\">b44aaac6b850f</span><span class=\"p\">]</span>::<span class=\"n\">util</span>::<span class=\"n\">setup_callbacks_and_run_in_thread_pool_with_globals</span><span class=\"o\">&lt;</span><span class=\"n\">rustc_interface</span><span class=\"p\">[</span><span class=\"mi\">333</span><span class=\"n\">b44aaac6b850f</span><span class=\"p\">]</span>::<span class=\"n\">interface</span>::<span class=\"n\">run_compiler</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rustc_driver</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"n\">b55fea025b343ce</span><span class=\"p\">]</span>::<span class=\"n\">run_compiler</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">1</span><span class=\"p\">}</span><span class=\"o\">&gt;</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">0</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;&gt;</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">0</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">result</span>::<span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">rustc_errors</span><span class=\"p\">[</span><span class=\"mi\">41</span><span class=\"n\">f29db6be5cacf9</span><span class=\"p\">]</span>::<span class=\"n\">ErrorReported</span><span class=\"o\">&gt;&gt;</span>::<span class=\"p\">{</span><span class=\"n\">closure</span>#<span class=\"mi\">1</span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">[</span><span class=\"n\">f4889159fda6615f</span><span class=\"p\">]</span>::<span class=\"n\">ops</span>::<span class=\"n\">function</span>::<span class=\"nb\">FnOnce</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;&gt;</span>::<span class=\"n\">call_once</span>::<span class=\"p\">{</span><span class=\"n\">shim</span>:<span class=\"nc\">vtable</span>#<span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">20</span>:        <span class=\"mh\">0x107266077</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">sys</span>::<span class=\"n\">unix</span>::<span class=\"n\">thread</span>::<span class=\"n\">Thread</span>::<span class=\"n\">new</span>::<span class=\"n\">thread_start</span>::<span class=\"n\">h46222cfa881cd2bf</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"mi\">21</span>:     <span class=\"mh\">0x7ff80d1c74e1</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">__pthread_start</span><span class=\"w\"></span>\n</code></pre></div>\n<p>could I ask any where it possibly go wrong?</p>",
        "id": 278384791,
        "sender_full_name": "Shihao Xia",
        "timestamp": 1649474663
    },
    {
        "content": "<p>The error seems like was triggered during deallocating a resource with rustc_session? am I accidentally moving something out of it?</p>",
        "id": 278384937,
        "sender_full_name": "Shihao Xia",
        "timestamp": 1649474917
    },
    {
        "content": "<p>this doesn't have to do with Drop -- these are delayed bugs, so they get stored and cause a panic later if no error is emitted.</p>",
        "id": 278384958,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649474996
    },
    {
        "content": "<p>Is your custom analysis calling anything that uses a ParamEnv?</p>",
        "id": 278385014,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649475016
    },
    {
        "content": "<p>this looks like calls to <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.codegen_fulfill_obligation\"><code>codegen_fulfill_obligation</code></a> with the wrong <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/struct.ParamEnv.html\"><code>ParamEnv</code></a>.</p>",
        "id": 278385043,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649475074
    },
    {
        "content": "<p>could you elaborate more about delayed bugs? is that a mechanism in the compiler?</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">resolve_callsite</span><span class=\"p\">(</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">caller_body</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">Body</span><span class=\"o\">&lt;'</span><span class=\"na\">tcx</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">bb</span>: <span class=\"nc\">BasicBlock</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">bb_data</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">BasicBlockData</span><span class=\"o\">&lt;'</span><span class=\"na\">tcx</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">CallSite</span><span class=\"o\">&lt;'</span><span class=\"na\">tcx</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"c1\">// Only consider direct calls to functions</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">terminator</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">bb_data</span><span class=\"p\">.</span><span class=\"n\">terminator</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">TerminatorKind</span>::<span class=\"n\">Call</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\"> </span><span class=\"n\">args</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\"> </span><span class=\"n\">destination</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">terminator</span><span class=\"p\">.</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">func_ty</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"p\">.</span><span class=\"n\">ty</span><span class=\"p\">(</span><span class=\"n\">caller_body</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">tcx</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">FnDef</span><span class=\"p\">(</span><span class=\"n\">def_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">substs</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">func_ty</span><span class=\"p\">.</span><span class=\"n\">kind</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"c1\">// To resolve an instance its substs have to be fully normalized.</span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">param_env</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">tcx</span><span class=\"p\">.</span><span class=\"n\">param_env_reveal_all_normalized</span><span class=\"p\">(</span><span class=\"n\">caller_body</span><span class=\"p\">.</span><span class=\"n\">source</span><span class=\"p\">.</span><span class=\"n\">def_id</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">substs</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">tcx</span><span class=\"p\">.</span><span class=\"n\">normalize_erasing_regions</span><span class=\"p\">(</span><span class=\"n\">param_env</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">substs</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">callee</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">Instance</span>::<span class=\"n\">resolve</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">tcx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">param_env</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">def_id</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">substs</span><span class=\"p\">).</span><span class=\"n\">ok</span><span class=\"p\">().</span><span class=\"n\">flatten</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">InstanceDef</span>::<span class=\"n\">Virtual</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">InstanceDef</span>::<span class=\"n\">Intrinsic</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">callee</span><span class=\"p\">.</span><span class=\"n\">def</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">None</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">fn_sig</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">tcx</span><span class=\"p\">.</span><span class=\"n\">fn_sig</span><span class=\"p\">(</span><span class=\"n\">def_id</span><span class=\"p\">).</span><span class=\"n\">subst</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">tcx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">substs</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">                </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">CallSite</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">callee</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">fn_sig</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">args</span>: <span class=\"nc\">args</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">()</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">});</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">        </span><span class=\"nb\">None</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 278385097,
        "sender_full_name": "Shihao Xia",
        "timestamp": 1649475146
    },
    {
        "content": "<p>This is my code to resolve a callsite (copied from inline analysis in compiler)<br>\nbut i did change this line<br>\n                let param_env = self.tcx.param_env_reveal_all_normalized(caller_body.source.def_id());</p>",
        "id": 278385120,
        "sender_full_name": "Shihao Xia",
        "timestamp": 1649475209
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"382085\">Shihao Xia</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/magic.20error.20when.20compile.20with.20.20rustc_driver.3A.3ARunCompiler/near/278385120\">said</a>:</p>\n<blockquote>\n<p>but i did change this line<br>\n                let param_env = self.tcx.param_env_reveal_all_normalized(caller_body.source.def_id());</p>\n</blockquote>\n<p>Are you sure that <code>caller_body</code> is the same body that <code>bb</code> (and <code>bb_data</code>) originates from?</p>",
        "id": 278385244,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649475405
    },
    {
        "content": "<p>delayed bugs: <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_errors/diagnostic_builder/struct.DiagnosticBuilder.html#method.delay_as_bug\">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_errors/diagnostic_builder/struct.DiagnosticBuilder.html#method.delay_as_bug</a></p>",
        "id": 278385252,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649475432
    },
    {
        "content": "<p>Yeah I think so, since I just simply use visitor pattern</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">visit_basic_block_data</span><span class=\"p\">(</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">block</span>: <span class=\"nc\">rustc_middle</span>::<span class=\"n\">mir</span>::<span class=\"n\">BasicBlock</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">data</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">rustc_middle</span>::<span class=\"n\">mir</span>::<span class=\"n\">BasicBlockData</span><span class=\"o\">&lt;'</span><span class=\"na\">tcx</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">is_cleanup</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">super_basic_block_data</span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">callsite</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">resolve_callsite</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">body</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">block</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"nb\">None</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">super_basic_block_data</span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">it</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">};</span><span class=\"w\"></span>\n\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">callsites</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">callsite</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">super_basic_block_data</span><span class=\"p\">(</span><span class=\"n\">block</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 278388367,
        "sender_full_name": "Shihao Xia",
        "timestamp": 1649480658
    },
    {
        "content": "<p>For the resolved callsite, I used</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tcx</span><span class=\"p\">.</span><span class=\"n\">optimized_mir</span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"n\">body_id</span><span class=\"p\">);</span><span class=\"w\"></span>\n</code></pre></div>\n<p>to get the body and passed to a new visitor</p>",
        "id": 278388409,
        "sender_full_name": "Shihao Xia",
        "timestamp": 1649480751
    }
]