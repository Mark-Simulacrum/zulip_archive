[
    {
        "content": "<p>Hello! I'm trying to run the test suite on Android. It looks like there's already support for running it on Android, but it was undocumented (I can send a patch to document it). The problem that I'm currently facing is that I need to use a newer version of the NDK than what you're currently using (src/ci/docker/host-x86_64/arm-android/Dockerfile seems to indicate it's r15?) I added support for newer NDK layouts to bootstrap (can send a patch for that as well) and I can run the tests but I'm hitting this error from one of them:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"nc\">ld</span>: <span class=\"nc\">error</span>: <span class=\"nc\">undefined</span><span class=\"w\"> </span><span class=\"n\">symbol</span>: <span class=\"nc\">__emutls_get_address</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">tls</span><span class=\"p\">.</span><span class=\"n\">dcec65ad</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"o\">/</span><span class=\"n\">mnt</span><span class=\"o\">/</span><span class=\"n\">disk2</span><span class=\"o\">/</span><span class=\"n\">pcc</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"o\">/</span><span class=\"n\">test</span><span class=\"o\">/</span><span class=\"n\">ui</span><span class=\"o\">/</span><span class=\"n\">thread</span><span class=\"o\">-</span><span class=\"n\">local</span><span class=\"o\">/</span><span class=\"n\">tls</span><span class=\"o\">/</span><span class=\"n\">a</span><span class=\"p\">.</span><span class=\"n\">tls</span><span class=\"p\">.</span><span class=\"n\">dcec65ad</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>:<span class=\"p\">(</span><span class=\"n\">core</span>::<span class=\"n\">ops</span>::<span class=\"n\">function</span>::<span class=\"nb\">FnOnce</span>::<span class=\"n\">call_once</span><span class=\"cp\">$u7b$$u7b$vtable</span><span class=\"p\">.</span><span class=\"n\">shim</span><span class=\"cp\">$u7d$$u7d$</span>::<span class=\"n\">heec1e80919c26d22</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">tls</span><span class=\"p\">.</span><span class=\"n\">dcec65ad</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\">               </span><span class=\"o\">/</span><span class=\"n\">mnt</span><span class=\"o\">/</span><span class=\"n\">disk2</span><span class=\"o\">/</span><span class=\"n\">pcc</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"o\">/</span><span class=\"n\">test</span><span class=\"o\">/</span><span class=\"n\">ui</span><span class=\"o\">/</span><span class=\"n\">thread</span><span class=\"o\">-</span><span class=\"n\">local</span><span class=\"o\">/</span><span class=\"n\">tls</span><span class=\"o\">/</span><span class=\"n\">a</span><span class=\"p\">.</span><span class=\"n\">tls</span><span class=\"p\">.</span><span class=\"n\">dcec65ad</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>:<span class=\"p\">(</span><span class=\"n\">tls</span>::<span class=\"n\">main</span>::<span class=\"n\">hf6e053e5f2aa14b0</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">           </span><span class=\"n\">clang</span><span class=\"o\">-</span><span class=\"mi\">12</span>: <span class=\"nc\">error</span>: <span class=\"nc\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n<p>I think it means that libcompiler_builtins.rlib needs to include emutls.o from compiler-rt. But I couldn't figure out where the list of source files used to build that library comes from. I tried grepping for some of the filenames that are already there but couldn't find anything. Anyone know?</p>",
        "id": 276137601,
        "sender_full_name": "Peter Collingbourne",
        "timestamp": 1647916916
    },
    {
        "content": "<p>Ah, found the list (I think), it's in <code>~/.cargo/registry/src/github.com-1ecc6299db9ec823/compiler_builtins-0.1.70/build.rs</code>. I guess my next question is: what's the recommended way to rebuild the compiler with modifications to that file? I'm guessing that file is managed by Cargo so I shouldn't just edit it directly?</p>",
        "id": 276140902,
        "sender_full_name": "Peter Collingbourne",
        "timestamp": 1647920942
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"487827\">@Peter Collingbourne</span> you could clone the git repository for compiler builtins, then add a <code>[patch]</code> section to the top level Cargo.toml that uses a path dependency instead of the published version</p>",
        "id": 276142972,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1647923792
    },
    {
        "content": "<p>(I'm on mobile so no links, but I think I used enough keywords the docs will pop up on Google)</p>",
        "id": 276143123,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1647924023
    },
    {
        "content": "<p>Thanks! I patched the <code>Cargo.toml</code> file like so:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">diff</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">git</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">/</span><span class=\"n\">Cargo</span><span class=\"p\">.</span><span class=\"n\">toml</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">/</span><span class=\"n\">Cargo</span><span class=\"p\">.</span><span class=\"n\">toml</span><span class=\"w\"></span>\n<span class=\"n\">index</span><span class=\"w\"> </span><span class=\"mf\">4e783996064</span><span class=\"o\">..</span><span class=\"mi\">95</span><span class=\"n\">d134af038</span><span class=\"w\"> </span><span class=\"mi\">100644</span><span class=\"w\"></span>\n<span class=\"o\">---</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"o\">/</span><span class=\"n\">Cargo</span><span class=\"p\">.</span><span class=\"n\">toml</span><span class=\"w\"></span>\n<span class=\"o\">+++</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"o\">/</span><span class=\"n\">Cargo</span><span class=\"p\">.</span><span class=\"n\">toml</span><span class=\"w\"></span>\n<span class=\"o\">@@</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mi\">132</span><span class=\"p\">,</span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mi\">132</span><span class=\"p\">,</span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"o\">@@</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"o\">-</span><span class=\"n\">std</span><span class=\"o\">-</span><span class=\"n\">workspace</span><span class=\"o\">-</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">library</span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">-</span><span class=\"n\">std</span><span class=\"o\">-</span><span class=\"n\">workspace</span><span class=\"o\">-</span><span class=\"n\">core</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"o\">-</span><span class=\"n\">std</span><span class=\"o\">-</span><span class=\"n\">workspace</span><span class=\"o\">-</span><span class=\"n\">alloc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">library</span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">-</span><span class=\"n\">std</span><span class=\"o\">-</span><span class=\"n\">workspace</span><span class=\"o\">-</span><span class=\"n\">alloc</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"o\">-</span><span class=\"n\">std</span><span class=\"o\">-</span><span class=\"n\">workspace</span><span class=\"o\">-</span><span class=\"n\">std</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">library</span><span class=\"o\">/</span><span class=\"n\">rustc</span><span class=\"o\">-</span><span class=\"n\">std</span><span class=\"o\">-</span><span class=\"n\">workspace</span><span class=\"o\">-</span><span class=\"n\">std</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"o\">+</span><span class=\"n\">compiler_builtins</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">compiler</span><span class=\"o\">-</span><span class=\"n\">builtins</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"o\">+</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">patch</span><span class=\"p\">.</span><span class=\"s\">\"https://github.com/rust-lang/rust-clippy\"</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"n\">clippy_lints</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">\"src/tools/clippy/clippy_lints\"</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and checked out tag 0.1.70 of compiler-builtins to the compiler-builtins subdirectory of my Rust source tree. But then I get the following error while building, even with an unmodified compiler-builtins repo.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">unexpected</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">cfg</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">condition</span><span class=\"w\"> </span><span class=\"n\">name</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">compiler</span><span class=\"o\">-</span><span class=\"n\">builtins</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">56</span>:<span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"mi\">56</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">kernel_user_helpers</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"o\">^^^^^^^^^^^^^^^^^^^</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"w\">   </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span>: <span class=\"err\">`</span><span class=\"o\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">unexpected</span><span class=\"o\">-</span><span class=\"n\">cfgs</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">implied</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">warnings</span><span class=\"err\">`</span><span class=\"w\"></span>\n</code></pre></div>\n<p>and then lots more of the same type of error complaining about <code>optimized-c</code> in <code>compiler-builtins/src/macros.rs</code>. Any idea what's up?</p>",
        "id": 276258914,
        "sender_full_name": "Peter Collingbourne",
        "timestamp": 1647985271
    },
    {
        "content": "<p>Try adding <code>deny-warnings = false</code> to your <code>config.toml</code>.</p>",
        "id": 276260797,
        "sender_full_name": "bjorn3",
        "timestamp": 1647986459
    },
    {
        "content": "<p>This is a lint warning caused by an option rust's build system uses to check if all cfg's are known. Dependencies from <a href=\"http://crates.io\">crates.io</a> nornally get all lints suppressed. Because you are now using a local build this doesn't happen anymore. Using <code>deny-warnings = false</code> lint warnings don't get promoted to hard errors.</p>",
        "id": 276261033,
        "sender_full_name": "bjorn3",
        "timestamp": 1647986604
    },
    {
        "content": "<p>Thanks! That got me past that error. Pushed my fix: <a href=\"https://github.com/rust-lang/compiler-builtins/pull/458\">https://github.com/rust-lang/compiler-builtins/pull/458</a> . Looks like some later test is failing because it's assuming that <code>gdbserver64</code> is installed to <code>$PATH</code>. That's certainly not true now (maybe it was true in the past? google.com/search?q=\"system/bin/gdbserver64\" seems to indicate so) -- I think the way that works now is that you're meant to push a <code>gdbserver</code> binary found in the NDK to the device. For now I'm skipping that test.</p>",
        "id": 276281294,
        "sender_full_name": "Peter Collingbourne",
        "timestamp": 1648002006
    }
]