[
    {
        "content": "<p>I'm having trouble bootstrapping <code>rustc</code> with our fork of llvm-12. Specifically, I don't seem to be able to compile <code>compiler/rustc_middle/src/lib.rs</code> beyond stage one, and even then, only occasionally. When compiling the call to rustc results in a segfault in a forked process, which I'm struggling to debug. </p>\n<p>I suspect that it could be related to <a href=\"https://github.com/rust-lang/rust/issues/76213\">this issue</a>, but from what I can tell this should have been resolved.</p>\n<p>Has anyone else had recent issues/segfaults with compiling rustc_middle? Alternatively, does anyone have any advice for debugging segfaults within the compiler.</p>",
        "id": 256445084,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633539276
    },
    {
        "content": "<p>(For completeness, omitted for brevity from the original post, this is the specific call that segfaults:)</p>\n<div class=\"codehilite\"><pre><span></span><code>export &quot;CARGO&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage0/bin/cargo&quot;\nexport &quot;CARGO_CRATE_NAME&quot;=&quot;rustc_privacy&quot;\nexport &quot;CARGO_INCREMENTAL&quot;=&quot;1&quot;\nexport &quot;CARGO_MAKEFLAGS&quot;=&quot;-j --jobserver-fds=6,7 --jobserver-auth=6,7&quot;\nexport &quot;CARGO_MANIFEST_DIR&quot;=&quot;/home/aharries/experimental/ruststuff/rust/compiler/rustc_privacy&quot;\nexport &quot;CARGO_PKG_AUTHORS&quot;=&quot;&quot;\nexport &quot;CARGO_PKG_DESCRIPTION&quot;=&quot;&quot;\nexport &quot;CARGO_PKG_HOMEPAGE&quot;=&quot;&quot;\nexport &quot;CARGO_PKG_LICENSE&quot;=&quot;&quot;\nexport &quot;CARGO_PKG_LICENSE_FILE&quot;=&quot;&quot;\nexport &quot;CARGO_PKG_NAME&quot;=&quot;rustc_privacy&quot;\nexport &quot;CARGO_PKG_REPOSITORY&quot;=&quot;&quot;\nexport &quot;CARGO_PKG_VERSION&quot;=&quot;0.0.0&quot;\nexport &quot;CARGO_PKG_VERSION_MAJOR&quot;=&quot;0&quot;\nexport &quot;CARGO_PKG_VERSION_MINOR&quot;=&quot;0&quot;\nexport &quot;CARGO_PKG_VERSION_PATCH&quot;=&quot;0&quot;\nexport &quot;CARGO_PKG_VERSION_PRE&quot;=&quot;&quot;\nexport &quot;CARGO_PROFILE_RELEASE_CODEGEN_UNITS&quot;=&quot;64&quot;\nexport &quot;CARGO_PROFILE_RELEASE_DEBUG&quot;=&quot;2&quot;\nexport &quot;CARGO_PROFILE_RELEASE_DEBUG_ASSERTIONS&quot;=&quot;false&quot;\nexport &quot;CARGO_PROFILE_RELEASE_OVERFLOW_CHECKS&quot;=&quot;false&quot;\nexport &quot;CARGO_TARGET_DIR&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc&quot;\nexport &quot;RUSTBUILD_NATIVE_DIR&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/native&quot;\nexport &quot;RUSTC&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/bootstrap/debug/rustc&quot;\nexport &quot;RUSTC_BACKTRACE_ON_ICE&quot;=&quot;1&quot;\nexport &quot;RUSTC_BOOTSTRAP&quot;=&quot;1&quot;\nexport &quot;RUSTC_BREAK_ON_ICE&quot;=&quot;1&quot;\nexport &quot;RUSTC_ERROR_METADATA_DST&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/tmp/extended-error-metadata&quot;\nexport &quot;RUSTC_FLAGS&quot;=&quot;-Z verbose -Z print-link-args --verbose&quot;\nexport &quot;RUSTC_FORCE_UNSTABLE&quot;=&quot;1&quot;\nexport &quot;RUSTC_INSTALL_BINDIR&quot;=&quot;bin&quot;\nexport &quot;RUSTC_LIBDIR&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1/lib&quot;\nexport &quot;RUSTC_LINT_FLAGS&quot;=&quot;-Wrust_2018_idioms -Wunused_lifetimes -Wsemicolon_in_expressions_from_macros -Dwarnings&quot;\nexport &quot;RUSTC_REAL&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1/bin/rustc&quot;\nexport &quot;RUSTC_SNAPSHOT&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1/bin/rustc&quot;\nexport &quot;RUSTC_SNAPSHOT_LIBDIR&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1/lib&quot;\nexport &quot;RUSTC_STAGE&quot;=&quot;1&quot;\nexport &quot;RUSTC_SYSROOT&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1&quot;\nexport &quot;RUSTC_VERBOSE&quot;=&quot;2&quot;\nexport &quot;RUSTDOC&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/bootstrap/debug/rustdoc&quot;\nexport &quot;RUSTDOCFLAGS&quot;=&quot;-Dwarnings -Wrustdoc::invalid_codeblock_attributes --crate-version 1.57.0-dev&quot;\nexport &quot;RUSTDOC_REAL&quot;=&quot;/path/to/nowhere/rustdoc/not/required&quot;\nexport &quot;RUSTFLAGS&quot;=&quot;-Zmacro-backtrace -Clink-args=-Wl,-rpath,$ORIGIN/../lib -Ztls-model=initial-exec -Zunstable-options -Wrustc::internal -Cprefer-dynamic -Cllvm-args=-import-instr-limit=10&quot;\nexport &quot;RUST_BACKTRACE&quot;=&quot;1&quot;\nexport &quot;RUST_TEST_THREADS&quot;=&quot;64&quot;\n&quot;LD_LIBRARY_PATH&quot;=&quot;/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1/lib:/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/release/deps:/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1/lib:/home/aharries/build/debug_12/lib:/home/aharries/build/debug_12/lib:/home/aharries/build/debug/lib&quot; /home/aharries/experimental/ruststuff/rust/build/bootstrap/debug/rustc --crate-name rustc_middle --edition=2021 compiler/rustc_middle/src/lib.rs --error-format=json --json=diagnostic-rendered-ansi,artifacts --crate-type lib --emit=dep-info,metadata,link -C opt-level=3 -C embed-bitcode=no -C codegen-units=64 -C debuginfo=2 -C metadata=b99dce85eb989066 -C extra-filename=-b99dce85eb989066 --out-dir /home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps --target x86_64-unknown-linux-gnu -C incremental=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/incremental -L dependency=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps -L dependency=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/release/deps --extern bitflags=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/libbitflags-0f3773a3f5b90c64.rmeta --extern chalk_ir=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/libchalk_ir-7783d73643f47f18.rmeta --extern either=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/libeither-99e2ab1bb156b6ba.rmeta --extern gsgdt=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/libgsgdt-8355fffa4a081bf2.rmeta --extern polonius_engine=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/libpolonius_engine-fae4b2de37a11f81.rmeta --extern rand=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librand-3708cd28e57d95c8.rmeta --extern rand_xoshiro=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librand_xoshiro-5f71a64a7637a84e.rmeta --extern rustc_rayon_core=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_rayon_core-1f6fd644b6d97594.rmeta --extern rustc_apfloat=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_apfloat-2694fadcb1b4be96.rmeta --extern rustc_arena=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_arena-71375bb83424a5a8.rmeta --extern rustc_ast=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_ast-8890e530964348f0.rmeta --extern rustc_attr=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_attr-da4013ae0a8cea42.rmeta --extern rustc_data_structures=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_data_structures-59246a5bde150731.rmeta --extern rustc_errors=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_errors-39b76caf44ca3b87.rmeta --extern rustc_feature=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_feature-7e16de1b984853f3.rmeta --extern rustc_graphviz=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_graphviz-b1ffa88b6b331288.rmeta --extern rustc_hir=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_hir-cd5af0f45181c564.rmeta --extern rustc_index=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_index-6476934182307b8b.rmeta --extern rustc_macros=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/release/deps/librustc_macros-159a13cc33ed8aa9.so --extern rustc_query_system=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_query_system-30c587bbcdc5484d.rmeta --extern rustc_serialize=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_serialize-33fd2cc1c39b60e6.rmeta --extern rustc_session=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_session-f128d2f0b4c6f4da.rmeta --extern rustc_span=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_span-d55b14e87aba1bfb.rmeta --extern rustc_target=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_target-7fe980015de2148c.rmeta --extern rustc_type_ir=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_type_ir-ecabf1b0495fafd7.rmeta --extern smallvec=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/libsmallvec-5bf8b261d82b8aa9.rmeta --extern tracing=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/deps/libtracing-4c7f56b921420bc8.rmeta -Zmacro-backtrace &#39;-Clink-args=-Wl,-rpath,$ORIGIN/../lib&#39; -Ztls-model=initial-exec -Zunstable-options &#39;-Wrustc::internal&#39; -Cprefer-dynamic -Cllvm-args=-import-instr-limit=10 -Z binary-dep-depinfo -L native=/home/aharries/experimental/ruststuff/rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/build/psm-5eae59431edf5431/out\n</code></pre></div>",
        "id": 256445243,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633539354
    },
    {
        "content": "<p>Small update: It looks like it's segfaulting in <code>llvm::value::getValueID</code>, after quite a few levels of recursion.</p>",
        "id": 256449719,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633541079
    },
    {
        "content": "<p>Specifically, <code>this=0x0</code> during the call, which is surprising.</p>",
        "id": 256449765,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633541097
    },
    {
        "content": "<p>Hmm, okay, I think this is a totally different issue to the one linked earlier. I've managed to track down the thread that segfaults, and the backtrace looks like this: </p>\n<div class=\"codehilite\"><pre><span></span><code>(gdb) bt 30\n#0  0x00007ffff7fde618 in check_match (undef_name=undef_name@entry=0x7fffedf4cd2a &quot;strlen&quot;, ref=ref@entry=0x7fffedf4b7e8, version=version@entry=0x7fffedf40b50, flags=flags@entry=5, type_class=type_class@entry=1, sym=sym@entry=0x7fffee4e8c40, symidx=817, strtab=0x7fffee4f1ca0 &quot;&quot;, map=0x7ffff7fcede0, versioned_sym=0x7fffed52b0c8, num_versions=0x7fffed52b0c4) at dl-lookup.c:94\n#1  0x00007ffff7fdeaf4 in do_lookup_x (undef_name=undef_name@entry=0x7fffedf4cd2a &quot;strlen&quot;, new_hash=new_hash@entry=479443869, old_hash=old_hash@entry=0x7fffed52b180, ref=0x7fffedf4b7e8, result=result@entry=0x7fffed52b190, scope=&lt;optimized out&gt;, i=&lt;optimized out&gt;, version=0x7fffedf40b50, flags=5, skip=0x0, type_class=1, undef_map=0x7fffee4b9410) at dl-lookup.c:407\n#2  0x00007ffff7fdf38f in _dl_lookup_symbol_x (undef_name=0x7fffedf4cd2a &quot;strlen&quot;, undef_map=0x7fffee4b9410, ref=ref@entry=0x7fffed52b228, symbol_scope=0x7fffee4b9770, version=0x7fffedf40b50, type_class=type_class@entry=1, flags=5, skip_map=&lt;optimized out&gt;) at dl-lookup.c:814\n#3  0x00007ffff7fe3b00 in _dl_fixup (l=&lt;optimized out&gt;, reloc_arg=&lt;optimized out&gt;) at ../elf/dl-runtime.c:112\n#4  0x00007ffff7fea57a in _dl_runtime_resolve_xsavec () at ../sysdeps/x86_64/dl-trampoline.h:126\n#5  0x00007fffedf5cdf5 in ?? () from /lib/x86_64-linux-gnu/libgcc_s.so.1\n#6  0x00007fffedf5d4f3 in ?? () from /lib/x86_64-linux-gnu/libgcc_s.so.1\n#7  0x00007fffee613bb7 in __GI___dl_iterate_phdr (callback=0x7fffedf5d0b0, data=0x7fffed52bdf0) at dl-iteratephdr.c:75\n#8  0x00007fffedf5e361 in _Unwind_Find_FDE () from /lib/x86_64-linux-gnu/libgcc_s.so.1\n#9  0x00007fffedf5aa43 in ?? () from /lib/x86_64-linux-gnu/libgcc_s.so.1\n#10 0x00007fffedf5bc20 in ?? () from /lib/x86_64-linux-gnu/libgcc_s.so.1\n#11 0x00007fffedf5c928 in _Unwind_Backtrace () from /lib/x86_64-linux-gnu/libgcc_s.so.1\n#12 0x00007fffee5e72a2 in __GI___backtrace (array=&lt;optimized out&gt;, size=&lt;optimized out&gt;) at backtrace.c:111\n#13 0x00007fffef205763 in rustc_driver::signal_handler::print_stack_trace () at compiler/rustc_driver/src/lib.rs:1311\n#14 &lt;signal handler called&gt;\n#15 0x00007fffef60714e in llvm::Value::getValueID (this=0x0) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/IR/Value.h:528\n#16 0x00007fffef6071b5 in llvm::isa_impl&lt;llvm::Instruction, llvm::Value, void&gt;::doit (Val=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/IR/Value.h:965\n#17 0x00007fffef60bdb5 in llvm::isa_impl_cl&lt;llvm::Instruction, llvm::Value const*&gt;::doit (Val=0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:105\n#18 0x00007fffef60af45 in llvm::isa_impl_wrap&lt;llvm::Instruction, llvm::Value const*, llvm::Value const*&gt;::doit (Val=@0x7fffd5936088: 0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:131\n#19 0x00007fffef609e48 in llvm::isa_impl_wrap&lt;llvm::Instruction, llvm::Value const* const, llvm::Value const*&gt;::doit (Val=@0x7fffd59360c8: 0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:122\n#20 0x00007fffef608913 in llvm::isa&lt;llvm::Instruction, llvm::Value const*&gt; (Val=@0x7fffd59360c8: 0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:143\n#21 0x00007ffff0518a5b in llvm::OverflowingBinaryOperator::classof (V=0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/IR/Operator.h:113\n#22 0x00007ffff1829585 in llvm::isa_impl&lt;llvm::OverflowingBinaryOperator, llvm::Operator, void&gt;::doit (Val=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:58\n#23 0x00007ffff182697f in llvm::isa_impl_cl&lt;llvm::OverflowingBinaryOperator, llvm::Operator const*&gt;::doit (Val=0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:105\n#24 0x00007ffff1820a8a in llvm::isa_impl_wrap&lt;llvm::OverflowingBinaryOperator, llvm::Operator const*, llvm::Operator const*&gt;::doit (Val=@0x7fffd5936158: 0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:131\n#25 0x00007ffff18158e9 in llvm::isa_impl_wrap&lt;llvm::OverflowingBinaryOperator, llvm::Operator* const, llvm::Operator const*&gt;::doit (Val=@0x7fffd5936198: 0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:122\n#26 0x00007ffff18095f7 in llvm::isa&lt;llvm::OverflowingBinaryOperator, llvm::Operator*&gt; (Val=@0x7fffd5936198: 0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:143\n#27 0x00007ffff17fe244 in llvm::dyn_cast&lt;llvm::OverflowingBinaryOperator, llvm::Operator&gt; (Val=0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/include/llvm/Support/Casting.h:345\n#28 0x00007ffff17c2efe in (anonymous namespace)::BinaryOp::BinaryOp (this=0x7fffd5936200, Op=0x7fff4cd66700) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:4554\n#29 0x00007ffff17c3082 in MatchBinaryOp (V=0x7fff4cd66700, DT=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:4590\n(More stack frames follow...)\n</code></pre></div>",
        "id": 256451569,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633541795
    },
    {
        "content": "<p>And the last 50 frames: </p>\n<div class=\"codehilite\"><pre><span></span><code>#4209 0x00007ffff17c5ac2 in llvm::ScalarEvolution::createNodeForPHI (this=0x7fff4d4ce640, PN=0x7fff4dc71378) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:5397\n#4210 0x00007ffff17cd455 in llvm::ScalarEvolution::createSCEV (this=0x7fff4d4ce640, V=0x7fff4dc71378) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:6736\n#4211 0x00007ffff17c08fd in llvm::ScalarEvolution::getSCEV (this=0x7fff4d4ce640, V=0x7fff4dc71378) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:3873\n#4212 0x00007ffff17cb511 in llvm::ScalarEvolution::createSCEV (this=0x7fff4d4ce640, V=0x7fff4dc723e0) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:6411\n#4213 0x00007ffff17c08fd in llvm::ScalarEvolution::getSCEV (this=0x7fff4d4ce640, V=0x7fff4dc723e0) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:3873\n#4214 0x00007ffff17c59dc in llvm::ScalarEvolution::createNodeFromSelectLikePHI (this=0x7fff4d4ce640, PN=0x7fff4dc738f8) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:5385\n#4215 0x00007ffff17c5ac2 in llvm::ScalarEvolution::createNodeForPHI (this=0x7fff4d4ce640, PN=0x7fff4dc738f8) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:5397\n#4216 0x00007ffff17cd455 in llvm::ScalarEvolution::createSCEV (this=0x7fff4d4ce640, V=0x7fff4dc738f8) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:6736\n#4217 0x00007ffff17c08fd in llvm::ScalarEvolution::getSCEV (this=0x7fff4d4ce640, V=0x7fff4dc738f8) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:3873\n#4218 0x00007ffff17cb511 in llvm::ScalarEvolution::createSCEV (this=0x7fff4d4ce640, V=0x7fff4dc74e60) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:6411\n#4219 0x00007ffff17c08fd in llvm::ScalarEvolution::getSCEV (this=0x7fff4d4ce640, V=0x7fff4dc74e60) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:3873\n#4220 0x00007ffff17c59dc in llvm::ScalarEvolution::createNodeFromSelectLikePHI (this=0x7fff4d4ce640, PN=0x7fff4dc763e8) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:5385\n#4221 0x00007ffff17c5ac2 in llvm::ScalarEvolution::createNodeForPHI (this=0x7fff4d4ce640, PN=0x7fff4dc763e8) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:5397\n#4222 0x00007ffff17cd455 in llvm::ScalarEvolution::createSCEV (this=0x7fff4d4ce640, V=0x7fff4dc763e8) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:6736\n#4223 0x00007ffff17c08fd in llvm::ScalarEvolution::getSCEV (this=0x7fff4d4ce640, V=0x7fff4dc763e8) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:3873\n#4224 0x00007ffff17c664b in llvm::ScalarEvolution::createNodeForGEP (this=0x7fff4d4ce640, GEP=0x7fff4dc78100) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:5520\n#4225 0x00007ffff17cd429 in llvm::ScalarEvolution::createSCEV (this=0x7fff4d4ce640, V=0x7fff4dc78100) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:6733\n#4226 0x00007ffff17c08fd in llvm::ScalarEvolution::getSCEV (this=0x7fff4d4ce640, V=0x7fff4dc78100) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/ScalarEvolution.cpp:3873\n#4227 0x00007ffff16b967d in llvm::isConsecutiveAccess (A=0x7fff4dc78650, B=0x7fff4dc786e0, DL=..., SE=..., CheckType=true) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Analysis/LoopAccessAnalysis.cpp:1256\n#4228 0x00007ffff00a1e0f in llvm::SLPVectorizerPass::&lt;lambda(int, int)&gt;::operator()(int, int) const (__closure=0x7fffd5b32990, K=0, Idx=1) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp:6032\n#4229 0x00007ffff00a1fde in llvm::SLPVectorizerPass::vectorizeStores (this=0x7fff4e41fd80, Stores=..., R=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp:6049\n#4230 0x00007ffff00a9603 in llvm::SLPVectorizerPass::vectorizeStoreChains (this=0x7fff4e41fd80, R=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp:7702\n#4231 0x00007ffff00a14a9 in llvm::SLPVectorizerPass::runImpl (this=0x7fff4e41fd80, F=..., SE_=0x7fff4d4ce640, TTI_=0x7fff4df7f540, TLI_=0x7fff4df672b8, AA_=0x7fff4d8dfa70, LI_=0x7fff4e27edc0, DT_=0x7fff4c0952e0, AC_=0x7fff4d8fa6a0, DB_=0x7fff4d262690, ORE_=0x7fff4e36f410) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp:5940\n#4232 0x00007ffff00a0de5 in (anonymous namespace)::SLPVectorizer::runOnFunction (this=0x7fff4e41fd60, F=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/Transforms/Vectorize/SLPVectorizer.cpp:5846\n#4233 0x00007ffff1f5ae67 in llvm::FPPassManager::runOnFunction (this=0x7fff4d4f0d60, F=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/IR/LegacyPassManager.cpp:1435\n#4234 0x00007ffff1f5b0bc in llvm::FPPassManager::runOnModule (this=0x7fff4d4f0d60, M=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/IR/LegacyPassManager.cpp:1481\n#4235 0x00007ffff1f5b4a4 in (anonymous namespace)::MPPassManager::runOnModule (this=0x7fff4e5eba10, M=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/IR/LegacyPassManager.cpp:1550\n#4236 0x00007ffff1f56c7f in llvm::legacy::PassManagerImpl::run (this=0x7fff4e712270, M=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/IR/LegacyPassManager.cpp:541\n#4237 0x00007ffff1f5bc7f in llvm::legacy::PassManager::run (this=0x7fff4cb04da0, M=...) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/IR/LegacyPassManager.cpp:1677\n#4238 0x00007ffff1e490fc in LLVMRunPassManager (PM=0x7fff4cb04da0, M=0x7fff4c0066c0) at /home/aharries/src/dpu_tools/llvm-project/llvm/lib/IR/Core.cpp:4139\n#4239 0x00007fffef512b9b in rustc_codegen_llvm::back::lto::run_pass_manager (cgcx=0x7fffd5b34508, diag_handler=0x7fffd5b33e88, module=&lt;optimized out&gt;, config=0x7fffa91889b0, thin=&lt;optimized out&gt;) at compiler/rustc_codegen_llvm/src/back/lto.rs:648\n#4240 0x00007fffef513817 in rustc_codegen_llvm::back::lto::optimize_thin_module (thin_module=&lt;optimized out&gt;, cgcx=0x7fffd5b34508) at compiler/rustc_codegen_llvm/src/back/lto.rs:875\n#4241 0x00007fffef4ad604 in &lt;rustc_codegen_llvm::LlvmCodegenBackend as rustc_codegen_ssa::traits::write::WriteBackendMethods&gt;::optimize_thin (cgcx=0x7fffd5b34508, thin=0x1) at compiler/rustc_codegen_llvm/src/lib.rs:169\n#4242 rustc_codegen_ssa::back::lto::LtoModuleCodegen&lt;B&gt;::optimize (self=0x7fff4cd66700, cgcx=0x7fffd5b34508) at /home/aharries/experimental/ruststuff/rust/compiler/rustc_codegen_ssa/src/back/lto.rs:79\n#4243 0x00007fffef48e538 in rustc_codegen_ssa::back::write::execute_lto_work_item (cgcx=0x7fffd5b34508, module=..., module_config=0x7fffa91889b0) at /home/aharries/experimental/ruststuff/rust/compiler/rustc_codegen_ssa/src/back/write.rs:889\n#4244 rustc_codegen_ssa::back::write::execute_work_item (cgcx=0x7fffd5b34508, work_item=...) at /home/aharries/experimental/ruststuff/rust/compiler/rustc_codegen_ssa/src/back/write.rs:742\n#4245 0x00007fffef53ca31 in rustc_codegen_ssa::back::write::spawn_work::{{closure}} () at /home/aharries/experimental/ruststuff/rust/compiler/rustc_codegen_ssa/src/back/write.rs:1663\n#4246 std::sys_common::backtrace::__rust_begin_short_backtrace (f=...) at /home/aharries/experimental/ruststuff/rust/library/std/src/sys_common/backtrace.rs:125\n#4247 0x00007fffef47b79d in std::thread::Builder::spawn_unchecked::{{closure}}::{{closure}} () at /home/aharries/experimental/ruststuff/rust/library/std/src/thread/mod.rs:483\n#4248 &lt;core::panic::unwind_safe::AssertUnwindSafe&lt;F&gt; as core::ops::function::FnOnce&lt;()&gt;&gt;::call_once (self=..., _args=&lt;optimized out&gt;) at /home/aharries/experimental/ruststuff/rust/library/core/src/panic/unwind_safe.rs:271\n#4249 std::panicking::try::do_call (data=&lt;optimized out&gt;) at /home/aharries/experimental/ruststuff/rust/library/std/src/panicking.rs:403\n#4250 std::panicking::try (f=...) at /home/aharries/experimental/ruststuff/rust/library/std/src/panicking.rs:367\n#4251 0x00007fffef4ee23f in std::panic::catch_unwind (f=...) at /home/aharries/experimental/ruststuff/rust/library/std/src/panic.rs:133\n#4252 std::thread::Builder::spawn_unchecked::{{closure}} () at /home/aharries/experimental/ruststuff/rust/library/std/src/thread/mod.rs:482\n#4253 core::ops::function::FnOnce::call_once{{vtable-shim}} () at /home/aharries/experimental/ruststuff/rust/library/core/src/ops/function.rs:227\n#4254 0x00007fffee7773b8 in &lt;alloc::boxed::Box&lt;F,A&gt; as core::ops::function::FnOnce&lt;Args&gt;&gt;::call_once (self=..., args=&lt;optimized out&gt;) at /home/aharries/experimental/ruststuff/rust/library/alloc/src/boxed.rs:1638\n#4255 &lt;alloc::boxed::Box&lt;F,A&gt; as core::ops::function::FnOnce&lt;Args&gt;&gt;::call_once (self=0x7fff90a9e970, args=&lt;optimized out&gt;) at /home/aharries/experimental/ruststuff/rust/library/alloc/src/boxed.rs:1638\n#4256 0x00007fffee765b3a in std::sys::unix::thread::Thread::new::thread_start (main=0x7fff90a9e970) at library/std/src/sys/unix/thread.rs:106\n#4257 0x00007fffee4c1fa3 in start_thread (arg=&lt;optimized out&gt;) at pthread_create.c:486\n#4258 0x00007fffee5d94cf in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:95\n</code></pre></div>",
        "id": 256451703,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633541860
    },
    {
        "content": "<p>I would recommend building LLVM with debug assertions enabled (if you're not already doing so)</p>",
        "id": 256452199,
        "sender_full_name": "Aaron Hill",
        "timestamp": 1633542031
    },
    {
        "content": "<p>I <em>thought</em> I had, but it looks like that might not be the case.</p>",
        "id": 256452661,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542199
    },
    {
        "content": "<p><code>CMakeCache.txt:LLVM_BUILD_TYPE:UNINITIALIZED=Debug</code><br>\nSo it is in debug mode.</p>",
        "id": 256453509,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542521
    },
    {
        "content": "<p>Which makes it more surprising, as none of the assertions triggered.</p>",
        "id": 256453536,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542531
    },
    {
        "content": "<p>Which stage is this asserting on?</p>",
        "id": 256453575,
        "sender_full_name": "simulacrum",
        "timestamp": 1633542542
    },
    {
        "content": "<p>This is stage 1.</p>",
        "id": 256453607,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542553
    },
    {
        "content": "<p>so the second compiler compile?</p>",
        "id": 256453631,
        "sender_full_name": "simulacrum",
        "timestamp": 1633542561
    },
    {
        "content": "<p>I'm not entirely sure - I'm still not sure what each stage refers to.</p>",
        "id": 256453681,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542579
    },
    {
        "content": "<p>do you have stage1/bin/rustc?</p>",
        "id": 256453725,
        "sender_full_name": "simulacrum",
        "timestamp": 1633542595
    },
    {
        "content": "<p>I can sometimes produce a stage 1 <code>rustc</code>, but I haven't been able to compile a stage 2 <code>rustc</code> yet.</p>",
        "id": 256453732,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542600
    },
    {
        "content": "<p>(Right now, I have none of them, as I have changed around the ar, ranlib, and ldd that the build is using so that it is all llvm, and all consistent)</p>",
        "id": 256453853,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542638
    },
    {
        "content": "<p>(also, a debug LLVM will take forever, I imagine...)</p>",
        "id": 256453879,
        "sender_full_name": "simulacrum",
        "timestamp": 1633542644
    },
    {
        "content": "<p>Yep</p>",
        "id": 256453899,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542653
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Segfault.20when.20compiling.20rustc_middle/near/256453725\">said</a>:</p>\n<blockquote>\n<p>do you have stage1/bin/rustc?</p>\n</blockquote>\n<p>I have managed to produce this now.</p>",
        "id": 256454712,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542944
    },
    {
        "content": "<p>The standard library is currently being compiled.</p>",
        "id": 256454757,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542960
    },
    {
        "content": "<p>hm ok</p>",
        "id": 256454764,
        "sender_full_name": "simulacrum",
        "timestamp": 1633542961
    },
    {
        "content": "<p>so sounds like it should use the debug-llvm then</p>",
        "id": 256454826,
        "sender_full_name": "simulacrum",
        "timestamp": 1633542970
    },
    {
        "content": "<p>not sure how to further debug</p>",
        "id": 256454838,
        "sender_full_name": "simulacrum",
        "timestamp": 1633542975
    },
    {
        "content": "<p>Is there a substantial difference between how stage1 and stage2 are built?</p>",
        "id": 256454875,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633542988
    },
    {
        "content": "<p>stage1 is built with the (probably) downloaded beta compiler, which has its own llvm</p>",
        "id": 256455012,
        "sender_full_name": "simulacrum",
        "timestamp": 1633543038
    },
    {
        "content": "<p>stage 2 is built with the stage 1 compiler</p>",
        "id": 256455045,
        "sender_full_name": "simulacrum",
        "timestamp": 1633543049
    },
    {
        "content": "<p>Ah, okay! That makes sense. That means that any errors with how I'm linking/building the stage 1 compiler will only show up when trying to build the stage 2 compiler.</p>",
        "id": 256455067,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633543057
    },
    {
        "content": "<p>I can confirm that the issue happens when buiding stage2. I realise now that I misunderstood some of the output, specifically that the build components/artefacts for stage 2 are stored in <code>rust/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/build</code>, which made me think they were for stage 1!</p>",
        "id": 256457058,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633543698
    },
    {
        "content": "<p>FWIW it would not terribly surprise me if a debug llvm build just uncovers stuff like this, since afaik no one tests that build scenario all that much (unlike release with assertions, which is tested in CI)</p>",
        "id": 256457374,
        "sender_full_name": "simulacrum",
        "timestamp": 1633543831
    },
    {
        "content": "<p>Do you mean that this kind of thing might <em>only</em> occur in a debug build, or it's something that we should see failing in a release build as well, but don't because of assertions etc?</p>",
        "id": 256457516,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633543884
    },
    {
        "content": "<p>More like \"optimizer deletes code\" than assertions, but yeah, that this behavior may be limited to debug builds. Have you successfully built with a release LLVM?</p>",
        "id": 256457675,
        "sender_full_name": "simulacrum",
        "timestamp": 1633543936
    },
    {
        "content": "<p>I haven't tried - but I will now <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span></p>",
        "id": 256457711,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633543950
    },
    {
        "content": "<p>(I have no real basis for such an assertion beyond just knowing it's not tested)</p>",
        "id": 256457724,
        "sender_full_name": "simulacrum",
        "timestamp": 1633543954
    },
    {
        "content": "<p>First I need a release build...</p>",
        "id": 256457736,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633543958
    },
    {
        "content": "<p>Ah, actually, I can just build with system llvm</p>",
        "id": 256457792,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633543975
    },
    {
        "content": "<p>You can try enabling download-ci-llvm = true in your config.toml, which will download a CI-built llvm</p>",
        "id": 256457813,
        "sender_full_name": "simulacrum",
        "timestamp": 1633543979
    },
    {
        "content": "<p>(to confirm that it's not the system.)</p>",
        "id": 256457823,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633543984
    },
    {
        "content": "<p>(As an aside, I've just managed to compile a release build of LLVM in the time it took to bootstrap to step 1...)</p>",
        "id": 256460820,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633545031
    },
    {
        "content": "<p>Okay, I can compile successfully with the CI llvm, so I will try now with my release llvm.</p>",
        "id": 256461433,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633545236
    },
    {
        "content": "<p>And I can now compile with my release llvm!</p>",
        "id": 256464051,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633546154
    },
    {
        "content": "<p>Okay, I can confirm that moving to a release compilation of LLVM (including my branch) \"fixes\" the bug. I'm not sure if this is something I should report, or otherwise notify the compiler team of. I suspect that it's going to be nasty to fix.</p>",
        "id": 256465478,
        "sender_full_name": "Adam Brouwers-Harries",
        "timestamp": 1633546671
    }
]