[
    {
        "content": "<p>I recently found a codegen bug related to codegen of function arguments of ptx kernels (unstable abi). I have located the bug and have a local fix of the bug. </p>\n<p>I'm now working on writing tests of the output format and was looking at test/codegen/riscv-abi.rs and test/codegen/avr-func-addrspace.rs in particular. I found the // CHECK stuff and have managed to create a test. </p>\n<p>The problem is that the test uses a .ll file as input. To me, it seems like it would better to use the .ptx file as input. Are there any ways to do this? Or is it unnecessary?</p>",
        "id": 274369602,
        "sender_full_name": "Kjetil Kjeka",
        "timestamp": 1646647080
    },
    {
        "content": "<p>That would be an assembly test, not an llvm ir test. Llvm ir tests are in codegen/. Assembly tests in assembly/.</p>",
        "id": 274377952,
        "sender_full_name": "bjorn3",
        "timestamp": 1646652236
    },
    {
        "content": "<p>There are already several nvptx tests in assembly/</p>",
        "id": 274378042,
        "sender_full_name": "bjorn3",
        "timestamp": 1646652268
    },
    {
        "content": "<p>Is it better to use \"only-nvptx64\" or \"--target=nvptx64-nvidia-cuda\" for tests that are only relevant for nvptx? I assume \"only-nvptx64\" since it may give better ability to filter out the tests if irrelevant?</p>",
        "id": 274379846,
        "sender_full_name": "Kjetil Kjeka",
        "timestamp": 1646653408
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133247\">@bjorn3</span> it seems like these tests are marked with both \"//only-nvptx64\" and \"//ignore-nvptx64\". Doesn't that mean that these tests always will be ignored?</p>",
        "id": 274380183,
        "sender_full_name": "Kjetil Kjeka",
        "timestamp": 1646653599
    },
    {
        "content": "<p>It should be only-nvptx. --target=nvptx64-nvidia-cuda wouldn't work if libcore isn't compiled for nvptx which is almost always the case.</p>",
        "id": 274380349,
        "sender_full_name": "bjorn3",
        "timestamp": 1646653709
    },
    {
        "content": "<p>I think combining only-nvptx64 and ignore-nvptx64 will indeed ignore the tests.</p>",
        "id": 274380380,
        "sender_full_name": "bjorn3",
        "timestamp": 1646653744
    },
    {
        "content": "<p>We don't have any ci builder to check them anyway afaik.</p>",
        "id": 274380405,
        "sender_full_name": "bjorn3",
        "timestamp": 1646653768
    },
    {
        "content": "<p>Thanks a lot for the help. I've been able to fix the layout and create tests for the nvptx64-nvidia-cuda target. Just a question about the 32bit stuff.</p>\n<p>It seems to me that the 32 bit target \"nvptx-nvidia-cuda\" is not listed in \"Platform support\". There's not a specification for the target shipped together with the rust compiler either, meaning \"--target  nvptx-nvidia-cuda\" will not work.</p>\n<p>Would it be beneficial to do some housekeeping and removing the layout stuff for the 32bit target while I'm at it? Or should it be done separately in case there are someone using custom targets that will actually use parts of this code?</p>",
        "id": 274382607,
        "sender_full_name": "Kjetil Kjeka",
        "timestamp": 1646655185
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"276242\">@Riccardo D'Ambrosio</span> do you know the answer to that question?</p>",
        "id": 274383001,
        "sender_full_name": "bjorn3",
        "timestamp": 1646655430
    },
    {
        "content": "<p>32 bit cuda is basically unused AFAIK</p>",
        "id": 274383633,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1646655864
    },
    {
        "content": "<p>its kinda useless nowadays and rust-cuda doesnt support it either</p>",
        "id": 274383651,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1646655879
    },
    {
        "content": "<p>it complicates codegen in a lot of areas and especially when it comes to launching kernels cause AFAIK you cannot use cuda on 32-bit arches, at least not modern cuda</p>",
        "id": 274383704,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1646655922
    },
    {
        "content": "<p>So i would be in agreement in removing the target entirely from everywhere, but idk how other people feel about that</p>",
        "id": 274383809,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1646655998
    },
    {
        "content": "<p>Also yes ptx-kernel is super broken, it should be passing everything as a value</p>",
        "id": 274383855,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1646656044
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"276242\">Riccardo D'Ambrosio</span> <a href=\"#narrow/stream/182449-t-compiler.2Fhelp/topic/Testing.20codegen.20fn.20args/near/274383809\">said</a>:</p>\n<blockquote>\n<p>So i would be in agreement in removing the target entirely from everywhere, but idk how other people feel about that</p>\n</blockquote>\n<p>It may need an MCP just like adding a target. Not sure though.</p>",
        "id": 274384101,
        "sender_full_name": "bjorn3",
        "timestamp": 1646656179
    },
    {
        "content": "<p>yeah</p>",
        "id": 274384293,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1646656282
    },
    {
        "content": "<p>32-bit cuda doesnt even support unified memory, its a thing of the past that doesnt really have uses nowadays</p>",
        "id": 274384548,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1646656494
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133247\">@bjorn3</span> This is a bugfix in an unstable feature that seems to be broken to the degree that nobody should have been able to sensibly use it as it currently stand. I don't really find the suitable approach in the rustc-dev-guild. Should I simply open a PR or are there anything I should do in addition (tracking issue, etc) to get it into the correct process?</p>",
        "id": 274395822,
        "sender_full_name": "Kjetil Kjeka",
        "timestamp": 1646662050
    },
    {
        "content": "<p>I think the removal of the 32bit cuda arch needs an MCP. Fixing the 64bit version can be a direct PR.</p>",
        "id": 274398411,
        "sender_full_name": "bjorn3",
        "timestamp": 1646663271
    }
]