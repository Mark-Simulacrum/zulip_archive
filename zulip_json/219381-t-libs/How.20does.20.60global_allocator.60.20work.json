[
    {
        "content": "<p>Calls to <code>alloc::alloc::alloc</code> or <code>Global::alloc</code> end up <a href=\"https://github.com/rust-lang/rust/blob/58899c4d9c63a6d27ac395ee9597ae797df7f026/library/alloc/src/alloc.rs#L30\">here</a>. How those are magic symbols implemented? I looked for them (and related ones mentioned in comments like <code>__rg_alloc</code> and <code>__rdl_alloc</code>) but I haven't found much.</p>",
        "id": 265522100,
        "sender_full_name": "nnethercote",
        "timestamp": 1639977506
    },
    {
        "content": "<p>The comment says \"The rustc fork of LLVM also special-cases these function names\". Is that correct -- is there such a fork?</p>",
        "id": 265522188,
        "sender_full_name": "nnethercote",
        "timestamp": 1639977614
    },
    {
        "content": "<p>Hmm, <a href=\"https://github.com/rust-lang/rust/blob/5ab0f37087b61b2ea51f364498cddc20ecff74fa/compiler/rustc_ast/src/expand/allocator.rs#L12-L13\">this</a> is relevant</p>",
        "id": 265522396,
        "sender_full_name": "nnethercote",
        "timestamp": 1639977920
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/blob/5ab0f37087b61b2ea51f364498cddc20ecff74fa/compiler/rustc_codegen_llvm/src/allocator.rs#L57\">This</a> too.</p>",
        "id": 265522861,
        "sender_full_name": "nnethercote",
        "timestamp": 1639978594
    },
    {
        "content": "<p>Now I see why grepping didn't work, because format strings are being used to create the names like <code>__rg_alloc</code></p>",
        "id": 265522870,
        "sender_full_name": "nnethercote",
        "timestamp": 1639978620
    },
    {
        "content": "<p>Ok, I think I can see the outlines of how this works now.</p>",
        "id": 265523464,
        "sender_full_name": "nnethercote",
        "timestamp": 1639979454
    },
    {
        "content": "<p>I want to add this line:</p>\n<div class=\"codehilite\"><pre><span></span><code>    tikv_jemalloc_sys::malloc_usable_size(memory.as_ptr());\n</code></pre></div>\n<p>to <a href=\"https://github.com/rust-lang/rust/blob/207c80f105282245d93024c95ac408c622f70114/library/alloc/src/raw_vec.rs#L447-L472\">RawVec::finish_grow</a>, but I'm having trouble getting it to build</p>",
        "id": 265524338,
        "sender_full_name": "nnethercote",
        "timestamp": 1639980429
    },
    {
        "content": "<p>With this diff:</p>",
        "id": 265524347,
        "sender_full_name": "nnethercote",
        "timestamp": 1639980455
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>diff --git a/library/alloc/Cargo.toml b/library/alloc/Cargo.toml\nindex b3ff0fd0a31..fad1d5e12f1 100644\n--- a/library/alloc/Cargo.toml\n+++ b/library/alloc/Cargo.toml\n@@ -11,6 +11,7 @@ edition = &quot;2018&quot;\n [dependencies]\n core = { path = &quot;../core&quot; }\n compiler_builtins = { version = &quot;0.1.40&quot;, features = [&#39;rustc-dep-of-std&#39;] }\n+tikv-jemalloc-sys = &quot;0.4.0&quot;\n\n [dev-dependencies]\n rand = &quot;0.7&quot;\ndiff --git a/library/alloc/src/raw_vec.rs b/library/alloc/src/raw_vec.rs\nindex 3d38e73305a..6aee2a5450a 100644\n--- a/library/alloc/src/raw_vec.rs\n+++ b/library/alloc/src/raw_vec.rs\n@@ -468,6 +468,8 @@ fn finish_grow&lt;A&gt;(\n         alloc.allocate(new_layout)\n     };\n\n+    tikv_jemalloc_sys::malloc_usable_size(memory.as_ptr());\n+\n     memory.map_err(|_| AllocError { layout: new_layout, non_exhaustive: () }.into())\n }\n</code></pre></div>",
        "id": 265524351,
        "sender_full_name": "nnethercote",
        "timestamp": 1639980459
    },
    {
        "content": "<p>I get this compile error:</p>\n<div class=\"codehilite\"><pre><span></span><code>Building stage0 std artifacts (x86_64-unknown-linux-gnu -&gt; x86_64-unknown-linux-gnu)\n   Compiling core v0.0.0 (/home/njn/dev/rust3/library/core)\n   Compiling rustc-std-workspace-core v1.99.0 (/home/njn/dev/rust3/library/rustc-std-workspace-core)\n   Compiling compiler_builtins v0.1.66\n   Compiling libc v0.2.108\n   Compiling cfg-if v0.1.10\n   Compiling memchr v2.4.1\n   Compiling adler v0.2.3\n   Compiling rustc-demangle v0.1.21\n   Compiling tikv-jemalloc-sys v0.4.1+5.2.1-patched\nerror[E0463]: can&#39;t find crate for `core`\n</code></pre></div>",
        "id": 265524357,
        "sender_full_name": "nnethercote",
        "timestamp": 1639980479
    },
    {
        "content": "<p>You did have to add rustc-dep-of-std support to tikv-jemalloc-sys and then enable this feature when specifying the dependency. See for example <a href=\"https://github.com/gimli-rs/object/blob/e45a3d12d75b3eed99e7183d3035803bfdd15b0d/Cargo.toml#L93\">https://github.com/gimli-rs/object/blob/e45a3d12d75b3eed99e7183d3035803bfdd15b0d/Cargo.toml#L93</a></p>",
        "id": 265534806,
        "sender_full_name": "bjorn3",
        "timestamp": 1639989756
    },
    {
        "content": "<p>Thanks for the info! Right now I can't even get <code>tikv-jemallocator</code> and <code>tikv-jemalloc-sys</code> to work in a tiny test crate. Well, if I use the versions from <code>crates.io</code> it's ok, but if I try to use a local copy of the crates I get problems with the <code>build.rs</code>, it's failing to get the jemalloc source code somehow</p>",
        "id": 265618729,
        "sender_full_name": "nnethercote",
        "timestamp": 1640036363
    },
    {
        "content": "<p>Even doing <code>cargo build</code> in a local clone of <code>tikv-jemallocator</code> fails in the same way, hmm</p>",
        "id": 265618989,
        "sender_full_name": "nnethercote",
        "timestamp": 1640036572
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120989\">@nnethercote</span> Have you initialized the git submodule?</p>",
        "id": 265619022,
        "sender_full_name": "Eric Huss",
        "timestamp": 1640036618
    },
    {
        "content": "<p>nope</p>",
        "id": 265619026,
        "sender_full_name": "nnethercote",
        "timestamp": 1640036628
    },
    {
        "content": "<p>How/where do I do that? I haven't seen anything in the docs about it</p>",
        "id": 265619090,
        "sender_full_name": "nnethercote",
        "timestamp": 1640036669
    },
    {
        "content": "<p><code>git submodule init</code></p>",
        "id": 265619102,
        "sender_full_name": "Eric Huss",
        "timestamp": 1640036684
    },
    {
        "content": "<p>submodules can be a pain</p>",
        "id": 265619112,
        "sender_full_name": "Eric Huss",
        "timestamp": 1640036691
    },
    {
        "content": "<p>or <code>git submodule update --init</code> is probably better</p>",
        "id": 265619172,
        "sender_full_name": "Eric Huss",
        "timestamp": 1640036733
    },
    {
        "content": "<p>Aha, the latter does it, thank you!</p>",
        "id": 265619241,
        "sender_full_name": "nnethercote",
        "timestamp": 1640036779
    },
    {
        "content": "<p>Curious, I've never come across that particular incantation before</p>",
        "id": 265619259,
        "sender_full_name": "nnethercote",
        "timestamp": 1640036802
    },
    {
        "content": "<p>Seems surprising that the <a href=\"http://build.rs\">build.rs</a> doesn't do that for me, or something</p>",
        "id": 265619318,
        "sender_full_name": "nnethercote",
        "timestamp": 1640036860
    },
    {
        "content": "<p>The suggestion from @bjorn3 has got me pretty far, but now I'm getting a link error at the end of compiler compilation:</p>",
        "id": 265620984,
        "sender_full_name": "nnethercote",
        "timestamp": 1640037920
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>ld.lld: error: /home/njn/dev/rust3/build/x86_64-unknown-linux-gnu/stage0-rustc/x86_64-unknown-linux-gnu/release/deps/librustc_driver-e375244a403fe1f2.so: undefined reference to _rjem_malloc_usable_size [--no-allow-shlib-undefined]\n</code></pre></div>",
        "id": 265621011,
        "sender_full_name": "nnethercote",
        "timestamp": 1640037942
    },
    {
        "content": "<p>/me fiddles with <code>compiler/rustc/src/main.rs</code></p>",
        "id": 265621328,
        "sender_full_name": "nnethercote",
        "timestamp": 1640038116
    },
    {
        "content": "<p>Hmm, I can call <code>tikv_jemalloc_sys::malloc_usable_size</code> successfully in <code>compiler/rustc/src/main.rs</code>, but I get a link error if I put the same call into <code>library/alloc/src/raw_vec.rs</code></p>",
        "id": 265623621,
        "sender_full_name": "nnethercote",
        "timestamp": 1640039484
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120989\">nnethercote</span> <a href=\"#narrow/stream/219381-t-libs/topic/How.20does.20.60global_allocator.60.20work/near/265619318\">said</a>:</p>\n<blockquote>\n<p>Seems surprising that the <a href=\"http://build.rs\">build.rs</a> doesn't do that for me, or something</p>\n</blockquote>\n<p>I'm honestly thrilled when <code>build.rs</code> files <em>don't</em> do weird poking at git or submodules.</p>",
        "id": 265624267,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1640039970
    },
    {
        "content": "<p>Well, in this case it just means that <code>cargo build</code> fails unless you do <code>git submodule update --init</code> first, and this isn't documented. Doesn't seem good?</p>",
        "id": 265625003,
        "sender_full_name": "nnethercote",
        "timestamp": 1640040496
    },
    {
        "content": "<p>\"and this isn't documented\" is definitely not good.</p>",
        "id": 265627571,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1640042279
    },
    {
        "content": "<p><code>cargo build</code> failing rather than touching the network seems very good. :)</p>",
        "id": 265627617,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1640042290
    },
    {
        "content": "<p>I do, FWIW, think it's perfectly reasonable for <code>build.rs</code> to <em>check</em> if an expected file in the submodule exists and print a useful error message if not.</p>",
        "id": 265627648,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1640042325
    },
    {
        "content": "<p>We could also make that declarative, with something in <code>Cargo.toml</code> saying \"if this file doesn't exist, assume the crate has a problem and can't build\".</p>",
        "id": 265627671,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1640042350
    }
]