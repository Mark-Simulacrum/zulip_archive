[
    {
        "content": "<p>I was debugging an ICE in <a href=\"https://github.com/rust-lang/rust/issues/92637\">#92637</a>, and I found that the ICE was due to some special-case autoderef logic hard-coded for arrays in rustc_typeck. The original solution I thought up to fix the ICE works (the second half of <a href=\"https://github.com/rust-lang/rust/issues/92640\">#92640</a>), but I found that it's actually a much simpler fix if I just impl <code>Deref</code> for <code>[T; N]</code> in the standard library. </p>\n<p>Is there a reason why we currently don't have that impl right now?</p>",
        "id": 267211653,
        "sender_full_name": "Michael Goulet",
        "timestamp": 1641573980
    },
    {
        "content": "<p>not that i know, assume that this is a leftover from pre const generics times</p>",
        "id": 267211986,
        "sender_full_name": "lcnr",
        "timestamp": 1641574146
    },
    {
        "content": "<p>I tried to implement it just for fun, to see if it would fix the issue, and the only roadblock I hit was that there were some regressions in const evaluation, since the <code>Deref</code> impl is not const. Maybe we can just fix that/make <code>&lt;[T; N] as Deref&gt;::deref</code> const? e.g. <code>[1, 2, 3].len()</code> fails with the change applied.</p>",
        "id": 267212038,
        "sender_full_name": "Michael Goulet",
        "timestamp": 1641574174
    },
    {
        "content": "<p>ah</p>",
        "id": 267212067,
        "sender_full_name": "lcnr",
        "timestamp": 1641574190
    },
    {
        "content": "<p>that should be fixed during mir building afaik</p>",
        "id": 267212232,
        "sender_full_name": "lcnr",
        "timestamp": 1641574242
    },
    {
        "content": "<p>at the same place where we change <code>1 + 2</code> from a call to <code>Add::add</code> to builtin addition</p>",
        "id": 267212276,
        "sender_full_name": "lcnr",
        "timestamp": 1641574270
    },
    {
        "content": "<p>can check where that would be, either when constructing the thir or the mir, not sure</p>",
        "id": 267212339,
        "sender_full_name": "lcnr",
        "timestamp": 1641574315
    },
    {
        "content": "<p>in that case, I'd be interested in implementing the change <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span></p>",
        "id": 267212420,
        "sender_full_name": "Michael Goulet",
        "timestamp": 1641574343
    },
    {
        "content": "<p>probably somewhere here? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> <a href=\"https://github.com/rust-lang/rust/blob/e012a191d768adeda1ee36a99ef8b92d51920154/compiler/rustc_mir_build/src/thir/cx/expr.rs#L331-L339\">https://github.com/rust-lang/rust/blob/e012a191d768adeda1ee36a99ef8b92d51920154/compiler/rustc_mir_build/src/thir/cx/expr.rs#L331-L339</a></p>",
        "id": 267212680,
        "sender_full_name": "lcnr",
        "timestamp": 1641574480
    },
    {
        "content": "<p>or here <a href=\"https://github.com/rust-lang/rust/blob/e012a191d768adeda1ee36a99ef8b92d51920154/compiler/rustc_mir_build/src/thir/cx/expr.rs#L122-L146\">https://github.com/rust-lang/rust/blob/e012a191d768adeda1ee36a99ef8b92d51920154/compiler/rustc_mir_build/src/thir/cx/expr.rs#L122-L146</a></p>",
        "id": 267212880,
        "sender_full_name": "lcnr",
        "timestamp": 1641574564
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"426609\">Michael Goulet</span> <a href=\"#narrow/stream/219381-t-libs/topic/implementing.20Deref.2FDerefMut.20for.20.5BT.3B.20N.5D/near/267212420\">said</a>:</p>\n<blockquote>\n<p>in that case, I'd be interested in implementing the change <span aria-label=\"eyes\" class=\"emoji emoji-1f440\" role=\"img\" title=\"eyes\">:eyes:</span></p>\n</blockquote>\n<p>if you're stuck somewhere while implementing this, don't hesitate to ask (if you do it on zulip please ping me though)</p>",
        "id": 267212972,
        "sender_full_name": "lcnr",
        "timestamp": 1641574609
    },
    {
        "content": "<p>yup, I was just looking at the adjustment code in MIR.</p>",
        "id": 267212994,
        "sender_full_name": "Michael Goulet",
        "timestamp": 1641574617
    },
    {
        "content": "<p>cool, thanks!</p>",
        "id": 267213005,
        "sender_full_name": "Michael Goulet",
        "timestamp": 1641574621
    },
    {
        "content": "<p>Funny timing, this just came up in the community discord. Hopefully this will make <a href=\"https://github.com/rust-lang/rust/issues/62992\">#62992</a> easy to fix as well, which is extra cool because that's a fairly easy beginner trap</p>",
        "id": 267317098,
        "sender_full_name": "Jake",
        "timestamp": 1641677596
    },
    {
        "content": "<p>I put up this in a PR <a href=\"https://github.com/rust-lang/rust/issues/92652\">#92652</a> and seems like implementing Deref(,Mut) for array will require some t-lang discussion at least. Thanks for linking that issue though, I'll keep it in mind.</p>",
        "id": 267317835,
        "sender_full_name": "Michael Goulet",
        "timestamp": 1641678702
    }
]