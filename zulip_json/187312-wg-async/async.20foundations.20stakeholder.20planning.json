[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116883\">@tmandry</span> So I'm working through the <a href=\"https://hackmd.io/5MakNcwCRDKWnP6UTL58wg\">impl trait update</a> for the lang team and I'm beginning to question the idea of making <code>impl Trait</code> in argument position be \"late bound types\".</p>",
        "id": 261701131,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094025
    },
    {
        "content": "<p>It's not that I don't like the idea exactly, which I do</p>",
        "id": 261701149,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094035
    },
    {
        "content": "<p>But I think I might like the idea <em>better</em> to move to a future where <em>everything</em> is late-bound</p>",
        "id": 261701184,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094055
    },
    {
        "content": "<p>Actually, I wonder why we don't do that even now</p>",
        "id": 261701242,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094089
    },
    {
        "content": "<p>You can't make <em>everything</em> late-bound</p>",
        "id": 261701254,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094094
    },
    {
        "content": "<p>Anything that appears in return type but not argument types must be early bound</p>",
        "id": 261701264,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094103
    },
    {
        "content": "<p><em>But</em>.. if we moved all the where clauses to the impl (logically)</p>",
        "id": 261701285,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094120
    },
    {
        "content": "<p>At that point, I think <span class=\"user-mention\" data-user-id=\"123856\">@Vadim Petrochenkov</span> has a point that (to me) it feels like \"fewer concepts\" to say that APIT desugars <em>exactly</em> to a fresh generic type parameter. We could address some of the other shortcomings (e.g., it's nice to not have to specify the values for all parameters) in an orthogonal way.</p>",
        "id": 261701379,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094163
    },
    {
        "content": "<p>My main concern was that, for async functions at least, you're going to need to specify the types of the arguments regardless, but that kind of works either way</p>",
        "id": 261701436,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094192
    },
    {
        "content": "<p>Ah, well, I guess it's also weird that the generic type for a function has to list the values for \"some\" of its generics</p>",
        "id": 261701458,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094210
    },
    {
        "content": "<p>/me thinks</p>",
        "id": 261701599,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094281
    },
    {
        "content": "<p>I guess I would say that, as a user, I'd prefer for things to be late-bound most of the time</p>",
        "id": 261701646,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094302
    },
    {
        "content": "<p>I just would also like a way to give it a name</p>",
        "id": 261701675,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094316
    },
    {
        "content": "<p>Example:</p>",
        "id": 261701679,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094317
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">do_the_thing</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Display</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nb\">String</span>\n</code></pre></div>",
        "id": 261701745,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094347
    },
    {
        "content": "<p>To get the output type of that, we are going to have to specify both the lifetime and the <code>impl Display</code> type</p>",
        "id": 261701832,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094375
    },
    {
        "content": "<p>I would prefer to do that with </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">&lt;</span><span class=\"k\">fn</span>#<span class=\"n\">do_the_thing</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">FnOnce</span><span class=\"p\">(</span><span class=\"o\">&amp;'</span><span class=\"na\">a</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"p\">)</span><span class=\"o\">&gt;</span>::<span class=\"n\">Output</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 261701885,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094407
    },
    {
        "content": "<p>Ah, right, ok, I'm remembering that my big concern was more about <em>typeof</em></p>",
        "id": 261701924,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094431
    },
    {
        "content": "<p>and how it would manage situations like this (wanting to avoid things like <a href=\"https://en.cppreference.com/w/cpp/utility/declval\">declval</a>)</p>",
        "id": 261701967,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094456
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261701885\">said</a>:</p>\n<blockquote>\n<p>I would prefer to do that with ... <em>long hideous thing follows</em></p>\n</blockquote>\n<p>to be clear, I'd probably prefer a shorthand most of all...</p>",
        "id": 261702156,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094531
    },
    {
        "content": "<p>I guess that <code>()</code> are not used in type grammar... we could e.g. do </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span>#<span class=\"n\">do_the_thing</span><span class=\"p\">(</span><span class=\"o\">&amp;'</span><span class=\"na\">a</span><span class=\"w\"> </span><span class=\"n\">MyType</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 261702239,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094572
    },
    {
        "content": "<p>i.e., <code>T(A1, A2, A3)</code> could be shorthand for </p>\n<p><code>&lt;T as FnOnce&lt;(A1, A2, A3)&gt;::Output</code></p>",
        "id": 261702284,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094596
    },
    {
        "content": "<p>did I already decide I hate that for some reason? :)</p>",
        "id": 261702346,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637094603
    },
    {
        "content": "<p>I have a reservation about both the approaches which is that I would expect that <code>::Output</code> would give the return type as written in the function signature, i.e., <code>impl Tr</code>. I don't see any justification for why it should return the concrete type from the implementation. It seems like this is a bit of hand-waviness which could bite us in the future since  there is no syntactic distinction between the output type in the signature vs the concrete type.</p>",
        "id": 261772864,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637149211
    },
    {
        "content": "<p>Getting slightly more philosophical, I find the whole motivation a bit off. The whole point of impl Trait is to abstract away the concrete type and we're now trying to find a way to break that encapsulation. Seems like a footgun, since upstream might change the implementation and break downstream code which relies on that named type. Unless I'm missing some safeguards against this</p>",
        "id": 261773065,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637149349
    },
    {
        "content": "<p>And semi-seriously, these types are ugly as hell! I am getting flashbacks to impossible to parse C++ template types. I pity any beginner or intermediate Rust programmer who comes across these in the wild. The understandability complaint applies maybe more to the shorthands than the longhand version.</p>",
        "id": 261773312,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637149513
    },
    {
        "content": "<p>My counter proposal is that either we find ways to address the motivations without needing to name the concrete return type (e.g.,  would it help to allow <code>impl Trait</code> as the type of struct fields with some semantics? Or leverage TAIT or ATIT to widen the scope of naming the concrete type without widening it to the whole program?). And if we can't do that, we just accept that there are some limitations in the type system that won't be fixed because the cost of doing so is too high.</p>",
        "id": 261773695,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637149774
    },
    {
        "content": "<p>Yeah, I am incliend to agree with 'ugly as hell'. I've significantly revised the approach and I'm much happier with it. Take a look at current draft: <a href=\"https://hackmd.io/@nikomatsakis/BJfj7BeOK\">https://hackmd.io/@nikomatsakis/BJfj7BeOK</a></p>",
        "id": 261941181,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637248831
    },
    {
        "content": "<p>wrong link?</p>",
        "id": 261942786,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637249504
    },
    {
        "content": "<p>don't think so</p>",
        "id": 261942899,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249537
    },
    {
        "content": "<p><a href=\"https://hackmd.io/@nikomatsakis/BJfj7BeOK#Async-fn-in-traits\">this section</a> covers it</p>",
        "id": 261942910,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249545
    },
    {
        "content": "<p><a href=\"https://hackmd.io/@nikomatsakis/BJfj7BeOK#Naming-the-future-that-is-returned\">and this one</a></p>",
        "id": 261942954,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249566
    },
    {
        "content": "<p>it's so much simpler you might not recognize it :)</p>",
        "id": 261942959,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249570
    },
    {
        "content": "<p>tl;dr when you have <code>-&gt; impl Trait</code> in a trait, we add an associated type with same name as the method to represent the return type</p>",
        "id": 261942989,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249589
    },
    {
        "content": "<p>plus a <em>touch</em> of sugar to help make the <code>for&lt;'a&gt;</code> more tractable</p>",
        "id": 261943021,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249607
    },
    {
        "content": "<p>(the sugar may be a bit controversial; there are some alternatives i've been toying with there, though what's written up there is the one I like best)</p>",
        "id": 261943049,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249625
    },
    {
        "content": "<p>ah I see, /me reads</p>",
        "id": 261943061,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637249630
    },
    {
        "content": "<p>gosh so many updates to make to the async fundamentals repo</p>",
        "id": 261943079,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249640
    },
    {
        "content": "<p>it also covers the \"dyner\" story, <span class=\"user-mention\" data-user-id=\"256841\">@Nick Cameron</span></p>",
        "id": 261943216,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249694
    },
    {
        "content": "<p>though I had some ideas on the subway home last night that made it a bit out of date :)</p>",
        "id": 261943236,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1637249705
    },
    {
        "content": "<p>So, to rephrase, the idea is that you allow users of an async trait to name the synthesised associated types? Presumably the same thing works for RPITIT</p>",
        "id": 261943892,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637249985
    },
    {
        "content": "<p>IS the HRL shorthand proposed, or does that work today?</p>",
        "id": 261944187,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637250094
    },
    {
        "content": "<p>Could you use it in a trait decl too? As a way to add bounds to the future. E.g.,:</p>\n<div class=\"codehilite\"><pre><span></span><code>trait HttpRequestProvider {\n  async fn request(&amp;mut self, request: Request) -&gt; Response where Self::request: Send;\n}\n</code></pre></div>",
        "id": 261944779,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637250324
    },
    {
        "content": "<p>That seems kind of long-winded though</p>",
        "id": 261944828,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637250343
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261943049\">said</a>:</p>\n<blockquote>\n<p>(the sugar may be a bit controversial; there are some alternatives i've been toying with there, though what's written up there is the one I like best)</p>\n</blockquote>\n<p>What about:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">where</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">P</span>::<span class=\"n\">request</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"w\"> </span>: <span class=\"nb\">Send</span>\n</code></pre></div>\n<p>The more I think about (explicitly-)elided lifetime parameters in <code>where</code> clauses, the more it makes sense to make them higher-order (at least when on the left-hand side of the clause):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">where</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"o\">&amp;</span><span class=\"n\">T</span><span class=\"w\"> </span>: <span class=\"nb\">Send</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"c1\">// instead of `T : Sync`</span>\n</code></pre></div>\n<p>with the caveat (similar to that when defining an <code>impl</code> receiver), of having \"input lifetime parameter\" elision rules only: each elided lifetime would be distinct from one another:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">where</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"o\">&amp;</span><span class=\"n\">P</span>::<span class=\"n\">request</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"w\"> </span>: <span class=\"nb\">Send</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"c1\">// same as:</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"o\">&lt;'</span><span class=\"na\">any0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">any1</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">&amp;'</span><span class=\"na\">any0</span><span class=\"w\"> </span><span class=\"n\">P</span>::<span class=\"n\">request</span><span class=\"o\">&lt;'</span><span class=\"na\">any1</span><span class=\"o\">&gt;</span><span class=\"w\"> </span>: <span class=\"nb\">Send</span><span class=\"p\">,</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 261949638,
        "sender_full_name": "Daniel Henry-Mantilla",
        "timestamp": 1637252069
    },
    {
        "content": "<p>Although I can see why <code>P::request&lt;'_, '_, '_, '_&gt;</code> may not be ideal either <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">P</span>::<span class=\"n\">request</span><span class=\"o\">&lt;'..&gt;</span><span class=\"w\"></span>\n</code></pre></div>\n<p>? <span aria-label=\"see no evil\" class=\"emoji emoji-1f648\" role=\"img\" title=\"see no evil\">:see_no_evil:</span></p>",
        "id": 261949931,
        "sender_full_name": "Daniel Henry-Mantilla",
        "timestamp": 1637252184
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116009\">nikomatsakis</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261941181\">said</a>:</p>\n<blockquote>\n<p>Yeah, I am incliend to agree with 'ugly as hell'. I've significantly revised the approach and I'm much happier with it. Take a look at current draft: <a href=\"https://hackmd.io/@nikomatsakis/BJfj7BeOK\">https://hackmd.io/@nikomatsakis/BJfj7BeOK</a></p>\n</blockquote>\n<p>I don't see it mentioned in the doc but this has a really nice symmetry with tuple structs- <code>struct Foo(T, U)</code> desugars to a type <code>Foo</code> and a constructor <code>fn Foo</code>; here <code>async fn foo</code> also desugars to a type <code>foo</code> and a constructor <code>fn foo</code>!</p>",
        "id": 261951567,
        "sender_full_name": "rpjohnst",
        "timestamp": 1637252846
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256841\">Nick Cameron</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261943892\">said</a>:</p>\n<blockquote>\n<p>So, to rephrase, the idea is that you allow users of an async trait to name the synthesised associated types? Presumably the same thing works for RPITIT</p>\n</blockquote>\n<p>yeah, we should do the same for RPITIT</p>",
        "id": 262017434,
        "sender_full_name": "tmandry",
        "timestamp": 1637285996
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256841\">Nick Cameron</span> <a href=\"#narrow/stream/187312-wg-async-foundations/topic/async.20foundations.20stakeholder.20planning/near/261773065\">said</a>:</p>\n<blockquote>\n<p>Getting slightly more philosophical, I find the whole motivation a bit off. The whole point of impl Trait is to abstract away the concrete type and we're now trying to find a way to break that encapsulation. Seems like a footgun, since upstream might change the implementation and break downstream code which relies on that named type. Unless I'm missing some safeguards against this</p>\n</blockquote>\n<p>you can make the type nameable <em>without</em> giving up the encapsulation ordinarily provided by <code>impl Trait</code></p>",
        "id": 262017535,
        "sender_full_name": "tmandry",
        "timestamp": 1637286082
    },
    {
        "content": "<p><code>impl Trait</code> already leaks auto traits like <code>Send</code> (as long as you know what impl is being used; i.e. you're using static dispatch)</p>",
        "id": 262017662,
        "sender_full_name": "tmandry",
        "timestamp": 1637286214
    },
    {
        "content": "<p>so when you write <code>P::request</code> the value of that associated type can still be <code>impl Future&lt;Output = Response&gt;</code>, which tells you only about the <code>Future</code> bound and the auto traits of the type</p>",
        "id": 262017893,
        "sender_full_name": "tmandry",
        "timestamp": 1637286409
    },
    {
        "content": "<p>On the <a href=\"https://github.com/rust-lang/rfcs/pull/3193\">RPITIT RFC</a> there was discussion around how this can be extended to other properties the impl chooses to advertise. So for example</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">MyIntoIterator</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">type</span> <span class=\"nc\">Item</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">my_into_iter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">impl</span><span class=\"w\"> </span><span class=\"nb\">Iterator</span><span class=\"o\">&lt;</span><span class=\"n\">Item</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">Self</span>::<span class=\"n\">Item</span><span class=\"o\">&gt;</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>could be \"refined\" in an impl:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">NewIntoIterator</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Range</span><span class=\"o\">&lt;</span><span class=\"kt\">u32</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">type</span> <span class=\"nc\">Item</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kt\">u32</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">into_iter</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt;\n        <span class=\"nc\">impl</span><span class=\"w\"> </span><span class=\"nb\">Iterator</span><span class=\"o\">&lt;</span><span class=\"n\">Item</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"bp\">Self</span>::<span class=\"n\">Item</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"nb\">DoubleEndedIterator</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"c1\">//  ^^^^^^^^^^^^^^^^^^^ not in the trait!</span>\n<span class=\"w\">    </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 262018240,
        "sender_full_name": "tmandry",
        "timestamp": 1637286796
    },
    {
        "content": "<p>But this is something the impl opts in to, giving the author as much flexibility as they want to make future changes</p>",
        "id": 262018259,
        "sender_full_name": "tmandry",
        "timestamp": 1637286838
    },
    {
        "content": "<p>Yeah, I'm all for allowing refinement of abstract return types in impls</p>",
        "id": 262043347,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637313402
    },
    {
        "content": "<p>I like the associated type proposal, that seems to get the balance right in that it lets users constrain the type without being able to name the concrete type. Presumably that means it doesn't address some of the use cases, but that is fine by me</p>",
        "id": 262043494,
        "sender_full_name": "Nick Cameron",
        "timestamp": 1637313514
    },
    {
        "content": "<p>It's possible we could allow the impl could refine the type all the way to a concrete type</p>",
        "id": 262085657,
        "sender_full_name": "tmandry",
        "timestamp": 1637337584
    }
]