[
    {
        "content": "<p>A new proposal has been announced: <a href=\"https://github.com/rust-lang/compiler-team/issues/481\">Overhaul interning #481</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>",
        "id": 270787916,
        "sender_full_name": "triagebot",
        "timestamp": 1644018101
    },
    {
        "content": "<p>Some thoughts: \"I also think this it's borderline whether this change needs an MCP.\"</p>\n<p>This, nearly by definition, what MCPs are used for. Particularly, changes that \"touch a lot of code.\" There are also MCPs that <em>don't</em> touch a lot of code, but a change that touches a lot of code is precisely one of the things MCPs are for.</p>",
        "id": 270792833,
        "sender_full_name": "Jack Huey",
        "timestamp": 1644022136
    },
    {
        "content": "<blockquote>\n<p>Have a zero-sized private type as a field so you can pattern match an Interned&lt;T&gt; but not construct an Interned&lt;T&gt;.</p>\n</blockquote>\n<p>This can be done with <code>non_exhaustive</code></p>",
        "id": 270792860,
        "sender_full_name": "Mark Drobnak",
        "timestamp": 1644022162
    },
    {
        "content": "<p>Second: I overall like this change. Interning is kind of a mess. But, I would push strongly to think carefully about the likely future type library (the one shared with Chalk and maybe others). Particularly, ensuring that changes here honor its goal to be interning-agnostic (so that other platforms e.g. rust-analyzer can utilize the type library without committing to interning)</p>",
        "id": 270793057,
        "sender_full_name": "Jack Huey",
        "timestamp": 1644022350
    },
    {
        "content": "<p><span class=\"user-group-mention\" data-user-group-id=\"492\">@T-compiler</span>: Proposal <a href=\"https://github.com/rust-lang/compiler-team/issues/481#issuecomment-1030567410\">#481</a> has been seconded, and will be approved in 10 days if no objections are raised.</p>",
        "id": 270811233,
        "sender_full_name": "triagebot",
        "timestamp": 1644045171
    },
    {
        "content": "<p>I think we're good on the chalk side, as a) it doesn't make anything worse and b) we need to do introduce the generic params at the level before the <code>Interned</code> anyway.</p>",
        "id": 270811537,
        "sender_full_name": "oli",
        "timestamp": 1644045681
    },
    {
        "content": "<p>The switch from typedefs to newtypes seems like an orthogonal change.</p>",
        "id": 270817222,
        "sender_full_name": "Vadim Petrochenkov",
        "timestamp": 1644054368
    },
    {
        "content": "<p>I don't see why implementing methods for <code>TyS</code> is an issue.<br>\nIf we normalize then why not normalize to typedefs instead, seems like a simpler solution.<br>\n<code>TyS</code> is the underlying data, <code>Interned&lt;TyS&gt;</code> is the reference to it, newtype around <code>Interned&lt;TyS&gt;</code> is ???</p>",
        "id": 270817243,
        "sender_full_name": "Vadim Petrochenkov",
        "timestamp": 1644054427
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232957\">Jack Huey</span> <a href=\"#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Overhaul.20interning.20compiler-team.23481/near/270792833\">said</a>:</p>\n<blockquote>\n<p>Some thoughts: \"I also think this it's borderline whether this change needs an MCP.\"</p>\n</blockquote>\n<p>The <a href=\"https://forge.rust-lang.org/compiler/mcp.html\">MCP docs</a> say:</p>\n<blockquote>\n<p>What constitutes a major change?</p>\n<p>The rough intuition is \"something that would require updates to the rustc-dev-guide or the rustc book\". In other words:</p>\n<ul>\n<li>Something that alters the architecture of some part(s) of the compiler, since this is what the rustc-dev-guide aims to document.</li>\n<li>A simple change that affects a lot of people, such as altering the names of very common types or changing coding conventions.</li>\n<li>Adding a compiler flag or other public facing changes, which should be documented (ultimately) in the rustc book. This is only appropriate for \"minor\" tweaks, however, and not major things that may impact a lot of users. (Also, public facing changes will require a full FCP before landing on stable, but an MCP can be a good way to propose the idea.)</li>\n</ul>\n<p>Note that, in some cases, the change may be deemed too big and a full FCP or RFC may be required to move forward. This could occur with significant public facing change or with sufficiently large changes to the architecture. The compiler team leads can make this call.</p>\n</blockquote>\n<p>This change doesn't alter the architecture of the compiler. It doesn't add any public facing changes. It's arguable whether it's a change that \"affects a lot of people\". If \"it touches a lot of code\" is a criterion for MCPs, then that should be added to the the docs.</p>",
        "id": 270913516,
        "sender_full_name": "nnethercote",
        "timestamp": 1644183800
    },
    {
        "content": "<p>Anyway, it clearly doesn't rise to the level of needing a full RFC, for example.</p>",
        "id": 270913527,
        "sender_full_name": "nnethercote",
        "timestamp": 1644183835
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123856\">@Vadim Petrochenkov</span> this change is all about how these interned types are represented, so the choice of newtype vs typedef is not orthogonal, it's utterly integral.</p>\n<p>In the PR, <code>Ty</code> is</p>\n<div class=\"codehilite\"><pre><span></span><code>pub struct Ty&lt;&#39;tcx&gt;(Interned&lt;&#39;tcx, TyS&lt;&#39;tcx&gt;&gt;);\n</code></pre></div>\n<p>If it was instead:</p>\n<div class=\"codehilite\"><pre><span></span><code>pub type Ty&lt;&#39;tcx&gt; = Interned&lt;&#39;tcx, TyS&lt;&#39;tcx&gt;&gt;;\n</code></pre></div>\n<p>then we can't do an inherent <code>impl</code> on <code>Ty</code>, because <code>Interned</code> is from a different crate. You asked:</p>\n<blockquote>\n<p>I don't see why implementing methods for TyS is an issue.</p>\n</blockquote>\n<p>I view <code>TyS</code> as an implementation detail and something that should be used as little as possible. <code>Ty</code> is the widely-used type, it's the interned type,  and <code>TyS</code> is not used directly at all. So IMO defining methods on <code>TyS</code> is confusing and might cause people to use <code>TyS</code> values without interning them, which would be bad.</p>",
        "id": 270914180,
        "sender_full_name": "nnethercote",
        "timestamp": 1644184707
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"218805\">Mark Drobnak</span> <a href=\"#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Overhaul.20interning.20compiler-team.23481/near/270792860\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>Have a zero-sized private type as a field so you can pattern match an Interned&lt;T&gt; but not construct an Interned&lt;T&gt;.</p>\n</blockquote>\n<p>This can be done with <code>non_exhaustive</code></p>\n</blockquote>\n<p>Yes. With a private field patterns look like <code>Interned(v, _)</code>, with <code>non_exhaustive</code> they look like <code>Interned(v, ..)</code>. I prefer the former because (a) it's one char shorter, (b) it's clear that there is only one additional field, rather than an unspecified number of possible additional fields.</p>",
        "id": 270914439,
        "sender_full_name": "nnethercote",
        "timestamp": 1644184946
    },
    {
        "content": "<p>non_exhaustive is also crate-visible essentially, whereas a private struct is truly private if you want it to be.</p>",
        "id": 270915884,
        "sender_full_name": "simulacrum",
        "timestamp": 1644187014
    },
    {
        "content": "<p>As stated elsewhere I am very much in favor of this change. The MCP lays out nicely that interning should be done in a unified fashion and that the current approach makes it easy to get things accidentally wrong. And working with the current infrastructure is just plain stressful and annoying because one always things that there's a reason why there are X special cases, when in fact there is no real reason.</p>\n<blockquote>\n<p>I also think this it's borderline whether this change needs an MCP.</p>\n</blockquote>\n<p>I think MCPs are a means of communications as much as they are for decision making. I think this is a change that almost anyone working on the compiler will want to have heard about beforehand. They are also good for PR authors because it should give them some piece of mind that the change will go through (as opposed to somebody bringing up a major objection after the fact).</p>\n<blockquote>\n<p>If \"it touches a lot of code\" is a criterion for MCPs, then that should be added to the the docs.</p>\n</blockquote>\n<p>That sounds like a good idea. Also, ideally we can make MCPs lightweight enough that filing one isn't a big deal.</p>",
        "id": 270949232,
        "sender_full_name": "mw",
        "timestamp": 1644224607
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120989\">nnethercote</span> <a href=\"#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Overhaul.20interning.20compiler-team.23481/near/270914180\">said</a>:</p>\n<blockquote>\n<p>I view <code>TyS</code> as an implementation detail and something that should be used as little as possible. <code>Ty</code> is the widely-used type, it's the interned type,  and <code>TyS</code> is not used directly at all. So IMO defining methods on <code>TyS</code> is confusing and might cause people to use <code>TyS</code> values without interning them, which would be bad.</p>\n</blockquote>\n<p>I agree with this reasoning.</p>",
        "id": 270949505,
        "sender_full_name": "mw",
        "timestamp": 1644224772
    },
    {
        "content": "<p>By the way, <span class=\"user-group-mention\" data-user-group-id=\"2943\">@T-infra</span>, we should be able to lock the tree for a bit in order to make it simpler to merge this change (once all the basics are in place), right? No reason to make this unnecessarily hard for <span class=\"user-mention silent\" data-user-id=\"120989\">nnethercote</span>.</p>",
        "id": 270949760,
        "sender_full_name": "mw",
        "timestamp": 1644224939
    },
    {
        "content": "<p>I'm not opposed, but how long are we talking about?</p>",
        "id": 270949892,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1644225006
    },
    {
        "content": "<p>if it's just close the tree, spend a couple hours (dunno how long) fixing the latest conflicts and then land that PR it's great, we practically keep the tree closed just for those couple hours</p>",
        "id": 270949971,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1644225066
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120989\">@nnethercote</span> would know best how much time he needs, but I suspect not more than a few hours.</p>",
        "id": 270949981,
        "sender_full_name": "mw",
        "timestamp": 1644225073
    },
    {
        "content": "<p>yeah, that sounds about right</p>",
        "id": 270949998,
        "sender_full_name": "mw",
        "timestamp": 1644225083
    },
    {
        "content": "<p>if it's in the order of days or something the queue might not be happy <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 270949999,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1644225083
    },
    {
        "content": "<p>in the past when we did similar changes (like reformat the world or moving directories) we did it close to dec 25th to minimize the chance of disruption, but it's a bit far <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 270950085,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1644225128
    },
    {
        "content": "<p>Weekends are a little less busy than mo-fr</p>",
        "id": 270956654,
        "sender_full_name": "The 8472",
        "timestamp": 1644228833
    },
    {
        "content": "<p>I don't think the conflicts will be bad. Closing the tree seems unlikely to be necessary, just setting the priority to 1 would be fine, I think</p>",
        "id": 271035420,
        "sender_full_name": "nnethercote",
        "timestamp": 1644264671
    },
    {
        "content": "<p>This proposal has been accepted: <a href=\"https://github.com/rust-lang/compiler-team/issues/481\">#481</a>.</p>",
        "id": 272226259,
        "sender_full_name": "triagebot",
        "timestamp": 1645086084
    }
]