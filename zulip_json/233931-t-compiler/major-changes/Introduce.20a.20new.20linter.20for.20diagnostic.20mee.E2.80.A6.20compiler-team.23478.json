[
    {
        "content": "<p>A new proposal has been announced: <a href=\"https://github.com/rust-lang/compiler-team/issues/478\">Introduce a new linter for diagnostic meesages #478</a>. It will be announced at the next meeting to try and draw attention to it, but usually MCPs are not discussed during triage meetings. If you think this would benefit from discussion amongst the team, consider proposing a design meeting.</p>",
        "id": 266659090,
        "sender_full_name": "triagebot",
        "timestamp": 1641196529
    },
    {
        "content": "<p>Hi, the author here. I'll answer a question I've got before writing this MCP here.</p>\n<blockquote>\n<p>Why not implement the proposed linter by adding rules to rustc internal lints?</p>\n</blockquote>\n<p>It is because the targets of the linter are not the Rust code that implements diagnostics, but the JSON output of the compiler in the middle of UI tests. Existing lints are for Rust files, so we need to create a new one for the JSON files.</p>",
        "id": 266659591,
        "sender_full_name": "Hirochika Matsumoto",
        "timestamp": 1641197040
    },
    {
        "content": "<p>I wonder if we could do this checking in tidy that just scans all <code>.stderr</code> files.</p>",
        "id": 266673159,
        "sender_full_name": "fee1-dead",
        "timestamp": 1641207132
    },
    {
        "content": "<p>We could dump the diagnostics as json (but not commit them) and run a pass on them that checks for such inconsistencies. cc <span class=\"user-group-mention\" data-user-group-id=\"1187\">@WG-diagnostics</span></p>",
        "id": 266673670,
        "sender_full_name": "oli",
        "timestamp": 1641207492
    },
    {
        "content": "<p>It should feasible but we need to implement a parser that re-reads a diagnostic from <code>.stderr</code> files, and I think that hardly pays off ;)</p>",
        "id": 266700975,
        "sender_full_name": "Hirochika Matsumoto",
        "timestamp": 1641224945
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"361356\">fee1-dead</span> <a href=\"#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478/near/266673159\">said</a>:</p>\n<blockquote>\n<p>I wonder if we could do this checking in tidy that just scans all <code>.stderr</code> files.</p>\n</blockquote>\n<p>It should feasible but we need to implement a parser that reconstructs a diagnostic from <code>.stderr</code> files, and I think that hardly pays off ;)</p>",
        "id": 266701186,
        "sender_full_name": "Hirochika Matsumoto",
        "timestamp": 1641225041
    },
    {
        "content": "<p>If the goal is linting diagnostic messages specifically emitted in UI tests, then integrating that linter into compiletest should give you access to the JSON structures without needing to dump to disk -- dumping to disk would likely be somewhat painful to structure well.</p>",
        "id": 266706048,
        "sender_full_name": "simulacrum",
        "timestamp": 1641227617
    },
    {
        "content": "<p>My recollection from <a href=\"https://github.com/rust-lang/rust/pull/89455\">https://github.com/rust-lang/rust/pull/89455</a> is that one of the major points of concern was the out-of-tree lints in that proposal -- this MCP is rather bare on details, but is that still the expectation? I remain concerned about the maintenance overhead of such a solution.</p>",
        "id": 266706339,
        "sender_full_name": "simulacrum",
        "timestamp": 1641227764
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <a href=\"#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478/near/266706339\">said</a>:</p>\n<blockquote>\n<p>My recollection from <a href=\"https://github.com/rust-lang/rust/pull/89455\">https://github.com/rust-lang/rust/pull/89455</a> is that one of the major points of concern was the out-of-tree lints in that proposal -- this MCP is rather bare on details, but is that still the expectation? I remain concerned about the maintenance overhead of such a solution.</p>\n</blockquote>\n<p>Yes, the idea of introducing an out-of-tree lint has not changed. But I don't think the maintenance burden is substantial as well as that of clippy or internal lints. For the two reasons below, I reckon I can maintain the lint by myself.</p>\n<ul>\n<li>The proposed lint is not dependent on the rustc code. This means that weekly or biweekly sync is not needed.</li>\n<li>The lint is not going to have many rules implemented. I've added lints accordingly to <a href=\"https://rustc-dev-guide.rust-lang.org/diagnostics.html#diagnostic-output-style-guide\">the diagnostic output style guide</a> which has 10 rules, so people barely send a patch to review.</li>\n</ul>",
        "id": 267071868,
        "sender_full_name": "Hirochika Matsumoto",
        "timestamp": 1641482243
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <a href=\"#narrow/stream/233931-t-compiler.2Fmajor-changes/topic/Introduce.20a.20new.20linter.20for.20diagnostic.20mee.E2.80.A6.20compiler-team.23478/near/266706048\">said</a>:</p>\n<blockquote>\n<p>If the goal is linting diagnostic messages specifically emitted in UI tests, then integrating that linter into compiletest should give you access to the JSON structures without needing to dump to disk -- dumping to disk would likely be somewhat painful to structure well.</p>\n</blockquote>\n<p>Yes, that is what I did in <a href=\"https://github.com/rust-lang/rust/issues/89455\">#89455</a>! The changes of the PR are happening only to compiletest (do note that I removed diagnostic message fixes to make the PR easier to review), and I am very happy about that.</p>",
        "id": 267072692,
        "sender_full_name": "Hirochika Matsumoto",
        "timestamp": 1641482652
    },
    {
        "content": "<p><span class=\"user-group-mention\" data-user-group-id=\"492\">@T-compiler</span>: Proposal <a href=\"https://github.com/rust-lang/compiler-team/issues/478#issuecomment-1009473133\">#478</a> has been seconded, and will be approved in 10 days if no objections are raised.</p>",
        "id": 267520220,
        "sender_full_name": "triagebot",
        "timestamp": 1641859725
    },
    {
        "content": "<p>How about we start by adding a script to CI that does the following, and then switch to the approach of adding <code>diaglint</code> to compiletest as a dependency once (after a certain time) the interested parties agree <code>diaglint</code> works well enough to do so? <span class=\"user-mention\" data-user-id=\"119031\">@Esteban KÃ¼ber</span>  <span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> </p>\n<p>The script does:</p>\n<ul>\n<li>For each<code>.stderr</code> file in <code>src/test</code><ul>\n<li>Extract diagnostic messages and lint them</li>\n</ul>\n</li>\n</ul>\n<p>I earlier said extracting messages is a hard job, but given most message has a prefix like <code>note: </code> it won't be that hard.</p>",
        "id": 268119903,
        "sender_full_name": "Hirochika Matsumoto",
        "timestamp": 1642244474
    },
    {
        "content": "<p>Maybe this has already been mentioned, but isn't it an issue to use a third-party linter if we decide to change our diagnostic style guide?</p>",
        "id": 268140991,
        "sender_full_name": "Noah Lev",
        "timestamp": 1642273203
    },
    {
        "content": "<p>I remain relatively skeptical of the external crate as a linter, it doesn't feel like it adds much value and does add overhead.</p>\n<p>Regardless, I don't think we should be <em>extracting</em> messages from stderr files -- we generate those from the JSON rustc emits, and we can lint on that, not re-parsing into a similar form.</p>",
        "id": 268193433,
        "sender_full_name": "simulacrum",
        "timestamp": 1642349882
    },
    {
        "content": "<p>This proposal has been accepted: <a href=\"https://github.com/rust-lang/compiler-team/issues/478\">#478</a>.</p>",
        "id": 268890896,
        "sender_full_name": "triagebot",
        "timestamp": 1642793028
    }
]