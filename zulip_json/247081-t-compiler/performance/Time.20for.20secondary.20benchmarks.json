[
    {
        "content": "<p>We're still finishing up adding/removing primary benchmarks, but I still wanted to kick off a conversation about the time it takes to run secondary benchmarks. As of right now it takes ~43 minutes to run primary benchmarks and ~39 minutes to run secondary. Since secondary are by definition less important than primary, is there anything we can do to reduce time in queue? Are there any situations where running secondary benchmarks is not necessary?</p>",
        "id": 276974062,
        "sender_full_name": "rylev",
        "timestamp": 1648543283
    },
    {
        "content": "<p>In particular it feels wrong that we spend ~1m18s on every perf run checking for issue-46449 which is simply a regression test making sure we don't reintroduce an issue seen long ago. Do we really need to run this for try runs?</p>",
        "id": 276975913,
        "sender_full_name": "rylev",
        "timestamp": 1648544397
    },
    {
        "content": "<blockquote>\n<p>is there anything we can do to reduce time in queue? </p>\n</blockquote>\n<p>Run two of them in parallel with CPU-pinning? I'll likely increase noise and change results but that might be acceptable for secondary?</p>",
        "id": 276982137,
        "sender_full_name": "The 8472",
        "timestamp": 1648548098
    },
    {
        "content": "<ul>\n<li>maybe separate them into two \"runs\", if there's a significant regression in a primary benchmark don't even run the secondary ones ?</li>\n<li>maybe we try and see how slow the regression tests are when parallelism shouldn't matter much eg with cachegrind (if we also don't gather self-profile times or switch to gathering hw counters for that I don't know) and where we could pin and saturate all the cores for the leaf crates ?</li>\n</ul>",
        "id": 276982906,
        "sender_full_name": "lqd",
        "timestamp": 1648548515
    },
    {
        "content": "<p>issue-46449 has a <code>.patch</code> file which probably isn't useful, and could be removed. I'd argue that no secondary benchmarks need <code>.patch</code> files. Other ones that currently do: coercions, deep-vector, tuple-stress, unify-linearly, unused-warnings</p>",
        "id": 277067421,
        "sender_full_name": "nnethercote",
        "timestamp": 1648589578
    },
    {
        "content": "<p>ctfe-stress-4 takes 2 minutes, I have shrinking that on the todo list</p>",
        "id": 277067601,
        "sender_full_name": "nnethercote",
        "timestamp": 1648589669
    },
    {
        "content": "<p>So there is some trimming possible, but if we really want to reduce times, we should consider removing stm32f4 as <span class=\"user-mention\" data-user-id=\"266526\">@Jakub Beránek</span> suggested; it takes almost 10 minutes</p>",
        "id": 277067707,
        "sender_full_name": "nnethercote",
        "timestamp": 1648589740
    },
    {
        "content": "<p>I only meant to use stm32f4 for rustdoc originally; changing it to only be Doc Full will probably cut down on the time tremendously</p>",
        "id": 277068178,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1648590042
    },
    {
        "content": "<p>I'd really prefer not to get rid of it altogether</p>",
        "id": 277068189,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1648590058
    },
    {
        "content": "<p>Oh, issue-46449 has <em>four</em> .patch files, that really seems unnecessary</p>",
        "id": 277068873,
        "sender_full_name": "nnethercote",
        "timestamp": 1648590514
    },
    {
        "content": "<p>Though some of them are fiddling with a buffer size, perhaps that is an important part of what is measured</p>",
        "id": 277068975,
        "sender_full_name": "nnethercote",
        "timestamp": 1648590579
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/247081-t-compiler.2Fperformance/topic/Time.20for.20secondary.20benchmarks/near/277068178\">said</a>:</p>\n<blockquote>\n<p>I only meant to use stm32f4 for rustdoc originally; changing it to only be Doc Full will probably cut down on the time tremendously</p>\n</blockquote>\n<p>We don't currently have a way to mark a test as Doc only</p>",
        "id": 277069085,
        "sender_full_name": "nnethercote",
        "timestamp": 1648590615
    },
    {
        "content": "<p>Happy to add that if you'll take the PR :)</p>",
        "id": 277098432,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1648620962
    },
    {
        "content": "<p>yeah I think that shouldn't be that hard. another way could just be to downgrade <code>stm</code> to the older version, which was faster to compile?</p>",
        "id": 277099571,
        "sender_full_name": "Jakub Beránek",
        "timestamp": 1648622168
    },
    {
        "content": "<p>Sure, or enable fewer features - I think it feature gates nearly everything</p>",
        "id": 277102328,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1648624390
    },
    {
        "content": "<p>it does, but already currently we only enable a single feature (it doesn't build without any features enabled)</p>",
        "id": 277103530,
        "sender_full_name": "Jakub Beránek",
        "timestamp": 1648625212
    },
    {
        "content": "<p>maybe there's some STM architecture/feature that is smaller/faster to compile than the one that we currently use though</p>",
        "id": 277103558,
        "sender_full_name": "Jakub Beránek",
        "timestamp": 1648625234
    },
    {
        "content": "<p>I did a quick check. All of the subparts of the crate (<code>stm32f405</code>, <code>stm32f401</code>, etc.) have a lot of code. The one that we currently use (...405) has 270k lines of code. the largest one has around 320k, the smallest one has 125k. so we could change the used feature to <code>stm32f410</code> (the smallest one), that should help</p>",
        "id": 277103736,
        "sender_full_name": "Jakub Beránek",
        "timestamp": 1648625379
    },
    {
        "content": "<p>Full debug build:<br>\ncurrent feature: 19.5s<br>\nstm32f410 feature: 12s</p>\n<p>Only last crate debug build:<br>\ncurrent feature: 13.3s<br>\nstm32f410 feature: 6s</p>",
        "id": 277104230,
        "sender_full_name": "Jakub Beránek",
        "timestamp": 1648625681
    },
    {
        "content": "<p>so it's about 2x faster for the crate itself (which corresponds to having 2x less code)</p>",
        "id": 277104249,
        "sender_full_name": "Jakub Beránek",
        "timestamp": 1648625698
    },
    {
        "content": "<p>I opened a PR to switch this rustdoc benchmark to the less costly feature <a href=\"https://github.com/rust-lang/rustc-perf/pull/1265\">https://github.com/rust-lang/rustc-perf/pull/1265</a> </p>\n<p>the roughly 50% reduction is probably going to look weird on the perf report, graphs, etc but probably worth it.</p>",
        "id": 277263998,
        "sender_full_name": "lqd",
        "timestamp": 1648724871
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120989\">@nnethercote</span> any objection to merging <span class=\"user-mention\" data-user-id=\"116113\">@lqd</span>'s PR? This makes comparisons for this benchmark a bit wonky for a little bit, and I just want to make sure we're all on board.</p>",
        "id": 277380928,
        "sender_full_name": "rylev",
        "timestamp": 1648799390
    },
    {
        "content": "<p>I'm in favour of merging it!</p>",
        "id": 277381327,
        "sender_full_name": "nnethercote",
        "timestamp": 1648799646
    },
    {
        "content": "<p>Done!</p>",
        "id": 277381676,
        "sender_full_name": "rylev",
        "timestamp": 1648799943
    },
    {
        "content": "<p>maybe the benchmark should be renamed to avoid tainting the summary stats?</p>",
        "id": 277387206,
        "sender_full_name": "The 8472",
        "timestamp": 1648803298
    },
    {
        "content": "<p>this version has only been there for a few days</p>",
        "id": 277388593,
        "sender_full_name": "lqd",
        "timestamp": 1648804051
    },
    {
        "content": "<p>This will likely cause whatever PR is benchmarked next as showing a huge perf improvement, but we'll have to just tell whoever is looking at the report to ignore this particular benchmark.</p>",
        "id": 277389481,
        "sender_full_name": "rylev",
        "timestamp": 1648804556
    },
    {
        "content": "<p>exactly, that's why I mentioned this on the PR and here and waited for everyone to see it before merging. thankfully it's only going to be a one-time annoyance, compared to the more complex alternatives of removing the benchmark, having rustdoc only benchmarks, splitting primary and secondary runs for faster turnaround, etc</p>",
        "id": 277389787,
        "sender_full_name": "lqd",
        "timestamp": 1648804742
    },
    {
        "content": "<p>Here's a try run that run into this: <a href=\"https://github.com/rust-lang/rust/pull/95562#issuecomment-1086098290\">https://github.com/rust-lang/rust/pull/95562#issuecomment-1086098290</a></p>",
        "id": 277443886,
        "sender_full_name": "rylev",
        "timestamp": 1648830470
    },
    {
        "content": "<p>It'll affect a handful of results this week, but then it'll stop being a problem. The time on <a href=\"https://perf.rust-lang.org/status.html\">https://perf.rust-lang.org/status.html</a> has dropped from almost 10 minutes to 4m16s, which is great.</p>",
        "id": 277480619,
        "sender_full_name": "nnethercote",
        "timestamp": 1648848892
    }
]