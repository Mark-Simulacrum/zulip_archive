[
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/pull/89709\">https://github.com/rust-lang/rust/pull/89709</a> had negative perf impact of almost 3% on some benchmarks, should we revert?</p>",
        "id": 257088870,
        "sender_full_name": "matthiaskrgr",
        "timestamp": 1633970414
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"249967\">@Clemens Wasser</span></p>",
        "id": 257088905,
        "sender_full_name": "matthiaskrgr",
        "timestamp": 1633970429
    },
    {
        "content": "<p>I wonder if it is somehow salvageable...?<br>\nThere was one <code>debug_assert</code> turned into an actual <code>assert</code>, I wonder how much of an impact that had...<br>\n<a href=\"https://github.com/rust-lang/rust/pull/89709/files#diff-39dc2906167489754ec214d1c9375ae076b3e70193c40daa00ee702ff658b006L615\">https://github.com/rust-lang/rust/pull/89709/files#diff-39dc2906167489754ec214d1c9375ae076b3e70193c40daa00ee702ff658b006L615</a></p>",
        "id": 257089087,
        "sender_full_name": "matthiaskrgr",
        "timestamp": 1633970523
    },
    {
        "content": "<p>Yeah also think it's the assert</p>",
        "id": 257089139,
        "sender_full_name": "Clemens Wasser",
        "timestamp": 1633970556
    },
    {
        "content": "<p>some of the iterator changes are suspicious too, e.g. the <code>by_ref</code> ones tend to optimize less well. Or changing a range to an enumerate.</p>",
        "id": 257090043,
        "sender_full_name": "The 8472",
        "timestamp": 1633970997
    },
    {
        "content": "<p>Checking with cachegrind where the extra instructions are may help, but with so many changes spread across the compiler it'll be pretty hard I'd guess.</p>",
        "id": 257090859,
        "sender_full_name": "simulacrum",
        "timestamp": 1633971451
    },
    {
        "content": "<p>we could start with reverting the assert change and do another perf run on the new pr to see if that fixes it..? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 257093376,
        "sender_full_name": "matthiaskrgr",
        "timestamp": 1633972770
    },
    {
        "content": "<p>I reverted two changes that looked suspicious to me in <a href=\"https://github.com/rust-lang/rust/pull/89855\">https://github.com/rust-lang/rust/pull/89855</a></p>",
        "id": 257429105,
        "sender_full_name": "matthiaskrgr",
        "timestamp": 1634155603
    },
    {
        "content": "<p>could I get a perf-run to see if that fixes it (or at least a part of it?)</p>",
        "id": 257429151,
        "sender_full_name": "matthiaskrgr",
        "timestamp": 1634155629
    },
    {
        "content": "<p>ok Oli already launched the perf run &lt;3</p>",
        "id": 257429409,
        "sender_full_name": "matthiaskrgr",
        "timestamp": 1634155734
    },
    {
        "content": "<p>no perf change from that pr</p>\n<p>cachegrind diff shows that the regression is definitely in <code>compress</code> though</p>\n<div class=\"codehilite\"><pre><span></span><code># from `cargo +nightly run --release --bin collector -- diff_local cachegrind --include keccak --builds Check --runs Full +86d6d2b7389fe1b339402c1798edae8b695fc9ef +6ae8912a3e7d2c4c775024f58a7ba4b1aedc4073`\n--------------------------------------------------------------------------------\nIr           file:function\n--------------------------------------------------------------------------------\n802,108,819  ???:rustc_data_structures::obligation_forest::ObligationForest&lt;O&gt;::compress\n -3,521,355  ???:hashbrown::map::RawEntryBuilderMut&lt;K,V,S,A&gt;::from_hash\n   -979,456  ???:rustc_middle::ty::context::CtxtInterners::intern_predicate\n   -854,829  obj/build/x86_64-unknown-linux-gnu/stage1-rustc/x86_64-unknown-linux-gnu/release/build/tikv-jemalloc-sys-fde45a9a697cc078/out/build/src/extent.c:extent_recycle\n</code></pre></div>\n<p>so it's likely caused by the change from manual indexing -&gt; iter_mut + enumerate in that loop</p>",
        "id": 257468922,
        "sender_full_name": "erikdesjardins",
        "timestamp": 1634177647
    }
]