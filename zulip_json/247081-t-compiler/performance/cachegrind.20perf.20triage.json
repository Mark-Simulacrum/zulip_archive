[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"330154\">@The 8472</span> <span class=\"user-mention\" data-user-id=\"224872\">@rylev</span> <a href=\"https://github.com/rust-lang/rust/pull/87244#issuecomment-920538189\">https://github.com/rust-lang/rust/pull/87244#issuecomment-920538189</a></p>",
        "id": 253521471,
        "sender_full_name": "simulacrum",
        "timestamp": 1631761412
    },
    {
        "content": "<p>happy to answer questions of course :)</p>",
        "id": 253521529,
        "sender_full_name": "simulacrum",
        "timestamp": 1631761448
    },
    {
        "content": "<p>could be cool to add this to perf.rlo ? :) if queries haven’t changed (or even if they have) run cachegrind on one, or a limited number since it’s going to be slower than running perf, of the significant regressions and show the head of the diff on the site</p>",
        "id": 253538850,
        "sender_full_name": "lqd",
        "timestamp": 1631776367
    },
    {
        "content": "<p>Cachegrind is unfortunately quite slow, though it doesn't need to be run on dedicated hardware (since it's essentially an emulator), so we could have a separate machine (s) for this. It's probably a good bit of work to write the code to do that though.</p>",
        "id": 253568163,
        "sender_full_name": "simulacrum",
        "timestamp": 1631792907
    },
    {
        "content": "<p>oh I'm well aware of the valgrind tools' overhead ^^ I was hoping it wasn't prohibitively slow on a single profile of a significant regression, but you can always imagine a worst case where a really slow PR + the cachegrind overhead conspire to completely block the queue. And if there were enough capacity in the queue, it'd probably be more interesting to use it to run more iterations instead of cachegrind, I presume ?</p>",
        "id": 253630837,
        "sender_full_name": "lqd",
        "timestamp": 1631818063
    },
    {
        "content": "<p>I think it may be viable for us to do something like perf record (which is near-native speed) and get diffs based on that. Cachegrind is useful because it's diffs can be one the order of thousands of instructions -- which is difficult or impossible for perf record to catch.</p>",
        "id": 253631696,
        "sender_full_name": "simulacrum",
        "timestamp": 1631818409
    },
    {
        "content": "<p>It's worth noting it's not as simple as a single profile -- you need to do at least two, probably, for the parent commit and the current one</p>",
        "id": 253631824,
        "sender_full_name": "simulacrum",
        "timestamp": 1631818450
    },
    {
        "content": "<p>yeah, true. probably better to keep doing it manually for the short and medium term then. <code>perf diff</code> on perf.rlo also sounds worth investigating</p>",
        "id": 253635338,
        "sender_full_name": "lqd",
        "timestamp": 1631819749
    },
    {
        "content": "<p>I have used perf diff before and it's hard to get it to spit out useful results. If inling changes then the property that it takes the left side as baseline and doesn't display stuff on the right side that's not in the baseline means it just displays noise because it omits one chunk and shows instructions shuffled to other methods as entirely new stuff.</p>",
        "id": 253636499,
        "sender_full_name": "The 8472",
        "timestamp": 1631820229
    },
    {
        "content": "<p>at least for local builds that's really problematic</p>",
        "id": 253636584,
        "sender_full_name": "The 8472",
        "timestamp": 1631820247
    },
    {
        "content": "<p>it's better with CI builds since they use 1CGU and aren't incremental but still leaves <code>perf diff</code>'s crazy notion of baseline.</p>",
        "id": 253636705,
        "sender_full_name": "The 8472",
        "timestamp": 1631820310
    },
    {
        "content": "<p>Yeah, I've had a similar experience too. Never sure if it's just my environment / bad docs or fundamental incompatibility.</p>",
        "id": 253636810,
        "sender_full_name": "simulacrum",
        "timestamp": 1631820359
    },
    {
        "content": "<p>perf docs are the worst. It honestly feels like lore: \"use these options when running perf because they give the best results\"</p>",
        "id": 253638796,
        "sender_full_name": "Jack Huey",
        "timestamp": 1631821179
    },
    {
        "content": "<p>for perf it might be useful to run a benchmark in a loop to get more samples</p>",
        "id": 253640647,
        "sender_full_name": "The 8472",
        "timestamp": 1631821941
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"116122\">simulacrum</span> <a href=\"#narrow/stream/247081-t-compiler.2Fperformance/topic/cachegrind.20perf.20triage/near/253521471\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"330154\">The 8472</span> <span class=\"user-mention silent\" data-user-id=\"224872\">rylev</span> <a href=\"https://github.com/rust-lang/rust/pull/87244#issuecomment-920538189\">https://github.com/rust-lang/rust/pull/87244#issuecomment-920538189</a></p>\n</blockquote>\n<p>it might be useful to link to this on rustc-dev-guide :)</p>",
        "id": 253688713,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1631853514
    },
    {
        "content": "<p>I would not link to it -- feel free to steal it though and rewrite it :)</p>",
        "id": 253730532,
        "sender_full_name": "simulacrum",
        "timestamp": 1631879883
    },
    {
        "content": "<p>With recent changes to rustc-perf in <a href=\"https://github.com/rust-lang/rustc-perf/issues/1025\">rustc-perf#1025</a> &amp; <a href=\"https://github.com/rust-lang/rustc-perf/issues/1028\">rustc-perf#1028</a>, this work flow is now directly incorporated into perf collector. Following command automatically installs the toolchains, runs the benchmarks, generates and annotates the cachegrind diff:</p>\n<div class=\"codehilite\"><pre><span></span><code>cargo run --release --bin collector -- diff_local cachegrind --builds Check --runs Full --include stm32f4 \\\n  +718d53b0cb7dde93499cb92950d60b412f5a3d05 \\\n  +da7d405357600a76f2b93b8aa41fe5ee5da7885d\n</code></pre></div>",
        "id": 255214991,
        "sender_full_name": "tm",
        "timestamp": 1632835343
    }
]