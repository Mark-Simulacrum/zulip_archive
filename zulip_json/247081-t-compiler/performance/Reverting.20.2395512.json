[
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/pull/95512\">#95512</a> was a caused of a <a href=\"https://github.com/rust-lang/rust/pull/95667#issuecomment-1088748929\">serious perf regression</a> (note the PR was merged through a rollup). Do we want to revert this PR until we can land it with less of a perf impact?</p>",
        "id": 278531577,
        "sender_full_name": "rylev",
        "timestamp": 1649671384
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"116107\">@davidtwco</span></p>",
        "id": 278531735,
        "sender_full_name": "rylev",
        "timestamp": 1649671462
    },
    {
        "content": "<p>Unfortunately, there are no clear and obvious ways to improve the perf here both bootstrapping wise and compiler perf.</p>",
        "id": 278531824,
        "sender_full_name": "rylev",
        "timestamp": 1649671523
    },
    {
        "content": "<p>(as a note I did make <a href=\"https://github.com/zbraniecki/unic-locale/issues/66\">an issue</a> which would get rid of the <code>proc_macro_hack</code> dependency but I'm pretty sure this won't help bootstrapping very much)</p>",
        "id": 278532162,
        "sender_full_name": "rylev",
        "timestamp": 1649671730
    },
    {
        "content": "<p>I think we can improve the impact on compiler performance:</p>\n<p>Most of what the pull request does should be neutral, it's just changing APIs and macros that generate calls to those APIs, the thing that's likely causing the impact is that we're now loading the Fluent resources (the file with the diagnostic messages in it) for the default locale at the start of every compilation session. I should be able to find a way to avoid doing that and just load it the first time that we need it - when there's definitely going to be an error, so happy path compilation sessions shouldn't have any performance impact.</p>\n<p>Bootstrapping performance is tougher, I introduce new dependencies, that's inherently going to add bootstrapping time, I've tried to avoid adding anything that wasn't strictly necessary, but there are transitive dependencies and I've not spent time trying to trim those down in the upstream projects - might be possible, might not.</p>",
        "id": 278532383,
        "sender_full_name": "davidtwco",
        "timestamp": 1649671866
    },
    {
        "content": "<p>If there's no major rush here then I should be able to have a pull request up with that change within a day or two and we can see if it helps.</p>",
        "id": 278532498,
        "sender_full_name": "davidtwco",
        "timestamp": 1649671934
    },
    {
        "content": "<p>Sounds good. My only worry is that if we ultimately need to rollback, the longer we wait the harder it becomes which means there's a tiny bit of urgency, but I think a day or two is fine.</p>",
        "id": 278532534,
        "sender_full_name": "rylev",
        "timestamp": 1649671964
    },
    {
        "content": "<p>If I'm right about where the slow down is and can't fix it easily, then I could probably write a patch that stops translation working but avoids that performance hit without having to roll it all back.</p>",
        "id": 278532639,
        "sender_full_name": "davidtwco",
        "timestamp": 1649672026
    },
    {
        "content": "<p>That might be a good stop gap</p>",
        "id": 278532828,
        "sender_full_name": "rylev",
        "timestamp": 1649672131
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"224872\">@rylev</span> was slightly trickier than I anticipated, but <a href=\"https://github.com/rust-lang/rust/issues/95968\">#95968</a> will hopefully help</p>",
        "id": 278664334,
        "sender_full_name": "davidtwco",
        "timestamp": 1649753424
    },
    {
        "content": "<p>Cool! Thanks. I'll kick off a perf run.</p>",
        "id": 278664625,
        "sender_full_name": "rylev",
        "timestamp": 1649753627
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/pull/95968#issuecomment-1096609796\">Perf result</a> looks really great!  <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> If we <a href=\"https://perf.rust-lang.org/compare.html?start=949b98cab8a186b98bf87e64374b8d0848c55271&amp;end=9dc3dee37922f95ff26fc636c1692ebabd993816&amp;stat=instructions%3Au\">compare this change to the perf right before the fluent change was added</a> we're at a slight perf improvement overall, and when only primary benchmarks are looked at, the improvements are even better. I definitely think we're going to want to ship this.</p>",
        "id": 278683247,
        "sender_full_name": "rylev",
        "timestamp": 1649765427
    }
]