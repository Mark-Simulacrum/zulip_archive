[
    {
        "content": "<p>Hi, I'm trying to build rustc on an M1 Macbook Pro. when running <code>./x.py test</code>, I get an abort during \"fmt check\" like so:</p>\n<p>$ ./x.py test<br>\nUpdating only changed submodules<br>\n  Submodules updated in 0.01 seconds<br>\nBuilding rustbuild<br>\n    Finished dev [unoptimized] target(s) in 0.10s<br>\nBuilding stage0 tool tidy (x86_64-apple-darwin)<br>\n    Finished release [optimized] target(s) in 0.11s<br>\ntidy check<br>\nChecking which error codes lack tests...</p>\n<ul>\n<li>629 error codes</li>\n<li>\n<p>highest error code: E0787<br>\nFound 504 error codes<br>\nFound 0 error(s) in error codes<br>\nDone!</p>\n</li>\n<li>\n<p>372 features<br>\nfmt check<br>\nrustfmt(7389,0x20133a600) malloc: *** error for object 0x6000036d4600: pointer being freed was not allocated<br>\nrustfmt(7389,0x20133a600) malloc: *** set a breakpoint in malloc_error_break to debug<br>\nRunning <code>\"/Users/code/git/rust/build/x86_64-apple-darwin/stage0/bin/rustfmt\" \"--config-path\" \"/Users/code/git/rust\" \"--edition\" \"2021\" \"--unstable-features\" \"--skip-children\" \"--check\" \"/Users/code/git/rust/library/std/src/collections/hash/set.rs\" \"/Users/code/git/rust/library/std/src/collections/hash/set/tests.rs\" \"/Users/code/git/rust/library/std/src/collections/hash/map/tests.rs\" \"/Users/code/git/rust/library/std/src/sync/condvar.rs\" \"/Users/code/git/rust/library/std/src/sync/poison.rs\" \"/Users/code/git/rust/library/std/src/sync/barrier/tests.rs\" \"/Users/code/git/rust/library/std/src/sync/mutex/tests.rs\" \"/Users/code/git/rust/library/std/src/prelude/v1.rs\"</code> failed.</p>\n</li>\n</ul>\n<p>Any pointers on how to resolve this would be appreciated</p>",
        "id": 278157132,
        "sender_full_name": "Sebastian Hahn",
        "timestamp": 1649335044
    },
    {
        "content": "<p>See <a href=\"https://github.com/rust-lang/rust/issues/92173\">https://github.com/rust-lang/rust/issues/92173</a></p>",
        "id": 278161086,
        "sender_full_name": "bjorn3",
        "timestamp": 1649336849
    },
    {
        "content": "<p>Thank you for the suggestion, I guess I didn't see it because for me it was rustfmt which isn't yet mentioned in that issue. Unfortunately no workaround yet I guess, but thanks a lot!</p>",
        "id": 278177670,
        "sender_full_name": "Sebastian Hahn",
        "timestamp": 1649343898
    },
    {
        "content": "<p>The way I have pieced this together for me is that it is the pre-built stage0 rustfmt that crashes, so I cannot really work around it locally by changing any options for the rust compilation. I was able to work around the issue by exporting MallocStackLogging=1 before the ./x.py test, but this of course makes everything a bit slower and creates lots of debug output. I guess the question becomes, when would a new stage0 be created and would it have a fix for this issue.</p>",
        "id": 278391433,
        "sender_full_name": "Sebastian Hahn",
        "timestamp": 1649485710
    },
    {
        "content": "<p>stage0 was bumped a few days ago, can you check that you are on the latest master?</p>\n<p>I also have a few questions:</p>\n<ul>\n<li>It looks like you are running x86_64 binaries. Is there a reason for that?  I would expect the build host to be <code>aarch64</code>.  Do you maybe have <code>x86_64</code> rustc or rustup installed, or have it overridden in config.toml?</li>\n<li>Which version of macOS are you using?</li>\n<li>Which version of xcode do you have installed?</li>\n</ul>",
        "id": 278413677,
        "sender_full_name": "Eric Huss",
        "timestamp": 1649515803
    },
    {
        "content": "<p>Latest master works (even with x86_64), awesome! Thank you so much. I also changed my rustup default host triple to <code>aarch64-apple-darwin</code> and magically I am now building using that for my build as well.<br>\nAs to your questions:</p>\n<ul>\n<li>I am not running x86_64 on purpose. I migrated the machine from an older Mac, I assume my rustup continued using x86_64. I figured this was the only thing available and therefore didn't look further.</li>\n<li>Version 12.3.1</li>\n<li>13.3</li>\n</ul>",
        "id": 278428090,
        "sender_full_name": "Sebastian Hahn",
        "timestamp": 1649534834
    }
]