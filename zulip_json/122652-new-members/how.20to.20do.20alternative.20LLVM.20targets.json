[
    {
        "content": "<p>(I'll move the message to a new topics with a more specific subject line.)</p>",
        "id": 274703496,
        "sender_full_name": "pnkfelix",
        "timestamp": 1646839616
    },
    {
        "content": "<p>Thanks, for creating a new topic. I am looking forward to hearing more about Rust on custom LLVM targets :)</p>",
        "id": 274843927,
        "sender_full_name": "Rithik Sharma",
        "timestamp": 1646923459
    },
    {
        "content": "<p>(its possible that I should have outright moved it to <a class=\"stream\" data-stream-id=\"187780\" href=\"/#narrow/stream/187780-t-compiler.2Fwg-llvm\">#t-compiler/wg-llvm</a> , but I figured I'd keep it underneath <a class=\"stream\" data-stream-id=\"122652\" href=\"/#narrow/stream/122652-new-members\">#new members</a>  for the short term...)</p>",
        "id": 274844595,
        "sender_full_name": "pnkfelix",
        "timestamp": 1646923776
    },
    {
        "content": "<p>I supported the architecture, but I have some concerns about the testing. Is there any test suite to check the functionality of the toolchain?</p>",
        "id": 276162296,
        "sender_full_name": "Rithik Sharma",
        "timestamp": 1647941929
    },
    {
        "content": "<p>./x.py test</p>",
        "id": 276164732,
        "sender_full_name": "bjorn3",
        "timestamp": 1647943334
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"482770\">@Rithik Sharma</span> see also <a href=\"https://rustc-dev-guide.rust-lang.org/tests/intro.html\">https://rustc-dev-guide.rust-lang.org/tests/intro.html</a> , which will cover <code>x.py test</code> (and is just one chapter in a broader book about rustc development).</p>",
        "id": 276174419,
        "sender_full_name": "pnkfelix",
        "timestamp": 1647948820
    },
    {
        "content": "<p>Thanks for the information :)</p>",
        "id": 276174743,
        "sender_full_name": "Rithik Sharma",
        "timestamp": 1647949004
    },
    {
        "content": "<p>I have a question about generating target specific code from a newly added architecture.</p>\n<p>I am trying to generate code for my newly added architecture. and the issue is that it doesn't follow up the data layout specified for the architecture, instead it points out to some other target with other pointer sizes and generate error with wrong specification of target pointer sizes, the other target seems to be my machine on which I am running my Rust toolchain.</p>\n<p>How I should generate code specifically for a target?</p>",
        "id": 277850914,
        "sender_full_name": "Rithik Sharma",
        "timestamp": 1649151624
    },
    {
        "content": "<p>Did you set the <code>data-layout</code> field of the target spec correctly?</p>",
        "id": 277851136,
        "sender_full_name": "bjorn3",
        "timestamp": 1649151732
    },
    {
        "content": "<p>I already have a working LLVM toolchain of the specific arch, and I used the same data layout for the Rust toolchain.</p>",
        "id": 277851285,
        "sender_full_name": "Rithik Sharma",
        "timestamp": 1649151807
    },
    {
        "content": "<p>Is there code you could share? It's a bit too vague for me to help I think.</p>",
        "id": 277851411,
        "sender_full_name": "bjorn3",
        "timestamp": 1649151860
    },
    {
        "content": "<p>Umm sorry, I am afraid that I don't have permissions to share code about my bachelor's thesis until it is approved by the University. I can try telling you what I did in the past, and what I am hoping to do.</p>\n<p>I had an LLVM C/C++ tool-chain with our target X, I am calling it X for now. X is a fully functional tool-chain, and works perfectly with C/C++ use cases. X is not a up-streamed Target, and is not available in the Master or experimental version of LLVM. I want X target to be added to the Rust frontend, and to do so I statically linked the LLVM C/C++ toolchain via LLVM-Config option in Config.toml, after which I added X as an expermental target, and manually patched on the Rust toolchain. I used the same data layout which we had in the functional LLVM C/C++ toolchain, which resulted in:</p>\n<p><em>rustc src/main.rs --target=X</em></p>\n<p><em>error: inconsistent target specification: \"data-layout\" claims pointers are 32-bit, while \"target-pointer-width\" is <code>64</code></em></p>\n<p>Firstly, is this the correct way of adding new architecture to Rust? <br>\nSecondly, I want to generate target X specific code, and is this information enough?</p>",
        "id": 277853839,
        "sender_full_name": "Rithik Sharma",
        "timestamp": 1649153102
    },
    {
        "content": "<blockquote>\n<p>Umm sorry, I am afraid that I don't have permissions to share code about my bachelor's thesis until it is approved by the University.</p>\n</blockquote>\n<p>No problem.</p>\n<blockquote>\n<p>error: inconsistent target specification: \"data-layout\" claims pointers are 32-bit, while \"target-pointer-width\" is 64</p>\n</blockquote>\n<p>Is the data-layout you used something you can share?</p>\n<blockquote>\n<p>Firstly, is this the correct way of adding new architecture to Rust? </p>\n</blockquote>\n<p>There are two ways to define a new target spec. In compiler/rustc_target/src/spec in the rust source code and using a json file passed in through <code>--target</code>. As you need a custom LLVM toolchain anyway modifying compiler/rustc_target/src/spec makes sense.</p>",
        "id": 277856231,
        "sender_full_name": "bjorn3",
        "timestamp": 1649154511
    },
    {
        "content": "<p>e-m:e-i64:32-p:32:32-f64:32-n32-a:0:32-S64, this is the data layout.</p>\n<p>I read some text about data layout from here <a href=\"https://llvm.org/doxygen/ARMTargetMachine_8cpp_source.html#l00139\">https://llvm.org/doxygen/ARMTargetMachine_8cpp_source.html#l00139</a></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code>\n</code></pre></div>",
        "id": 277857148,
        "sender_full_name": "Rithik Sharma",
        "timestamp": 1649155084
    },
    {
        "content": "<p>x86_64-unknown-linux-gnu has <code>e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128</code> as data layout which roughly parses as</p>\n<ul>\n<li><code>e</code>: little endian</li>\n<li><code>m:e</code>: ELF symbol mangling</li>\n<li><code>p270:32:32</code>: pointers in the \"270\" address space (ptr32_sptr according to <a href=\"https://github.com/llvm/llvm-project/blob/dc152659b4527cc2e5f75cc33f36df67c7d5db26/clang/lib/Basic/Targets/X86.h#L43-L45\">https://github.com/llvm/llvm-project/blob/dc152659b4527cc2e5f75cc33f36df67c7d5db26/clang/lib/Basic/Targets/X86.h#L43-L45</a>) are 32bit and with a 32bit alignment</li>\n<li><code>p271:32:32</code>: pointers in the \"271\" address space (ptr32_uptr)are 32bit and with a 32bit alignment</li>\n<li><code>p272:64:64</code>: pointers in the \"272\" address space (ptr64) are 64bit and with a 64bit alignment</li>\n<li><code>i64:64</code>: 64bit ints are 64bit aligned</li>\n<li><code>f80:128</code>: 80bit floats are 128bit aligned</li>\n<li><code>n8:16:32:64</code>: native integer widths are 8bit, 16bit, 32bit, 64bit. According to the LLVM docs \"Elements of this set are considered to support most general arithmetic operations efficiently.\"</li>\n<li><code>S128</code>: natural stack alignment is 128bit</li>\n</ul>",
        "id": 277857172,
        "sender_full_name": "bjorn3",
        "timestamp": 1649155103
    },
    {
        "content": "<p>Right, you need to set <code>target_pointer_width</code> in the target spec to 32.</p>",
        "id": 277857256,
        "sender_full_name": "bjorn3",
        "timestamp": 1649155171
    },
    {
        "content": "<p>I already passed 32 as pointer width, but still faces the error shared above.</p>",
        "id": 277857378,
        "sender_full_name": "Rithik Sharma",
        "timestamp": 1649155248
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"482770\">Rithik Sharma</span> <a href=\"#narrow/stream/122652-new-members/topic/how.20to.20do.20alternative.20LLVM.20targets/near/277853839\">said</a>:</p>\n<blockquote>\n<p>Umm sorry, I am afraid that I don't have permissions to share code about my bachelor's thesis until it is approved by the University.</p>\n</blockquote>\n<p>You should check with your thesis advisor about the school policy here, if you haven't already. There's a lot of people here who can probably help you at lot, but it will help <em>us</em> a lot if you can be more open about what you are doing, the same way we are open about what we are doing.</p>\n<p>Even if the school policy does indeed bar you from sharing the code underlying your work, I'm sure your advisor would have advice for you on how to reduce the problems you are facing in the near term into smaller bits of code you <em>could</em> share with us that would help us understand what you are doing.</p>",
        "id": 277862013,
        "sender_full_name": "pnkfelix",
        "timestamp": 1649158002
    },
    {
        "content": "<p>(to be clear: you have no <em>obligation</em> to share it. I'm just saying I don't want you to have artificial barriers to getting external help, especially when it comes to academic work on an open source project.)</p>",
        "id": 277862467,
        "sender_full_name": "pnkfelix",
        "timestamp": 1649158224
    },
    {
        "content": "<p>I completely agree with you that the community would be beneficial in solving these challenges. I will have a conversation with the advisor about this. My advisor has an excellent compiler background but is very new to Rust and wanted me to explore this part and support our target on the Rust frontend.</p>",
        "id": 277867325,
        "sender_full_name": "Rithik Sharma",
        "timestamp": 1649160648
    }
]