[
    {
        "content": "<p>Hey all! I'm just jumping on off the back of <a href=\"https://twitter.com/jsbarretto/status/1499783123785113614\">this</a> Twitter conversation. I noticed that MIR's constant folding pass doesn't currently have the ability to represent partially-known values (at least, from a cursory glance at <code>rustc_middle::interpret</code>, but perhaps I've missed something). This feels like a missed opportunity, because a significant proportion of values in real Rust code contain both constant and runtime values at once, and yet their constant elements still provide useful information that can inform optimisations. Given that this should be a relatively easy thing to implement (barring details like side-effects), are there any thoughts about implementing such a pass (or generalising the existing const folding pass) in rustc?</p>\n<div class=\"inline-preview-twitter\"><div class=\"twitter-tweet\"><a href=\"https://twitter.com/jsbarretto/status/1499783123785113614\"><img class=\"twitter-avatar\" src=\"https://uploads.zulipusercontent.net/2209907fa6da1c03ea6bda27d066c38912d39cf6/68747470733a2f2f7062732e7477696d672e636f6d2f70726f66696c655f696d616765732f313430383036363037373737393538323938342f4d4c496f545367535f6e6f726d616c2e6a7067\"></a><p><a href=\"https://twitter.com/steveklabnik\">@steveklabnik</a> <a href=\"https://twitter.com/workingjubilee\">@workingjubilee</a> Do you know whether it was/is full symbolic execution, or just const propagation? I implemented the former in my compiler the other day and I was surprised at how unreasonably effective it was given the simplicity of its implementation (not much harder than const propagation).</p><span>- Joshua Barretto (@jsbarretto)</span></div></div>",
        "id": 274157457,
        "sender_full_name": "Joshua Barretto",
        "timestamp": 1646413076
    },
    {
        "content": "<p>Though there is undoubtedly a lot that could be improved with the ConstProp pass (ie: implementing LVN / GVN instead), I think the issue you raise is at least partially sidestepped by the optimization running after de-aggregation</p>",
        "id": 274158380,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1646413412
    },
    {
        "content": "<p>which means we assign individual fields of enums / structs rather than doing it all at once</p>",
        "id": 274158648,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1646413530
    },
    {
        "content": "<p>I believe this should allow the constprop to take advantage of a single field being constant</p>",
        "id": 274158682,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1646413547
    },
    {
        "content": "<p>but I'm not familiar enough with the code / behavior</p>",
        "id": 274158692,
        "sender_full_name": "Xavier Denis",
        "timestamp": 1646413556
    },
    {
        "content": "<p>So, I happened to be reading this code yesterday, and there's a FIXME in there noting exactly this point (which also caused me pain, see <a href=\"https://github.com/rust-lang/rust/issues/94590\">#94590</a>). From an initial reading, this is non-trivial to fix though, because the memory that const prop uses is per-local, and tracking exactly what is known and what isn't seems difficult</p>",
        "id": 274159388,
        "sender_full_name": "Jake",
        "timestamp": 1646413857
    },
    {
        "content": "<p>At the same time, I don't think it's possible to actually fix this in the current pass in a backwards compatible way. The problem is that const prop also emits lints, including deny-by-default lints, and adding more const prop means emitting more lints</p>",
        "id": 274159818,
        "sender_full_name": "Jake",
        "timestamp": 1646414042
    },
    {
        "content": "<p>So I would absolutely love if someone revisited that pass and tried to improve it, but it seems like the first thing to do is to separate out the optimizations and the linting</p>",
        "id": 274160027,
        "sender_full_name": "Jake",
        "timestamp": 1646414135
    },
    {
        "content": "<p>There is also design work to be done here though. For example, currently const prop runs after some optimizations, and that seems like it's not a great idea, since now other optimizations causing changes to the MIR might accidentally cause more lints to be emitted.</p>",
        "id": 274160869,
        "sender_full_name": "Jake",
        "timestamp": 1646414487
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"312719\">Xavier Denis</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274158380\">said</a>:</p>\n<blockquote>\n<p>Though there is undoubtedly a lot that could be improved with the ConstProp pass (ie: implementing LVN / GVN instead), I think the issue you raise is at least partially sidestepped by the optimization running after de-aggregation</p>\n</blockquote>\n<p>Is there anywhere I can read more about this? I feel like my mental model of the const propagation pass is missing something. In my compiler, I just have a <a href=\"https://github.com/zesterer/tao/blob/master/middle/src/mir.rs#L15-L30\">generic constant type</a> parameterised with a potentially-uninhabited <code>Unknown</code> variant that allows for representing partial constants <a href=\"https://github.com/zesterer/tao/blob/master/middle/src/opt/const_fold.rs\">during propagation</a>. This is then used to inform later optimisations.</p>",
        "id": 274161356,
        "sender_full_name": "Joshua Barretto",
        "timestamp": 1646414690
    },
    {
        "content": "<p>It would be helpful to give an example of where the <code>Unknown</code> variant shows up and how you use it in optimizations.</p>",
        "id": 274162276,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646415094
    },
    {
        "content": "<p>Deaggregation sort of splits structs/tuples/etc into their constituent fields and provides more opportunities for optimizations like the const-prop pass to run even if we have runtime values. Ie, we can turn </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">foo</span><span class=\"p\">(</span><span class=\"n\">x</span>: <span class=\"kt\">u32</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">u32</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">.</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"mi\">42</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>into</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">foo</span><span class=\"p\">(</span><span class=\"n\">x</span>: <span class=\"kt\">u32</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">u32</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"mi\">42</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 274162977,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646415439
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125250\">Wesley Wiser</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274162276\">said</a>:</p>\n<blockquote>\n<p>It would be helpful to give an example of where the <code>Unknown</code> variant shows up and how you use it in optimizations.</p>\n</blockquote>\n<p><code>Unknown</code> shows up whenever a non-constant value appears (i.e: a function parameter). The const propagation pass then effectively walks through the code as if it were executing it, treating <code>Unknown</code> values as if they were real values.</p>\n<p>You can see <a href=\"https://github.com/zesterer/tao/blob/master/middle/src/opt/const_fold.rs#L129\">here</a> that a <code>Unknown</code> gets pushed to the locals stack when const evaluating a lambda body, representing a value that's not known until run-time.</p>\n<p>For example, this allows me to flatten the following into the identity function (I've translated it to Rust for the sake of simplicity):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">foo</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">x</span>: <span class=\"nc\">T</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">T</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>(it would also perform the optimisation you mentioned too)</p>\n<p>This works pretty well for a lot of code like this and turned out to be <a href=\"https://github.com/zesterer/tao/blob/master/middle/src/opt/const_fold.rs\">very simple to implement</a>. In addition, it seems like it's going to generalise to a lot more cases where I have some knowledge of a value (i.e: a set or range of possible values).</p>\n<p><span class=\"user-mention silent\" data-user-id=\"125250\">Wesley Wiser</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274162977\">said</a>:</p>\n<blockquote>\n<p>Deaggregation sort of splits structs/tuples/etc into their constituent fields and provides more opportunities for optimizations like the const-prop pass to run even if we have runtime values. Ie,</p>\n</blockquote>\n<p>It sounds like you're doing something relatively similar, if not the same thing. Perhaps we're talking about the same optimisation, but for me the implementation was quite simple: I just mirror possible runtime values with an enum and execute the code symbolically as if it were dynamically-typed, and these sort of opportunities for optimisation just drop out of this process without much work.</p>",
        "id": 274169071,
        "sender_full_name": "Joshua Barretto",
        "timestamp": 1646418285
    },
    {
        "content": "<p>Ah, that sounds conceptually similar to this part then <a href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/const_prop.rs#L247\">https://github.com/rust-lang/rust/blob/master/compiler/rustc_mir_transform/src/const_prop.rs#L247</a></p>",
        "id": 274172737,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646419795
    },
    {
        "content": "<p>\"Uninitialized\" in this context means we don't know what the value is.</p>",
        "id": 274172820,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646419823
    },
    {
        "content": "<p>Between the deaggregation and handling uninitialized values, I think we do pretty much the same thing.</p>",
        "id": 274172886,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646419875
    },
    {
        "content": "<p>Ah, I forgot. This doesn't work for enum discriminants.</p>",
        "id": 274173007,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646419932
    },
    {
        "content": "<p>That is something we should handle better.</p>",
        "id": 274173052,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646419957
    },
    {
        "content": "<p>Yes, and there's a rather lot of issues that basically say something to the effect of \"eesh, we could do so much better for pattern matching\".</p>",
        "id": 274174512,
        "sender_full_name": "Jubilee",
        "timestamp": 1646420614
    },
    {
        "content": "<p>Writing correct MIR opts is hard <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 274175202,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646420962
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281757\">Jubilee</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274174512\">said</a>:</p>\n<blockquote>\n<p>Yes, and there's a rather lot of issues that basically say something to the effect of \"eesh, we could do so much better for pattern matching\".</p>\n</blockquote>\n<p>Yeah, this is one of the things I most want to work on. LLVM is just not set up to figure out the optimizations around matching that we want</p>",
        "id": 274176194,
        "sender_full_name": "Jake",
        "timestamp": 1646421445
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310518\">Jake</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274159818\">said</a>:</p>\n<blockquote>\n<p>At the same time, I don't think it's possible to actually fix this in the current pass in a backwards compatible way. The problem is that const prop also emits lints, including deny-by-default lints, and adding more const prop means emitting more lints</p>\n</blockquote>\n<p>If it's just new lints, that's allowed, even if they're deny-by-default.</p>\n<p>(Only new hard errors are <em>de jure</em> breaking changes.)</p>",
        "id": 274176339,
        "sender_full_name": "scottmcm",
        "timestamp": 1646421510
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125270\">scottmcm</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274176339\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310518\">Jake</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274159818\">said</a>:</p>\n<blockquote>\n<p>At the same time, I don't think it's possible to actually fix this in the current pass in a backwards compatible way. The problem is that const prop also emits lints, including deny-by-default lints, and adding more const prop means emitting more lints</p>\n</blockquote>\n<p>If it's just new lints, that's allowed, even if they're deny-by-default.</p>\n<p>(Only new hard errors are <em>de jure</em> breaking changes.)</p>\n</blockquote>\n<p>oh hmm, I didn't know that. That's definitely a good sign, but this still seems less than ideal regardless. Even if lints are allowed to change in either direction, compiler output changing when optimizations are added/removed feels kinda meh</p>",
        "id": 274177433,
        "sender_full_name": "Jake",
        "timestamp": 1646422121
    },
    {
        "content": "<p>Yeah, it's basically a necessary implication of \"stability without stagnation\".  If new lints are a breaking change, we de facto can't even fix accidentally-missing-warnings, and that's intolerable.  And users can even make allow-by-default lints into build failures with attributes or compiler flags, so it's not even just deny ones where this applies.</p>\n<p>But as always, we try to be smart about the practical impact of things.  I agree that different linting depending on optimization levels and such would be a poor user experience, and it would be better to avoid it.</p>",
        "id": 274177942,
        "sender_full_name": "scottmcm",
        "timestamp": 1646422371
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125250\">Wesley Wiser</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274173007\">said</a>:</p>\n<blockquote>\n<p>Ah, I forgot. This doesn't work for enum discriminants.</p>\n</blockquote>\n<p>This is something I've wanted to improve more generally in MIR potentially by making the discriminant a place projection instead of an Rvalue &amp; SetDiscriminant statement.</p>",
        "id": 274178522,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646422644
    },
    {
        "content": "<p>We generate some incredibly ugly LLVM IR right now to do basic things like match niche layout enums and I don't see a good way right now to fix that.</p>",
        "id": 274178678,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646422700
    },
    {
        "content": "<p>This </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">foo</span><span class=\"p\">(</span><span class=\"n\">o</span>: <span class=\"nb\">Option</span><span class=\"o\">&lt;&amp;'</span><span class=\"nb\">static</span><span class=\"w\"> </span><span class=\"kt\">u32</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">i32</span> <span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"nb\">None</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"mi\">21</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>turns into</p>\n<div class=\"codehilite\" data-code-language=\"LLVM\"><pre><span></span><code><span class=\"c\">; playground::foo</span>\n<span class=\"c\">; Function Attrs: nonlazybind uwtable</span>\n<span class=\"k\">define</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"vg\">@_ZN10playground3foo17hfb059510df235295E</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"k\">dereferenceable_or_null</span><span class=\"p\">(</span><span class=\"m\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">unnamed_addr</span><span class=\"w\"> </span><span class=\"vg\">#0</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!6</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"nl\">start:</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">alloca</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv\">%o</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">alloca</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">store</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">**</span><span class=\"w\"> </span><span class=\"nv\">%o</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">call</span><span class=\"w\"> </span><span class=\"k\">void</span><span class=\"w\"> </span><span class=\"vg\">@llvm.dbg.declare</span><span class=\"p\">(</span><span class=\"k\">metadata</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">**</span><span class=\"w\"> </span><span class=\"nv\">%o</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">metadata</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">metadata</span><span class=\"w\"> </span><span class=\"nv\">!DIExpression</span><span class=\"p\">()),</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!33</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%2</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">bitcast</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">**</span><span class=\"w\"> </span><span class=\"nv\">%o</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"p\">{}**,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!34</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%3</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">load</span><span class=\"w\"> </span><span class=\"p\">{}*,</span><span class=\"w\"> </span><span class=\"p\">{}**</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!34</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%4</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">icmp</span><span class=\"w\"> </span><span class=\"k\">eq</span><span class=\"w\"> </span><span class=\"p\">{}*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!34</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv\">%_2</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">select</span><span class=\"w\"> </span><span class=\"kt\">i1</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!34</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">switch</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"nv\">%_2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">label</span><span class=\"w\"> </span><span class=\"nv\">%bb2</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">label</span><span class=\"w\"> </span><span class=\"nv\">%bb1</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">label</span><span class=\"w\"> </span><span class=\"nv\">%bb3</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!35</span><span class=\"w\"></span>\n\n<span class=\"nl\">bb2:</span><span class=\"w\">                                              </span><span class=\"c\">; preds = %start</span>\n<span class=\"w\">  </span><span class=\"k\">unreachable</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!34</span><span class=\"w\"></span>\n\n<span class=\"nl\">bb1:</span><span class=\"w\">                                              </span><span class=\"c\">; preds = %start</span>\n<span class=\"w\">  </span><span class=\"k\">store</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"m\">21</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!36</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">br</span><span class=\"w\"> </span><span class=\"kt\">label</span><span class=\"w\"> </span><span class=\"nv\">%bb4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!36</span><span class=\"w\"></span>\n\n<span class=\"nl\">bb3:</span><span class=\"w\">                                              </span><span class=\"c\">; preds = %start</span>\n<span class=\"w\">  </span><span class=\"k\">store</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"m\">42</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!37</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">br</span><span class=\"w\"> </span><span class=\"kt\">label</span><span class=\"w\"> </span><span class=\"nv\">%bb4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!37</span><span class=\"w\"></span>\n\n<span class=\"nl\">bb4:</span><span class=\"w\">                                              </span><span class=\"c\">; preds = %bb1, %bb3</span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%5</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">load</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!38</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">ret</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!38</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>when we should be able to combine the discriminant extract &amp; branch together.</p>\n<div class=\"codehilite\" data-code-language=\"LLVM\"><pre><span></span><code><span class=\"c\">; playground::foo</span>\n<span class=\"c\">; Function Attrs: nonlazybind uwtable</span>\n<span class=\"k\">define</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"vg\">@_ZN10playground3foo17hfb059510df235295E</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"> </span><span class=\"k\">dereferenceable_or_null</span><span class=\"p\">(</span><span class=\"m\">4</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">unnamed_addr</span><span class=\"w\"> </span><span class=\"vg\">#0</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!6</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"nl\">start:</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">alloca</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv\">%o</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">alloca</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">store</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">**</span><span class=\"w\"> </span><span class=\"nv\">%o</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">call</span><span class=\"w\"> </span><span class=\"k\">void</span><span class=\"w\"> </span><span class=\"vg\">@llvm.dbg.declare</span><span class=\"p\">(</span><span class=\"k\">metadata</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">**</span><span class=\"w\"> </span><span class=\"nv\">%o</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">metadata</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">metadata</span><span class=\"w\"> </span><span class=\"nv\">!DIExpression</span><span class=\"p\">()),</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!33</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%2</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">bitcast</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">**</span><span class=\"w\"> </span><span class=\"nv\">%o</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"p\">{}**,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!34</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%3</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">load</span><span class=\"w\"> </span><span class=\"p\">{}*,</span><span class=\"w\"> </span><span class=\"p\">{}**</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!34</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%4</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">icmp</span><span class=\"w\"> </span><span class=\"k\">eq</span><span class=\"w\"> </span><span class=\"p\">{}*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!34</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">br</span><span class=\"w\"> </span><span class=\"kt\">i1</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">label</span><span class=\"w\"> </span><span class=\"nv\">%bb1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">label</span><span class=\"w\"> </span><span class=\"nv\">%bb3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!35</span><span class=\"w\"></span>\n\n<span class=\"nl\">bb1:</span><span class=\"w\">                                              </span><span class=\"c\">; preds = %start</span>\n<span class=\"w\">  </span><span class=\"k\">store</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"m\">21</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!36</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">br</span><span class=\"w\"> </span><span class=\"kt\">label</span><span class=\"w\"> </span><span class=\"nv\">%bb3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!36</span><span class=\"w\"></span>\n\n<span class=\"nl\">bb2:</span><span class=\"w\">                                              </span><span class=\"c\">; preds = %start</span>\n<span class=\"w\">  </span><span class=\"k\">store</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"m\">42</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!37</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">br</span><span class=\"w\"> </span><span class=\"kt\">label</span><span class=\"w\"> </span><span class=\"nv\">%bb3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!37</span><span class=\"w\"></span>\n\n<span class=\"nl\">bb3:</span><span class=\"w\">                                              </span><span class=\"c\">; preds = %bb1, %bb3</span>\n<span class=\"w\">  </span><span class=\"nv nv-Anonymous\">%5</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">load</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">*</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!38</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">ret</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!38</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>or something like that.</p>",
        "id": 274180156,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646423477
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125250\">Wesley Wiser</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274178522\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"125250\">Wesley Wiser</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274173007\">said</a>:</p>\n<blockquote>\n<p>Ah, I forgot. This doesn't work for enum discriminants.</p>\n</blockquote>\n<p>This is something I've wanted to improve more generally in MIR potentially by making the discriminant a place projection instead of an Rvalue &amp; SetDiscriminant statement.</p>\n</blockquote>\n<p>I would be rather strongly opposed to this, because I don't see how to make it compatible with more general layout optimizations. Citing an example from <a href=\"https://github.com/rust-lang/rust/issues/91095\">#91095</a> that I posted there yesterday, in the future we presumably will want to layout optimize</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">enum</span> <span class=\"nc\">E</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">A</span><span class=\"p\">(</span><span class=\"n\">NonZeroU8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">u8</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">C</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>into</p>\n<div class=\"codehilite\"><pre><span></span><code>A(x, y) =&gt; [x, y],\nB =&gt; [0, 1],\nC =&gt; [0, 0],\n</code></pre></div>\n<p>I don't see how to allow this kind of optimization while having the discriminant be a place. It's particularly interesting to also imagine the case where we have <code>UnsafeCell&lt;u8&gt;</code> instead of <code>u8</code> in the field, which still allows this optimization, but <em>really</em> doesn't allow the discriminant to be a place.</p>",
        "id": 274180261,
        "sender_full_name": "Jake",
        "timestamp": 1646423535
    },
    {
        "content": "<p>I have some work done with more general layout optimizations that I think could be a first step towards allowing us to improve this. I may try and revisit that, although I sort of burned out working on that code, so I might just have to share the ideas for the model and the partial implementation</p>",
        "id": 274180392,
        "sender_full_name": "Jake",
        "timestamp": 1646423615
    },
    {
        "content": "<p>With regards to how we can improve matching codegen, I think one thing that would help greatly is introducing a <code>byte</code> type in MIR, which would then allow implementing <code>discriminant</code> in MIR, instead of in codegen. That seems like a principled thing to do anyway, since it reduces the complexity of codegen, and also it will allow us to work on improving matching code with MIR opts and similar tools that we have more control over</p>",
        "id": 274180695,
        "sender_full_name": "Jake",
        "timestamp": 1646423767
    },
    {
        "content": "<p>Note that we want to move the linting part of const prop earlier so that the actual const prop opt part can go crazy without causing diagnostic changes</p>",
        "id": 274181101,
        "sender_full_name": "oli",
        "timestamp": 1646423979
    },
    {
        "content": "<p>If you want to do that, I'm happy to mentor.</p>",
        "id": 274181142,
        "sender_full_name": "oli",
        "timestamp": 1646423995
    },
    {
        "content": "<p>If OP doesn't want to do it, I'd volunteer for that as well</p>",
        "id": 274181574,
        "sender_full_name": "Jake",
        "timestamp": 1646424154
    },
    {
        "content": "<p><code>Discriminant</code> can't be implemented in MIR as the exact codegen depends on the layout of the type which may differ depending on generic parameters.</p>",
        "id": 274181888,
        "sender_full_name": "bjorn3",
        "timestamp": 1646424319
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133247\">bjorn3</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274181888\">said</a>:</p>\n<blockquote>\n<p><code>Discriminant</code> can't be implemented in MIR as the exact codegen depends on the layout of the type which may differ depending on generic parameters.</p>\n</blockquote>\n<p>oh, crap. I wonder how much it would help to do this just for non-generic types. Feel like that might lead to too much code duplication though</p>",
        "id": 274182087,
        "sender_full_name": "Jake",
        "timestamp": 1646424425
    },
    {
        "content": "<blockquote>\n<p>I would be rather strongly opposed to this, because I don't see how to make it compatible with more general layout optimizations.</p>\n</blockquote>\n<p>I'll freely admit I have not put much thought into this but in my head, the proposed semantics would be that <code>discriminant(place)</code> refers to a place of type <code>Discriminant</code> (or perhaps <code>Discriminant&lt;EnumTy&gt;</code>). Therefore, the MIR would still be layout agnostic as it is today.</p>",
        "id": 274183315,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646425026
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125250\">Wesley Wiser</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274183315\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>I would be rather strongly opposed to this, because I don't see how to make it compatible with more general layout optimizations.</p>\n</blockquote>\n<p>I'll freely admit I have not put much thought into this but in my head, the proposed semantics would be that <code>discriminant(place)</code> refers to a place of type <code>Discriminant</code> (or perhaps <code>Discriminant&lt;EnumTy&gt;</code>). Therefore, the MIR would still be layout agnostic as it is today.</p>\n</blockquote>\n<p>So, just trying to understand, what would the size/layout of this place be for <code>Option&lt;NonZeroU8&gt;</code>?</p>",
        "id": 274183730,
        "sender_full_name": "Jake",
        "timestamp": 1646425269
    },
    {
        "content": "<p>It would effectively be an <code>isize</code> just like it is right now in MIR.</p>",
        "id": 274184158,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646425520
    },
    {
        "content": "<p>oh I see what you're saying</p>",
        "id": 274184533,
        "sender_full_name": "Jake",
        "timestamp": 1646425733
    },
    {
        "content": "<p>Well, I guess it's kind of weird right now in MIR anyway. <code>SetDiscriminant()</code> takes an integer (the discriminant id). The \"read discriminant\" rvalue returns an <code>isize</code>.</p>",
        "id": 274184561,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646425747
    },
    {
        "content": "<p>It might be conceptually nice if both of those operations used the same data types (and instead of isize, perhaps something more strongly typed like a <code>Discriminant&lt;EnumType&gt;</code> type which is still just a wrapper over the discriminant id would be better).</p>",
        "id": 274184818,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646425865
    },
    {
        "content": "<p>I don't <em>think</em> I'm proposing anything too crazy. It's mostly just moving around the operations we already have.</p>",
        "id": 274184864,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646425899
    },
    {
        "content": "<p>Yeah, that might totally work. I do wonder about the side-effects of having a \"place\" which isn't actually a place for mir opts and such, but possibly it'll be fine.</p>",
        "id": 274184980,
        "sender_full_name": "Jake",
        "timestamp": 1646425954
    },
    {
        "content": "<p>Oh, totally! I'm not 100% sure it's a good idea.</p>",
        "id": 274185229,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646426152
    },
    {
        "content": "<p>It could make somethings like the thing I mentioned originally easier but we'd have to consider all the ramifications before going ahead with it. </p>\n<p><span class=\"user-mention silent\" data-user-id=\"125250\">Wesley Wiser</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274173007\">said</a>:</p>\n<blockquote>\n<p>Ah, I forgot. This doesn't work for enum discriminants.</p>\n</blockquote>",
        "id": 274185342,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1646426214
    },
    {
        "content": "<p>On a related note, have we ever considered disallowing more than one <code>Deref</code> projection per place? That is also the kind of thing that seems like it introduces complexity where it's not necessarily needed</p>",
        "id": 274185865,
        "sender_full_name": "Jake",
        "timestamp": 1646426527
    },
    {
        "content": "<p>The niche encoding is major complication for any optimization around discriminants, since in that case SetDiscriminant becomes partially a fiction, and encoded discriminant aliases with some of the fields.</p>",
        "id": 274196135,
        "sender_full_name": "tm",
        "timestamp": 1646432321
    },
    {
        "content": "<blockquote>\n<p>On a related note, have we ever considered disallowing more than one <code>Deref</code> projection per place? That is also the kind of thing that seems like it introduces complexity where it's not necessarily needed</p>\n</blockquote>\n<p>Yea, we had whole design docs around it, but I forgot where they are. Maybe in the compiler team hackmds?</p>",
        "id": 274200306,
        "sender_full_name": "oli",
        "timestamp": 1646434817
    },
    {
        "content": "<p>There should be threads on here, too</p>",
        "id": 274200399,
        "sender_full_name": "oli",
        "timestamp": 1646434847
    },
    {
        "content": "<p>It sounds like quite a few problems and unmet potential appears as a result of MIR being pre-monomorphisation. Has there ever been consideration put towards splitting the MIR (or making it generic over the existence of generic parameters, or having a whole other IR) that allows post-monomorphisation optimisation? I imagine that this would start to really come into its own when considering that this allows for inlining trait methods and reasoning about the value of trait constants.</p>\n<p>Personally, I deliberately went for a post-monomorphisation MIR in my language because it allowed me to massively reduce the surface area of the MIR (no typeclasses, generic types, self types, unknown typeclass constants, type projections, type layout ambiguity, etc.) which makes writing optimisation passes significantly easier and exploiting optimisations easier too, at the cost of some duplicated compile-time work compared to a pre-monomorphisation MIR.</p>",
        "id": 274242319,
        "sender_full_name": "Joshua Barretto",
        "timestamp": 1646485265
    },
    {
        "content": "<p>The whole point of mir optimizations is to do optimizations before monomorphization. This means that optimizations don't have to be repeated for every monomorphization, unlike for optimizations at llvm level. LLVM can already do almost every optimization currently done on MIR.</p>",
        "id": 274245283,
        "sender_full_name": "bjorn3",
        "timestamp": 1646489181
    },
    {
        "content": "<blockquote>\n<p>Note that we want to move the linting part of const prop earlier so that the actual const prop opt part can go crazy without causing diagnostic changes</p>\n</blockquote>\n<p>I just got informed i'll have a paid full time mentee for the next three weeks, so he'll work on the initial split of const prop.</p>",
        "id": 274245616,
        "sender_full_name": "oli",
        "timestamp": 1646489657
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"133247\">bjorn3</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274245283\">said</a>:</p>\n<blockquote>\n<p>LLVM can already do almost every optimization currently done on MIR.</p>\n</blockquote>\n<p>Fair enough. The implication I read from previously discussion, perhaps erroneously, was that LLVM struggles to optimise things like <code>match</code> expressions because it understands less about the semantics of Rust and what values are representable. I thought that optimising this post-monomorphisation would provide even more information about representation, allowing us to catch some of this. If, as you say, LLVM is capable of optimising these things just fine then this isn't relevant of course.</p>",
        "id": 274248514,
        "sender_full_name": "Joshua Barretto",
        "timestamp": 1646493282
    },
    {
        "content": "<p>That one is the only MIR optimization LLVM can't do I believe.</p>",
        "id": 274248930,
        "sender_full_name": "bjorn3",
        "timestamp": 1646493749
    },
    {
        "content": "<p>The thing about <code>match</code> that LLVM has trouble with today around enums that comes to mind for me is, as far as I can tell from <span class=\"user-mention silent\" data-user-id=\"133224\">Nikita Popov</span>'s comment in <a href=\"https://github.com/rust-lang/rust/issues/85133#issuecomment-1053701216\">https://github.com/rust-lang/rust/issues/85133#issuecomment-1053701216</a>, \"just\" a bug.  Whether or not it's an easy fix I don't know, but it seems like it should be possible.  We're already giving it sufficient information (via <code>!range</code> metadata and <code>unreachable</code> blocks) to be able to do better.</p>\n<p>There might be more though; I don't know.</p>",
        "id": 274263259,
        "sender_full_name": "scottmcm",
        "timestamp": 1646512020
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125270\">scottmcm</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Better.20constant.20folding/near/274263259\">said</a>:</p>\n<blockquote>\n<p>The thing about <code>match</code> that LLVM has trouble with today around enums that comes to mind for me is, as far as I can tell from <span class=\"user-mention silent\" data-user-id=\"133224\">Nikita Popov</span>'s comment in <a href=\"https://github.com/rust-lang/rust/issues/85133#issuecomment-1053701216\">https://github.com/rust-lang/rust/issues/85133#issuecomment-1053701216</a>, \"just\" a bug.  Whether or not it's an easy fix I don't know, but it seems like it should be possible.  We're already giving it sufficient information (via <code>!range</code> metadata and <code>unreachable</code> blocks) to be able to do better.</p>\n<p>There might be more though; I don't know.</p>\n</blockquote>\n<p>Actually, I'm now wondering if <a href=\"https://github.com/rust-lang/rust/issues/94590\">#94590</a> will help LLVM reason about matches better (if we were to actually emit the <code>uninit</code> writes). I've never touched codegen, but might try and change that to see how it affects perf</p>",
        "id": 274263781,
        "sender_full_name": "Jake",
        "timestamp": 1646512634
    }
]