[
    {
        "content": "<p>I was going to submit a bunch of individual PRs to improve documentation of MIR semantics, but after having accidentally written contradictory things like three times I figured that would involve too much after the fact editing, so I dumped all the things I knew/could figure out into a repo: <a href=\"https://github.com/JakobDegen/mir-docs\">https://github.com/JakobDegen/mir-docs</a>. The hope is that the things in there are overwhelmingly true already (unanswered questions are explicitly marked as such).</p>\n<p>As I said, the original intent was to break the result of this up into PRs that could be discussed individually and go into API docs or somewhere (the structure is pretty obviously designed for that purpose), but I'm now wondering if it might be better to reorganize things, combine this with existing docs, and create some kind of dedicated place for MIR semantics documentation. Both ways have their advantages though, and I don't know enough to have an opinion between them.</p>",
        "id": 275747602,
        "sender_full_name": "Jake",
        "timestamp": 1647564448
    },
    {
        "content": "<p>Oh also, i did my best to distinguish between things that are unclear in Rust vs things that are unclear in MIR. I'm not convinced I was entirely successful with that though, especially around the places/operands area. That in particular should be very heavily scrutinized before we merge any of it</p>",
        "id": 275749078,
        "sender_full_name": "Jake",
        "timestamp": 1647565900
    },
    {
        "content": "<blockquote>\n<p>It is - in principle - acceptable to produce MIR that exhibits undefined behavior - of course, you should not introduce UB where there was none in the past, as that will cause the user's code to be miscompiled.</p>\n</blockquote>\n<p>Do you have an example of this? I would hope that this is not the case currently (and that we can continue to keep it that way)...</p>",
        "id": 275756297,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1647574155
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"271719\">Mario Carneiro</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/MIR.20Docs/near/275756297\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>It is - in principle - acceptable to produce MIR that exhibits undefined behavior - of course, you should not introduce UB where there was none in the past, as that will cause the user's code to be miscompiled.</p>\n</blockquote>\n<p>Do you have an example of this? I would hope that this is not the case currently (and that we can continue to keep it that way)...</p>\n</blockquote>\n<p>I mean... all code that is UB in Rust produces MIR that is UB. We still compile it</p>",
        "id": 275756637,
        "sender_full_name": "Jake",
        "timestamp": 1647574622
    },
    {
        "content": "<p>(and every <code>unsafe</code> function is at least sometimes UB as far as the MIR for it knows)</p>",
        "id": 275756997,
        "sender_full_name": "Jake",
        "timestamp": 1647575038
    },
    {
        "content": "<p>Oh, I was under the standard assumption that the user's code doesn't have UB. But I suppose it's fair that even code with UB shouldn't cause an ICE</p>",
        "id": 275757706,
        "sender_full_name": "Mario Carneiro",
        "timestamp": 1647575787
    },
    {
        "content": "<p>Maybe there's a way to rephrase \"MIR that exhibits undefined behavior\", since I'm not sure I could say what \"exhibits\" means precisely here.</p>\n<p>Perhaps something like \"some MIR can trigger UB if executed, such as the <code>unreachable</code> terminator.  This must be preserved as-is through the <code>mir_for_miri</code> stage, to be able to report it to the user.  After that point, optimized MIR can use the fact that such code much be unreachable in optimizations, but of course must not introduce any UB on execution paths that were not already UB.\"</p>",
        "id": 275758209,
        "sender_full_name": "scottmcm",
        "timestamp": 1647576258
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"271719\">Mario Carneiro</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/MIR.20Docs/near/275757706\">said</a>:</p>\n<blockquote>\n<p>Oh, I was under the standard assumption that the user's code doesn't have UB. But I suppose it's fair that even code with UB shouldn't cause an ICE</p>\n</blockquote>\n<p>Yeah. I don't know what T-Lang's position is on turning UB into errors (probably that's a bad idea with an unfinished memory model), but ICEs are definitely a bad idea</p>",
        "id": 275758273,
        "sender_full_name": "Jake",
        "timestamp": 1647576363
    },
    {
        "content": "<p>\"For example, <code>addr_of!(*p)</code> should be retained to MIRI in order to detect null pointers, but can be folded to just <code>p</code> in optimized MIR.\"</p>",
        "id": 275758297,
        "sender_full_name": "scottmcm",
        "timestamp": 1647576384
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310518\">Jake</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/MIR.20Docs/near/275758273\">said</a>:</p>\n<blockquote>\n<p>T-Lang's position is on turning UB into errors</p>\n</blockquote>\n<p>UB in dead code is sound, so it's generally nigh impossible to actually do this (outside consts).</p>",
        "id": 275758327,
        "sender_full_name": "scottmcm",
        "timestamp": 1647576440
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125270\">scottmcm</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/MIR.20Docs/near/275758297\">said</a>:</p>\n<blockquote>\n<p>\"For example, <code>addr_of!(*p)</code> should be retained to MIRI in order to detect null pointers, but can be folded to just <code>p</code> in optimized MIR.\"</p>\n</blockquote>\n<p>Yeah, I would word this slightly less strongly though, since we do want to be able to run MIRI on optimized MIR. I think the right way to put it is probably that \"things that run at opt level zero should preserve all UB.\"</p>",
        "id": 275758399,
        "sender_full_name": "Jake",
        "timestamp": 1647576518
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125270\">scottmcm</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/MIR.20Docs/near/275758327\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"310518\">Jake</span> <a href=\"#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/MIR.20Docs/near/275758273\">said</a>:</p>\n<blockquote>\n<p>T-Lang's position is on turning UB into errors</p>\n</blockquote>\n<p>UB in dead code is sound, so it's generally nigh impossible to actually do this (outside consts).</p>\n</blockquote>\n<p>Oh, yeah, without knowing that a function is going to be invoked we can't do this, that's a good point</p>",
        "id": 275758412,
        "sender_full_name": "Jake",
        "timestamp": 1647576552
    },
    {
        "content": "<p>Generally the best we can do is lower the UB to <code>llvm.trap</code> so it's cheap to codegen and clearly blows up if it's not actually dead.</p>",
        "id": 275758420,
        "sender_full_name": "scottmcm",
        "timestamp": 1647576581
    },
    {
        "content": "<blockquote>\n<p>word this slightly less strongly though</p>\n</blockquote>\n<p>Maybe use the query names for it?  Since I'm trying to mention the existing phases, like <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.mir_for_ctfe\">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.mir_for_ctfe</a> vs <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.optimized_mir\">https://doc.rust-lang.org/nightly/nightly-rustc/rustc_middle/ty/context/struct.TyCtxt.html#method.optimized_mir</a></p>",
        "id": 275758494,
        "sender_full_name": "scottmcm",
        "timestamp": 1647576658
    },
    {
        "content": "<p>Ah, yeah. I've just been thinking in terms of <code>MirPhase</code>s, not query names, but using those is a good idea (and I should figure out and add to the documentation how they map to each other)</p>",
        "id": 275758582,
        "sender_full_name": "Jake",
        "timestamp": 1647576785
    },
    {
        "content": "<p>(Well, unless that conversation about stopping using queries happen <span aria-label=\"sweat\" class=\"emoji emoji-1f613\" role=\"img\" title=\"sweat\">:sweat:</span>)</p>",
        "id": 275758681,
        "sender_full_name": "scottmcm",
        "timestamp": 1647576946
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/issues/95320\">#95320</a> is up :)</p>",
        "id": 276695292,
        "sender_full_name": "Jak{e,ob} Degen",
        "timestamp": 1648254965
    }
]