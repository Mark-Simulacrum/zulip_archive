[
    {
        "content": "<p>When working for PR <a href=\"https://github.com/rust-lang/rust/issues/88018\">#88018</a> I discovered that <code>rustc_typeck</code> and <code>rustc_mir_build</code> has different expectations regarding the regions used in <code>ty::Const</code>. <code>rustc_mir_build</code> pretty much expects <code>ty::Const</code>'s ty to have all erased regions, while <code>rustc_typeck</code>'s current usage expects non-erased type. This discrepancy causes ICE in <a href=\"https://github.com/rust-lang/rust/issues/78174\">#78174</a>.</p>\n<p>My PR currently just creates a <code>from_anon_const_erased</code> which is supposed to be called during MIR building while the <code>from_anon_const</code>'ll be called from type checker. But I wonder if instead I should ensure that all regions in <code>ty::Const</code>'s ty to be erased, and then convert them to back <code>ReStatic</code> in type checker. I guess that should be okay since no regions other than <code>ReLateBound</code> and <code>ReStatic</code> should appear in constant's type?</p>",
        "id": 249535867,
        "sender_full_name": "Gary Guo",
        "timestamp": 1629070611
    },
    {
        "content": "<p>Hm, in the future constants might be able to refer to generic lifetime parameters of the surrounding context (similar to how they should be able to refer to generic type/const parameters)</p>",
        "id": 249558429,
        "sender_full_name": "RalfJ",
        "timestamp": 1629100040
    },
    {
        "content": "<p>erasing and later un-erasing also strikes me as conceptually the wrong approach</p>",
        "id": 249558521,
        "sender_full_name": "RalfJ",
        "timestamp": 1629100098
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"303710\">@Gary Guo</span> have you tried playing with <a href=\"https://github.com/rust-lang/rust/blob/3a24abd22fd25c836d8b4d75ff46c833f9c3934c/compiler/rustc_mir/src/transform/promote_consts.rs#L864\">this code</a>, e.g. using <code>re_static</code> there, as <span class=\"user-mention\" data-user-id=\"124288\">@oli</span> suggested?<br>\nI have no idea what that code does though...^^</p>",
        "id": 249559595,
        "sender_full_name": "RalfJ",
        "timestamp": 1629100936
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"120791\">RalfJ</span> <a href=\"#narrow/stream/146212-t-compiler.2Fconst-eval/topic/Regions.20in.20.60ty.3A.3AConst.60's.20ty/near/249559595\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"303710\">Gary Guo</span> have you tried playing with <a href=\"https://github.com/rust-lang/rust/blob/3a24abd22fd25c836d8b4d75ff46c833f9c3934c/compiler/rustc_mir/src/transform/promote_consts.rs#L864\">this code</a>, e.g. using <code>re_static</code> there, as <span class=\"user-mention silent\" data-user-id=\"124288\">oli</span> suggested?<br>\nI have no idea what that code does though...^^</p>\n</blockquote>\n<p>Lifetimes are all erased in MIR so that's not relevant</p>",
        "id": 249572129,
        "sender_full_name": "Gary Guo",
        "timestamp": 1629110078
    },
    {
        "content": "<p>well I can just quote what <span class=\"user-mention\" data-user-id=\"124288\">@oli</span> said^^</p>\n<blockquote>\n<p>From a cursory glance I would say it is promotion related. If someone wants to dig into this, dumping the MIR before mir borrowck and checking the exact lifetimes that show up is probably the right way. Maybe it is incorrect for us to use re_erased in <a href=\"http://promote_consts.rs\">promote_consts.rs</a>. It is ok to use in general, but in promotion we also use it for the substs of unevaluated constants that point to the promoted. These substs may have to be re_static</p>\n</blockquote>",
        "id": 249573491,
        "sender_full_name": "RalfJ",
        "timestamp": 1629111160
    },
    {
        "content": "<p>Well, I am pretty sure the issue is <code>type_of</code> returning <code>ReErased</code>, which isn't expected by the <a href=\"https://github.com/rust-lang/rust/blob/3a24abd22fd25c836d8b4d75ff46c833f9c3934c/compiler/rustc_mir/src/borrow_check/universal_regions.rs#L653\">borrow checker</a>.</p>",
        "id": 249574366,
        "sender_full_name": "Gary Guo",
        "timestamp": 1629111836
    },
    {
        "content": "<p>yeah the borrow checker should never call functions that return <code>ReErased</code></p>",
        "id": 249575197,
        "sender_full_name": "RalfJ",
        "timestamp": 1629112502
    },
    {
        "content": "<p>there is some kind of phase violation going on here</p>",
        "id": 249575207,
        "sender_full_name": "RalfJ",
        "timestamp": 1629112508
    }
]