[
    {
        "content": "<p>I'm working on <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/11547\">https://github.com/rust-analyzer/rust-analyzer/issues/11547</a><br>\nAnd I think I've realized that the line mentioned by Veykril should probably be removed all together.<br>\nThe line in question is (with pat renamed to pat2)<br>\n<code>(_pat, pat2) =&gt; if is_empty_expr(&amp;expr) =&gt; (pat2, expr2, expr)</code></p>\n<p>Which matches</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">pat</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">expr</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">pat2</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">expr2</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>To save you having to read the code, this code basically says that if the first match arm is an empty expression (like <code>{}</code>), then the resulting if let should be</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">pat2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">expr2</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>However this is only true if pat and pat2 are mutually exclusive. In the issue linked above pat = <code>'{'</code> and pat2 = <code>_</code>, and so they're not mutually exclusive, which is why the resulting code is wrong.<br>\nSo I'm wondering if I should just remove this branch altogether, or find a way to check if the two patterns are mutually exclusive, which seems difficult, or slow. An even more difficult method would be to somehow generate the pattern that would be mutually exclusive. That would let it handle cases like</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">(),</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">None</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>by generating a None(_) pattern for the if let. but this wouldn't be easy in cases like matching numbers, so I'm not sure it's worth it.</p>\n<p>What are your thoughts?</p>",
        "id": 273257413,
        "sender_full_name": "Ole Strohm",
        "timestamp": 1645809559
    },
    {
        "content": "<p>Right , that branch is correct actually(made a mistake when looking at it earlier it seems). So the problem here is actually as you've said the pattern in that if the pattern with the empty arm is more specific than the arm with the actual body we can't create an if let out of that.<br>\nIn this case we should just make the assist not be applicable here.(We could do some special stuff for option as you've said but that is just extra functionality that can be added on top)</p>",
        "id": 273258338,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1645809968
    },
    {
        "content": "<p>Is removing the second arm enough to have it keep on working for all the other tests? Then I'd say ye just remove it.</p>",
        "id": 273258448,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1645810019
    },
    {
        "content": "<p>Otherwise we probably want to look into addressing this specific problem by adding some extra checks</p>",
        "id": 273258484,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1645810045
    },
    {
        "content": "<p>I <em>think</em> the match checking algorithm can actually decide whether two patterns overlap, though I haven't thought about it in detail. it would also probably require a low-level API for the match check though</p>",
        "id": 273261616,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1645811505
    }
]