[
    {
        "content": "<p>hello! My library is using rowan and returns an AST which is a rowan SyntaxNode,  like so:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span> <span class=\"nc\">SyntaxTree</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"p\">(</span><span class=\"k\">crate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">ast</span>: <span class=\"nc\">rowan</span>::<span class=\"n\">SyntaxNode</span><span class=\"o\">&lt;</span><span class=\"n\">GraphQLLanguage</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"p\">(</span><span class=\"k\">crate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">errors</span>: <span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"k\">crate</span>::<span class=\"n\">Error</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>SyntaxNode is !Send, so my ast is !Send also, but my team is wanting to use it in a multithreaded environment. If I understand correctly, rust-analyzer is also multithreaded (maybe I am wrong!), and I wanted to ask how you are managing to get your ast being passed around multiple threads?</p>",
        "id": 268005009,
        "sender_full_name": "Irina Shestak (they/she)",
        "timestamp": 1642161952
    },
    {
        "content": "<p>The core of rowan is actually threadsafe, <code>SyntaxNode</code> is just a non threadsafe wrapper with extra ref counting around the actual threadsafe <code>GreenNode</code>s, see <a href=\"https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/syntax/src/lib.rs#L71-L76\">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/syntax/src/lib.rs#L71-L76</a> for some example usages. When we need a threadsafe tree we actually use the <code>GreenNode</code> and construct a <code>SyntaxNode</code> on demand with <code>SyntaxNode::new_root</code> from the <code>GreenNode</code></p>",
        "id": 268005564,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1642162338
    },
    {
        "content": "<p>To go from <code>SyntaxNode</code> to <code>GreenNode</code> its just a <code>syntax.green().to_owned()</code></p>",
        "id": 268005713,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1642162472
    },
    {
        "content": "<p>ah! I already use the <code>GreenNodeBuilder</code> when constructing the tree, and create the <code>SyntaxNode</code> on demand with <code>SyntaxNode::new_root</code>, so it seems all I am really missing is getting the GreenNode out with <code>syntax.green().to_owned()</code>.  Amazing!</p>",
        "id": 268006288,
        "sender_full_name": "Irina Shestak (they/she)",
        "timestamp": 1642162855
    },
    {
        "content": "<p>hmm passing around <code>GreenNodeData</code> between threads becomes possible if doing <code>green().to_owned()</code>, but getting the data out / \"querying\" the tree becomes a lot more difficult. All my nice types are tied to the <code>SyntaxNode</code>. I guess this problem goes away for rust-analyzer once the hir is created from the ast?</p>",
        "id": 268014770,
        "sender_full_name": "Irina Shestak (they/she)",
        "timestamp": 1642167811
    },
    {
        "content": "<p>ye our HIR doesn't really care about the syntax tree once created. We have machinery in place to fetch the source of a HIR node if required for things, which basically looks up a <code>SyntaxNodePtr</code>(a file id and a file offset) from which we (re-)parse the file and do a lookup at the offset for the node of interest again. So our HIR is only weakly connected via this file id, offset pair. But the main interest points should usually be exposed in the HIR in some form.</p>",
        "id": 268016030,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1642168389
    },
    {
        "content": "<p>right, that makes sense! I don't think it'd make a lot of sense for the HIR to be super closely tied to the syntax tree.</p>",
        "id": 268040271,
        "sender_full_name": "Irina Shestak (they/she)",
        "timestamp": 1642178997
    }
]