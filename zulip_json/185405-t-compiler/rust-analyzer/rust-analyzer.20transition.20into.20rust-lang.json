[
    {
        "content": "<p>So our next step right now would be to move the various small crates into the main repo, the crates in question are <code>smol_str</code>, <code>lsp-server</code>, <code>countme</code>, <code>ungrammar</code>, <code>expect-test</code>, <code>rowan</code>, <code>text-size</code>. So the main question here is, which ones do we want to stay as their own repos and which do we want to merge into the main repo. Relevant <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/10307\">r-a issue #10307</a>.</p>\n<p>To be completely honest I feel like merging all into a monorepo seems a bit counter productive though, as issues with those crates will probably drown rather quickly in the big issue list of the main repo. But this worry might be unwarranted?</p>",
        "id": 277616479,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648985772
    },
    {
        "content": "<p>We could probably add new issue labels for those crates specifically which might be enough to resolve that potential problem</p>",
        "id": 277616609,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648985857
    },
    {
        "content": "<p>TBH, today the issues for those crates are drowning in oblivion anyway. It's not clear which one is better: </p>\n<ul>\n<li>small issue tracker no-one looks at</li>\n<li>huge issue tracker some people actually triage</li>\n</ul>",
        "id": 277619842,
        "sender_full_name": "matklad",
        "timestamp": 1648987623
    },
    {
        "content": "<p>Ye, I can see that happening as well that is true. I mean, most of those crates don't really get many issues in the first place + if we add issue labels for each of them it sounds somewhat fine to have them in the main repo since you can easily look up specific issues for them then.</p>",
        "id": 277620133,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648987782
    },
    {
        "content": "<p>So I would say we want to move all of them, except for rowan, as that is a rather big library compared to the rest.</p>",
        "id": 277620259,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648987823
    },
    {
        "content": "<p>On that note, does anyone know how to properly merge repos while keeping the history? I googled around a bit in regards to this as well as git subtree but my search didn't result in anything usable :)</p>",
        "id": 277620498,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648987949
    },
    {
        "content": "<p>We had a case for this at <code>$JOB</code> recently (creating a workspace for several related projects). It may depend a bit on the exact result you want (supposedly there are ways to do even better with (potentially manual) rebases; see also <a href=\"https://stackoverflow.com/questions/42161910/merge-two-git-repositories-and-keep-the-master-history\">https://stackoverflow.com/questions/42161910/merge-two-git-repositories-and-keep-the-master-history</a>), but for us we decided it was good enough to guarantee keeping the <code>git log</code>, even if with this method one needs to <code>--follow</code> because of the file moving. But the upside is that for this you only need to </p>\n<ul>\n<li>check out both repos</li>\n<li>make a branch in the one you want to move where you move all the files to the place you want them to be in their new home (e.g. mimic the subdirectory of the workspace you want to put them in in the end) and commit that</li>\n<li>go to the target repo and add the source as a remote</li>\n<li>merge the source branch that you just created with <code>--allow-unrelated-histories</code></li>\n<li>verify everything worked by checking the logs</li>\n</ul>\n<p>There were some things we adjusted after merging everything, such as moving CI definitions for the (now-)subprojects into a combined one, but I was pleasantly surprised by the lack of any git-related troubles that required human intervention in this process.</p>",
        "id": 277622067,
        "sender_full_name": "Domenic Quirl",
        "timestamp": 1648988835
    },
    {
        "content": "<p>Thanks! I'll try that out later :)</p>",
        "id": 277622423,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648989047
    },
    {
        "content": "<p>I <em>think</em> that worked? <a href=\"https://github.com/rust-analyzer/rust-analyzer/pull/11889\">https://github.com/rust-analyzer/rust-analyzer/pull/11889</a></p>",
        "id": 277635903,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648996436
    },
    {
        "content": "<p>Actually, is it important to add the source remote from the github repo, or is it fine to point the remote to my local copy? Not sure if that makes a difference for git hence the question</p>",
        "id": 277636417,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648996707
    },
    {
        "content": "<p>The two should be equivalent, your local folder is technically a full repo (hence why you can add it as a remote)</p>",
        "id": 277636525,
        "sender_full_name": "Domenic Quirl",
        "timestamp": 1648996765
    },
    {
        "content": "<p>Seeing the commits in the PR looks like it worked</p>",
        "id": 277636564,
        "sender_full_name": "Domenic Quirl",
        "timestamp": 1648996790
    },
    {
        "content": "<p>Oh, this adds a merge commit, bors does not like that <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 277636653,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648996819
    },
    {
        "content": "<p>This should work with rebasing as well right?</p>",
        "id": 277636677,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648996833
    },
    {
        "content": "<p>Rebasing would destroy the history relation between the original repo and the new location.</p>",
        "id": 277636860,
        "sender_full_name": "bjorn3",
        "timestamp": 1648996928
    },
    {
        "content": "<p>Oh, pro tip btw (though I didn't see how exactly you did it): since the preparation commits all end up in the target repo, I think it makes sense to give them messages already as if they were in the workspace. Otherwise you end up like me - with the last 20 commits in the workspace being \"move files into workspace structure\" into \"merge X\" alternating <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 277636884,
        "sender_full_name": "Domenic Quirl",
        "timestamp": 1648996943
    },
    {
        "content": "<p>S<br>\n<span class=\"user-mention silent\" data-user-id=\"133247\">bjorn3</span> <a href=\"#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rust-analyzer.20transition.20into.20rust-lang/near/277636860\">말함</a>:</p>\n<blockquote>\n<p>Rebasing would destroy the history relation between the original repo and the new location.</p>\n</blockquote>\n<p>So we gotta make bors shut up somehow? <span aria-label=\"confused\" class=\"emoji emoji-1f615\" role=\"img\" title=\"confused\">:confused:</span></p>",
        "id": 277636999,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648997026
    },
    {
        "content": "<p>I'd comment-out our merge check for know -- it seems like the case where we actually do want a merge commit</p>",
        "id": 277637066,
        "sender_full_name": "matklad",
        "timestamp": 1648997046
    },
    {
        "content": "<p>to clarify -- this is not bors, this is our test in <code>tidy.rs</code></p>",
        "id": 277637106,
        "sender_full_name": "matklad",
        "timestamp": 1648997075
    },
    {
        "content": "<p>Can we still publish these independently (so you don't download the whole of RA for <code>smol_str</code>? Actually, can we still publish them after moving?</p>",
        "id": 277637933,
        "sender_full_name": "Laurențiu",
        "timestamp": 1648997541
    },
    {
        "content": "<p>TBH, I liked them better outside the RA repo.</p>",
        "id": 277637998,
        "sender_full_name": "Laurențiu",
        "timestamp": 1648997578
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"203546\">Laurențiu</span> <a href=\"#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/rust-analyzer.20transition.20into.20rust-lang/near/277637998\">말함</a>:</p>\n<blockquote>\n<p>TBH, I liked them better outside the RA repo.</p>\n</blockquote>\n<p>I share this sentiment tbf, I am not a fan of generic libraries being part of the main repo</p>",
        "id": 277638826,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648998003
    },
    {
        "content": "<blockquote>\n<p>Actually, can we still publish them after moving</p>\n</blockquote>\n<p>I think, if we do the move, the rule we want is \"everything from <code>/libs</code> is used via <a href=\"http://crates.io\">crates.io</a>, not via path deps\"</p>",
        "id": 277639609,
        "sender_full_name": "matklad",
        "timestamp": 1648998434
    },
    {
        "content": "<p>As an alternative proposal -- can we just think about moving smaller crates later? :)</p>",
        "id": 277639736,
        "sender_full_name": "matklad",
        "timestamp": 1648998489
    },
    {
        "content": "<p>And some workflows to still publish them when updating the version.</p>",
        "id": 277639745,
        "sender_full_name": "Laurențiu",
        "timestamp": 1648998493
    },
    {
        "content": "<blockquote>\n<p>And some workflows to still publish them when updating the version.</p>\n</blockquote>\n<p>oh wow we actually do <a href=\"https://docs.rs/ra_ap_la-arena/latest/ra_ap_la_arena/\">https://docs.rs/ra_ap_la-arena/latest/ra_ap_la_arena/</a></p>",
        "id": 277640154,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648998701
    },
    {
        "content": "<p>Yeah, but.. that's not ideal</p>",
        "id": 277640296,
        "sender_full_name": "Laurențiu",
        "timestamp": 1648998773
    },
    {
        "content": "<blockquote>\n<p>As an alternative proposal -- can we just think about moving smaller crates later? :)</p>\n</blockquote>\n<p>That is certainly an option as well, I just figured this was the next simplest step, but maybe it makes sense to do/consider this after we moved main repo</p>",
        "id": 277640298,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648998774
    },
    {
        "content": "<p>In that case given the feedback in <a class=\"stream\" data-stream-id=\"301329\" href=\"/#narrow/stream/301329-t-devtools\">#t-devtools</a> was limited, do we want to split out the vscode extension or not</p>",
        "id": 277640448,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648998845
    },
    {
        "content": "<p><a href=\"#narrow/stream/301329-t-devtools/topic/rust-analyzer.20ro.20rust-lang.20org.20transition/near/276721397\">https://rust-lang.zulipchat.com/#narrow/stream/301329-t-devtools/topic/rust-analyzer.20ro.20rust-lang.20org.20transition/near/276721397</a></p>",
        "id": 277640485,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648998872
    },
    {
        "content": "<p>I am still in favor of moving it out personally (there seems to be a general drift for me to separate things out into multiple repos :) )</p>",
        "id": 277640554,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648998917
    },
    {
        "content": "<p>I think it will make coordinating LSP extension changes really annoying</p>",
        "id": 277640764,
        "sender_full_name": "Laurențiu",
        "timestamp": 1648999059
    },
    {
        "content": "<p>Ye that seems the major downside to it :/</p>",
        "id": 277640992,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648999180
    },
    {
        "content": "<p>Though I guess thats also something we can think about <em>after</em> the move of the r-a repo into the rust-lang org</p>",
        "id": 277641010,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648999191
    },
    {
        "content": "<p>But that's maybe just my experience from an unrelated project: there's a repository for the crate and one for a test suite, depending one on each other, and when you break the API of the crate you have to make a PR to the test runner to use a git dependency to the crate, then update the test runner dependency in the main crate to point to that PR branch</p>",
        "id": 277641082,
        "sender_full_name": "Laurențiu",
        "timestamp": 1648999216
    },
    {
        "content": "<p>It's not the same thing since we're not testing our extension code like this, but.. that one was pretty awful</p>",
        "id": 277641136,
        "sender_full_name": "Laurențiu",
        "timestamp": 1648999253
    },
    {
        "content": "<p>Ye its not quite the same but there is indeed the problem of having two PRs on different repos be interlinked I guess, given the implicit reliance of the extension on the latest server builds.</p>",
        "id": 277641302,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648999345
    },
    {
        "content": "<p>I guess we can leave the repos alone for now, I'll get in touch with people to start transferring <code>rust-analyzer/rust-analyzer</code> to <code>rust-lang/rust-analyzer</code> then unless there are other points to raise before ( I've went through my list of things to do for that now )</p>",
        "id": 277641431,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648999422
    }
]