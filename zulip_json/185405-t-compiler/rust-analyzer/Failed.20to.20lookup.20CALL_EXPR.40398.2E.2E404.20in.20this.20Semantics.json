[
    {
        "content": "<p>I'm trying to implement <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/11855\">https://github.com/rust-analyzer/rust-analyzer/issues/11855</a> , I added a variant to the <code>ImmediateLocation</code>, then I tried to find the type via <code>ctx.sema.type_of_pat</code> but it panics:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">lookup</span><span class=\"w\"> </span><span class=\"n\">IDENT_PAT</span><span class=\"o\">@</span><span class=\"mi\">433</span><span class=\"o\">..</span><span class=\"mi\">436</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">Semantics</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"n\">Make</span><span class=\"w\"> </span><span class=\"n\">sure</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">query</span><span class=\"w\"> </span><span class=\"n\">nodes</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">derived</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">Semantics</span><span class=\"p\">.</span><span class=\"w\"></span>\n<span class=\"n\">root</span><span class=\"w\"> </span><span class=\"n\">node</span>:   <span class=\"nc\">SOURCE_FILE</span><span class=\"o\">@</span><span class=\"mi\">0</span><span class=\"o\">..</span><span class=\"mi\">465</span><span class=\"w\"></span>\n<span class=\"n\">known</span><span class=\"w\"> </span><span class=\"n\">nodes</span>: <span class=\"nc\">SOURCE_FILE</span><span class=\"o\">@</span><span class=\"mi\">0</span><span class=\"o\">..</span><span class=\"mi\">451</span><span class=\"w\"></span>\n</code></pre></div>\n<p>The pat node belongs to <code>ctx.completion_location</code> and <code>Semantics</code> is from <code>ctx.sema</code>, what is the problem?</p>",
        "id": 277322752,
        "sender_full_name": "hkalbasi",
        "timestamp": 1648751969
    },
    {
        "content": "<p>Sounds like the IDENT_PAT node you have is from the fake file, that is the source where we inserted an extra ident. You can't use those in semantics</p>",
        "id": 277328042,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648754418
    },
    {
        "content": "<p>That's also why those nodes are usually commented like here <a href=\"https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_completion/src/patterns.rs#L47-L53\">https://github.com/rust-analyzer/rust-analyzer/blob/master/crates/ide_completion/src/patterns.rs#L47-L53</a></p>",
        "id": 277328120,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648754470
    },
    {
        "content": "<p>the fake ones can't be used for semantics as they aren't part of any actual file we build the HIR for</p>",
        "id": 277328171,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1648754506
    }
]