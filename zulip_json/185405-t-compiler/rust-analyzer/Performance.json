[
    {
        "content": "<p>Hey all! First, thanks for the awesome work! <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span>️ I'm working on the winrt crate which is a crate for Windows Runtime bindings (think modern Windows APIs). These APIs are huge and so it's pretty easy for bindings to reach the hundreds of thousands or even millions of lines of code. Needless to say, it's a perf challenge. I'm wondering if it would be helpful to have our crate as a performance measure. You can give it a try with a simple scratch repo we set up: <a href=\"https://github.com/kennykerr/scratch\">https://github.com/kennykerr/scratch</a> there shouldn't be anything special to run it, just a Windows 10 box.</p>",
        "id": 199901163,
        "sender_full_name": "rylev",
        "timestamp": 1591374269
    },
    {
        "content": "<p>Could you also create a repo with all the code generated? Might be much easier to poke at if win 10 box is not required :)</p>",
        "id": 199901489,
        "sender_full_name": "matklad",
        "timestamp": 1591374411
    },
    {
        "content": "<p>Sure. You won't be able to run it, but I guess that's not an issue</p>",
        "id": 199901597,
        "sender_full_name": "rylev",
        "timestamp": 1591374477
    },
    {
        "content": "<p>Fun fact: IntelliJ Rust had (and I bet still has) special hacks in resolver to handle winapi crate</p>",
        "id": 199901774,
        "sender_full_name": "matklad",
        "timestamp": 1591374543
    },
    {
        "content": "<p>yup, still there: <a href=\"https://github.com/intellij-rust/intellij-rust/blob/5a3d790d4d981c0f5a03761a340d7add69702e66/src/main/kotlin/org/rust/lang/core/resolve/Processors.kt#L38-L42\">https://github.com/intellij-rust/intellij-rust/blob/5a3d790d4d981c0f5a03761a340d7add69702e66/src/main/kotlin/org/rust/lang/core/resolve/Processors.kt#L38-L42</a></p>",
        "id": 199901868,
        "sender_full_name": "matklad",
        "timestamp": 1591374594
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133169\">@matklad</span> <a href=\"https://github.com/rylev/winrt-generated\">https://github.com/rylev/winrt-generated</a></p>",
        "id": 199902841,
        "sender_full_name": "rylev",
        "timestamp": 1591375006
    },
    {
        "content": "<p>Interesting note. the generated bindings seems faster than when going through a different create through an <code>include</code> macro</p>",
        "id": 199903250,
        "sender_full_name": "rylev",
        "timestamp": 1591375167
    },
    {
        "content": "<p>Is there perhaps something when using <code>include!</code> that might be slowing things down?</p>",
        "id": 199904109,
        "sender_full_name": "rylev",
        "timestamp": 1591375588
    },
    {
        "content": "<p>Moving stuff around in the file seems to cause it to wonk out though...</p>",
        "id": 199906015,
        "sender_full_name": "rylev",
        "timestamp": 1591376522
    },
    {
        "content": "<p>I played more with the sample repo I posted above today. Besides a long startup time, the performance is ok. It still takes over a second for some types to resolve. I also am under the impression that performance is different when the code is pre-generated and included explicitly  in the project vs when the code is generated in the build script and read by an <code>include!</code> macro from OUT_DIR. I'm not exactly sure what the next steps should be</p>",
        "id": 200102851,
        "sender_full_name": "rylev",
        "timestamp": 1591625666
    },
    {
        "content": "<p>Yeah, I think it's quite probable that <code>include!</code> is a problem here</p>",
        "id": 200103242,
        "sender_full_name": "matklad",
        "timestamp": 1591625834
    },
    {
        "content": "<p>(or at least one of the problems)</p>",
        "id": 200103253,
        "sender_full_name": "matklad",
        "timestamp": 1591625840
    },
    {
        "content": "<p>We've fixed an accidently quadratic behavior around <code>include!</code> a couple of weeks ago but there's still at least one <code>O(N^2)</code> thing left</p>",
        "id": 200103314,
        "sender_full_name": "matklad",
        "timestamp": 1591625868
    },
    {
        "content": "<p>Are there tests around this? I need to look into getting rust-analyzer dev set upon my machine</p>",
        "id": 200103584,
        "sender_full_name": "rylev",
        "timestamp": 1591625970
    },
    {
        "content": "<p>look for <code>infer_builtin_macros_include</code> and <code>include_accidentally_quadratic</code></p>",
        "id": 200103821,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1591626070
    },
    {
        "content": "<p>the <code>include_accidentally_quadratic</code> test is actually ignored, presumably because it's still pretty slow</p>",
        "id": 200103877,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1591626101
    },
    {
        "content": "<p><a href=\"https://github.com/rust-analyzer/rust-analyzer/blob/5ed9818a7c855bf914e91324e305f24e4e743057/crates/ra_hir_ty/src/tests/macros.rs#L553-L575\">https://github.com/rust-analyzer/rust-analyzer/blob/5ed9818a7c855bf914e91324e305f24e4e743057/crates/ra_hir_ty/src/tests/macros.rs#L553-L575</a></p>",
        "id": 200103896,
        "sender_full_name": "matklad",
        "timestamp": 1591626111
    },
    {
        "content": "<p>I'll see if I can make any dent in that.</p>",
        "id": 200104151,
        "sender_full_name": "rylev",
        "timestamp": 1591626210
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"224872\">@Ryan Levick</span> do you know about <code>RA_PROFILE</code> env var?</p>",
        "id": 200104358,
        "sender_full_name": "matklad",
        "timestamp": 1591626292
    },
    {
        "content": "<p><a href=\"https://github.com/rust-analyzer/rust-analyzer/tree/master/docs/dev#profiling\">https://github.com/rust-analyzer/rust-analyzer/tree/master/docs/dev#profiling</a></p>",
        "id": 200104426,
        "sender_full_name": "matklad",
        "timestamp": 1591626322
    },
    {
        "content": "<p>Might be useful to narrow this down. I haven't looked into this myself yet, but the most probable cause is \"somethig is quadratic\".</p>",
        "id": 200104471,
        "sender_full_name": "matklad",
        "timestamp": 1591626348
    },
    {
        "content": "<p>Sorry, had to step out. No I didn't know about that (I'm basically completely new to RA dev - only been a user until now). I'll give it a look</p>",
        "id": 200112611,
        "sender_full_name": "rylev",
        "timestamp": 1591629500
    },
    {
        "content": "<p><a href=\"https://github.com/rust-analyzer/rust-analyzer/tree/master/docs/dev\">https://github.com/rust-analyzer/rust-analyzer/tree/master/docs/dev</a> is worth reading, but <code>git clone</code> and <code>cargo test</code> will get you pretty far.</p>",
        "id": 200116151,
        "sender_full_name": "Laurențiu",
        "timestamp": 1591630821
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133169\">@matklad</span> regarding the performance cc <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/4692#issuecomment-637076470\">https://github.com/rust-analyzer/rust-analyzer/issues/4692#issuecomment-637076470</a>, it's strange that <code>codegen-units=1</code> doesn't increase the dist run time. If so I wonder if it really does give performance increase.</p>",
        "id": 200400190,
        "sender_full_name": "std::Veetaha",
        "timestamp": 1591785322
    },
    {
        "content": "<p>That's compile-time peformance, right? In general, I wouldn't tweak anything here -- at the current level of internal optimization of RA, fine-grained tweaking of compiler optimization flags should be irrelevant -- those should come after the code base itself is optimized. </p>\n<p>I wonder if incremental=true negates codegen units?</p>",
        "id": 200400670,
        "sender_full_name": "matklad",
        "timestamp": 1591785707
    },
    {
        "content": "<p>Incremental=true did this untill 1.44 rust releaae</p>",
        "id": 200400818,
        "sender_full_name": "std::Veetaha",
        "timestamp": 1591785812
    },
    {
        "content": "<p>Setting Codegen-units=1 trades compilation in 1 thread for potentially more optimizations rustc can do.<br>\nI also wonder why we have incremental enabled for dist builds...</p>",
        "id": 200400973,
        "sender_full_name": "std::Veetaha",
        "timestamp": 1591785920
    },
    {
        "content": "<p>We don't?</p>",
        "id": 200400983,
        "sender_full_name": "Laurențiu",
        "timestamp": 1591785936
    },
    {
        "content": "<p>There's <code>CARGO_INCREMENTAL: 0</code> in an <code>env</code> section at the top of <code>release.yaml</code></p>",
        "id": 200401040,
        "sender_full_name": "Laurențiu",
        "timestamp": 1591785966
    },
    {
        "content": "<p>I mean there is incremental=true release section of cargo toml</p>",
        "id": 200401060,
        "sender_full_name": "std::Veetaha",
        "timestamp": 1591785986
    },
    {
        "content": "<p>Because matklad only runs release builds locally?</p>",
        "id": 200401087,
        "sender_full_name": "Laurențiu",
        "timestamp": 1591786030
    },
    {
        "content": "<p>Don't we have <code>debug=0</code> in <code>[dev]</code> profile for this purpose?</p>",
        "id": 200401160,
        "sender_full_name": "std::Veetaha",
        "timestamp": 1591786099
    },
    {
        "content": "<p>debug=0 is to speed up local debug builds (debug info is huge). incremtal=1 is to speed up local release builds</p>",
        "id": 200401245,
        "sender_full_name": "matklad",
        "timestamp": 1591786199
    },
    {
        "content": "<p>I think <code>CARGO_INCREMENTAL=0</code> in <code>release.yml</code> doesn't override what is specified in <code>Cargo.toml</code></p>",
        "id": 200401369,
        "sender_full_name": "std::Veetaha",
        "timestamp": 1591786289
    },
    {
        "content": "<p>Or  does it?</p>",
        "id": 200401387,
        "sender_full_name": "std::Veetaha",
        "timestamp": 1591786311
    },
    {
        "content": "<p>It should</p>",
        "id": 200401655,
        "sender_full_name": "Laurențiu",
        "timestamp": 1591786543
    },
    {
        "content": "<p>Ah, yes, the docs say so...<br>\nI wonder why I thought it doesn't</p>",
        "id": 200401764,
        "sender_full_name": "std::Veetaha",
        "timestamp": 1591786614
    },
    {
        "content": "<p>A <code>codegen-units=1 incremental=false</code> build takes 14 minutes on my laptop</p>",
        "id": 200403655,
        "sender_full_name": "Laurențiu",
        "timestamp": 1591788109
    },
    {
        "content": "<p>And analysis takes 57.7 vs. 59.8s</p>",
        "id": 200404207,
        "sender_full_name": "Laurențiu",
        "timestamp": 1591788575
    },
    {
        "content": "<p>I just wiped my target directory because I was running out of disk space. I now have an extra 50GB I didn't have before.</p>",
        "id": 200666065,
        "sender_full_name": "Jeremy Kolb",
        "timestamp": 1591966549
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>38442ms - handle_hover\n    11300ms - classify_name_ref @ next\n        11300ms - Semantics::analyze_impl\n            11300ms - infer:wait @ main\n                0   - SourceBinder::to_module_def (1 calls)\n                0   - crate_def_map:wait (1 calls)\n        0   - crate_def_map:wait (21 calls)\n        0   - descend_into_macros (1 calls)\n     5908ms - parse_macro_expansion (1532 calls)\n    21234ms - ???\n</code></pre></div>",
        "id": 269715603,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643366142
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>17606ms - import_map_query\n    17605ms - collect_import_map\n        16270ms - collect_trait_assoc_items\n                1ms - crate_def_map:wait (3080 calls)\n              622ms - file_item_tree_query (1539 calls)\n             5273ms - macro_expand (1539 calls)\n             7458ms - parse_macro_expansion (2987 calls)\n            0   - PerNs::filter_visibility (244 calls)\n            0   - PerNs::iter_items (200 calls)\n         1060ms - collect_trait_assoc_items (27 calls)\n          275ms - crate_def_map:wait (1 calls)\n        0   - fst_path (292 calls)\n</code></pre></div>",
        "id": 269715682,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643366188
    },
    {
        "content": "<p>Spotted in <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/4243\">r-a#4243</a> after <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/11360\">r-a#11360</a></p>",
        "id": 269715691,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643366194
    },
    {
        "content": "<p>Since those get reexpanded constantly on changes, does that mean completions take 15+ seconds in those crates? <span aria-label=\"grimacing\" class=\"emoji emoji-1f62c\" role=\"img\" title=\"grimacing\">:grimacing:</span></p>",
        "id": 269716412,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1643366606
    },
    {
        "content": "<p>No, it's fast, but hover seems slow every time</p>",
        "id": 269716578,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643366694
    },
    {
        "content": "<p>Maybe while typing <em>in</em> the macro?</p>",
        "id": 269716614,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643366711
    },
    {
        "content": "<p>Right, if the input doesn't change it shouldn't reexpand. Typing inside should do so though, though I'm not sure in what way that might invalidate the import map</p>",
        "id": 269716684,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1643366757
    },
    {
        "content": "<p>Sounds odd that hover does this every time though <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 269716815,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1643366824
    },
    {
        "content": "<p>Yeah, typing inside that macro is... unpleasant</p>",
        "id": 269717016,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643366934
    },
    {
        "content": "<p>Quick r+ on <a href=\"https://github.com/rust-analyzer/rust-analyzer/pull/11360\">https://github.com/rust-analyzer/rust-analyzer/pull/11360</a>?</p>",
        "id": 269717395,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643367146
    },
    {
        "content": "<p>Maybe we're blowing some cache and losing the old results?</p>",
        "id": 269719696,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643368348
    },
    {
        "content": "<p>Probably</p>",
        "id": 269720108,
        "sender_full_name": "Lukas Wirth",
        "timestamp": 1643368564
    },
    {
        "content": "<p>Or we can reuse this one <span class=\"user-mention\" data-user-id=\"198819\">@David Barsky</span></p>",
        "id": 270100785,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643661403
    },
    {
        "content": "<p>I did see some long <code>macro_expand</code>s in your profile, and that's a known problem, if you read above</p>",
        "id": 270100846,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643661432
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"203546\">Laurențiu</span> <a href=\"#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Performance/near/270100785\">said</a>:</p>\n<blockquote>\n<p>Or we can reuse this one <span class=\"user-mention silent\" data-user-id=\"198819\">David Barsky</span></p>\n</blockquote>\n<p>cool, looking at it</p>",
        "id": 270101111,
        "sender_full_name": "David Barsky",
        "timestamp": 1643661560
    },
    {
        "content": "<p>that's fair: re macros. out of curiosity: how much of this is inherent to the space vs. there are improvements that exist, but there wasn't enough people working on it for a bit?</p>",
        "id": 270101311,
        "sender_full_name": "David Barsky",
        "timestamp": 1643661636
    },
    {
        "content": "<p>The context is that <code>async-std</code> has a huge macro that's supposed to re-export some <code>futures</code> traits while replacing their docs. It bumps the <code>recursion_limit</code> and now that we actually expand it.. it's quite slow</p>",
        "id": 270101315,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643661639
    },
    {
        "content": "<blockquote>\n<p>that's fair: re macros. out of curiosity: how much of this is inherent to the space vs. there are improvements that exist, but there wasn't enough people working on it for a bit?</p>\n</blockquote>\n<p>i guess this applies to macros and rust analyzer as a whole</p>",
        "id": 270101369,
        "sender_full_name": "David Barsky",
        "timestamp": 1643661673
    },
    {
        "content": "<p>(asking since i need to kinda justify where i spend my time, haha)</p>",
        "id": 270101397,
        "sender_full_name": "David Barsky",
        "timestamp": 1643661687
    },
    {
        "content": "<p>I think MBE expansion is one of the slower things in RA</p>",
        "id": 270101406,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643661695
    },
    {
        "content": "<p>We shouldn't take 15-30 seconds to show completions in that case, that's at least 100x slower than what we'd like</p>",
        "id": 270101539,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643661739
    },
    {
        "content": "<p>But it depends on the code. If you don't have heavy MBE macros, it might be hard to notice any improvements</p>",
        "id": 270101758,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643661851
    },
    {
        "content": "<p>So you could set that environment variable, load the project and wait for it to settle (or disable cache priming if you're interested in the apparent load times), work on some code for a bit and see if anything is outrageously slow (slower than 3-4 seconds, for starters)</p>",
        "id": 270102075,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643662042
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"203546\">Laurențiu</span> <a href=\"#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/Performance/near/270102075\">said</a>:</p>\n<blockquote>\n<p>So you could set that environment variable, load the project and wait for it to settle (or disable cache priming if you're interested in the apparent load times), work on some code for a bit and see if anything is outrageously slow (slower than 3-4 seconds, for starters)</p>\n</blockquote>\n<p>gotcha. thanks so much for all this info.</p>",
        "id": 270102531,
        "sender_full_name": "David Barsky",
        "timestamp": 1643662243
    },
    {
        "content": "<p>Or try interacting with the <code>next</code> in <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/11363\">https://github.com/rust-analyzer/rust-analyzer/issues/11363</a> to see a really bad case</p>",
        "id": 270102974,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643662447
    },
    {
        "content": "<p>woof, good to know</p>",
        "id": 270105783,
        "sender_full_name": "David Barsky",
        "timestamp": 1643663616
    },
    {
        "content": "<p>Do we want to try this? <a href=\"https://github.com/robclu/leapfrog\">https://github.com/robclu/leapfrog</a> I'm not sure how hard we're hitting the <code>dashmap</code> in the interner</p>",
        "id": 270232987,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643730533
    },
    {
        "content": "<blockquote>\n<p>The value type for the map needs to implement the Value trait, which is simple enough to implement, however, two values need to be chosen, one as a null value and another as a redirect value.</p>\n</blockquote>",
        "id": 270233533,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643730702
    },
    {
        "content": "<p>The interner had no measurable performance impact when I added it</p>",
        "id": 270239168,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1643732551
    },
    {
        "content": "<p>fyi: dashmap (some versions?) is currently unsound: <a href=\"https://github.com/xacrimon/dashmap/issues/167\">https://github.com/xacrimon/dashmap/issues/167</a></p>",
        "id": 270273275,
        "sender_full_name": "Waffle Lapkin",
        "timestamp": 1643744665
    },
    {
        "content": "<p>It's been <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/11341\">reported</a>, but I don't think it's a problem for us</p>",
        "id": 270273469,
        "sender_full_name": "Laurențiu",
        "timestamp": 1643744759
    }
]