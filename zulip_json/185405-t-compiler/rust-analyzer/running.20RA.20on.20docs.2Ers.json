[
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/Steering.20meeting/near/223135648\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"211727\">Jonas Schievink</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/Steering.20meeting/near/223135485\">said</a>:</p>\n<blockquote>\n<p>If sorting issues by number of <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> reactions is anything to go by, reducing memory usage and supporting inner items properly are high on the list</p>\n</blockquote>\n<p>big +1 to less memory usage, I don't even use RA on <a href=\"http://docs.rs\">docs.rs</a> because it crashes my laptop</p>\n</blockquote>\n<p>is <a href=\"http://docs.rs\">docs.rs</a> that huge? maybe there's something else going on, it might be worth running analysis-stats on it and/or creating an issue</p>",
        "id": 223135877,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1610984675
    },
    {
        "content": "<p>I did: <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/7052\">https://github.com/rust-analyzer/rust-analyzer/issues/7052</a></p>",
        "id": 223138046,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610985801
    },
    {
        "content": "<p>the debug tools didn't work for me: <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/7052#issuecomment-751499782\">https://github.com/rust-analyzer/rust-analyzer/issues/7052#issuecomment-751499782</a><br>\nand no one else was able to reproduce the memory usage: <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/7052#issuecomment-751518257\">https://github.com/rust-analyzer/rust-analyzer/issues/7052#issuecomment-751518257</a></p>",
        "id": 223138119,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610985839
    },
    {
        "content": "<p>and then it got marked as unactionable</p>",
        "id": 223138215,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610985871
    },
    {
        "content": "<p>so I don't know what the next steps are</p>",
        "id": 223138221,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610985875
    },
    {
        "content": "<p>Do you see the panic now ?</p>",
        "id": 223138576,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610986050
    },
    {
        "content": "<p>I see <em>a</em> panic:</p>\n<div class=\"codehilite\"><pre><span></span><code>[Info  - 11:07:36 AM] Connection to server got closed. Server will restart.\n[Error - 11:07:36 AM] Request textDocument/semanticTokens/full failed.\nError: Connection got disposed.\n    at Object.dispose (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:5534:27)\n    at Object.dispose (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:11546:35)\n    at LanguageClient.handleConnectionClosed (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:13897:42)\n    at LanguageClient.handleConnectionClosed (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:16803:15)\n    at closeHandler (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:13884:18)\n    at CallbackList.invoke (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:3527:39)\n    at Emitter.fire (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:3589:36)\n    at closeHandler (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:4747:26)\n    at CallbackList.invoke (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:3527:39)\n    at Emitter.fire (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:3589:36)\n    at StreamMessageWriter.fireClose (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:4009:27)\n    at Socket.&lt;anonymous&gt; (/home/joshua/.vscode/extensions/matklad.rust-analyzer-0.2.457/out/src/main.js:4042:42)\n    at Socket.emit (events.js:223:5)\n    at Pipe.&lt;anonymous&gt; (net.js:664:12)\n</code></pre></div>",
        "id": 223138633,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986083
    },
    {
        "content": "<p>I never saw the original panic even 3 weeks ago, maybe I wasn't looking at the logs</p>",
        "id": 223138715,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986110
    },
    {
        "content": "<p>the server just crashed I think because it's back to 55/369 roots, it was at 200 just a second ago</p>",
        "id": 223138755,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986140
    },
    {
        "content": "<p>I think running the memory usage command now (intentionally) breaks salsa invariants, so a panic is expected</p>",
        "id": 223138760,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610986143
    },
    {
        "content": "<p>not sure if that's an OOM or not</p>",
        "id": 223138785,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986150
    },
    {
        "content": "<p>but it happens pretty consistently</p>",
        "id": 223138802,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986157
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"211727\">Jonas Schievink</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223138760\">said</a>:</p>\n<blockquote>\n<p>I think running the memory usage command now (intentionally) breaks salsa invariants, so a panic is expected</p>\n</blockquote>\n<p>this is without running any commands at all</p>",
        "id": 223138817,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986168
    },
    {
        "content": "<p>I just have it open to a file without making any changes</p>",
        "id": 223138828,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986176
    },
    {
        "content": "<p>ok the server keeps getting OOM'd so I'm going to close RA now</p>",
        "id": 223138902,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986203
    },
    {
        "content": "<p>on linux <code>dmesg</code> will tell you if something gets OOM-killed</p>",
        "id": 223138958,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610986215
    },
    {
        "content": "<p>I'm using earlyoom, let me see where it sends its logs</p>",
        "id": 223139086,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986272
    },
    {
        "content": "<p>(without earlyoom my computer will freeze up completely instead of killing a process)</p>",
        "id": 223139111,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986284
    },
    {
        "content": "<p>Did anyone else try it on Windows?</p>",
        "id": 223139502,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610986466
    },
    {
        "content": "<p>yup it was killed:</p>\n<div class=\"codehilite\"><pre><span></span><code>Jan 18 11:13:42 joshua-ThinkPad-P51s earlyoom[988]: mem avail:   834 of  7597 MiB (10 %), swap free:   77 of  975 MiB ( 7 %)\nJan 18 11:13:42 joshua-ThinkPad-P51s earlyoom[988]: low memory! at or below SIGTERM limits: mem 10 %, swap 10 %\nJan 18 11:13:42 joshua-ThinkPad-P51s earlyoom[988]: sending SIGTERM to process 51844 &quot;rust-analyzer-x&quot;: badness 216, VmRSS 1850 MiB\nJan 18 11:13:42 joshua-ThinkPad-P51s earlyoom[988]: process exited after 0.1 seconds\nJan 18 11:14:07 joshua-ThinkPad-P51s earlyoom[988]: mem avail:  2206 of  7597 MiB (29 %), swap free:   77 of  975 MiB ( 7 %)\n</code></pre></div>",
        "id": 223139516,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986475
    },
    {
        "content": "<p>I can close some tabs and see how much memory it will take if I let it run long enough</p>",
        "id": 223139560,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986504
    },
    {
        "content": "<p>it got up to 2.7 GB this time and seems to be working reasonably well</p>",
        "id": 223139756,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986587
    },
    {
        "content": "<p>but I had to close pretty much everything except the zulip tab</p>",
        "id": 223139770,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986596
    },
    {
        "content": "<p>so it's not a <em>bug</em> in RA, it just uses too much memory for me to use it normally</p>",
        "id": 223139984,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986697
    },
    {
        "content": "<p>I tried the 'clear database' command again and it has the same issue as before, it shows -3.2 GB which I think means it <em>allocated</em> memory while the command was running</p>",
        "id": 223140355,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986885
    },
    {
        "content": "<p><code>top</code> still shows RA using 2.7 GB RSS</p>",
        "id": 223140364,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986892
    },
    {
        "content": "<p>anyway, let me know if I can help more with this</p>",
        "id": 223140390,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610986909
    },
    {
        "content": "<p>Here is my machine stats from <code>top</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code>  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND\n 109309 edwin     20   0 1920708   1.4g  15504 S   0.0   8.8   0:35.15 rust-analyzer\n 109872 edwin     20   0  153216  79268  69088 S   0.0   0.5   0:02.13 /home/edwin/.cargo/bin/rust-analyzer proc-macro\n</code></pre></div>",
        "id": 223140514,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610986965
    },
    {
        "content": "<p>So it is around 1.5g and no panic occuried..</p>",
        "id": 223140569,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610986993
    },
    {
        "content": "<p><span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span> that is not my experience</p>",
        "id": 223140588,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987003
    },
    {
        "content": "<p>I'm on debian 10 with <code>rustc 1.49.0 (e1884a8e3 2020-12-29)</code> if it helps</p>",
        "id": 223140618,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987030
    },
    {
        "content": "<p>x86 ?</p>",
        "id": 223140753,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610987119
    },
    {
        "content": "<p>x86_64, yeah. This is an 7th-gen intel i5 with 4 cores (2 physical cores) and 8 GB memory</p>",
        "id": 223140765,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987132
    },
    {
        "content": "<p>Iam still on 1.48 , let me update and try</p>",
        "id": 223140883,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610987210
    },
    {
        "content": "<p>hmm, I might have some RA settings that aren't the default? How do I find those?</p>",
        "id": 223140913,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987244
    },
    {
        "content": "<p>If you are using vscode, just copy the json settings ?</p>",
        "id": 223140937,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610987269
    },
    {
        "content": "<p>do you only have the one Rust extension running?</p>",
        "id": 223141022,
        "sender_full_name": "oliver",
        "timestamp": 1610987319
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>    &quot;rust-analyzer.checkOnSave.overrideCommand&quot;: null,\n    &quot;rust-analyzer.checkOnSave.allTargets&quot;: false,\n    &quot;rust-analyzer.checkOnSave.enable&quot;: false\n</code></pre></div>",
        "id": 223141038,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987328
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281739\">oliver</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223141022\">said</a>:</p>\n<blockquote>\n<p>do you only have the one Rust extension running?</p>\n</blockquote>\n<p>yes, RA works fine on other projects, and works fine on this one other than the memory usage</p>",
        "id": 223141054,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987342
    },
    {
        "content": "<p>and top specifically shows <code>rust-analyzer-x</code>, not VSCode, as using the memory</p>",
        "id": 223141086,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987361
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223141038\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\"><pre><span></span><code>    &quot;rust-analyzer.checkOnSave.overrideCommand&quot;: null,\n    &quot;rust-analyzer.checkOnSave.allTargets&quot;: false,\n    &quot;rust-analyzer.checkOnSave.enable&quot;: false\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>(I have a bunch more things in settings, but none of them start with <code>rust-analyzer</code>)</p>",
        "id": 223141228,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987441
    },
    {
        "content": "<p>me</p>\n<div class=\"codehilite\" data-code-language=\"JSON\"><pre><span></span><code>    <span class=\"nt\">\"rust-analyzer.updates.channel\"</span><span class=\"p\">:</span> <span class=\"s2\">\"nightly\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"rust-analyzer.updates.askBeforeDownload\"</span><span class=\"p\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"rust-analyzer.cargo.allFeatures\"</span><span class=\"p\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"rust-analyzer.assist.importMergeBehaviour\"</span><span class=\"p\">:</span> <span class=\"s2\">\"full\"</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"rust-analyzer.cargo.target\"</span><span class=\"p\">:</span> <span class=\"kc\">null</span><span class=\"p\">,</span>\n    <span class=\"nt\">\"rust-analyzer.cargoRunner\"</span><span class=\"p\">:</span> <span class=\"kc\">null</span><span class=\"p\">,</span>\n</code></pre></div>",
        "id": 223141330,
        "sender_full_name": "oliver",
        "timestamp": 1610987514
    },
    {
        "content": "<p>Does <code>rust-analyzer-x analysis-stats .</code> work?</p>",
        "id": 223141397,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987537
    },
    {
        "content": "<p>as well ofc <code>\"rust-client.rustupPath\": \"~/.cargo/bin/rustup\",</code></p>",
        "id": 223141488,
        "sender_full_name": "oliver",
        "timestamp": 1610987599
    },
    {
        "content": "<p>hmm I need to find where in PATH rust-analyzer is, one sec</p>",
        "id": 223141520,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987629
    },
    {
        "content": "<p>Why does it say <code>-x</code>?</p>",
        "id": 223141537,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987641
    },
    {
        "content": "<p>oh it must be <code>/home/joshua/.config/Code/User/globalStorage/matklad.rust-analyzer/rust-analyzer-x86_64-unknown-linux-gnu</code></p>",
        "id": 223141597,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987662
    },
    {
        "content": "<p>I guess top cut it off because it was too long lol</p>",
        "id": 223141605,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987670
    },
    {
        "content": "<p>Right</p>",
        "id": 223141615,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987678
    },
    {
        "content": "<blockquote>\n<p>Failed to create perf counter: Operation not permitted (os error 1)</p>\n</blockquote>\n<p>do I need to run it with sudo?</p>",
        "id": 223141639,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987697
    },
    {
        "content": "<p>(does RA try to modify things in the home directory?)</p>",
        "id": 223141654,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987705
    },
    {
        "content": "<p>Maybe try installing GNU <code>time</code> and running <code>command time ~/.config/Code/User/globalStorage/matklad.rust-analyzer/rust-analyzer-x86_64-unknown-linux-gnu analysis-stats .</code></p>",
        "id": 223141677,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987719
    },
    {
        "content": "<p>For the perf counters yes, but you don't _need_ them, I suppose</p>",
        "id": 223141691,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987734
    },
    {
        "content": "<p>oh sorry it got OOM killed again, let me finish the other thing I'm doing</p>\n<div class=\"codehilite\"><pre><span></span><code>&gt; /home/joshua/.config/Code/User/globalStorage/matklad.rust-analyzer/rust-analyzer-x86_64-unknown-linux-gnu analysis-stats .\nFailed to create perf counter: Operation not permitted (os error 1)\nTerminated\n</code></pre></div>",
        "id": 223141713,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610987748
    },
    {
        "content": "<p>It runs <code>cargo metadata</code> so it might write some files as <code>root</code> if you use <code>sudo</code></p>",
        "id": 223141719,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987755
    },
    {
        "content": "<p>Cool, then it's easier to reproduce it</p>",
        "id": 223141790,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987782
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>Database loaded:     2.28s, 516minstr\n  crates: 9, mods: 102, decls: 900, fns: 623\nItem Collection:     10.07s, 106ginstr\n  exprs: 48928, ??ty: 676 (1%), ?ty: 797 (1%), !ty: 93\nInference:           6.56s, 59ginstr\nTotal:               16.63s, 165ginstr\n17.83user 0.41system 0:19.51elapsed 93%CPU (0avgtext+0avgdata 1206296maxresident)k\n179344inputs+16520outputs (94major+382095minor)pagefaults 0swaps\n</code></pre></div>",
        "id": 223141878,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987840
    },
    {
        "content": "<p>So it's using.. 1.2G on my system</p>",
        "id": 223141899,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987852
    },
    {
        "content": "<p>What distro are you running? Maybe it's allocator-specific?</p>",
        "id": 223142031,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610987926
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223141228\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223141038\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\"><pre><span></span><code>    &quot;rust-analyzer.checkOnSave.overrideCommand&quot;: null,\n    &quot;rust-analyzer.checkOnSave.allTargets&quot;: false,\n    &quot;rust-analyzer.checkOnSave.enable&quot;: false\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>(I have a bunch more things in settings, but none of them start with <code>rust-analyzer</code>)</p>\n</blockquote>\n<p>So you do not enable proc-macro support ...? Um..</p>",
        "id": 223142210,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610988017
    },
    {
        "content": "<p><code>analysis-stats</code> also doesn't enable proc macros by default</p>",
        "id": 223142235,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610988033
    },
    {
        "content": "<p>If you're using a pre-built binary, I guess it's not CentOS 7, so the oldest one that works is Ubuntu 16.04 with GLIBC 2.23 and the new allocator got merged in 2.26..</p>",
        "id": 223142250,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610988044
    },
    {
        "content": "<p>this is ubuntu 20.04</p>",
        "id": 223142419,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610988148
    },
    {
        "content": "<p>there's also the <code>--memory-usage</code> argument to <code>analysis-stats</code></p>",
        "id": 223142427,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1610988155
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>Database loaded:     1.26s, 512minstr, 129mb\n  crates: 9, mods: 102, decls: 900, fns: 623\nItem Collection:     25.28s, 136ginstr, 755mb\n  exprs: 49526, ??ty: 246 (0%), ?ty: 455 (0%), !ty: 10\nInference:           16.16s, 76ginstr, 306mb\nTotal:               41.44s, 212ginstr, 1062mb\n43.09user 0.69system 0:43.95elapsed 99%CPU (0avgtext+0avgdata 1226628maxresident)k\n0inputs+8outputs (0major+373318minor)pagefaults 0swaps\n</code></pre></div>",
        "id": 223142444,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1610988168
    },
    {
        "content": "<p>Not if it OOMs <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 223142448,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610988173
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"216201\">Edwin Cheng</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223142210\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223141228\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223141038\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\"><pre><span></span><code>    &quot;rust-analyzer.checkOnSave.overrideCommand&quot;: null,\n    &quot;rust-analyzer.checkOnSave.allTargets&quot;: false,\n    &quot;rust-analyzer.checkOnSave.enable&quot;: false\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>(I have a bunch more things in settings, but none of them start with <code>rust-analyzer</code>)</p>\n</blockquote>\n<p>So you do not enable proc-macro support ...? Um..</p>\n</blockquote>\n<p><a href=\"http://docs.rs\">docs.rs</a> doesn't use a ton of proc-macros I don't think</p>",
        "id": 223142488,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610988198
    },
    {
        "content": "<p>in any case, it seems to OOM without proc-macros anyway</p>",
        "id": 223142520,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1610988219
    },
    {
        "content": "<p>still waiting for the other build to finish, sorry</p>",
        "id": 223142530,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610988224
    },
    {
        "content": "<p>clearly the solution is for rust to just be a simpler language to compile <span aria-label=\"laughing\" class=\"emoji emoji-1f606\" role=\"img\" title=\"laughing\">:laughing:</span></p>",
        "id": 223142563,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610988243
    },
    {
        "content": "<p>Okay, rust 1.49 build and disabled proc-macro in my machine:</p>\n<div class=\"codehilite\"><pre><span></span><code>    PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND\n 130314 edwin     20   0 1645292   1.1g  16156 S   0.0   7.3   0:29.51 rust-analyzer\n</code></pre></div>",
        "id": 223142662,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610988292
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232545\">@Joshua Nelson</span> what's your rust-analyzer version ?</p>",
        "id": 223142813,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610988395
    },
    {
        "content": "<p>--version tells me <code>rust-analyzer fde4a86</code></p>",
        "id": 223142867,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610988438
    },
    {
        "content": "<p>not sure how to get a date from that</p>",
        "id": 223142873,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610988444
    },
    {
        "content": "<p>It's today's</p>",
        "id": 223142907,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610988479
    },
    {
        "content": "<p>You build from source ? but your path is vscode extension one ?</p>",
        "id": 223143020,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610988539
    },
    {
        "content": "<p>I did not build from source. This is from the 'rust-analyzer server is not installed' button in vscode</p>",
        "id": 223143059,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610988566
    },
    {
        "content": "<p>(the other build is <em>still</em> running, sorry)</p>",
        "id": 223143125,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610988603
    },
    {
        "content": "<p>Tried it in Docker:</p>\n<div class=\"codehilite\"><pre><span></span><code>Failed to create perf counter: Operation not permitted (os error 1)\nDatabase loaded:     374.68ms, 131mb\nFailed to create perf counter: Operation not permitted (os error 1)\n  crates: 9, mods: 102, decls: 900, fns: 623\nItem Collection:     10.05s, 771mb\nFailed to create perf counter: Operation not permitted (os error 1)\n  exprs: 48928, ??ty: 676 (1%), ?ty: 797 (1%), !ty: 93\nInference:           6.43s, 301mb\nTotal:               16.48s, 1072mb\n</code></pre></div>",
        "id": 223143241,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610988668
    },
    {
        "content": "<p>Next step would be a live USB <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 223143431,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610988783
    },
    {
        "content": "<p>I wouldn't expect it to be related to the distro</p>",
        "id": 223143660,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610988920
    },
    {
        "content": "<p>I'm on the same thing as you and using <code>935Mb</code></p>",
        "id": 223143698,
        "sender_full_name": "oliver",
        "timestamp": 1610988944
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"203546\">Laurențiu Nicola</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223141677\">said</a>:</p>\n<blockquote>\n<p>Maybe try installing GNU <code>time</code> and running <code>command time ~/.config/Code/User/globalStorage/matklad.rust-analyzer/rust-analyzer-x86_64-unknown-linux-gnu analysis-stats .</code></p>\n</blockquote>\n<p>ok the other build finally finished, running this now</p>",
        "id": 223143891,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989078
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>&gt; command time -v /home/joshua/.config/Code/User/globalStorage/matklad.rust-analyzer/rust-analyzer-x86_64-unknown-linux-gnu analysis-stats .\nDatabase loaded:     45.09s\n  crates: 9, mods: 102, decls: 900, fns: 623\nItem Collection:     17.72s\n92/623 14% processing: web::crate_details::tests::test_last_successful_build_with_intermittent_releases_failed_or_ya3/623 14% processing: web::crate_details::tests::test_last_successful_build_with_intermittent_releases_failed_or_yan  exprs: 49528, ??ty: 246 (0%), ?ty: 455 (0%), !ty: 11\nInference:           11.38s\nTotal:               29.09s\n    Command being timed: &quot;/home/joshua/.config/Code/User/globalStorage/matklad.rust-analyzer/rust-analyzer-x86_64-unknown-linux-gnu analysis-stats .&quot;\n    User time (seconds): 33.97\n    System time (seconds): 10.80\n    Percent of CPU this job got: 59%\n    Elapsed (wall clock) time (h:mm:ss or m:ss): 1:15.48\n    Average shared text size (kbytes): 0\n    Average unshared data size (kbytes): 0\n    Average stack size (kbytes): 0\n    Average total size (kbytes): 0\n    Maximum resident set size (kbytes): 2867164\n</code></pre></div>",
        "id": 223144046,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989175
    },
    {
        "content": "<p>oh whoops let me run that again with --memory-usage</p>",
        "id": 223144233,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989268
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>&gt; command time -v /home/joshua/.config/Code/User/globalStorage/matklad.rust-analyzer/rust-analyzer-x86_64-unknown-linux-gnu analysis-stats --memory-usage .\nDatabase loaded:     10.98s, 1682mb\n  crates: 9, mods: 102, decls: 900, fns: 623\nItem Collection:     18.26s, -3332mb\n92/623 14% processing: web::crate_details::tests::test_last_successful_build_with_intermittent_releases_failed_or_ya3/623 14% processing: web::crate_details::tests::test_last_successful_build_with_intermittent_releases_failed_or_yan  exprs: 49528, ??ty: 246 (0%), ?ty: 455 (0%), !ty: 11\nInference:           12.36s, 307mb\nTotal:               30.63s, -3025mb\n    Command being timed: &quot;/home/joshua/.config/Code/User/globalStorage/matklad.rust-analyzer/rust-analyzer-x86_64-unknown-linux-gnu analysis-stats --memory-usage .&quot;\n    User time (seconds): 33.40\n    System time (seconds): 3.47\n    Percent of CPU this job got: 85%\n    Elapsed (wall clock) time (h:mm:ss or m:ss): 0:42.93\n    Average shared text size (kbytes): 0\n    Average unshared data size (kbytes): 0\n    Average stack size (kbytes): 0\n    Average total size (kbytes): 0\n    Maximum resident set size (kbytes): 2872688\n</code></pre></div>",
        "id": 223144309,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989318
    },
    {
        "content": "<blockquote>\n<p>Total:               30.63s, -3025mb</p>\n</blockquote>\n<p>this looks very wrong</p>",
        "id": 223144357,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989327
    },
    {
        "content": "<p>like corrupted memory wrong...</p>",
        "id": 223144376,
        "sender_full_name": "oliver",
        "timestamp": 1610989339
    },
    {
        "content": "<p>Is that using an i32 somewhere to count memory usage?</p>",
        "id": 223144421,
        "sender_full_name": "Daniel Silverstone",
        "timestamp": 1610989372
    },
    {
        "content": "<p>what, with the cli?? that should never happen</p>",
        "id": 223144424,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989374
    },
    {
        "content": "<p>that's what it says</p>",
        "id": 223144440,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989385
    },
    {
        "content": "<p>we use <code>isize</code> to count this</p>",
        "id": 223144594,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989468
    },
    {
        "content": "<p>hmm, isize is 8 bytes on x64</p>",
        "id": 223144664,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989517
    },
    {
        "content": "<p>why is the actual per-query memory usage missing? did this break recently?</p>",
        "id": 223144682,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989534
    },
    {
        "content": "<p>you need to wait a bit for that</p>",
        "id": 223144712,
        "sender_full_name": "oliver",
        "timestamp": 1610989562
    },
    {
        "content": "<p>it happens locally too, it just exits without outputting it</p>",
        "id": 223144768,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989581
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"223910\">Daniel Silverstone</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223144421\">said</a>:</p>\n<blockquote>\n<p>Is that using an i32 somewhere to count memory usage?</p>\n</blockquote>\n<p>hmm, casting that to u32 isn't very informative: <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=75edeec5350fc6b12e9f50b2a64def8d\">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=75edeec5350fc6b12e9f50b2a64def8d</a></p>",
        "id": 223144831,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989632
    },
    {
        "content": "<p>ah, now you have to pass <code>--verbose</code> too</p>",
        "id": 223144840,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989638
    },
    {
        "content": "<p>sure, running that</p>",
        "id": 223144876,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989662
    },
    {
        "content": "<p>can't wait for this to be a bug in glibc's memory allocator</p>",
        "id": 223144884,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989667
    },
    {
        "content": "<p>hmm, this output is weird:</p>\n<div class=\"codehilite\"><pre><span></span><code>/home/joshua/src/rust/docs.rs/src/web/mod.rs 372:22-372:25: Expected str, got &amp;str\n/home/joshua/src/rust/docs.rs/src/web/rustdoc.rs 388:25-388:40: Expected &amp;str, got &amp;String\n/home/joshua/src/rust/docs.rs/src/web/builds.rs 269:20-269:22: Expected &amp;(dyn ToSql + Sync), got &amp;_\n/home/joshua/src/rust/docs.rs/src/web/metrics.rs 41:21-41:38: Expected Box&lt;dyn Handler, Global&gt;, got Box&lt;impl Handler, Global&gt;\n/home/joshua/src/rust/docs.rs/src/test/fakes.rs 303:40-303:52: Expected _, got &amp;str\n/home/joshua/src/rust/docs.rs/src/test/fakes.rs 305:36-305:42: Expected &amp;str, got &amp;&lt;[&amp;String] as Join&lt;&amp;str&gt;&gt;::Output\n/home/joshua/src/rust/docs.rs/src/test/fakes.rs 314:56-314:70: Expected Option&lt;&amp;str&gt;, got Option&lt;&amp;String&gt;\n/home/joshua/src/rust/docs.rs/src/db/migrate.rs 64:8-180:9: Expected Vec&lt;Box&lt;dyn PostgresMigration, Global&gt;&gt;, got Vec&lt;Box&lt;Amigration, Global&gt;&gt;\n</code></pre></div>",
        "id": 223144972,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989720
    },
    {
        "content": "<p>anyway, here's with --verbose: <a href=\"https://gist.github.com/jyn514/01a0f789a2464d116d5c3974d4b1f52f\">https://gist.github.com/jyn514/01a0f789a2464d116d5c3974d4b1f52f</a></p>",
        "id": 223145171,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989825
    },
    {
        "content": "<blockquote>\n<p>Total:               29.23s, -3025mb</p>\n</blockquote>\n<p>smh</p>",
        "id": 223145212,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989860
    },
    {
        "content": "<p>the culprit seems to be</p>\n<div class=\"codehilite\"><pre><span></span><code> -3280mb FileTextQuery (purge)\n</code></pre></div>",
        "id": 223145254,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989885
    },
    {
        "content": "<p>oh</p>\n<p><code>int uordblks;</code></p>",
        "id": 223145314,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989924
    },
    {
        "content": "<p><code>int</code> is <code>i32</code> on x86_64</p>",
        "id": 223145339,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989936
    },
    {
        "content": "<p>that would do it</p>",
        "id": 223145347,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989942
    },
    {
        "content": "<p>where is <code>uordblks</code> from?</p>",
        "id": 223145366,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610989957
    },
    {
        "content": "<p><a href=\"https://man7.org/linux/man-pages/man3/mallinfo.3.html\">https://man7.org/linux/man-pages/man3/mallinfo.3.html</a></p>",
        "id": 223145385,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989965
    },
    {
        "content": "<p>that's what we use to figure out the memory usage via <code>mallinfo()</code></p>",
        "id": 223145423,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610989979
    },
    {
        "content": "<p>looks like <code>malloc_info()</code> handles this: <a href=\"https://stackoverflow.com/questions/40878169/64-bit-capable-alternative-to-mallinfo\">https://stackoverflow.com/questions/40878169/64-bit-capable-alternative-to-mallinfo</a></p>",
        "id": 223145482,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990002
    },
    {
        "content": "<p><a href=\"https://linux.die.net/man/3/malloc_info\">https://linux.die.net/man/3/malloc_info</a></p>",
        "id": 223145496,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990013
    },
    {
        "content": "<p>lol wtf why is it XML</p>",
        "id": 223145513,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990025
    },
    {
        "content": "<p>XML?!</p>",
        "id": 223145528,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990036
    },
    {
        "content": "<p>What's a block in <code>mallinfo</code>?</p>",
        "id": 223145585,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610990053
    },
    {
        "content": "<p>If they're not bytes, it might still fit in an <code>int</code></p>",
        "id": 223145624,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610990086
    },
    {
        "content": "<p>oh great, there's malloc_stats but it only prints to stdout <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span> <a href=\"https://man7.org/linux/man-pages/man3/malloc_stats.3.html\">https://man7.org/linux/man-pages/man3/malloc_stats.3.html</a></p>",
        "id": 223145786,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990190
    },
    {
        "content": "<p>what clown designed this</p>",
        "id": 223145800,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990197
    },
    {
        "content": "<p>urgh this sucks, we've wanted a high-performance pure-Rust allocator for a long time now</p>",
        "id": 223145831,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990223
    },
    {
        "content": "<p>it would be much easier to support this then</p>",
        "id": 223145847,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990233
    },
    {
        "content": "<p>I think jemalloc has support for introspection</p>",
        "id": 223145972,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990297
    },
    {
        "content": "<p>I think we used to use that, even</p>",
        "id": 223146028,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990316
    },
    {
        "content": "<p>but that required passing a cargo feature</p>",
        "id": 223146056,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990331
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"211727\">Jonas Schievink</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223146056\">said</a>:</p>\n<blockquote>\n<p>but that required passing a cargo feature</p>\n</blockquote>\n<p>what's wrong with that?</p>",
        "id": 223146328,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990493
    },
    {
        "content": "<p>minor annoyance, not sure if there was anything else...</p>",
        "id": 223146625,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990657
    },
    {
        "content": "<p><a href=\"https://github.com/rust-analyzer/rust-analyzer/pull/5479\">https://github.com/rust-analyzer/rust-analyzer/pull/5479</a></p>",
        "id": 223146681,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990696
    },
    {
        "content": "<p>removing jemalloc entirely was probably not the right move then</p>",
        "id": 223146727,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990739
    },
    {
        "content": "<p>mallinfo is also way way slower than jemalloc's API</p>",
        "id": 223146742,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990749
    },
    {
        "content": "<p>if features are annoying, you could set jemalloc on by default</p>",
        "id": 223146755,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990758
    },
    {
        "content": "<p>and then only disable it if someone really cares</p>",
        "id": 223146797,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990765
    },
    {
        "content": "<p>I can't find what removed it entirely though</p>",
        "id": 223146859,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610990807
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"211727\">Jonas Schievink</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223144884\">said</a>:</p>\n<blockquote>\n<p>can't wait for this to be a bug in glibc's memory allocator</p>\n</blockquote>\n<p>I guess in a sense it was lmao</p>",
        "id": 223146923,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990859
    },
    {
        "content": "<p>What's surprising is how much more RSS you seem to need over other people though</p>",
        "id": 223147031,
        "sender_full_name": "Daniel Silverstone",
        "timestamp": 1610990906
    },
    {
        "content": "<p>yeah :( IDK what's up with that</p>",
        "id": 223147054,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990920
    },
    {
        "content": "<p>could someone else post the <code>--verbose</code> output for the query memory usage?</p>",
        "id": 223147090,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990952
    },
    {
        "content": "<p>maybe <span class=\"user-mention\" data-user-id=\"211727\">@Jonas Schievink</span> or <span class=\"user-mention\" data-user-id=\"203546\">@Laurențiu Nicola</span> since you had about ~1.3 GB used?</p>",
        "id": 223147121,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610990974
    },
    {
        "content": "<p><a href=\"https://paste.debian.net/1181653/\">https://paste.debian.net/1181653/</a></p>",
        "id": 223147559,
        "sender_full_name": "oliver",
        "timestamp": 1610991216
    },
    {
        "content": "<p><a href=\"https://bpa.st/JHYA\">https://bpa.st/JHYA</a></p>",
        "id": 223147654,
        "sender_full_name": "Laurențiu",
        "timestamp": 1610991260
    },
    {
        "content": "<p><a href=\"https://gist.github.com/edwin0cheng/82663ac774ae14aa362236fadfce52e3\">https://gist.github.com/edwin0cheng/82663ac774ae14aa362236fadfce52e3</a></p>",
        "id": 223147696,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610991292
    },
    {
        "content": "<blockquote>\n<p>urgh this sucks, we've wanted a high-performance pure-Rust allocator for a long time now</p>\n</blockquote>\n<p>this needs <code>#[thread_local]</code> sadly</p>",
        "id": 223147722,
        "sender_full_name": "matklad",
        "timestamp": 1610991305
    },
    {
        "content": "<p>looks like the regression was due to the hygiene frame query then</p>",
        "id": 223148116,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610991566
    },
    {
        "content": "<p>low-effort improvement: <a href=\"https://github.com/rust-analyzer/rust-analyzer/pull/7331\">https://github.com/rust-analyzer/rust-analyzer/pull/7331</a></p>",
        "id": 223148286,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610991673
    },
    {
        "content": "<p>Wow, FileTextQuery is using <em>significantly</em> less memory for you</p>",
        "id": 223149309,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610992406
    },
    {
        "content": "<p>I don't know why that would be different</p>",
        "id": 223149322,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610992417
    },
    {
        "content": "<p>Do you have any text files generated from the project ? We all tested from a fresh github pull</p>",
        "id": 223149442,
        "sender_full_name": "Edwin Cheng",
        "timestamp": 1610992504
    },
    {
        "content": "<p>it's not actually using over 3 GB, that's the mallinfo wraparound</p>",
        "id": 223149469,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610992544
    },
    {
        "content": "<p>FileTextQuery really is just the raw file contents of on-disk files, you'd notice if <a href=\"http://docs.rs\">docs.rs</a> was more than 3 GB in size</p>",
        "id": 223149537,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610992578
    },
    {
        "content": "<p>well, that plus dependencies</p>",
        "id": 223149541,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610992586
    },
    {
        "content": "<p>perhaps its the allocator not releasing memory to the system?</p>",
        "id": 223149592,
        "sender_full_name": "cynecx",
        "timestamp": 1610992642
    },
    {
        "content": "<p>60 MB sounds about right for FileTextQuery</p>",
        "id": 223149597,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610992649
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"211568\">cynecx</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223149592\">said</a>:</p>\n<blockquote>\n<p>perhaps its the allocator not releasing memory to the system?</p>\n</blockquote>\n<p>we measure what the allocator reports, not what the kernel reports</p>",
        "id": 223149623,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610992678
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 223150595,
        "sender_full_name": "cynecx",
        "timestamp": 1610993467
    },
    {
        "content": "<p>isn't vfs unsually high? 60mb vs 813mb.</p>",
        "id": 223150609,
        "sender_full_name": "cynecx",
        "timestamp": 1610993486
    },
    {
        "content": "<p>currently adding back jemalloc support for more accurate stats</p>",
        "id": 223151043,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610993882
    },
    {
        "content": "<p>/me waits for the bug to disappear with jemalloc</p>",
        "id": 223151848,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1610994569
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"216201\">Edwin Cheng</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223149442\">said</a>:</p>\n<blockquote>\n<p>Do you have any text files generated from the project ? We all tested from a fresh github pull</p>\n</blockquote>\n<p>hmm I do have a bunch of untracked files, let me try deleting those</p>",
        "id": 223152440,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610995059
    },
    {
        "content": "<p>oh I bet I know what it is - does rust-analyzer try to look for recursive projects? It might be looking in <code>.rustwide</code> even though it shouldn't</p>",
        "id": 223152497,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610995085
    },
    {
        "content": "<p>hmm, that could be it</p>",
        "id": 223152565,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1610995162
    },
    {
        "content": "<p>well that actually explains why vfs is so high lol</p>",
        "id": 223152646,
        "sender_full_name": "cynecx",
        "timestamp": 1610995208
    },
    {
        "content": "<p>ok yeah I removed those and it's down to 1.9 GB</p>",
        "id": 223152655,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1610995219
    },
    {
        "content": "<p>(continued in <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/VFS.20eagerly.20loads.20all.20.2Ers.20files.20in.20the.20project.20directory\">https://rust-lang.zulipchat.com/#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/VFS.20eagerly.20loads.20all.20.2Ers.20files.20in.20the.20project.20directory</a>)</p>",
        "id": 223172415,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1611012040
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"211727\">Jonas Schievink  [he/him]</span> <a href=\"#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/running.20RA.20on.20docs.2Ers/near/223145339\">said</a>:</p>\n<blockquote>\n<p><code>int</code> is <code>i32</code> on x86_64</p>\n</blockquote>\n<blockquote>\n<p>The mallinfo2 function is added to report statistics as per mallinfo,<br>\n  but with larger field widths to accurately report values that are<br>\n  larger than fit in an integer.</p>\n</blockquote>",
        "id": 227094741,
        "sender_full_name": "Laurențiu",
        "timestamp": 1613831187
    },
    {
        "content": "<p>At least if you're running Arch or Gentoo</p>",
        "id": 227094867,
        "sender_full_name": "Laurențiu",
        "timestamp": 1613831350
    }
]