[
    {
        "content": "<p>Hey, I was trying to debug <a href=\"https://github.com/rust-analyzer/rust-analyzer/issues/4132\" title=\"https://github.com/rust-analyzer/rust-analyzer/issues/4132\">https://github.com/rust-analyzer/rust-analyzer/issues/4132</a> and seem to have a simple reproduction here:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">struct</span> <span class=\"nc\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">x</span>: <span class=\"nc\">T</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">Constraint</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Constraint</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n\n<span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">transform</span><span class=\"p\">(</span><span class=\"n\">x</span>: <span class=\"nc\">T</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">Self</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"k\">impl</span><span class=\"o\">&lt;</span><span class=\"n\">T</span>: <span class=\"nc\">Constraint</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">transform</span><span class=\"p\">(</span><span class=\"n\">x</span>: <span class=\"nc\">T</span><span class=\"p\">)</span><span class=\"w\"> </span>-&gt; <span class=\"nc\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">A</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">A</span>::<span class=\"n\">transform</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>In this case rust-analyzer shows the type of <code>a</code> in <code>main</code>  as <code>A&lt;{unknown}&gt;</code>, but it's able to infer <code>a: A&lt;i32&gt;</code> if I remove the <code>Constraint</code> trait or specify <code>1i32</code>. Any tips on how to further debug this?</p>\n<p>One thing I've seen so far that I don't understand is that at some point in <a href=\"https://github.com/rust-analyzer/rust-analyzer/blob/89e1f97515c36ab97bd378d972cabec0feb6d77e/crates/ra_hir_ty/src/infer.rs#L307\" title=\"https://github.com/rust-analyzer/rust-analyzer/blob/89e1f97515c36ab97bd378d972cabec0feb6d77e/crates/ra_hir_ty/src/infer.rs#L307\"><code>resolve_obligations_as_possible</code></a> we try to  resolve the obligation </p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"n\">Implements</span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"o\">&gt;</span>: <span class=\"nc\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>which should have a unique solution of <code>i32</code>, but the result we're getting is <code>Ambig(Unknown}</code>. Plugging the same program into the chalk repl seems like it should work fine:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"o\">?-</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"w\"></span>\n<span class=\"n\">Enter</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">program</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">press</span><span class=\"w\"> </span><span class=\"n\">Ctrl</span><span class=\"o\">-</span><span class=\"n\">D</span><span class=\"w\"> </span><span class=\"n\">when</span><span class=\"w\"> </span><span class=\"n\">finished</span><span class=\"w\"></span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">struct</span> <span class=\"nc\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">Constraint</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Constraint</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"o\">|</span><span class=\"w\"> </span><span class=\"k\">impl</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">T</span>: <span class=\"nc\">Constraint</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"o\">?-</span><span class=\"w\"> </span><span class=\"n\">exists</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"n\">U</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span>: <span class=\"nc\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">U</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"n\">Unique</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">substitution</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">?</span><span class=\"mi\">0</span><span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"p\">(</span><span class=\"n\">I32</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"mi\">1</span><span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Int</span><span class=\"p\">(</span><span class=\"n\">I32</span><span class=\"p\">)],</span><span class=\"w\"> </span><span class=\"n\">lifetime</span><span class=\"w\"> </span><span class=\"n\">constraints</span><span class=\"w\"> </span><span class=\"p\">[]</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>Any advice in particular on how to further check what statements are available to chalk and why it can't seem to resolve this obligation?</p>",
        "id": 196074601,
        "sender_full_name": "Adam Bratschi-Kaye (he)",
        "timestamp": 1588461425
    },
    {
        "content": "<p>to model this in Chalk the way rust-analyzer would, you need to mark the traits <code>#[non_enumerable]</code>. we don't allow open-ended searches of all impls, that's why this doesn't work</p>",
        "id": 196076001,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1588464122
    },
    {
        "content": "<p>I'm reasonably sure rustc also only does this for integer variables, and the problem is that Chalk doesn't know about integer variables yet</p>",
        "id": 196076066,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1588464214
    },
    {
        "content": "<p>This looks like either integer fallback or \"inference guessing\" (where it eagerly selects the only remaining impl that could apply) at work</p>",
        "id": 196076413,
        "sender_full_name": "Jonas Schievink  [he/him]",
        "timestamp": 1588464890
    },
    {
        "content": "<p>Thanks <span class=\"user-mention\" data-user-id=\"129457\">@Florian Diebold</span>, that makes sense. If I add the <code>#[non_enumerable]</code> tag then chalk doesn't provide a solution:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">struct</span> <span class=\"nc\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"cp\">#[non_enumerable]</span><span class=\"w\"></span>\n<span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">Constraint</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"cp\">#[non_enumerable]</span><span class=\"w\"></span>\n<span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Constraint</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"k\">impl</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">where</span><span class=\"w\"> </span><span class=\"n\">T</span>: <span class=\"nc\">Constraint</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n\n<span class=\"o\">?-</span><span class=\"w\"> </span><span class=\"n\">exists</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"n\">U</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span>: <span class=\"nc\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">U</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"n\">Ambiguous</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">no</span><span class=\"w\"> </span><span class=\"n\">inference</span><span class=\"w\"> </span><span class=\"n\">guidance</span><span class=\"w\"></span>\n</code></pre></div>\n\n\n<p>But now I'm confused as to why it doesn't at least determine that <code>T</code> and <code>U</code> should be the same type. It is able to do that if the implementation for <code>MyTrait</code> on <code>A</code> doesn't have the condition <code>T: Constraint</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code><span class=\"k\">struct</span> <span class=\"nc\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"cp\">#[non_enumerable]</span><span class=\"w\"></span>\n<span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">Constraint</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"cp\">#[non_enumerable]</span><span class=\"w\"></span>\n<span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Constraint</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"k\">impl</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n\n<span class=\"o\">?-</span><span class=\"w\"> </span><span class=\"n\">exists</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"n\">U</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">A</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span>: <span class=\"nc\">MyTrait</span><span class=\"o\">&lt;</span><span class=\"n\">U</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"n\">Unique</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"o\">&lt;?</span><span class=\"n\">U0</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">substitution</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">?</span><span class=\"mi\">0</span><span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">^</span><span class=\"mf\">0.0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">?</span><span class=\"mi\">1</span><span class=\"w\"> </span>:<span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">^</span><span class=\"mf\">0.0</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">lifetime</span><span class=\"w\"> </span><span class=\"n\">constraints</span><span class=\"w\"> </span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 196092977,
        "sender_full_name": "Adam Bratschi-Kaye (he)",
        "timestamp": 1588497220
    },
    {
        "content": "<p>Hmm I'm not sure, actually, that may require some debugging</p>",
        "id": 196093188,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1588497591
    },
    {
        "content": "<p>I'm happy to try looking into it.</p>",
        "id": 196093346,
        "sender_full_name": "Adam Bratschi-Kaye (he)",
        "timestamp": 1588497793
    },
    {
        "content": "<p>not sure if you were using the recursive solver or the SLG solver there, if it was in the REPL it was probably SLG. Maybe the problem exists in both, but it'll surely require different fixes</p>",
        "id": 196093435,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1588497934
    },
    {
        "content": "<p>oh, and if you want to look into it: (I don't know how familiar you are with Chalk, so) what I'd do is add a test for it in the Chalk repo, run it with <code>CHALK_DEBUG=2</code> (I just do that by calling <code>set_env</code> at the beginning of the test), and see what happens. Also probably ask about it over in #wg-traits ;)</p>",
        "id": 196093577,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1588498145
    },
    {
        "content": "<p>Thanks for the tips, I'm indeed not familiar with chalk. I was just using the repl by doing <code>cargo run</code> in the chalk repo, so if SLG is the default then that's what I had.</p>",
        "id": 196097563,
        "sender_full_name": "Adam Bratschi-Kaye (he)",
        "timestamp": 1588503992
    },
    {
        "content": "<p>Here's the thread in wg-traits: <a href=\"#narrow/stream/144729-wg-traits/topic/More.20guidance.20for.20an.20ambiguous.20query\" title=\"#narrow/stream/144729-wg-traits/topic/More.20guidance.20for.20an.20ambiguous.20query\">https://rust-lang.zulipchat.com/#narrow/stream/144729-wg-traits/topic/More.20guidance.20for.20an.20ambiguous.20query</a></p>",
        "id": 196278022,
        "sender_full_name": "Adam Bratschi-Kaye (he)",
        "timestamp": 1588665972
    }
]