[
    {
        "content": "<p>Sounds like we're not picking up one of the config files. Does a <code>cargo clean</code> fix it? I've seen this happen before after toolchain upgrades.</p>",
        "id": 271876064,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644866810
    },
    {
        "content": "<p>I'll try, the full rebuilds take a while for my project though, so i'll let you know in 5 minutes or so <span aria-label=\"stuck out tongue\" class=\"emoji emoji-1f61b\" role=\"img\" title=\"stuck out tongue\">:stuck_out_tongue:</span></p>",
        "id": 271876194,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644866865
    },
    {
        "content": "<p>Cargo clean hasn't fixed it :(</p>\n<p>I did try copying my cargo config to a fresh project, but I can't seem to reproduce the issue there. If you want I can send you my repo though, since it's public on gitlab.</p>",
        "id": 271879870,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644868478
    },
    {
        "content": "<p>I'll try it tomorrow</p>",
        "id": 271884665,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644870906
    },
    {
        "content": "<p>Here's my project, It's specifically the server subproject that's giving me problems since I have the .cargo/config.toml in there</p>\n<p><a href=\"https://gitlab.com/freddyb/scuddb\">https://gitlab.com/freddyb/scuddb</a></p>",
        "id": 271885948,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644871640
    },
    {
        "content": "<p>and my init.vim, i'm using neovim <a href=\"/user_uploads/4715/ySXeXrJcou__l17b-WOtKMuO/init.vim\">init.vim</a></p>",
        "id": 271886072,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644871702
    },
    {
        "content": "<p>rust-analyzer 17afa2e77 2022-01-24 stable</p>",
        "id": 271886112,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644871726
    },
    {
        "content": "<p>rust 1.58.1</p>",
        "id": 271886158,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644871749
    },
    {
        "content": "<p>Just tried it on another laptop, with the latest rust-analyzer, and i managed to reproduce it.</p>",
        "id": 271905981,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644882320
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/2XSZgvIi9Ip1QaNnI2ZJOVVR/Screencast-from-02-15-2022-124343-AM.webm\">Screencast-from-02-15-2022-124343-AM.webm</a> A short recording of what I have to do to trigger the bug. video ends with cargo blocking on build directory, but the proceeding build, after a few minutes, was a full rebuild.</p>",
        "id": 271906755,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644882918
    },
    {
        "content": "<p>Apparently the shared config in ~/.cargo/config.toml isn't even necessary <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 271911637,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644886260
    },
    {
        "content": "<p>Ok so I managed to make a reproducer: <a href=\"https://github.com/Frederik-Baetens/RA_rebuild\">https://github.com/Frederik-Baetens/RA_rebuild</a></p>\n<p>I think the fact that it's in a workspace is irrelevant (just something I tried to try &amp; reproduce, but that didn't end up triggering it)</p>\n<p>What ended up triggering it, is adding <code>console-subscriber = \"~0.1.2\"</code> to my dependencies.</p>",
        "id": 271914883,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644888783
    },
    {
        "content": "<p>I don't even need to use that dependency, just having it in my cargo.toml seems to be enough. It's not a surprise that it's that specific dependency causing problems though, because the rustflags in the .cargo/config.toml are for that specific dependency.</p>",
        "id": 271918246,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644891709
    },
    {
        "content": "<p><a href=\"/user_uploads/4715/2pxhJS1ILwZtXvNiMJSlBZCT/2022-02-15-18-57-18_na.mp4\">2022-02-15-18-57-18_na.mp4</a></p>",
        "id": 272004151,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644944441
    },
    {
        "content": "<p>I don't seem to be able to reproduce this in VS Code</p>",
        "id": 272004250,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644944479
    },
    {
        "content": "<p>Yes, i'm using nvim, are you open to attempting this with the init.vim I posted above?</p>",
        "id": 272005176,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644944813
    },
    {
        "content": "<p>And I'm not sure that vs code invokes rust-analyzer in exactly the same way as my init.vim does.</p>\n<p>If you're not familliar, the init.vim goes in ~/.config/nvim/init.vim</p>",
        "id": 272005351,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644944868
    },
    {
        "content": "<p>You need to run :PlugInstall first in nvim to set everything up</p>",
        "id": 272005499,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644944908
    },
    {
        "content": "<p>are you running your <code>cargo build</code> from a different terminal, or from inside vim?</p>",
        "id": 272008458,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1644945972
    },
    {
        "content": "<p>ah, there's a video</p>",
        "id": 272008606,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1644946036
    },
    {
        "content": "<p>maybe it'd be interesting to try running it from inside vim, to see whether there's a difference in environments there</p>",
        "id": 272008757,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1644946083
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"129457\">@Florian Diebold</span>  This also happens when invoking cargo build from inside vim with :!cargo build.</p>\n<p>I understand that this being unreproducable in vs-code makes it seem like this is my problem, but I copied the <a href=\"https://sharksforarms.dev/posts/neovim-rust/\">https://sharksforarms.dev/posts/neovim-rust/</a> config, which was mentioned on <a href=\"https://rust-analyzer.github.io/manual.html#vimneovim\">https://rust-analyzer.github.io/manual.html#vimneovim</a>, so I hope that my setup isn't all that weird. Does VSCode also run cargo clippy for every file save? Maybe that makes a difference?</p>\n<p>Come to think of it, I should try if i can reproduce this without using RA, by just invoking cargo clippy <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 272046763,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644963709
    },
    {
        "content": "<p>Just tried it, manually invoking cargo clippy doesn't cause a rebuild afterwards.</p>",
        "id": 272046975,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644963827
    },
    {
        "content": "<p>Alternatively, is there a more \"supported\" way of using RA with neovim? (not to imply that a fantastic volunteer project such as this should provide support, but just a config that's assumed to work better)</p>",
        "id": 272047277,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644963968
    },
    {
        "content": "<p>what does running <code>cargo build -v</code> say (when it does the rebuild)?</p>",
        "id": 272047698,
        "sender_full_name": "Florian Diebold",
        "timestamp": 1644964235
    },
    {
        "content": "<p><span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> I ran :PlugUpdate and that seems to have fixed my problem? I don't know if that was actually the fix, but I can't seem to reproduce it for now.</p>\n<p>I also briefly swapped to another vim config, closed all my vim instances, swapped back to my rust-analyzer vim config and now everything works <span aria-label=\"shrug\" class=\"emoji emoji-1f937\" role=\"img\" title=\"shrug\">:shrug:</span></p>",
        "id": 272052287,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644967232
    },
    {
        "content": "<p>Sorry for bothering you, will update if I manage to encounter this problem again.</p>",
        "id": 272052306,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644967247
    },
    {
        "content": "<p>Never mind, forgot to include the .cargo/config.toml in the reproducer repository apparently? Apologies.</p>\n<p><span class=\"user-mention\" data-user-id=\"203546\">@Laurențiu</span> could you try again, I pushed the config to the repo. perhaps it's reproducible now in VS code as well?</p>",
        "id": 272059940,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644972290
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"129457\">@Florian Diebold</span> Here's the output of build -v when the rebuild issue occurs: <a href=\"https://pastebin.com/CKepFS21\">https://pastebin.com/CKepFS21</a></p>",
        "id": 272060255,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644972517
    },
    {
        "content": "<p>Just installed vscode myself with rust-analyzer, and I managed to reproduce this problem with the full rebuilds there as well.</p>",
        "id": 272061421,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644973467
    },
    {
        "content": "<p>I managed to reproduce it again. apparently I had forgotten to include the .cargo config in the repo, apologies.</p>\n<p>So I tried reproducing it in rust-analyzer, and I can't get it to reproduce there, but I can trigger it by running rust-analyzer in vscode, and then running cargo build manually in my terminal</p>",
        "id": 272064812,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644976757
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"129457\">@Florian Diebold</span> here's the build -v output from when the rebuild happens <a href=\"https://pastebin.com/CKepFS21\">https://pastebin.com/CKepFS21</a></p>",
        "id": 272065000,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644976912
    },
    {
        "content": "<p>Running a manual cargo build, also seems to trigger a full rebuild when running in vscode again.</p>",
        "id": 272065058,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644976945
    },
    {
        "content": "<p><span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> this makes me suspect that RA and cargo build are running with different working directories which may not include the .cargo config even though i'm launching nvim and cargo build from the same directory. Is that possible?</p>",
        "id": 272065207,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644977108
    },
    {
        "content": "<p>I think that's it. Moving my .cargo config to the top of the workspace makes this no longer occur. I think rust-analyzer commands are launched from the top level of the workspace, where the cargo config didn't get included.</p>",
        "id": 272066037,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644977976
    },
    {
        "content": "<p>This issue doesn't occur in VSCode itself, because it also runs its build commands in the top level of the workspace, thereby also avoiding the .cargo config lower down in the workspace.</p>",
        "id": 272066113,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644978050
    },
    {
        "content": "<p>Is the working directory where rust-analyzer gets run something rust-analyzer has control over? Could rust analyzer run starting from the location of the file being edited instead of the top of the workspace?</p>",
        "id": 272066346,
        "sender_full_name": "Frederik Baetens",
        "timestamp": 1644978279
    },
    {
        "content": "<p>I think we mostly avoid changing the current directory. But doesn't <code>cargo build -p path/to/manifest</code> pick up the config file?</p>",
        "id": 272079205,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644994355
    },
    {
        "content": "<p>I think I also noticed some CWD-related weirdness in other editors</p>",
        "id": 272079223,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644994382
    },
    {
        "content": "<blockquote>\n<p>apparently I had forgotten to include the .cargo config in the repo</p>\n</blockquote>\n<p>I could have sworn I saw the <code>config.toml</code> there, but it was under <code>subproj/src/.cargo</code>. <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span> But I still can't reproduce it.</p>",
        "id": 272079347,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644994558
    },
    {
        "content": "<p>Ooh, you're running <code>cargo build</code> in <code>subproj</code>.</p>",
        "id": 272079521,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644994728
    },
    {
        "content": "<p>I think <code>subproj/cargo.toml</code> only applies when you run <code>cargo build</code> in <code>subproj</code>, and it's not picked up by <code>cargo build</code> from the workspace root.</p>",
        "id": 272079648,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644994825
    },
    {
        "content": "<p>Try this:</p>\n<div class=\"codehilite\"><pre><span></span><code>cargo build\ncd subproj\ncargo build\ncd ..\ncargo build\n</code></pre></div>",
        "id": 272079711,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644994890
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"398861\">Frederik Baetens</span> <a href=\"#narrow/stream/185405-t-compiler.2Frust-analyzer/topic/multiple.20cargo.20configs.20causes.20full.20rebuilds.20with.20rust-ana.2E.2E.2E/near/272066037\">said</a>:</p>\n<blockquote>\n<p>I think that's it. Moving my .cargo config to the top of the workspace makes this no longer occur.</p>\n</blockquote>\n<p>Oh, you've already figured it out.</p>",
        "id": 272080542,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644995673
    },
    {
        "content": "<p>The problem is that we simply run <code>cargo check</code> to get the workspace diagnostics. Otherwise we'd need to run <code>cargo check</code> on each project in the workspace.</p>",
        "id": 272083350,
        "sender_full_name": "Laurențiu",
        "timestamp": 1644998290
    }
]