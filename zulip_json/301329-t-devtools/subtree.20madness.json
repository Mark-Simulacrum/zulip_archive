[
    {
        "content": "<p>relatively confident this is a PEBKAC issue, but sending out a flare after banging a hole in my desk with my head..</p>\n<p>i'm trying to sync commits back to rust-lang/rustfmt from rust-lang/rust via the standard git subtree flows, but git is refusing the _push_, apparently because it's behind the remote, while a subtree pull is a no op because everything's already up to date.</p>\n<p>didn't encounter this issue on the last sync, and have been following the standard instructions the clippy team documented (<a href=\"https://github.com/rust-lang/rust-clippy/blob/master/CONTRIBUTING.md#performing-the-sync-from-rust-langrust-to-clippy\">https://github.com/rust-lang/rust-clippy/blob/master/CONTRIBUTING.md#performing-the-sync-from-rust-langrust-to-clippy</a>). it's starting to look like i might have to split/rejoin manually, which gives me pause as i feel like the standard push/pull model should just work</p>\n<p>any and all suggestions are appreciated, especially if this was caused by me doing something goofy</p>",
        "id": 258831093,
        "sender_full_name": "Caleb Cartwright",
        "timestamp": 1635005982
    },
    {
        "content": "<p>can you post the error you're seeing?</p>",
        "id": 258831758,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1635006953
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/301329-t-devtools/topic/subtree.20madness/near/258831758\">said</a>:</p>\n<blockquote>\n<p>can you post the error you're seeing?</p>\n</blockquote>\n<p>this, have tried with a few different branches to no avail</p>\n<div class=\"codehilite\"><pre><span></span><code>$ git subtree push -P src/tools/rustfmt https://github.com/calebcartwright/rustfmt sync-doc-commits\ngit push using:  https://github.com/calebcartwright/rustfmt sync-doc-commits\nTo https://github.com/calebcartwright/rustfmt\n ! [rejected]                29be5483b618ecbf216aff559098c61e23b300c0 -&gt; sync-doc-commits (non-fast-forward)\nerror: failed to push some refs to &#39;https://github.com/calebcartwright/rustfmt&#39;\nhint: Updates were rejected because the tip of your current branch is behind\nhint: its remote counterpart. Integrate the remote changes (e.g.\nhint: &#39;git pull ...&#39;) before pushing again.\nhint: See the &#39;Note about fast-forwards&#39; in &#39;git push --help&#39; for details.\n</code></pre></div>",
        "id": 258831951,
        "sender_full_name": "Caleb Cartwright",
        "timestamp": 1635007210
    },
    {
        "content": "<p>hmm, yeah I'm not sure</p>",
        "id": 258832463,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1635007976
    },
    {
        "content": "<p>You already have a single commit on this branch: <a href=\"https://github.com/calebcartwright/rustfmt/tree/sync-doc-commits\">https://github.com/calebcartwright/rustfmt/tree/sync-doc-commits</a></p>",
        "id": 258832711,
        "sender_full_name": "bjorn3",
        "timestamp": 1635008323
    },
    {
        "content": "<p>yeah i'd started messing around trying to get it to work, and subsequently merged a PR in the rustfmt repo, but i got the same behavior across the board. and even (now) with that one, a subtree pull will go through, but push still hits the same issue</p>",
        "id": 258832883,
        "sender_full_name": "Caleb Cartwright",
        "timestamp": 1635008509
    },
    {
        "content": "<p>Try pushing to a different branch. Preferably a not yet existing branch.</p>",
        "id": 258833044,
        "sender_full_name": "bjorn3",
        "timestamp": 1635008712
    },
    {
        "content": "<p>that worked</p>",
        "id": 258833108,
        "sender_full_name": "Caleb Cartwright",
        "timestamp": 1635008793
    },
    {
        "content": "<p>well, at least from git. the diff looks extremely odd though - <a href=\"https://github.com/rust-lang/rustfmt/compare/master...calebcartwright:subtree-push-debugging?expand=1\">https://github.com/rust-lang/rustfmt/compare/master...calebcartwright:subtree-push-debugging?expand=1</a></p>",
        "id": 258833144,
        "sender_full_name": "Caleb Cartwright",
        "timestamp": 1635008862
    },
    {
        "content": "<p>hmm that may actually just be due to some stuff i've tried locally. let me try with a completely clean workspace and a net-new branch and see if that produces a more reasonable diff</p>",
        "id": 258833212,
        "sender_full_name": "Caleb Cartwright",
        "timestamp": 1635008922
    },
    {
        "content": "<p>nope same issue, and the diff for the push is the same as the diff from pull in rust-lang/rust that just landed</p>\n<p><a href=\"https://github.com/rust-lang/rustfmt/compare/master...calebcartwright:new-subtree-sync?expand=1\">https://github.com/rust-lang/rustfmt/compare/master...calebcartwright:new-subtree-sync?expand=1</a><br>\n<a href=\"https://github.com/rust-lang/rust/pull/90087\">https://github.com/rust-lang/rust/pull/90087</a></p>\n<p>which makes me think there's a history related issue</p>",
        "id": 258833657,
        "sender_full_name": "Caleb Cartwright",
        "timestamp": 1635009505
    },
    {
        "content": "<p>So pull almost always just works. You might have some merge conflicts, but otherwise it works.</p>\n<p>Push on the other hand has more things you have to know about.</p>\n<p>So the above error is because the branch already exists and the changes can't be fast-forwarded. This can be avoided by just deleting the branch before running <code>git subtree push</code>.  I recommend to always make sure that you delete the branch beforehand. Otherwise you'll have to wait for the whole <code>push</code> again.</p>\n<p>The weird diff you see is because <code>git subtree</code> bases the push on the last commit that was synced to <code>rust-lang/rust</code> and not on the current <code>master</code> branch of <code>rust-lang/rustffmt</code>. So most of the time you'll have to:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>git subtree push -P ... branch-name\ngit checkout branch-name\ngit merge upstream/master  <span class=\"c1\"># assuming `upstream` points to the `github.com/rust-lang/rustfmt.git` remote</span>\n</code></pre></div>\n<p>and then resolve merge conflicts. It is important, that you use <code>git merge</code> and not <code>git rebase</code>, otherwise <code>git subtree</code> will get really confused.</p>\n<p>My usual workflow is to push to a <em>local</em> remote, so your clone of the rustfmt repo:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"c1\"># assuming the rust-lang/rust and rust-lang/rustfmt clone are in the same directory</span>\n<span class=\"c1\"># in the rust directory:</span>\ngit remote add rustfmt-local ../rustfmt\ngit subtree push -P ... rustfmt-local branch-name\n<span class=\"c1\"># in the rustfmt directory:</span>\ngit checkout branch-name\ngit fetch upstream\ngit merge upstream/master\n<span class=\"c1\"># resolve merge conflicts</span>\ngit push ...\n</code></pre></div>\n<p>With pushing to the local repository, you will also have to make sure that the branch doesn't exist. Before syncing, just run <code>git branch -D branch-name</code> for that.</p>\n<p>I also recommend to do the <code>push</code> first. In Clippy we don't run all of our tests in the Rust repository. Running the push first makes sure that a completely working (and correctly formatted) version gets synced into the Rust repo every 2 weeks. Not sure if that is a concern for rustfmt though.</p>",
        "id": 258877725,
        "sender_full_name": "flip1995",
        "timestamp": 1635080296
    },
    {
        "content": "<p>I'm looking to improve our documentation on all the sync/release process, so knowing what's missing there is nice for that. So let me know if you have any other questions!</p>",
        "id": 258878051,
        "sender_full_name": "flip1995",
        "timestamp": 1635080770
    },
    {
        "content": "<p>thank you so much <span class=\"user-mention\" data-user-id=\"264664\">@flip1995</span>! i think the biggest piece i was missing was the need for a new/clean branch on pushes, as my initial reading of the docs led me to believe that <code>sync-from-rust</code> was a long lived branch used for all syncs.</p>\n<p>trying to use a single/existing branch led me down all sorts of confusing rabbit holes but it all makes sense, and is working now <span aria-label=\"heart\" class=\"emoji emoji-2764\" role=\"img\" title=\"heart\">:heart:</span></p>",
        "id": 258892194,
        "sender_full_name": "Caleb Cartwright",
        "timestamp": 1635101304
    }
]