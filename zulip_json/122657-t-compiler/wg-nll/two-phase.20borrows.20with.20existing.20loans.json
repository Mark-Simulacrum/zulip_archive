[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116009\">@nikomatsakis</span> Just chatted with <span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span>, and I learned that we accept code like</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">fn</span> <span class=\"nf\">two_phase_overlapping1</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"o\">!</span><span class=\"p\">[];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">x</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</pre></div>\n\n\n<p>Can we, uh, not do that?^^ It would do quite horrible things to Stacked Borrows. Firstly, it'd kill the stack. More interestingly, to actually properly explain what happens (<span class=\"user-mention\" data-user-id=\"126804\">@Ariel Ben-Yehuda</span> came up with some way more crazy examples), we'd probably have to generalize from a stack to a tree or some such thing</p>",
        "id": 148375189,
        "sender_full_name": "RalfJ",
        "timestamp": 1543246770
    },
    {
        "content": "<p>I think I have a fairly simple way of supporting two-phase borrows by immediately sharing the mutable reference, done. this works nicely together with the rule that <em>reading</em> from a mutable reference does not require popping of frozen/shared items.</p>",
        "id": 148375275,
        "sender_full_name": "RalfJ",
        "timestamp": 1543246827
    },
    {
        "content": "<p>but code like the above breaks that idea completely</p>",
        "id": 148375296,
        "sender_full_name": "RalfJ",
        "timestamp": 1543246846
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span> hmm</p>",
        "id": 148385841,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543256003
    },
    {
        "content": "<p>we <em>could</em></p>",
        "id": 148385854,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543256027
    },
    {
        "content": "<p>I'm not opposed to doing so per se, just thinking about the schedule</p>",
        "id": 148385863,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543256038
    },
    {
        "content": "<p>we might be able to get away with calling this a bug fix</p>",
        "id": 148385867,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543256042
    },
    {
        "content": "<p>I guess we can still backport to Rust 2018</p>",
        "id": 148385913,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543256052
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span> can you file an issue?</p>",
        "id": 148385919,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543256063
    },
    {
        "content": "<p>Hmm. The code is actually safe, isn't it? It feels wrong to go out of the way to disallow safe code; the point of NLL is to reduce false negatives.</p>",
        "id": 148393146,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1543261761
    },
    {
        "content": "<p>well, that's the question, isn't it</p>",
        "id": 148394380,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543262806
    },
    {
        "content": "<p>that is, the code is not safe according to the stacked borrows rules that <span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span> has been working on, it's UB</p>",
        "id": 148394399,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543262822
    },
    {
        "content": "<p>but the question then is whether this makes the rules wrong</p>",
        "id": 148394412,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543262831
    },
    {
        "content": "<p>I'm inclined to try and tread carefully here</p>",
        "id": 148394424,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543262847
    },
    {
        "content": "<p>I'd still like to do <a href=\"https://github.com/rust-lang/rust/issues/53198\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/53198\">this refactoring</a></p>",
        "id": 148394529,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543262912
    },
    {
        "content": "<p>which I think would also reject the example in question</p>",
        "id": 148394566,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543262951
    },
    {
        "content": "<p>opened <a href=\"https://github.com/rust-lang/rust/issues/56254\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/56254\">https://github.com/rust-lang/rust/issues/56254</a></p>",
        "id": 148394727,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543263080
    },
    {
        "content": "<blockquote>\n<p>this makes the rules wrong</p>\n</blockquote>\n<p>I think this is the crux for me â€” what is actually driving what Rust-the-language accepts? Is stacked borrows the true arbiter of what's safe?</p>",
        "id": 148395291,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1543263576
    },
    {
        "content": "<p>it aims to be</p>",
        "id": 148395529,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543263782
    },
    {
        "content": "<p>we can of course decide that it should accept this code</p>",
        "id": 148395540,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543263790
    },
    {
        "content": "<p>there's a sort of balancing act</p>",
        "id": 148395543,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543263793
    },
    {
        "content": "<p>how complex are the rules to describe</p>",
        "id": 148395548,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543263796
    },
    {
        "content": "<p>(and understand)</p>",
        "id": 148395560,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543263809
    },
    {
        "content": "<p>vs what code they accept</p>",
        "id": 148395563,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543263811
    },
    {
        "content": "<p>(and what optimizations they permit)</p>",
        "id": 148395575,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543263827
    },
    {
        "content": "<p>As an outsider, it's interesting because it seems like stacked borrows is a post-hoc justification of what \"the code\" does. This makes it weird when the code is adjusted to fit the model (physicists everywhere are jealous)</p>",
        "id": 148395702,
        "sender_full_name": "Jake Goulding",
        "timestamp": 1543263937
    },
    {
        "content": "<blockquote>\n<p>As an outsider, it's interesting because it seems like stacked borrows is a post-hoc justification of what \"the code\" does. This makes it weird when the code is adjusted to fit the model (physicists everywhere are jealous)</p>\n</blockquote>\n<p>stacked borrows is a post-hoc justification of original borrowck and might serve as a guide for future borrowck evolution. also, it might uncover situations where borrowck is inconsistent or runs afoul of guarantees we might want to have. in this concrete case, for example, whether or not we allow such code has influence on how hard it will be for an optimization pass to analyze which shared reference can alias a given mutable reference.</p>",
        "id": 148399247,
        "sender_full_name": "RalfJ",
        "timestamp": 1543267462
    },
    {
        "content": "<p>but mostly, I'd like us to be able to <em>have that discussion</em></p>",
        "id": 148399254,
        "sender_full_name": "RalfJ",
        "timestamp": 1543267475
    },
    {
        "content": "<p>and that means not stabilizing too much too early</p>",
        "id": 148399260,
        "sender_full_name": "RalfJ",
        "timestamp": 1543267484
    },
    {
        "content": "<p>physicists model an immutable reality, whereas modelling programming languages can hopefully contribute to improve the future evolution of that language ;)</p>",
        "id": 148399511,
        "sender_full_name": "RalfJ",
        "timestamp": 1543267781
    },
    {
        "content": "<p>think HTML but with a lot more formal verification :)</p>",
        "id": 148399568,
        "sender_full_name": "Keith Yeung",
        "timestamp": 1543267806
    },
    {
        "content": "<p>and of course, without the backwards compatibility issues</p>",
        "id": 148399585,
        "sender_full_name": "Keith Yeung",
        "timestamp": 1543267823
    },
    {
        "content": "<p>I'd actually claim that doing formal models during development will often lead to a better understanding of what is being developed, and thus a better language</p>",
        "id": 148399597,
        "sender_full_name": "RalfJ",
        "timestamp": 1543267839
    },
    {
        "content": "<p>looks <span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span> like this <em>might</em> be a small diff</p>",
        "id": 148403361,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543271287
    },
    {
        "content": "<p>I guess we'll see what errors I get</p>",
        "id": 148403364,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543271292
    },
    {
        "content": "<p>hmm, I get a bunch :)</p>",
        "id": 148404220,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543272005
    },
    {
        "content": "<p>from the match desugaring, I think</p>",
        "id": 148404224,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543272010
    },
    {
        "content": "<p>ah, yes</p>",
        "id": 148404307,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543272091
    },
    {
        "content": "<p>I have to check, <span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> might remember better, but I believe we are relying on the current behavior in match desugaring -- we create shared borrows of the various \"discriminants\" that we examine</p>",
        "id": 148404376,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543272126
    },
    {
        "content": "<p>then we make two-phase borrows for <code>ref mut</code> bindings</p>",
        "id": 148404382,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543272135
    },
    {
        "content": "<p>but they are not activated until we enter the arm</p>",
        "id": 148404390,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543272142
    },
    {
        "content": "<p>some of those have the peculiar characteristic that they are 2PB that <em>never</em> get activated</p>",
        "id": 148404419,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543272189
    },
    {
        "content": "<p>We also create borrows of the places that we bind variables to, which is the more difficult one to fix, since they don't have a different borrow kind.</p>",
        "id": 148404904,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543272669
    },
    {
        "content": "<p>I'll try to write up what I think is the best solution (with the time we have) tomorrow.</p>",
        "id": 148405029,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543272835
    },
    {
        "content": "<p>So the simplest thing that I think we can do is to add another borrow kind that doesn't conflict with reservations, but is otherwise a shared borrow. Then move all fake borrows to that kind (shallow borrows aren't compatible with niche layout optimisations) and remove the shallow borrow kind. <br>\nThis would also allow us to do all post NLL cleanup in a single pass (we wouldn't backport that part).</p>",
        "id": 148623123,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543305645
    },
    {
        "content": "<p>Having a different borrow kind isn't great, but fake borrows are strange and special anyway.</p>",
        "id": 148623253,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543305816
    },
    {
        "content": "<blockquote>\n<p>some of those have the peculiar characteristic that they are 2PB that <em>never</em> get activated</p>\n</blockquote>\n<p>They are activated as long as the arm is reachable, which doesn't seem any different to function call two phase borrows.</p>",
        "id": 148623379,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543305999
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> what would be an example of a desugared match guard that relies on the existing-loans-are-preserved thing?</p>",
        "id": 148628950,
        "sender_full_name": "RalfJ",
        "timestamp": 1543313577
    },
    {
        "content": "<p>Any match that has a mut ref binding with a match guard.</p>",
        "id": 148629344,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543314154
    },
    {
        "content": "<p>okay so let's say we have</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">fn</span> <span class=\"nf\">foo</span><span class=\"p\">(</span><span class=\"n\">x</span>: <span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"nb\">String</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">.</span><span class=\"n\">starts_with</span><span class=\"p\">(</span><span class=\"s\">&quot;hello&quot;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"p\">.</span><span class=\"n\">push_str</span><span class=\"p\">(</span><span class=\"s\">&quot; world!&quot;</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{},</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</pre></div>\n\n\n<p>what does this desugar to, with the fake refs?</p>",
        "id": 148631912,
        "sender_full_name": "RalfJ",
        "timestamp": 1543317744
    },
    {
        "content": "<p>@RalfJ so the problem is a conflict with the \"borrow lock\"</p>",
        "id": 148632683,
        "sender_full_name": "Ariel Ben-Yehuda",
        "timestamp": 1543318905
    },
    {
        "content": "<p>*the \"discriminant lock\" borrow</p>",
        "id": 148632690,
        "sender_full_name": "Ariel Ben-Yehuda",
        "timestamp": 1543318910
    },
    {
        "content": "<p>which borrows <code>x</code> immutably for the duration of the arms</p>",
        "id": 148632693,
        "sender_full_name": "Ariel Ben-Yehuda",
        "timestamp": 1543318921
    },
    {
        "content": "<p>(to prevent it from being modified in a way that breaks exhaustiveness)</p>",
        "id": 148632737,
        "sender_full_name": "Ariel Ben-Yehuda",
        "timestamp": 1543318930
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><span class=\"n\">_fake1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">shallow</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"n\">_fake2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">).</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"c1\">// switch on discriminant</span>\n<span class=\"n\">s_for_guard</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">).</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"n\">s_for_guard_ref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">s_for_guard</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"c1\">// guard, using *s_for_guard_ref instead of s</span>\n<span class=\"n\">FakeRead</span><span class=\"p\">(</span><span class=\"n\">_fake1</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"n\">FakeRead</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">_fake2</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">s_for_guard</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"c1\">// Arm as usual</span>\n</pre></div>",
        "id": 148632745,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543318954
    },
    {
        "content": "<p>yea that</p>",
        "id": 148632759,
        "sender_full_name": "Ariel Ben-Yehuda",
        "timestamp": 1543318990
    },
    {
        "content": "<p>Everything involving _fakeN is deleted shortly after NLL</p>",
        "id": 148632851,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543319100
    },
    {
        "content": "<blockquote>\n<p>Having a different borrow kind isn't great, but fake borrows are strange and special anyway.</p>\n</blockquote>\n<p>this is what I was thinking</p>",
        "id": 148643910,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543331600
    },
    {
        "content": "<p>for one thing, these \"borrow locks\" are different in kind from other borrows</p>",
        "id": 148643922,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543331614
    },
    {
        "content": "<p>hmm, well, are they?</p>",
        "id": 148643930,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543331621
    },
    {
        "content": "<p>I think they are -- or at least <em>could be</em></p>",
        "id": 148643941,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543331640
    },
    {
        "content": "<p>That is, they are there to enforce rules about what you can/can't do in match arms, guards, etc, because of our exhaustiveness rules. It potentially creates UB to violate those rules because you mess up our match desugaring.</p>",
        "id": 148644015,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543331669
    },
    {
        "content": "<p>However, it's not clear that <strong>stacked borrows</strong> cares about this</p>",
        "id": 148644022,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543331677
    },
    {
        "content": "<p>that is, if you used unsafe code to violate those loans, this may create UB, but not necessarily because of an aliasing violation</p>",
        "id": 148644046,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543331699
    },
    {
        "content": "<p>(it's more akin to creating UB by relying on the layout of a struct or some such thing, which we are free to change)</p>",
        "id": 148644074,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543331724
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> did you do any work on that?</p>",
        "id": 148644101,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543331748
    },
    {
        "content": "<p>I've done no work on this yet since I've been traveling. I should be able to get this done tonight if you don't want to take it.</p>",
        "id": 148651932,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543338294
    },
    {
        "content": "<p>I've not done anything, not feeling well today. Probably shoudn't be typing here now I'm supposed to be sleeping :P</p>",
        "id": 148657686,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543343156
    },
    {
        "content": "<p>using the original example, if i try to push twice, it errors with </p>\n<div class=\"codehilite\"><pre><span></span><span class=\"n\">error</span><span class=\"p\">[</span><span class=\"n\">E0502</span><span class=\"p\">]</span>: <span class=\"nc\">cannot</span><span class=\"w\"> </span><span class=\"n\">borrow</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">x</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">mutable</span><span class=\"w\"> </span><span class=\"n\">because</span><span class=\"w\"> </span><span class=\"n\">it</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">also</span><span class=\"w\"> </span><span class=\"n\">borrowed</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">immutable</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"o\">-</span>-&gt; <span class=\"nc\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">4</span>:<span class=\"mi\">5</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\"></span>\n<span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">x</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"n\">immutable</span><span class=\"w\"> </span><span class=\"n\">borrow</span><span class=\"w\"> </span><span class=\"n\">occurs</span><span class=\"w\"> </span><span class=\"n\">here</span><span class=\"w\"></span>\n<span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"o\">^^^^^^^^^^^^^^^</span><span class=\"w\"> </span><span class=\"n\">mutable</span><span class=\"w\"> </span><span class=\"n\">borrow</span><span class=\"w\"> </span><span class=\"n\">occurs</span><span class=\"w\"> </span><span class=\"n\">here</span><span class=\"w\"></span>\n<span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">immutable</span><span class=\"w\"> </span><span class=\"n\">borrow</span><span class=\"w\"> </span><span class=\"n\">later</span><span class=\"w\"> </span><span class=\"n\">used</span><span class=\"w\"> </span><span class=\"n\">here</span><span class=\"w\"></span>\n</pre></div>\n\n\n<p>(posting ^ if it gives a bigger picture / current diagnostics. if I push once and debug print x, it works, printing <code>[0]</code>)</p>",
        "id": 148663089,
        "sender_full_name": "memoryruins",
        "timestamp": 1543348350
    },
    {
        "content": "<p>Ugh, we need Shallow borrows to allow matching on <code>(*x).1</code> while <code>(*x).0</code> is borrowed.</p>",
        "id": 148673170,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543357795
    },
    {
        "content": "<p>{WIP] PR <a href=\"https://github.com/rust-lang/rust/pull/56301\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/pull/56301\">https://github.com/rust-lang/rust/pull/56301</a>. Thinking about this some more, I'm not convinced that 2 phase borrows are the correct way of handling match guards at all. Notably, in <code>match x { ref mut z if ...</code>, <code>x</code> should be mutably borrowed for the guard, as well as for the match arm.</p>",
        "id": 148677017,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543361821
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> I assume the <code>&amp;mut</code> there is an <code>&amp;mut2phase</code>?</p>",
        "id": 148696267,
        "sender_full_name": "RalfJ",
        "timestamp": 1543392600
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"126804\">@Ariel Ben-Yehuda</span> <span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> See <a href=\"https://github.com/rust-lang/rust/issues/56254#issuecomment-442357546\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/56254#issuecomment-442357546\">https://github.com/rust-lang/rust/issues/56254#issuecomment-442357546</a>: I don't understand why my desugaring based on transmute does not work. All pointer addresses are the same, from what I can see.</p>",
        "id": 148696440,
        "sender_full_name": "RalfJ",
        "timestamp": 1543392856
    },
    {
        "content": "<blockquote>\n<p>x should be mutably borrowed for the guard, as well as for the match arm.</p>\n</blockquote>\n<p>by \"mutably borrowed\" you mean there should be an active mutable loan?</p>",
        "id": 148696601,
        "sender_full_name": "RalfJ",
        "timestamp": 1543393085
    },
    {
        "content": "<p>Yes.</p>",
        "id": 148696748,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543393372
    },
    {
        "content": "<p>Anyway, i think i have a way to avoid 2PB for matches.</p>",
        "id": 148696757,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543393402
    },
    {
        "content": "<p>Is that included in your PR above?</p>",
        "id": 148697047,
        "sender_full_name": "RalfJ",
        "timestamp": 1543393888
    },
    {
        "content": "<p>I now have an implementation of two-phase borrows <em>without</em> existing loans. It <a href=\"https://github.com/solson/miri/compare/rustup...RalfJung:stacked-borrows-2-phase\" target=\"_blank\" title=\"https://github.com/solson/miri/compare/rustup...RalfJung:stacked-borrows-2-phase\">is trivial, as expected</a>: When retagging for an <code>&amp;mut2phase</code>, after doing the usual retag business, we simply immediately do a shared re-borrow of the mutable borrow we just created. done.</p>",
        "id": 148698356,
        "sender_full_name": "RalfJ",
        "timestamp": 1543395829
    },
    {
        "content": "<p>No, it's a different approach. I'm still thinking it through.</p>",
        "id": 148698415,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543395878
    },
    {
        "content": "<p>We do not have to rewrite the other uses, because <em>read</em> uses of something shared do not invalidate mutable references that are ancestors of the shared one</p>",
        "id": 148698423,
        "sender_full_name": "RalfJ",
        "timestamp": 1543395894
    },
    {
        "content": "<p>as in, <code>let x = &amp;mut 2; let y = &amp;*x; let _val1 = *x; let _val2 = *y;</code> is fine because reading through <code>x</code> does not invalidate <code>y</code></p>",
        "id": 148698443,
        "sender_full_name": "RalfJ",
        "timestamp": 1543395940
    },
    {
        "content": "<p>that also applies \"further up the chain\":</p>\n<div class=\"codehilite\"><pre><span></span>let x = &amp;mut 42;\nlet y = &amp;mut*x;\nlet z = &amp;*y;\nlet _val1 = *x;\nlet _val2 = *y;\n</pre></div>\n\n\n<p>would be fine if it was accepted, because  reading <code>x</code> is justified by <code>z</code>, and hence does not have to invalidate <code>y</code></p>",
        "id": 148698484,
        "sender_full_name": "RalfJ",
        "timestamp": 1543395964
    },
    {
        "content": "<p>This works quite nicely for 2phase borrows (they are only a tiny extension of the model), but it enforces that there be no outstanding references when the 2phase borrow starts.</p>",
        "id": 148698566,
        "sender_full_name": "RalfJ",
        "timestamp": 1543396089
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span> the transmute based desugaring was one of the first things we thought of, but 2PB seemed more elegant.</p>",
        "id": 148712963,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543413754
    },
    {
        "content": "<p>(IIRC)</p>",
        "id": 148713074,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543413861
    },
    {
        "content": "<p>I'll have to catch up on the comments though</p>",
        "id": 148713079,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543413866
    },
    {
        "content": "<p>I'm still feeling sort of sick today :( not sure how much I'll be up for working yet</p>",
        "id": 148713090,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543413877
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> out of curiosity, when you said: </p>\n<blockquote>\n<p>Notably, in <code>match x { ref mut z if ...</code>, <code>x</code> should be mutably borrowed for the guard, as well as for the match arm.</p>\n</blockquote>\n<p>what was the scenario that you are concerned about?</p>\n<p>Unless I'm mistaken, the semantics for references to pattern variables in guards should prevent any mutable accesses from occurring... and therefore the mutable borrow need not be activated during the guard's execution, no?</p>",
        "id": 148713216,
        "sender_full_name": "pnkfelix",
        "timestamp": 1543413981
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> I don't quite follow why using 2PB is wrong for match guards though, <em>particularly</em> if we manage to move to the model <span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span> is advocating. If I understand that means that a 2PB is equivalent to a <code>&amp;mut</code> which is reborrowed to an <code>&amp;</code>, right? (And the activation corresponds to the <code>&amp;</code> going out of scope)</p>\n<p>In that case, in the example:</p>\n<blockquote>\n<p><code>match x { ref mut z if ...</code></p>\n</blockquote>\n<p>I believe we would create a 2PB on <code>z</code>, so there <em>would</em> be an active mut borrow on <code>x</code>? (But one that is itself frozen)</p>\n<p>I'm also not sure why it matters if there is one =)</p>",
        "id": 148713231,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543414020
    },
    {
        "content": "<p>(jinx)</p>",
        "id": 148713246,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543414032
    },
    {
        "content": "<blockquote>\n<p>If I understand that means that a 2PB is equivalent to a &amp;mut which is reborrowed to an &amp;, right? (And the activation corresponds to the &amp; going out of scope)</p>\n</blockquote>\n<p>Yes. Crucially, rewriting uses is <em>not</em> necessary, any read-only use of a variable that is a parent of the <code>&amp;mut</code> can still be read from (this is unlike my original thoughts from months ago where I thought we'd also have to rewrite uses)</p>",
        "id": 148718697,
        "sender_full_name": "RalfJ",
        "timestamp": 1543418613
    },
    {
        "content": "<p>the problem with the current version is that it creates a new borrow but keeps the old ones alive \"in parallel\", so we have a tree more than a stack. a tree might be sound, might even be closer to what one needs to model LLVM's noalias, but it is much more complicated -- and everything except for this quirk in 2PB can be explained by just a stack.</p>",
        "id": 148718807,
        "sender_full_name": "RalfJ",
        "timestamp": 1543418699
    },
    {
        "content": "<blockquote>\n<p>don't quite follow why using 2PB is wrong for match guards though, particularly if we manage to move to the model @RalfJ is advocating.</p>\n</blockquote>\n<p>that doesn't seem possible though? the desugaring inherently relies on outstanding shared borrows remaining intact. the PR by <span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> introduces a new kind of borrow that will not conflict and makes sure those all disappear before we execute anything, but that's quite a hack. it means giving a semantics to the MIR that the analysis actually happens on <em>still</em> requires trees. it solves miri's problem, but it doesn't solve the problem of giving a proper spec to MIR -- to all variants of MIR, including the one NLL runs on.</p>",
        "id": 148719032,
        "sender_full_name": "RalfJ",
        "timestamp": 1543418893
    },
    {
        "content": "<blockquote>\n<p>the transmute based desugaring was one of the first things we thought of, but 2PB seemed more elegant.</p>\n</blockquote>\n<p>you clearly have different taste than I do.  :D or maybe you weren't aware that the transmute is actually generally sound, not just in some special cases?</p>",
        "id": 148719074,
        "sender_full_name": "RalfJ",
        "timestamp": 1543418932
    },
    {
        "content": "<p>I am aware of that</p>",
        "id": 148720056,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543419708
    },
    {
        "content": "<p>kk</p>",
        "id": 148721557,
        "sender_full_name": "RalfJ",
        "timestamp": 1543420351
    },
    {
        "content": "<blockquote>\n<p>it means giving a semantics to the MIR that the analysis actually happens on <em>still</em> requires trees. </p>\n</blockquote>\n<p>ok, so you're saying that if we:</p>\n<ul>\n<li>create shallow borrows and whatever we need to \"lock down\" the thing we are matching on</li>\n<li>create <code>&amp;&amp;T</code> for bindings in a guard and then transmute to <code>&amp;&amp;mut T</code> </li>\n<li>and then once we enter an arm create the proper <code>ref mut</code></li>\n</ul>\n<p>and hence just avoid 2PB in this desugaring at all, we just don't have any particular problems.</p>\n<p>I think I agree with that.</p>",
        "id": 148723247,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543421775
    },
    {
        "content": "<p>(Sound correct <span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span> ?)</p>",
        "id": 148723252,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543421782
    },
    {
        "content": "<blockquote>\n<p>Yes. Crucially, rewriting uses is <em>not</em> necessary, any read-only use of a variable that is a parent of the <code>&amp;mut</code> can still be read from (this is unlike my original thoughts from months ago where I thought we'd also have to rewrite uses)</p>\n</blockquote>\n<p>But I definitely need to work this through in my head to fully understand.</p>\n<p>Thinking about it a bit more, I think the way the code is treating a 2PB now is roughly like an \"upgradable read lock\". That is, the initial borrow is shared, and then it is \"activated\" into an <code>&amp;mut</code>. (But this activation is not presently explicit in the MIR, though we always know what it is.)</p>\n<p>This also feels coherent but it still feels prudent to be more conservative for now.</p>",
        "id": 148723916,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543422375
    },
    {
        "content": "<blockquote>\n<p>(Sound correct <span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span> ?)</p>\n</blockquote>\n<p>yes</p>",
        "id": 148724224,
        "sender_full_name": "RalfJ",
        "timestamp": 1543422617
    },
    {
        "content": "<blockquote>\n<p>Thinking about it a bit more, I think the way the code is treating a 2PB now is roughly like an \"upgradable read lock\". That is, the initial borrow is shared, and then it is \"activated\" into an &amp;mut. (But this activation is not presently explicit in the MIR, though we always know what it is.)</p>\n</blockquote>\n<p>Hm, I see. Yeah Stacked Borrows is not currently prepared for a borrow to change its \"type\" (unique/shared)</p>",
        "id": 148724304,
        "sender_full_name": "RalfJ",
        "timestamp": 1543422686
    },
    {
        "content": "<p>I think doing that would require tracking the relationship of shared references more precisely, which would probably also need a tree.</p>",
        "id": 148724389,
        "sender_full_name": "RalfJ",
        "timestamp": 1543422742
    },
    {
        "content": "<p>I'm not saying 2PB is <em>unsound</em> for match guards. I just don't think that it should be: allowing <code>match x { ref mut z if x == 1 =&gt; ...</code> is unexpected.</p>",
        "id": 148727528,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543425346
    },
    {
        "content": "<p><code>x == z</code> seems even more unexpected</p>",
        "id": 148729710,
        "sender_full_name": "RalfJ",
        "timestamp": 1543427325
    },
    {
        "content": "<p>that is \"using\" two mutable references to the same location</p>",
        "id": 148729723,
        "sender_full_name": "RalfJ",
        "timestamp": 1543427333
    },
    {
        "content": "<p>my sense is we won't be able to change this for the initial Rust 2018 release</p>",
        "id": 148732686,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543430182
    },
    {
        "content": "<p>but we might be able to make changes here for the follow-on release, presuming low impact (as seems likely)</p>",
        "id": 148732698,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543430198
    },
    {
        "content": "<p>the clock is just running down</p>",
        "id": 148732704,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543430203
    },
    {
        "content": "<p>That's probably the case.</p>",
        "id": 148733710,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543430975
    },
    {
        "content": "<p>if only I had been two weeks faster :(</p>",
        "id": 148740784,
        "sender_full_name": "RalfJ",
        "timestamp": 1543436943
    },
    {
        "content": "<p>something that occurs to me, <span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> <span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> <span class=\"user-mention\" data-user-id=\"120791\">@RalfJ</span>, is that if we don't backport -- and I'm still not that keen on doing so because of the risk factor --</p>",
        "id": 148747500,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442628
    },
    {
        "content": "<p>we still have NLL-sound things to land anyway</p>",
        "id": 148747502,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442632
    },
    {
        "content": "<p>we can make a warning period here if we have to</p>",
        "id": 148747505,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442637
    },
    {
        "content": "<p>there is already a kind of \"NLL transition\" taking place</p>",
        "id": 148747553,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442644
    },
    {
        "content": "<p>and it feels like we can fit this into that</p>",
        "id": 148747556,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442649
    },
    {
        "content": "<p>it's a bit different, of course, but so what</p>",
        "id": 148747561,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442654
    },
    {
        "content": "<blockquote>\n<p>we still have NLL-sound things to land anyway</p>\n</blockquote>\n<p>what does that means? soundness holes in NLL that must be fixed?</p>",
        "id": 148747578,
        "sender_full_name": "RalfJ",
        "timestamp": 1543442676
    },
    {
        "content": "<p>yes, there are some known soundness holes</p>",
        "id": 148747593,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442696
    },
    {
        "content": "<p>mostly around user-supplied type annotations though</p>",
        "id": 148747601,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442704
    },
    {
        "content": "<p>things judged to be pretty edge-casey</p>",
        "id": 148747612,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442714
    },
    {
        "content": "<p><a href=\"https://discordapp.com/channels/442252698964721669/443148319431065610/517459924247117824\" target=\"_blank\" title=\"https://discordapp.com/channels/442252698964721669/443148319431065610/517459924247117824\">link to conversation with <span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span> on discord</a></p>",
        "id": 148747621,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442727
    },
    {
        "content": "<p>Personally, I'm leaning against backporting</p>",
        "id": 148747698,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543442790
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116118\">@Matthew Jasper</span> looking at the code in question from the new error:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">val</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">llvm</span>::<span class=\"n\">get_param</span><span class=\"p\">(</span><span class=\"n\">bx</span><span class=\"p\">.</span><span class=\"n\">llfn</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">c_uint</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"o\">*</span><span class=\"n\">idx</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">val</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">PassMode</span>::<span class=\"n\">Ignore</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{},</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">PassMode</span>::<span class=\"n\">Pair</span><span class=\"p\">(..)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">OperandValue</span>::<span class=\"n\">Pair</span><span class=\"p\">(</span><span class=\"n\">next</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"p\">()).</span><span class=\"n\">store</span><span class=\"p\">(</span><span class=\"n\">bx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">PassMode</span>::<span class=\"n\">Indirect</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">OperandValue</span>::<span class=\"n\">Ref</span><span class=\"p\">(</span><span class=\"n\">next</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">next</span><span class=\"p\">()),</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">layout</span><span class=\"p\">.</span><span class=\"n\">align</span><span class=\"p\">.</span><span class=\"n\">abi</span><span class=\"p\">).</span><span class=\"n\">store</span><span class=\"p\">(</span><span class=\"n\">bx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">PassMode</span>::<span class=\"n\">Direct</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PassMode</span>::<span class=\"n\">Indirect</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">None</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">PassMode</span>::<span class=\"n\">Cast</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">store</span><span class=\"p\">(</span><span class=\"n\">bx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">dst</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"></span>\n</pre></div>",
        "id": 148748158,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443313
    },
    {
        "content": "<p>with the error:</p>\n<div class=\"codehilite\"><pre><span></span>error[E0502]: cannot borrow `*bx` as mutable because it is also borrowed as immutable_codegen_llvm\n   --&gt; src/librustc_codegen_llvm/abi.rs:279:28\n    |\n265 |         let mut next = || {\n    |                        -- immutable borrow occurs here\n266 |             let val = llvm::get_param(bx.llfn(), *idx as c_uint);\n    |                                       -- first borrow occurs due to use of `bx` in closure\n...\n279 |                 self.store(bx, next(), dst);\n    |                            ^^  ---- immutable borrow later used here\n    |                            |\n    |                            mutable borrow occurs here\n\nerror: aborting due to previous error\n</pre></div>",
        "id": 148748167,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443327
    },
    {
        "content": "<p>is the <code>bx</code> here a 2pb?</p>",
        "id": 148748193,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443361
    },
    {
        "content": "<p>Yes</p>",
        "id": 148748233,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543443365
    },
    {
        "content": "<p>sorry, which one, the <code>bx.llfn()</code>?</p>",
        "id": 148748237,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443371
    },
    {
        "content": "<p>the <code>self.store(bx, ...)</code>?</p>",
        "id": 148748241,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443377
    },
    {
        "content": "<p>if the latter, I .. feel a bit surprised, because I thought we didn't do it in that scenario.</p>",
        "id": 148748246,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443392
    },
    {
        "content": "<p>the former seems wrong because it is <code>fn llfn(&amp;self)</code></p>",
        "id": 148748260,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443407
    },
    {
        "content": "<p>I guess we extended to fn arguments?</p>",
        "id": 148748293,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443438
    },
    {
        "content": "<p>I see, we do. Well... I was wrong about <em>that</em></p>",
        "id": 148748364,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443499
    },
    {
        "content": "<p>interesting</p>",
        "id": 148748368,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443505
    },
    {
        "content": "<p>(I thought we did only method receivers and binary operators)</p>",
        "id": 148748385,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443523
    },
    {
        "content": "<p>( ok, we definitely have to prioritize also writing up a complete NLL document :) which has been on my mind for some time anyway... but the match desugaring discussion and now this brought it to the fore again )</p>",
        "id": 148748426,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543443592
    },
    {
        "content": "<p>OK, I'll try to write up the current state and our long-term options tomorrow, since we should have time to implement them.</p>",
        "id": 148748893,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543444082
    },
    {
        "content": "<p>Well, consensus from the release discussion was that a backport is off the table, which gives us a bit more time to settle on the <em>right</em> fix. I feel good about that.</p>",
        "id": 148748978,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543444182
    },
    {
        "content": "<p>sure doing a backport to the Rust 2018 release doesn't look like the best idea</p>",
        "id": 148749059,
        "sender_full_name": "Ariel Ben-Yehuda",
        "timestamp": 1543444237
    },
    {
        "content": "<p>we'll probably have to release a patch edition anyway</p>",
        "id": 148749068,
        "sender_full_name": "Ariel Ben-Yehuda",
        "timestamp": 1543444254
    },
    {
        "content": "<p>for NLL</p>",
        "id": 148749071,
        "sender_full_name": "Ariel Ben-Yehuda",
        "timestamp": 1543444260
    },
    {
        "content": "<p>I wouldn't be surprised, for one reason or another, anyway</p>",
        "id": 148749259,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1543444467
    },
    {
        "content": "<p>Some notes on two-phase borrows and some potential changes: <a href=\"https://gist.github.com/matthewjasper/1e48c300e96aaf69e9f56a2d9f969c87\" target=\"_blank\" title=\"https://gist.github.com/matthewjasper/1e48c300e96aaf69e9f56a2d9f969c87\">https://gist.github.com/matthewjasper/1e48c300e96aaf69e9f56a2d9f969c87</a></p>",
        "id": 150685521,
        "sender_full_name": "Matthew Jasper",
        "timestamp": 1543674683
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> on the topic of implementing 2PB via rewriting, I see that <a href=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=3089aa28872013534beafb0682edd57f\" target=\"_blank\" title=\"https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=3089aa28872013534beafb0682edd57f\">this example compiles</a>:</p>\n<div class=\"codehilite\"><pre><span></span><span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"o\">!</span><span class=\"p\">[];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">vec</span><span class=\"o\">!</span><span class=\"p\">[];</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">push</span><span class=\"p\">((</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"mi\">22</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">},</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">x</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">(),</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">));</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</pre></div>\n\n\n<p>though I suspect that <em>this one</em> doesn't occur a lot in the wild =)</p>",
        "id": 152172869,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1545215317
    },
    {
        "content": "<p>(afk now)</p>",
        "id": 152172887,
        "sender_full_name": "nikomatsakis",
        "timestamp": 1545215336
    },
    {
        "content": "<p>hmm. look at this: <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2015&amp;gist=b997316b973891850c7d457ac79b3ac5\" target=\"_blank\" title=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2015&amp;gist=b997316b973891850c7d457ac79b3ac5\">https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2015&amp;gist=b997316b973891850c7d457ac79b3ac5</a></p>",
        "id": 152174894,
        "sender_full_name": "pnkfelix",
        "timestamp": 1545217774
    },
    {
        "content": "<p>oh wait, duh</p>",
        "id": 152174954,
        "sender_full_name": "pnkfelix",
        "timestamp": 1545217826
    },
    {
        "content": "<p>that isn't surprising at all</p>",
        "id": 152174957,
        "sender_full_name": "pnkfelix",
        "timestamp": 1545217830
    },
    {
        "content": "<p>(had to lift the value being borrowed into a separate nameable thing to observe the effect, <a href=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2015&amp;gist=b2c11f234815fe0b3d44d233aaff2f28\" target=\"_blank\" title=\"https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2015&amp;gist=b2c11f234815fe0b3d44d233aaff2f28\">this way</a>)</p>",
        "id": 152175040,
        "sender_full_name": "pnkfelix",
        "timestamp": 1545217933
    }
]