[
    {
        "content": "<p>The first thing that <code>create_generator_drop_shim</code> does is <a href=\"https://github.com/rust-lang/rust/blob/e2116acae59654bfab2a9729a024f3e2fd6d4b02/compiler/rustc_mir_transform/src/generator.rs#L921\">clone the MIR of the original generator</a>, including its CFG. I found that strange, since presumably they do very different things (although I suppose both start with a switch on the generator state). Does anyone have some intuition about why things are done this way?</p>",
        "id": 263793336,
        "sender_full_name": "Dylan MacKenzie (ecstatic-morse)",
        "timestamp": 1638744157
    },
    {
        "content": "<p>I don't have the best understanding of the generator machinery, and I'm looking to improve it.</p>",
        "id": 263793429,
        "sender_full_name": "Dylan MacKenzie (ecstatic-morse)",
        "timestamp": 1638744296
    },
    {
        "content": "<p>The drop shim is added as field to the original generator mir: <a href=\"https://github.com/rust-lang/rust/blob/e2116acae59654bfab2a9729a024f3e2fd6d4b02/compiler/rustc_mir_transform/src/generator.rs#L1367\">https://github.com/rust-lang/rust/blob/e2116acae59654bfab2a9729a024f3e2fd6d4b02/compiler/rustc_mir_transform/src/generator.rs#L1367</a></p>",
        "id": 263817545,
        "sender_full_name": "bjorn3",
        "timestamp": 1638777547
    },
    {
        "content": "<p><code>create_generator_drop_shim</code> should probably take <code>&amp;Body</code> instead of <code>&amp;mut Body</code>.</p>",
        "id": 263817564,
        "sender_full_name": "bjorn3",
        "timestamp": 1638777586
    },
    {
        "content": "<p>That's true, yes. But I still don't see why drop shim creation begins by cloning the body of the original generator instead of creating a fresh one and copying the source info. We don't need any of its locals (except the first), most of the CFG is irrelevant (except the first switch), and it means the drop shim is in the wrong MIR phase (see <a href=\"https://github.com/rust-lang/rust/issues/91576\">#91576</a>).</p>",
        "id": 263881269,
        "sender_full_name": "Dylan MacKenzie (ecstatic-morse)",
        "timestamp": 1638810113
    },
    {
        "content": "<blockquote>\n<p>We don't need any of its locals (except the first)</p>\n</blockquote>\n<p>Some of the locals are for the drop code I think. In addition the blocks with <code>GeneratorDrop</code> terminators need to have their statements copied.</p>",
        "id": 263881717,
        "sender_full_name": "bjorn3",
        "timestamp": 1638810274
    },
    {
        "content": "<p>Ah, could you say more about the <code>GeneratorDrop</code>? Or if it's in the dev guide I can just go read.</p>",
        "id": 263882410,
        "sender_full_name": "Dylan MacKenzie (ecstatic-morse)",
        "timestamp": 1638810557
    },
    {
        "content": "<p>Honestly I don't have much of a clue. I inferred this from <code>create_generator_drop_shim</code> and the place in <code>rustc_mir_built</code> where <code>GeneratorDrop</code> is created.</p>",
        "id": 263882681,
        "sender_full_name": "bjorn3",
        "timestamp": 1638810656
    }
]