[
    {
        "content": "<p>Is it important that code like this, found in <code>src/test/mir-opt/lower_intrinsics.rs</code>, not ICE?</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">wrapping</span><span class=\"o\">&lt;</span><span class=\"n\">T</span>: <span class=\"nb\">Copy</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">a</span>: <span class=\"nc\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span>: <span class=\"nc\">T</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">intrinsics</span>::<span class=\"n\">wrapping_add</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">intrinsics</span>::<span class=\"n\">wrapping_sub</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_z</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">intrinsics</span>::<span class=\"n\">wrapping_mul</span><span class=\"p\">(</span><span class=\"n\">a</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">b</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Specifically, I'm improving the MIR validator at the moment and one of the things I would like to check is that <code>Rvalue::BinOp</code>s are used with appropriate types. I could of course add type parameters to the accepted types, but if this isn't supposed to work anyway it might be better to just switch the test to use <code>i32</code> or something</p>",
        "id": 276564088,
        "sender_full_name": "Jak{e,ob} Degen",
        "timestamp": 1648174496
    },
    {
        "content": "<p>Trying to codegen this with a wrong type ICEs already</p>",
        "id": 276564379,
        "sender_full_name": "Jak{e,ob} Degen",
        "timestamp": 1648174850
    },
    {
        "content": "<p>I think it's important that that function definition not ICE, yes -- it's very handy to add new intrinsics to bootstrap by calling other intrinsics in that way.  See, for example, <a href=\"https://github.com/rust-lang/rust/pull/52205/files#diff-e12e6106c42c02071fd498e2b853ab36451be3254de394c9124bb31ce16561caR1386\">https://github.com/rust-lang/rust/pull/52205/files#diff-e12e6106c42c02071fd498e2b853ab36451be3254de394c9124bb31ce16561caR1386</a></p>\n<p>If they ICE when <em>called</em> with wrong types that's definitely fine.</p>",
        "id": 276576156,
        "sender_full_name": "scottmcm",
        "timestamp": 1648183426
    },
    {
        "content": "<p>But it would also be fine for that to only work in some restricted functions.  I don't think there's any ordinary code that needs to be able to do it.  Just special <code>core</code> stuff.</p>",
        "id": 276576344,
        "sender_full_name": "scottmcm",
        "timestamp": 1648183688
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125270\">scottmcm</span> <a href=\"#narrow/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically/near/276576344\">said</a>:</p>\n<blockquote>\n<p>But it would also be fine for that to only work in some restricted functions.  I don't think there's any ordinary code that needs to be able to do it.  Just special <code>core</code> stuff.</p>\n</blockquote>\n<p>I don't think this part makes a difference. What I'd like is for MIR passes to be able to assume they won't see things like this. Hm, let me think about this some more</p>",
        "id": 276576738,
        "sender_full_name": "Jak{e,ob} Degen",
        "timestamp": 1648184303
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125270\">scottmcm</span> <a href=\"#narrow/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically/near/276576156\">said</a>:</p>\n<blockquote>\n<p>I think it's important that that function definition not ICE, yes -- it's very handy to add new intrinsics to bootstrap by calling other intrinsics in that way.  See, for example, <a href=\"https://github.com/rust-lang/rust/pull/52205/files#diff-e12e6106c42c02071fd498e2b853ab36451be3254de394c9124bb31ce16561caR1386\">https://github.com/rust-lang/rust/pull/52205/files#diff-e12e6106c42c02071fd498e2b853ab36451be3254de394c9124bb31ce16561caR1386</a></p>\n<p>If they ICE when <em>called</em> with wrong types that's definitely fine.</p>\n</blockquote>\n<p>Can't this kind of thing be done in the \"surface level\" functions? ie in this case the unstable functions on the numeric types? That requires a little more verbosity, but I don't think it's that bad</p>",
        "id": 276577019,
        "sender_full_name": "Jak{e,ob} Degen",
        "timestamp": 1648184652
    },
    {
        "content": "<p>I really want there to be one function for the new thing.</p>\n<p>That'd also fit better with <a href=\"https://github.com/rust-lang/rust/issues/93145#issuecomment-1018354451\">https://github.com/rust-lang/rust/issues/93145#issuecomment-1018354451</a> (cc <span class=\"user-mention\" data-user-id=\"124288\">@oli</span>) because if this kind of thing wasn't an intrinsic (in the current meaning of the word) then it would be extra annoying for backends to have to match \"codegen items\" for all 16 different integer types, rather than just the one <code>add_unchecked</code> item that has a body that defaults to the right thing.</p>\n<p>Maybe you could do this from the other direction, and stop lowering <em>generic</em> uses of intrinsics to MIR ops in <a href=\"https://github.com/rust-lang/rust/blob/661e8beec1fa5f3c58bf6e4362ae3c3fe0b4b1bd/compiler/rustc_mir_transform/src/lower_intrinsics.rs#L64\">https://github.com/rust-lang/rust/blob/661e8beec1fa5f3c58bf6e4362ae3c3fe0b4b1bd/compiler/rustc_mir_transform/src/lower_intrinsics.rs#L64</a> ?</p>",
        "id": 276578161,
        "sender_full_name": "scottmcm",
        "timestamp": 1648186189
    },
    {
        "content": "<p>Obligatory caveat: I'm not actually on the compiler team, nor a \"compiler contributor\", so my opinion is not necessarily important.</p>",
        "id": 276578256,
        "sender_full_name": "scottmcm",
        "timestamp": 1648186285
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"125270\">scottmcm</span> <a href=\"#narrow/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically/near/276578161\">said</a>:</p>\n<blockquote>\n<p>I really want there to be one function for the new thing.</p>\n<p>That'd also fit better with <a href=\"https://github.com/rust-lang/rust/issues/93145#issuecomment-1018354451\">https://github.com/rust-lang/rust/issues/93145#issuecomment-1018354451</a> (cc <span class=\"user-mention silent\" data-user-id=\"124288\">oli</span>) because if this kind of thing wasn't an intrinsic (in the current meaning of the word) then it would be extra annoying for backends to have to match \"codegen items\" for all 16 different integer types, rather than just the one <code>add_unchecked</code> item that has a body that defaults to the right thing.</p>\n</blockquote>\n<p>I don't think this is an issue. I'm proposing to have</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[cfg(stage0)]</span><span class=\"w\"></span>\n<span class=\"n\">overflow</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"cp\">#[cfg(not(stage0))]</span><span class=\"w\"></span>\n<span class=\"n\">intrinsic</span><span class=\"p\">();</span><span class=\"w\"></span>\n</code></pre></div>\n<p>in the integer functions - codegen will see an intrinsic in either case. Actually, I think Oli's proposal would resolve this issue from my pov, because if I am understanding correctly we would no longer have MIR bodies that have generic usages of MIR ops that are supposed to be non-generic. (<strong>Edit:</strong> Wait, maybe I got that backwards and it actually wouldn't)</p>\n<blockquote>\n<p>Maybe you could do this from the other direction, and stop lowering <em>generic</em> uses of intrinsics to MIR ops in <a href=\"https://github.com/rust-lang/rust/blob/661e8beec1fa5f3c58bf6e4362ae3c3fe0b4b1bd/compiler/rustc_mir_transform/src/lower_intrinsics.rs#L64\">https://github.com/rust-lang/rust/blob/661e8beec1fa5f3c58bf6e4362ae3c3fe0b4b1bd/compiler/rustc_mir_transform/src/lower_intrinsics.rs#L64</a> ?</p>\n</blockquote>\n<p>I don't think this would be correct - intrinsic lowering is currently guaranteed as far as I know, which means that probably codegen backends are not expecting to see the intrinsic invocation for intrinsics that have an associated MIR opt.</p>\n<p>That being said, I realize this is actually a non-issue for any intrinsics that do not get lowered to MIR ops, so something like the non-overflowing stuff wouldn't be affected. This probably makes the change much more feasible.</p>\n<p>In any case, I'll add the generic param for now, since it seems like there might be legitimate use cases for this.</p>",
        "id": 276578870,
        "sender_full_name": "Jak{e,ob} Degen",
        "timestamp": 1648187076
    },
    {
        "content": "<p>Honestly, now that I think about it, it probably makes the most sense to explicitly differentiate between those intrinsics that get lowered to MIR ops and those that don't. For the second kind it's not a problem to allow these kinds of things in MIR, and I think those are also the only ones it's interesting for</p>",
        "id": 276579069,
        "sender_full_name": "Jak{e,ob} Degen",
        "timestamp": 1648187285
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"310518\">Jak{e,ob} Degen</span> <a href=\"#narrow/stream/131828-t-compiler/topic/Using.20Intrinsics.20Generically/near/276578870\">said</a>:</p>\n<blockquote>\n<p>That being said, I realize this is actually a non-issue for any intrinsics that do not get lowered to MIR ops, so something like the non-overflowing stuff wouldn't be affected. This probably makes the change much more feasible.</p>\n</blockquote>\n<p>Oh, that's a very good point.  It basically only affects <code>wrapping_*</code>, since everything else that lowers to MIR is generic anyway.</p>\n<p>Might be fine to just change that test to a different intrinsic and be more stringent in the validator, then.</p>",
        "id": 276579432,
        "sender_full_name": "scottmcm",
        "timestamp": 1648187752
    },
    {
        "content": "<p>Yeah, I just checked - <code>wrapping_*</code> is literally the only thing this affects, so this is probably fine then. Cool, that makes me happy</p>",
        "id": 276579744,
        "sender_full_name": "Jak{e,ob} Degen",
        "timestamp": 1648188057
    },
    {
        "content": "<p>Yea, the amount of generics will get reduces a lot on integer intrinsics, but others like copy_nonoverlapping and SIMD intrinsics are inherently generic</p>",
        "id": 276592122,
        "sender_full_name": "oli",
        "timestamp": 1648199424
    },
    {
        "content": "<p>Maybe I make an MVP of the new intrinsic scheme for just one intrinsic so that we can create a tracking issue for the rest and get some contributors to munch away on them</p>",
        "id": 276592237,
        "sender_full_name": "oli",
        "timestamp": 1648199519
    }
]