[
    {
        "content": "<p>This came up when I was reviewing <a href=\"https://github.com/rust-lang/rust/pull/94079\">https://github.com/rust-lang/rust/pull/94079</a>. In that PR <span class=\"user-mention\" data-user-id=\"123856\">@Vadim Petrochenkov</span> pointed out that re-export stability isn't checked by the compiler, which surprised me, since I hadn't run into any warnings when I was setting up my error in core PR which does something very similar: <a href=\"https://github.com/rust-lang/rust/pull/90328\">https://github.com/rust-lang/rust/pull/90328</a></p>\n<p>I had hoped that it would work in the error-in-core PR since in that case we were introducing a new module, so in theory the unstable attribute was being applied to <code>mod core::error;</code> and that would make any usage of <code>core::error</code> produce an error. In Vadim's PR's case there was already a <code>core::ffi</code> module so that wasn't an option.</p>\n<p>After some digging it turns out it sort of works but mostly doesn't.</p>\n<ul>\n<li><code>use core::error;</code> does correctly produce a warning for use of an unstable feature <a href=\"https://github.com/rust-lang/rust/pull/90328/files#diff-1e1de53b51b61f48e07e7424fa8ee998bb9690853304d02a63e2316e4f0fa38d\">https://github.com/rust-lang/rust/pull/90328/files#diff-1e1de53b51b61f48e07e7424fa8ee998bb9690853304d02a63e2316e4f0fa38d</a></li>\n<li>But <code>impl core::error::Error for MyType {}</code> works juuuuust fine.... <a href=\"https://github.com/rust-lang/rust/pull/90328/files#diff-c3b23dcebfc9d27e8813a31ccb2ecb16f6be21af3952d7e5bb6a27fc52a2afad\">https://github.com/rust-lang/rust/pull/90328/files#diff-c3b23dcebfc9d27e8813a31ccb2ecb16f6be21af3952d7e5bb6a27fc52a2afad</a></li>\n</ul>\n<p>I talked to Vadim about it and he's gonna look into using a type alias for the CStr issue to allow it to be unstable in core but have a stable type alias, but for the error in core issue I need to figure something else out. I'm noodling around in the <code>rustc_middle/.../stability.rs</code> and wondering how bad of an idea it would be to just also check the parent module's stability, but generally I'm curious if y'all have ideas for how we could better support unstable moves of types and traits from std into core.</p>",
        "id": 277958533,
        "sender_full_name": "Jane Lusby [she/her]",
        "timestamp": 1649201934
    },
    {
        "content": "<p>Is it inherently hard to fix the compiler to check this consistently? Seems better than hacking around it somehow ...</p>",
        "id": 277960451,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1649203620
    },
    {
        "content": "<p>no idea! that's is very much my question here</p>",
        "id": 277963753,
        "sender_full_name": "Jane Lusby [she/her]",
        "timestamp": 1649206859
    },
    {
        "content": "<p>for the CStr issue vadim explained that it would be a pretty big body of work to fix</p>",
        "id": 277963783,
        "sender_full_name": "Jane Lusby [she/her]",
        "timestamp": 1649206890
    },
    {
        "content": "<p>because we'd have to move the stability attribute checking to an earlier stage of the compiler</p>",
        "id": 277963794,
        "sender_full_name": "Jane Lusby [she/her]",
        "timestamp": 1649206904
    },
    {
        "content": "<p>It would be useful to figure out exactly what isn't being checked. Is it any item in <code>std::error</code>, i.e. an issue with propagating the attribute to module children? Does it only happen when implementing an unstable trait? Something else?</p>",
        "id": 277965465,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1649208798
    },
    {
        "content": "<p>I had to use type aliases for the <code>std::os::raw::c_*</code> types when adding them to <code>core::ffi::c_*</code>. I'd love to have been able to <code>#[stable] pub use</code> instead.</p>",
        "id": 277976582,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1649222153
    },
    {
        "content": "<p>I think in general we could use type aliases for now, instead of re-exports of types.</p>",
        "id": 277976636,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1649222194
    },
    {
        "content": "<p>We don't have stable trait aliases, but I wonder if we could use the unstable trait_alias feature?</p>",
        "id": 277976651,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1649222233
    },
    {
        "content": "<p>It's my recollection that you can't currently <em>implement</em> traits through trait aliases.</p>\n<p>(I don't know if that's an intentional restriction or not.)</p>",
        "id": 277993042,
        "sender_full_name": "scottmcm",
        "timestamp": 1649234918
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"232545\">@Joshua Nelson</span> from my quick poke around it looks like it's the former, it isn't propagating/checking the stableness of the parent module</p>",
        "id": 278043641,
        "sender_full_name": "Jane Lusby [she/her]",
        "timestamp": 1649259822
    },
    {
        "content": "<p>Gotcha. That shouldn't be terribly hard to fix then, I don't think - it just needs to call <code>tcx.parent(def_id)</code> in a loop until it gets to the crate root, to see if any parent is unstable</p>",
        "id": 278045082,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1649260421
    },
    {
        "content": "<p>(this is basically how <code>doc(hidden)</code> checking works in rustdoc)</p>",
        "id": 278045182,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1649260459
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/131828-t-compiler/topic/moving.20items.20to.20core.20unstably/near/278045082\">said</a>:</p>\n<blockquote>\n<p>Gotcha. That shouldn't be terribly hard to fix then, I don't think - it just needs to call <code>tcx.parent(def_id)</code> in a loop until it gets to the crate root, to see if any parent is unstable</p>\n</blockquote>\n<p>okay cool! this sounds like what I was thinking as a possible fix for the specific issue for error, and it looks like Vadim was able to use a type alias for CStr/CString so we might be fine for now with this approach. I'll go ahead and open a PR to add the parent stability check, tyty ^_^</p>",
        "id": 278052570,
        "sender_full_name": "Jane Lusby [she/her]",
        "timestamp": 1649263539
    },
    {
        "content": "<p>got an initial version of the PR <a href=\"https://github.com/rust-lang/rust/pull/95956\">https://github.com/rust-lang/rust/pull/95956</a></p>\n<p>but apparently i need to figure out a way to fix the panic macro because apparently it calls some publicly re-exported functions from core::panicking through the unstable <code>rt</code> module. Not really sure how it worked before because they appear to be unstable in rustdoc: <a href=\"https://doc.rust-lang.org/stable/core/panicking/fn.panic_fmt.html\">https://doc.rust-lang.org/stable/core/panicking/fn.panic_fmt.html</a>, but I'll have to figure that out next time I have a chance to work on this</p>",
        "id": 278637787,
        "sender_full_name": "Jane Lusby [she/her]",
        "timestamp": 1649727080
    }
]