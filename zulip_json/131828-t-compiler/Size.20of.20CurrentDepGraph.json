[
    {
        "content": "<p>Does 264MiB sound a lot for an allocation for the rehash of one shard of CurrentDepGraph's new_node_to_index?</p>",
        "id": 262897580,
        "sender_full_name": "Mike Hommey",
        "timestamp": 1638054196
    },
    {
        "content": "<p>Which crate are you compiling?</p>",
        "id": 262897746,
        "sender_full_name": "cjgillot",
        "timestamp": 1638054431
    },
    {
        "content": "<p>style (from Firefox)</p>",
        "id": 262898609,
        "sender_full_name": "Mike Hommey",
        "timestamp": 1638055840
    },
    {
        "content": "<p>(and I don't know if that's the max size, because it's on a 32-bits platform, and the process is aborted for OOM on that allocation)</p>",
        "id": 262898624,
        "sender_full_name": "Mike Hommey",
        "timestamp": 1638055893
    },
    {
        "content": "<p>(and the point the process OOMs, it has (only) 1.3G RSS)</p>",
        "id": 262898630,
        "sender_full_name": "Mike Hommey",
        "timestamp": 1638055917
    },
    {
        "content": "<p>The DepGraph can get massive for large crates. According to perf tracking, the typical on-disk size of the DepGraph for a check build of style is ~126 MB. This on-disk size is ~30% smaller than the in-memory version. Since <code>new_node_to_index</code> only contains part of the information in the DepGraph, I'd say that 264 MB seems like a bit much, but not excessively so. The overallocation for a rehash could explain the size.</p>",
        "id": 262941798,
        "sender_full_name": "cjgillot",
        "timestamp": 1638124356
    },
    {
        "content": "<p>2.5 million nodes x 22 bytes per node (16 for the fingerprint, 2 for the DepKind, 4 for the DepNodeIndex), seems about right.</p>",
        "id": 262941971,
        "sender_full_name": "cjgillot",
        "timestamp": 1638124575
    },
    {
        "content": "<p>Is it actually 22 bytes, or is there padding in there?</p>",
        "id": 262943894,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1638127254
    },
    {
        "content": "<p>DepNode uses a PackedFingerprint to avoid padding. I don't know if there is padding between the DepNodes and between the DepNode and the DepNodeIndex in the hash map layout.</p>",
        "id": 262954666,
        "sender_full_name": "cjgillot",
        "timestamp": 1638142477
    }
]