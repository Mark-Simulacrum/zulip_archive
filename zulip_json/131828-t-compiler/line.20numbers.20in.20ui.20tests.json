[
    {
        "content": "<p>Hey all!</p>\n<p>At work I have the need to annotate a lot of UI tests with additional comments on top of each file, but I'm having problems with the line numbers in error messages. Each comment I add shifts all the line numbers and requires running <code>--bless</code>, and causes merge conflicts when the test is updated upstream. Those annotations are specific to our CI setup so there isn't much value in upstreaming them (which would solve the merge conflicts problem).</p>\n<p>I've also been encountering this in PRs to rust-lang/rust (like the recent bootstrap update I did), where changing something on top of the file requires changing the line numbers:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"w\"> </span> error: the target features paca, pacg must all be either enabled or disabled together<span class=\"w\"></span>\n<span class=\"gd\">-   --&gt; $DIR/tied-features.rs:13:5</span><span class=\"w\"></span>\n<span class=\"gi\">+   --&gt; $DIR/tied-features.rs:12:5</span><span class=\"w\"></span>\n<span class=\"w\"> </span>    |<span class=\"w\"></span>\n<span class=\"w\"> </span> LL |     #[target_feature(enable = \"pacg\")]<span class=\"w\"></span>\n<span class=\"w\"> </span>    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^<span class=\"w\"></span>\n<span class=\"w\"> </span>    |<span class=\"w\"></span>\n<span class=\"w\"> </span>    = help: add the missing features in a `target_feature` attribute<span class=\"w\"></span>\n</code></pre></div>\n<p>I did some digging, and in the <a href=\"https://github.com/rust-lang/rust/pull/48449\">PR changing most line numbers to <code>LL</code></a> it was mentioned that the line numbers in <code>--&gt;</code> were <a href=\"https://github.com/rust-lang/rust/issues/46643#issuecomment-350831862\">explicitly not replaced to detect error reordering</a>. Later, the remaining line and column numbers were changed <a href=\"https://github.com/rust-lang/rust/pull/53558\">only for paths outside the test itself</a>.</p>\n<p>Are the concerns about error reordering still present, or would the compiler team be interested in a PR removing all remaining line numbers and replacing them with <code>LL:COL</code>?</p>",
        "id": 278522641,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649666151
    },
    {
        "content": "<p>Replacing the line numbers with LL seems fine, though I'd kinda prefer to keep the column numbers, since that's something we should detect regressions in the values of.</p>",
        "id": 278527018,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1649668614
    },
    {
        "content": "<p>For the line numbers, I wonder if there's something more we could do to tie the line numbers to the actual code, such that we're robust against adding lines...</p>",
        "id": 278527085,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1649668675
    },
    {
        "content": "<blockquote>\n<p>Are the concerns about error reordering still present</p>\n</blockquote>\n<p>Yes, the concerns still very much exist.<br>\nEven with the anonymization as it's done right now it's hard to read the tests sometimes.<br>\nIf we are talking about test usefulness for humans, then no lines would be anonymized ideally, the fact that we have to anonymize a part of them is a tradeoff.</p>",
        "id": 278534555,
        "sender_full_name": "Vadim Petrochenkov",
        "timestamp": 1649673225
    },
    {
        "content": "<blockquote>\n<p>annotate a lot of UI tests with additional comments on top of each file</p>\n</blockquote>\n<p>What kind of annotations we are talking about?<br>\nIs it additional compiletest annotations, or something custom?<br>\nMaybe they can be added at the end of test files? I think we can even modify compiletest to do that if necessary.</p>",
        "id": 278535146,
        "sender_full_name": "Vadim Petrochenkov",
        "timestamp": 1649673634
    },
    {
        "content": "<p>Basically, we need to link some tests with their corresponding (internal) issue numbers or requirements, like <code>// annotate: #1234</code></p>\n<p>Our plan was to have compiletest parse those annotations, validate them and emit a list of all annotations with the related tests (enabling the rest of our tooling to process that data). If adding any annotation requires a <code>--bless</code> because the line numbers change, pulling new changes from rust-lang/rust into our fork would become too much painful.</p>\n<p>I'm open to have compiletest parse annotations up to the end of the file, <a href=\"https://github.com/rust-lang/rust/blob/48a9e104dfafdec3a5d00d365229d6369939f433/src/tools/compiletest/src/header.rs#L514-L531\">but that's currently not done</a>. If you want I can send a PR lifting the restriction.</p>",
        "id": 278536832,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649674866
    },
    {
        "content": "<p>This looks like a better alternative to me than removing line information.</p>",
        "id": 278542556,
        "sender_full_name": "Vadim Petrochenkov",
        "timestamp": 1649678395
    },
    {
        "content": "<p>ok! I originally proposed removing the line information as I also kinda found that annoying when making PRs, but I understand others might find it useful</p>",
        "id": 278545039,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649679809
    },
    {
        "content": "<p>Hm</p>",
        "id": 278549726,
        "sender_full_name": "simulacrum",
        "timestamp": 1649682115
    },
    {
        "content": "<p>I think end of file parsing seems OK, but it's probably a little awkward to put the annotations down at the end of the file. I wonder if we should consider e.g. stripping annotation lines prior to calling rustc, so that the number of annotations doesn't affect final output, though that would make finding the original bit of the file that produced output rather annoying.</p>",
        "id": 278549950,
        "sender_full_name": "simulacrum",
        "timestamp": 1649682219
    },
    {
        "content": "<p>Unless you can instead maintain an out-of-band list that just lists all UI tests and maps them to a set of annotations, which might also work ok, at least for this kind of thing</p>",
        "id": 278550074,
        "sender_full_name": "simulacrum",
        "timestamp": 1649682290
    },
    {
        "content": "<blockquote>\n<p>I think end of file parsing seems OK, but it's probably a little awkward to put the annotations down at the end of the file</p>\n</blockquote>\n<p>having tried that it's indeed a bit awkward, but it's way better than maintaining out-of-bad lists</p>\n<blockquote>\n<p>I wonder if we should consider e.g. stripping annotation lines prior to calling rustc, so that the number of annotations doesn't affect final output, though that would make finding the original bit of the file that produced output rather annoying.</p>\n</blockquote>\n<p>not sure what the opinion of the compiler team is, but IMO incorrect line numbers you have to offset in your mind are worse than no line numbers</p>",
        "id": 278561418,
        "sender_full_name": "Pietro Albini",
        "timestamp": 1649687190
    },
    {
        "content": "<p>Yeah, that seems right to me.</p>",
        "id": 278579865,
        "sender_full_name": "simulacrum",
        "timestamp": 1649694571
    }
]