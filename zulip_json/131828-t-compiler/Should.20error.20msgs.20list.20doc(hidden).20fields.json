[
    {
        "content": "<p>Just wondering if anyone has opinions about <a href=\"https://github.com/rust-lang/rust/issues/89042\">https://github.com/rust-lang/rust/issues/89042</a> and <a href=\"https://github.com/rust-lang/rust/pull/90358#discussion_r747763197\">https://github.com/rust-lang/rust/pull/90358#discussion_r747763197</a></p>\n<p>TL;DR:<br>\nNow that <code>non_exhaustive</code> struct and enum patterns can show all fields/variants we ran into problems with stdlib internal <code>stable/unstable</code> fields and variants, so they had to be filtered out of the pattern set when preparing for the error message. The decision that needs to be made is about <code>doc(hidden)</code> fields and variants, should they be filtered out and replaced with a wildcard suggestion or left in the error msg output?</p>\n<p>Sorry for cross posting from <a class=\"stream\" data-stream-id=\"243200\" href=\"/#narrow/stream/243200-t-lang.2Fmajor-changes\">#t-lang/major changes</a> I was told this may be a way to get some feedback.</p>",
        "id": 263146817,
        "sender_full_name": "DevinR528",
        "timestamp": 1638280344
    },
    {
        "content": "<p>(You might consider mentioning it in <a class=\"stream\" data-stream-id=\"266220\" href=\"/#narrow/stream/266220-rustdoc\">#rustdoc</a> as well.)</p>",
        "id": 263684553,
        "sender_full_name": "Noah Lev",
        "timestamp": 1638594252
    },
    {
        "content": "<p>I'm not sure how rustdoc is relevant here?</p>",
        "id": 263684857,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1638594767
    },
    {
        "content": "<p>If anything #t-lang seems like a better place</p>",
        "id": 263684872,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1638594791
    },
    {
        "content": "<p>Diagnostics would be compiler, would they not?</p>",
        "id": 263684881,
        "sender_full_name": "Connor Horman",
        "timestamp": 1638594821
    },
    {
        "content": "<p>Hmm, <code>#[doc(hidden)]</code> often de-facto means <code>unstable</code> in the ecosystem, since a <code>#[doc(hidden)] __MaybeMoreLater</code> variant was a pretty common pattern before <code>#[non_exhaustive]</code> existed.</p>\n<p>This feels like a place where a survey could help.  What popular enums in the wild could trigger this?</p>\n<p>(The unstable thing is probably easier, since that only happens in the standard library, so we know what it looks like.  And there's precedent like avoiding unstable methods in method resolution.)</p>",
        "id": 263690956,
        "sender_full_name": "scottmcm",
        "timestamp": 1638603900
    },
    {
        "content": "<p>I think it's somewhat relevant to rustdoc since <code>doc(hidden)</code> was meant, mostly, to convey info exclusively to rustdoc, although this has expanded overtime to things like the hacky <code>non_exhaustive</code> stuff. </p>\n<p>I feel like it comes down to this question: should rustc discourage the \"misuse\" of <code>doc(hidden)</code> now that <code>non_exhaustive</code> is a thing or should it encourage by making <code>doc(hidden)</code> act more like <code>non_exhaustive</code></p>\n<blockquote>\n<p>This feels like a place where a survey could help. What popular enums in the wild could trigger this?</p>\n</blockquote>\n<ul>\n<li><a href=\"https://docs.rs/syn/latest/syn/#enums\">a lot of syn</a></li>\n<li><a href=\"https://docs.rs/url/latest/url/enum.SyntaxViolation.html\">url parse errors</a></li>\n<li><a href=\"https://docs.rs/csv/latest/csv/#enums\">csv errors</a></li>\n</ul>\n<p>I was surprised how little enums are used in general, it took me a while to find these examples looking at the top crates on cratesio.</p>\n<blockquote>\n<p>(The unstable thing is probably easier, since that only happens in the standard library, so we know what it looks like. And there's precedent like avoiding unstable methods in method resolution.)</p>\n</blockquote>\n<p>Yeah, it need to produce a wild card when the <code>unstable</code>variants are filtered, or you can get into situations where you have an \"exhaustive\" match that isn't exhaustive (see this <a href=\"https://github.com/rust-lang/rust/pull/89105#discussion_r724349576\">comment</a> ðŸ¤¯).</p>",
        "id": 263706651,
        "sender_full_name": "DevinR528",
        "timestamp": 1638623837
    },
    {
        "content": "<p>I've suggested <code>doc(alias)</code> be used for diagnostics in the past ( <a href=\"https://github.com/rust-lang/rust/issues/83968\">https://github.com/rust-lang/rust/issues/83968</a>); I don't think it's particularly important to only have doc attributes affect rustdoc as long as we're not stabilizing the new behavior.</p>",
        "id": 263712194,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1638629488
    },
    {
        "content": "<p>Ah, to copy out one of those things from <code>syn</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">        </span><span class=\"c1\">// The following is the only supported idiom for exhaustive matching of</span>\n<span class=\"w\">        </span><span class=\"c1\">// this enum.</span>\n<span class=\"w\">        </span><span class=\"c1\">//</span>\n<span class=\"w\">        </span><span class=\"c1\">//     match expr {</span>\n<span class=\"w\">        </span><span class=\"c1\">//         ForeignItem::Fn(e) =&gt; {...}</span>\n<span class=\"w\">        </span><span class=\"c1\">//         ForeignItem::Static(e) =&gt; {...}</span>\n<span class=\"w\">        </span><span class=\"c1\">//         ...</span>\n<span class=\"w\">        </span><span class=\"c1\">//         ForeignItem::Verbatim(e) =&gt; {...}</span>\n<span class=\"w\">        </span><span class=\"c1\">//</span>\n<span class=\"w\">        </span><span class=\"c1\">//         #[cfg(test)]</span>\n<span class=\"w\">        </span><span class=\"c1\">//         ForeignItem::__TestExhaustive(_) =&gt; unimplemented!(),</span>\n<span class=\"w\">        </span><span class=\"c1\">//         #[cfg(not(test))]</span>\n<span class=\"w\">        </span><span class=\"c1\">//         _ =&gt; { /* some sane fallback */ }</span>\n<span class=\"w\">        </span><span class=\"c1\">//     }</span>\n<span class=\"w\">        </span><span class=\"c1\">//</span>\n<span class=\"w\">        </span><span class=\"c1\">// This way we fail your tests but don't break your library when adding</span>\n<span class=\"w\">        </span><span class=\"c1\">// a variant. You will be notified by a test failure when a variant is</span>\n<span class=\"w\">        </span><span class=\"c1\">// added, so that you can add code to handle it, but your library will</span>\n<span class=\"w\">        </span><span class=\"c1\">// continue to compile and work for downstream users in the interim.</span>\n<span class=\"w\">        </span><span class=\"c1\">//</span>\n<span class=\"w\">        </span><span class=\"c1\">// Once `deny(reachable)` is available in rustc, ForeignItem will be</span>\n<span class=\"w\">        </span><span class=\"c1\">// reimplemented as a non_exhaustive enum.</span>\n<span class=\"w\">        </span><span class=\"c1\">// https://github.com/rust-lang/rust/issues/44109#issuecomment-521781237</span>\n<span class=\"w\">        </span><span class=\"cp\">#[doc(hidden)]</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">__TestExhaustive</span><span class=\"p\">(</span><span class=\"k\">crate</span>::<span class=\"n\">private</span><span class=\"p\">),</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 263731369,
        "sender_full_name": "scottmcm",
        "timestamp": 1638652002
    },
    {
        "content": "<p>So I think that's permission to show hidden fields in <code>warn(non_exhaustive_omitted_patterns)</code> <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 263731382,
        "sender_full_name": "scottmcm",
        "timestamp": 1638652047
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/131828-t-compiler/topic/Should.20error.20msgs.20list.20doc.28hidden.29.20fields/near/263712194\">said</a>:</p>\n<blockquote>\n<p>I've suggested <code>doc(alias)</code> be used for diagnostics in the past ( <a href=\"https://github.com/rust-lang/rust/issues/83968\">https://github.com/rust-lang/rust/issues/83968</a>); I don't think it's particularly important to only have doc attributes affect rustdoc as long as we're not stabilizing the new behavior.</p>\n</blockquote>\n<p>The ultimate goal is to stabilize the new behavior though, right?</p>",
        "id": 263731786,
        "sender_full_name": "Noah Lev",
        "timestamp": 1638652622
    },
    {
        "content": "<p>There's some extra nuance for lints -- even stable lints don't have the same stability guarantees as the language or library.  So even if the behaviour ends up on stable, we can still undo it later if it turns out to have been a bad idea.</p>",
        "id": 263732434,
        "sender_full_name": "scottmcm",
        "timestamp": 1638653300
    }
]