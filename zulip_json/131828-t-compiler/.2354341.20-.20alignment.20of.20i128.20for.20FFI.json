[
    {
        "content": "<p>I'm currently looking into the issue of the alignment of <code>i128</code> being 8 while the C <code>__int128</code> has an alignment of 16. Clang ignores the LLVM datalayout and hard-codes the alignment to 16 bytes.</p>\n<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> You previously attempted to fix this in <a href=\"https://github.com/rust-lang/rust/issues/38871\">#38871</a>, but in the end it didn't get merged. There was an attempt to fix this on the LLVM side but that didn't go through either. Do you think we can just hard-code the alignment like Clang does and ignore the datalayout?</p>",
        "id": 260289399,
        "sender_full_name": "Amanieu",
        "timestamp": 1636040778
    },
    {
        "content": "<p>I would rather we don't. Data layout is used by our size and layout calculation code as implemented by eddyb.</p>",
        "id": 260296307,
        "sender_full_name": "nagisa",
        "timestamp": 1636043206
    },
    {
        "content": "<p>IME the right solution would be to change the data layout string on our end and remove the requirement that it matches whatever llvm thinks is default.</p>",
        "id": 260296354,
        "sender_full_name": "nagisa",
        "timestamp": 1636043232
    },
    {
        "content": "<p><a href=\"https://reviews.llvm.org/D28990\">https://reviews.llvm.org/D28990</a>  was a fix attempt on LLVM side.</p>",
        "id": 260296576,
        "sender_full_name": "nagisa",
        "timestamp": 1636043321
    },
    {
        "content": "<p>I never actually followed up on this.</p>",
        "id": 260296632,
        "sender_full_name": "nagisa",
        "timestamp": 1636043348
    },
    {
        "content": "<p>@nagisa One possibility for changing LLVM is to change the default alignment in the datalayout for i128 when a value isn't specified (<a href=\"https://github.com/llvm/llvm-project/blob/9714444f1e43fafc7e5235f4d3675b9d2056d97b/llvm/lib/IR/DataLayout.cpp#L170\">here</a>). That way the actual datalayout strings wouldn't need to be changed.</p>",
        "id": 260354274,
        "sender_full_name": "Amanieu",
        "timestamp": 1636073353
    },
    {
        "content": "<p>Any target that doesn't specify an alignment for i128 in their datalayout will have it default to 128-bit alignment, which is in line with what Clang expects.</p>",
        "id": 260354299,
        "sender_full_name": "Amanieu",
        "timestamp": 1636073400
    },
    {
        "content": "<p>We hit the <code>__int128</code> issue on the libc bindings and I'd like to figure out <em>some</em> way we can make <code>i128</code> C-compatible.</p>",
        "id": 260355220,
        "sender_full_name": "Amanieu",
        "timestamp": 1636074165
    },
    {
        "content": "<p>would we make it <em>conditionally</em> FFI-safe? I don't think all targets have <code>__int128</code> in their C ABIs</p>",
        "id": 260355526,
        "sender_full_name": "cuviper",
        "timestamp": 1636074478
    },
    {
        "content": "<p>Yes, we would basically disable the FFI-safe lint for <code>i128</code> only on targets that have a <code>__int128</code> type.</p>",
        "id": 260357125,
        "sender_full_name": "Amanieu",
        "timestamp": 1636076086
    }
]