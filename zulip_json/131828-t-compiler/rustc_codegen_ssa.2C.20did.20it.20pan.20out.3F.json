[
    {
        "content": "<p>Do we think rustc_codegen_ssa pan out as a way to extract some supposedly common parts around building a crate to a SSA-like IR? As far as I know none of the non-llvm backends actually use parts of <code>rustc_codegen_ssa</code> that are not strictly required for an alternative codegen backend (i.e. traits like <code>CodegenBackend</code> trait and maybe linker invocation stuff?)</p>",
        "id": 254851064,
        "sender_full_name": "nagisa",
        "timestamp": 1632586413
    },
    {
        "content": "<p>I was kinda thinking it might be a good idea to replace <code>rustc_codegen_ssa</code> with just <code>rustc_codegen</code> that contains the strictly required parts for implementing a codegen backend and then merging all of the SSA-like stuff back into the <code>_llvm</code>?</p>",
        "id": 254851146,
        "sender_full_name": "nagisa",
        "timestamp": 1632586471
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> <span class=\"user-mention\" data-user-id=\"133247\">@bjorn3</span> ^</p>",
        "id": 254851176,
        "sender_full_name": "nagisa",
        "timestamp": 1632586506
    },
    {
        "content": "<p>cg_gcc and rust-gpu use cg_ssa heavily. only cg_clif uses a small part of it.</p>",
        "id": 254852133,
        "sender_full_name": "bjorn3",
        "timestamp": 1632587435
    },
    {
        "content": "<p>cg_ssa is biased towards llvm, but it works reasonably well with codegen backends that are somewhat similar to llvm, like gcc.</p>",
        "id": 254852240,
        "sender_full_name": "bjorn3",
        "timestamp": 1632587523
    },
    {
        "content": "<p>it could be improved a lot though IMHO.</p>",
        "id": 254852266,
        "sender_full_name": "bjorn3",
        "timestamp": 1632587546
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"404242\">@antoyo</span></p>",
        "id": 254854495,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1632589647
    },
    {
        "content": "<p>Yes, rustc_codegen_gcc uses rustc_codegen_ssa. I had to use many hacks to make it work though, so it'd be great to improve it. I won't be able to implement some features without changing its API.</p>\n<p>My plan was to start proposing changes to cg_ssa once cg_gcc is merged, but here are some areas I'd like to see improvements:</p>\n<ul>\n<li>rvalue vs lvalue</li>\n<li>landing pads (unwinding)</li>\n<li>handling of basic blocks (mostly an issue for intrinsics that don't exist in gcc)</li>\n<li>function vs value</li>\n<li>\n<p>AST-based IR vs instruction-based IR<br>\n** Example: dereference of pointers in wrong basic block</p>\n</li>\n<li>\n<p>separate aggregate operations (structs, arrays, vectors)</p>\n</li>\n</ul>\n<p>I did talk about those in <a href=\"https://www.linuxplumbersconf.org/event/11/contributions/903/\">my talk at the LPC</a>.</p>\n<p>I can provide more details now if needed.</p>",
        "id": 254855257,
        "sender_full_name": "antoyo",
        "timestamp": 1632590286
    },
    {
        "content": "<p>Is there a transcript or a recording of the talk?</p>",
        "id": 254856805,
        "sender_full_name": "nagisa",
        "timestamp": 1632591661
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> <a href=\"#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/254856805\">said</a>:</p>\n<blockquote>\n<p>Is there a transcript or a recording of the talk?</p>\n</blockquote>\n<p>Yes, <a href=\"https://youtu.be/ORwYx5_zmZo?t=5794\">here's the recording of that particular slide</a>.</p>\n<div class=\"youtube-video message_inline_image\"><a data-id=\"ORwYx5_zmZo\" href=\"https://youtu.be/ORwYx5_zmZo?t=5794\"><img src=\"https://uploads.zulipusercontent.net/05fc1b0dd842fb4d6b6b22481b2ef6c1a53b612b/68747470733a2f2f692e7974696d672e636f6d2f76692f4f52775978355f7a6d5a6f2f64656661756c742e6a7067\"></a></div>",
        "id": 254858165,
        "sender_full_name": "antoyo",
        "timestamp": 1632592837
    },
    {
        "content": "<p>My concern with attempting to make <code>_ssa</code> fit more use-cases is that even if we sit down and take all our knowledge into account and design a perfect interface, some other backend will come around and the new well considered interface won't be all that suitable for it.</p>",
        "id": 254867430,
        "sender_full_name": "nagisa",
        "timestamp": 1632601135
    },
    {
        "content": "<p>(I also have a feeling that MIR itself is pretty close to a generally great interface here)</p>",
        "id": 254867531,
        "sender_full_name": "nagisa",
        "timestamp": 1632601225
    },
    {
        "content": "<p>MIR is way too high-level. You need to reimplement the algorithms for getting and setting discriminants, unsize coercions and worst of all the abi handling. The former werw relatively straight forward to reimplement, but the abi handling too me so many iterations to get right. IMHO the abj handling code in cg_clif right now is much cleaner than the one in cg_ssa. When using cg_ssa this doesn't matter though as the codegen backend basically only needs to implement loads, stores, stack allocation and a way to set param abi flags I think. The rest is handled within cg_ssa. That includes <code>#[track_caller]</code>, <code>extern \"rust-call\"</code>, indirect and vtable calls (requires making the fat self pointer thin) and abi adjustments.</p>",
        "id": 254868311,
        "sender_full_name": "bjorn3",
        "timestamp": 1632602026
    },
    {
        "content": "<p>Right, I didn't mean in terms of what is least effort, but in terms of what's most generally usable without resorting to hacks. ABI computation code, at least parts of it that end up describing what's an ABI look like, sounds like something that could be a part of the target code, rather than backend code.</p>",
        "id": 254868851,
        "sender_full_name": "nagisa",
        "timestamp": 1632602522
    },
    {
        "content": "<p>Much like layout code isn't part of the backend but rather its own kinda independent component.</p>",
        "id": 254868899,
        "sender_full_name": "nagisa",
        "timestamp": 1632602563
    },
    {
        "content": "<p>Of course there's a downside to not sharing all this code between backends in that with increasing number of backends, the effort to keep all of them updated is also going to increase much more significantly.</p>",
        "id": 254868949,
        "sender_full_name": "nagisa",
        "timestamp": 1632602632
    },
    {
        "content": "<p>So from what I'm gathering, the way I should be approaching what I'd like to do is trying to extract and/or move and/or refactor the generally reusable components out of <code>_ssa</code> and we can reconsider other stuff later.</p>",
        "id": 254869288,
        "sender_full_name": "nagisa",
        "timestamp": 1632602886
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133247\">@bjorn3</span> would clif be at all interested in having <code>_ssa</code> parts that are required to implement a codegen backend split out into its own crate?</p>",
        "id": 254869324,
        "sender_full_name": "nagisa",
        "timestamp": 1632602933
    },
    {
        "content": "<p>re abi handling the abi adjustment calculation is handled in a backend independent way in rustc_target and I do use it in cg_clif. The actual performing of these abi adjustements and many other details can't really be done in a generic way without ending up with an interface similar to cg_ssa.</p>",
        "id": 254870482,
        "sender_full_name": "bjorn3",
        "timestamp": 1632603965
    },
    {
        "content": "<p>I want to try to replace the abi handling code in cg_ssa with that of cg_clif and share it with cg_clif. Sharing may require require replacing cg_ssa's Operand and Place with cg_clif's equivalents though to avoid regressing codegen quality of cg_clif.</p>",
        "id": 254870658,
        "sender_full_name": "bjorn3",
        "timestamp": 1632604150
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"133247\">bjorn3</span> would clif be at all interested in having <code>_ssa</code> parts that are required to implement a codegen backend split out into its own crate?</p>\n</blockquote>\n<p>I think dissolving cg_ssa will require too much code duplication between backends. On the other hand I would apploud any effort at reducing the LLVMisms in cg_ssa.</p>",
        "id": 254870902,
        "sender_full_name": "bjorn3",
        "timestamp": 1632604395
    },
    {
        "content": "<p>After working on my own codegen, i would say cg_ssa absolutely did work out for the most part. It made modifying cg_llvm into something that could be used to compile gpu kernels almost scarily simple in relation to how much work it would have been to reimplement the mir lowering. </p>\n<p>However, i do think theres still way too many lingering remains of cg_llvm inside cg_ssa, things like the linking logic (why is it all in cg_ssa?). Moreover i feel like control over what the codegen wants to do for optimization should be given back to the codegen. Instead of thin_lto, optimize, etc methods.</p>\n<p>I also think docs on it are severely lacking, especially on the actual methods in cg_ssa, i had to do a lot of digging and a lot of bothering bjorn about what some things did ;)</p>",
        "id": 254883711,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632617290
    },
    {
        "content": "<p>i do think that MIR is not low level enough compared to simple operations through traits. I think the lower level interface of cg_ssa is definitely a win. However, i also believe that more control over how cg_ssa actually lowers the MIR would be nice. Something like being able to override how cg_ssa codegens a statement or a function. Maybe going through traits once again that describe mir lowering, not sure.</p>",
        "id": 254884205,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632617827
    },
    {
        "content": "<blockquote>\n<p>things like the linking logic (why is it all in cg_ssa?)</p>\n</blockquote>\n<p>Because it is the same for the majority of the codegen backends. Cg_llvm, cg_gcc and cg_clif need the exact same code for linking as they all produce regular object files as required by conventional linkers.</p>\n<blockquote>\n<p>Moreover i feel like control over what the codegen wants to do for optimization should be given back to the codegen. Instead of thin_lto, optimize, etc methods.</p>\n</blockquote>\n<p>I think you can avoid the codegen driver entirely and only use cg_ssa for codegening individual functions.</p>",
        "id": 254928165,
        "sender_full_name": "bjorn3",
        "timestamp": 1632659841
    },
    {
        "content": "<p>One thing I'd like is actually having more stuff in <code>cg_ssa</code>: in <code>cg_gcc</code> there are a bunch of functions copied from <code>cg_llvm</code>, some of them identical, some of them almost identical and could be made the same with a few changes in <code>cg_ssa</code> I guess.</p>",
        "id": 254933894,
        "sender_full_name": "antoyo",
        "timestamp": 1632665158
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"133247\">@bjorn3</span> <span class=\"user-mention\" data-user-id=\"404242\">@antoyo</span> It sounds silly but why not put the linking logic as well as the functions ur talking about in a separate crate, called cg_cpu/cg_cpu_utils or something? I dont really think cg_ssa is the place for it, i think cg ssa should be for abstracting mir lowering and thats it</p>",
        "id": 255247464,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632846990
    },
    {
        "content": "<p>That would be an option. cg_ssa is currently for pretty much everything that only backends use.</p>",
        "id": 255252306,
        "sender_full_name": "bjorn3",
        "timestamp": 1632848711
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"276242\">Riccardo D'Ambrosio</span> <a href=\"#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/255247464\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"133247\">bjorn3</span> <span class=\"user-mention silent\" data-user-id=\"404242\">antoyo</span> It sounds silly but why not put the linking logic as well as the functions ur talking about in a separate crate, called cg_cpu/cg_cpu_utils or something? I dont really think cg_ssa is the place for it, i think cg ssa should be for abstracting mir lowering and thats it</p>\n</blockquote>\n<p>Which functions? The changes I'd like are refactor of cg_ssa.</p>",
        "id": 255264711,
        "sender_full_name": "antoyo",
        "timestamp": 1632850682
    },
    {
        "content": "<p>yeah and i think as rust is targeted for more generic outputs (e.g. spirv or ptx), it would be nice to make cg_ssa just a mir lowering interface and moving the cpu specific stuff elsewhere. cg_ssa is nice but it has some... odd things inside. Random odd functions that are very much cpu-specific (im looking at you insert_reference_to_gdb_debug_scripts_section_global). It feels to me like its for cpu codegen first, and other codegen is just \"yeah u can prob do that but it wasnt exactly made for that\"</p>",
        "id": 255264832,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632850715
    },
    {
        "content": "<blockquote>\n<p>refactor of cg_ssa</p>\n</blockquote>\n<p>What changes would that entail exactly?</p>",
        "id": 255264931,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632850754
    },
    {
        "content": "<p>Im not super familiar with odd things found outside of using cg_ssa without llvm (because my codegen uses llvm, just an older version and a subset that libnvvm accepts). Could you give some examples?</p>",
        "id": 255265331,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632850903
    },
    {
        "content": "<p>I am familiar with cpu-specific things like linking logic, theres plenty of those \"niche\" functions in there</p>",
        "id": 255265435,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632850936
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"276242\">Riccardo D'Ambrosio</span> <a href=\"#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/255264931\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>refactor of cg_ssa</p>\n</blockquote>\n<p>What changes would that entail exactly?</p>\n</blockquote>\n<p>I shared them <a href=\"#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/254855257\">above</a>.</p>",
        "id": 255277393,
        "sender_full_name": "antoyo",
        "timestamp": 1632854978
    },
    {
        "content": "<p>oh right i totally forgot, my bad</p>",
        "id": 255278698,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632855467
    },
    {
        "content": "<p>why are basic blocks an issue for intrinsics?</p>",
        "id": 255278730,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632855482
    },
    {
        "content": "<p>are u talking about like, basic block jump/goto things?</p>",
        "id": 255278922,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632855545
    },
    {
        "content": "<p>for value vs function couldnt you represent value as an enum in the codegen?</p>",
        "id": 255280384,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632856048
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"276242\">Riccardo D'Ambrosio</span> <a href=\"#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/255278730\">said</a>:</p>\n<blockquote>\n<p>why are basic blocks an issue for intrinsics?</p>\n</blockquote>\n<p>I need to do stuff like <a href=\"https://github.com/rust-lang/rustc_codegen_gcc/blob/master/src/intrinsic/mod.rs#L186-L190\">this</a> which is error-prone.</p>",
        "id": 255283357,
        "sender_full_name": "antoyo",
        "timestamp": 1632857190
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"276242\">Riccardo D'Ambrosio</span> <a href=\"#narrow/stream/131828-t-compiler/topic/rustc_codegen_ssa.2C.20did.20it.20pan.20out.3F/near/255280384\">said</a>:</p>\n<blockquote>\n<p>for value vs function couldnt you represent value as an enum in the codegen?</p>\n</blockquote>\n<p>That would still be inconvenient. Just so you understand better, currently I do <a href=\"https://github.com/rust-lang/rustc_codegen_gcc/blob/master/src/builder.rs#L403\">unsafe casts</a> (function defined <a href=\"https://github.com/rust-lang/rustc_codegen_gcc/blob/master/src/context.rs#L223\">here</a>).</p>",
        "id": 255283697,
        "sender_full_name": "antoyo",
        "timestamp": 1632857332
    },
    {
        "content": "<p>Is cg_ssa something that supplies helpers and gets used as a library, or an abstraction layer with hooks?</p>",
        "id": 255287082,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1632858672
    },
    {
        "content": "<p>it provides as a library the core traits etc that an actual backend needs to implement to be considered a codegen backend. In addition to that it contains some common code around linker invocation and artifact management as well as an abstraction with some convenience implementation for SSA-like backends.</p>",
        "id": 255287724,
        "sender_full_name": "nagisa",
        "timestamp": 1632858900
    },
    {
        "content": "<p>basically it has a lot of stuff that doesn't necessarily need to be a single crate.</p>",
        "id": 255287749,
        "sender_full_name": "nagisa",
        "timestamp": 1632858913
    },
    {
        "content": "<p>I think one valid approach to making cg_ssa abstractions more suitable for backends such as the cg_gcc one, might be splitting up cg_ssa into parts that are required for a cg (<code>rustc_codegen</code> perhaps?) and not required (remains in <code>cg_ssa</code>) and then we could e.g. introduce something like <code>cg_ssa2</code> to simplify the efforts in re-abstraction or somesuch.</p>",
        "id": 255288037,
        "sender_full_name": "nagisa",
        "timestamp": 1632859012
    },
    {
        "content": "<p>Since cg_gcc is gonna get merged soon, I'll want to start making changes to cg_ssa. What would be the process to do that?</p>",
        "id": 255288748,
        "sender_full_name": "antoyo",
        "timestamp": 1632859263
    },
    {
        "content": "<p>I don't see a problem with changing cg_ssa itself either ^^</p>",
        "id": 255289104,
        "sender_full_name": "nagisa",
        "timestamp": 1632859390
    },
    {
        "content": "<p>Good. I still wonder what would be the process. Do I need to do a RFC or something?</p>",
        "id": 255289372,
        "sender_full_name": "antoyo",
        "timestamp": 1632859479
    },
    {
        "content": "<p>Just PRs seem fine</p>",
        "id": 255289542,
        "sender_full_name": "simulacrum",
        "timestamp": 1632859538
    },
    {
        "content": "<p>(maybe MCPs)</p>",
        "id": 255289564,
        "sender_full_name": "simulacrum",
        "timestamp": 1632859548
    },
    {
        "content": "<p>Feel free to cc me on cg_ssa PRs.</p>",
        "id": 255297369,
        "sender_full_name": "bjorn3",
        "timestamp": 1632862366
    },
    {
        "content": "<p>I think cg_ssa2 would be a weird name for it, i propose:</p>\n<ul>\n<li>rustc_codegen OR rustc_codegen_ssa: contains the CodegenBackend trait, the bare bones for what can be considered a codegen, as well as convenience traits for doing the MIR lowering for you. BUT contains zero (unlikely but close to zero) cpu specific things like linking.</li>\n<li>rustc_codegen_cpu: contains all of the utils that cg_clif, cg_llvm, and cg_gcc for linking and such, that cg_spirv and cg_nvvm do not need.</li>\n</ul>",
        "id": 255299607,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632863241
    },
    {
        "content": "<p>Honestly, i think the best long term thing that rustc could do is introduce LIR, but thats a ton of work</p>",
        "id": 255300295,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632863536
    },
    {
        "content": "<p>because then codegens could just retrieve the LIR (which can be optimized beforehand by rustc too), and then rewrite and analyze the entire structure of a function instead of blindly providing functions for adding instructions and such</p>",
        "id": 255300415,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632863598
    },
    {
        "content": "<p>So if for example, cg_gcc cannot deal with a basic block instruction, it can go in and analyze and modify the LIR on its own before it codegens it</p>",
        "id": 255300561,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632863645
    },
    {
        "content": "<p>And additionally, because LIR would be optimization-friendly (because it would be monomorphized and very simplistic), it would open up more opportunities for optimization for backends that dont use an optimizing codegen already (cg_clif and cg_spirv)</p>",
        "id": 255301184,
        "sender_full_name": "Riccardo D'Ambrosio",
        "timestamp": 1632863840
    }
]