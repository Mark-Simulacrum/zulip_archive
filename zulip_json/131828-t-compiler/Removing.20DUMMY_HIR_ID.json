[
    {
        "content": "<p>I made a first attempt at removing small usage of DUMMY_HIR_ID: <a href=\"https://github.com/rust-lang/rust/pull/71069\" title=\"https://github.com/rust-lang/rust/pull/71069\">https://github.com/rust-lang/rust/pull/71069</a></p>",
        "id": 193722651,
        "sender_full_name": "marmeladema",
        "timestamp": 1586713745
    },
    {
        "content": "<p>(tests are compiling locally right now, so i don't know if they pass yet)</p>",
        "id": 193722669,
        "sender_full_name": "marmeladema",
        "timestamp": 1586713786
    },
    {
        "content": "<p>heh you got there before me</p>",
        "id": 193724377,
        "sender_full_name": "eddyb",
        "timestamp": 1586716346
    },
    {
        "content": "<p><span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> on <code>ObligationCause::dummy()</code></p>",
        "id": 193724384,
        "sender_full_name": "eddyb",
        "timestamp": 1586716362
    },
    {
        "content": "<p>idk if I should do a PSA but \"CI / PR (x86_64-gnu-llvm-7) (pull_request) Successful in 41m \" is the thing to look for in general</p>",
        "id": 193724531,
        "sender_full_name": "eddyb",
        "timestamp": 1586716584
    },
    {
        "content": "<p>it's faster than the same checks running on the older Azure</p>",
        "id": 193724546,
        "sender_full_name": "eddyb",
        "timestamp": 1586716626
    },
    {
        "content": "<p>Yep, i looked at it and all the tests pass. Azure build takes 120m <span aria-label=\"fear\" class=\"emoji emoji-1f628\" role=\"img\" title=\"fear\">:fear:</span></p>",
        "id": 193724555,
        "sender_full_name": "marmeladema",
        "timestamp": 1586716663
    },
    {
        "content": "<p>There is also this other quick one: <a href=\"https://github.com/rust-lang/rust/pull/71071\" title=\"https://github.com/rust-lang/rust/pull/71071\">https://github.com/rust-lang/rust/pull/71071</a></p>",
        "id": 193724618,
        "sender_full_name": "marmeladema",
        "timestamp": 1586716700
    },
    {
        "content": "<p>3x speedup for 4x the cores I guess :D</p>",
        "id": 193724639,
        "sender_full_name": "eddyb",
        "timestamp": 1586716752
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> ping me when this second one passes too :P</p>",
        "id": 193724660,
        "sender_full_name": "eddyb",
        "timestamp": 1586716796
    },
    {
        "content": "<p>actually in general, ping me here because I'll see it faster than in GH notifications</p>",
        "id": 193724709,
        "sender_full_name": "eddyb",
        "timestamp": 1586716816
    },
    {
        "content": "<p>Will do, thanks! I might have one or two other small ones</p>",
        "id": 193724727,
        "sender_full_name": "marmeladema",
        "timestamp": 1586716869
    },
    {
        "content": "<p>it might be worth combining them into one PR?</p>",
        "id": 193724732,
        "sender_full_name": "eddyb",
        "timestamp": 1586716879
    },
    {
        "content": "<p>since they share in common the removal of DUMMY_HIR_ID uses</p>",
        "id": 193724737,
        "sender_full_name": "eddyb",
        "timestamp": 1586716891
    },
    {
        "content": "<p>yep, sorry. I split the one for <code>ObligationCause</code> because i was not sure</p>",
        "id": 193724748,
        "sender_full_name": "marmeladema",
        "timestamp": 1586716919
    },
    {
        "content": "<p>But yes, i will merge all the subsequent ones if they are straightforward</p>",
        "id": 193724795,
        "sender_full_name": "marmeladema",
        "timestamp": 1586716953
    },
    {
        "content": "<p>you can even combine them into the PR I approved and I can just reapprove</p>",
        "id": 193725208,
        "sender_full_name": "eddyb",
        "timestamp": 1586717574
    },
    {
        "content": "<p>I added more commits to <a href=\"https://github.com/rust-lang/rust/pull/71069\" title=\"https://github.com/rust-lang/rust/pull/71069\">https://github.com/rust-lang/rust/pull/71069</a></p>",
        "id": 193727986,
        "sender_full_name": "marmeladema",
        "timestamp": 1586721996
    },
    {
        "content": "<p>I'm still awake so I'll review now</p>",
        "id": 193728594,
        "sender_full_name": "eddyb",
        "timestamp": 1586722900
    },
    {
        "content": "<p>Thanks</p>",
        "id": 193728827,
        "sender_full_name": "marmeladema",
        "timestamp": 1586723299
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> do you have more commits coming?</p>",
        "id": 193728857,
        "sender_full_name": "eddyb",
        "timestamp": 1586723382
    },
    {
        "content": "<p>Not right now</p>",
        "id": 193728926,
        "sender_full_name": "marmeladema",
        "timestamp": 1586723470
    },
    {
        "content": "<p>I'll r+ once it passes</p>",
        "id": 193728929,
        "sender_full_name": "eddyb",
        "timestamp": 1586723479
    },
    {
        "content": "<p>I hope it passes :/</p>",
        "id": 193728935,
        "sender_full_name": "marmeladema",
        "timestamp": 1586723503
    },
    {
        "content": "<p>I don't see anything problematic</p>",
        "id": 193728998,
        "sender_full_name": "eddyb",
        "timestamp": 1586723635
    },
    {
        "content": "<p>it passes <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 193729369,
        "sender_full_name": "marmeladema",
        "timestamp": 1586724261
    },
    {
        "content": "<p>Thanks! It got merged pretty quickly! I am king a now blocked on removing it from <code>librustc_ast_lowering</code>. A table that maps node id to hir id is pre allocated in <code>lower_node_id_generic</code>. I tried to change to type of that <code>IndexVec</code> to store <code>Option&lt;HirId&gt;</code> instead of bare <code>HirId</code> and then filter out unused value when calling <code>init_node_id_to_hir_id_mapping</code> but that breaks because there is another table <code>node_id_to_def_id</code> that maps node id to def id and because i removed unused entries in the first table, the indexes do not match anymore in this second table</p>",
        "id": 193758646,
        "sender_full_name": "marmeladema",
        "timestamp": 1586772211
    },
    {
        "content": "<p>I could just store Option's too in <code>librustc_hir</code> but that would mean either returning Option everywhere or calling unwrap() before returning which might impact perf</p>",
        "id": 193758737,
        "sender_full_name": "marmeladema",
        "timestamp": 1586772325
    },
    {
        "content": "<p>Or I could change the <code>IndexVec</code> to <code>FxHashMap</code>? Dunno if thats a good idea either</p>",
        "id": 193758852,
        "sender_full_name": "marmeladema",
        "timestamp": 1586772449
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> hmm what if you move <code>DUMMY_HIR_ID</code> inside the function that it's used in? unless it's used in more than one file?</p>",
        "id": 193759660,
        "sender_full_name": "eddyb",
        "timestamp": 1586773322
    },
    {
        "content": "<p>well, i could but it means that it will be really stored as value in the table and that it can be \"leaked\" to other module that access the table using <code>node_id_to_hir_id</code> or <code>local_def_id_to_hir_id</code></p>",
        "id": 193759766,
        "sender_full_name": "marmeladema",
        "timestamp": 1586773451
    },
    {
        "content": "<p>okay now that your PR is merged I can refresh my search and see if I can understand what is going on</p>",
        "id": 193759789,
        "sender_full_name": "eddyb",
        "timestamp": 1586773500
    },
    {
        "content": "<p>So from what i understand, during lowering DUMMY_HIR_ID is used to pre-allocate hir ids because <code>lower_node_id_generic</code> is not called with consecutive <code>ast_node_id</code> but it is used as an index in that table, so it fills the table to \"empty entries\" and use the DUMMY_HIR_ID as value</p>",
        "id": 193759887,
        "sender_full_name": "marmeladema",
        "timestamp": 1586773629
    },
    {
        "content": "<p>and then the <code>hir_id_validator</code> ensures there are no dummy entries left</p>",
        "id": 193759952,
        "sender_full_name": "eddyb",
        "timestamp": 1586773693
    },
    {
        "content": "<p>Oh i'll look to that one, i have missed it</p>",
        "id": 193759959,
        "sender_full_name": "marmeladema",
        "timestamp": 1586773720
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> so I think you can use <code>Option</code></p>",
        "id": 193759962,
        "sender_full_name": "eddyb",
        "timestamp": 1586773733
    },
    {
        "content": "<p><code>Option&lt;HirId&gt;</code> will be the same size as <code>HirId</code></p>",
        "id": 193759973,
        "sender_full_name": "eddyb",
        "timestamp": 1586773754
    },
    {
        "content": "<p>(thanks to some niche tricks we do with index types)</p>",
        "id": 193759978,
        "sender_full_name": "eddyb",
        "timestamp": 1586773765
    },
    {
        "content": "<p>i did try the Option&lt;&gt; but it failed miserably because there are some empty entries somehow</p>",
        "id": 193759981,
        "sender_full_name": "marmeladema",
        "timestamp": 1586773771
    },
    {
        "content": "<p>oh!</p>",
        "id": 193759998,
        "sender_full_name": "eddyb",
        "timestamp": 1586773798
    },
    {
        "content": "<p>but how does <code>hir_id_validator</code> not see them later?</p>",
        "id": 193760042,
        "sender_full_name": "eddyb",
        "timestamp": 1586773812
    },
    {
        "content": "<p>thats what i want to look at because either my branch was broken or something is wrong somewhere. I did not know about <code>hir_id_validator</code> last night, i am taking a look</p>",
        "id": 193760061,
        "sender_full_name": "marmeladema",
        "timestamp": 1586773857
    },
    {
        "content": "<p>So, i am not sure of anything, but reading the hir_id_validator code, i believe that it iterates over all the modules and look at the hir tree of those modules. But if we look at the flat list of hir ids, i think there are still empty entries in it even if they <em>might</em> not be reachable from any module tree.</p>",
        "id": 193764097,
        "sender_full_name": "marmeladema",
        "timestamp": 1586777950
    },
    {
        "content": "<p>Also, I found this comment:</p>\n<div class=\"codehilite\"><pre><span></span>    // FIXME(eddyb) don&#39;t go through `ast::NodeId` to convert between `HirId`\n    // and `LocalDefId` - ideally all `LocalDefId`s would be HIR owners.\n    node_id_to_def_id: FxHashMap&lt;ast::NodeId, LocalDefId&gt;,\n</pre></div>",
        "id": 193764333,
        "sender_full_name": "marmeladema",
        "timestamp": 1586778220
    },
    {
        "content": "<p>oh yeah I still need to work on that <em>sigh</em></p>",
        "id": 193764530,
        "sender_full_name": "eddyb",
        "timestamp": 1586778460
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> unreachable entries may explain it, hmpf. but still, it's kind of reckless of us to even have those</p>",
        "id": 193764589,
        "sender_full_name": "eddyb",
        "timestamp": 1586778485
    },
    {
        "content": "<p>yep, but that would explain when i removed that it broke badly because I basically \"re-numbered\" node id and the node id to def id table was out of sync</p>",
        "id": 193764639,
        "sender_full_name": "marmeladema",
        "timestamp": 1586778542
    },
    {
        "content": "<p>what do you mean \"removed\"?</p>",
        "id": 193764963,
        "sender_full_name": "eddyb",
        "timestamp": 1586778848
    },
    {
        "content": "<p>the <code>resize</code> call?</p>",
        "id": 193764971,
        "sender_full_name": "eddyb",
        "timestamp": 1586778875
    },
    {
        "content": "<p>I found the code a bit convoluted because some lookup table are stored globally in the <code>(dyn Resolver).definitions()</code> and some locally in the current <code>LoweringContext</code></p>",
        "id": 193764975,
        "sender_full_name": "marmeladema",
        "timestamp": 1586778886
    },
    {
        "content": "<p>I am pretty sure this can use <code>Option</code> <a href=\"https://github.com/rust-lang/rust/blob/0c835b0cca83fe21090562603e4bda77c183ace3/src/librustc_ast_lowering/lib.rs#L581-L586\" title=\"https://github.com/rust-lang/rust/blob/0c835b0cca83fe21090562603e4bda77c183ace3/src/librustc_ast_lowering/lib.rs#L581-L586\">https://github.com/rust-lang/rust/blob/0c835b0cca83fe21090562603e4bda77c183ace3/src/librustc_ast_lowering/lib.rs#L581-L586</a></p>",
        "id": 193764999,
        "sender_full_name": "eddyb",
        "timestamp": 1586778929
    },
    {
        "content": "<p>So what i did is to change the type of <code>node_id_to_hir_id</code> in <code>LoweringContext</code> to an indexvec of <code>Option&lt;HirId&gt;</code> instead of bare <code>HirId</code></p>",
        "id": 193765008,
        "sender_full_name": "marmeladema",
        "timestamp": 1586778937
    },
    {
        "content": "<p>oh wait it's passed to <code>init_node_id_to_hir_id_mapping</code> hmpf</p>",
        "id": 193765017,
        "sender_full_name": "eddyb",
        "timestamp": 1586778957
    },
    {
        "content": "<p>then in the call of <code>init_node_id_to_hir_id_mapping</code> i filter_map to remove the \"unused entries\"</p>",
        "id": 193765057,
        "sender_full_name": "marmeladema",
        "timestamp": 1586778968
    },
    {
        "content": "<p>aaaaaah</p>",
        "id": 193765066,
        "sender_full_name": "eddyb",
        "timestamp": 1586778976
    },
    {
        "content": "<p>yeah no it's a map</p>",
        "id": 193765071,
        "sender_full_name": "eddyb",
        "timestamp": 1586778982
    },
    {
        "content": "<p>the indices are \"keys\"</p>",
        "id": 193765079,
        "sender_full_name": "eddyb",
        "timestamp": 1586778990
    },
    {
        "content": "<p>yeah i figured that</p>",
        "id": 193765083,
        "sender_full_name": "marmeladema",
        "timestamp": 1586778997
    },
    {
        "content": "<p>okay so this is the problem <a href=\"https://github.com/rust-lang/rust/blob/0c835b0cca83fe21090562603e4bda77c183ace3/src/librustc_hir/definitions.rs#L478\" title=\"https://github.com/rust-lang/rust/blob/0c835b0cca83fe21090562603e4bda77c183ace3/src/librustc_hir/definitions.rs#L478\">https://github.com/rust-lang/rust/blob/0c835b0cca83fe21090562603e4bda77c183ace3/src/librustc_hir/definitions.rs#L478</a></p>",
        "id": 193765092,
        "sender_full_name": "eddyb",
        "timestamp": 1586779012
    },
    {
        "content": "<p>but in the hir, i don't want Optio&lt;HirId&gt; anymore, do i?</p>",
        "id": 193765094,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779015
    },
    {
        "content": "<p>now I think I'm caught up</p>",
        "id": 193765097,
        "sender_full_name": "eddyb",
        "timestamp": 1586779020
    },
    {
        "content": "<p>yeah I replaced this line to something like <code>self.node_id_to_hir_id = mapping.into_iter().filter_map(|hir_id| hir_id).collect();</code></p>",
        "id": 193765132,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779072
    },
    {
        "content": "<p>to remove the unused entry and avoid changing the type of <code>self.node_id_to_hir_id</code> in the hir</p>",
        "id": 193765193,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779107
    },
    {
        "content": "<p>have you tried <code>.map(Option::unwrap)</code> :D?</p>",
        "id": 193765224,
        "sender_full_name": "eddyb",
        "timestamp": 1586779145
    },
    {
        "content": "<p>since that's what I thought broke</p>",
        "id": 193765233,
        "sender_full_name": "eddyb",
        "timestamp": 1586779157
    },
    {
        "content": "<p>oh wait that's the same failure condition <em>facepalm</em></p>",
        "id": 193765245,
        "sender_full_name": "eddyb",
        "timestamp": 1586779171
    },
    {
        "content": "<p>just detected earlier</p>",
        "id": 193765250,
        "sender_full_name": "eddyb",
        "timestamp": 1586779178
    },
    {
        "content": "<p>I haven't but because it broke with filter_map it means i removed some entries and re number the ast node id</p>",
        "id": 193765251,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779180
    },
    {
        "content": "<p>right right</p>",
        "id": 193765254,
        "sender_full_name": "eddyb",
        "timestamp": 1586779185
    },
    {
        "content": "<p>yep</p>",
        "id": 193765255,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779185
    },
    {
        "content": "<p>did it broke during building libstd?</p>",
        "id": 193765258,
        "sender_full_name": "eddyb",
        "timestamp": 1586779193
    },
    {
        "content": "<p>wait hang on this just means there are <code>NodeId</code>s with no corresponding <code>HirId</code></p>",
        "id": 193765337,
        "sender_full_name": "eddyb",
        "timestamp": 1586779209
    },
    {
        "content": "<p>it broke early during stage1 iirc</p>",
        "id": 193765338,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779209
    },
    {
        "content": "<p>this is normal</p>",
        "id": 193765340,
        "sender_full_name": "eddyb",
        "timestamp": 1586779211
    },
    {
        "content": "<p>AST-&gt;HIR lowering replaces some constructs</p>",
        "id": 193765343,
        "sender_full_name": "eddyb",
        "timestamp": 1586779222
    },
    {
        "content": "<p>like <code>(a+b)</code> is just <code>a+b</code> after AST-&gt;HIR lowering</p>",
        "id": 193765352,
        "sender_full_name": "eddyb",
        "timestamp": 1586779244
    },
    {
        "content": "<p>so yeah you have to change <a href=\"https://github.com/rust-lang/rust/blob/0c835b0cca83fe21090562603e4bda77c183ace3/src/librustc_hir/definitions.rs#L90\" title=\"https://github.com/rust-lang/rust/blob/0c835b0cca83fe21090562603e4bda77c183ace3/src/librustc_hir/definitions.rs#L90\">https://github.com/rust-lang/rust/blob/0c835b0cca83fe21090562603e4bda77c183ace3/src/librustc_hir/definitions.rs#L90</a></p>",
        "id": 193765381,
        "sender_full_name": "eddyb",
        "timestamp": 1586779271
    },
    {
        "content": "<p>Yes, that makes sense, but maybe we should not use an indexvec but really a fxhashmap?</p>",
        "id": 193765389,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779282
    },
    {
        "content": "<p>every place where you can use a flat array with decent occupancy is a perf win</p>",
        "id": 193765400,
        "sender_full_name": "eddyb",
        "timestamp": 1586779305
    },
    {
        "content": "<p>and <code>Option&lt;HirId&gt;</code> is the same size as <code>HirId</code></p>",
        "id": 193765430,
        "sender_full_name": "eddyb",
        "timestamp": 1586779322
    },
    {
        "content": "<p>I figured thats why it was used for yes, perf</p>",
        "id": 193765458,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779330
    },
    {
        "content": "<p>anyway, eventually this will be used less and less and will matter less and less</p>",
        "id": 193765497,
        "sender_full_name": "eddyb",
        "timestamp": 1586779363
    },
    {
        "content": "<p>But if i replace that with Option&lt;HirId&gt;, then i need to either return Options in the related functions<br>\nor unwrap() before returning</p>",
        "id": 193765511,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779380
    },
    {
        "content": "<p>the latter is correct</p>",
        "id": 193765519,
        "sender_full_name": "eddyb",
        "timestamp": 1586779388
    },
    {
        "content": "<p>and see what breaks</p>",
        "id": 193765522,
        "sender_full_name": "eddyb",
        "timestamp": 1586779396
    },
    {
        "content": "<p>and i suspect calling unwrap() in each call might impact perf?</p>",
        "id": 193765536,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779407
    },
    {
        "content": "<p>anything that breaks will want <code>opt_</code> versions of the regular methods</p>",
        "id": 193765537,
        "sender_full_name": "eddyb",
        "timestamp": 1586779408
    },
    {
        "content": "<p>ok</p>",
        "id": 193765546,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779418
    },
    {
        "content": "<p>it might, but that's why we'll check</p>",
        "id": 193765553,
        "sender_full_name": "eddyb",
        "timestamp": 1586779420
    },
    {
        "content": "<p>first priority is to get something that compiles</p>",
        "id": 193765558,
        "sender_full_name": "eddyb",
        "timestamp": 1586779428
    },
    {
        "content": "<p>Ok</p>",
        "id": 193765619,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779443
    },
    {
        "content": "<p>ideally nothing uses <code>NodeId</code>s although I know that's not exactly true :P</p>",
        "id": 193765639,
        "sender_full_name": "eddyb",
        "timestamp": 1586779478
    },
    {
        "content": "<p>I'll try that then!</p>",
        "id": 193765753,
        "sender_full_name": "marmeladema",
        "timestamp": 1586779600
    },
    {
        "content": "<p>On a similar topic, i made to remove some usage of DUMMY_HIR_ID again: <a href=\"https://github.com/rust-lang/rust/pull/71092\" title=\"https://github.com/rust-lang/rust/pull/71092\">https://github.com/rust-lang/rust/pull/71092</a></p>",
        "id": 193771956,
        "sender_full_name": "marmeladema",
        "timestamp": 1586784725
    },
    {
        "content": "<p>test pass on CI, but locally, rustdoc tests are failing</p>",
        "id": 193771962,
        "sender_full_name": "marmeladema",
        "timestamp": 1586784742
    },
    {
        "content": "<p>How is that possible? oO</p>",
        "id": 193771980,
        "sender_full_name": "marmeladema",
        "timestamp": 1586784776
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> can you share your local failures?</p>",
        "id": 193772041,
        "sender_full_name": "eddyb",
        "timestamp": 1586784830
    },
    {
        "content": "<p>also you can put <code>r? @eddyb</code> in the PR description</p>",
        "id": 193772095,
        "sender_full_name": "eddyb",
        "timestamp": 1586784852
    },
    {
        "content": "<p>I have another commit that i removed because i thought it was responsible for rustdoc test failures, but i reran locally without it and its still failing</p>",
        "id": 193772161,
        "sender_full_name": "marmeladema",
        "timestamp": 1586784932
    },
    {
        "content": "<p><a href=\"https://paste.ee/p/PaE4g\" title=\"https://paste.ee/p/PaE4g\">https://paste.ee/p/PaE4g</a></p>",
        "id": 193772227,
        "sender_full_name": "marmeladema",
        "timestamp": 1586784964
    },
    {
        "content": "<p>that's.... weird</p>",
        "id": 193772278,
        "sender_full_name": "eddyb",
        "timestamp": 1586785031
    },
    {
        "content": "<p>what was the commit?</p>",
        "id": 193772289,
        "sender_full_name": "eddyb",
        "timestamp": 1586785044
    },
    {
        "content": "<p>I just added it back to the PR</p>",
        "id": 193772306,
        "sender_full_name": "marmeladema",
        "timestamp": 1586785063
    },
    {
        "content": "<p>this one? <a href=\"https://github.com/rust-lang/rust/pull/71092/commits/23da8057990355291235b8b8eaf164806111f20f\" title=\"https://github.com/rust-lang/rust/pull/71092/commits/23da8057990355291235b8b8eaf164806111f20f\">https://github.com/rust-lang/rust/pull/71092/commits/23da8057990355291235b8b8eaf164806111f20f</a></p>",
        "id": 193772387,
        "sender_full_name": "eddyb",
        "timestamp": 1586785103
    },
    {
        "content": "<p>Yes, but in fact, no matter what commit I add, i feel like my rustdoc tests are failing</p>",
        "id": 193772429,
        "sender_full_name": "marmeladema",
        "timestamp": 1586785149
    },
    {
        "content": "<p>I'll try to run them from master and see what happens</p>",
        "id": 193772440,
        "sender_full_name": "marmeladema",
        "timestamp": 1586785162
    },
    {
        "content": "<p>azure tests are failing because of some error getting python-setuptools</p>",
        "id": 193772643,
        "sender_full_name": "marmeladema",
        "timestamp": 1586785311
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>E: Failed to fetch http://azure.archive.ubuntu.com/ubuntu/pool/main/p/python-setuptools/python3-setuptools_20.7.0-1_all.deb  503  Service Unavailable\n</pre></div>",
        "id": 193772652,
        "sender_full_name": "marmeladema",
        "timestamp": 1586785318
    },
    {
        "content": "<p>lol</p>",
        "id": 193772654,
        "sender_full_name": "eddyb",
        "timestamp": 1586785318
    },
    {
        "content": "<p>I still don't understand how \"CI network errors\" are still a thing</p>",
        "id": 193772701,
        "sender_full_name": "eddyb",
        "timestamp": 1586785341
    },
    {
        "content": "<p>Can they be rerun?</p>",
        "id": 193772883,
        "sender_full_name": "marmeladema",
        "timestamp": 1586785460
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"116122\">@simulacrum</span> <span class=\"user-mention\" data-user-id=\"121055\">@Pietro Albini</span></p>",
        "id": 193772896,
        "sender_full_name": "eddyb",
        "timestamp": 1586785468
    },
    {
        "content": "<p>generally those errors mean we just have to wait unfortunately</p>",
        "id": 193772941,
        "sender_full_name": "simulacrum",
        "timestamp": 1586785495
    },
    {
        "content": "<p>Ok, tests are failing locally on master also. Very weird, but expect for the azure tests, everything looks good for my PR</p>",
        "id": 193777416,
        "sender_full_name": "marmeladema",
        "timestamp": 1586788308
    },
    {
        "content": "<p>yeah so something broke locally</p>",
        "id": 193777473,
        "sender_full_name": "eddyb",
        "timestamp": 1586788329
    },
    {
        "content": "<p>maybe Python?</p>",
        "id": 193777483,
        "sender_full_name": "eddyb",
        "timestamp": 1586788335
    },
    {
        "content": "<p>yeah i'll dig into the <code>htmldocck.py</code> script</p>",
        "id": 193777579,
        "sender_full_name": "marmeladema",
        "timestamp": 1586788414
    },
    {
        "content": "<p>I think we changed something about which Python we support</p>",
        "id": 193777638,
        "sender_full_name": "eddyb",
        "timestamp": 1586788443
    },
    {
        "content": "<p>Whats funny is that i started to remove DUMMY_HIR_ID because of those failing test. I assumed my code for LocalDefId was responsible about those failures lol</p>",
        "id": 193777670,
        "sender_full_name": "marmeladema",
        "timestamp": 1586788451
    },
    {
        "content": "<p>oh right! I saw that!</p>",
        "id": 193777732,
        "sender_full_name": "marmeladema",
        "timestamp": 1586788489
    },
    {
        "content": "<p>You are right, if i force running the tests using python3 it works fine</p>",
        "id": 193777760,
        "sender_full_name": "marmeladema",
        "timestamp": 1586788503
    },
    {
        "content": "<p>silly me</p>",
        "id": 193777766,
        "sender_full_name": "marmeladema",
        "timestamp": 1586788505
    },
    {
        "content": "<p>haha</p>",
        "id": 193777852,
        "sender_full_name": "eddyb",
        "timestamp": 1586788561
    },
    {
        "content": "<p>is there some kind of python venv to remove?</p>",
        "id": 193777898,
        "sender_full_name": "marmeladema",
        "timestamp": 1586788567
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281572\">marmeladema</span> <a href=\"#narrow/stream/131828-t-compiler/topic/Removing.20DUMMY_HIR_ID/near/193777670\" title=\"#narrow/stream/131828-t-compiler/topic/Removing.20DUMMY_HIR_ID/near/193777670\">said</a>:</p>\n<blockquote>\n<p>Whats funny is that i started to remove DUMMY_HIR_ID because of those failing test. I assumed my code for LocalDefId was responsible about those failures lol</p>\n</blockquote>\n<p>oh I thought it was ICE-ing!</p>",
        "id": 193777918,
        "sender_full_name": "eddyb",
        "timestamp": 1586788584
    },
    {
        "content": "<p>No, just tests failing in rustdoc ... But anyway, removing DUMMY_HIR_ID is a good thing no?</p>",
        "id": 193778059,
        "sender_full_name": "marmeladema",
        "timestamp": 1586788673
    },
    {
        "content": "<p>yeah</p>",
        "id": 193778073,
        "sender_full_name": "eddyb",
        "timestamp": 1586788680
    },
    {
        "content": "<p>just unfortunate about the test failure reason confusion</p>",
        "id": 193778133,
        "sender_full_name": "eddyb",
        "timestamp": 1586788697
    },
    {
        "content": "<p>I'll do a separate PR for the change in ast_lowering+hir just in case it impacts performance</p>",
        "id": 193778264,
        "sender_full_name": "marmeladema",
        "timestamp": 1586788797
    },
    {
        "content": "<p>So ... I changed the <code>node_id_to_hir_id</code> to a vec of <code>Option&lt;HirId&gt;</code> and unwrap-ing in <code>local_def_id_to_hir_id</code>leads to the following <a href=\"https://paste.ee/p/py82b\" title=\"https://paste.ee/p/py82b\">https://paste.ee/p/py82b</a></p>",
        "id": 193787812,
        "sender_full_name": "marmeladema",
        "timestamp": 1586794081
    },
    {
        "content": "<p>It means that some DUMMY_HIR_ID are leaked somehow</p>",
        "id": 193787879,
        "sender_full_name": "marmeladema",
        "timestamp": 1586794097
    },
    {
        "content": "<p>Well actually i think its <code>self.def_id_to_node_id[id]</code> that returns a node_id that does not have a corresponding hir id</p>",
        "id": 193788112,
        "sender_full_name": "marmeladema",
        "timestamp": 1586794228
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> no, that's perfect!</p>",
        "id": 193788605,
        "sender_full_name": "eddyb",
        "timestamp": 1586794489
    },
    {
        "content": "<p>we want <em>only</em> save-analysis to fail, if anything fails</p>",
        "id": 193788626,
        "sender_full_name": "eddyb",
        "timestamp": 1586794503
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> because it does this weird thing where it looks things up by <code>NodeId</code>s</p>",
        "id": 193788679,
        "sender_full_name": "eddyb",
        "timestamp": 1586794533
    },
    {
        "content": "<p>Here are the 4 tests that fail:</p>\n<div class=\"codehilite\"><pre><span></span>failures:\n    [ui] ui/generator/async-generator-issue-67158.rs\n    [ui] ui/save-analysis/issue-68621.rs\n    [ui] ui/type-alias-impl-trait/issue-63279.rs\n    [ui] ui/type-alias-impl-trait/issue-65679-inst-opaque-ty-from-val-twice.rs\n</pre></div>",
        "id": 193788737,
        "sender_full_name": "marmeladema",
        "timestamp": 1586794558
    },
    {
        "content": "<p>its not only save-analysis unfortunately</p>",
        "id": 193788837,
        "sender_full_name": "marmeladema",
        "timestamp": 1586794586
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span>#0 [has_typeck_tables] processing `&lt;Struct as Service&gt;::Future::{{opaque}}#0`\n</pre></div>",
        "id": 193789203,
        "sender_full_name": "eddyb",
        "timestamp": 1586794778
    },
    {
        "content": "<p>heh <a href=\"https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/mod.rs#L842\" title=\"https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/mod.rs#L842\">https://github.com/rust-lang/rust/blob/master/src/librustc_typeck/check/mod.rs#L842</a></p>",
        "id": 193789337,
        "sender_full_name": "eddyb",
        "timestamp": 1586794845
    },
    {
        "content": "<p>For <code>ui/type-alias-impl-trait/issue-63279.rs</code>I get</p>\n<div class=\"codehilite\"><pre><span></span>#0 [has_typeck_tables] processing `Closure::{{opaque}}#0`\n</pre></div>",
        "id": 193789356,
        "sender_full_name": "marmeladema",
        "timestamp": 1586794864
    },
    {
        "content": "<p>okay this is suspicious</p>",
        "id": 193789377,
        "sender_full_name": "eddyb",
        "timestamp": 1586794882
    },
    {
        "content": "<p>anyway, you can add a variant of <code>as_local_hir_id</code> that has an <code>opt_</code> prefix or <code>_opt</code> suffix</p>",
        "id": 193789505,
        "sender_full_name": "eddyb",
        "timestamp": 1586794945
    },
    {
        "content": "<p>that returns <code>Option</code></p>",
        "id": 193789511,
        "sender_full_name": "eddyb",
        "timestamp": 1586794949
    },
    {
        "content": "<p>and only a few places use</p>",
        "id": 193789520,
        "sender_full_name": "eddyb",
        "timestamp": 1586794957
    },
    {
        "content": "<p>I can but from what i understand such function would return None, if the def_id is not a local one. Not if the def_id as no hir_id associated</p>",
        "id": 193789560,
        "sender_full_name": "marmeladema",
        "timestamp": 1586794992
    },
    {
        "content": "<p>hmm</p>",
        "id": 193789582,
        "sender_full_name": "eddyb",
        "timestamp": 1586795013
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> okay we can manufacture a <code>HirId</code> :P</p>",
        "id": 193789661,
        "sender_full_name": "eddyb",
        "timestamp": 1586795056
    },
    {
        "content": "<p>and hopefully nothing breaks</p>",
        "id": 193789666,
        "sender_full_name": "eddyb",
        "timestamp": 1586795062
    },
    {
        "content": "<p>lol okay^^</p>",
        "id": 193789729,
        "sender_full_name": "marmeladema",
        "timestamp": 1586795112
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><span class=\"n\">HirId</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">owner</span>: <span class=\"nc\">def_id</span><span class=\"p\">,</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">local_id</span>: <span class=\"nc\">ItemLocalId</span>::<span class=\"n\">from_u32</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">),</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</pre></div>",
        "id": 193789755,
        "sender_full_name": "eddyb",
        "timestamp": 1586795130
    },
    {
        "content": "<p>I just dont want to be responsible for hiding an underlying bug somewhere^^</p>",
        "id": 193789758,
        "sender_full_name": "marmeladema",
        "timestamp": 1586795131
    },
    {
        "content": "<p>eventually all <code>LocalDefId</code> -&gt; <code>HirId</code> conversions will be just this</p>",
        "id": 193789867,
        "sender_full_name": "eddyb",
        "timestamp": 1586795176
    },
    {
        "content": "<p>I even have a branch somewhere that does this for everything except closures because those are a bit of a pain</p>",
        "id": 193789885,
        "sender_full_name": "eddyb",
        "timestamp": 1586795190
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> we can open an issue about a <code>LocalDefId</code> existing that doesn't have any <code>HirId</code></p>",
        "id": 193790057,
        "sender_full_name": "eddyb",
        "timestamp": 1586795310
    },
    {
        "content": "<p>and mention it in a comment on the hack</p>",
        "id": 193790072,
        "sender_full_name": "eddyb",
        "timestamp": 1586795320
    },
    {
        "content": "<p>Ok, i am fine with that</p>",
        "id": 193790093,
        "sender_full_name": "marmeladema",
        "timestamp": 1586795334
    },
    {
        "content": "<p>Are you already creating the issue or shall I do it?</p>",
        "id": 193790453,
        "sender_full_name": "marmeladema",
        "timestamp": 1586795531
    },
    {
        "content": "<p>you can do it if you want</p>",
        "id": 193790773,
        "sender_full_name": "eddyb",
        "timestamp": 1586795680
    },
    {
        "content": "<p>Ok I'll try then :)</p>",
        "id": 193790870,
        "sender_full_name": "marmeladema",
        "timestamp": 1586795748
    },
    {
        "content": "<p>About <a href=\"https://github.com/rust-lang/rust/pull/71092\" title=\"https://github.com/rust-lang/rust/pull/71092\">https://github.com/rust-lang/rust/pull/71092</a>, is this good to go?</p>",
        "id": 193791043,
        "sender_full_name": "marmeladema",
        "timestamp": 1586795820
    },
    {
        "content": "<p>oh yeah okay just r+'d it</p>",
        "id": 193791078,
        "sender_full_name": "eddyb",
        "timestamp": 1586795849
    },
    {
        "content": "<p>Cool thanks!</p>",
        "id": 193791208,
        "sender_full_name": "marmeladema",
        "timestamp": 1586795908
    },
    {
        "content": "<p>I've removed DUMMY_HIR_ID locally entirely, lets see how many things break :D</p>",
        "id": 193794179,
        "sender_full_name": "marmeladema",
        "timestamp": 1586797645
    },
    {
        "content": "<p>Hum only one failure for:</p>\n<div class=\"codehilite\"><pre><span></span>failures:\n    [ui] ui/generator/async-generator-issue-67158.rs\n</pre></div>",
        "id": 193800445,
        "sender_full_name": "marmeladema",
        "timestamp": 1586800739
    },
    {
        "content": "<p>But it was already broken with the change to the node_id_to_hir_id</p>",
        "id": 193800489,
        "sender_full_name": "marmeladema",
        "timestamp": 1586800760
    },
    {
        "content": "<p><a href=\"https://paste.ee/p/0cGzW\" title=\"https://paste.ee/p/0cGzW\">https://paste.ee/p/0cGzW</a></p>",
        "id": 193800563,
        "sender_full_name": "marmeladema",
        "timestamp": 1586800798
    },
    {
        "content": "<p>Its failing here: <a href=\"https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/context.rs#L1129\" title=\"https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/context.rs#L1129\">https://github.com/rust-lang/rust/blob/master/src/librustc_middle/ty/context.rs#L1129</a></p>",
        "id": 193800860,
        "sender_full_name": "marmeladema",
        "timestamp": 1586800923
    },
    {
        "content": "<p>Some node_id don't have a corresponding hir_id</p>",
        "id": 193800943,
        "sender_full_name": "marmeladema",
        "timestamp": 1586800975
    },
    {
        "content": "<p>Maybe the <code>trait_map</code> is wrong/corrupted somehow?</p>",
        "id": 193801348,
        "sender_full_name": "marmeladema",
        "timestamp": 1586801199
    },
    {
        "content": "<p>huh that's really suspicious</p>",
        "id": 193801965,
        "sender_full_name": "eddyb",
        "timestamp": 1586801512
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> I think you can just ignore <code>NodeId</code>s w/o a <code>HirId</code></p>",
        "id": 193802091,
        "sender_full_name": "eddyb",
        "timestamp": 1586801570
    },
    {
        "content": "<p>that just means they weren't lowered</p>",
        "id": 193802096,
        "sender_full_name": "eddyb",
        "timestamp": 1586801574
    },
    {
        "content": "<p>it's possibly a bug, but it didn't do anything before anyway</p>",
        "id": 193802146,
        "sender_full_name": "eddyb",
        "timestamp": 1586801605
    },
    {
        "content": "<p>Ok</p>",
        "id": 193802181,
        "sender_full_name": "marmeladema",
        "timestamp": 1586801620
    },
    {
        "content": "<p>By the way, I just added one last commit in <a href=\"https://github.com/rust-lang/rust/pull/71092\" title=\"https://github.com/rust-lang/rust/pull/71092\">https://github.com/rust-lang/rust/pull/71092</a></p>",
        "id": 193802342,
        "sender_full_name": "marmeladema",
        "timestamp": 1586801712
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> do you need to approve again in this case? I don't know if how bors work in this case</p>",
        "id": 193802550,
        "sender_full_name": "marmeladema",
        "timestamp": 1586801841
    },
    {
        "content": "<p>yupp, thanks for the ping</p>",
        "id": 193802934,
        "sender_full_name": "eddyb",
        "timestamp": 1586802031
    },
    {
        "content": "<p>Do i have to wait for stage2 to be built to run some tests? It really takes a long time on my laptop.</p>",
        "id": 193804688,
        "sender_full_name": "marmeladema",
        "timestamp": 1586803079
    },
    {
        "content": "<p>oh drat I should've asked</p>",
        "id": 193804774,
        "sender_full_name": "eddyb",
        "timestamp": 1586803103
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> <code>./x.py test --stage 1 src/test/ui</code></p>",
        "id": 193804790,
        "sender_full_name": "eddyb",
        "timestamp": 1586803116
    },
    {
        "content": "<p>this should cover most of the testing</p>",
        "id": 193804806,
        "sender_full_name": "eddyb",
        "timestamp": 1586803126
    },
    {
        "content": "<p>and set <code>incremental = true</code> in <code>config.toml</code></p>",
        "id": 193804830,
        "sender_full_name": "eddyb",
        "timestamp": 1586803145
    },
    {
        "content": "<p>hu ok lets try that</p>",
        "id": 193805016,
        "sender_full_name": "marmeladema",
        "timestamp": 1586803267
    },
    {
        "content": "<p>GHA tests passed</p>",
        "id": 193807433,
        "sender_full_name": "marmeladema",
        "timestamp": 1586804390
    },
    {
        "content": "<p>Thank you so much for the advise for --stage 1 and incremental, its way faster</p>",
        "id": 193825136,
        "sender_full_name": "marmeladema",
        "timestamp": 1586814126
    },
    {
        "content": "<p>And I have a branch passing all tests without <code>DUMMY_HIR_ID</code></p>",
        "id": 193825166,
        "sender_full_name": "marmeladema",
        "timestamp": 1586814154
    },
    {
        "content": "<p>nice :D</p>",
        "id": 193825369,
        "sender_full_name": "eddyb",
        "timestamp": 1586814299
    },
    {
        "content": "<p>there are actually 3 places where either a <code>DefId</code> or a <code>NodeId</code> does not have a corresponding <code>HirId</code>. There must a bug somewhere for sure, but i am unable to find/fix it with my current understanding of the codebase. In the meantime, I created <a href=\"https://github.com/rust-lang/rust/issues/71104\" title=\"https://github.com/rust-lang/rust/issues/71104\">https://github.com/rust-lang/rust/issues/71104</a> and i'll update the tickets once I have opened the PR.</p>",
        "id": 193825592,
        "sender_full_name": "marmeladema",
        "timestamp": 1586814449
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> this is it: <a href=\"https://github.com/rust-lang/rust/pull/71116\" title=\"https://github.com/rust-lang/rust/pull/71116\">https://github.com/rust-lang/rust/pull/71116</a></p>",
        "id": 193866911,
        "sender_full_name": "marmeladema",
        "timestamp": 1586854326
    },
    {
        "content": "<p>I don't know if a perf run is worth it?</p>",
        "id": 193866931,
        "sender_full_name": "marmeladema",
        "timestamp": 1586854335
    },
    {
        "content": "<p>eh let's just do it</p>",
        "id": 193867323,
        "sender_full_name": "eddyb",
        "timestamp": 1586854568
    },
    {
        "content": "<p><span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>",
        "id": 193884233,
        "sender_full_name": "marmeladema",
        "timestamp": 1586864578
    },
    {
        "content": "<p><a href=\"https://perf.rust-lang.org/compare.html?start=513a6473d69b3af34e6cdaa4efb288fe5283c3e9&amp;end=433e90a8704a6c96d2560173ac41b079b0e58442\" title=\"https://perf.rust-lang.org/compare.html?start=513a6473d69b3af34e6cdaa4efb288fe5283c3e9&amp;end=433e90a8704a6c96d2560173ac41b079b0e58442\">https://perf.rust-lang.org/compare.html?start=513a6473d69b3af34e6cdaa4efb288fe5283c3e9&amp;end=433e90a8704a6c96d2560173ac41b079b0e58442</a></p>",
        "id": 193908228,
        "sender_full_name": "marmeladema",
        "timestamp": 1586875541
    },
    {
        "content": "<p>Does not seem very good? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 193908263,
        "sender_full_name": "marmeladema",
        "timestamp": 1586875560
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> actually i don't really know how to read the results and what is acceptable</p>",
        "id": 193910276,
        "sender_full_name": "marmeladema",
        "timestamp": 1586876342
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281572\">@marmeladema</span> there's no change I don't think</p>",
        "id": 193910678,
        "sender_full_name": "eddyb",
        "timestamp": 1586876497
    },
    {
        "content": "<p>the two at the top are just noise</p>",
        "id": 193910769,
        "sender_full_name": "eddyb",
        "timestamp": 1586876523
    },
    {
        "content": "<p>okay the rest have a slight slowdown too, but it's like 0.5%, I think it's acceptable</p>",
        "id": 193910886,
        "sender_full_name": "eddyb",
        "timestamp": 1586876577
    },
    {
        "content": "<p>Cool! And hopefully the perf will be back with the LocalDefId work</p>",
        "id": 193911100,
        "sender_full_name": "marmeladema",
        "timestamp": 1586876646
    },
    {
        "content": "<p>Merged <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 194010231,
        "sender_full_name": "marmeladema",
        "timestamp": 1586946336
    },
    {
        "content": "<p>if you want more issues to work on, feel free to ping me <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 194014885,
        "sender_full_name": "DPC",
        "timestamp": 1586949667
    },
    {
        "content": "<p>I can come back to the first one^^ removing DUMMY_HIR_ID was a side project to better finish the original one</p>",
        "id": 194015683,
        "sender_full_name": "marmeladema",
        "timestamp": 1586950303
    },
    {
        "content": "<p>I polished a bit the description for <a href=\"https://github.com/rust-lang/rust/issues/71104\" title=\"https://github.com/rust-lang/rust/issues/71104\">https://github.com/rust-lang/rust/issues/71104</a> and removed the <code>[DRAFT]</code> tag.</p>",
        "id": 194277533,
        "sender_full_name": "marmeladema",
        "timestamp": 1587029291
    }
]