[
    {
        "content": "<p>It appears that <code>-Zno-link</code>/<code>-Zlink-only</code> are totally broken:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">[</span><span class=\"n\">gulf</span>:<span class=\"o\">~/</span><span class=\"n\">tmp</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"w\"></span>\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"hello world\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"n\">gulf</span>:<span class=\"o\">~/</span><span class=\"n\">tmp</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"cp\">$RUSTC0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Zno</span><span class=\"o\">-</span><span class=\"n\">link</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"n\">gulf</span>:<span class=\"o\">~/</span><span class=\"n\">tmp</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">ls</span><span class=\"w\"></span>\n<span class=\"n\">z</span><span class=\"p\">.</span><span class=\"mi\">43</span><span class=\"n\">k2bohs4u65rnbc</span><span class=\"p\">.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\">  </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"mf\">7e813375</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">1.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\">  </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"mf\">7e813375</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">5.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\"></span>\n<span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">rlink</span><span class=\"w\">                    </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"mf\">7e813375</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">2.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\">  </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"mf\">7e813375</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">6.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\"></span>\n<span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"w\">                       </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"mf\">7e813375</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">3.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\">  </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"mf\">7e813375</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">7.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\"></span>\n<span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"mf\">7e813375</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">0.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\">  </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"mf\">7e813375</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">4.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"w\"></span>\n<span class=\"p\">[</span><span class=\"n\">gulf</span>:<span class=\"o\">~/</span><span class=\"n\">tmp</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"cp\">$RUSTC0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Zlink</span><span class=\"o\">-</span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">z</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"w\"></span>\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">rustc</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">index</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">bounds</span>: <span class=\"nc\">the</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mi\">43</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mi\">112</span><span class=\"o\">'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">njn</span><span class=\"o\">/</span><span class=\"n\">dev</span><span class=\"o\">/</span><span class=\"n\">rust0</span><span class=\"o\">/</span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">rustc_serialize</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">opaque</span><span class=\"p\">.</span><span class=\"n\">rs</span>:<span class=\"mi\">655</span>:<span class=\"mi\">24</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 276548535,
        "sender_full_name": "nnethercote",
        "timestamp": 1648161617
    },
    {
        "content": "<p>The file format was recently changed from JSON to binary, but it was broken before that. With nightly 1.59 I get a different error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span>: <span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">decode</span><span class=\"w\"> </span><span class=\"n\">rlink</span>: <span class=\"nc\">ParseError</span><span class=\"p\">(</span><span class=\"n\">SyntaxError</span><span class=\"p\">(</span><span class=\"n\">InvalidSyntax</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">))</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 276548587,
        "sender_full_name": "nnethercote",
        "timestamp": 1648161679
    },
    {
        "content": "<p>I couldn't find any open issues on this</p>",
        "id": 276548595,
        "sender_full_name": "nnethercote",
        "timestamp": 1648161684
    },
    {
        "content": "<p>I'm not exactly sure what's the process people used to test this; I only could get these 2 errors as well, going back to around the time they were introduced. there may some combination of flags required to make it work (like additional emit values, or -Zcombine-cgus, etc), but a deserialization issue is unexpected</p>",
        "id": 276589172,
        "sender_full_name": "lqd",
        "timestamp": 1648197684
    },
    {
        "content": "<p>It should work by using the linker invocation the same as the compile invocation except replacing the source file with the .rlink file and -Zno-link with -Zlink-only. This is exactly what <span class=\"user-mention silent\" data-user-id=\"120989\">nnethercote</span> did.</p>",
        "id": 276589556,
        "sender_full_name": "bjorn3",
        "timestamp": 1648197943
    },
    {
        "content": "<p>that was our expectation, but alas</p>",
        "id": 276590786,
        "sender_full_name": "lqd",
        "timestamp": 1648198516
    },
    {
        "content": "<p>For me the following works just fine:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">vV</span><span class=\"w\"></span>\n<span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"mf\">1.61.0</span><span class=\"o\">-</span><span class=\"n\">nightly</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"n\">c17c84a3</span><span class=\"w\"> </span><span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">21</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"n\">binary</span>: <span class=\"nc\">rustc</span><span class=\"w\"></span>\n<span class=\"n\">commit</span><span class=\"o\">-</span><span class=\"n\">hash</span>: <span class=\"mi\">3</span><span class=\"n\">c17c84a386e7badf6b2c6018d172496b3a28a04</span><span class=\"w\"></span>\n<span class=\"n\">commit</span><span class=\"o\">-</span><span class=\"n\">date</span>: <span class=\"mi\">2022</span><span class=\"o\">-</span><span class=\"mi\">03</span><span class=\"o\">-</span><span class=\"mi\">21</span><span class=\"w\"></span>\n<span class=\"n\">host</span>: <span class=\"nc\">x86_64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"w\"></span>\n<span class=\"n\">release</span>: <span class=\"mf\">1.61.0</span><span class=\"o\">-</span><span class=\"n\">nightly</span><span class=\"w\"></span>\n<span class=\"n\">LLVM</span><span class=\"w\"> </span><span class=\"n\">version</span>: <span class=\"mf\">14.0.0</span><span class=\"w\"></span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">fn</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Zno</span><span class=\"o\">-</span><span class=\"n\">link</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"></span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">rustc</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Zlink</span><span class=\"o\">-</span><span class=\"n\">only</span><span class=\"w\"> </span><span class=\"n\">rust_out</span><span class=\"p\">.</span><span class=\"n\">rlink</span><span class=\"w\"></span>\n<span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">rust_out</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 276591194,
        "sender_full_name": "bjorn3",
        "timestamp": 1648198810
    },
    {
        "content": "<p>ok that also did work and it's not what we did before, we were just changing the flag, while you also need to refer to the rlink. I see what you mean now, thanks a bunch!</p>",
        "id": 276591607,
        "sender_full_name": "lqd",
        "timestamp": 1648199092
    },
    {
        "content": "<p>Right, missed that <span class=\"user-mention silent\" data-user-id=\"120989\">nnethercote</span>  kept referring to the source file.</p>",
        "id": 276591800,
        "sender_full_name": "bjorn3",
        "timestamp": 1648199235
    },
    {
        "content": "<p>Rlink files should probably get a header indicating that they are rlink files and mentioning the rustc version.</p>",
        "id": 276591838,
        "sender_full_name": "bjorn3",
        "timestamp": 1648199260
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/issues/95297\">https://github.com/rust-lang/rust/issues/95297</a></p>",
        "id": 276592127,
        "sender_full_name": "bjorn3",
        "timestamp": 1648199428
    },
    {
        "content": "<p>Oh, you have to name the rlink file, not the source file. That wasn't clear to me</p>",
        "id": 276594676,
        "sender_full_name": "nnethercote",
        "timestamp": 1648201028
    },
    {
        "content": "<p>Thanks</p>",
        "id": 276594697,
        "sender_full_name": "nnethercote",
        "timestamp": 1648201045
    }
]