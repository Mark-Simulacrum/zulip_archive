[
    {
        "content": "<p>Hi, I saw that a new deprecated_safe attribute may end up being used for the env unsoundness issues here: <a href=\"https://github.com/rust-lang/rust/pull/92365#issuecomment-1057456247\">https://github.com/rust-lang/rust/pull/92365#issuecomment-1057456247</a> , and then asked if I could work on it: <a href=\"https://github.com/rust-lang/rust/pull/92365#issuecomment-1058726600\">https://github.com/rust-lang/rust/pull/92365#issuecomment-1058726600</a></p>\n<p>I got a basic dev environment setup last night, and now I have some questions about next steps. (A special thank you to whoever included this in the dev guide: \"Please ask questions! A lot of people report feeling that they are \"wasting expert time\", but nobody on t-compiler feels this way. Contributors are important to us.\")</p>\n<p>I've started exploring the code around the unsafety checking, but I also have a lot of procedural questions. Like if this would need an RFC (I suspect not), but there are still questions that need to be tracked like whether this would be just a rustc attribute, or if it would be available outside of rustc, etc. etc.</p>",
        "id": 274251697,
        "sender_full_name": "skippy",
        "timestamp": 1646497258
    },
    {
        "content": "<p>Just for some background, this will be my first time contributing to open source, or working on a compiler, or even working on Rust. I have been following Rust quite closely for several years though.</p>",
        "id": 274251783,
        "sender_full_name": "skippy",
        "timestamp": 1646497397
    },
    {
        "content": "<p>Welcome! Whether or not this would require an RFC would be up for the libs team to decide: <a class=\"stream\" data-stream-id=\"219381\" href=\"/#narrow/stream/219381-t-libs\">#t-libs</a>. On the one hand this is a fairly minor change, but on the other hand it's something without precedent, so it's worth asking. In particular you can make things easier by keeping the discussion focused on the ability to deprecate only the ability to call <code>env::set_var</code> in safe code. The actual attribute itself would be an unstable implementation detail, probably called <code>rustc_deprecated_safe</code> (the <code>rustc_</code> on the front indicates a rustc implementation detail).</p>",
        "id": 274252603,
        "sender_full_name": "bstrie",
        "timestamp": 1646498438
    },
    {
        "content": "<p>I'm not completely familiar with the code in question but I have done some work on the deprecation machinery before and my first impression is that this doesn't sound <em>too</em> difficult to implement, but if this is your first time contributing to Rust, or a compiler, or to open source, then you may want to tackle one or two smaller issues just to get familiar with the process. There's a tag for \"easy\" issues on the issue tracker: <a href=\"https://github.com/rust-lang/rust/labels/E-easy\">https://github.com/rust-lang/rust/labels/E-easy</a> , and in particular if you were to try one of the ones that only deal with adjusting documentation then that would let you get acquainted with the contribution process without asking you to learn too much at once.</p>",
        "id": 274252928,
        "sender_full_name": "bstrie",
        "timestamp": 1646498850
    },
    {
        "content": "<p>(Also, any of the ones labeled with \"E-mentor\" indicate that someone might be willing to mentor anyone who wants to work on those issues.)</p>",
        "id": 274253009,
        "sender_full_name": "bstrie",
        "timestamp": 1646498945
    },
    {
        "content": "<p>Thanks! The main reason I chose this issue is because I suggested something like this a few months back on IRLO: <a href=\"https://internals.rust-lang.org/t/synchronized-ffi-access-to-posix-environment-variable-functions/15475/56\">https://internals.rust-lang.org/t/synchronized-ffi-access-to-posix-environment-variable-functions/15475/56</a> It's the perfect motivation for me to finally contribute to rustc. <span aria-label=\"blush\" class=\"emoji emoji-1f60a\" role=\"img\" title=\"blush\">:blush:</span></p>\n<p>I am fairly confident this is something I can implement, especially if it's just a rustc_ attribute which would cut out a lot of questions.</p>",
        "id": 274253257,
        "sender_full_name": "skippy",
        "timestamp": 1646499271
    },
    {
        "content": "<p>I'm just starting to dig into things, but in particular this comment on the UnsafeFn variant stood out to me:</p>\n<p>pub enum UnsafetyViolationKind {<br>\n    /// Unsafe operation outside <code>unsafe</code>.<br>\n    General,<br>\n    /// Unsafe operation in an <code>unsafe fn</code> but outside an <code>unsafe</code> block.<br>\n    /// Has to be handled as a lint for backwards compatibility.<br>\n    UnsafeFn,<br>\n}</p>\n<p>It seems like this is a very similar backwards compatibility situation so I'm wondering if a new variant here would make sense, and then I can use the UnsafeFn variant as an example to build off of.</p>",
        "id": 274253542,
        "sender_full_name": "skippy",
        "timestamp": 1646499586
    },
    {
        "content": "<p>And should I move this topic over to t-libs? I wasn't sure where a new attribute would fall.</p>",
        "id": 274253708,
        "sender_full_name": "skippy",
        "timestamp": 1646499661
    },
    {
        "content": "<p>Just be aware that there are <strong>two</strong> unsafety checker in <code>rustc</code>, one that operate on <code>thir</code>(the new one) and one that operate on <code>mir</code> (the old one, still the default).</p>",
        "id": 274253932,
        "sender_full_name": "Urgau",
        "timestamp": 1646499895
    },
    {
        "content": "<p>I did notice that when I was exploring, would the implementation need go to in both places? I'm not sure if both are simultaneously operational.</p>",
        "id": 274254052,
        "sender_full_name": "skippy",
        "timestamp": 1646500010
    },
    {
        "content": "<p>They are not used at the same time. Currently the mir one is the only one used by default. We want to migrate to the thir one in the future, so they should be kept in sync.</p>",
        "id": 274254148,
        "sender_full_name": "bjorn3",
        "timestamp": 1646500099
    },
    {
        "content": "<p>Do you happen to know the flag to run with the new thir checker? That was actually the first place I tried modifying (just error strings to see a changed output).</p>",
        "id": 274254455,
        "sender_full_name": "skippy",
        "timestamp": 1646500464
    },
    {
        "content": "<p><code>-Zthir-unsafeck=yes</code></p>",
        "id": 274254482,
        "sender_full_name": "bjorn3",
        "timestamp": 1646500507
    },
    {
        "content": "<p>Is that something I should be able to use with stage1? I did <code>cargo +stage1 -Zthir-unsafeck=yes build</code> and got <code>error: the `-Z` flag is only accepted on the nightly channel of Cargo, but this is the `stable` channel</code>.</p>\n<p>I did a horrible <code>export RUSTC_BOOTSTRAP=1</code> and then got <code>error: unknown `-Z` flag specified: thir-unsafeck</code> instead.</p>\n<p>This is on a dummy project where I call an unsafe fn from a safe fn to test things out.</p>",
        "id": 274254651,
        "sender_full_name": "skippy",
        "timestamp": 1646500714
    },
    {
        "content": "<p>It's a <code>rustc</code> flag not a <code>cargo</code> one, you should put it in <code>RUSTFLAGS</code> like this <code>RUSTFLAGS='-Zthir-unsafeck=yes' cargo +stage1 build</code>.</p>",
        "id": 274254810,
        "sender_full_name": "Urgau",
        "timestamp": 1646500922
    },
    {
        "content": "<p>awesome!!! thank you, i can get errors from both versions of the unsafety checker now</p>",
        "id": 274254926,
        "sender_full_name": "skippy",
        "timestamp": 1646501068
    },
    {
        "content": "<p>I would also highly recommend to directly use <code>rustc</code> with a test file: <code>rustc +stage1 -Zthir-unsafeck=yes a.rs</code>.<br>\nThis will simplify the debugging and also improve the quality of your development process by not having cargo in the way.</p>",
        "id": 274254929,
        "sender_full_name": "Urgau",
        "timestamp": 1646501078
    },
    {
        "content": "<p>nice, thanks for the additional tip</p>",
        "id": 274254937,
        "sender_full_name": "skippy",
        "timestamp": 1646501102
    },
    {
        "content": "<p>yeah, that is way more convenient :)</p>",
        "id": 274254974,
        "sender_full_name": "skippy",
        "timestamp": 1646501159
    },
    {
        "content": "<p>i figured out how to add a new rustc attribute and created a new set_var2 unsafe fn using it for testing, i'll see about getting both unsafety checkers to spit out a warning on using it now:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"sd\">///</span>\n<span class=\"cp\">#[cfg(not(bootstrap))]</span><span class=\"w\"></span>\n<span class=\"cp\">#[stable(feature = </span><span class=\"s\">\"env\"</span><span class=\"cp\">, since = </span><span class=\"s\">\"1.0.0\"</span><span class=\"cp\">)]</span><span class=\"w\"></span>\n<span class=\"cp\">#[rustc_deprecated_safe(since = </span><span class=\"s\">\"1.99.0\"</span><span class=\"cp\">, reason = </span><span class=\"s\">\"bla\"</span><span class=\"cp\">)]</span><span class=\"w\"></span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">set_var2</span><span class=\"o\">&lt;</span><span class=\"n\">K</span>: <span class=\"nb\">AsRef</span><span class=\"o\">&lt;</span><span class=\"n\">OsStr</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">V</span>: <span class=\"nb\">AsRef</span><span class=\"o\">&lt;</span><span class=\"n\">OsStr</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"n\">key</span>: <span class=\"nc\">K</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span>: <span class=\"nc\">V</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">_set_var</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">.</span><span class=\"n\">as_ref</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">.</span><span class=\"n\">as_ref</span><span class=\"p\">())</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 274260098,
        "sender_full_name": "skippy",
        "timestamp": 1646507725
    },
    {
        "content": "<p>The new one was already brought up, but I'll add a mention to <a class=\"stream\" data-stream-id=\"278509\" href=\"/#narrow/stream/278509-project-thir-unsafeck\">#project-thir-unsafeck</a> in case you haven't seen it.  (The question is completely fine here; no need to move it.  It's just easy to miss streams so wanted to share.)</p>",
        "id": 274264152,
        "sender_full_name": "scottmcm",
        "timestamp": 1646513102
    },
    {
        "content": "<p>Thanks! I'm working on understanding the old one currently, as least the part dealing with calls to unsafe functions. I'll take a look at the new THIR one next.</p>\n<p>I'm also just focusing on calls to unsafe functions first. I know there'll be other places that need handling like function pointers, but I'm not sure what the full list would be.</p>\n<p>Btw, I asked if t-libs would be a more appropriate channel earlier, but I think t-compiler is probably correct? The only libs change would be just slapping the new #[rustc_deprecated_safe] attribute on set_env when it works. (assuming that this solution ends up being used)</p>\n<p>Would it be appropriate for me to open a tracking issue for this new attribute? I don't know if the concept is already being tracked anywhere, and as mentioned it may not end up being what's used.</p>",
        "id": 274264884,
        "sender_full_name": "skippy",
        "timestamp": 1646514107
    },
    {
        "content": "<p>This is on the old unsafety checker (not THIR), and I'm not at all confident in the quality of the change yet, but it's a start!</p>\n<p><a href=\"/user_uploads/4715/NZT1xwkXR-IyQuiGh-4-uhNd/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/NZT1xwkXR-IyQuiGh-4-uhNd/image.png\" title=\"image.png\"><img src=\"/user_uploads/4715/NZT1xwkXR-IyQuiGh-4-uhNd/image.png\"></a></div>",
        "id": 274269286,
        "sender_full_name": "skippy",
        "timestamp": 1646519549
    },
    {
        "content": "<p>This is enough to get a successful <code>./x.py build</code> with the real <code>set_var</code> (not <code>set_var2</code>) marked as unsafe now too.</p>",
        "id": 274270117,
        "sender_full_name": "skippy",
        "timestamp": 1646520874
    },
    {
        "content": "<p>Given this signature:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">set_var</span><span class=\"o\">&lt;</span><span class=\"n\">K</span>: <span class=\"nb\">AsRef</span><span class=\"o\">&lt;</span><span class=\"n\">OsStr</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">V</span>: <span class=\"nb\">AsRef</span><span class=\"o\">&lt;</span><span class=\"n\">OsStr</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"n\">key</span>: <span class=\"nc\">K</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">value</span>: <span class=\"nc\">V</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>Is it possible to cast this to fn() and Fn()? I'm struggling on how to fill in the _ in these two lines that I want to use for testing:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_</span>: <span class=\"nc\">fn</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_</span>: <span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"nb\">Fn</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">std</span>::<span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">);</span><span class=\"w\"></span>\n</code></pre></div>\n<p>In the meantime I just created a dummy, argumentless set_var3 and have the <code>Box&lt;dyn Fn()&gt;</code> sorta kinda working with #[rustc_deprecated_safe].</p>\n<p>I'm also not sure what the full list of places that would need to be backwards compatible when a function becomes unsafe is. I know about calling the function, and the fn() and Fn() casts, but I don't know what else there might be.</p>",
        "id": 274305247,
        "sender_full_name": "skippy",
        "timestamp": 1646572341
    },
    {
        "content": "<p>You have to specify a specific type in the place of _. For example &amp;OsStr or OsString both implement AsRef&lt;OsStr&gt;.</p>",
        "id": 274305613,
        "sender_full_name": "bjorn3",
        "timestamp": 1646572950
    },
    {
        "content": "<p>That was the first thing I tried, but I got this error:</p>\n<div class=\"codehilite\"><pre><span></span><code>error[E0308]: mismatched types\n  --&gt; /home/skippy/rust_deprecated_safe/src/main.rs:10:33\n   |\n10 |     let _: fn(&amp;OsStr, &amp;OsStr) = std::env::set_var;\n   |                                 ^^^^^^^^^^^^^^^^^ one type is more general than the other\n   |\n   = note: expected fn pointer `for&lt;&#39;r, &#39;s&gt; fn(&amp;&#39;r OsStr, &amp;&#39;s OsStr)`\n              found fn pointer `fn(&amp;OsStr, &amp;OsStr)`\n</code></pre></div>\n<p>Everything I tried to do after that kept making the errors worse. :)</p>",
        "id": 274305727,
        "sender_full_name": "skippy",
        "timestamp": 1646573133
    },
    {
        "content": "<p>Oh, nevermind, you mentioned OsString also and that does work! Thanks. :)</p>",
        "id": 274305798,
        "sender_full_name": "skippy",
        "timestamp": 1646573253
    },
    {
        "content": "<p>I was able to get something very basic (and hokey) working to cast an unsafe fn() to a safe fn() when annotated with #[rustc_deprecated_safe], although it doesn't lint at all currently.</p>",
        "id": 274321003,
        "sender_full_name": "skippy",
        "timestamp": 1646591640
    },
    {
        "content": "<p>There should only be 3 warnings emitted here, not 4, but here's where I'm currently at:</p>\n<p><a href=\"/user_uploads/4715/nrT50BYaV1CEXPfgHug9Lt6C/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/nrT50BYaV1CEXPfgHug9Lt6C/image.png\" title=\"image.png\"><img src=\"/user_uploads/4715/nrT50BYaV1CEXPfgHug9Lt6C/image.png\"></a></div>",
        "id": 274321932,
        "sender_full_name": "skippy",
        "timestamp": 1646592849
    },
    {
        "content": "<p>I have no idea if I'm remotely on the right track with the changes I've been trying, but I pushed them up here: <a href=\"https://github.com/skippy10110/rust/commit/a2c9fc6a22d5783b172692e6dd212541fb7b1740\">https://github.com/skippy10110/rust/commit/a2c9fc6a22d5783b172692e6dd212541fb7b1740</a></p>\n<p>These certainly aren't \"reviewable\" quality, but I wanted to push them in case my computer spontaneously combusts. <span aria-label=\"blush\" class=\"emoji emoji-1f60a\" role=\"img\" title=\"blush\">:blush:</span></p>\n<p>This is what I've been using as a testbed:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">env</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span>::<span class=\"n\">ffi</span>::<span class=\"n\">OsString</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">print_env</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// usage without unsafe should lint</span>\n<span class=\"w\">    </span><span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">(</span><span class=\"s\">\"TEST\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"set_var_safe\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">print_env</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// all of these coercions should lint</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">set_var_fn_ptr</span>: <span class=\"nc\">fn</span><span class=\"p\">(</span><span class=\"n\">OsString</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OsString</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">set_var_fn_impl</span>: <span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"nb\">Fn</span><span class=\"p\">(</span><span class=\"n\">OsString</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OsString</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">set_var_fnmut_impl</span>: <span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"nb\">FnMut</span><span class=\"p\">(</span><span class=\"n\">OsString</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OsString</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">set_var_fnonce_impl</span>: <span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"nb\">FnOnce</span><span class=\"p\">(</span><span class=\"n\">OsString</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OsString</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">set_var_fn_ptr</span><span class=\"p\">(</span><span class=\"s\">\"TEST\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"s\">\"set_var_fn_ptr\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">print_env</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">set_var_fn_impl</span><span class=\"p\">(</span><span class=\"s\">\"TEST\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"s\">\"set_var_fn_impl\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">print_env</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">set_var_fnmut_impl</span><span class=\"p\">(</span><span class=\"s\">\"TEST\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"s\">\"set_var_fnmut_impl\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">print_env</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"n\">set_var_fnonce_impl</span><span class=\"p\">(</span><span class=\"s\">\"TEST\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"s\">\"set_var_fnonce_impl\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">());</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">print_env</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"w\">    </span><span class=\"c1\">// these shouldn't lint, appropriate unsafe usage</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_unsafe_set_var_fn_ptr</span>: <span class=\"nc\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"p\">(</span><span class=\"n\">OsString</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OsString</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">(</span><span class=\"s\">\"TEST\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"set_var_unsafe\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"n\">print_env</span><span class=\"p\">(</span><span class=\"mi\">7</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"k\">fn</span> <span class=\"nf\">print_env</span><span class=\"p\">(</span><span class=\"n\">i</span>: <span class=\"kt\">u32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"{}: {}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">env</span>::<span class=\"n\">var</span><span class=\"p\">(</span><span class=\"s\">\"TEST\"</span><span class=\"p\">).</span><span class=\"n\">unwrap_or</span><span class=\"p\">(</span><span class=\"s\">\"missing\"</span><span class=\"p\">.</span><span class=\"n\">to_string</span><span class=\"p\">()));</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 274329088,
        "sender_full_name": "skippy",
        "timestamp": 1646602038
    },
    {
        "content": "<p>Example output also:</p>\n<p><a href=\"/user_uploads/4715/uzt2heo8ne6jhxjYgT5UjoNr/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/4715/uzt2heo8ne6jhxjYgT5UjoNr/image.png\" title=\"image.png\"><img src=\"/user_uploads/4715/uzt2heo8ne6jhxjYgT5UjoNr/image.png\"></a></div>",
        "id": 274329815,
        "sender_full_name": "skippy",
        "timestamp": 1646602993
    },
    {
        "content": "<p>Left a couple of comments on that commit.</p>",
        "id": 274330973,
        "sender_full_name": "bjorn3",
        "timestamp": 1646604485
    },
    {
        "content": "<p>Thanks so much!</p>",
        "id": 274331111,
        "sender_full_name": "skippy",
        "timestamp": 1646604675
    },
    {
        "content": "<p>I found at least one example that my currently committed code fails to lint for:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">fn_taking_fn_impl</span><span class=\"p\">(</span><span class=\"n\">_x</span>: <span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"nb\">Fn</span><span class=\"p\">(</span><span class=\"n\">OsString</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OsString</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"n\">fn_taking_fn_impl</span><span class=\"p\">(</span><span class=\"nb\">Box</span>::<span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">));</span><span class=\"w\"></span>\n</code></pre></div>\n<p>(same with FnMut and FnOnce)</p>\n<p>This does properly lint at least:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span> <span class=\"nf\">fn_taking_fn_ptr</span><span class=\"p\">(</span><span class=\"n\">_x</span>: <span class=\"nc\">fn</span><span class=\"p\">(</span><span class=\"n\">OsString</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OsString</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"></span>\n<span class=\"n\">fn_taking_fn_ptr</span><span class=\"p\">(</span><span class=\"n\">env</span>::<span class=\"n\">set_var</span><span class=\"p\">);</span><span class=\"w\"></span>\n</code></pre></div>",
        "id": 274338578,
        "sender_full_name": "skippy",
        "timestamp": 1646614675
    },
    {
        "content": "<p>Oh, my code does actually lint for that, but only for the very first line that does <code>Box::new(env::set_var)</code>, not subsequent lines. I was already pretty suspicious that I was linting from a really weird place by linting in <code>candidate_assembly.rs</code>. :)</p>",
        "id": 274339152,
        "sender_full_name": "skippy",
        "timestamp": 1646615340
    },
    {
        "content": "<p>I was able to fix the lint not firing on subsequent usages of <code>Box::new(env::set_var)</code>, the candidate was being cached. I guess it's also fine to lint from <code>candidate_assembly.rs</code> since there is already pre-existing code doing so.</p>",
        "id": 274437259,
        "sender_full_name": "skippy",
        "timestamp": 1646678046
    },
    {
        "content": "<p>I'm not sure what my next step for #[rustc_deprecated_safe] should be, the approach I've taken to implement this may be all wrong for all I know, so I don't want to get the code all done up \"properly\" just yet.</p>",
        "id": 274437364,
        "sender_full_name": "skippy",
        "timestamp": 1646678102
    },
    {
        "content": "<p>Hi, is there a way for me to run my changes by someone to see if I'm on the right track? I'm not sure what the appropriate process is. The code isn't really review ready yet as I want to validate the approach I'm taking first.</p>\n<p>The changes to support <code>Box::new(env::set_var)</code> specifically are the ones I'm least confident/have the most questions about.</p>",
        "id": 274612511,
        "sender_full_name": "skippy",
        "timestamp": 1646776213
    },
    {
        "content": "<p>Do you have a sketch of the design? Not exactly an RFC, but, what the attribute is and how it works?</p>",
        "id": 274614175,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1646777024
    },
    {
        "content": "<p>If you haven't already, a lang MCP seems like it might be the right approach for that?</p>",
        "id": 274614200,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1646777038
    },
    {
        "content": "<p>Thanks! I wondered if an MCP might be right thing to do here. Would it be appropriate for me to write up a sketch of the design on the MCP itself?</p>",
        "id": 274614544,
        "sender_full_name": "skippy",
        "timestamp": 1646777198
    },
    {
        "content": "<p>Oh, I think you were saying exactly that in your reply, put the design in the MCP. :) I'll get started!!</p>",
        "id": 274614778,
        "sender_full_name": "skippy",
        "timestamp": 1646777322
    },
    {
        "content": "<p>I have another noobie process question. <span aria-label=\"blush\" class=\"emoji emoji-1f60a\" role=\"img\" title=\"blush\">:blush:</span> When are new MCPs usually looked at? I only ask because I've been making edits to the proposal as I think of them.</p>",
        "id": 274769661,
        "sender_full_name": "skippy",
        "timestamp": 1646869686
    },
    {
        "content": "<p>Typically in the relevant team's weekly meeting.</p>",
        "id": 274773955,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1646872397
    },
    {
        "content": "<p>In terms of process, I'm not sure if this should be compiler or lang.</p>",
        "id": 274773982,
        "sender_full_name": "Josh Triplett",
        "timestamp": 1646872425
    },
    {
        "content": "<p>Oh, is that something I should be marking/tagging appropriately on the MCP somehow?</p>",
        "id": 274774240,
        "sender_full_name": "skippy",
        "timestamp": 1646872633
    },
    {
        "content": "<p>Different repositories, either on lang-team or compiler-team. I think in this case it's probably a lang proposal more so than compiler.</p>",
        "id": 274777851,
        "sender_full_name": "simulacrum",
        "timestamp": 1646875175
    },
    {
        "content": "<p>Ahh, my bad. I just clicked on the \"major change template\" link here: <a href=\"https://forge.rust-lang.org/compiler/mcp.html#major-change-proposals-1\">https://forge.rust-lang.org/compiler/mcp.html#major-change-proposals-1</a> and filed away.</p>\n<p>It sounds like I should close &amp; refile my issue here: <a href=\"https://github.com/rust-lang/lang-team\">https://github.com/rust-lang/lang-team</a> ?</p>",
        "id": 274779049,
        "sender_full_name": "skippy",
        "timestamp": 1646876236
    },
    {
        "content": "<p>I don't see MCP as an issue option here either: <a href=\"https://github.com/rust-lang/compiler-team/issues/new/choose\">https://github.com/rust-lang/compiler-team/issues/new/choose</a> ,  vs. <a href=\"https://github.com/rust-lang/compiler-team/issues/new/choose\">https://github.com/rust-lang/compiler-team/issues/new/choose</a></p>\n<p>If I refile my issue under lang-team with identical text, will it still get picked up as an MCP on that repo? I just don't want to do it wrong and spam a bunch of incorrect issues in there. :)</p>",
        "id": 274779180,
        "sender_full_name": "skippy",
        "timestamp": 1646876383
    },
    {
        "content": "<p>Looks like initiative proposal is what I want, that template has the \"major-change\" label on it.</p>",
        "id": 274779659,
        "sender_full_name": "skippy",
        "timestamp": 1646876836
    },
    {
        "content": "<p>Ok, I have it in the right place now on lang-team. Thanks for your help everyone and sorry for the extra noise!</p>",
        "id": 274780207,
        "sender_full_name": "skippy",
        "timestamp": 1646877395
    }
]