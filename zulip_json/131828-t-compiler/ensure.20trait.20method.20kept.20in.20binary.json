[
    {
        "content": "<p>Hi, I am code-genning a custom intrinsic that when called, will call a trait method on its argument. E.g.:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">MyTrait</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">foo</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n\n<span class=\"c1\">// inside core::intrinsics</span>\n<span class=\"k\">fn</span> <span class=\"nf\">my_intrinsic</span>::<span class=\"o\">&lt;</span><span class=\"n\">T</span>: <span class=\"nc\">MyTrait</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">value</span>: <span class=\"kp\">&amp;</span><span class=\"nc\">T</span><span class=\"p\">);</span><span class=\"w\">   </span><span class=\"c1\">// intrinsic def</span>\n</code></pre></div>\n<p>Unfortunately, because <code>MyTrait::foo</code> is only called by generated code in <code>my_intrinsic</code> the linker can't find the definition because I think rustc thinks the trait method is unused. How can I prevent this and make sure that it is always kept in the binary?</p>",
        "id": 272737947,
        "sender_full_name": "Jake Hughes",
        "timestamp": 1645479945
    },
    {
        "content": "<p>Such decisions are made in the monomorphization collector. You'll need to add some custom logic for your intrinsic there. Though at that point, maybe we're trying to solve your problem the wrong way. Can you tell me more about your intrinsic and why it's needed?</p>",
        "id": 272738197,
        "sender_full_name": "oli",
        "timestamp": 1645480177
    },
    {
        "content": "<p>thanks <span class=\"user-mention\" data-user-id=\"124288\">@oli</span> . This stuff is definitely in the weeds of my problem so I'm struggling a bit to give the higher level context, but i'll do my best:</p>\n<p>I have a rustc fork where I'm experimenting with GC designs. One approach I am excited to try is to be able to dynamically change allocated blocks from managed/unmanaged. So imagine a trait like:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">Collectable</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">set_managed</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">set_unmanaged</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">);</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>My intrinsic would be something like:</p>\n<div class=\"codehilite\"><pre><span></span><code>fn make_collectable::&lt;T&gt;(value: &amp;T);\n</code></pre></div>\n<p>And in codegen, I'm iterating over the component types of <code>T</code>,  looking for impls of my <code>Collectable</code> trait, and projecting into them and calling <code>set_managed</code> or <code>set_unmanaged</code>. I hope that makes some kind of sense :)</p>",
        "id": 272738777,
        "sender_full_name": "Jake Hughes",
        "timestamp": 1645480726
    },
    {
        "content": "<p>Hmm, why does this need an intrinsic? Would it be possible to implement this trait to require that the two methods recurse into the type's fields? Or is that not actionable because it would require deriving the trait everywhere?</p>",
        "id": 272784211,
        "sender_full_name": "oli",
        "timestamp": 1645525652
    },
    {
        "content": "<p>Instead of using an intrinsic you could make your trait autogenerated as a shim, just like we generate drop glue or similar</p>",
        "id": 272784318,
        "sender_full_name": "oli",
        "timestamp": 1645525706
    },
    {
        "content": "<p>Drop glue also automatically drops the fields of a type, so this seems rather similar</p>",
        "id": 272784344,
        "sender_full_name": "oli",
        "timestamp": 1645525729
    },
    {
        "content": "<p>there is a #[used] attribute (<a href=\"https://doc.rust-lang.org/reference/abi.html#the-used-attribute\">https://doc.rust-lang.org/reference/abi.html#the-used-attribute</a>), but it's only for static items</p>",
        "id": 272793916,
        "sender_full_name": "bstrie",
        "timestamp": 1645531830
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"124288\">@oli</span> I understand. I used an intrinsic as it seemed like a straightforward way to hook into codegen at the place I wanted and start writing my own logic for the function. IIRC the drop glue stuff is implemented as a terminator kind in the MIR, this seemed like a fair bit of work.</p>",
        "id": 272796019,
        "sender_full_name": "Jake Hughes",
        "timestamp": 1645533214
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"256342\">bstrie</span> <a href=\"#narrow/stream/131828-t-compiler/topic/ensure.20trait.20method.20kept.20in.20binary/near/272793916\">said</a>:</p>\n<blockquote>\n<p>there is a #[used] attribute (<a href=\"https://doc.rust-lang.org/reference/abi.html#the-used-attribute\">https://doc.rust-lang.org/reference/abi.html#the-used-attribute</a>), but it's only for static items</p>\n</blockquote>\n<p>Thanks, I saw this. I'm not sure it works for my purposes though.</p>",
        "id": 272796217,
        "sender_full_name": "Jake Hughes",
        "timestamp": 1645533335
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"223286\">Jake Hughes</span> <a href=\"#narrow/stream/131828-t-compiler/topic/ensure.20trait.20method.20kept.20in.20binary/near/272796019\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"124288\">oli</span> I understand. I used an intrinsic as it seemed like a straightforward way to hook into codegen at the place I wanted and start writing my own logic for the function. IIRC the drop glue stuff is implemented as a terminator kind in the MIR, this seemed like a fair bit of work.</p>\n</blockquote>\n<p>ah yea it is quite a bit of work. doesn't need a mir terminator, but still... well... you'll need to touch the collector, and basically do the type-walk you do in the intrinsic impl, but instead of calling functions, you need to register them for collection</p>",
        "id": 272800129,
        "sender_full_name": "oli",
        "timestamp": 1645535634
    },
    {
        "content": "<p>thanks <span class=\"user-mention\" data-user-id=\"124288\">@oli</span> . Out of interest, if I didn't make my <code>make_collectable&lt;T&gt;</code> intrinsic an intrinsic, how would you see me generating it?  edge case-ing it in MIR generation of fn calls  like exchange_malloc? One of the reasons I chose to do it at <code>codegen_llvm</code> stage was because I was pretty sure I'd have the monomorphized version of <code>T</code>. This is most likely a misunderstanding on my part. Maybe you can also get monomorphized version of <code>T</code> during MIR building?</p>",
        "id": 272805809,
        "sender_full_name": "Jake Hughes",
        "timestamp": 1645538342
    },
    {
        "content": "<p>no you're right on that end, but you're also breaking abstractions in interesting ways (like drop glue). As an example: I don't see how your idea works for <code>Box</code> or <code>Vec</code>, as these just have pointer fields, they don't contain any fields that would implement your trait, even if they contain values of types that implement your trait</p>",
        "id": 272809836,
        "sender_full_name": "oli",
        "timestamp": 1645540103
    }
]