[
    {
        "content": "<p>Hey, this was pinged to llvm-icebreakers <a href=\"https://github.com/rust-lang/rust/issues/63959\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/63959\">https://github.com/rust-lang/rust/issues/63959</a></p>\n<p>I'm happy to take it on, but see my comment. I lack the target CPU on both machines, would that be an issue?</p>",
        "id": 180801338,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573791877
    },
    {
        "content": "<p>I suspect it will be difficult to do much without the hardware. <span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> did volunteer to run testcases or dump data on their own hardware ... but still, its probably better for us to focus effort on finding someone with the hardware ...</p>",
        "id": 180815996,
        "sender_full_name": "pnkfelix",
        "timestamp": 1573810811
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> was able to reproduce the crash on Intel CPU by cross compiling to Windows and using Wine to run the binary. So it shouldn't be an issue.</p>",
        "id": 180822462,
        "sender_full_name": "mati865",
        "timestamp": 1573816561
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> Fine. If I could suggest some improvements, I would suggest clarifying these things when marking issues for llvm-icebreakers. If people volunteer too many times and are told they cannot due to &lt;random issue&gt; they lose interest. I'm not there yet but there's only so many times you volunteer with non-constructive outcome.</p>",
        "id": 180839301,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573829788
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> noted</p>",
        "id": 180839718,
        "sender_full_name": "pnkfelix",
        "timestamp": 1573830047
    },
    {
        "content": "<p>There is a ryzen box on <a href=\"https://cfarm.tetaneutral.net/news/\" target=\"_blank\" title=\"https://cfarm.tetaneutral.net/news/\">https://cfarm.tetaneutral.net/news/</a></p>",
        "id": 180841984,
        "sender_full_name": "nagisa",
        "timestamp": 1573831447
    },
    {
        "content": "<p>if it reproduces with wine, should be good enough</p>",
        "id": 180842008,
        "sender_full_name": "nagisa",
        "timestamp": 1573831473
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> <span class=\"user-mention\" data-user-id=\"119581\">@mati865</span> Seems plausible. I'm happy to take it on but <span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> might know more. I can wait and if you cannot find someone with the hardware, feel free to let me know...</p>",
        "id": 180844094,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573832628
    },
    {
        "content": "<p>at this point I trust <span class=\"user-mention\" data-user-id=\"119581\">@mati865</span> and <span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> 's interpretation of things more than my own</p>",
        "id": 180844184,
        "sender_full_name": "pnkfelix",
        "timestamp": 1573832674
    },
    {
        "content": "<p>(I <del>wasn't</del> am not sure if the reproduction with Wine required running Wine <em>atop</em> a Ryzen box, though...)</p>",
        "id": 180844220,
        "sender_full_name": "pnkfelix",
        "timestamp": 1573832709
    },
    {
        "content": "<blockquote>\n<p>at this point I trust <span class=\"user-mention silent\" data-user-id=\"119581\">mati865</span> and <span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> 's interpretation of things more than my own</p>\n</blockquote>\n<p>Oki, cool. First step for me is to reproduce the issue on my hardware then. I will do that during the weekend and let you know how I progress.</p>",
        "id": 180844242,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573832724
    },
    {
        "content": "<p>best thing might be to ping <span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> and just ask for clarification, if their notes on the bug do not suffice.</p>",
        "id": 180844274,
        "sender_full_name": "pnkfelix",
        "timestamp": 1573832761
    },
    {
        "content": "<blockquote>\n<p>(I <del>wasn't</del> am not sure if the reproduction with Wine required running Wine <em>atop</em> a Ryzen box, though...)</p>\n</blockquote>\n<p>Yeah, fair point. Hence why I listen, no point wasting effort, as that is even more discouraging.  Let me see if I can reproduce it, I will report back here during the weekend</p>",
        "id": 180844378,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573832804
    },
    {
        "content": "<blockquote>\n<p>best thing might be to ping <span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> and just ask for clarification, if their notes on the bug do not suffice.</p>\n</blockquote>\n<p>Also valid, but he would only know if he tried wine on both AMD and intel. If he tried on AMD only he might not know for Intel. I will ask.</p>",
        "id": 180844468,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573832876
    },
    {
        "content": "<p>I reproduced crash on Ryzen box on both Windows and Wine, eddyb reproduced it using Wine on Intel CPU.<br>\n<a href=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-552219951\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-552219951\">https://github.com/rust-lang/rust/issues/63959#issuecomment-552219951</a> isn't totally clear but I thought people would get the point.</p>",
        "id": 180845802,
        "sender_full_name": "mati865",
        "timestamp": 1573833733
    },
    {
        "content": "<p>Always targeting <code>znver1</code> ofc.</p>",
        "id": 180845845,
        "sender_full_name": "mati865",
        "timestamp": 1573833772
    },
    {
        "content": "<p>Okay, so: sorry for the confusion on my part <span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> ; it sounds like you should be able to have success on other hardware as long as you have access to Wine.</p>",
        "id": 180846165,
        "sender_full_name": "pnkfelix",
        "timestamp": 1573833974
    },
    {
        "content": "<blockquote>\n<p>Okay, so: sorry for the confusion on my part @Siavosh Zarrasvand ; it sounds like you should be able to have success on other hardware as long as you have access to Wine.</p>\n</blockquote>\n<p>No worries, thank you for doublechecking</p>",
        "id": 180846442,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573834157
    },
    {
        "content": "<p>I believe it can be reproduced natively on Windows on non Ryzen box as well, at least with <code>windows-gnu</code> target I haven't found specific instructions that would not run on any other \"modern\" CPU.<br>\nSo you should be able to use whatever OS and CPU you want but binaries have to be compiled for znver1 CPU and Windows target.</p>",
        "id": 180846807,
        "sender_full_name": "mati865",
        "timestamp": 1573834374
    },
    {
        "content": "<p>whoops didn't see this thread. I left a comment on the issue</p>",
        "id": 180872801,
        "sender_full_name": "eddyb",
        "timestamp": 1573852528
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span>  All good, I'm installing all targets now, will attempt to reproduce after. Do I understand it correctly that znver1 is not really required, but compiling for Windows is, as the miscompilation happens for the windows targets?</p>",
        "id": 180934510,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573949971
    },
    {
        "content": "<p>\"all targets\"?</p>",
        "id": 180934513,
        "sender_full_name": "eddyb",
        "timestamp": 1573949996
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> you might not need a \"1st generation AMD Ryzen\" (i.e. znver1) CPU but you <em>do</em> need to run <code>rustc</code> with <code>-C target-cpu=znver1</code></p>",
        "id": 180934580,
        "sender_full_name": "eddyb",
        "timestamp": 1573950047
    },
    {
        "content": "<blockquote>\n<p>\"all targets\"?</p>\n</blockquote>\n<p>Hahaha, I figured I might as well... probably will need them at some point if I hang around in this channel. Is in <code>rustup target add all</code></p>",
        "id": 180934636,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573950147
    },
    {
        "content": "<p>the assembly looks very different from other target CPUs, likely due to the different cost tables (which are so different because AMD made Ryzen unlike existing CPUs)</p>",
        "id": 180934638,
        "sender_full_name": "eddyb",
        "timestamp": 1573950151
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> that seems excessive and a waste of your time, you should only add each target you need at a time</p>",
        "id": 180934644,
        "sender_full_name": "eddyb",
        "timestamp": 1573950175
    },
    {
        "content": "<p>What is the full compiler command?</p>",
        "id": 180934645,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573950177
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"247084\">Siavosh Zarrasvand</span> that seems excessive and a waste of your time, you should only add each target you need at a time</p>\n</blockquote>\n<p>Are they that many?  I thought I'd give it 20 minutes...</p>",
        "id": 180934654,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573950209
    },
    {
        "content": "<p>every time you update nightly you will have to download probably entire GBs</p>",
        "id": 180934663,
        "sender_full_name": "eddyb",
        "timestamp": 1573950229
    },
    {
        "content": "<p>for no real good reason</p>",
        "id": 180934665,
        "sender_full_name": "eddyb",
        "timestamp": 1573950235
    },
    {
        "content": "<p>Omg...</p>",
        "id": 180934706,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573950244
    },
    {
        "content": "<p>oki, I will have to remove them. Can I abort, clean and add targets again?</p>",
        "id": 180934714,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573950271
    },
    {
        "content": "<p>I think you can just Ctrl+C it yeah</p>",
        "id": 180934722,
        "sender_full_name": "eddyb",
        "timestamp": 1573950293
    },
    {
        "content": "<p>run <code>rustup target list</code></p>",
        "id": 180934727,
        "sender_full_name": "eddyb",
        "timestamp": 1573950298
    },
    {
        "content": "<p>it will tell you which ones are installed</p>",
        "id": 180934735,
        "sender_full_name": "eddyb",
        "timestamp": 1573950308
    },
    {
        "content": "<p>there are 89 targets in total (listed for me)</p>",
        "id": 180934741,
        "sender_full_name": "eddyb",
        "timestamp": 1573950317
    },
    {
        "content": "<p>I don't actually know how to cross-compile for windows, you might need help from <span class=\"user-mention\" data-user-id=\"119581\">@mati865</span> on that</p>",
        "id": 180934792,
        "sender_full_name": "eddyb",
        "timestamp": 1573950373
    },
    {
        "content": "<p>Yeah, removing now. </p>\n<p>Which triple do I need to reproduce the error?</p>",
        "id": 180934794,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573950387
    },
    {
        "content": "<p>(I've never tried it, only copied windows binaries from a windows machine to linux and ran wine on it)</p>",
        "id": 180934798,
        "sender_full_name": "eddyb",
        "timestamp": 1573950399
    },
    {
        "content": "<p><code>x86_64-pc-windows-gnu</code> or <code>x86_64-pc-windows-msvc</code></p>",
        "id": 180934804,
        "sender_full_name": "eddyb",
        "timestamp": 1573950413
    },
    {
        "content": "<p>I think both reproduce but I'm not sure which one is easier to cross-compile for</p>",
        "id": 180934809,
        "sender_full_name": "eddyb",
        "timestamp": 1573950424
    },
    {
        "content": "<p>Oki, cool, I will try those two</p>",
        "id": 180934810,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573950425
    },
    {
        "content": "<p>This compiles fine <code>cargo rustc --release --target=x86_64-pc-windows-gnu -- -C target-cpu=znver1 -C linker=x86_64-w64-mingw32-gcc</code></p>",
        "id": 180935888,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573952533
    },
    {
        "content": "<p>Am I supposed to get the issue while I compile, or when I run the binary in wine?</p>",
        "id": 180935890,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573952553
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> How did you manage to get it to crash under wine? Does it mean that you installed Windows binaries for rustup on wine, and compiled using your wine installation of Rust?</p>",
        "id": 180936384,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573953564
    },
    {
        "content": "<p>My cross compilation works, and it runs through wine. But I don't trigger the error <span aria-label=\"frown\" class=\"emoji emoji-1f641\" role=\"img\" title=\"frown\">:frown:</span></p>",
        "id": 180936452,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573953707
    },
    {
        "content": "<p>when you run the binary</p>",
        "id": 180936943,
        "sender_full_name": "eddyb",
        "timestamp": 1573954714
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> you shouldn't use Cargo, it's just more complicated</p>",
        "id": 180936950,
        "sender_full_name": "eddyb",
        "timestamp": 1573954745
    },
    {
        "content": "<p>adding your flags to my command:</p>\n<div class=\"codehilite\"><pre><span></span>rustc main.rs -C opt-level=3 -C codegen-units=1 -C target-cpu=znver1 --edition=2018 --target=x86_64-pc-windows-gnu -C linker=x86_64-w64-mingw32-gc\n</pre></div>",
        "id": 180936994,
        "sender_full_name": "eddyb",
        "timestamp": 1573954803
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> oh you should also only use my latest testcase</p>",
        "id": 180937005,
        "sender_full_name": "eddyb",
        "timestamp": 1573954859
    },
    {
        "content": "<p>before I started reducing all of the testcases crash while rustc is running code from a proc macro, so those cannot reproduce except on windows</p>",
        "id": 180937013,
        "sender_full_name": "eddyb",
        "timestamp": 1573954886
    },
    {
        "content": "<blockquote>\n<p>before I started reducing all of the testcases crash while rustc is running code from a proc macro, so those cannot reproduce except on windows</p>\n</blockquote>\n<p>I think this is it, right: </p>\n<p><code>thread 'main' panicked at 'assertion failed: </code>(left == right)<code>\n  left: </code>([1, 1, 1, 1, 1, 1, 1, 1], [2, 2, 2, 2, 2, 2, 2, 2], [3, 3, 3, 3, 3, 3, 3, 3])<code>,\n right: </code>([16, 250, 50, 0, 0, 0, 0, 0], [32, 32, 32, 32, 32, 32, 32, 32], [3, 3, 3, 3, 3, 3, 3, 3])<code>', ./src/main.rs:37:13\nnote: run with </code>RUST_BACKTRACE=1<code> environment variable to display a backtrace.</code></p>",
        "id": 180937401,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573955705
    },
    {
        "content": "<p>Alright, it is 2 AM here in London. If this is correct, then I continue tomorrow to see if I can debug it <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 180937506,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573955993
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> yupp, nice!</p>",
        "id": 180937563,
        "sender_full_name": "eddyb",
        "timestamp": 1573956113
    },
    {
        "content": "<p>I think if you replace <code>-C target-cpu=znver1</code> with <code>-C target-cpu=native</code>, the assertion failure will go away</p>",
        "id": 180937616,
        "sender_full_name": "eddyb",
        "timestamp": 1573956187
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> btw, on github, you need to put triple backticks (```) on their own lines</p>",
        "id": 180937678,
        "sender_full_name": "eddyb",
        "timestamp": 1573956319
    },
    {
        "content": "<blockquote>\n<p>I think if you replace <code>-C target-cpu=znver1</code> with <code>-C target-cpu=native</code>, the assertion failure will go away</p>\n</blockquote>\n<p>That is correct, cpu-target=native will not produce the assertion error. Would be interested to understand how you debugged it to this degree so far <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 180937794,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573956566
    },
    {
        "content": "<p>I didn't debug it, I just took the code and reduced it while keeping it crashing (and then later switched to an assertion failure)</p>",
        "id": 180937843,
        "sender_full_name": "eddyb",
        "timestamp": 1573956623
    },
    {
        "content": "<p>oh and if I haven't mentioned this already, the optimized LLVM IR doesn't seem to differ much between windows and linux, but the assembly does, by a lot, because of windows calling conventions, I think</p>",
        "id": 180937856,
        "sender_full_name": "eddyb",
        "timestamp": 1573956680
    },
    {
        "content": "<blockquote>\n<p>oh and if I haven't mentioned this already, the optimized LLVM IR doesn't seem to differ much between windows and linux, but the assembly does, by a lot, because of windows calling conventions, I think</p>\n</blockquote>\n<p>Would that not be the case in general, that the assembly is very different? They do compile for different ABIs after all and specially the optimised versions optimize for different OS-level schedulers, maybe? My ASM is a bit rusty (pun intended) so I do not remember how different the results should be.</p>",
        "id": 180937975,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573956920
    },
    {
        "content": "<p>OS schedulers can't have anything to do with userspace code</p>",
        "id": 180938045,
        "sender_full_name": "eddyb",
        "timestamp": 1573957077
    },
    {
        "content": "<p>and the ABIs typically only affect function prologue/epilogue</p>",
        "id": 180938084,
        "sender_full_name": "eddyb",
        "timestamp": 1573957089
    },
    {
        "content": "<p>the only reason the difference is so big here is the heavy use of SIMD, I think</p>",
        "id": 180938089,
        "sender_full_name": "eddyb",
        "timestamp": 1573957110
    },
    {
        "content": "<p>(that's also why those types have to be so big, so that LLVM uses a lot of SIMD instructions to move data around)</p>",
        "id": 180938093,
        "sender_full_name": "eddyb",
        "timestamp": 1573957137
    },
    {
        "content": "<blockquote>\n<p>OS schedulers can't have anything to do with userspace code</p>\n</blockquote>\n<p>What I meant was that at compile time, the strategies of how to lay out the ASM could be different based on which scheduler the compiler is tasked to optimize for.</p>",
        "id": 180938101,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1573957169
    },
    {
        "content": "<p>nope</p>",
        "id": 180938156,
        "sender_full_name": "eddyb",
        "timestamp": 1573957244
    },
    {
        "content": "<p>what <em>is</em> being optimized for is CPU microarchitectural details, like how many instructions of a certain category can be executed in parallel, how many cycles an instruction is expected to take, etc.</p>",
        "id": 180938172,
        "sender_full_name": "eddyb",
        "timestamp": 1573957307
    },
    {
        "content": "<p>the OS primarily only affects ABI (including exception handling, which can be pretty different between linux and windows)</p>",
        "id": 180938217,
        "sender_full_name": "eddyb",
        "timestamp": 1573957361
    },
    {
        "content": "<p>I was hoping I'd find a simple explanation so I went and searched for all mentions of windows in LLVM's X86 target</p>",
        "id": 180938227,
        "sender_full_name": "eddyb",
        "timestamp": 1573957404
    },
    {
        "content": "<p>and there isn't anything noticeable. looking at the assembly, the SIMD usage differs and that can totally be just from the ABI register assignment</p>",
        "id": 180938273,
        "sender_full_name": "eddyb",
        "timestamp": 1573957457
    },
    {
        "content": "<p>Quick update on this, I've been preoccupied since where we left it during the weekend. I intend to pick it up again before Friday, ideally by compiling a couple of similar binaries for different cpu-targets, and then use gdb or IDA Pro to debug my way through the binaries and understand the ASM-level difference  between them. Then post a gist about that and wait for feedback. </p>\n<p>Does this sounds like a way forward?</p>",
        "id": 181050075,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574107076
    },
    {
        "content": "<p>Is our current goal to try to continue reducing the test case?</p>",
        "id": 181116797,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574174476
    },
    {
        "content": "<p>in particular, have we learned enough to be able to be pretty sure that this is an LLVM bug; i.e. something that we might be able to translate to C or LLVM assembly?</p>",
        "id": 181116959,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574174560
    },
    {
        "content": "<p>at least, that's how I interpreted eddyb's <a href=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-554527634\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-554527634\">comment here</a>; though its possible <span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span>  actually meant that one could/should trace through the LLVM internals while still driving the test from <code>rustc</code> itself.</p>",
        "id": 181117656,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574174970
    },
    {
        "content": "<p>From what I have read on the Github thread and here in this channel, we still haven't nailed it down 100%. <span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> mentioned he had looked at the IR and ASM of files compiled with different CPU targets, and there are some differences but not further analyzed. My proposal is to compile for different targets and track down exactly what happens on the bits and byte levels when it crashes. </p>\n<p>In theory, LLVM and the CPU OEM could just blame each other. LLVM manages to create code that compiles for both znver1 and other CPUs, it is when it is executed on znver1 that the crash happens... It's a bit of a chicken and egg situation but the overarching problem seems to me to figure out exactly what happens, and take it from there?</p>\n<p>Please correct me if I am wrong.</p>",
        "id": 181117847,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574175088
    },
    {
        "content": "<p>Is it at a point where we could throw our generated <code>.bc</code> file(s) into LLVM's <a href=\"https://llvm.org/docs/CommandGuide/bugpoint.html\" target=\"_blank\" title=\"https://llvm.org/docs/CommandGuide/bugpoint.html\"><code>bugpoint</code> tool</a>?</p>",
        "id": 181118000,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175176
    },
    {
        "content": "<p>I don't know what .bc files are, and not familiar with bugpoint. I've done exploit development so I would have used IDA Pro and GDB <span aria-label=\"rolling on the floor laughing\" class=\"emoji emoji-1f923\" role=\"img\" title=\"rolling on the floor laughing\">:rolling_on_the_floor_laughing:</span>  Let me read up on those and come back, either with an answer or further questions?</p>",
        "id": 181118156,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574175272
    },
    {
        "content": "<p>oh: <code>.bc</code> files are the bitcode files that LLVM generates</p>",
        "id": 181118172,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175287
    },
    {
        "content": "<blockquote>\n<p>oh: <code>.bc</code> files are the bitcode files that LLVM generates</p>\n</blockquote>\n<p>Are they same as the IR, Intermediate Representation?</p>",
        "id": 181118239,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574175329
    },
    {
        "content": "<p>they are basically a binary file  representation of the low-level internal representation that LLVM uses. (And <code>.ll</code> files are a human-readable (or at least semi-human readable) version of that</p>",
        "id": 181118257,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175341
    },
    {
        "content": "<p>Yeah, <code>.bc</code> files hold LLVM IR</p>",
        "id": 181118299,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175352
    },
    {
        "content": "<p>and you can specify you want <code>.bc</code> output from <code>rustc</code></p>",
        "id": 181118355,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175365
    },
    {
        "content": "<p>I cannot tell whether <code>bugpoint</code> is a good match for this particular bug</p>",
        "id": 181118416,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175385
    },
    {
        "content": "<p>In that case, I believe so, yes. We can reliably compile both passing examples for <code>cpu-target=native</code> and failing for <code>cpu-target=znver1</code></p>",
        "id": 181118448,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574175412
    },
    {
        "content": "<p>since I do not know/remember how flexible it is with how it automatically runs the test code it compiles as part of its search process.</p>",
        "id": 181118451,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175414
    },
    {
        "content": "<p>i.e. if I understand correctly, you need to run the generated code under Wine in order to observe the bug. I do not know if <code>bugpoint</code> lets one do that (but I <em>hope</em> it does!)</p>",
        "id": 181118500,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175447
    },
    {
        "content": "<p>It is worth a shot, the issue is, compilation works fine. It is in the execution that the znver1-targeted binary hicks-up</p>",
        "id": 181118509,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574175451
    },
    {
        "content": "<p>Right. <code>bugpoint</code> <em>can</em> handle issues that arise from running the generated code</p>",
        "id": 181118542,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175473
    },
    {
        "content": "<blockquote>\n<p>i.e. if I understand correctly, you need to run the generated code under Wine in order to observe the bug. I do not know if <code>bugpoint</code> lets one do that (but I <em>hope</em> it does!)</p>\n</blockquote>\n<p>I will research and give further details here. But if that doesn't work, then I assume we think using GDB and IDA Pro might not be the worst path forward?</p>",
        "id": 181118655,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574175521
    },
    {
        "content": "<p>Sure, trying to understand the actual dynamic execution under a debugger isn't a terrible idea</p>",
        "id": 181118675,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175541
    },
    {
        "content": "<p>Aha! Lovely!<br>\nThank you, this was highly helpful <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 181118685,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574175548
    },
    {
        "content": "<p>I just figured that we might also learn a lot from finding out which LLVM pass is causing the code's behavior to change</p>",
        "id": 181118695,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175560
    },
    {
        "content": "<p>since presumably it is <em>some</em> optimization ...</p>",
        "id": 181118702,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175567
    },
    {
        "content": "<p>... but the other dangerous thing here is that <span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> earlier hypothesized that the use of <code>llvm.lifetime.start</code> and <code>llvm.lifetime.end</code> could be related to the problem here</p>",
        "id": 181118806,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175612
    },
    {
        "content": "<p>which brings us back to something I asked near the beginning: If its possible that <em>Rust</em> is generating invalid LLVM IR</p>",
        "id": 181118830,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175634
    },
    {
        "content": "<p>Because if the problem is due to invalid use of <code>llvm.lifetime.start</code> and <code>llvm.lifetime.end</code>, (which are essentially constructs that tell LLVM's optimizers that certain values have reached the end of their dynamic extent and thus optimizations can assume they won't be used), then LLVM will just say \"sure, this is a Garbage-In-Garbage-Out scenario.\"</p>",
        "id": 181118935,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175703
    },
    {
        "content": "<p>unfortunately dissecting that is probably going to require analyzing the use of <code>llvm.lifetime.{start,end}</code> in the generated code.</p>",
        "id": 181119064,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175778
    },
    {
        "content": "<p>Interesting, hmm... I guess we figure out. I will keep this in my mind when I am debugging.</p>",
        "id": 181119079,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574175789
    },
    {
        "content": "<p>in any case, I'm glad to hear you were able to successfully reproduce the bug locally!</p>",
        "id": 181119110,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574175818
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> you'd be right about the llvm.lifetime stuff, except... effectively identical IR doesn't crash when compiled for non-windows or non-znver1</p>",
        "id": 181124324,
        "sender_full_name": "eddyb",
        "timestamp": 1574178646
    },
    {
        "content": "<p>it just explains why certain aspects of the Rust code influence LLVM <em>at all</em>, but I don't think this is about UB</p>",
        "id": 181124392,
        "sender_full_name": "eddyb",
        "timestamp": 1574178686
    },
    {
        "content": "<p>LLVM doesn't seem to optimize differently when it outputs a broken executable, it just uses different registers and whatnot</p>",
        "id": 181124565,
        "sender_full_name": "eddyb",
        "timestamp": 1574178761
    },
    {
        "content": "<p>it's possible someone dedicated enough might be able to reduce the LLVM IR, but it's hard to keep it correct (at least in the Rust code, it being safe is a good metric)</p>",
        "id": 181124669,
        "sender_full_name": "eddyb",
        "timestamp": 1574178817
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> oh and <code>bugpoint</code> would likely just remove all the checks around the assert and just make LLVM trigger it...</p>",
        "id": 181124750,
        "sender_full_name": "eddyb",
        "timestamp": 1574178846
    },
    {
        "content": "<p>can you make <code>bugpoint</code> solely reduce the set of LLVM passes, and leave the input source unchanged?</p>",
        "id": 181124783,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574178868
    },
    {
        "content": "<p>I haven't seen <code>bugpoint</code> success stories outside of tracking down crashes <em>within</em> LLVM</p>",
        "id": 181124787,
        "sender_full_name": "eddyb",
        "timestamp": 1574178871
    },
    {
        "content": "<p>interesting, okay</p>",
        "id": 181124792,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574178876
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> it's not a LLVM pass</p>",
        "id": 181124796,
        "sender_full_name": "eddyb",
        "timestamp": 1574178880
    },
    {
        "content": "<p>all of this happens <em>after</em> LLVM IR</p>",
        "id": 181124801,
        "sender_full_name": "eddyb",
        "timestamp": 1574178885
    },
    {
        "content": "<p>it's mis-instruction-selection not mis-optimization :/</p>",
        "id": 181124844,
        "sender_full_name": "eddyb",
        "timestamp": 1574178910
    },
    {
        "content": "<p>oh, okay; I had assumed that some LLVM optimization was responsible for part of the transformation at fault.</p>",
        "id": 181124851,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574178912
    },
    {
        "content": "<p>there's almost nothing going on just a lot of SIMD copies and the instructions and registers chosen differ between working and broken versions</p>",
        "id": 181124948,
        "sender_full_name": "eddyb",
        "timestamp": 1574178960
    },
    {
        "content": "<p>I think <span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> and I looked at something similar (but much simpler than heavy SIMD code) on ARM and it turned out to be something wrong in LLVM's information for an instruction or something like that</p>",
        "id": 181125090,
        "sender_full_name": "eddyb",
        "timestamp": 1574179012
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> if you do not think this is about UB, does that mean we might at least be at the point where we could file a bug with LLVM with the generated <code>.bc</code> ?</p>",
        "id": 181125103,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574179021
    },
    {
        "content": "<p>well, you almost never want to touch <code>.bc</code>, it's like an unstable compression format for <code>.ll</code> :P</p>",
        "id": 181125178,
        "sender_full_name": "eddyb",
        "timestamp": 1574179059
    },
    {
        "content": "<p>Silly question but did someone try to remove <em>just</em> the lifetime.{start,end} calls from the LLVM IR and see if it still reproduces?</p>",
        "id": 181125216,
        "sender_full_name": "Hanna Kruppe",
        "timestamp": 1574179079
    },
    {
        "content": "<p>but we could theoretically submit the <code>.ll</code> - maybe we should replace the panic with something else? like <code>exit(1)</code>?</p>",
        "id": 181125263,
        "sender_full_name": "eddyb",
        "timestamp": 1574179085
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"124289\">@rkruppe</span> this is stack corruption bug so if the stack layout is different you can't repro</p>",
        "id": 181125278,
        "sender_full_name": "eddyb",
        "timestamp": 1574179100
    },
    {
        "content": "<p>oh, too bad</p>",
        "id": 181125290,
        "sender_full_name": "Hanna Kruppe",
        "timestamp": 1574179108
    },
    {
        "content": "<p>you need weirdly precise sizes of those variables. there's potentially a simpler repro but I'm not aware of it</p>",
        "id": 181125323,
        "sender_full_name": "eddyb",
        "timestamp": 1574179133
    },
    {
        "content": "<p>You will want it to be reproducible with <code>llc</code> when reporting upstream</p>",
        "id": 181125355,
        "sender_full_name": "nagisa",
        "timestamp": 1574179149
    },
    {
        "content": "<p>it requires compiling a windows program and ru- wait no</p>",
        "id": 181125385,
        "sender_full_name": "eddyb",
        "timestamp": 1574179163
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> how do I link and run a windows target executable, for/on linux?</p>",
        "id": 181125419,
        "sender_full_name": "eddyb",
        "timestamp": 1574179190
    },
    {
        "content": "<p>Getting rid of panic (in favor of exit) seems nice for reducing. But panicking code adds some temporaries on the stack, I think, So it might be difficult to do that while still reproducing, if it's so dependent on the frame layout.</p>",
        "id": 181125435,
        "sender_full_name": "Hanna Kruppe",
        "timestamp": 1574179197
    },
    {
        "content": "<p>like I want windows codegen but to call linux libc functions</p>",
        "id": 181125481,
        "sender_full_name": "eddyb",
        "timestamp": 1574179203
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"124289\">@rkruppe</span> it's dependent on the layout of the data that's being corrupted (with massive SIMD copies)</p>",
        "id": 181125531,
        "sender_full_name": "eddyb",
        "timestamp": 1574179225
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> specifying the msvc windows target for that object should suffice in llc</p>",
        "id": 181125547,
        "sender_full_name": "nagisa",
        "timestamp": 1574179229
    },
    {
        "content": "<p>I think we have some flexibility otherwise</p>",
        "id": 181125560,
        "sender_full_name": "eddyb",
        "timestamp": 1574179239
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> mhmm then how can I make that into a linux executable?</p>",
        "id": 181125584,
        "sender_full_name": "eddyb",
        "timestamp": 1574179255
    },
    {
        "content": "<p>or link it into one</p>",
        "id": 181125609,
        "sender_full_name": "eddyb",
        "timestamp": 1574179269
    },
    {
        "content": "<p>I couldn't tell from the assembly that it's going to corrupt the data and trigger the panic</p>",
        "id": 181125640,
        "sender_full_name": "eddyb",
        "timestamp": 1574179286
    },
    {
        "content": "<p><code>gcc object.o -o out</code> maybe?</p>",
        "id": 181125642,
        "sender_full_name": "nagisa",
        "timestamp": 1574179287
    },
    {
        "content": "<p>That seems too frankenstein to be good for the purpose of demonstrating a bug to upstream. First comment: why the hell does the target triple say windows when you run it on Linux?</p>",
        "id": 181125680,
        "sender_full_name": "Hanna Kruppe",
        "timestamp": 1574179309
    },
    {
        "content": "<p>we can give both mingw and native repro <em>shrug</em></p>",
        "id": 181125777,
        "sender_full_name": "eddyb",
        "timestamp": 1574179347
    },
    {
        "content": "<p>I just wanted to avoid <em>needing</em> mingw + wine, but I think that path would also work</p>",
        "id": 181125900,
        "sender_full_name": "eddyb",
        "timestamp": 1574179415
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> do you want to spend some time on this? or should I try it? I probably won't get to it until the weekend (unless I'm tempted by how ridiculous this bug is)</p>",
        "id": 181125921,
        "sender_full_name": "eddyb",
        "timestamp": 1574179427
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"124289\">@rkruppe</span> <span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> oh the other thing is that the <code>assert_eq</code> prints the data so you can see it's wrong and corruption has occurred, maybe I should just call <code>printf</code> to show the data and not bother checking for corruption?</p>",
        "id": 181126039,
        "sender_full_name": "eddyb",
        "timestamp": 1574179487
    },
    {
        "content": "<p>Sure, that would work, if the output is not too long or hard to diff by eye. Would probably make the asm shorter, too.</p>",
        "id": 181126295,
        "sender_full_name": "Hanna Kruppe",
        "timestamp": 1574179619
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> so yeah maybe you can make a version that just uses <code>printf</code> to show the bytes and even try to get it to be <code>#[no_std]</code> if you want, but that probably doesn't matter much at this point</p>",
        "id": 181126354,
        "sender_full_name": "eddyb",
        "timestamp": 1574179650
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"124289\">@rkruppe</span> it's like <code>([11; 8], [22; 8], [33; 8], [44; 8])</code> right now</p>",
        "id": 181126495,
        "sender_full_name": "eddyb",
        "timestamp": 1574179713
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"119009\">eddyb</span> specifying the msvc windows target for that object should suffice in llc</p>\n</blockquote>\n<p>Can't cross-compile for msvc in Ubuntu at least, linker does not exists. I had to use gnu-gcc. See my compile flags.</p>",
        "id": 181126506,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574179719
    },
    {
        "content": "<p>yeah the -gnu and -msvc targets both work for this, it's really the windows calling convention that seems to be required</p>",
        "id": 181126553,
        "sender_full_name": "eddyb",
        "timestamp": 1574179748
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"247084\">Siavosh Zarrasvand</span> do you want to spend some time on this? or should I try it? I probably won't get to it until the weekend (unless I'm tempted by how ridiculous this bug is)</p>\n</blockquote>\n<p>I intend to spend time on this from Thursday and onwards... <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> But do not let me block anyone else. Please work on it if you can. I will post all my updates here so that we don't perform redundant work</p>",
        "id": 181126601,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574179783
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"124289\">@rkruppe</span> <span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> more evil ideas: can I just set the windows calling convention on a function on a non-windows target, or will that generate weird SEH things when it shouldn't?</p>",
        "id": 181126629,
        "sender_full_name": "eddyb",
        "timestamp": 1574179798
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> Sorry, forgot to tag you on the above message</p>",
        "id": 181126632,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574179798
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> yes you can</p>",
        "id": 181126705,
        "sender_full_name": "nagisa",
        "timestamp": 1574179816
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> pls stop giving me nightmare fuel</p>",
        "id": 181126714,
        "sender_full_name": "Hanna Kruppe",
        "timestamp": 1574179820
    },
    {
        "content": "<p>This will just make people look for bugs in these weird-ass bits</p>",
        "id": 181126746,
        "sender_full_name": "Hanna Kruppe",
        "timestamp": 1574179842
    },
    {
        "content": "<p>x64 calling convention is universally supported across all targets AFAIK</p>",
        "id": 181126787,
        "sender_full_name": "nagisa",
        "timestamp": 1574179860
    },
    {
        "content": "<p>and is otherwise very well defined.</p>",
        "id": 181126812,
        "sender_full_name": "nagisa",
        "timestamp": 1574179865
    },
    {
        "content": "<p>I wish I had fine-grained register control because it looks like the big difference is something to do with xmm6</p>",
        "id": 181126827,
        "sender_full_name": "eddyb",
        "timestamp": 1574179872
    },
    {
        "content": "<p>(until you reach 128 bit stuff, that is)</p>",
        "id": 181126851,
        "sender_full_name": "nagisa",
        "timestamp": 1574179888
    },
    {
        "content": "<p>hey wouldn't it be funny if one of the registers was just broken but only windows used it?</p>",
        "id": 181126860,
        "sender_full_name": "eddyb",
        "timestamp": 1574179891
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> would be hilarious and I kinda want it to happen just so I can return my ryzen and go get a better one :D</p>",
        "id": 181126952,
        "sender_full_name": "nagisa",
        "timestamp": 1574179929
    },
    {
        "content": "<p>(presumably broken on the LLVM side, our chances of finding a hardware bug that isn't even limited to AMD Ryzen seem slim to impossible)</p>",
        "id": 181126977,
        "sender_full_name": "eddyb",
        "timestamp": 1574179944
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> this repros on anything that doesn't SIGILL</p>",
        "id": 181127004,
        "sender_full_name": "eddyb",
        "timestamp": 1574179957
    },
    {
        "content": "<p>the generated instructions don't use ymm or zmm AFAICT!</p>",
        "id": 181127019,
        "sender_full_name": "eddyb",
        "timestamp": 1574179968
    },
    {
        "content": "<blockquote>\n<p>hey wouldn't it be funny if one of the registers was just broken but only windows used it?</p>\n</blockquote>\n<p>Does ubuntu PCs on znver1 targets run the binary? if not, wouldn't it be more of a znver1 issue than a windows issue?</p>",
        "id": 181127066,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574179999
    },
    {
        "content": "<p>it's just that the Ryzen cost tables + windows calling convention register allocation makes LLVM generate very different machine code</p>",
        "id": 181127105,
        "sender_full_name": "eddyb",
        "timestamp": 1574180029
    },
    {
        "content": "<blockquote>\n<p>it's just that the Ryzen cost tables + windows calling convention register allocation makes LLVM generate very different machine code</p>\n</blockquote>\n<p>Ah, oki, cool <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 181127194,
        "sender_full_name": "Siavosh Zarrasvand",
        "timestamp": 1574180057
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> if you run it under wine, it will run on the CPU, wine only hooks windows APIs at the library level AFAICT</p>",
        "id": 181127203,
        "sender_full_name": "eddyb",
        "timestamp": 1574180062
    },
    {
        "content": "<p>Hi, I own an AMD R7 1800X on Windows. If you need anything to help you find the root cause of this issue, just ask.</p>",
        "id": 181129673,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574181391
    },
    {
        "content": "<p>The set of instructions just before core::ptr::real_drop_in_place&lt;syn::derive::DeriveInput&gt; in the example given by novacrazy looks to be the same kind of those I found when I investigated <a href=\"https://github.com/rust-lang/rust/issues/65618\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/65618\">#65618</a></p>",
        "id": 181130849,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574182193
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"224971\">@Vincent Rouillé</span> it's probably better to ignore all of the early investigation because of how simple we were able to make the whole setup (also, it's harder to debug crashes in dylibs loaded by <code>rustc</code>, which is where the original failures were)</p>",
        "id": 181131248,
        "sender_full_name": "eddyb",
        "timestamp": 1574182468
    },
    {
        "content": "<p>also, I think we sadly run out of problems we need a Windows Ryzen machine for and fell into problems we need a lowest-parts-of-LLVM expert for :(</p>",
        "id": 181131292,
        "sender_full_name": "eddyb",
        "timestamp": 1574182505
    },
    {
        "content": "<p>if I were to investigate this further I would just install mingw and use that with wine (or try to bypass cross-compilation entirely and just get the windows+znver1 codegen on non-Ryzen linux, which sounds doable)</p>",
        "id": 181131419,
        "sender_full_name": "eddyb",
        "timestamp": 1574182574
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> at least with your <code>llc</code> suggestion, we can have no optimization passes run and (presumably) still repro, so I think that's significant?</p>",
        "id": 181131641,
        "sender_full_name": "eddyb",
        "timestamp": 1574182729
    },
    {
        "content": "<p>and maybe there are some LLVM IR instructions that aren't needed - although I don't look forward to redu- OH</p>",
        "id": 181131705,
        "sender_full_name": "eddyb",
        "timestamp": 1574182773
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> <span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> <span class=\"user-mention\" data-user-id=\"124289\">@rkruppe</span> I know how to use <code>bugpoint</code> for this!</p>\n<p>have a harness that tests <em>both</em> non-windows and/or non-znver1 and windows+znver1 and only pretends to crash/fail when <em>only</em> windows+znver1 produces the wrong result</p>",
        "id": 181131946,
        "sender_full_name": "eddyb",
        "timestamp": 1574182922
    },
    {
        "content": "<p>you couldn't just look at one of those situations because that would make <code>bugpoint</code> be super helpful and replace the SIMD corruption with something arbitrary that looks corrupted</p>",
        "id": 181132034,
        "sender_full_name": "eddyb",
        "timestamp": 1574182977
    },
    {
        "content": "<p>I suspect we shouldn't use any C library calls for this, but rather IR for a <code>#![no_std]</code> <code>staticlib</code> with one exported <code>u64 -&gt; u64</code> function that should behave like the identity function (and I guess you'd use only one of the memory locations that gets corrupted - presumably you can get 3 or so different <code>bugpoint</code> reductions)</p>",
        "id": 181132198,
        "sender_full_name": "eddyb",
        "timestamp": 1574183090
    },
    {
        "content": "<p>In the repro case at the end of the issue, did you figure out which instructions are wrong?</p>",
        "id": 181132560,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574183348
    },
    {
        "content": "<p>hmm. maybe if you compile the testcase with full debuginfo enabled (<code>-C debuginfo=2</code>) and get lucky with LLVM so it doesn't get optimized out and single-step through the execution, constantly printing all the locals?</p>\n<p>cc <span class=\"user-mention\" data-user-id=\"247084\">@Siavosh Zarrasvand</span> you said you wanted to use a debugger on this</p>",
        "id": 181132863,
        "sender_full_name": "eddyb",
        "timestamp": 1574183513
    },
    {
        "content": "<p>From what I just saw: [3u8;8] is stored in rdi and untouched<br>\n([1u8;8], [2u8;8]) is stored in xmm6 and is overwritten by <code>vmovups     ymm6,ymmword ptr [rsp+0B0h]</code></p>",
        "id": 181132873,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574183519
    },
    {
        "content": "<p>ooor someone more patient than me can read through the assembly :)</p>",
        "id": 181132933,
        "sender_full_name": "eddyb",
        "timestamp": 1574183540
    },
    {
        "content": "<p>wait I thought ymm wasn't used, only xmm. maybe I wasn't paying attention</p>",
        "id": 181132963,
        "sender_full_name": "eddyb",
        "timestamp": 1574183558
    },
    {
        "content": "<p>oh I was looking at <code>vmovaps xmm6, xmmword ptr [rip + .LCPI5_0]</code> and missed all the other instructions using <code>ymm</code></p>",
        "id": 181133153,
        "sender_full_name": "eddyb",
        "timestamp": 1574183655
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><span class=\"mi\">00007</span><span class=\"n\">FF7F4A61358</span><span class=\"w\">  </span><span class=\"n\">vmovaps</span><span class=\"w\">     </span><span class=\"n\">xmm6</span><span class=\"p\">,</span><span class=\"n\">xmmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">__xmm</span><span class=\"o\">@</span><span class=\"mi\">02020202020202020101010101010101</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">07</span><span class=\"n\">FF7F4A7A000h</span><span class=\"p\">)]</span><span class=\"w\"></span>\n<span class=\"c1\">//                            ^ put ([1u8;8], [2u8;8]) into xmm6</span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61360</span><span class=\"w\">  </span><span class=\"n\">lea</span><span class=\"w\">         </span><span class=\"n\">rsi</span><span class=\"p\">,[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">80</span><span class=\"n\">h</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61368</span><span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\">         </span><span class=\"n\">rdi</span><span class=\"p\">,</span><span class=\"mi\">303030303030303</span><span class=\"n\">h</span><span class=\"w\"></span>\n<span class=\"c1\">//                            ^ put [3u8;8] into rdi</span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61372</span><span class=\"w\">  </span><span class=\"n\">nop</span><span class=\"w\">         </span><span class=\"n\">word</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"n\">cs</span>:<span class=\"p\">[</span><span class=\"n\">rax</span><span class=\"o\">+</span><span class=\"n\">rax</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">Evil</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">data</span>: <span class=\"p\">([</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">]),</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">padding</span>: <span class=\"nc\">MaybeUninit</span>::<span class=\"n\">uninit</span><span class=\"p\">(),</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">evil2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">evil1</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61380</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymm0</span><span class=\"p\">,</span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">140</span><span class=\"n\">h</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61389</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymm1</span><span class=\"p\">,</span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">130</span><span class=\"n\">h</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61392</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymm6</span><span class=\"p\">,</span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">0</span><span class=\"n\">B0h</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"c1\">//                            ^ overwrite xmm6</span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A6139B</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymm2</span><span class=\"p\">,</span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">0</span><span class=\"n\">F0h</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613A4</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymm3</span><span class=\"p\">,</span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">110</span><span class=\"n\">h</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">allocated</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">opaque_iter_next</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">allocator</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613AD</span><span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\">         </span><span class=\"n\">rcx</span><span class=\"p\">,</span><span class=\"n\">rsi</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">Evil</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">data</span>: <span class=\"p\">([</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">]),</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">padding</span>: <span class=\"nc\">MaybeUninit</span>::<span class=\"n\">uninit</span><span class=\"p\">(),</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">evil2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">evil1</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613B0</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"n\">F0h</span><span class=\"p\">],</span><span class=\"n\">ymm0</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613B9</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mf\">1E0</span><span class=\"n\">h</span><span class=\"p\">],</span><span class=\"n\">ymm1</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613C2</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymm1</span><span class=\"p\">,</span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">0</span><span class=\"n\">D0h</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613CB</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"n\">C0h</span><span class=\"p\">],</span><span class=\"n\">ymm3</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613D4</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"n\">A0h</span><span class=\"p\">],</span><span class=\"n\">ymm2</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613DD</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">160</span><span class=\"n\">h</span><span class=\"p\">],</span><span class=\"n\">ymm6</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">evil2</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">evil4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">evil3</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613E6</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">110</span><span class=\"n\">h</span><span class=\"p\">],</span><span class=\"n\">ymm3</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613EF</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">0</span><span class=\"n\">F0h</span><span class=\"p\">],</span><span class=\"n\">ymm2</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A613F8</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">0</span><span class=\"n\">B0h</span><span class=\"p\">],</span><span class=\"n\">ymm6</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"n\">Evil</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">data</span>: <span class=\"p\">([</span><span class=\"mi\">1</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">3</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"p\">]),</span><span class=\"w\"></span>\n<span class=\"w\">                    </span><span class=\"n\">padding</span>: <span class=\"nc\">MaybeUninit</span>::<span class=\"n\">uninit</span><span class=\"p\">(),</span><span class=\"w\"></span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">evil2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">evil1</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61401</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">180</span><span class=\"n\">h</span><span class=\"p\">],</span><span class=\"n\">ymm1</span><span class=\"w\"></span>\n<span class=\"w\">            </span><span class=\"n\">evil2</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"p\">};</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">evil4</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">evil3</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A6140A</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">0</span><span class=\"n\">D0h</span><span class=\"p\">],</span><span class=\"n\">ymm1</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61413</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymm5</span><span class=\"p\">,</span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">1</span><span class=\"n\">F0h</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A6141C</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymm4</span><span class=\"p\">,</span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mf\">1E0</span><span class=\"n\">h</span><span class=\"p\">]</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61425</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">140</span><span class=\"n\">h</span><span class=\"p\">],</span><span class=\"n\">ymm5</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A6142E</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">ymmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rsp</span><span class=\"o\">+</span><span class=\"mi\">130</span><span class=\"n\">h</span><span class=\"p\">],</span><span class=\"n\">ymm4</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">allocated</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">opaque_iter_next</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">allocator</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61437</span><span class=\"w\">  </span><span class=\"n\">vzeroupper</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A6143A</span><span class=\"w\">  </span><span class=\"n\">call</span><span class=\"w\">        </span><span class=\"n\">rust_63959</span>::<span class=\"n\">opaque_iter_next</span><span class=\"o\">&lt;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">core</span>::<span class=\"n\">mem</span>::<span class=\"n\">maybe_uninit</span>::<span class=\"n\">MaybeUninit</span><span class=\"o\">&lt;</span><span class=\"n\">rust_63959</span>::<span class=\"n\">Evil</span><span class=\"o\">&gt;*</span><span class=\"p\">,</span><span class=\"n\">core</span>::<span class=\"n\">slice</span>::<span class=\"n\">IterMut</span><span class=\"o\">&lt;</span><span class=\"n\">core</span>::<span class=\"n\">mem</span>::<span class=\"n\">maybe_uninit</span>::<span class=\"n\">MaybeUninit</span><span class=\"o\">&lt;</span><span class=\"n\">rust_63959</span>::<span class=\"n\">Evil</span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">07</span><span class=\"n\">FF7F4A612F0h</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A6143F</span><span class=\"w\">  </span><span class=\"n\">test</span><span class=\"w\">        </span><span class=\"n\">rax</span><span class=\"p\">,</span><span class=\"n\">rax</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61442</span><span class=\"w\">  </span><span class=\"n\">je</span><span class=\"w\">          </span><span class=\"n\">rust_63959</span>::<span class=\"n\">main</span><span class=\"o\">+</span><span class=\"mi\">213</span><span class=\"n\">h</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">07</span><span class=\"n\">FF7F4A61523h</span><span class=\"p\">)</span><span class=\"w\"></span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">allocated</span><span class=\"p\">.</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">evil4</span><span class=\"p\">).</span><span class=\"n\">data</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A61448</span><span class=\"w\">  </span><span class=\"n\">vmovups</span><span class=\"w\">     </span><span class=\"n\">xmmword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rax</span><span class=\"p\">],</span><span class=\"n\">xmm6</span><span class=\"w\"></span>\n<span class=\"c1\">//                            ^ put xmm6 (i.e. garbage)  into [rax]</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">allocated</span><span class=\"p\">.</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">evil4</span><span class=\"p\">).</span><span class=\"n\">data</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"mi\">00007</span><span class=\"n\">FF7F4A6144C</span><span class=\"w\">  </span><span class=\"n\">mov</span><span class=\"w\">         </span><span class=\"n\">qword</span><span class=\"w\"> </span><span class=\"n\">ptr</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">rax</span><span class=\"o\">+</span><span class=\"mi\">10</span><span class=\"n\">h</span><span class=\"p\">],</span><span class=\"n\">rdi</span><span class=\"w\"></span>\n<span class=\"c1\">//                            ^ put rdi (i.e. [3u8;8])  into [rax+10h]</span>\n</pre></div>",
        "id": 181133247,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574183717
    },
    {
        "content": "<p><a href=\"https://godbolt.org/z/KmMdZD\" target=\"_blank\" title=\"https://godbolt.org/z/KmMdZD\">https://godbolt.org/z/KmMdZD</a> is the relevant output ftr</p>",
        "id": 181133252,
        "sender_full_name": "eddyb",
        "timestamp": 1574183722
    },
    {
        "content": "<p>it's easier to find where the data flow with a debugger :)</p>",
        "id": 181133309,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574183762
    },
    {
        "content": "<p>I remember seeing an output like what you pasted there from a tool, ages ago, but I forget what it was</p>",
        "id": 181133448,
        "sender_full_name": "eddyb",
        "timestamp": 1574183859
    },
    {
        "content": "<p>and I've forgotten it's a thing at all</p>",
        "id": 181133519,
        "sender_full_name": "eddyb",
        "timestamp": 1574183884
    },
    {
        "content": "<p>The heavy visual studio...</p>",
        "id": 181133530,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574183895
    },
    {
        "content": "<p>ah that would explain it</p>",
        "id": 181133551,
        "sender_full_name": "eddyb",
        "timestamp": 1574183912
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"224971\">@Vincent Rouillé</span> well, that gives me a pretty good idea of one way this might happen</p>",
        "id": 181133563,
        "sender_full_name": "eddyb",
        "timestamp": 1574183926
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"124289\">@rkruppe</span> <span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> <span class=\"user-mention\" data-user-id=\"133224\">@Nikita Popov</span> do you think it's possible for LLVM to miss a conflict between <code>xmmN</code> and <code>ymmN</code>?</p>",
        "id": 181133625,
        "sender_full_name": "eddyb",
        "timestamp": 1574183971
    },
    {
        "content": "<p>the non-windows znver1 codegen uses <code>0x0303030303030303</code> in <code>r14</code> (<strong>EDIT</strong>: nevermind, <code>rdi</code> is used to hold that constant in the windows version, <em>not</em> <code>xmm6</code>)</p>",
        "id": 181133818,
        "sender_full_name": "eddyb",
        "timestamp": 1574184080
    },
    {
        "content": "<p>oh wow it still uses <code>ymm6</code>, ugh I should've paid more attention to the actual diff between those two</p>",
        "id": 181133844,
        "sender_full_name": "eddyb",
        "timestamp": 1574184102
    },
    {
        "content": "<p>so if I ignore the stack offsets, the use of <code>xmm6</code> is the main difference</p>",
        "id": 181133916,
        "sender_full_name": "eddyb",
        "timestamp": 1574184139
    },
    {
        "content": "<p>and <code>vmovaps xmm0, xmmword ptr [rip + .LCPI5_0]</code> being immediately followed by using <code>xmm0</code>, in the non-windows version</p>",
        "id": 181134029,
        "sender_full_name": "eddyb",
        "timestamp": 1574184212
    },
    {
        "content": "<p>both versions freely use all <code>ymm</code> registers, so I'm not sure I understand what in the calling convention makes windows use <code>xmm6</code>?!</p>",
        "id": 181134235,
        "sender_full_name": "eddyb",
        "timestamp": 1574184329
    },
    {
        "content": "<p>the windows version appears to have to save and restore <code>xmm6</code>, which may be the calling convention difference, but that wouldn't explain why it uses it for anything else</p>",
        "id": 181134324,
        "sender_full_name": "eddyb",
        "timestamp": 1574184375
    },
    {
        "content": "<p>okay I've taken a closer look and it's <code>vmovaps xmmN, xmmword ptr [rip + .LCPI5_0]</code> in both, <em>but</em> both the N and the location of the instruction differs:</p>\n<ul>\n<li>non-windows loads <code>xmm0</code> right before using it</li>\n<li>windows loads <code>xmm6</code> <em>much earlier</em></li>\n</ul>",
        "id": 181134618,
        "sender_full_name": "eddyb",
        "timestamp": 1574184575
    },
    {
        "content": "<p>in godbolt, the linux (left) is writing ([1u8;8],[2u8;8]) into xmm0 later than the windows (right) version</p>",
        "id": 181134659,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574184594
    },
    {
        "content": "<p>yeah same conclusion</p>",
        "id": 181134750,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574184619
    },
    {
        "content": "<p>there is the uninlined <code>opaque_iter_next</code> call in between, I wonder if on windows <code>xmm6</code> <em>specifically</em> is callee-saved, but on non-windows there are no callee-saved xmm registers?</p>",
        "id": 181134755,
        "sender_full_name": "eddyb",
        "timestamp": 1574184622
    },
    {
        "content": "<p>so on windows it tries to aggressively take advantage of that one callee-saved register?</p>",
        "id": 181134815,
        "sender_full_name": "eddyb",
        "timestamp": 1574184662
    },
    {
        "content": "<p>well, there goes my bugpoint harness, we can probably reduce the LLVM by hand now taking into account that one register usage</p>",
        "id": 181134863,
        "sender_full_name": "eddyb",
        "timestamp": 1574184697
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> <span class=\"user-mention\" data-user-id=\"124289\">@rkruppe</span> I should not trust my intuition with regards to why the size matters, this isn't even a stack corruption but register corruption... (before I managed to remove allocation was assuming it was an allocator size class, lol)</p>",
        "id": 181135484,
        "sender_full_name": "eddyb",
        "timestamp": 1574185112
    },
    {
        "content": "<p>so I think I know where that large size is coming from too! one <code>ymm</code> register is 4 <code>u64</code>s, so you need at least <code>4*6+1</code> <code>u64</code>s for <code>ymm6</code> to be needed, that's 25. 3 of them are in <code>data</code>,  and <code>22</code> are in <code>padding</code></p>",
        "id": 181135585,
        "sender_full_name": "eddyb",
        "timestamp": 1574185197
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"124289\">rkruppe</span> <span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> <span class=\"user-mention silent\" data-user-id=\"133224\">Nikita Popov</span> do you think it's possible for LLVM to miss a conflict between <code>xmmN</code> and <code>ymmN</code>?</p>\n</blockquote>\n<p>Hard to imagine this being a cae.</p>",
        "id": 181135654,
        "sender_full_name": "nagisa",
        "timestamp": 1574185217
    },
    {
        "content": "<p>FWIW microsoft’s x86 calling convention only uses xmm0-3 in its calling convention</p>",
        "id": 181135725,
        "sender_full_name": "nagisa",
        "timestamp": 1574185281
    },
    {
        "content": "<p>it only treats xmm6 as callee-save despite using ymm0-ymm6 (maybe ymm7 is also callee-save? I should check)</p>",
        "id": 181135843,
        "sender_full_name": "eddyb",
        "timestamp": 1574185334
    },
    {
        "content": "<p>xmm6-xmm15 are non-volatile registers, so it might be a case of it failing to spill/restore it right if it overwrites it</p>",
        "id": 181135892,
        "sender_full_name": "nagisa",
        "timestamp": 1574185367
    },
    {
        "content": "<p>by the way target-cpu=core-avx2, doesn't have this problem, it still write to xmm6, but do not use ymm6.</p>",
        "id": 181135958,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574185398
    },
    {
        "content": "<blockquote>\n<p>the upper portions of YMM0-15 and ZMM0-15 are considered volatile and must be considered destroyed on function calls</p>\n</blockquote>\n<p>also as per the docs.</p>",
        "id": 181135976,
        "sender_full_name": "nagisa",
        "timestamp": 1574185414
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"224971\">@Vincent Rouillé</span> I think that's where the znver1 cost tables come in, it's supposedly faster/more efficient on Ryzens to do what LLVM is doing here</p>",
        "id": 181136071,
        "sender_full_name": "eddyb",
        "timestamp": 1574185460
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> okay with 22+2*4 for the padding length I can see xmm7 and xmm8 also getting callee-saved</p>",
        "id": 181136141,
        "sender_full_name": "eddyb",
        "timestamp": 1574185513
    },
    {
        "content": "<p>above that it crosses a threshold and uses memcpy or something</p>",
        "id": 181136166,
        "sender_full_name": "eddyb",
        "timestamp": 1574185533
    },
    {
        "content": "<p>it's funny to see that at 32, it stops using ymm6 and use ymm7</p>",
        "id": 181136461,
        "sender_full_name": "Vincent Rouillé",
        "timestamp": 1574185771
    },
    {
        "content": "<p>I summarized everything so far into <a href=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-555627472\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-555627472\">https://github.com/rust-lang/rust/issues/63959#issuecomment-555627472</a></p>",
        "id": 181136666,
        "sender_full_name": "eddyb",
        "timestamp": 1574185926
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> found at least where this is declared <a href=\"https://github.com/llvm/llvm-project/blob/e531750c6cf9ab6ca987ffbfe100b1d766269eb5/llvm/lib/Target/X86/X86CallingConv.td#L1071-L1072\" target=\"_blank\" title=\"https://github.com/llvm/llvm-project/blob/e531750c6cf9ab6ca987ffbfe100b1d766269eb5/llvm/lib/Target/X86/X86CallingConv.td#L1071-L1072\">https://github.com/llvm/llvm-project/blob/e531750c6cf9ab6ca987ffbfe100b1d766269eb5/llvm/lib/Target/X86/X86CallingConv.td#L1071-L1072</a></p>",
        "id": 181136894,
        "sender_full_name": "eddyb",
        "timestamp": 1574186069
    },
    {
        "content": "<p>now that I know what to look for :D</p>",
        "id": 181136911,
        "sender_full_name": "eddyb",
        "timestamp": 1574186084
    },
    {
        "content": "<p>non-windows doesn't appear to have xmm callee-saved registers, at all? (there are some exceptions i.e. \"regcall\". hmmmmmmmm)</p>",
        "id": 181137183,
        "sender_full_name": "eddyb",
        "timestamp": 1574186279
    },
    {
        "content": "<p>we don't expose regcall in Rust?</p>",
        "id": 181137314,
        "sender_full_name": "eddyb",
        "timestamp": 1574186353
    },
    {
        "content": "<p>wait, now that we know it's the <code>opaque_iter_next</code>.... <code>extern \"win64\" fn opaque_iter_next</code> works on non-windows and produces very similar ASM...</p>",
        "id": 181137491,
        "sender_full_name": "eddyb",
        "timestamp": 1574186451
    },
    {
        "content": "<p>yes it reproduces trivially on linux now (and probably anything at all, really) - see <a href=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-555633777\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-555633777\">https://github.com/rust-lang/rust/issues/63959#issuecomment-555633777</a></p>",
        "id": 181138026,
        "sender_full_name": "eddyb",
        "timestamp": 1574186786
    },
    {
        "content": "<p>I need to go grab something to eat but this feels like a big step</p>",
        "id": 181138119,
        "sender_full_name": "eddyb",
        "timestamp": 1574186867
    },
    {
        "content": "<p>should be trivial at this point to get to a LLVM-IR to report upstream</p>",
        "id": 181138851,
        "sender_full_name": "nagisa",
        "timestamp": 1574187304
    },
    {
        "content": "<p>For previous questions:<br>\nIt's definitely <strong>not</strong> a hardware bug. You can reproduce crash on any CPU that has necessary registers/instructions.<br>\nThis code works fine on Linux with 2nd gen Ryzen CPU.<br>\nI tried to use bugpoint but it appears to not work at all on windows.</p>",
        "id": 181138985,
        "sender_full_name": "mati865",
        "timestamp": 1574187382
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119581\">@mati865</span> now that reproducer works on linux, should be viable to use it</p>",
        "id": 181139032,
        "sender_full_name": "nagisa",
        "timestamp": 1574187417
    },
    {
        "content": "<p>Oh, neat!</p>",
        "id": 181139063,
        "sender_full_name": "mati865",
        "timestamp": 1574187444
    },
    {
        "content": "<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"116083\">pnkfelix</span> <span class=\"user-mention silent\" data-user-id=\"123586\">nagisa</span> <span class=\"user-mention silent\" data-user-id=\"124289\">rkruppe</span> I know how to use <code>bugpoint</code> for this!</p>\n<p>have a harness that tests <em>both</em> non-windows and/or non-znver1 and windows+znver1 and only pretends to crash/fail when <em>only</em> windows+znver1 produces the wrong result</p>\n</blockquote>\n<p>you still need something like this ^^</p>",
        "id": 181139387,
        "sender_full_name": "eddyb",
        "timestamp": 1574187665
    },
    {
        "content": "<p>if you want to use <code>bugpoint</code></p>",
        "id": 181139393,
        "sender_full_name": "eddyb",
        "timestamp": 1574187672
    },
    {
        "content": "<p>but at least this time it can be an entirely linux-based procedure, and you just toggle whether <code>opaque_id</code> has <code>win64</code> calling convention or not</p>",
        "id": 181139478,
        "sender_full_name": "eddyb",
        "timestamp": 1574187724
    },
    {
        "content": "<p>That's exactly what I did for creduce <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 181139525,
        "sender_full_name": "mati865",
        "timestamp": 1574187762
    },
    {
        "content": "<p>(you'd probably have to inject it into whatever bugpoint gives you, I'm guessing?)</p>",
        "id": 181139531,
        "sender_full_name": "eddyb",
        "timestamp": 1574187765
    },
    {
        "content": "<p>I've sunk enough time as it is into this, I guess if nobody has taken over in an hour or so I'll do that</p>",
        "id": 181139605,
        "sender_full_name": "eddyb",
        "timestamp": 1574187840
    },
    {
        "content": "<p>(I guess both win64 and regcall calling conventions could be attempted, I expect results from both, but maybe not identical)</p>",
        "id": 181139847,
        "sender_full_name": "eddyb",
        "timestamp": 1574188001
    },
    {
        "content": "<p>I'm out of time.<br>\nThis probably proves <a href=\"https://github.com/rust-lang/rust/issues/65618\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/65618\">#65618</a> is something entirely different?<br>\nIt works on mingw bug doesn't with msvc.</p>",
        "id": 181139861,
        "sender_full_name": "mati865",
        "timestamp": 1574188019
    },
    {
        "content": "<p>And is also related to znver1.</p>",
        "id": 181139906,
        "sender_full_name": "mati865",
        "timestamp": 1574188050
    },
    {
        "content": "<p>could very well be more of the same.</p>",
        "id": 181139937,
        "sender_full_name": "nagisa",
        "timestamp": 1574188076
    },
    {
        "content": "<p>yeah just more sensitive to certain things</p>",
        "id": 181140005,
        "sender_full_name": "eddyb",
        "timestamp": 1574188097
    },
    {
        "content": "<p>Shouldn't it reproduce on windows with mingw then?<br>\nOr maybe there is some platform specific code somewhere along.</p>",
        "id": 181140234,
        "sender_full_name": "mati865",
        "timestamp": 1574188233
    },
    {
        "content": "<p>Looking through debug logs, it looks like originally a correct register allocation is produced, but then critical anti-dep edge breaking replaces a ymm0 use with a conflicting ymm6 use.</p>",
        "id": 181158567,
        "sender_full_name": "Nikita Popov",
        "timestamp": 1574200639
    },
    {
        "content": "<p>ymm0 -&gt; ymm6? not xmm0 -&gt; xmm6?</p>",
        "id": 181158596,
        "sender_full_name": "eddyb",
        "timestamp": 1574200671
    },
    {
        "content": "<p>because xmm0 <em>is</em> being used when xmm6 is not available due to being callee-saved, so it would make sense that xmm0 -&gt; xmm6 happens with win64 (or regcall, if you switch that manually in the IR)</p>",
        "id": 181158677,
        "sender_full_name": "eddyb",
        "timestamp": 1574200719
    },
    {
        "content": "<p>uhh it's been (far) more than an hour</p>",
        "id": 181847997,
        "sender_full_name": "eddyb",
        "timestamp": 1574705694
    },
    {
        "content": "<p>but right now I'm reducing bugpoint output</p>",
        "id": 181848015,
        "sender_full_name": "eddyb",
        "timestamp": 1574705707
    },
    {
        "content": "<p>this is what I've used to get that <a href=\"https://gist.github.com/eddyb/7b08cdc2ff0a40aed8adcfaf63120598\" target=\"_blank\" title=\"https://gist.github.com/eddyb/7b08cdc2ff0a40aed8adcfaf63120598\">https://gist.github.com/eddyb/7b08cdc2ff0a40aed8adcfaf63120598</a></p>",
        "id": 181848050,
        "sender_full_name": "eddyb",
        "timestamp": 1574705729
    },
    {
        "content": "<p>bugpoint annoyingly leaves a bunch of things <code>undef</code>, which only do anything useful through the sheer power of strong coincidence, but I was able to get rid of it</p>",
        "id": 181848150,
        "sender_full_name": "eddyb",
        "timestamp": 1574705778
    },
    {
        "content": "<p>wrote it up on thread <a href=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-558287117\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/63959#issuecomment-558287117\">https://github.com/rust-lang/rust/issues/63959#issuecomment-558287117</a></p>",
        "id": 181850630,
        "sender_full_name": "eddyb",
        "timestamp": 1574707398
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"123586\">@nagisa</span> <span class=\"user-mention\" data-user-id=\"133224\">@Nikita Popov</span> <span class=\"user-mention\" data-user-id=\"124289\">@rkruppe</span> <del>does anyone volunteer to submit to LLVM?</del> (nevermind, I ended up doing it myself, see below)</p>",
        "id": 181850681,
        "sender_full_name": "eddyb",
        "timestamp": 1574707440
    },
    {
        "content": "<p>it's been a while for me</p>",
        "id": 181850728,
        "sender_full_name": "eddyb",
        "timestamp": 1574707450
    },
    {
        "content": "<p>I still don't have an LLVM bugzilla account &gt;_&gt;</p>",
        "id": 181850818,
        "sender_full_name": "Hanna Kruppe",
        "timestamp": 1574707523
    },
    {
        "content": "<p>oh wait I'm not sure I do, I forgot something happened at some point</p>",
        "id": 181850871,
        "sender_full_name": "eddyb",
        "timestamp": 1574707547
    },
    {
        "content": "<p>I guess I do, oh well I'll do it</p>",
        "id": 181850990,
        "sender_full_name": "eddyb",
        "timestamp": 1574707620
    },
    {
        "content": "<p>there we go: <a href=\"https://bugs.llvm.org/show_bug.cgi?id=44140\" target=\"_blank\" title=\"https://bugs.llvm.org/show_bug.cgi?id=44140\">https://bugs.llvm.org/show_bug.cgi?id=44140</a></p>",
        "id": 181854255,
        "sender_full_name": "eddyb",
        "timestamp": 1574709771
    },
    {
        "content": "<p>sorry for all the delays thus far, this turned out to be far more manageable and not as much of a timesink as I was worrying</p>",
        "id": 181854316,
        "sender_full_name": "eddyb",
        "timestamp": 1574709835
    },
    {
        "content": "<p>Based on ctoppers comment it looks like this is indeed caused by critical anti-dep breaking not handling subregs correctly. Sorry for not following up on that.</p>",
        "id": 181870204,
        "sender_full_name": "Nikita Popov",
        "timestamp": 1574720949
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> <a href=\"https://www.phoronix.com/scan.php?page=news_item&amp;px=Linux-5.2-Go-Register-Corrupt\" target=\"_blank\" title=\"https://www.phoronix.com/scan.php?page=news_item&amp;px=Linux-5.2-Go-Register-Corrupt\">https://www.phoronix.com/scan.php?page=news_item&amp;px=Linux-5.2-Go-Register-Corrupt</a> in related news.</p>",
        "id": 181975539,
        "sender_full_name": "nagisa",
        "timestamp": 1574811714
    },
    {
        "content": "<p>oof</p>",
        "id": 182016290,
        "sender_full_name": "eddyb",
        "timestamp": 1574859808
    },
    {
        "content": "<p>hey <span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span> given that you've identified this as an LLVM bug, what next for <a href=\"https://github.com/rust-lang/rust/issues/63959\" target=\"_blank\" title=\"https://github.com/rust-lang/rust/issues/63959\">#63959</a> itself? Should I close it as \"LLVM bug\" ? Or downgrade it to P-medium at least? I don't think it warrants further investigation on our part, right?</p>",
        "id": 182113048,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574951403
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"116083\">@pnkfelix</span> I think the issue should be closed by a PR that updates LLVM to include a backport of the fix</p>",
        "id": 182119707,
        "sender_full_name": "eddyb",
        "timestamp": 1574957012
    },
    {
        "content": "<p>oh, right, that's probably the way to go</p>",
        "id": 182119784,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574957091
    },
    {
        "content": "<p>could be done as soon as the fix lands upstream, or even earlier if we don't want to wait. I wish I knew who also handles stuff like this (i.e. LLVM updates and backports), other than <span class=\"user-mention\" data-user-id=\"116015\">@Alex Crichton</span>. worst case someone ping me and I can probably do it</p>",
        "id": 182119785,
        "sender_full_name": "eddyb",
        "timestamp": 1574957094
    },
    {
        "content": "<p>thanks!</p>",
        "id": 182119799,
        "sender_full_name": "pnkfelix",
        "timestamp": 1574957108
    },
    {
        "content": "<p>not sure if we have a strategy for backporting LLVM updates due to LLVM backports back to beta</p>",
        "id": 182119805,
        "sender_full_name": "eddyb",
        "timestamp": 1574957117
    },
    {
        "content": "<p>(that was... a mouthful)</p>",
        "id": 182119815,
        "sender_full_name": "eddyb",
        "timestamp": 1574957125
    },
    {
        "content": "<p>Upstream fix landed in llvm master branch already.<br>\nAFAIK anybody can open backport PR, even I did it in the past.</p>",
        "id": 182120046,
        "sender_full_name": "mati865",
        "timestamp": 1574957324
    },
    {
        "content": "<blockquote>\n<p>Upstream fix landed in llvm master branch already.</p>\n</blockquote>\n<p>wheeeee</p>",
        "id": 182120286,
        "sender_full_name": "eddyb",
        "timestamp": 1574957533
    },
    {
        "content": "<p>wait wouldn't the bug report get closed and therefore I should've gotten an email?</p>",
        "id": 182120310,
        "sender_full_name": "eddyb",
        "timestamp": 1574957557
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119009\">@eddyb</span>  should I open backport PR (after testing OFC) or do you want to do it?</p>",
        "id": 182162756,
        "sender_full_name": "mati865",
        "timestamp": 1575019669
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"119581\">@mati865</span> you can do it, I'm swamped again</p>",
        "id": 182185061,
        "sender_full_name": "eddyb",
        "timestamp": 1575040674
    },
    {
        "content": "<p>Sure</p>",
        "id": 182185114,
        "sender_full_name": "mati865",
        "timestamp": 1575040687
    }
]