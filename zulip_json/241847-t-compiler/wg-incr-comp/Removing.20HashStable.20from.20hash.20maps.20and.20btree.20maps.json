[
    {
        "content": "<p>Taking a note here, this is not a complete proposal and super urgent:</p>\n<p>I think it would be a good idea to remove the HashStable impl for collections that store their values in non-deterministic order, such as hash maps and btree maps. These collection types could be replaced by new-type wrappers which don't allow iterating of the entries but expose the rest of the functionality. These wrappers could also have something like a <code>items_in_deterministic_order(&amp;self, cmp: Fn(&amp;K) -&gt; Ordering) -&gt; Vec&lt;(&amp;K, &amp;V)&gt;</code> method that allows to extract the items, if they can be ordered deterministically.</p>",
        "id": 270183513,
        "sender_full_name": "mw",
        "timestamp": 1643710985
    },
    {
        "content": "<blockquote>\n<p>These collection types could be replaced by new-type wrappers which don't allow iterating of the entries but expose the rest of the functionality.</p>\n</blockquote>\n<p>You mean <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_data_structures/stable_map/struct.StableMap.html\"><code>StableMap</code></a>?</p>\n<blockquote>\n<p>These wrappers could also have something like a <code>items_in_deterministic_order(&amp;self, cmp: Fn(&amp;K) -&gt; Ordering) -&gt; Vec&lt;(&amp;K, &amp;V)&gt;</code> method that allows to extract the items, if they can be ordered deterministically.</p>\n</blockquote>\n<p><code>StableMap</code> has an <code>into_sorted_vector</code> method. It uses the <code>Ord</code> trait instead of a closure though.</p>",
        "id": 270195888,
        "sender_full_name": "bjorn3",
        "timestamp": 1643716494
    },
    {
        "content": "<p>Ah yes, that looks pretty good. That <code>into_sorted_vector</code> simply uses <code>Ord</code> (which does not guarantee determinism across compilation sessions) is problematic. But otherwise that's roughly what I imagined.</p>\n<p>The important thing would be to also use it everywhere and disallow using regular hashmaps in query results/query keys.</p>",
        "id": 270196992,
        "sender_full_name": "mw",
        "timestamp": 1643717120
    },
    {
        "content": "<p>See <a href=\"https://github.com/rust-lang/rust/issues/63713\">#63713</a></p>",
        "id": 270197575,
        "sender_full_name": "bjorn3",
        "timestamp": 1643717338
    }
]