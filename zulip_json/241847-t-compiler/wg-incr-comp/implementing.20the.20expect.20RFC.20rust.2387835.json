[
    {
        "content": "<p>Hello, I've got a working implementation of the <code>expect</code> attribute in <a href=\"https://github.com/rust-lang/rust/issues/87835\">rust#87835</a>. The implementation is currently based on an ID that is assigned to each lint expectation when it's discovered in the <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_lint/levels/struct.LintLevelsBuilder.html\"><code>LintLevelsBuilder</code></a>. The ID is then stored as part of the new <code>Expect</code> lint level and used to link the diagnostic to the expectation. This works well in test files.</p>\n<p>The current implementation creates the expectation ID based on the <code>AttrId</code> of the attribute that the expectation originated from. However, that ID is not stable. I'm now struck on how to create an ID that's stable between compilation sessions. The <code>LintLevelsBuilder</code> is also used during the <code>EarlyLintPass</code> inside <a href=\"https://doc.rust-lang.org/nightly/nightly-rustc/rustc_lint/context/struct.EarlyContext.html\"><code>EarlyContext</code></a> to track the current level for lints during that pass. It would also be a viable option to use the <code>HirId</code> of the item/statement that the attribute is on, but the <code>HirId</code> is not available in the early lint pass (to my knowledge).</p>\n<p>Could somebody maybe take a look at the implementation and help me find a stable way to generate an expectation ID?</p>\n<hr>\n<p>The PR description contains a more detailed explanation about the implementation and as well as reasoning why this ID has to be stable.</p>",
        "id": 248963523,
        "sender_full_name": "xFrednet",
        "timestamp": 1628592225
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"369415\">xFrednet</span> has marked this topic as resolved.</p>",
        "id": 248963621,
        "sender_full_name": "Notification Bot",
        "timestamp": 1628592314
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"369415\">xFrednet</span> has marked this topic as unresolved.</p>",
        "id": 248963628,
        "sender_full_name": "Notification Bot",
        "timestamp": 1628592319
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"369415\">@xFrednet</span> If you can use the <code>HirId</code>, that will be a lot more stable than just the attribute id. (<a href=\"https://rustc-dev-guide.rust-lang.org/identifiers.html#in-the-hir\">https://rustc-dev-guide.rust-lang.org/identifiers.html#in-the-hir</a>)</p>\n<p><code>DefId</code> is the most stable but I don't think you have access to those when EarlyLintPasses run.</p>",
        "id": 255778417,
        "sender_full_name": "Wesley Wiser",
        "timestamp": 1633108805
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"125250\">@Wesley Wiser</span> , I'm just getting back into working on the <code>expect</code> attribute. The early lint pass operates on the AST and can even be registered to run before the expansion of macros. Is there a way to get the <code>HirId</code> of an AST node? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> I couldn't find one the last time I looked into it.</p>",
        "id": 262187868,
        "sender_full_name": "xFrednet",
        "timestamp": 1637420574
    },
    {
        "content": "<p>I wouldn't expect (heh) there to be one, HirIds aren't stable between compilations and aren't assigned until HIR lowering happens</p>",
        "id": 262187902,
        "sender_full_name": "Joshua Nelson",
        "timestamp": 1637420635
    },
    {
        "content": "<p>Now I'm considering to have the <code>LintExpectationId</code> as an enum that either holds a <code>AttrId</code> for the early lint pass and then a <code>HirId</code> for the late lint pass. Diagnostics with a <code>AttrId</code> would be updated to a <code>HirId</code> based <code>LintExpectationId</code> once the <code>HirId</code> was determined. I'll experiment a bit more with this idea.</p>",
        "id": 262187946,
        "sender_full_name": "xFrednet",
        "timestamp": 1637420657
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"232545\">Joshua Nelson</span> <a href=\"#narrow/stream/241847-t-compiler.2Fwg-incr-comp/topic/implementing.20the.20expect.20RFC.20rust.2387835/near/262187902\">said</a>:</p>\n<blockquote>\n<p>I wouldn't expect (heh) there to be one, HirIds aren't stable between compilations and aren't assigned until HIR lowering happens</p>\n</blockquote>\n<p>That's also what I thought, thanks :)</p>",
        "id": 262187951,
        "sender_full_name": "xFrednet",
        "timestamp": 1637420672
    }
]