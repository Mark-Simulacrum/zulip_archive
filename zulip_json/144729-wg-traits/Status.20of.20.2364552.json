[
    {
        "content": "<p>What's the status of <a href=\"https://github.com/rust-lang/rust/issues/64552\">https://github.com/rust-lang/rust/issues/64552</a>?  I see <a href=\"https://github.com/rust-lang/rust/pull/92449\">https://github.com/rust-lang/rust/pull/92449</a> mentions it (but doesn't fix it). If I want to have a try on fixing <a href=\"https://github.com/rust-lang/rust/issues/64552\">#64552</a>, should I wait <a href=\"https://github.com/rust-lang/rust/issues/92449\">#92449</a> merged first?</p>",
        "id": 277979197,
        "sender_full_name": "sgk",
        "timestamp": 1649225377
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/issues/92449\">#92449</a> is kinda stalled, though the issue <a href=\"https://github.com/rust-lang/rust/issues/64552\">#64552</a> and related issues with auto traits and generators are very difficult to fix it seems, at least with the way that we currently have typeck and borrowck set up</p>",
        "id": 277981990,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649228220
    },
    {
        "content": "<p>if you do want to take a stab at it, feel free to ask me questions</p>",
        "id": 277982008,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649228238
    },
    {
        "content": "<p>Yes. I want to at least have a proper picture of how hard this is or what's problem really is. Then I will try to fix this.<br>\nWhich part of the coded should I look into first?  I believe this mostly related to mir and typeck?</p>",
        "id": 278002800,
        "sender_full_name": "sgk",
        "timestamp": 1649240279
    },
    {
        "content": "<p>And should I follow your work in <a href=\"https://github.com/rust-lang/rust/issues/92449\">#92449</a>?</p>",
        "id": 278002934,
        "sender_full_name": "sgk",
        "timestamp": 1649240365
    },
    {
        "content": "<p>no, I don't think <a href=\"https://github.com/rust-lang/rust/issues/92449\">#92449</a> is really worth salvaging at this point, at least not without a really dramatic redesign</p>",
        "id": 278078730,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649275531
    },
    {
        "content": "<p>so the \"future is not send due to generators\" issue is actually a class of several issues</p>",
        "id": 278078995,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649275663
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/issues/64552\">#64552</a> specifically is pretty difficult member of that class, because the generator needs to prove that one of its internal members, specifically the iterator type of <code>BTreeMap</code>, is <code>Send</code></p>",
        "id": 278079015,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649275672
    },
    {
        "content": "<p>however, that means proving that one of the internal members of BTreeMap is Send as well, specifically <a href=\"https://github.com/rust-lang/rust/blob/master/library/alloc/src/collections/btree/node.rs#L209-213\"><code>NodeRef</code></a></p>",
        "id": 278079154,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649275724
    },
    {
        "content": "<p>but to prove that <code>Send</code> bound, we need to prove an outlives constraint on the key and value types, but we just don't have enough information to prove that outlives constraint when all the lifetimes are erased</p>",
        "id": 278079282,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649275791
    },
    {
        "content": "<p><a href=\"https://github.com/rust-lang/rust/issues/92449\">#92449</a> tries to stash the outlives predicates that we know in the generator, and then add them to the param-env that we use to prove that the generator is <code>Send</code></p>",
        "id": 278079632,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649275935
    },
    {
        "content": "<p>but (as far as i can tell) we can't infer it from the structure of the btreemap itself, and don't need to prove it anywhere else in our function body so we know nothing about the lifetime relationship between the <code>K</code> and <code>V</code> args of the btreemap and the NodeRef...</p>",
        "id": 278080034,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649276110
    },
    {
        "content": "<p>this is all speculation and recollection, i wrote that PR a few months ago when I knew far less about the compiler</p>",
        "id": 278080087,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649276132
    },
    {
        "content": "<p>but the root cause of all of these issues is that we erase the lifetimes of the generator-interior elements <a href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_typeck/src/check/generator_interior.rs#L213-220\">so we can't prove anything about the lifetime relationships</a> of the contents of the generators, but we _need_ information about the lifetime relationships of the contents of the generator, at least in this case, to prove that the generator is <code>Send</code></p>",
        "id": 278080379,
        "sender_full_name": "Michael Goulet (compiler-errors)",
        "timestamp": 1649276267
    },
    {
        "content": "<p>Thank you for the info. I will look into this for a bit before giving some more thoughts about it. I'm still not that familiar with rustc code.<br>\nFrom what I see, my intuition is that, <code>NodeRef</code> impl <code>Send</code> base on some bound related to lifetime, but generator-interior erased all lifetime info (to <code>'alpha</code> it seems). Result is the <code>Send</code> bound is not satisfied. To fix this, we should store lifetime info somewhere.<br>\nWhat I don't get is why are we erasing lifetime info in the first place?</p>",
        "id": 278139204,
        "sender_full_name": "sgk",
        "timestamp": 1649324714
    }
]