<html>
    <head>
<script>
async function run() {
    let correct;
    let original = window.location.pathname;

    // Not necessary but allows testing in forks.
    if (original.startsWith("/zulip_archive")) {
        original = original.replace("/zulip_archive", "");
    }

    let streamPart = "/stream/";
    let topicPart = "/topic/";
    let extension = ".html";

    let streamOffset = original.search(streamPart);
    // `/` or `/index.html`
    if (original === "/" || original === `/index${extension}`) {
        correct = `https://rust-lang.zulipchat.com/`;
    // `/stream/185405-t-compiler/rust-analyzer/index.html` or
    // `/stream/185405-t-compiler/rust-analyzer/topic/Rust-analyzer.20use.20inside.20stdlib.html`
    } else if (streamOffset !== -1) {
        // `185405-t-compiler/rust-analyzer/index.html` or
        // `185405-t-compiler/rust-analyzer/topic/Rust-analyzer.20use.20inside.20stdlib.html`
        let stream = original.substring(streamOffset + streamPart.length);

        let topicOffset = stream.search(topicPart);
        if (topicOffset !== -1) {
            // `185405-t-compiler/rust-analyzer`
            let onlyStream = encodeURIComponent(stream.substring(0, topicOffset));
            // `Rust-analyzer.20use.20inside.20stdlib.html`
            let remaining = stream.substring(topicOffset + topicPart.length);
            // `Rust-analyzer.20use.20inside.20stdlib`
            let remainingWithoutExtension = remaining.substring(0, remaining.length - extension.length);

            let specificMessage = "";
            // `#278572262`
            if (window.location.hash) {
                // `278572262`
                let hash = window.location.hash.substring(1);
                specificMessage = `/near/${hash}`;
            }

            correct = `https://rust-lang.zulipchat.com/#narrow/stream/${onlyStream}/topic/${remainingWithoutExtension}${specificMessage}`;
        } else {
            // for `185405-t-compiler/rust-analyzer/` or `185405-t-compiler/rust-analyzer/index.html`
            let lastSlash = stream.lastIndexOf("/");
            // `185405-t-compiler/rust-analyzer`
            let onlyStream = encodeURIComponent(stream.substring(0, lastSlash));

            correct = `https://rust-lang.zulipchat.com/#narrow/stream/${onlyStream}`;
        }
    // `/219381tlibs/index.html` or `/219381tlibs/07261PanicmessagefromcatchunwindsdynAny.html`
    } else {
        let index = await (fetch("/topic-index-404.json").then(r => r.json()));

        let stream_id = original.substring(1, 7); // /xxxxxstreamname
        let stream = index[stream_id].stream;
        let topics = index[stream_id].topics;

        let end = original.substring(original.substring(1).indexOf('/') + 2);
        let hash = parseInt(end.substring(0, 5), 10);
        let sanitized = end.substring(5).slice(0, -5);

        for (let topic of topics) {
            let cmp = sanitize_topic(topic);
            if (cmp.sanitized == sanitized) {
                correct = `https://rust-lang.zulipchat.com/#narrow/stream/${stream_id}-${new_sanitize(stream)}/topic/${new_sanitize_topic(topic)}`;
            }
        }
    }

    if (correct !== undefined) {
        window.location.replace(correct);
    }
}

run();

function adler32(topic) {
    // Not yet implemented - likely not necessary.
    return 0;
}

function sanitize_topic(topic) {
    return {
        hash: adler32(topic) % 10000,
        sanitized: topic.replace(/[^a-zA-Z0-9]/g, "")
    };
}

function new_sanitize(s) {
    return s.replace(/[^a-zA-Z0-9 ]/g, "").replace(/ /g, "-").replace(/\?/g, "%3F");
}

function new_sanitize_topic(s) {
    return encodeURI(s).replace(/\./g, "%2E").replace(/%/g, ".");
}
</script>
    </head>

    <body>
        Unknown URL in zulip-archive. You can access the
        <a href="https://rust-lang.zulipchat.org">Rust Zulip</a> without requiring registration.

        This page attempts to redirect to the web-public Rust Zulip if
        possible, but this requires JavaScript and may not always work.
    </body>
</html>
